=== SISTEMA AVD UISA - CÃ“DIGO-FONTE COMPLETO ===
Gerado em: Thu Nov 20 12:11:44 EST 2025

========================================
ARQUIVO: ./client/src/App.tsx
========================================
import { Toaster } from "@/components/ui/sonner";
import { TooltipProvider } from "@/components/ui/tooltip";
import NotFound from "@/pages/NotFound";
import Alertas from "@/pages/Alertas";
import Discrepancias from "./pages/Discrepancias";
import Departamentos from "./pages/Departamentos";
import CentrosCustos from "./pages/CentrosCustos";
import SucessaoInteligente from "./pages/SucessaoInteligente";
import ImportacaoPonto from "@/pages/ImportacaoPonto";
import { Route, Switch } from "wouter";
import ErrorBoundary from "./components/ErrorBoundary";
import { ThemeProvider } from "./contexts/ThemeContext";
import { NotificationProvider } from "./contexts/NotificationContext";
import Home from "./pages/Home";
import DashboardGestor from "./pages/DashboardGestor";
import ConfiguracoesSMTP from "./pages/ConfiguracoesSMTP";
import Metas from "./pages/Metas";
import Avaliacoes from "./pages/Avaliacoes";
import PDI from "./pages/PDI";
import NineBox from "./pages/NineBox";
import Relatorios from "./pages/Relatorios";
import Calibracao from "./pages/Calibracao";
import Configuracoes from "./pages/Configuracoes";
import Perfil from "./pages/Perfil";
import History from "./pages/History";
import Funcionarios from "./pages/Funcionarios";
import FuncionariosAtivos from "./pages/FuncionariosAtivos";
import AprovacoesD from "./pages/aprovacoes/Dashboard";
import MinhasSolicitacoes from "./pages/aprovacoes/MinhasSolicitacoes";
import BonusAprovacoes from "./pages/aprovacoes/Bonus";
import Workflows from "./pages/aprovacoes/Workflows";
import Sucessao from "./pages/Sucessao";
import SucessaoMelhorado from "./pages/SucessaoMelhorado";
import MapaSucessaoCompleto from "./pages/MapaSucessaoCompleto";
import PDIInteligente from "./pages/PDIInteligente";
import PDIInteligenteNovo from "./pages/PDIInteligenteNovo";
import PDIInteligenteDetalhes from "./pages/PDIInteligenteDetalhes";
import TestesResultadosRH from "./pages/TestesResultadosRH";
import NineBoxComparativo from "./pages/NineBoxComparativo";
import ReportBuilder from "./pages/ReportBuilder";
import ReportAnalytics from "./pages/ReportAnalytics";
import SuccessionImport from "./pages/SuccessionImport";
import PerformanceIntegrada from "./pages/PerformanceIntegrada";
import Avaliacao360Enhanced from "./pages/Avaliacao360Enhanced";
import Avaliacao360Autoavaliacao from "./pages/Avaliacao360Autoavaliacao";
import Avaliacao360Gestor from "./pages/Avaliacao360Gestor";
import Avaliacao360Consenso from "./pages/Avaliacao360Consenso";
import BenchmarkingMercado from "./pages/BenchmarkingMercado";
import MetasCascata from "./pages/MetasCascata";
import DashboardExecutivoConsolidado from "./pages/DashboardExecutivoConsolidado";
import CiclosAvaliacao from "./pages/CiclosAvaliacao";
import AuditTrail from "./pages/AuditTrail";
import Analytics from "./pages/Analytics";
import AnalyticsAvancado from "./pages/AnalyticsAvancado";
import DescricaoCargos from "./pages/DescricaoCargos";
import DescricaoCargosUISA from "./pages/DescricaoCargosUISA";
import CriarDescricaoCargo from "./pages/CriarDescricaoCargo";
import DetalhesDescricaoCargo from "./pages/DetalhesDescricaoCargo";
import MinhasAtividades from "./pages/MinhasAtividades";
import RelatoriosProdutividade from "./pages/RelatoriosProdutividade";
import ValidacaoLider from "./pages/ValidacaoLider";
import AnaliseGaps from "./pages/AnaliseGaps";
import ImportacaoDescricoes from "./pages/ImportacaoDescricoes";
import PesquisasPulse from "./pages/PesquisasPulse";
import ResponderPesquisaPulse from "./pages/ResponderPesquisaPulse";
import ResultadosPesquisaPulse from "./pages/ResultadosPesquisaPulse";
import Feedbacks from "./pages/Feedbacks";
import Badges from "./pages/Badges";
import PsychometricTests from "./pages/PsychometricTests";
import TestDISC from "./pages/TestDISC";
import TestBigFive from "./pages/TestBigFive";
import TestMBTI from "./pages/TestMBTI";
import TestIE from "./pages/TestIE";
import TestVARK from "./pages/TestVARK";
import TestLeadership from "./pages/TestLeadership";
import TestCareerAnchors from "./pages/TestCareerAnchors";
import EnviarTestes from "./pages/EnviarTestes";
import Notificacoes from "./pages/Notificacoes";
import DashboardComparativoTestes from "./pages/DashboardComparativoTestes";
import RelatoriosExecutivos from "./pages/RelatoriosExecutivos";
import AdminSmtp from "./pages/AdminSmtp";
import EmailMetrics from "./pages/EmailMetrics";
import ScheduledReports from "./pages/ScheduledReports";
import ExecutiveDashboard from "./pages/ExecutiveDashboard";
import DashboardExecutivo from "./pages/DashboardExecutivo";
import Avaliar360 from "./pages/Avaliar360";
import MetasSMART from "./pages/MetasSMART";
import CriarMetaSMART from "./pages/CriarMetaSMART";
import DetalhesMeta from "./pages/DetalhesMeta";
import EditarMeta from "./pages/EditarMeta";
import AtualizarProgressoMeta from "./pages/AtualizarProgressoMeta";
import AnalyticsMetas from "./pages/AnalyticsMetas";
import AprovarMetas from "./pages/AprovarMetas";
import ConfiguracaoBonus from "@/pages/ConfiguracaoBonus";
import ConfiguracaoWorkflowsBonus from "@/pages/ConfiguracaoWorkflowsBonus";
import DashboardBonusRH from "./pages/DashboardBonusRH";
import MovimentacaoNineBox from "./pages/MovimentacaoNineBox";
import AprovacaoCalibracoes from "./pages/AprovacaoCalibracoes";
import RankingGamificacao from "./pages/RankingGamificacao";
import ConfiguracaoIntegracoes from "./pages/ConfiguracaoIntegracoes";
import BonusPolicies from "@/pages/Bonus";
import AprovacaoBonus from "@/pages/AprovacaoBonus";
import RelatorioBonus from "./pages/RelatorioBonus";
import PrevisaoBonus from "./pages/PrevisaoBonus";
import AprovacaoBonusLote from "./pages/AprovacaoBonusLote";
import BonusAuditoria from "./pages/BonusAuditoria";
import AvaliacoesPendentes from "./pages/AvaliacoesPendentes";
import HierarquiaOrganizacional from "./pages/HierarquiaOrganizacional";
import HierarquiaImport from "./pages/HierarquiaImport";
import DashboardEmails from "./pages/DashboardEmails";

function Router() {
  return (
    <Switch>
      <Route path={"/"} component={Home} />          <Route path="/gestor" component={DashboardGestor} />
          <Route path="/configuracoes/smtp" component={ConfiguracoesSMTP} />      <Route path={"/metas"} component={MetasSMART} />
      <Route path={"/metas/criar"} component={CriarMetaSMART} />
      <Route path={"/metas/:id"} component={DetalhesMeta} />
      <Route path={"/metas/:id/editar"} component={EditarMeta} />
      <Route path="/metas/:id/progresso" component={AtualizarProgressoMeta} />
      <Route path="/analytics/metas" component={AnalyticsMetas} />
      <Route path="/executivo/calibracao" component={MovimentacaoNineBox} />
      <Route path="/executivo/aprovacoes" component={AprovacaoCalibracoes} />
      <Route path="/gamificacao/ranking" component={RankingGamificacao} />
      <Route path="/configuracoes/integracoes" component={ConfiguracaoIntegracoes} />
      <Route path="/bonus" component={BonusPolicies} />
      <Route path="/aprovacoes/bonus" component={AprovacaoBonus} />
      <Route path="/relatorios/bonus" component={RelatorioBonus} />
      <Route path="/previsao-bonus" component={PrevisaoBonus} />
      <Route path="/aprovacoes/bonus-lote" component={AprovacaoBonusLote} />
      <Route path="/bonus/auditoria" component={BonusAuditoria} />
      <Route path="/avaliacoes-pendentes" component={AvaliacoesPendentes} />
       <Route path="/avaliacoes" component={Avaliacoes} />
      <Route path="/avaliacoes/autoavaliacao/:id" component={Avaliacao360Autoavaliacao} />
      <Route path="/avaliacoes/gestor/:id" component={Avaliacao360Gestor} />
      <Route path="/avaliacoes/consenso/:id" component={Avaliacao360Consenso} />
      <Route path="/benchmarking" component={BenchmarkingMercado} />
      <Route path="/metas-cascata" component={MetasCascata} />
      <Route path="/dashboard-executivo" component={DashboardExecutivoConsolidado} />
      <Route path="/ciclos-avaliacao" component={CiclosAvaliacao} />
      <Route path={"/pdi"} component={PDI} />
      <Route path={"/nine-box"} component={NineBox} />
      <Route path={'/relatorios'} component={Relatorios} />
      <Route path="/calibracao" component={Calibracao} />
      <Route path="/configuracoes" component={Configuracoes} />
      <Route path="/perfil" component={Perfil} />
      <Route path="/historico" component={History} />
      <Route path="/funcionarios" component={Funcionarios} />
      <Route path="/funcionarios-ativos" component={FuncionariosAtivos} />
      <Route path="/departamentos" component={Departamentos} />
      <Route path="/centros-custo" component={CentrosCustos} />
      <Route path="/aprovacoes/dashboard" component={AprovacoesD} />
      <Route path="/aprovacoes/solicitacoes" component={MinhasSolicitacoes} />      <Route path={"/aprovacoes/bonus"} component={BonusAprovacoes} />
      <Route path="/aprovacoes/metas" component={AprovarMetas} />
      <Route path="/configuracoes/bonus" component={ConfiguracaoBonus} />
      <Route path="/configuracoes/workflows-bonus" component={ConfiguracaoWorkflowsBonus} />
      <Route path="/rh/dashboard-bonus" component={DashboardBonusRH} />
      <Route path="/aprovacoes/workflows" component={Workflows} />
      <Route path="/sucessao" component={Sucessao} />
      <Route path="/mapa-sucessao" component={SucessaoMelhorado} />
      <Route path="/mapa-sucessao-completo" component={MapaSucessaoCompleto} />
      <Route path="/pdi-inteligente/novo" component={PDIInteligenteNovo} />
      <Route path="/pdi-inteligente/:id/detalhes" component={PDIInteligenteDetalhes} />
      <Route path="/pdi-inteligente/:id" component={PDIInteligente} />
      <Route path="/testes-psicometricos/resultados" component={TestesResultadosRH} />
      <Route path="/nine-box-comparativo" component={NineBoxComparativo} />
      <Route path="/admin/report-builder" component={ReportBuilder} />
      <Route path="/admin/report-analytics" component={ReportAnalytics} />
      <Route path={"/admin/succession-import"} component={SuccessionImport} />
      <Route path="/performance-integrada" component={PerformanceIntegrada} />
      <Route path="/360-enhanced" component={Avaliacao360Enhanced} />
      <Route path="/testes-psicometricos" component={PsychometricTests} />
      <Route path="/teste-disc" component={TestDISC} />
      <Route path="/teste-bigfive" component={TestBigFive} />
      <Route path="/teste-mbti" component={TestMBTI} />
      <Route path="/teste-ie" component={TestIE} />
      <Route path="/teste-vark" component={TestVARK} />
      <Route path="/teste-lideranca" component={TestLeadership} />
      <Route path="/teste-ancoras-carreira" component={TestCareerAnchors} />
      <Route path="/testes/enviar" component={EnviarTestes} />
      <Route path="/descricao-cargos" component={DescricaoCargos} />
      <Route path="/descricao-cargos-uisa" component={DescricaoCargosUISA} />
      <Route path="/descricao-cargos-uisa/criar" component={CriarDescricaoCargo} />
      <Route path="/descricao-cargos-uisa/:id" component={DetalhesDescricaoCargo} />
      <Route path="/minhas-atividades" component={MinhasAtividades} />
      <Route path="/relatorios-produtividade" component={RelatoriosProdutividade} />
      <Route path="/alertas" component={Alertas} />
      <Route path="/discrepancias" component={Discrepancias} />
      <Route path="/departamentos" component={Departamentos} />
      <Route path="/centros-custos" component={CentrosCustos} />
      <Route path="/sucessao-inteligente" component={SucessaoInteligente} />
      <Route path="/importacao-ponto" component={ImportacaoPonto} />
      <Route path="/validacao-lider" component={ValidacaoLider} />
      <Route path="/analise-gaps" component={AnaliseGaps} />
      <Route path="/importacao-descricoes" component={ImportacaoDescricoes} />
      <Route path="/pesquisas-pulse" component={PesquisasPulse} />
      <Route path="/pesquisa/:id" component={ResponderPesquisaPulse} />
      <Route path="/pesquisas-pulse/resultados/:id" component={ResultadosPesquisaPulse} />
      <Route path="/notificacoes" component={Notificacoes} />
      <Route path="/testes/comparativo" component={DashboardComparativoTestes} />
      <Route path="/relatorios-executivos" component={RelatoriosExecutivos} />
      <Route path="/admin/smtp" component={AdminSmtp} />
      <Route path="/admin/hierarquia" component={HierarquiaOrganizacional} />
      <Route path="/admin/hierarquia/importar" component={HierarquiaImport} />
      <Route path="/admin/emails" component={DashboardEmails} />
      <Route path="/admin/email-metrics" component={EmailMetrics} />
      <Route path="/admin/scheduled-reports" component={ScheduledReports} />
      <Route path="/executive-dashboard" component={ExecutiveDashboard} />
      <Route path="/dashboard-executivo" component={DashboardExecutivo} />
      <Route path="/analytics" component={Analytics} />
      <Route path="/analytics/avancado" component={AnalyticsAvancado} />
                <Route path="/avaliar-360/:id" component={Avaliar360} />
          <Route path="/admin/audit-log" component={AuditTrail} />
          <Route path="/admin/analytics" component={Analytics} />
          <Route path="/feedback" component={Feedbacks} />
          <Route path="/badges" component={Badges} />
      <Route path={"/404"} component={NotFound} />
      <Route component={NotFound} />
    </Switch>
  );
}

function App() {
  return (
    <ErrorBoundary>
      <ThemeProvider
        defaultTheme="light"
        // switchable
      >
        <NotificationProvider>
          <TooltipProvider>
            <Toaster />
            <Router />
          </TooltipProvider>
        </NotificationProvider>
      </ThemeProvider>
    </ErrorBoundary>
  );
}

export default App;

========================================
ARQUIVO: ./client/src/_core/hooks/useAuth.ts
========================================
import { getLoginUrl } from "@/const";
import { trpc } from "@/lib/trpc";
import { TRPCClientError } from "@trpc/client";
import { useCallback, useEffect, useMemo } from "react";

type UseAuthOptions = {
  redirectOnUnauthenticated?: boolean;
  redirectPath?: string;
};

export function useAuth(options?: UseAuthOptions) {
  const { redirectOnUnauthenticated = false, redirectPath = getLoginUrl() } =
    options ?? {};
  const utils = trpc.useUtils();

  const meQuery = trpc.auth.me.useQuery(undefined, {
    retry: false,
    refetchOnWindowFocus: false,
  });

  const logoutMutation = trpc.auth.logout.useMutation({
    onSuccess: () => {
      utils.auth.me.setData(undefined, null);
    },
  });

  const logout = useCallback(async () => {
    try {
      await logoutMutation.mutateAsync();
    } catch (error: unknown) {
      if (
        error instanceof TRPCClientError &&
        error.data?.code === "UNAUTHORIZED"
      ) {
        return;
      }
      throw error;
    } finally {
      utils.auth.me.setData(undefined, null);
      await utils.auth.me.invalidate();
    }
  }, [logoutMutation, utils]);

  const state = useMemo(() => {
    localStorage.setItem(
      "manus-runtime-user-info",
      JSON.stringify(meQuery.data)
    );
    return {
      user: meQuery.data ?? null,
      loading: meQuery.isLoading || logoutMutation.isPending,
      error: meQuery.error ?? logoutMutation.error ?? null,
      isAuthenticated: Boolean(meQuery.data),
    };
  }, [
    meQuery.data,
    meQuery.error,
    meQuery.isLoading,
    logoutMutation.error,
    logoutMutation.isPending,
  ]);

  useEffect(() => {
    if (!redirectOnUnauthenticated) return;
    if (meQuery.isLoading || logoutMutation.isPending) return;
    if (state.user) return;
    if (typeof window === "undefined") return;
    if (window.location.pathname === redirectPath) return;

    window.location.href = redirectPath
  }, [
    redirectOnUnauthenticated,
    redirectPath,
    logoutMutation.isPending,
    meQuery.isLoading,
    state.user,
  ]);

  return {
    ...state,
    refresh: () => meQuery.refetch(),
    logout,
  };
}


========================================
ARQUIVO: ./client/src/components/AIChatBox.tsx
========================================
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { ScrollArea } from "@/components/ui/scroll-area";
import { cn } from "@/lib/utils";
import { Loader2, Send, User, Sparkles } from "lucide-react";
import { useState, useEffect, useRef } from "react";
import { Streamdown } from "streamdown";

/**
 * Message type matching server-side LLM Message interface
 */
export type Message = {
  role: "system" | "user" | "assistant";
  content: string;
};

export type AIChatBoxProps = {
  /**
   * Messages array to display in the chat.
   * Should match the format used by invokeLLM on the server.
   */
  messages: Message[];

  /**
   * Callback when user sends a message.
   * Typically you'll call a tRPC mutation here to invoke the LLM.
   */
  onSendMessage: (content: string) => void;

  /**
   * Whether the AI is currently generating a response
   */
  isLoading?: boolean;

  /**
   * Placeholder text for the input field
   */
  placeholder?: string;

  /**
   * Custom className for the container
   */
  className?: string;

  /**
   * Height of the chat box (default: 600px)
   */
  height?: string | number;

  /**
   * Empty state message to display when no messages
   */
  emptyStateMessage?: string;

  /**
   * Suggested prompts to display in empty state
   * Click to send directly
   */
  suggestedPrompts?: string[];
};

/**
 * A ready-to-use AI chat box component that integrates with the LLM system.
 *
 * Features:
 * - Matches server-side Message interface for seamless integration
 * - Markdown rendering with Streamdown
 * - Auto-scrolls to latest message
 * - Loading states
 * - Uses global theme colors from index.css
 *
 * @example
 * ```tsx
 * const ChatPage = () => {
 *   const [messages, setMessages] = useState<Message[]>([
 *     { role: "system", content: "You are a helpful assistant." }
 *   ]);
 *
 *   const chatMutation = trpc.ai.chat.useMutation({
 *     onSuccess: (response) => {
 *       // Assuming your tRPC endpoint returns the AI response as a string
 *       setMessages(prev => [...prev, {
 *         role: "assistant",
 *         content: response
 *       }]);
 *     },
 *     onError: (error) => {
 *       console.error("Chat error:", error);
 *       // Optionally show error message to user
 *     }
 *   });
 *
 *   const handleSend = (content: string) => {
 *     const newMessages = [...messages, { role: "user", content }];
 *     setMessages(newMessages);
 *     chatMutation.mutate({ messages: newMessages });
 *   };
 *
 *   return (
 *     <AIChatBox
 *       messages={messages}
 *       onSendMessage={handleSend}
 *       isLoading={chatMutation.isPending}
 *       suggestedPrompts={[
 *         "Explain quantum computing",
 *         "Write a hello world in Python"
 *       ]}
 *     />
 *   );
 * };
 * ```
 */
export function AIChatBox({
  messages,
  onSendMessage,
  isLoading = false,
  placeholder = "Type your message...",
  className,
  height = "600px",
  emptyStateMessage = "Start a conversation with AI",
  suggestedPrompts,
}: AIChatBoxProps) {
  const [input, setInput] = useState("");
  const scrollAreaRef = useRef<HTMLDivElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const inputAreaRef = useRef<HTMLFormElement>(null);
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  // Filter out system messages
  const displayMessages = messages.filter((msg) => msg.role !== "system");

  // Calculate min-height for last assistant message to push user message to top
  const [minHeightForLastMessage, setMinHeightForLastMessage] = useState(0);

  useEffect(() => {
    if (containerRef.current && inputAreaRef.current) {
      const containerHeight = containerRef.current.offsetHeight;
      const inputHeight = inputAreaRef.current.offsetHeight;
      const scrollAreaHeight = containerHeight - inputHeight;

      // Reserve space for:
      // - padding (p-4 = 32px top+bottom)
      // - user message: 40px (item height) + 16px (margin-top from space-y-4) = 56px
      // Note: margin-bottom is not counted because it naturally pushes the assistant message down
      const userMessageReservedHeight = 56;
      const calculatedHeight = scrollAreaHeight - 32 - userMessageReservedHeight;

      setMinHeightForLastMessage(Math.max(0, calculatedHeight));
    }
  }, []);

  // Scroll to bottom helper function with smooth animation
  const scrollToBottom = () => {
    const viewport = scrollAreaRef.current?.querySelector(
      '[data-radix-scroll-area-viewport]'
    ) as HTMLDivElement;

    if (viewport) {
      requestAnimationFrame(() => {
        viewport.scrollTo({
          top: viewport.scrollHeight,
          behavior: 'smooth'
        });
      });
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const trimmedInput = input.trim();
    if (!trimmedInput || isLoading) return;

    onSendMessage(trimmedInput);
    setInput("");

    // Scroll immediately after sending
    scrollToBottom();

    // Keep focus on input
    textareaRef.current?.focus();
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSubmit(e);
    }
  };

  return (
    <div
      ref={containerRef}
      className={cn(
        "flex flex-col bg-card text-card-foreground rounded-lg border shadow-sm",
        className
      )}
      style={{ height }}
    >
      {/* Messages Area */}
      <div ref={scrollAreaRef} className="flex-1 overflow-hidden">
        {displayMessages.length === 0 ? (
          <div className="flex h-full flex-col p-4">
            <div className="flex flex-1 flex-col items-center justify-center gap-6 text-muted-foreground">
              <div className="flex flex-col items-center gap-3">
                <Sparkles className="size-12 opacity-20" />
                <p className="text-sm">{emptyStateMessage}</p>
              </div>

              {suggestedPrompts && suggestedPrompts.length > 0 && (
                <div className="flex max-w-2xl flex-wrap justify-center gap-2">
                  {suggestedPrompts.map((prompt, index) => (
                    <button
                      key={index}
                      onClick={() => onSendMessage(prompt)}
                      disabled={isLoading}
                      className="rounded-lg border border-border bg-card px-4 py-2 text-sm transition-colors hover:bg-accent disabled:cursor-not-allowed disabled:opacity-50"
                    >
                      {prompt}
                    </button>
                  ))}
                </div>
              )}
            </div>
          </div>
        ) : (
          <ScrollArea className="h-full">
            <div className="flex flex-col space-y-4 p-4">
              {displayMessages.map((message, index) => {
                // Apply min-height to last message only if NOT loading (when loading, the loading indicator gets it)
                const isLastMessage = index === displayMessages.length - 1;
                const shouldApplyMinHeight =
                  isLastMessage && !isLoading && minHeightForLastMessage > 0;

                return (
                  <div
                    key={index}
                    className={cn(
                      "flex gap-3",
                      message.role === "user"
                        ? "justify-end items-start"
                        : "justify-start items-start"
                    )}
                    style={
                      shouldApplyMinHeight
                        ? { minHeight: `${minHeightForLastMessage}px` }
                        : undefined
                    }
                  >
                    {message.role === "assistant" && (
                      <div className="size-8 shrink-0 mt-1 rounded-full bg-primary/10 flex items-center justify-center">
                        <Sparkles className="size-4 text-primary" />
                      </div>
                    )}

                    <div
                      className={cn(
                        "max-w-[80%] rounded-lg px-4 py-2.5",
                        message.role === "user"
                          ? "bg-primary text-primary-foreground"
                          : "bg-muted text-foreground"
                      )}
                    >
                      {message.role === "assistant" ? (
                        <div className="prose prose-sm dark:prose-invert max-w-none">
                          <Streamdown>{message.content}</Streamdown>
                        </div>
                      ) : (
                        <p className="whitespace-pre-wrap text-sm">
                          {message.content}
                        </p>
                      )}
                    </div>

                    {message.role === "user" && (
                      <div className="size-8 shrink-0 mt-1 rounded-full bg-secondary flex items-center justify-center">
                        <User className="size-4 text-secondary-foreground" />
                      </div>
                    )}
                  </div>
                );
              })}

              {isLoading && (
                <div
                  className="flex items-start gap-3"
                  style={
                    minHeightForLastMessage > 0
                      ? { minHeight: `${minHeightForLastMessage}px` }
                      : undefined
                  }
                >
                  <div className="size-8 shrink-0 mt-1 rounded-full bg-primary/10 flex items-center justify-center">
                    <Sparkles className="size-4 text-primary" />
                  </div>
                  <div className="rounded-lg bg-muted px-4 py-2.5">
                    <Loader2 className="size-4 animate-spin text-muted-foreground" />
                  </div>
                </div>
              )}
            </div>
          </ScrollArea>
        )}
      </div>

      {/* Input Area */}
      <form
        ref={inputAreaRef}
        onSubmit={handleSubmit}
        className="flex gap-2 p-4 border-t bg-background/50 items-end"
      >
        <Textarea
          ref={textareaRef}
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder={placeholder}
          className="flex-1 max-h-32 resize-none min-h-9"
          rows={1}
        />
        <Button
          type="submit"
          size="icon"
          disabled={!input.trim() || isLoading}
          className="shrink-0 h-[38px] w-[38px]"
        >
          {isLoading ? (
            <Loader2 className="size-4 animate-spin" />
          ) : (
            <Send className="size-4" />
          )}
        </Button>
      </form>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/components/CompetencyRadarChart.tsx
========================================
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer, Legend, Tooltip } from "recharts";

interface Competency {
  name: string;
  currentLevel: number;
  requiredLevel: number;
  category?: string;
}

interface CompetencyRadarChartProps {
  competencies: Competency[];
  title?: string;
  description?: string;
}

export default function CompetencyRadarChart({
  competencies,
  title = "Mapa de CompetÃªncias",
  description = "ComparaÃ§Ã£o entre nÃ­vel atual e nÃ­vel esperado",
}: CompetencyRadarChartProps) {
  // Preparar dados para o grÃ¡fico
  const chartData = competencies.map((comp) => ({
    competency: comp.name.length > 20 ? comp.name.substring(0, 20) + "..." : comp.name,
    fullName: comp.name,
    "NÃ­vel Atual": comp.currentLevel,
    "NÃ­vel Esperado": comp.requiredLevel,
    gap: comp.requiredLevel - comp.currentLevel,
  }));

  // Calcular estatÃ­sticas
  const avgCurrent = competencies.reduce((sum, c) => sum + c.currentLevel, 0) / competencies.length;
  const avgRequired = competencies.reduce((sum, c) => sum + c.requiredLevel, 0) / competencies.length;
  const totalGap = competencies.reduce((sum, c) => sum + Math.max(0, c.requiredLevel - c.currentLevel), 0);
  const competenciesWithGap = competencies.filter((c) => c.currentLevel < c.requiredLevel).length;

  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
        <CardDescription>{description}</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-6">
          {/* EstatÃ­sticas */}
          <div className="grid grid-cols-4 gap-4">
            <div className="text-center p-3 bg-muted rounded-lg">
              <p className="text-2xl font-bold text-primary">{avgCurrent.toFixed(1)}</p>
              <p className="text-xs text-muted-foreground">NÃ­vel MÃ©dio Atual</p>
            </div>
            <div className="text-center p-3 bg-muted rounded-lg">
              <p className="text-2xl font-bold text-purple-600">{avgRequired.toFixed(1)}</p>
              <p className="text-xs text-muted-foreground">NÃ­vel MÃ©dio Esperado</p>
            </div>
            <div className="text-center p-3 bg-muted rounded-lg">
              <p className="text-2xl font-bold text-orange-600">{totalGap.toFixed(1)}</p>
              <p className="text-xs text-muted-foreground">Gap Total</p>
            </div>
            <div className="text-center p-3 bg-muted rounded-lg">
              <p className="text-2xl font-bold text-red-600">{competenciesWithGap}</p>
              <p className="text-xs text-muted-foreground">CompetÃªncias com Gap</p>
            </div>
          </div>

          {/* GrÃ¡fico Radar */}
          <ResponsiveContainer width="100%" height={400}>
            <RadarChart data={chartData}>
              <PolarGrid strokeDasharray="3 3" />
              <PolarAngleAxis
                dataKey="competency"
                tick={{ fontSize: 11, fill: "currentColor" }}
              />
              <PolarRadiusAxis angle={90} domain={[0, 5]} tick={{ fontSize: 10 }} />
              <Radar
                name="NÃ­vel Atual"
                dataKey="NÃ­vel Atual"
                stroke="hsl(var(--primary))"
                fill="hsl(var(--primary))"
                fillOpacity={0.3}
                strokeWidth={2}
              />
              <Radar
                name="NÃ­vel Esperado"
                dataKey="NÃ­vel Esperado"
                stroke="hsl(280, 100%, 50%)"
                fill="hsl(280, 100%, 50%)"
                fillOpacity={0.1}
                strokeWidth={2}
                strokeDasharray="5 5"
              />
              <Legend
                wrapperStyle={{ paddingTop: "20px" }}
                iconType="circle"
              />
              <Tooltip
                content={({ active, payload }) => {
                  if (active && payload && payload.length) {
                    const data = payload[0].payload;
                    return (
                      <div className="bg-background border rounded-lg p-3 shadow-lg">
                        <p className="font-semibold text-sm mb-2">{data.fullName}</p>
                        <div className="space-y-1 text-xs">
                          <div className="flex items-center justify-between gap-4">
                            <span className="text-muted-foreground">NÃ­vel Atual:</span>
                            <span className="font-semibold text-primary">{data["NÃ­vel Atual"]}</span>
                          </div>
                          <div className="flex items-center justify-between gap-4">
                            <span className="text-muted-foreground">NÃ­vel Esperado:</span>
                            <span className="font-semibold text-purple-600">{data["NÃ­vel Esperado"]}</span>
                          </div>
                          <div className="flex items-center justify-between gap-4 pt-1 border-t">
                            <span className="text-muted-foreground">Gap:</span>
                            <span className={`font-semibold ${data.gap > 0 ? "text-red-600" : "text-green-600"}`}>
                              {data.gap > 0 ? `+${data.gap}` : data.gap}
                            </span>
                          </div>
                        </div>
                      </div>
                    );
                  }
                  return null;
                }}
              />
            </RadarChart>
          </ResponsiveContainer>

          {/* Lista de Gaps */}
          {competenciesWithGap > 0 && (
            <div className="space-y-2">
              <h4 className="text-sm font-semibold">CompetÃªncias PrioritÃ¡rias para Desenvolvimento</h4>
              <div className="space-y-1">
                {competencies
                  .filter((c) => c.currentLevel < c.requiredLevel)
                  .sort((a, b) => (b.requiredLevel - b.currentLevel) - (a.requiredLevel - a.currentLevel))
                  .slice(0, 5)
                  .map((comp, idx) => (
                    <div
                      key={idx}
                      className="flex items-center justify-between p-2 bg-muted rounded text-sm"
                    >
                      <span className="font-medium">{comp.name}</span>
                      <div className="flex items-center gap-4">
                        <span className="text-xs text-muted-foreground">
                          {comp.currentLevel} â†’ {comp.requiredLevel}
                        </span>
                        <span className="text-xs font-semibold text-red-600">
                          Gap: +{comp.requiredLevel - comp.currentLevel}
                        </span>
                      </div>
                    </div>
                  ))}
              </div>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}


========================================
ARQUIVO: ./client/src/components/CostCenterFilter.tsx
========================================
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { trpc } from "@/lib/trpc";
import { Building2 } from "lucide-react";

interface CostCenterFilterProps {
  value: string;
  onChange: (value: string) => void;
  label?: string;
  showLabel?: boolean;
}

/**
 * Componente de filtro por centro de custos
 * ReutilizÃ¡vel em mÃºltiplos dashboards
 */
export function CostCenterFilter({ 
  value, 
  onChange, 
  label = "Centro de Custos",
  showLabel = true 
}: CostCenterFilterProps) {
  // Buscar centros de custos
  const { data: costCenters, isLoading } = trpc.costCenters.list.useQuery();

  if (isLoading) {
    return (
      <div className="flex items-center gap-2 text-sm text-muted-foreground">
        <Building2 className="h-4 w-4 animate-pulse" />
        <span>Carregando...</span>
      </div>
    );
  }

  return (
    <div className="space-y-2">
      {showLabel && (
        <Label htmlFor="cost-center-filter" className="flex items-center gap-2">
          <Building2 className="h-4 w-4" />
          {label}
        </Label>
      )}
      <Select value={value} onValueChange={onChange}>
        <SelectTrigger id="cost-center-filter" className="w-full md:w-[280px]">
          <SelectValue placeholder="Selecione um centro de custos" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">
            <span className="font-semibold">ðŸ“Š Todos os Centros de Custos</span>
          </SelectItem>
          {costCenters && costCenters.length > 0 ? (
            costCenters.map((cc: any) => (
              <SelectItem key={cc.id} value={cc.id.toString()}>
                <div className="flex flex-col">
                  <span className="font-medium">{cc.code}</span>
                  <span className="text-xs text-muted-foreground">{cc.name}</span>
                </div>
              </SelectItem>
            ))
          ) : (
            <SelectItem value="none" disabled>
              Nenhum centro de custos encontrado
            </SelectItem>
          )}
        </SelectContent>
      </Select>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/components/DashboardLayout.tsx
========================================
import { useAuth } from "@/_core/hooks/useAuth";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarHeader,
  SidebarInset,
  SidebarMenu,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarProvider,
  SidebarTrigger,
  useSidebar,
} from "@/components/ui/sidebar";
import { APP_LOGO, APP_TITLE, getLoginUrl } from "@/const";
import { useIsMobile } from "@/hooks/useMobile";
import { BarChart3, FileText, Goal, LayoutDashboard, LogOut, PanelLeft, Settings, Target, TrendingUp, User as UserIcon, Users, History as HistoryIcon, ChevronDown, ChevronRight, Activity, RefreshCw, Star, Scale, Grid3x3, GraduationCap, Lightbulb, GitBranch, CheckSquare, UsersRound, Building2, DollarSign, Workflow, Gift, Inbox, BarChart, Brain, Mail, FileSearch, MessageSquare, Trophy, Calendar, Clock, CheckCircle, AlertTriangle, Upload, Search } from "lucide-react";
import { CSSProperties, useEffect, useRef, useState } from "react";
import { useLocation } from "wouter";
import { DashboardLayoutSkeleton } from './DashboardLayoutSkeleton';
import { Button } from "./ui/button";
import NotificationCenter from "./NotificationCenter";
import { GlobalSearch, useGlobalSearchShortcut } from "./GlobalSearch";
import { Breadcrumbs } from "./Breadcrumbs";

// Componente de seÃ§Ã£o com submenu
function MenuSection({ item, location, setLocation }: { item: any; location: string; setLocation: (path: string) => void }) {
  const [isOpen, setIsOpen] = useState(true);
  
  return (
    <div className="space-y-1">
      <SidebarMenuItem>
        <SidebarMenuButton
          onClick={() => setIsOpen(!isOpen)}
          className="h-10 transition-all font-medium"
        >
          <item.icon className="h-4 w-4" />
          <span>{item.label}</span>
          {isOpen ? <ChevronDown className="h-4 w-4 ml-auto" /> : <ChevronRight className="h-4 w-4 ml-auto" />}
        </SidebarMenuButton>
      </SidebarMenuItem>
      {isOpen && (
        <div className="ml-4 space-y-0.5">
          {item.children.map((child: any) => {
            const isActive = location === child.path;
            return (
              <SidebarMenuItem key={child.path}>
                <SidebarMenuButton
                  isActive={isActive}
                  onClick={() => setLocation(child.path)}
                  tooltip={child.label}
                  className="h-9 transition-all font-normal text-sm"
                >
                  <child.icon className={`h-3.5 w-3.5 ${isActive ? "text-primary" : "text-muted-foreground"}`} />
                  <span>{child.label}</span>
                </SidebarMenuButton>
              </SidebarMenuItem>
            );
          })}
        </div>
      )}
    </div>
  );
}

const menuItems = [
  { icon: LayoutDashboard, label: "Dashboard", path: "/" },
  { icon: BarChart, label: "Dashboard Executivo", path: "/dashboard-executivo" },
  { icon: BarChart3, label: "Analytics de RH", path: "/analytics" },
  { icon: Target, label: "Metas", path: "/metas" },
  {
    icon: TrendingUp,
    label: "Performance",
    isSection: true,
    children: [
      { icon: Activity, label: "Performance Integrada", path: "/performance-integrada" },
      { icon: RefreshCw, label: "AvaliaÃ§Ã£o 360Â°", path: "/avaliacoes" },
      { icon: Star, label: "360Â° Enhanced", path: "/360-enhanced" },
      { icon: Scale, label: "CalibraÃ§Ã£o", path: "/calibracao" },
      { icon: Grid3x3, label: "Nine Box", path: "/nine-box" },
      { icon: BarChart3, label: "Nine Box Comparativo", path: "/nine-box-comparativo" },
    ],
  },
  {
    icon: GraduationCap,
    label: "Desenvolvimento",
    isSection: true,
    children: [
      { icon: Lightbulb, label: "PDI Inteligente", path: "/pdi" },
      { icon: GitBranch, label: "Mapa de SucessÃ£o", path: "/sucessao" },
      { icon: Brain, label: "Testes PsicomÃ©tricos", path: "/testes-psicometricos" },
      { icon: MessageSquare, label: "Feedback ContÃ­nuo", path: "/feedback" },
      { icon: Trophy, label: "Conquistas e Badges", path: "/badges" },
      { icon: BarChart3, label: "Pesquisas de Pulse", path: "/pesquisas-pulse" },
    ],
  },
  {
    icon: UsersRound,
    label: "GestÃ£o de Pessoas",
    isSection: true,
    children: [
      { icon: Users, label: "FuncionÃ¡rios", path: "/funcionarios" },
      { icon: Building2, label: "Departamentos", path: "/departamentos" },
      { icon: DollarSign, label: "Centros de Custo", path: "/centros-custo" },
      { icon: GitBranch, label: "Hierarquia Organizacional", path: "/admin/hierarquia" },
      { icon: FileText, label: "DescriÃ§Ã£o de Cargos", path: "/descricao-cargos" },
      { icon: FileText, label: "DescriÃ§Ã£o de Cargos UISA", path: "/descricao-cargos-uisa" },
      { icon: Clock, label: "Minhas Atividades", path: "/minhas-atividades" },
      { icon: BarChart3, label: "RelatÃ³rios de Produtividade", path: "/relatorios-produtividade" },
      { icon: CheckCircle, label: "ValidaÃ§Ã£o por LÃ­der", path: "/validacao-lider" },
      { icon: AlertTriangle, label: "AnÃ¡lise de Gaps", path: "/analise-gaps" },
      { icon: Upload, label: "ImportaÃ§Ã£o em Massa", path: "/importacao-descricoes" },
    ],
  },
  {
    icon: CheckSquare,
    label: "AprovaÃ§Ãµes",
    isSection: true,
    children: [
      { icon: BarChart, label: "Dashboard", path: "/aprovacoes/dashboard" },
      { icon: Inbox, label: "Minhas SolicitaÃ§Ãµes", path: "/aprovacoes/solicitacoes" },
      { icon: CheckSquare, label: "PDIs Pendentes", path: "/aprovacoes/pdi" },
      { icon: Users, label: "AvaliaÃ§Ãµes Pendentes", path: "/aprovacoes/avaliacoes" },
      { icon: Gift, label: "BÃ´nus", path: "/aprovacoes/bonus" },
      { icon: Workflow, label: "Workflows", path: "/aprovacoes/workflows" },
    ],
  },
  {
    icon: DollarSign,
    label: "BÃ´nus",
    isSection: true,
    children: [
      { icon: DollarSign, label: "PolÃ­ticas", path: "/bonus" },
      { icon: TrendingUp, label: "PrevisÃ£o", path: "/previsao-bonus" },
      { icon: CheckSquare, label: "AprovaÃ§Ã£o em Lote", path: "/aprovacoes/bonus-lote" },
      { icon: FileSearch, label: "Auditoria", path: "/bonus/auditoria" },
      { icon: FileText, label: "RelatÃ³rios", path: "/relatorios/bonus" },
    ],
  },
  { icon: HistoryIcon, label: "HistÃ³rico", path: "/historico" },
  { icon: FileText, label: "RelatÃ³rios", path: "/relatorios" },
  {
    icon: Settings,
    label: "ConfiguraÃ§Ãµes",
    isSection: true,
    children: [
      { icon: Settings, label: "Gerais", path: "/configuracoes" },
      { icon: BarChart3, label: "Analytics (Admin)", path: "/admin/analytics" },
      { icon: Mail, label: "SMTP (Admin)", path: "/admin/smtp" },
      { icon: BarChart, label: "MÃ©tricas de E-mail", path: "/admin/email-metrics" },
      { icon: Mail, label: "Dashboard de Emails", path: "/admin/emails" },
      { icon: Calendar, label: "RelatÃ³rios Agendados", path: "/admin/scheduled-reports" },
      { icon: BarChart3, label: "Report Builder", path: "/admin/report-builder" },
      { icon: TrendingUp, label: "Analytics (Reports)", path: "/admin/report-analytics" },
      { icon: Inbox, label: "Importar Dados UISA", path: "/admin/succession-import" },
      { icon: BarChart3, label: "Dashboard Executivo", path: "/executive-dashboard" },
      { icon: FileSearch, label: "HistÃ³rico de AlteraÃ§Ãµes", path: "/admin/audit-log" },
    ],
  },
];

const SIDEBAR_WIDTH_KEY = "sidebar-width";
const DEFAULT_WIDTH = 280;
const MIN_WIDTH = 200;
const MAX_WIDTH = 480;

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const [sidebarWidth, setSidebarWidth] = useState(() => {
    const saved = localStorage.getItem(SIDEBAR_WIDTH_KEY);
    return saved ? parseInt(saved, 10) : DEFAULT_WIDTH;
  });
  const { loading, user } = useAuth();

  useEffect(() => {
    localStorage.setItem(SIDEBAR_WIDTH_KEY, sidebarWidth.toString());
  }, [sidebarWidth]);

  if (loading) {
    return <DashboardLayoutSkeleton />
  }

  if (!user) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="flex flex-col items-center gap-8 p-8 max-w-md w-full">
          <div className="flex flex-col items-center gap-6">
            <div className="relative group">
              <div className="relative">
                <img
                  src={APP_LOGO}
                  alt={APP_TITLE}
                  className="h-20 w-20 rounded-xl object-cover shadow"
                />
              </div>
            </div>
            <div className="text-center space-y-2">
              <h1 className="text-2xl font-bold tracking-tight">{APP_TITLE}</h1>
              <p className="text-sm text-muted-foreground">
                Please sign in to continue
              </p>
            </div>
          </div>
          <Button
            onClick={() => {
              window.location.href = getLoginUrl();
            }}
            size="lg"
            className="w-full shadow-lg hover:shadow-xl transition-all"
          >
            Sign in
          </Button>
        </div>
      </div>
    );
  }

  return (
    <SidebarProvider
      style={
        {
          "--sidebar-width": `${sidebarWidth}px`,
        } as CSSProperties
      }
    >
      <DashboardLayoutContent setSidebarWidth={setSidebarWidth}>
        {children}
      </DashboardLayoutContent>
    </SidebarProvider>
  );
}

type DashboardLayoutContentProps = {
  children: React.ReactNode;
  setSidebarWidth: (width: number) => void;
};

function DashboardLayoutContent({
  children,
  setSidebarWidth,
}: DashboardLayoutContentProps) {
  const { user, logout } = useAuth();
  const [location, setLocation] = useLocation();
  const { state, toggleSidebar } = useSidebar();
  const isCollapsed = state === "collapsed";
  const [isResizing, setIsResizing] = useState(false);
  const sidebarRef = useRef<HTMLDivElement>(null);
  const activeMenuItem = menuItems.find(item => item.path === location);
  const isMobile = useIsMobile();
  const [searchOpen, setSearchOpen] = useState(false);
  
  // Ativar atalho de teclado Ctrl+K / Cmd+K
  useGlobalSearchShortcut(() => setSearchOpen(true));

  useEffect(() => {
    if (isCollapsed) {
      setIsResizing(false);
    }
  }, [isCollapsed]);

  useEffect(() => {
    const handleMouseMove = (e: MouseEvent) => {
      if (!isResizing) return;

      const sidebarLeft = sidebarRef.current?.getBoundingClientRect().left ?? 0;
      const newWidth = e.clientX - sidebarLeft;
      if (newWidth >= MIN_WIDTH && newWidth <= MAX_WIDTH) {
        setSidebarWidth(newWidth);
      }
    };

    const handleMouseUp = () => {
      setIsResizing(false);
    };

    if (isResizing) {
      document.addEventListener("mousemove", handleMouseMove);
      document.addEventListener("mouseup", handleMouseUp);
      document.body.style.cursor = "col-resize";
      document.body.style.userSelect = "none";
    }

    return () => {
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
      document.body.style.cursor = "";
      document.body.style.userSelect = "";
    };
  }, [isResizing, setSidebarWidth]);

  return (
    <>
      <div className="relative" ref={sidebarRef}>
        <Sidebar
          collapsible="icon"
          className="border-r-0"
          disableTransition={isResizing}
        >
          <SidebarHeader className="h-16 justify-center">
            <div className="flex items-center gap-3 pl-2 group-data-[collapsible=icon]:px-0 transition-all w-full">
              {isCollapsed ? (
                <div className="relative h-8 w-8 shrink-0 group">
                  <img
                    src={APP_LOGO}
                    className="h-8 w-8 rounded-md object-cover ring-1 ring-border"
                    alt="Logo"
                  />
                  <button
                    onClick={toggleSidebar}
                    className="absolute inset-0 flex items-center justify-center bg-accent rounded-md ring-1 ring-border opacity-0 group-hover:opacity-100 transition-opacity focus:outline-none focus-visible:ring-2 focus-visible:ring-ring"
                  >
                    <PanelLeft className="h-4 w-4 text-foreground" />
                  </button>
                </div>
              ) : (
                <>
                  <div className="flex items-center gap-3 min-w-0">
                    <img
                      src={APP_LOGO}
                      className="h-8 w-8 rounded-md object-cover ring-1 ring-border shrink-0"
                      alt="Logo"
                    />
                    <span className="font-semibold tracking-tight truncate">
                      {APP_TITLE}
                    </span>
                  </div>
                  <button
                    onClick={toggleSidebar}
                    className="ml-auto h-8 w-8 flex items-center justify-center hover:bg-accent rounded-lg transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-ring shrink-0"
                  >
                    <PanelLeft className="h-4 w-4 text-muted-foreground" />
                  </button>
                </>
              )}
            </div>
          </SidebarHeader>

          <SidebarContent className="gap-0">
            <SidebarMenu className="px-2 py-1">
              {menuItems.map((item, idx) => {
                if (item.isSection && item.children) {
                  return <MenuSection key={idx} item={item} location={location} setLocation={setLocation} />;
                }
                const isActive = location === item.path;
                return (
                  <SidebarMenuItem key={item.path || idx}>
                    <SidebarMenuButton
                      isActive={isActive}
                      onClick={() => item.path && setLocation(item.path)}
                      tooltip={item.label}
                      className={`h-10 transition-all font-normal`}
                    >
                      <item.icon
                        className={`h-4 w-4 ${isActive ? "text-primary" : ""}`}
                      />
                      <span>{item.label}</span>
                    </SidebarMenuButton>
                  </SidebarMenuItem>
                );
              })}
            </SidebarMenu>
          </SidebarContent>

          <SidebarFooter className="p-3">
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <button className="flex items-center gap-3 rounded-lg px-1 py-1 hover:bg-accent/50 transition-colors w-full text-left group-data-[collapsible=icon]:justify-center focus:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <Avatar className="h-9 w-9 border shrink-0">
                    <AvatarFallback className="text-xs font-medium">
                      {user?.name?.charAt(0).toUpperCase()}
                    </AvatarFallback>
                  </Avatar>
                  <div className="flex-1 min-w-0 group-data-[collapsible=icon]:hidden">
                    <p className="text-sm font-medium truncate leading-none">
                      {user?.name || "-"}
                    </p>
                    <p className="text-xs text-muted-foreground truncate mt-1.5">
                      {user?.email || "-"}
                    </p>
                  </div>
                </button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end" className="w-48">
                <DropdownMenuItem
                  onClick={() => setLocation('/perfil')}
                  className="cursor-pointer"
                >
                  <UserIcon className="mr-2 h-4 w-4" />
                  <span>Meu Perfil</span>
                </DropdownMenuItem>
                <DropdownMenuItem
                  onClick={logout}
                  className="cursor-pointer text-destructive focus:text-destructive"
                >
                  <LogOut className="mr-2 h-4 w-4" />
                  <span>Sign out</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </SidebarFooter>
        </Sidebar>
        <div
          className={`absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-primary/20 transition-colors ${isCollapsed ? "hidden" : ""}`}
          onMouseDown={() => {
            if (isCollapsed) return;
            setIsResizing(true);
          }}
          style={{ zIndex: 50 }}
        />
      </div>

      <SidebarInset>
        {isMobile && (
          <div className="flex border-b h-14 items-center justify-between bg-background/95 px-2 backdrop-blur supports-[backdrop-filter]:backdrop-blur sticky top-0 z-40">
            <div className="flex items-center gap-2">
              <SidebarTrigger className="h-9 w-9 rounded-lg bg-background" />
              <div className="flex items-center gap-3">
                <div className="flex flex-col gap-1">
                  <span className="tracking-tight text-foreground">
                    {activeMenuItem?.label ?? APP_TITLE}
                  </span>
                </div>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => setSearchOpen(true)}
                className="h-9 w-9"
              >
                <Search className="h-4 w-4" />
              </Button>
              <NotificationCenter />
            </div>
          </div>
        )}
        {!isMobile && (
          <div className="flex border-b h-14 items-center justify-between bg-background/95 px-4 backdrop-blur supports-[backdrop-filter]:backdrop-blur sticky top-0 z-40">
            <div className="flex items-center gap-4">
              <SidebarTrigger className="h-9 w-9 rounded-lg bg-background" />
              <h1 className="text-lg font-semibold">{activeMenuItem?.label ?? APP_TITLE}</h1>
            </div>
            <div className="flex items-center gap-2">
              <Button
                variant="outline"
                onClick={() => setSearchOpen(true)}
                className="h-9 gap-2 px-3"
              >
                <Search className="h-4 w-4" />
                <span className="text-sm text-muted-foreground">Buscar...</span>
                <kbd className="pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100">
                  <span className="text-xs">âŒ˜</span>K
                </kbd>
              </Button>
              <NotificationCenter />
            </div>
          </div>
        )}
        <GlobalSearch open={searchOpen} onOpenChange={setSearchOpen} />
        <main className="flex-1 p-4">
          <Breadcrumbs />
          {children}
        </main>
      </SidebarInset>
    </>
  );
}


========================================
ARQUIVO: ./client/src/components/DashboardLayoutSkeleton.tsx
========================================
import { Skeleton } from './ui/skeleton';

export function DashboardLayoutSkeleton() {
  return (
    <div className="flex min-h-screen bg-background">
      {/* Sidebar skeleton */}
      <div className="w-[280px] border-r border-border bg-background p-4 space-y-6">
        {/* Logo area */}
        <div className="flex items-center gap-3 px-2">
          <Skeleton className="h-8 w-8 rounded-md" />
          <Skeleton className="h-4 w-24" />
        </div>

        {/* Menu items */}
        <div className="space-y-2 px-2">
          <Skeleton className="h-10 w-full rounded-lg" />
          <Skeleton className="h-10 w-full rounded-lg" />
          <Skeleton className="h-10 w-full rounded-lg" />
        </div>

        {/* User profile area at bottom */}
        <div className="absolute bottom-4 left-4 right-4">
          <div className="flex items-center gap-3 px-1">
            <Skeleton className="h-9 w-9 rounded-full" />
            <div className="flex-1 space-y-2">
              <Skeleton className="h-3 w-20" />
              <Skeleton className="h-2 w-32" />
            </div>
          </div>
        </div>
      </div>

      {/* Main content skeleton */}
      <div className="flex-1 p-4 space-y-4">
        {/* Content blocks */}
        <Skeleton className="h-12 w-48 rounded-lg" />
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          <Skeleton className="h-32 rounded-xl" />
          <Skeleton className="h-32 rounded-xl" />
          <Skeleton className="h-32 rounded-xl" />
        </div>
        <Skeleton className="h-64 rounded-xl" />
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/components/ErrorBoundary.tsx
========================================
import { cn } from "@/lib/utils";
import { AlertTriangle, RotateCcw } from "lucide-react";
import { Component, ReactNode } from "react";

interface Props {
  children: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="flex items-center justify-center min-h-screen p-8 bg-background">
          <div className="flex flex-col items-center w-full max-w-2xl p-8">
            <AlertTriangle
              size={48}
              className="text-destructive mb-6 flex-shrink-0"
            />

            <h2 className="text-xl mb-4">An unexpected error occurred.</h2>

            <div className="p-4 w-full rounded bg-muted overflow-auto mb-6">
              <pre className="text-sm text-muted-foreground whitespace-break-spaces">
                {this.state.error?.stack}
              </pre>
            </div>

            <button
              onClick={() => window.location.reload()}
              className={cn(
                "flex items-center gap-2 px-4 py-2 rounded-lg",
                "bg-primary text-primary-foreground",
                "hover:opacity-90 cursor-pointer"
              )}
            >
              <RotateCcw size={16} />
              Reload Page
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;


========================================
ARQUIVO: ./client/src/components/EvaluationForm.tsx
========================================
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Textarea } from "@/components/ui/textarea";
import { trpc } from "@/lib/trpc";
import { CheckCircle2 } from "lucide-react";
import { useState } from "react";
import { toast } from "sonner";

interface EvaluationFormProps {
  evaluationId: number;
  type: "self" | "manager" | "peer" | "subordinate";
  onComplete?: () => void;
}

const competencies = [
  {
    id: 1,
    name: "ComunicaÃ§Ã£o",
    description: "Capacidade de se expressar claramente e ouvir ativamente",
  },
  {
    id: 2,
    name: "Trabalho em Equipe",
    description: "ColaboraÃ§Ã£o efetiva com colegas e contribuiÃ§Ã£o para objetivos comuns",
  },
  {
    id: 3,
    name: "LideranÃ§a",
    description: "Capacidade de inspirar, motivar e guiar outros",
  },
  {
    id: 4,
    name: "ResoluÃ§Ã£o de Problemas",
    description: "Habilidade de identificar e resolver desafios de forma criativa",
  },
  {
    id: 5,
    name: "Adaptabilidade",
    description: "Flexibilidade para lidar com mudanÃ§as e novas situaÃ§Ãµes",
  },
  {
    id: 6,
    name: "OrientaÃ§Ã£o para Resultados",
    description: "Foco em atingir metas e entregar resultados de qualidade",
  },
  {
    id: 7,
    name: "Iniciativa",
    description: "Proatividade e autonomia para tomar aÃ§Ãµes sem supervisÃ£o constante",
  },
  {
    id: 8,
    name: "Conhecimento TÃ©cnico",
    description: "DomÃ­nio das habilidades e conhecimentos necessÃ¡rios para a funÃ§Ã£o",
  },
];

const scaleLabels = [
  "InsatisfatÃ³rio",
  "Abaixo do Esperado",
  "Atende Expectativas",
  "Supera Expectativas",
  "Excepcional",
];

export default function EvaluationForm({ evaluationId, type, onComplete }: EvaluationFormProps) {
  const [ratings, setRatings] = useState<Record<number, number>>({});
  const [comments, setComments] = useState<Record<number, string>>({});
  const [generalComments, setGeneralComments] = useState("");
  const [submitted, setSubmitted] = useState(false);

  // TODO: Implement API call when endpoint is ready

  const getTypeLabel = () => {
    const labels = {
      self: "AutoavaliaÃ§Ã£o",
      manager: "AvaliaÃ§Ã£o do Gestor",
      peer: "AvaliaÃ§Ã£o de Pares",
      subordinate: "AvaliaÃ§Ã£o da Equipe",
    };
    return labels[type];
  };

  const handleRatingChange = (competencyId: number, value: string) => {
    setRatings({ ...ratings, [competencyId]: Number(value) });
  };

  const handleCommentChange = (competencyId: number, value: string) => {
    setComments({ ...comments, [competencyId]: value });
  };

  const handleSubmit = async () => {
    // Validate all competencies are rated
    const missingRatings = competencies.filter((c) => !ratings[c.id]);
    if (missingRatings.length > 0) {
      toast.error("Por favor, avalie todas as competÃªncias antes de enviar");
      return;
    }

    // TODO: Replace with actual API call
    // Simulate API call
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    setSubmitted(true);
    toast.success("AvaliaÃ§Ã£o enviada com sucesso!");
    onComplete?.();
  };

  if (submitted) {
    return (
      <Card>
        <CardContent className="flex flex-col items-center justify-center py-12">
          <CheckCircle2 className="h-16 w-16 text-green-600 mb-4" />
          <h3 className="font-semibold text-xl mb-2">AvaliaÃ§Ã£o Enviada!</h3>
          <p className="text-muted-foreground text-center">
            Obrigado por completar sua {getTypeLabel().toLowerCase()}
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle>{getTypeLabel()}</CardTitle>
          <CardDescription>
            Avalie cada competÃªncia usando a escala de 1 a 5. Seus comentÃ¡rios sÃ£o opcionais mas
            muito valiosos.
          </CardDescription>
        </CardHeader>
      </Card>

      {competencies.map((competency) => (
        <Card key={competency.id}>
          <CardHeader>
            <CardTitle className="text-base">{competency.name}</CardTitle>
            <CardDescription>{competency.description}</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="space-y-3">
              <Label>AvaliaÃ§Ã£o *</Label>
              <RadioGroup
                value={ratings[competency.id]?.toString()}
                onValueChange={(value) => handleRatingChange(competency.id, value)}
                className="flex flex-col space-y-2"
              >
                {[1, 2, 3, 4, 5].map((rating) => (
                  <div key={rating} className="flex items-center space-x-3">
                    <RadioGroupItem value={rating.toString()} id={`${competency.id}-${rating}`} />
                    <Label
                      htmlFor={`${competency.id}-${rating}`}
                      className="flex items-center gap-2 cursor-pointer font-normal"
                    >
                      <span className="font-semibold w-4">{rating}</span>
                      <span className="text-muted-foreground">- {scaleLabels[rating - 1]}</span>
                    </Label>
                  </div>
                ))}
              </RadioGroup>
            </div>

            <div className="space-y-2">
              <Label htmlFor={`comment-${competency.id}`}>
                ComentÃ¡rios (opcional)
              </Label>
              <Textarea
                id={`comment-${competency.id}`}
                placeholder="Adicione observaÃ§Ãµes ou exemplos especÃ­ficos..."
                value={comments[competency.id] || ""}
                onChange={(e) => handleCommentChange(competency.id, e.target.value)}
                rows={2}
              />
            </div>
          </CardContent>
        </Card>
      ))}

      <Card>
        <CardHeader>
          <CardTitle className="text-base">ComentÃ¡rios Gerais</CardTitle>
          <CardDescription>
            Adicione quaisquer observaÃ§Ãµes adicionais sobre o desempenho geral
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Textarea
            placeholder="Pontos fortes, Ã¡reas de melhoria, conquistas notÃ¡veis..."
            value={generalComments}
            onChange={(e) => setGeneralComments(e.target.value)}
            rows={4}
          />
        </CardContent>
      </Card>

      <div className="flex gap-2 justify-end sticky bottom-4 bg-background/95 backdrop-blur p-4 rounded-lg border">
        <Button variant="outline" onClick={() => window.history.back()}>
          Cancelar
        </Button>
        <Button onClick={handleSubmit}>
          Enviar AvaliaÃ§Ã£o
        </Button>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/components/FaceLogin.tsx
========================================
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import * as faceapi from "face-api.js";
import { Camera, Loader2, LogIn, X } from "lucide-react";
import { useEffect, useRef, useState } from "react";
import { toast } from "sonner";

interface FaceLoginProps {
  onSuccess?: (userId: number) => void;
  onCancel?: () => void;
}

export default function FaceLogin({ onSuccess, onCancel }: FaceLoginProps) {
  const videoRef = useRef<HTMLVideoElement>(null);
  const canvasRef = useRef<HTMLCanvasElement | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isVerifying, setIsVerifying] = useState(false);
  const [stream, setStream] = useState<MediaStream | null>(null);
  const [modelsLoaded, setModelsLoaded] = useState(false);

  useEffect(() => {
    loadModels();
    return () => {
      stopCamera();
    };
  }, []);

  const loadModels = async () => {
    try {
      setIsLoading(true);
      const MODEL_URL = "/models";
      
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
      ]);

      setModelsLoaded(true);
      await startCamera();
      setIsLoading(false);
      toast.success("CÃ¢mera iniciada. Posicione seu rosto.");
    } catch (error) {
      console.error("Error loading models:", error);
      toast.error("Erro ao carregar modelos");
      setIsLoading(false);
    }
  };

  const startCamera = async () => {
    try {
      const mediaStream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "user",
        },
      });

      if (videoRef.current) {
        videoRef.current.srcObject = mediaStream;
        setStream(mediaStream);
      }
    } catch (error) {
      console.error("Error starting camera:", error);
      toast.error("Erro ao acessar cÃ¢mera");
    }
  };

  const stopCamera = () => {
    if (stream) {
      stream.getTracks().forEach((track) => track.stop());
      setStream(null);
    }
  };

  const verifyFace = async () => {
    if (!videoRef.current || !modelsLoaded) {
      toast.error("Sistema nÃ£o estÃ¡ pronto");
      return;
    }

    setIsVerifying(true);

    try {
      const detection = await faceapi
        .detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!detection) {
        toast.error("Nenhum rosto detectado");
        setIsVerifying(false);
        return;
      }

      // TODO: Call API to verify face descriptor against stored descriptors
      // For now, simulate API call
      await new Promise((resolve) => setTimeout(resolve, 1500));

      // Mock: Simulate successful match
      const mockUserId = 1;
      const mockConfidence = 0.92; // 92% confidence

      if (mockConfidence >= 0.75) {
        toast.success("Reconhecimento facial bem-sucedido!");
        stopCamera();
        onSuccess?.(mockUserId);
      } else {
        toast.error("Rosto nÃ£o reconhecido. Tente novamente.");
        setIsVerifying(false);
      }
    } catch (error) {
      console.error("Error verifying face:", error);
      toast.error("Erro ao verificar rosto");
      setIsVerifying(false);
    }
  };

  const handleCancel = () => {
    stopCamera();
    onCancel?.();
  };

  return (
    <Card className="w-full max-w-md mx-auto">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Camera className="h-5 w-5" />
          Login com Reconhecimento Facial
        </CardTitle>
        <CardDescription>
          Posicione seu rosto na cÃ¢mera para fazer login
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Camera Feed */}
        <div className="relative bg-black rounded-lg overflow-hidden aspect-video">
          <video
            ref={videoRef}
            autoPlay
            muted
            playsInline
            className="w-full h-full object-cover"
          />
          <canvas
            ref={canvasRef}
            className="absolute top-0 left-0 w-full h-full"
          />

          {isLoading && (
            <div className="absolute inset-0 flex items-center justify-center bg-black/50">
              <div className="text-center text-white">
                <Loader2 className="h-8 w-8 animate-spin mx-auto mb-2" />
                <p>Carregando...</p>
              </div>
            </div>
          )}

          {isVerifying && (
            <div className="absolute inset-0 flex items-center justify-center bg-black/50">
              <div className="text-center text-white">
                <Loader2 className="h-8 w-8 animate-spin mx-auto mb-2" />
                <p>Verificando...</p>
              </div>
            </div>
          )}
        </div>

        {/* Instructions */}
        <div className="bg-blue-50 dark:bg-blue-950 p-3 rounded-lg">
          <p className="text-sm text-muted-foreground">
            ðŸ’¡ <strong>Dica:</strong> Posicione seu rosto centralizado e com boa iluminaÃ§Ã£o
          </p>
        </div>

        {/* Actions */}
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={handleCancel}
            className="flex-1"
            disabled={isVerifying}
          >
            <X className="h-4 w-4 mr-2" />
            Cancelar
          </Button>
          <Button
            onClick={verifyFace}
            disabled={isLoading || isVerifying}
            className="flex-1"
          >
            {isVerifying ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Verificando...
              </>
            ) : (
              <>
                <LogIn className="h-4 w-4 mr-2" />
                Fazer Login
              </>
            )}
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}


========================================
ARQUIVO: ./client/src/components/FaceRegistration.tsx
========================================
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import * as faceapi from "face-api.js";
import { Camera, CheckCircle2, Loader2, X } from "lucide-react";
import { useEffect, useRef, useState } from "react";
import { toast } from "sonner";

interface FaceRegistrationProps {
  onComplete?: (descriptors: Float32Array[]) => void;
  onCancel?: () => void;
}

export default function FaceRegistration({ onComplete, onCancel }: FaceRegistrationProps) {
  const videoRef = useRef<HTMLVideoElement>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isCapturing, setIsCapturing] = useState(false);
  const [capturedFaces, setCapturedFaces] = useState<Float32Array[]>([]);
  const [stream, setStream] = useState<MediaStream | null>(null);
  const [modelsLoaded, setModelsLoaded] = useState(false);

  const REQUIRED_PHOTOS = 5;
  const progressPercentage = (capturedFaces.length / REQUIRED_PHOTOS) * 100;

  useEffect(() => {
    loadModels();
    return () => {
      stopCamera();
    };
  }, []);

  const loadModels = async () => {
    try {
      setIsLoading(true);
      const MODEL_URL = "/models"; // Models should be in public/models folder
      
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
      ]);

      setModelsLoaded(true);
      await startCamera();
      setIsLoading(false);
      toast.success("CÃ¢mera iniciada com sucesso!");
    } catch (error) {
      console.error("Error loading models:", error);
      toast.error("Erro ao carregar modelos de reconhecimento facial");
      setIsLoading(false);
    }
  };

  const startCamera = async () => {
    try {
      const mediaStream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "user",
        },
      });

      if (videoRef.current) {
        videoRef.current.srcObject = mediaStream;
        setStream(mediaStream);
      }
    } catch (error) {
      console.error("Error starting camera:", error);
      toast.error("Erro ao acessar cÃ¢mera. Verifique as permissÃµes.");
    }
  };

  const stopCamera = () => {
    if (stream) {
      stream.getTracks().forEach((track) => track.stop());
      setStream(null);
    }
  };

  const captureFace = async () => {
    if (!videoRef.current || !canvasRef.current || !modelsLoaded) {
      toast.error("Sistema nÃ£o estÃ¡ pronto");
      return;
    }

    setIsCapturing(true);

    try {
      const detection = await faceapi
        .detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!detection) {
        toast.error("Nenhum rosto detectado. Posicione seu rosto na cÃ¢mera.");
        setIsCapturing(false);
        return;
      }

      // Draw detection on canvas
      const canvas = canvasRef.current;
      const displaySize = {
        width: videoRef.current.videoWidth,
        height: videoRef.current.videoHeight,
      };
      faceapi.matchDimensions(canvas, displaySize);

      const resizedDetection = faceapi.resizeResults(detection, displaySize);
      const ctx = canvas.getContext("2d");
      if (ctx) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        faceapi.draw.drawDetections(canvas, resizedDetection);
        faceapi.draw.drawFaceLandmarks(canvas, resizedDetection);
      }

      // Save descriptor
      setCapturedFaces((prev) => [...prev, detection.descriptor]);
      toast.success(`Foto ${capturedFaces.length + 1}/${REQUIRED_PHOTOS} capturada!`);

      // Check if we have enough photos
      if (capturedFaces.length + 1 >= REQUIRED_PHOTOS) {
        toast.success("Cadastro facial completo!");
        setTimeout(() => {
          onComplete?.([...capturedFaces, detection.descriptor]);
          stopCamera();
        }, 1000);
      }
    } catch (error) {
      console.error("Error capturing face:", error);
      toast.error("Erro ao capturar rosto");
    } finally {
      setIsCapturing(false);
    }
  };

  const handleCancel = () => {
    stopCamera();
    onCancel?.();
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Camera className="h-5 w-5" />
          Cadastro de Reconhecimento Facial
        </CardTitle>
        <CardDescription>
          Capture {REQUIRED_PHOTOS} fotos do seu rosto em diferentes Ã¢ngulos para melhor precisÃ£o
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Progress */}
        <div className="space-y-2">
          <div className="flex items-center justify-between text-sm">
            <span className="font-medium">Progresso</span>
            <span className="text-muted-foreground">
              {capturedFaces.length}/{REQUIRED_PHOTOS} fotos
            </span>
          </div>
          <Progress value={progressPercentage} className="h-2" />
        </div>

        {/* Camera Feed */}
        <div className="relative bg-black rounded-lg overflow-hidden aspect-video">
          <video
            ref={videoRef}
            autoPlay
            muted
            playsInline
            className="w-full h-full object-cover"
          />
          <canvas
            ref={canvasRef}
            className="absolute top-0 left-0 w-full h-full"
          />

          {isLoading && (
            <div className="absolute inset-0 flex items-center justify-center bg-black/50">
              <div className="text-center text-white">
                <Loader2 className="h-8 w-8 animate-spin mx-auto mb-2" />
                <p>Carregando modelos...</p>
              </div>
            </div>
          )}
        </div>

        {/* Instructions */}
        <div className="bg-blue-50 dark:bg-blue-950 p-4 rounded-lg space-y-2">
          <p className="text-sm font-medium">ðŸ“¸ InstruÃ§Ãµes:</p>
          <ul className="text-sm text-muted-foreground space-y-1 ml-4 list-disc">
            <li>Posicione seu rosto centralizado na cÃ¢mera</li>
            <li>Mantenha boa iluminaÃ§Ã£o no ambiente</li>
            <li>Tire fotos em diferentes Ã¢ngulos (frente, esquerda, direita)</li>
            <li>Mantenha expressÃ£o neutra</li>
            <li>Evite usar Ã³culos escuros ou chapÃ©us</li>
          </ul>
        </div>

        {/* Captured Photos */}
        {capturedFaces.length > 0 && (
          <div className="space-y-2">
            <p className="text-sm font-medium">Fotos Capturadas:</p>
            <div className="flex gap-2">
              {Array.from({ length: REQUIRED_PHOTOS }).map((_, index) => (
                <div
                  key={index}
                  className={`w-12 h-12 rounded-full flex items-center justify-center border-2 ${
                    index < capturedFaces.length
                      ? "bg-green-100 border-green-500 dark:bg-green-950"
                      : "bg-muted border-muted-foreground/20"
                  }`}
                >
                  {index < capturedFaces.length ? (
                    <CheckCircle2 className="h-6 w-6 text-green-600 dark:text-green-400" />
                  ) : (
                    <span className="text-sm text-muted-foreground">{index + 1}</span>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Actions */}
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={handleCancel}
            className="flex-1"
          >
            <X className="h-4 w-4 mr-2" />
            Cancelar
          </Button>
          <Button
            onClick={captureFace}
            disabled={isLoading || isCapturing || capturedFaces.length >= REQUIRED_PHOTOS}
            className="flex-1"
          >
            {isCapturing ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Capturando...
              </>
            ) : (
              <>
                <Camera className="h-4 w-4 mr-2" />
                Capturar Foto
              </>
            )}
          </Button>
        </div>

        {/* Warning */}
        <div className="bg-yellow-50 dark:bg-yellow-950 p-3 rounded-lg border border-yellow-200 dark:border-yellow-800">
          <p className="text-xs text-muted-foreground">
            âš ï¸ <strong>Privacidade:</strong> Seus dados faciais sÃ£o criptografados e armazenados com seguranÃ§a. 
            VocÃª pode removÃª-los a qualquer momento nas configuraÃ§Ãµes da conta.
          </p>
        </div>
      </CardContent>
    </Card>
  );
}


========================================
ARQUIVO: ./client/src/components/GoalApprovalSection.tsx
========================================
import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { CheckCircle2, XCircle, Clock, MessageSquare } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { toast } from "sonner";
import { useAuth } from "@/_core/hooks/useAuth";

interface GoalApprovalSectionProps {
  goalId: number;
  currentStatus: string;
  approvalStatus: string;
}

/**
 * Componente de AprovaÃ§Ã£o de Metas
 * 
 * Exibe:
 * - Status atual de aprovaÃ§Ã£o
 * - BotÃµes de Aprovar/Rejeitar (apenas para gestores)
 * - HistÃ³rico de aprovaÃ§Ãµes
 */
export default function GoalApprovalSection({
  goalId,
  currentStatus,
  approvalStatus,
}: GoalApprovalSectionProps) {
  const { user } = useAuth();
  const [comments, setComments] = useState("");
  const [showRejectForm, setShowRejectForm] = useState(false);

  const utils = trpc.useUtils();

  // Queries
  const { data: approvals = [], isLoading } = trpc.goalApprovals.list.useQuery({ goalId });

  // Mutations
  const approveMutation = trpc.goalApprovals.approve.useMutation({
    onSuccess: () => {
      toast.success("Meta aprovada com sucesso!");
      utils.goalApprovals.list.invalidate({ goalId });
      utils.smartGoals.getById.invalidate({ goalId });
      setComments("");
    },
    onError: (error) => {
      toast.error(`Erro ao aprovar meta: ${error.message}`);
    },
  });

  const rejectMutation = trpc.goalApprovals.reject.useMutation({
    onSuccess: () => {
      toast.success("Meta rejeitada");
      utils.goalApprovals.list.invalidate({ goalId });
      utils.smartGoals.getById.invalidate({ goalId });
      setComments("");
      setShowRejectForm(false);
    },
    onError: (error) => {
      toast.error(`Erro ao rejeitar meta: ${error.message}`);
    },
  });

  const handleApprove = () => {
    approveMutation.mutate({ goalId, comments: comments || undefined });
  };

  const handleReject = () => {
    if (comments.length < 10) {
      toast.error("ComentÃ¡rio obrigatÃ³rio ao rejeitar (mÃ­nimo 10 caracteres)");
      return;
    }
    rejectMutation.mutate({ goalId, comments });
  };

  // Verificar se usuÃ¡rio pode aprovar/rejeitar
  const canApprove = user && ["admin", "rh", "gestor"].includes(user.role);
  const isPending = approvalStatus === "pending_manager" || approvalStatus === "pending_hr";
  const isApproved = approvalStatus === "approved";
  const isRejected = approvalStatus === "rejected";

  const getStatusBadge = () => {
    if (isApproved) {
      return (
        <Badge variant="default" className="bg-green-500">
          <CheckCircle2 className="w-4 h-4 mr-1" />
          Aprovada
        </Badge>
      );
    }
    if (isRejected) {
      return (
        <Badge variant="destructive">
          <XCircle className="w-4 h-4 mr-1" />
          Rejeitada
        </Badge>
      );
    }
    if (isPending) {
      return (
        <Badge variant="secondary">
          <Clock className="w-4 h-4 mr-1" />
          Pendente de AprovaÃ§Ã£o
        </Badge>
      );
    }
    return (
      <Badge variant="outline">
        <Clock className="w-4 h-4 mr-1" />
        NÃ£o Submetida
      </Badge>
    );
  };

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle>AprovaÃ§Ã£o da Meta</CardTitle>
            <CardDescription>Status e histÃ³rico de aprovaÃ§Ãµes</CardDescription>
          </div>
          {getStatusBadge()}
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* BotÃµes de AprovaÃ§Ã£o (apenas para gestores) */}
        {canApprove && (isPending || currentStatus === "draft") && !isApproved && !isRejected && (
          <div className="space-y-4 p-4 bg-muted rounded-lg">
            <div className="flex gap-2">
              <Button
                onClick={handleApprove}
                disabled={approveMutation.isPending}
                className="flex-1"
              >
                <CheckCircle2 className="w-4 h-4 mr-2" />
                {approveMutation.isPending ? "Aprovando..." : "Aprovar Meta"}
              </Button>
              <Button
                onClick={() => setShowRejectForm(!showRejectForm)}
                variant="destructive"
                disabled={rejectMutation.isPending}
                className="flex-1"
              >
                <XCircle className="w-4 h-4 mr-2" />
                Rejeitar Meta
              </Button>
            </div>

            {/* FormulÃ¡rio de RejeiÃ§Ã£o */}
            {showRejectForm && (
              <div className="space-y-2">
                <label className="text-sm font-medium">
                  Motivo da RejeiÃ§Ã£o (obrigatÃ³rio)
                </label>
                <Textarea
                  placeholder="Descreva o motivo da rejeiÃ§Ã£o (mÃ­nimo 10 caracteres)..."
                  value={comments}
                  onChange={(e) => setComments(e.target.value)}
                  rows={3}
                />
                <Button
                  onClick={handleReject}
                  variant="destructive"
                  disabled={rejectMutation.isPending || comments.length < 10}
                  className="w-full"
                >
                  {rejectMutation.isPending ? "Rejeitando..." : "Confirmar RejeiÃ§Ã£o"}
                </Button>
              </div>
            )}

            {/* Campo de ComentÃ¡rios para AprovaÃ§Ã£o */}
            {!showRejectForm && (
              <div className="space-y-2">
                <label className="text-sm font-medium">
                  ComentÃ¡rios (opcional)
                </label>
                <Textarea
                  placeholder="Adicione comentÃ¡rios sobre a aprovaÃ§Ã£o..."
                  value={comments}
                  onChange={(e) => setComments(e.target.value)}
                  rows={2}
                />
              </div>
            )}
          </div>
        )}

        {/* HistÃ³rico de AprovaÃ§Ãµes */}
        {approvals.length > 0 && (
          <div className="space-y-3">
            <h4 className="font-medium flex items-center gap-2">
              <MessageSquare className="w-4 h-4" />
              HistÃ³rico de AprovaÃ§Ãµes
            </h4>
            <div className="space-y-2">
              {approvals.map((approval) => (
                <div
                  key={approval.id}
                  className="p-3 border rounded-lg space-y-1"
                >
                  <div className="flex items-center justify-between">
                    <span className="font-medium">{approval.approverName}</span>
                    <Badge
                      variant={
                        approval.status === "approved"
                          ? "default"
                          : approval.status === "rejected"
                          ? "destructive"
                          : "secondary"
                      }
                    >
                      {approval.status === "approved" && "Aprovado"}
                      {approval.status === "rejected" && "Rejeitado"}
                      {approval.status === "pending" && "Pendente"}
                    </Badge>
                  </div>
                  <div className="text-sm text-muted-foreground">
                    {approval.approverRole === "manager" && "Gestor"}
                    {approval.approverRole === "hr" && "RH"}
                    {approval.approverRole === "director" && "Diretor"}
                    {" â€¢ "}
                    {approval.approvedAt
                      ? new Date(approval.approvedAt).toLocaleDateString("pt-BR", {
                          day: "2-digit",
                          month: "2-digit",
                          year: "numeric",
                          hour: "2-digit",
                          minute: "2-digit",
                        })
                      : "Pendente"}
                  </div>
                  {approval.comments && (
                    <p className="text-sm mt-2 p-2 bg-muted rounded">
                      {approval.comments}
                    </p>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Mensagem quando nÃ£o hÃ¡ aprovaÃ§Ãµes */}
        {approvals.length === 0 && !isLoading && (
          <p className="text-sm text-muted-foreground text-center py-4">
            Nenhuma aprovaÃ§Ã£o registrada ainda
          </p>
        )}
      </CardContent>
    </Card>
  );
}


========================================
ARQUIVO: ./client/src/components/ManusDialog.tsx
========================================
import { useEffect, useState } from "react";

import { Button } from "@/components/ui/button";
import { APP_LOGO, APP_TITLE } from "@/const";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogTitle,
} from "@/components/ui/dialog";

interface ManusDialogProps {
  title?: string;
  logo?: string;
  open?: boolean;
  onLogin: () => void;
  onOpenChange?: (open: boolean) => void;
  onClose?: () => void;
}

export function ManusDialog({
  title = APP_TITLE,
  logo = APP_LOGO,
  open = false,
  onLogin,
  onOpenChange,
  onClose,
}: ManusDialogProps) {
  const [internalOpen, setInternalOpen] = useState(open);

  useEffect(() => {
    if (!onOpenChange) {
      setInternalOpen(open);
    }
  }, [open, onOpenChange]);

  const handleOpenChange = (nextOpen: boolean) => {
    if (onOpenChange) {
      onOpenChange(nextOpen);
    } else {
      setInternalOpen(nextOpen);
    }

    if (!nextOpen) {
      onClose?.();
    }
  };

  return (
    <Dialog
      open={onOpenChange ? open : internalOpen}
      onOpenChange={handleOpenChange}
    >
      <DialogContent className="py-5 bg-[#f8f8f7] rounded-[20px] w-[400px] shadow-[0px_4px_11px_0px_rgba(0,0,0,0.08)] border border-[rgba(0,0,0,0.08)] backdrop-blur-2xl p-0 gap-0 text-center">
        <div className="flex flex-col items-center gap-2 p-5 pt-12">
          <div className="w-16 h-16 bg-white rounded-xl border border-[rgba(0,0,0,0.08)] flex items-center justify-center">
            <img src={logo} alt="App icon" className="w-10 h-10 rounded-md" />
          </div>

          {/* Title and subtitle */}
          <DialogTitle className="text-xl font-semibold text-[#34322d] leading-[26px] tracking-[-0.44px]">
            {title}
          </DialogTitle>
          <DialogDescription className="text-sm text-[#858481] leading-5 tracking-[-0.154px]">
            Please login with Manus to continue
          </DialogDescription>
        </div>

        <DialogFooter className="px-5 py-5">
          {/* Login button */}
          <Button
            onClick={onLogin}
            className="w-full h-10 bg-[#1a1a19] hover:bg-[#1a1a19]/90 text-white rounded-[10px] text-sm font-medium leading-5 tracking-[-0.154px]"
          >
            Login with Manus
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}


========================================
ARQUIVO: ./client/src/components/Map.tsx
========================================
/**
 * GOOGLE MAPS FRONTEND INTEGRATION - ESSENTIAL GUIDE
 *
 * USAGE FROM PARENT COMPONENT:
 * ======
 *
 * const mapRef = useRef<google.maps.Map | null>(null);
 *
 * <MapView
 *   initialCenter={{ lat: 40.7128, lng: -74.0060 }}
 *   initialZoom={15}
 *   onMapReady={(map) => {
 *     mapRef.current = map; // Store to control map from parent anytime, google map itself is in charge of the re-rendering, not react state.
 * </MapView>
 *
 * ======
 * Available Libraries and Core Features:
 * -------------------------------
 * ðŸ“ MARKER (from `marker` library)
 * - Attaches to map using { map, position }
 * new google.maps.marker.AdvancedMarkerElement({
 *   map,
 *   position: { lat: 37.7749, lng: -122.4194 },
 *   title: "San Francisco",
 * });
 *
 * -------------------------------
 * ðŸ¢ PLACES (from `places` library)
 * - Does not attach directly to map; use data with your map manually.
 * const place = new google.maps.places.Place({ id: PLACE_ID });
 * await place.fetchFields({ fields: ["displayName", "location"] });
 * map.setCenter(place.location);
 * new google.maps.marker.AdvancedMarkerElement({ map, position: place.location });
 *
 * -------------------------------
 * ðŸ§­ GEOCODER (from `geocoding` library)
 * - Standalone service; manually apply results to map.
 * const geocoder = new google.maps.Geocoder();
 * geocoder.geocode({ address: "New York" }, (results, status) => {
 *   if (status === "OK" && results[0]) {
 *     map.setCenter(results[0].geometry.location);
 *     new google.maps.marker.AdvancedMarkerElement({
 *       map,
 *       position: results[0].geometry.location,
 *     });
 *   }
 * });
 *
 * -------------------------------
 * ðŸ“ GEOMETRY (from `geometry` library)
 * - Pure utility functions; not attached to map.
 * const dist = google.maps.geometry.spherical.computeDistanceBetween(p1, p2);
 *
 * -------------------------------
 * ðŸ›£ï¸ ROUTES (from `routes` library)
 * - Combines DirectionsService (standalone) + DirectionsRenderer (map-attached)
 * const directionsService = new google.maps.DirectionsService();
 * const directionsRenderer = new google.maps.DirectionsRenderer({ map });
 * directionsService.route(
 *   { origin, destination, travelMode: "DRIVING" },
 *   (res, status) => status === "OK" && directionsRenderer.setDirections(res)
 * );
 *
 * -------------------------------
 * ðŸŒ¦ï¸ MAP LAYERS (attach directly to map)
 * - new google.maps.TrafficLayer().setMap(map);
 * - new google.maps.TransitLayer().setMap(map);
 * - new google.maps.BicyclingLayer().setMap(map);
 *
 * -------------------------------
 * âœ… SUMMARY
 * - â€œmap-attachedâ€ â†’ AdvancedMarkerElement, DirectionsRenderer, Layers.
 * - â€œstandaloneâ€ â†’ Geocoder, DirectionsService, DistanceMatrixService, ElevationService.
 * - â€œdata-onlyâ€ â†’ Place, Geometry utilities.
 */

/// <reference types="@types/google.maps" />

import { useEffect, useRef } from "react";
import { usePersistFn } from "@/hooks/usePersistFn";
import { cn } from "@/lib/utils";

declare global {
  interface Window {
    google?: typeof google;
  }
}

const API_KEY = import.meta.env.VITE_FRONTEND_FORGE_API_KEY;
const FORGE_BASE_URL =
  import.meta.env.VITE_FRONTEND_FORGE_API_URL ||
  "https://forge.butterfly-effect.dev";
const MAPS_PROXY_URL = `${FORGE_BASE_URL}/v1/maps/proxy`;

function loadMapScript() {
  return new Promise(resolve => {
    const script = document.createElement("script");
    script.src = `${MAPS_PROXY_URL}/maps/api/js?key=${API_KEY}&v=weekly&libraries=marker,places,geocoding,geometry`;
    script.async = true;
    script.crossOrigin = "anonymous";
    script.onload = () => {
      resolve(null);
      script.remove(); // Clean up immediately
    };
    script.onerror = () => {
      console.error("Failed to load Google Maps script");
    };
    document.head.appendChild(script);
  });
}

interface MapViewProps {
  className?: string;
  initialCenter?: google.maps.LatLngLiteral;
  initialZoom?: number;
  onMapReady?: (map: google.maps.Map) => void;
}

export function MapView({
  className,
  initialCenter = { lat: 37.7749, lng: -122.4194 },
  initialZoom = 12,
  onMapReady,
}: MapViewProps) {
  const mapContainer = useRef<HTMLDivElement>(null);
  const map = useRef<google.maps.Map | null>(null);

  const init = usePersistFn(async () => {
    await loadMapScript();
    if (!mapContainer.current) {
      console.error("Map container not found");
      return;
    }
    map.current = new window.google.maps.Map(mapContainer.current, {
      zoom: initialZoom,
      center: initialCenter,
      mapTypeControl: true,
      fullscreenControl: true,
      zoomControl: true,
      streetViewControl: true,
      mapId: "DEMO_MAP_ID",
    });
    if (onMapReady) {
      onMapReady(map.current);
    }
  });

  useEffect(() => {
    init();
  }, [init]);

  return (
    <div ref={mapContainer} className={cn("w-full h-[500px]", className)} />
  );
}


========================================
ARQUIVO: ./client/src/components/NineBoxChart.tsx
========================================
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";

interface Employee {
  id: number;
  name: string;
  performance: number;
  potential: number;
  position?: string;
  department?: string;
}

interface NineBoxChartProps {
  employees: Employee[];
  onEmployeeClick?: (employee: Employee) => void;
}

export default function NineBoxChart({ employees, onEmployeeClick }: NineBoxChartProps) {
  const getBoxEmployees = (perfMin: number, perfMax: number, potMin: number, potMax: number) => {
    return employees.filter(
      (emp) =>
        emp.performance >= perfMin &&
        emp.performance < perfMax &&
        emp.potential >= potMin &&
        emp.potential < potMax
    );
  };

  const getBoxColor = (perfLevel: number, potLevel: number) => {
    // perfLevel e potLevel: 0 (baixo), 1 (mÃ©dio), 2 (alto)
    if (perfLevel === 2 && potLevel === 2) return "bg-green-50 border-green-500 dark:bg-green-950";
    if (perfLevel === 2 && potLevel === 1) return "bg-blue-50 border-blue-500 dark:bg-blue-950";
    if (perfLevel === 2 && potLevel === 0) return "bg-yellow-50 border-yellow-500 dark:bg-yellow-950";
    if (perfLevel === 1 && potLevel === 2) return "bg-purple-50 border-purple-500 dark:bg-purple-950";
    if (perfLevel === 1 && potLevel === 1) return "bg-gray-50 border-gray-400 dark:bg-gray-900";
    if (perfLevel === 1 && potLevel === 0) return "bg-orange-50 border-orange-500 dark:bg-orange-950";
    if (perfLevel === 0 && potLevel === 2) return "bg-indigo-50 border-indigo-500 dark:bg-indigo-950";
    if (perfLevel === 0 && potLevel === 1) return "bg-red-50 border-red-400 dark:bg-red-950";
    return "bg-red-100 border-red-600 dark:bg-red-900";
  };

  const getBoxLabel = (perfLevel: number, potLevel: number) => {
    const labels = [
      ["Risco", "Inconsistente", "Eficaz"],
      ["Profissional SÃ³lido", "Talento Emergente", "Alto Desempenho"],
      ["Talento Chave", "Alto Potencial", "Estrela"],
    ];
    return labels[potLevel][perfLevel];
  };

  const getInitials = (name: string) => {
    return name
      .split(" ")
      .map((n) => n[0])
      .join("")
      .toUpperCase()
      .slice(0, 2);
  };

  return (
    <div className="space-y-4">
      {/* Eixos */}
      <div className="flex items-center justify-between mb-2">
        <div className="text-sm font-semibold text-muted-foreground">
          â† Baixo Desempenho | Alto Desempenho â†’
        </div>
      </div>

      <div className="relative">
        {/* Label do eixo Y */}
        <div className="absolute -left-20 top-1/2 -translate-y-1/2 -rotate-90 text-sm font-semibold text-muted-foreground whitespace-nowrap">
          â† Baixo Potencial | Alto Potencial â†’
        </div>

        {/* Grid 3x3 */}
        <div className="grid grid-cols-3 gap-3 ml-8">
          {[2, 1, 0].map((potLevel) =>
            [0, 1, 2].map((perfLevel) => {
              const boxEmployees = getBoxEmployees(
                perfLevel * 3.33,
                (perfLevel + 1) * 3.33,
                potLevel * 3.33,
                (potLevel + 1) * 3.33
              );

              return (
                <Card
                  key={`${potLevel}-${perfLevel}`}
                  className={`min-h-[200px] border-2 transition-all hover:shadow-lg ${getBoxColor(
                    perfLevel,
                    potLevel
                  )}`}
                >
                  <CardHeader className="pb-3">
                    <div className="flex items-center justify-between">
                      <CardTitle className="text-sm font-bold">
                        {getBoxLabel(perfLevel, potLevel)}
                      </CardTitle>
                      <Badge variant="secondary" className="text-xs">
                        {boxEmployees.length}
                      </Badge>
                    </div>
                    <CardDescription className="text-xs">
                      Desempenho: {perfLevel === 0 ? "Baixo" : perfLevel === 1 ? "MÃ©dio" : "Alto"} |
                      Potencial: {potLevel === 0 ? "Baixo" : potLevel === 1 ? "MÃ©dio" : "Alto"}
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-2">
                      {boxEmployees.slice(0, 4).map((emp) => (
                        <Tooltip key={emp.id}>
                          <TooltipTrigger asChild>
                            <div
                              className="flex items-center gap-2 p-2 rounded-md bg-background/60 hover:bg-background cursor-pointer transition-colors"
                              onClick={() => onEmployeeClick?.(emp)}
                            >
                              <Avatar className="h-6 w-6">
                                <AvatarFallback className="text-xs">
                                  {getInitials(emp.name)}
                                </AvatarFallback>
                              </Avatar>
                              <div className="flex-1 min-w-0">
                                <p className="text-xs font-medium truncate">{emp.name}</p>
                                {emp.position && (
                                  <p className="text-[10px] text-muted-foreground truncate">
                                    {emp.position}
                                  </p>
                                )}
                              </div>
                              <div className="text-right">
                                <p className="text-[10px] text-muted-foreground">
                                  D:{emp.performance.toFixed(1)}
                                </p>
                                <p className="text-[10px] text-muted-foreground">
                                  P:{emp.potential.toFixed(1)}
                                </p>
                              </div>
                            </div>
                          </TooltipTrigger>
                          <TooltipContent>
                            <div className="space-y-1">
                              <p className="font-semibold">{emp.name}</p>
                              {emp.position && <p className="text-xs">{emp.position}</p>}
                              {emp.department && <p className="text-xs">{emp.department}</p>}
                              <div className="text-xs pt-1 border-t">
                                <p>Desempenho: {emp.performance.toFixed(1)}/10</p>
                                <p>Potencial: {emp.potential.toFixed(1)}/10</p>
                              </div>
                            </div>
                          </TooltipContent>
                        </Tooltip>
                      ))}
                      {boxEmployees.length > 4 && (
                        <div className="text-center text-xs text-muted-foreground py-1">
                          +{boxEmployees.length - 4} colaborador(es)
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              );
            })
          )}
        </div>
      </div>

      {/* Legenda */}
      <div className="flex items-center justify-center gap-6 pt-4 border-t text-xs">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded border-2 border-green-500 bg-green-50 dark:bg-green-950" />
          <span>Estrelas</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded border-2 border-blue-500 bg-blue-50 dark:bg-blue-950" />
          <span>Alto Desempenho</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded border-2 border-purple-500 bg-purple-50 dark:bg-purple-950" />
          <span>Alto Potencial</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded border-2 border-red-600 bg-red-100 dark:bg-red-900" />
          <span>AtenÃ§Ã£o NecessÃ¡ria</span>
        </div>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/components/NotificationCenter.tsx
========================================
import { useState } from "react";
import { Bell, Check, X, AlertCircle, CheckCircle, Info, TrendingUp, Brain, Target, Trophy } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";
import { Badge } from "@/components/ui/badge";
import { ScrollArea } from "@/components/ui/scroll-area";
import { cn } from "@/lib/utils";
import { trpc } from "@/lib/trpc";
import { toast } from "sonner";
import { useLocation } from "wouter";

/**
 * NotificationCenter - Centro de NotificaÃ§Ãµes em Tempo Real
 * 
 * Features:
 * - Badge de contagem de notificaÃ§Ãµes nÃ£o lidas
 * - Dropdown com lista de notificaÃ§Ãµes
 * - IntegraÃ§Ã£o com backend real via tRPC
 * - Tipos de notificaÃ§Ãµes:
 *   - Testes psicomÃ©tricos concluÃ­dos
 *   - Marcos de PDI atingidos
 *   - Insights crÃ­ticos identificados
 *   - AvaliaÃ§Ãµes 360Â° concluÃ­das
 *   - Metas atingidas
 * - MarcaÃ§Ã£o de lida/nÃ£o lida
 * - NavegaÃ§Ã£o para links relacionados
 */

export default function NotificationCenter() {
  const [open, setOpen] = useState(false);
  const [, setLocation] = useLocation();

  // Buscar notificaÃ§Ãµes do backend
  const { data: notifications, refetch } = trpc.notifications.list.useQuery({
    limit: 20,
  });

  // Contar nÃ£o lidas
  const { data: unreadCount } = trpc.notifications.countUnread.useQuery();

  // Mutation para marcar como lida
  const markAsReadMutation = trpc.notifications.markAsRead.useMutation({
    onSuccess: () => {
      refetch();
    },
  });

  // Mutation para marcar todas como lidas
  const markAllAsReadMutation = trpc.notifications.markAllAsRead.useMutation({
    onSuccess: () => {
      refetch();
      toast.success("Todas as notificaÃ§Ãµes marcadas como lidas");
    },
  });

  const handleNotificationClick = (notification: any) => {
    // Marcar como lida
    if (!notification.read) {
      markAsReadMutation.mutate({ id: notification.id });
    }

    // Navegar para o link se existir
    if (notification.link) {
      setLocation(notification.link);
      setOpen(false);
    }
  };

  const handleMarkAllAsRead = () => {
    if (((unreadCount?.count ?? 0)) > 0) {
      markAllAsReadMutation.mutate();
    }
  };

  const getIcon = (type: string) => {
    switch (type) {
      case "test_completed":
        return <Brain className="h-5 w-5 text-blue-500" />;
      case "pdi_milestone":
        return <Target className="h-5 w-5 text-green-500" />;
      case "insight_critical":
        return <AlertCircle className="h-5 w-5 text-orange-500" />;
      case "evaluation_completed":
        return <CheckCircle className="h-5 w-5 text-purple-500" />;
      case "goal_achieved":
        return <Trophy className="h-5 w-5 text-yellow-500" />;
      case "approval":
        return <CheckCircle className="h-5 w-5 text-blue-500" />;
      case "pdi":
        return <TrendingUp className="h-5 w-5 text-green-500" />;
      case "succession":
        return <AlertCircle className="h-5 w-5 text-orange-500" />;
      default:
        return <Info className="h-5 w-5 text-gray-500" />;
    }
  };

  const formatTimeAgo = (date: Date | string) => {
    const now = new Date();
    const notifDate = new Date(date);
    const diffMs = now.getTime() - notifDate.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return "agora";
    if (diffMins < 60) return `${diffMins}m atrÃ¡s`;
    if (diffHours < 24) return `${diffHours}h atrÃ¡s`;
    return `${diffDays}d atrÃ¡s`;
  };

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button variant="ghost" size="icon" className="relative">
          <Bell className="h-5 w-5" />
          {((unreadCount?.count ?? 0)) > 0 && (
            <Badge
              variant="destructive"
              className="absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center p-0 text-xs"
            >
              {((unreadCount?.count ?? 0)) > 9 ? "9+" : (unreadCount?.count ?? 0)}
            </Badge>
          )}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-96 p-0" align="end">
        <div className="flex items-center justify-between border-b px-4 py-3">
          <div>
            <h3 className="font-semibold">NotificaÃ§Ãµes</h3>
            <p className="text-xs text-muted-foreground">
              {(unreadCount?.count ?? 0)} nÃ£o {((unreadCount?.count ?? 0)) === 1 ? "lida" : "lidas"}
            </p>
          </div>
          <div className="flex items-center gap-2">
            {((unreadCount?.count ?? 0)) > 0 && (
              <Button
                variant="ghost"
                size="sm"
                onClick={handleMarkAllAsRead}
                className="text-xs"
                disabled={markAllAsReadMutation.isPending}
              >
                Marcar todas como lidas
              </Button>
            )}
          </div>
        </div>

        <ScrollArea className="h-[400px]">
          {!notifications || notifications.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-12 text-center">
              <Bell className="h-12 w-12 text-muted-foreground/50 mb-3" />
              <p className="text-sm text-muted-foreground">
                Nenhuma notificaÃ§Ã£o
              </p>
            </div>
          ) : (
            <div className="divide-y">
              {notifications.map((notification) => (
                <div
                  key={notification.id}
                  className={cn(
                    "px-4 py-3 hover:bg-accent transition-colors cursor-pointer",
                    !notification.read && "bg-blue-50/50 dark:bg-blue-950/20"
                  )}
                  onClick={() => handleNotificationClick(notification)}
                >
                  <div className="flex gap-3">
                    <div className="flex-shrink-0 mt-0.5">
                      {getIcon(notification.type)}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-start justify-between gap-2">
                        <p className="font-medium text-sm">
                          {notification.title}
                        </p>
                        {!notification.read && (
                          <div className="h-2 w-2 rounded-full bg-blue-500 flex-shrink-0 mt-1" />
                        )}
                      </div>
                      <p className="text-xs text-muted-foreground mt-1 line-clamp-2">
                        {notification.message}
                      </p>
                      <p className="text-xs text-muted-foreground mt-2">
                        {formatTimeAgo(notification.createdAt)}
                      </p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </ScrollArea>

        {notifications && notifications.length > 0 && (
          <div className="border-t px-4 py-2">
            <Button
              variant="ghost"
              size="sm"
              className="w-full text-xs"
              onClick={() => {
                setLocation("/notificacoes");
                setOpen(false);
              }}
            >
              Ver todas as notificaÃ§Ãµes
            </Button>
          </div>
        )}
      </PopoverContent>
    </Popover>
  );
}


========================================
ARQUIVO: ./client/src/components/PDIWizard.tsx
========================================
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Progress } from "@/components/ui/progress";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { trpc } from "@/lib/trpc";
import { ArrowLeft, ArrowRight, CheckCircle2, Lightbulb, Loader2, Sparkles, Target } from "lucide-react";
import { useState } from "react";
import { toast } from "sonner";

interface PDIWizardProps {
  onComplete?: () => void;
  onCancel?: () => void;
}

export default function PDIWizard({ onComplete, onCancel }: PDIWizardProps) {
  const [currentStep, setCurrentStep] = useState(1);
  const [targetPositionId, setTargetPositionId] = useState<string>("");
  const [competencyGaps, setCompetencyGaps] = useState<any[]>([]);
  const [aiRecommendations, setAiRecommendations] = useState<string>("");
  const [selectedActions, setSelectedActions] = useState<any[]>([]);
  const [isGenerating, setIsGenerating] = useState(false);

  // Extract positions from employees data
  const { data: employeesData } = trpc.employees.list.useQuery();
  const positions = employeesData?.reduce((acc: any[], emp) => {
    if (emp.position && !acc.find(p => p.id === emp.position!.id)) {
      acc.push(emp.position);
    }
    return acc;
  }, []) || [];
  const { data: employee } = trpc.employees.getCurrent.useQuery();

  const totalSteps = 6;
  const progressPercentage = (currentStep / totalSteps) * 100;

  // Mock competency gaps (in production, this would come from API)
  const mockCompetencyGaps = [
    { id: 1, name: "LideranÃ§a", current: 6, required: 9, gap: 3 },
    { id: 2, name: "GestÃ£o de Projetos", current: 5, required: 8, gap: 3 },
    { id: 3, name: "ComunicaÃ§Ã£o EstratÃ©gica", current: 7, required: 9, gap: 2 },
    { id: 4, name: "VisÃ£o de NegÃ³cio", current: 6, required: 9, gap: 3 },
    { id: 5, name: "GestÃ£o de Pessoas", current: 5, required: 8, gap: 3 },
  ];

  // Mock AI recommendations
  const mockAIRecommendations = `
Com base na anÃ¡lise de suas competÃªncias atuais e nas exigÃªncias do cargo de Gerente de Projetos, identifiquei as seguintes oportunidades de desenvolvimento:

**Prioridades CrÃ­ticas:**
1. **LideranÃ§a** (Gap: 3 pontos) - Fundamental para o cargo-alvo
2. **GestÃ£o de Projetos** (Gap: 3 pontos) - CompetÃªncia core da posiÃ§Ã£o
3. **GestÃ£o de Pessoas** (Gap: 3 pontos) - Essencial para liderar equipes

**RecomendaÃ§Ãµes Personalizadas:**

**70% - ExperiÃªncia PrÃ¡tica:**
- Liderar projeto de reestruturaÃ§Ã£o do departamento (6 meses)
- Assumir mentoria de 2-3 analistas jÃºnior
- Participar do comitÃª de planejamento estratÃ©gico

**20% - Aprendizado Social:**
- Mentoria com Gerente SÃªnior de Projetos
- Job rotation com Ã¡rea de Planejamento (2 semanas)
- ParticipaÃ§Ã£o em grupo de estudos de lideranÃ§a

**10% - EducaÃ§Ã£o Formal:**
- Curso: "GestÃ£o AvanÃ§ada de Projetos" (40h)
- CertificaÃ§Ã£o PMP ou equivalente
- Workshop de LideranÃ§a Situacional

**Cronograma Sugerido:** 12 meses
**Investimento Estimado:** R$ 8.500
**Probabilidade de Sucesso:** 85% (baseado em histÃ³rico similar)
  `.trim();

  const handleAnalyzeGaps = () => {
    setIsGenerating(true);
    // Simulate API call
    setTimeout(() => {
      setCompetencyGaps(mockCompetencyGaps);
      setIsGenerating(false);
      setCurrentStep(3);
    }, 2000);
  };

  const handleGenerateRecommendations = () => {
    setIsGenerating(true);
    // Simulate AI generation
    setTimeout(() => {
      setAiRecommendations(mockAIRecommendations);
      setIsGenerating(false);
      setCurrentStep(5);
    }, 3000);
  };

  const handleSubmit = () => {
    toast.success("PDI criado com sucesso!");
    onComplete?.();
  };

  const renderStep = () => {
    switch (currentStep) {
      case 1:
        return (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Target className="h-5 w-5" />
                Selecione seu Cargo-Alvo
              </CardTitle>
              <CardDescription>
                Escolha a posiÃ§Ã£o que vocÃª deseja alcanÃ§ar em sua carreira
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="position">Cargo-Alvo</Label>
                <Select value={targetPositionId} onValueChange={setTargetPositionId}>
                  <SelectTrigger id="position">
                    <SelectValue placeholder="Selecione um cargo" />
                  </SelectTrigger>
                  <SelectContent>
                    {positions?.map((pos: any) => (
                      <SelectItem key={pos.id} value={pos.id.toString()}>
                        {pos.title}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="bg-muted p-4 rounded-lg space-y-2">
                <p className="text-sm font-medium">ðŸ’¡ Dica</p>
                <p className="text-sm text-muted-foreground">
                  Escolha um cargo que represente o prÃ³ximo passo natural em sua carreira, 
                  considerando suas aspiraÃ§Ãµes e o plano de sucessÃ£o da empresa.
                </p>
              </div>

              <div className="flex justify-end gap-2">
                <Button variant="outline" onClick={onCancel}>
                  Cancelar
                </Button>
                <Button 
                  onClick={() => setCurrentStep(2)} 
                  disabled={!targetPositionId}
                >
                  PrÃ³ximo
                  <ArrowRight className="h-4 w-4 ml-2" />
                </Button>
              </div>
            </CardContent>
          </Card>
        );

      case 2:
        return (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Sparkles className="h-5 w-5" />
                AnÃ¡lise de CompetÃªncias
              </CardTitle>
              <CardDescription>
                Vamos analisar as competÃªncias necessÃ¡rias para o cargo-alvo
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-950 dark:to-pink-950 p-6 rounded-lg border">
                <div className="flex items-start gap-4">
                  <div className="p-3 bg-white dark:bg-gray-800 rounded-full">
                    <Sparkles className="h-6 w-6 text-purple-600" />
                  </div>
                  <div className="flex-1">
                    <h3 className="font-semibold mb-2">AnÃ¡lise Inteligente com IA</h3>
                    <p className="text-sm text-muted-foreground mb-4">
                      Nossa IA vai comparar suas competÃªncias atuais (baseadas em avaliaÃ§Ãµes 360Â°) 
                      com as competÃªncias necessÃ¡rias para o cargo-alvo e identificar os gaps de desenvolvimento.
                    </p>
                    <Button 
                      onClick={handleAnalyzeGaps}
                      disabled={isGenerating}
                      className="w-full sm:w-auto"
                    >
                      {isGenerating ? (
                        <>
                          <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                          Analisando...
                        </>
                      ) : (
                        <>
                          <Sparkles className="h-4 w-4 mr-2" />
                          Iniciar AnÃ¡lise
                        </>
                      )}
                    </Button>
                  </div>
                </div>
              </div>

              <div className="flex justify-between">
                <Button variant="outline" onClick={() => setCurrentStep(1)}>
                  <ArrowLeft className="h-4 w-4 mr-2" />
                  Voltar
                </Button>
              </div>
            </CardContent>
          </Card>
        );

      case 3:
        return (
          <Card>
            <CardHeader>
              <CardTitle>Gaps de CompetÃªncias Identificados</CardTitle>
              <CardDescription>
                Visualize as competÃªncias que precisam ser desenvolvidas
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Spider Chart Placeholder */}
              <div className="bg-muted p-8 rounded-lg flex items-center justify-center">
                <div className="text-center space-y-2">
                  <div className="text-4xl">ðŸ“Š</div>
                  <p className="text-sm text-muted-foreground">
                    GrÃ¡fico Spider de CompetÃªncias
                  </p>
                  <p className="text-xs text-muted-foreground">
                    (ImplementaÃ§Ã£o com biblioteca de charts)
                  </p>
                </div>
              </div>

              {/* Competency Gaps List */}
              <div className="space-y-3">
                {competencyGaps.map((comp) => (
                  <div key={comp.id} className="space-y-2">
                    <div className="flex items-center justify-between text-sm">
                      <span className="font-medium">{comp.name}</span>
                      <span className="text-muted-foreground">
                        Atual: {comp.current}/10 â†’ Meta: {comp.required}/10 (Gap: {comp.gap})
                      </span>
                    </div>
                    <div className="relative h-2 bg-muted rounded-full overflow-hidden">
                      <div
                        className="absolute h-full bg-blue-200 dark:bg-blue-900"
                        style={{ width: `${(comp.current / 10) * 100}%` }}
                      />
                      <div
                        className="absolute h-full bg-blue-600"
                        style={{ width: `${(comp.required / 10) * 100}%`, opacity: 0.3 }}
                      />
                    </div>
                  </div>
                ))}
              </div>

              <div className="flex justify-between">
                <Button variant="outline" onClick={() => setCurrentStep(2)}>
                  <ArrowLeft className="h-4 w-4 mr-2" />
                  Voltar
                </Button>
                <Button onClick={() => setCurrentStep(4)}>
                  PrÃ³ximo
                  <ArrowRight className="h-4 w-4 ml-2" />
                </Button>
              </div>
            </CardContent>
          </Card>
        );

      case 4:
        return (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Lightbulb className="h-5 w-5" />
                RecomendaÃ§Ãµes Personalizadas
              </CardTitle>
              <CardDescription>
                A IA vai gerar recomendaÃ§Ãµes de aÃ§Ãµes de desenvolvimento
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-950 dark:to-cyan-950 p-6 rounded-lg border">
                <div className="flex items-start gap-4">
                  <div className="p-3 bg-white dark:bg-gray-800 rounded-full">
                    <Lightbulb className="h-6 w-6 text-blue-600" />
                  </div>
                  <div className="flex-1">
                    <h3 className="font-semibold mb-2">RecomendaÃ§Ãµes com IA Gemini</h3>
                    <p className="text-sm text-muted-foreground mb-4">
                      Com base nos gaps identificados, nossa IA vai sugerir aÃ§Ãµes de desenvolvimento 
                      seguindo o modelo 70-20-10 (70% prÃ¡tica, 20% mentoria, 10% cursos).
                    </p>
                    <Button 
                      onClick={handleGenerateRecommendations}
                      disabled={isGenerating}
                      className="w-full sm:w-auto"
                    >
                      {isGenerating ? (
                        <>
                          <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                          Gerando recomendaÃ§Ãµes...
                        </>
                      ) : (
                        <>
                          <Sparkles className="h-4 w-4 mr-2" />
                          Gerar RecomendaÃ§Ãµes
                        </>
                      )}
                    </Button>
                  </div>
                </div>
              </div>

              <div className="flex justify-between">
                <Button variant="outline" onClick={() => setCurrentStep(3)}>
                  <ArrowLeft className="h-4 w-4 mr-2" />
                  Voltar
                </Button>
              </div>
            </CardContent>
          </Card>
        );

      case 5:
        return (
          <Card>
            <CardHeader>
              <CardTitle>Plano de Desenvolvimento Sugerido</CardTitle>
              <CardDescription>
                Revise as recomendaÃ§Ãµes geradas pela IA
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="bg-muted p-4 rounded-lg">
                <pre className="whitespace-pre-wrap text-sm font-mono">
                  {aiRecommendations}
                </pre>
              </div>

              <div className="bg-blue-50 dark:bg-blue-950 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
                <p className="text-sm font-medium mb-2">âœ¨ PrÃ³ximo Passo</p>
                <p className="text-sm text-muted-foreground">
                  VocÃª pode personalizar estas recomendaÃ§Ãµes na prÃ³xima etapa, adicionando ou removendo aÃ§Ãµes conforme necessÃ¡rio.
                </p>
              </div>

              <div className="flex justify-between">
                <Button variant="outline" onClick={() => setCurrentStep(4)}>
                  <ArrowLeft className="h-4 w-4 mr-2" />
                  Voltar
                </Button>
                <Button onClick={() => setCurrentStep(6)}>
                  PrÃ³ximo
                  <ArrowRight className="h-4 w-4 ml-2" />
                </Button>
              </div>
            </CardContent>
          </Card>
        );

      case 6:
        return (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <CheckCircle2 className="h-5 w-5" />
                RevisÃ£o e SubmissÃ£o
              </CardTitle>
              <CardDescription>
                Revise seu PDI antes de enviar para aprovaÃ§Ã£o
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-3">
                <div className="p-4 bg-muted rounded-lg">
                  <p className="text-sm font-medium">Cargo-Alvo</p>
                  <p className="text-sm text-muted-foreground">
                    {positions?.find((p: any) => p.id === Number(targetPositionId))?.title}
                  </p>
                </div>

                <div className="p-4 bg-muted rounded-lg">
                  <p className="text-sm font-medium mb-2">CompetÃªncias a Desenvolver</p>
                  <div className="space-y-1">
                    {competencyGaps.slice(0, 3).map((comp) => (
                      <p key={comp.id} className="text-sm text-muted-foreground">
                        â€¢ {comp.name} (Gap: {comp.gap} pontos)
                      </p>
                    ))}
                  </div>
                </div>

                <div className="p-4 bg-muted rounded-lg">
                  <p className="text-sm font-medium">DuraÃ§Ã£o Estimada</p>
                  <p className="text-sm text-muted-foreground">12 meses</p>
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="notes">ObservaÃ§Ãµes Adicionais (Opcional)</Label>
                <Textarea
                  id="notes"
                  placeholder="Adicione quaisquer observaÃ§Ãµes ou ajustes que gostaria de fazer..."
                  rows={3}
                />
              </div>

              <div className="bg-yellow-50 dark:bg-yellow-950 p-4 rounded-lg border border-yellow-200 dark:border-yellow-800">
                <p className="text-sm font-medium mb-1">âš ï¸ AtenÃ§Ã£o</p>
                <p className="text-sm text-muted-foreground">
                  ApÃ³s a submissÃ£o, seu PDI serÃ¡ enviado para aprovaÃ§Ã£o do seu gestor. 
                  VocÃª poderÃ¡ fazer ajustes apÃ³s o feedback.
                </p>
              </div>

              <div className="flex justify-between">
                <Button variant="outline" onClick={() => setCurrentStep(5)}>
                  <ArrowLeft className="h-4 w-4 mr-2" />
                  Voltar
                </Button>
                <Button onClick={handleSubmit}>
                  <CheckCircle2 className="h-4 w-4 mr-2" />
                  Enviar para AprovaÃ§Ã£o
                </Button>
              </div>
            </CardContent>
          </Card>
        );

      default:
        return null;
    }
  };

  return (
    <div className="space-y-6">
      {/* Progress Header */}
      <Card>
        <CardContent className="pt-6">
          <div className="space-y-2">
            <div className="flex items-center justify-between text-sm">
              <span className="font-medium">Passo {currentStep} de {totalSteps}</span>
              <span className="text-muted-foreground">{Math.round(progressPercentage)}% completo</span>
            </div>
            <Progress value={progressPercentage} className="h-2" />
          </div>
        </CardContent>
      </Card>

      {/* Step Content */}
      {renderStep()}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/components/RecommendationsSection.tsx
========================================
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Loader2, Lightbulb, BookOpen, Target, TrendingUp } from "lucide-react";
import { Alert, AlertDescription } from "@/components/ui/alert";

interface RecommendationsSectionProps {
  employeeId: number;
}

export default function RecommendationsSection({ employeeId }: RecommendationsSectionProps) {
  const { data: recommendations, isLoading } = trpc.psychometric.getPDIRecommendations.useQuery({
    employeeId,
  });

  if (isLoading) {
    return (
      <Card className="border-blue-200 bg-gradient-to-r from-blue-50 to-cyan-50">
        <CardContent className="py-8 flex items-center justify-center">
          <Loader2 className="w-6 h-6 animate-spin text-blue-600" />
        </CardContent>
      </Card>
    );
  }

  if (!recommendations || recommendations.length === 0) {
    return (
      <Alert className="border-yellow-200 bg-yellow-50">
        <Lightbulb className="h-4 w-4 text-yellow-600" />
        <AlertDescription className="text-yellow-800">
          Este colaborador ainda nÃ£o realizou testes psicomÃ©tricos. Envie convites de testes para gerar recomendaÃ§Ãµes inteligentes de desenvolvimento.
        </AlertDescription>
      </Alert>
    );
  }

  return (
    <Card className="border-blue-200 bg-gradient-to-r from-blue-50 to-cyan-50">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Lightbulb className="h-5 w-5 text-blue-600" />
          RecomendaÃ§Ãµes Inteligentes de Desenvolvimento
        </CardTitle>
        <CardDescription>
          Baseadas nos testes psicomÃ©tricos realizados pelo colaborador
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {recommendations.slice(0, 3).map((rec: any, index: number) => (
          <div key={index} className="bg-white p-4 rounded-lg border border-blue-100 space-y-3">
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="flex items-center gap-2 mb-1">
                  <h4 className="font-semibold text-gray-900">{rec.competency}</h4>
                  <Badge 
                    variant={rec.priority === "high" ? "default" : "secondary"}
                    className={rec.priority === "high" ? "bg-orange-500" : ""}
                  >
                    {rec.priority === "high" ? "Alta" : rec.priority === "medium" ? "MÃ©dia" : "Baixa"} Prioridade
                  </Badge>
                </div>
                <p className="text-sm text-gray-600 mb-2">{rec.description}</p>
                <p className="text-xs text-gray-500 italic">{rec.reasoning}</p>
              </div>
            </div>

            {/* AÃ§Ãµes Sugeridas */}
            {rec.actions && rec.actions.length > 0 && (
              <div>
                <div className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-2">
                  <Target className="h-4 w-4" />
                  AÃ§Ãµes Sugeridas:
                </div>
                <ul className="space-y-1">
                  {rec.actions.slice(0, 2).map((action: string, i: number) => (
                    <li key={i} className="text-sm text-gray-600 flex items-start gap-2">
                      <span className="text-blue-500 mt-1">â€¢</span>
                      <span>{action}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {/* Cursos Recomendados */}
            {rec.courses && rec.courses.length > 0 && (
              <div>
                <div className="flex items-center gap-1 text-sm font-medium text-gray-700 mb-2">
                  <BookOpen className="h-4 w-4" />
                  Cursos Recomendados:
                </div>
                <div className="flex flex-wrap gap-2">
                  {rec.courses.slice(0, 3).map((course: string, i: number) => (
                    <Badge key={i} variant="outline" className="text-xs">
                      {course}
                    </Badge>
                  ))}
                </div>
              </div>
            )}
          </div>
        ))}

        {recommendations.length > 3 && (
          <div className="text-center pt-2">
            <p className="text-sm text-gray-600">
              + {recommendations.length - 3} recomendaÃ§Ãµes adicionais disponÃ­veis apÃ³s criaÃ§Ã£o do PDI
            </p>
          </div>
        )}

        <Alert className="border-blue-200 bg-blue-50">
          <TrendingUp className="h-4 w-4 text-blue-600" />
          <AlertDescription className="text-blue-800 text-sm">
            <strong>Dica:</strong> Estas recomendaÃ§Ãµes foram geradas automaticamente com base nos perfis psicomÃ©tricos. 
            Use-as como ponto de partida para criar um PDI personalizado e eficaz.
          </AlertDescription>
        </Alert>
      </CardContent>
    </Card>
  );
}


========================================
ARQUIVO: ./client/src/components/SuccessionPipeline.tsx
========================================
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { ArrowDown, User, Users, TrendingUp } from "lucide-react";

interface Successor {
  id: number;
  name: string;
  currentPosition: string;
  readiness: "pronto" | "1-2_anos" | "3-5_anos";
  performance: number;
  potential: number;
}

interface SuccessionPlan {
  id: number;
  criticalPosition: string;
  department: string;
  currentHolder?: string;
  successors: Successor[];
  priority: "alta" | "media" | "baixa";
}

interface SuccessionPipelineProps {
  plans: SuccessionPlan[];
}

export default function SuccessionPipeline({ plans }: SuccessionPipelineProps) {
  const getReadinessColor = (readiness: string) => {
    if (readiness === "pronto") return "bg-green-100 text-green-800 border-green-300 dark:bg-green-950 dark:text-green-400";
    if (readiness === "1-2_anos") return "bg-yellow-100 text-yellow-800 border-yellow-300 dark:bg-yellow-950 dark:text-yellow-400";
    return "bg-orange-100 text-orange-800 border-orange-300 dark:bg-orange-950 dark:text-orange-400";
  };

  const getReadinessLabel = (readiness: string) => {
    if (readiness === "pronto") return "Pronto";
    if (readiness === "1-2_anos") return "1-2 anos";
    return "3-5 anos";
  };

  const getPriorityColor = (priority: string) => {
    if (priority === "alta") return "destructive";
    if (priority === "media") return "default";
    return "secondary";
  };

  const getInitials = (name: string) => {
    return name
      .split(" ")
      .map((n) => n[0])
      .join("")
      .toUpperCase()
      .slice(0, 2);
  };

  return (
    <div className="space-y-6">
      {plans.map((plan) => (
        <Card key={plan.id} className="overflow-hidden">
          <CardHeader className="bg-muted/50">
            <div className="flex items-start justify-between">
              <div className="space-y-1">
                <div className="flex items-center gap-2">
                  <CardTitle className="text-lg">{plan.criticalPosition}</CardTitle>
                  <Badge variant={getPriorityColor(plan.priority)}>
                    Prioridade {plan.priority}
                  </Badge>
                </div>
                <CardDescription className="flex items-center gap-2">
                  <Users className="h-4 w-4" />
                  {plan.department}
                </CardDescription>
              </div>
              <div className="text-right">
                <p className="text-sm text-muted-foreground">Sucessores</p>
                <p className="text-2xl font-bold text-primary">{plan.successors.length}</p>
              </div>
            </div>
          </CardHeader>
          <CardContent className="pt-6">
            <div className="space-y-6">
              {/* Titular Atual */}
              {plan.currentHolder && (
                <div className="flex items-center gap-4 p-4 bg-primary/5 rounded-lg border-2 border-primary/20">
                  <Avatar className="h-12 w-12">
                    <AvatarFallback className="bg-primary text-primary-foreground">
                      <User className="h-6 w-6" />
                    </AvatarFallback>
                  </Avatar>
                  <div className="flex-1">
                    <p className="font-semibold">{plan.currentHolder}</p>
                    <p className="text-sm text-muted-foreground">Titular Atual</p>
                  </div>
                  <Badge variant="outline" className="text-xs">
                    PosiÃ§Ã£o CrÃ­tica
                  </Badge>
                </div>
              )}

              {/* Seta indicando sucessÃ£o */}
              <div className="flex justify-center">
                <ArrowDown className="h-6 w-6 text-muted-foreground" />
              </div>

              {/* Pipeline de Sucessores */}
              <div className="space-y-3">
                <h4 className="text-sm font-semibold flex items-center gap-2">
                  <TrendingUp className="h-4 w-4" />
                  Pipeline de SucessÃ£o
                </h4>
                
                {plan.successors.length === 0 ? (
                  <div className="text-center py-8 text-muted-foreground">
                    <Users className="h-12 w-12 mx-auto mb-2 opacity-20" />
                    <p className="text-sm">Nenhum sucessor identificado</p>
                    <p className="text-xs">Considere avaliar candidatos internos</p>
                  </div>
                ) : (
                  <div className="grid gap-3">
                    {plan.successors
                      .sort((a, b) => {
                        const readinessOrder = { pronto: 0, "1-2_anos": 1, "3-5_anos": 2 };
                        return readinessOrder[a.readiness] - readinessOrder[b.readiness];
                      })
                      .map((successor, idx) => (
                        <div
                          key={successor.id}
                          className="flex items-center gap-4 p-3 bg-background border rounded-lg hover:shadow-md transition-shadow"
                        >
                          <div className="flex items-center justify-center w-8 h-8 rounded-full bg-muted text-sm font-semibold">
                            {idx + 1}
                          </div>
                          <Avatar className="h-10 w-10">
                            <AvatarFallback>{getInitials(successor.name)}</AvatarFallback>
                          </Avatar>
                          <div className="flex-1 min-w-0">
                            <p className="font-medium truncate">{successor.name}</p>
                            <p className="text-xs text-muted-foreground truncate">
                              {successor.currentPosition}
                            </p>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="text-right text-xs">
                              <p className="text-muted-foreground">Desempenho</p>
                              <p className="font-semibold text-primary">{successor.performance}/10</p>
                            </div>
                            <div className="text-right text-xs">
                              <p className="text-muted-foreground">Potencial</p>
                              <p className="font-semibold text-purple-600">{successor.potential}/10</p>
                            </div>
                          </div>
                          <Badge
                            variant="outline"
                            className={`text-xs ${getReadinessColor(successor.readiness)}`}
                          >
                            {getReadinessLabel(successor.readiness)}
                          </Badge>
                        </div>
                      ))}
                  </div>
                )}
              </div>

              {/* EstatÃ­sticas do Pipeline */}
              {plan.successors.length > 0 && (
                <div className="grid grid-cols-3 gap-3 pt-4 border-t">
                  <div className="text-center p-2 bg-green-50 dark:bg-green-950 rounded">
                    <p className="text-lg font-bold text-green-600">
                      {plan.successors.filter((s) => s.readiness === "pronto").length}
                    </p>
                    <p className="text-xs text-muted-foreground">Prontos</p>
                  </div>
                  <div className="text-center p-2 bg-yellow-50 dark:bg-yellow-950 rounded">
                    <p className="text-lg font-bold text-yellow-600">
                      {plan.successors.filter((s) => s.readiness === "1-2_anos").length}
                    </p>
                    <p className="text-xs text-muted-foreground">1-2 anos</p>
                  </div>
                  <div className="text-center p-2 bg-orange-50 dark:bg-orange-950 rounded">
                    <p className="text-lg font-bold text-orange-600">
                      {plan.successors.filter((s) => s.readiness === "3-5_anos").length}
                    </p>
                    <p className="text-xs text-muted-foreground">3-5 anos</p>
                  </div>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/components/ui/accordion.tsx
========================================
import * as React from "react";
import * as AccordionPrimitive from "@radix-ui/react-accordion";
import { ChevronDownIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function Accordion({
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Root>) {
  return <AccordionPrimitive.Root data-slot="accordion" {...props} />;
}

function AccordionItem({
  className,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Item>) {
  return (
    <AccordionPrimitive.Item
      data-slot="accordion-item"
      className={cn("border-b last:border-b-0", className)}
      {...props}
    />
  );
}

function AccordionTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Trigger>) {
  return (
    <AccordionPrimitive.Header className="flex">
      <AccordionPrimitive.Trigger
        data-slot="accordion-trigger"
        className={cn(
          "focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-start justify-between gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180",
          className
        )}
        {...props}
      >
        {children}
        <ChevronDownIcon className="text-muted-foreground pointer-events-none size-4 shrink-0 translate-y-0.5 transition-transform duration-200" />
      </AccordionPrimitive.Trigger>
    </AccordionPrimitive.Header>
  );
}

function AccordionContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Content>) {
  return (
    <AccordionPrimitive.Content
      data-slot="accordion-content"
      className="data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm"
      {...props}
    >
      <div className={cn("pt-0 pb-4", className)}>{children}</div>
    </AccordionPrimitive.Content>
  );
}

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent };


========================================
ARQUIVO: ./client/src/components/ui/alert-dialog.tsx
========================================
import * as React from "react";
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog";

import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />;
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  );
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  );
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  );
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  );
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  );
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  );
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  );
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  );
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  );
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
};


========================================
ARQUIVO: ./client/src/components/ui/alert.tsx
========================================
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
);

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  );
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  );
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  );
}

export { Alert, AlertTitle, AlertDescription };


========================================
ARQUIVO: ./client/src/components/ui/aspect-ratio.tsx
========================================
import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio";

function AspectRatio({
  ...props
}: React.ComponentProps<typeof AspectRatioPrimitive.Root>) {
  return <AspectRatioPrimitive.Root data-slot="aspect-ratio" {...props} />;
}

export { AspectRatio };


========================================
ARQUIVO: ./client/src/components/ui/avatar.tsx
========================================
import * as React from "react";
import * as AvatarPrimitive from "@radix-ui/react-avatar";

import { cn } from "@/lib/utils";

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  );
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  );
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  );
}

export { Avatar, AvatarImage, AvatarFallback };


========================================
ARQUIVO: ./client/src/components/ui/badge.tsx
========================================
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
);

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span";

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  );
}

export { Badge, badgeVariants };


========================================
ARQUIVO: ./client/src/components/ui/breadcrumb.tsx
========================================
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { ChevronRight, MoreHorizontal } from "lucide-react";

import { cn } from "@/lib/utils";

function Breadcrumb({ ...props }: React.ComponentProps<"nav">) {
  return <nav aria-label="breadcrumb" data-slot="breadcrumb" {...props} />;
}

function BreadcrumbList({ className, ...props }: React.ComponentProps<"ol">) {
  return (
    <ol
      data-slot="breadcrumb-list"
      className={cn(
        "text-muted-foreground flex flex-wrap items-center gap-1.5 text-sm break-words sm:gap-2.5",
        className
      )}
      {...props}
    />
  );
}

function BreadcrumbItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-item"
      className={cn("inline-flex items-center gap-1.5", className)}
      {...props}
    />
  );
}

function BreadcrumbLink({
  asChild,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean;
}) {
  const Comp = asChild ? Slot : "a";

  return (
    <Comp
      data-slot="breadcrumb-link"
      className={cn("hover:text-foreground transition-colors", className)}
      {...props}
    />
  );
}

function BreadcrumbPage({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-page"
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn("text-foreground font-normal", className)}
      {...props}
    />
  );
}

function BreadcrumbSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-separator"
      role="presentation"
      aria-hidden="true"
      className={cn("[&>svg]:size-3.5", className)}
      {...props}
    >
      {children ?? <ChevronRight />}
    </li>
  );
}

function BreadcrumbEllipsis({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-ellipsis"
      role="presentation"
      aria-hidden="true"
      className={cn("flex size-9 items-center justify-center", className)}
      {...props}
    >
      <MoreHorizontal className="size-4" />
      <span className="sr-only">More</span>
    </span>
  );
}

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
};


========================================
ARQUIVO: ./client/src/components/ui/button-group.tsx
========================================
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";
import { Separator } from "@/components/ui/separator";

const buttonGroupVariants = cva(
  "flex w-fit items-stretch [&>*]:focus-visible:z-10 [&>*]:focus-visible:relative [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md has-[>[data-slot=button-group]]:gap-2",
  {
    variants: {
      orientation: {
        horizontal:
          "[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none",
        vertical:
          "flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none",
      },
    },
    defaultVariants: {
      orientation: "horizontal",
    },
  }
);

function ButtonGroup({
  className,
  orientation,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof buttonGroupVariants>) {
  return (
    <div
      role="group"
      data-slot="button-group"
      data-orientation={orientation}
      className={cn(buttonGroupVariants({ orientation }), className)}
      {...props}
    />
  );
}

function ButtonGroupText({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"div"> & {
  asChild?: boolean;
}) {
  const Comp = asChild ? Slot : "div";

  return (
    <Comp
      className={cn(
        "bg-muted flex items-center gap-2 rounded-md border px-4 text-sm font-medium shadow-xs [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  );
}

function ButtonGroupSeparator({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="button-group-separator"
      orientation={orientation}
      className={cn(
        "bg-input relative !m-0 self-stretch data-[orientation=vertical]:h-auto",
        className
      )}
      {...props}
    />
  );
}

export {
  ButtonGroup,
  ButtonGroupSeparator,
  ButtonGroupText,
  buttonGroupVariants,
};


========================================
ARQUIVO: ./client/src/components/ui/button.tsx
========================================
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-transparent shadow-xs hover:bg-accent dark:bg-transparent dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
);

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean;
  }) {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  );
}

export { Button, buttonVariants };


========================================
ARQUIVO: ./client/src/components/ui/calendar.tsx
========================================
import * as React from "react";
import {
  ChevronDownIcon,
  ChevronLeftIcon,
  ChevronRightIcon,
} from "lucide-react";
import { DayButton, DayPicker, getDefaultClassNames } from "react-day-picker";

import { cn } from "@/lib/utils";
import { Button, buttonVariants } from "@/components/ui/button";

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  captionLayout = "label",
  buttonVariant = "ghost",
  formatters,
  components,
  ...props
}: React.ComponentProps<typeof DayPicker> & {
  buttonVariant?: React.ComponentProps<typeof Button>["variant"];
}) {
  const defaultClassNames = getDefaultClassNames();

  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn(
        "bg-background group/calendar p-3 [--cell-size:--spacing(8)] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent",
        String.raw`rtl:**:[.rdp-button\_next>svg]:rotate-180`,
        String.raw`rtl:**:[.rdp-button\_previous>svg]:rotate-180`,
        className
      )}
      captionLayout={captionLayout}
      formatters={{
        formatMonthDropdown: date =>
          date.toLocaleString("default", { month: "short" }),
        ...formatters,
      }}
      classNames={{
        root: cn("w-fit", defaultClassNames.root),
        months: cn(
          "flex gap-4 flex-col md:flex-row relative",
          defaultClassNames.months
        ),
        month: cn("flex flex-col w-full gap-4", defaultClassNames.month),
        nav: cn(
          "flex items-center gap-1 w-full absolute top-0 inset-x-0 justify-between",
          defaultClassNames.nav
        ),
        button_previous: cn(
          buttonVariants({ variant: buttonVariant }),
          "size-(--cell-size) aria-disabled:opacity-50 p-0 select-none",
          defaultClassNames.button_previous
        ),
        button_next: cn(
          buttonVariants({ variant: buttonVariant }),
          "size-(--cell-size) aria-disabled:opacity-50 p-0 select-none",
          defaultClassNames.button_next
        ),
        month_caption: cn(
          "flex items-center justify-center h-(--cell-size) w-full px-(--cell-size)",
          defaultClassNames.month_caption
        ),
        dropdowns: cn(
          "w-full flex items-center text-sm font-medium justify-center h-(--cell-size) gap-1.5",
          defaultClassNames.dropdowns
        ),
        dropdown_root: cn(
          "relative has-focus:border-ring border border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] rounded-md",
          defaultClassNames.dropdown_root
        ),
        dropdown: cn(
          "absolute bg-popover inset-0 opacity-0",
          defaultClassNames.dropdown
        ),
        caption_label: cn(
          "select-none font-medium",
          captionLayout === "label"
            ? "text-sm"
            : "rounded-md pl-2 pr-1 flex items-center gap-1 text-sm h-8 [&>svg]:text-muted-foreground [&>svg]:size-3.5",
          defaultClassNames.caption_label
        ),
        table: "w-full border-collapse",
        weekdays: cn("flex", defaultClassNames.weekdays),
        weekday: cn(
          "text-muted-foreground rounded-md flex-1 font-normal text-[0.8rem] select-none",
          defaultClassNames.weekday
        ),
        week: cn("flex w-full mt-2", defaultClassNames.week),
        week_number_header: cn(
          "select-none w-(--cell-size)",
          defaultClassNames.week_number_header
        ),
        week_number: cn(
          "text-[0.8rem] select-none text-muted-foreground",
          defaultClassNames.week_number
        ),
        day: cn(
          "relative w-full h-full p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md group/day aspect-square select-none",
          defaultClassNames.day
        ),
        range_start: cn(
          "rounded-l-md bg-accent",
          defaultClassNames.range_start
        ),
        range_middle: cn("rounded-none", defaultClassNames.range_middle),
        range_end: cn("rounded-r-md bg-accent", defaultClassNames.range_end),
        today: cn(
          "bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none",
          defaultClassNames.today
        ),
        outside: cn(
          "text-muted-foreground aria-selected:text-muted-foreground",
          defaultClassNames.outside
        ),
        disabled: cn(
          "text-muted-foreground opacity-50",
          defaultClassNames.disabled
        ),
        hidden: cn("invisible", defaultClassNames.hidden),
        ...classNames,
      }}
      components={{
        Root: ({ className, rootRef, ...props }) => {
          return (
            <div
              data-slot="calendar"
              ref={rootRef}
              className={cn(className)}
              {...props}
            />
          );
        },
        Chevron: ({ className, orientation, ...props }) => {
          if (orientation === "left") {
            return (
              <ChevronLeftIcon className={cn("size-4", className)} {...props} />
            );
          }

          if (orientation === "right") {
            return (
              <ChevronRightIcon
                className={cn("size-4", className)}
                {...props}
              />
            );
          }

          return (
            <ChevronDownIcon className={cn("size-4", className)} {...props} />
          );
        },
        DayButton: CalendarDayButton,
        WeekNumber: ({ children, ...props }) => {
          return (
            <td {...props}>
              <div className="flex size-(--cell-size) items-center justify-center text-center">
                {children}
              </div>
            </td>
          );
        },
        ...components,
      }}
      {...props}
    />
  );
}

function CalendarDayButton({
  className,
  day,
  modifiers,
  ...props
}: React.ComponentProps<typeof DayButton>) {
  const defaultClassNames = getDefaultClassNames();

  const ref = React.useRef<HTMLButtonElement>(null);
  React.useEffect(() => {
    if (modifiers.focused) ref.current?.focus();
  }, [modifiers.focused]);

  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      data-day={day.date.toLocaleDateString()}
      data-selected-single={
        modifiers.selected &&
        !modifiers.range_start &&
        !modifiers.range_end &&
        !modifiers.range_middle
      }
      data-range-start={modifiers.range_start}
      data-range-end={modifiers.range_end}
      data-range-middle={modifiers.range_middle}
      className={cn(
        "data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 dark:hover:text-accent-foreground flex aspect-square size-auto w-full min-w-(--cell-size) flex-col gap-1 leading-none font-normal group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] data-[range-end=true]:rounded-md data-[range-end=true]:rounded-r-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md data-[range-start=true]:rounded-l-md [&>span]:text-xs [&>span]:opacity-70",
        defaultClassNames.day,
        className
      )}
      {...props}
    />
  );
}

export { Calendar, CalendarDayButton };


========================================
ARQUIVO: ./client/src/components/ui/card.tsx
========================================
import * as React from "react";

import { cn } from "@/lib/utils";

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  );
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  );
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  );
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  );
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  );
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  );
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
};


========================================
ARQUIVO: ./client/src/components/ui/carousel.tsx
========================================
import * as React from "react";
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react";
import { ArrowLeft, ArrowRight } from "lucide-react";

import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";

type CarouselApi = UseEmblaCarouselType[1];
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>;
type CarouselOptions = UseCarouselParameters[0];
type CarouselPlugin = UseCarouselParameters[1];

type CarouselProps = {
  opts?: CarouselOptions;
  plugins?: CarouselPlugin;
  orientation?: "horizontal" | "vertical";
  setApi?: (api: CarouselApi) => void;
};

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0];
  api: ReturnType<typeof useEmblaCarousel>[1];
  scrollPrev: () => void;
  scrollNext: () => void;
  canScrollPrev: boolean;
  canScrollNext: boolean;
} & CarouselProps;

const CarouselContext = React.createContext<CarouselContextProps | null>(null);

function useCarousel() {
  const context = React.useContext(CarouselContext);

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />");
  }

  return context;
}

function Carousel({
  orientation = "horizontal",
  opts,
  setApi,
  plugins,
  className,
  children,
  ...props
}: React.ComponentProps<"div"> & CarouselProps) {
  const [carouselRef, api] = useEmblaCarousel(
    {
      ...opts,
      axis: orientation === "horizontal" ? "x" : "y",
    },
    plugins
  );
  const [canScrollPrev, setCanScrollPrev] = React.useState(false);
  const [canScrollNext, setCanScrollNext] = React.useState(false);

  const onSelect = React.useCallback((api: CarouselApi) => {
    if (!api) return;
    setCanScrollPrev(api.canScrollPrev());
    setCanScrollNext(api.canScrollNext());
  }, []);

  const scrollPrev = React.useCallback(() => {
    api?.scrollPrev();
  }, [api]);

  const scrollNext = React.useCallback(() => {
    api?.scrollNext();
  }, [api]);

  const handleKeyDown = React.useCallback(
    (event: React.KeyboardEvent<HTMLDivElement>) => {
      if (event.key === "ArrowLeft") {
        event.preventDefault();
        scrollPrev();
      } else if (event.key === "ArrowRight") {
        event.preventDefault();
        scrollNext();
      }
    },
    [scrollPrev, scrollNext]
  );

  React.useEffect(() => {
    if (!api || !setApi) return;
    setApi(api);
  }, [api, setApi]);

  React.useEffect(() => {
    if (!api) return;
    onSelect(api);
    api.on("reInit", onSelect);
    api.on("select", onSelect);

    return () => {
      api?.off("select", onSelect);
    };
  }, [api, onSelect]);

  return (
    <CarouselContext.Provider
      value={{
        carouselRef,
        api: api,
        opts,
        orientation:
          orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
        scrollPrev,
        scrollNext,
        canScrollPrev,
        canScrollNext,
      }}
    >
      <div
        onKeyDownCapture={handleKeyDown}
        className={cn("relative", className)}
        role="region"
        aria-roledescription="carousel"
        data-slot="carousel"
        {...props}
      >
        {children}
      </div>
    </CarouselContext.Provider>
  );
}

function CarouselContent({ className, ...props }: React.ComponentProps<"div">) {
  const { carouselRef, orientation } = useCarousel();

  return (
    <div
      ref={carouselRef}
      className="overflow-hidden"
      data-slot="carousel-content"
    >
      <div
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  );
}

function CarouselItem({ className, ...props }: React.ComponentProps<"div">) {
  const { orientation } = useCarousel();

  return (
    <div
      role="group"
      aria-roledescription="slide"
      data-slot="carousel-item"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  );
}

function CarouselPrevious({
  className,
  variant = "outline",
  size = "icon",
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel();

  return (
    <Button
      data-slot="carousel-previous"
      variant={variant}
      size={size}
      className={cn(
        "absolute size-8 rounded-full",
        orientation === "horizontal"
          ? "top-1/2 -left-12 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft />
      <span className="sr-only">Previous slide</span>
    </Button>
  );
}

function CarouselNext({
  className,
  variant = "outline",
  size = "icon",
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollNext, canScrollNext } = useCarousel();

  return (
    <Button
      data-slot="carousel-next"
      variant={variant}
      size={size}
      className={cn(
        "absolute size-8 rounded-full",
        orientation === "horizontal"
          ? "top-1/2 -right-12 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight />
      <span className="sr-only">Next slide</span>
    </Button>
  );
}

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
};


========================================
ARQUIVO: ./client/src/components/ui/chart.tsx
========================================
import * as React from "react";
import * as RechartsPrimitive from "recharts";

import { cn } from "@/lib/utils";

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const;

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode;
    icon?: React.ComponentType;
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  );
};

type ChartContextProps = {
  config: ChartConfig;
};

const ChartContext = React.createContext<ChartContextProps | null>(null);

function useChart() {
  const context = React.useContext(ChartContext);

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />");
  }

  return context;
}

function ChartContainer({
  id,
  className,
  children,
  config,
  ...props
}: React.ComponentProps<"div"> & {
  config: ChartConfig;
  children: React.ComponentProps<
    typeof RechartsPrimitive.ResponsiveContainer
  >["children"];
}) {
  const uniqueId = React.useId();
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`;

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-slot="chart"
        data-chart={chartId}
        className={cn(
          "[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  );
}

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  );

  if (!colorConfig.length) {
    return null;
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color;
    return color ? `  --color-${key}: ${color};` : null;
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  );
};

const ChartTooltip = RechartsPrimitive.Tooltip;

function ChartTooltipContent({
  active,
  payload,
  className,
  indicator = "dot",
  hideLabel = false,
  hideIndicator = false,
  label,
  labelFormatter,
  labelClassName,
  formatter,
  color,
  nameKey,
  labelKey,
}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
  React.ComponentProps<"div"> & {
    hideLabel?: boolean;
    hideIndicator?: boolean;
    indicator?: "line" | "dot" | "dashed";
    nameKey?: string;
    labelKey?: string;
  }) {
  const { config } = useChart();

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null;
    }

    const [item] = payload;
    const key = `${labelKey || item?.dataKey || item?.name || "value"}`;
    const itemConfig = getPayloadConfigFromPayload(config, item, key);
    const value =
      !labelKey && typeof label === "string"
        ? config[label as keyof typeof config]?.label || label
        : itemConfig?.label;

    if (labelFormatter) {
      return (
        <div className={cn("font-medium", labelClassName)}>
          {labelFormatter(value, payload)}
        </div>
      );
    }

    if (!value) {
      return null;
    }

    return <div className={cn("font-medium", labelClassName)}>{value}</div>;
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ]);

  if (!active || !payload?.length) {
    return null;
  }

  const nestLabel = payload.length === 1 && indicator !== "dot";

  return (
    <div
      className={cn(
        "border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl",
        className
      )}
    >
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload
          .filter(item => item.type !== "none")
          .map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`;
            const itemConfig = getPayloadConfigFromPayload(config, item, key);
            const indicatorColor = color || item.payload.fill || item.color;

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="text-foreground font-mono font-medium tabular-nums">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            );
          })}
      </div>
    </div>
  );
}

const ChartLegend = RechartsPrimitive.Legend;

function ChartLegendContent({
  className,
  hideIcon = false,
  payload,
  verticalAlign = "bottom",
  nameKey,
}: React.ComponentProps<"div"> &
  Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
    hideIcon?: boolean;
    nameKey?: string;
  }) {
  const { config } = useChart();

  if (!payload?.length) {
    return null;
  }

  return (
    <div
      className={cn(
        "flex items-center justify-center gap-4",
        verticalAlign === "top" ? "pb-3" : "pt-3",
        className
      )}
    >
      {payload
        .filter(item => item.type !== "none")
        .map(item => {
          const key = `${nameKey || item.dataKey || "value"}`;
          const itemConfig = getPayloadConfigFromPayload(config, item, key);

          return (
            <div
              key={item.value}
              className={cn(
                "[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          );
        })}
    </div>
  );
}

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined;
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined;

  let configLabelKey: string = key;

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string;
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string;
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config];
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
};


========================================
ARQUIVO: ./client/src/components/ui/checkbox.tsx
========================================
import * as React from "react";
import * as CheckboxPrimitive from "@radix-ui/react-checkbox";
import { CheckIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="flex items-center justify-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  );
}

export { Checkbox };


========================================
ARQUIVO: ./client/src/components/ui/collapsible.tsx
========================================
import * as CollapsiblePrimitive from "@radix-ui/react-collapsible";

function Collapsible({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.Root>) {
  return <CollapsiblePrimitive.Root data-slot="collapsible" {...props} />;
}

function CollapsibleTrigger({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleTrigger>) {
  return (
    <CollapsiblePrimitive.CollapsibleTrigger
      data-slot="collapsible-trigger"
      {...props}
    />
  );
}

function CollapsibleContent({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleContent>) {
  return (
    <CollapsiblePrimitive.CollapsibleContent
      data-slot="collapsible-content"
      {...props}
    />
  );
}

export { Collapsible, CollapsibleTrigger, CollapsibleContent };


========================================
ARQUIVO: ./client/src/components/ui/combobox.tsx
========================================
import * as React from "react"
import { Check, ChevronsUpDown } from "lucide-react"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from "@/components/ui/command"
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover"

export interface ComboboxOption {
  value: string
  label: string
}

interface ComboboxProps {
  options: ComboboxOption[]
  value?: string
  onValueChange: (value: string) => void
  placeholder?: string
  searchPlaceholder?: string
  emptyText?: string
  className?: string
}

export function Combobox({
  options,
  value,
  onValueChange,
  placeholder = "Selecione...",
  searchPlaceholder = "Buscar...",
  emptyText = "Nenhum resultado encontrado.",
  className,
}: ComboboxProps) {
  const [open, setOpen] = React.useState(false)

  const selectedOption = options.find((option) => option.value === value)

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          role="combobox"
          aria-expanded={open}
          className={cn("w-full justify-between", className)}
        >
          {selectedOption ? selectedOption.label : placeholder}
          <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-full p-0" align="start">
        <Command>
          <CommandInput placeholder={searchPlaceholder} />
          <CommandList>
            <CommandEmpty>{emptyText}</CommandEmpty>
            <CommandGroup>
              {options.map((option) => (
                <CommandItem
                  key={option.value}
                  value={option.value}
                  onSelect={(currentValue) => {
                    onValueChange(currentValue === value ? "" : currentValue)
                    setOpen(false)
                  }}
                >
                  <Check
                    className={cn(
                      "mr-2 h-4 w-4",
                      value === option.value ? "opacity-100" : "opacity-0"
                    )}
                  />
                  {option.label}
                </CommandItem>
              ))}
            </CommandGroup>
          </CommandList>
        </Command>
      </PopoverContent>
    </Popover>
  )
}


========================================
ARQUIVO: ./client/src/components/ui/command.tsx
========================================
"use client";

import * as React from "react";
import { Command as CommandPrimitive } from "cmdk";
import { SearchIcon } from "lucide-react";

import { cn } from "@/lib/utils";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";

function Command({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive>) {
  return (
    <CommandPrimitive
      data-slot="command"
      className={cn(
        "bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md",
        className
      )}
      {...props}
    />
  );
}

function CommandDialog({
  title = "Command Palette",
  description = "Search for a command to run...",
  children,
  className,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof Dialog> & {
  title?: string;
  description?: string;
  className?: string;
  showCloseButton?: boolean;
}) {
  return (
    <Dialog {...props}>
      <DialogHeader className="sr-only">
        <DialogTitle>{title}</DialogTitle>
        <DialogDescription>{description}</DialogDescription>
      </DialogHeader>
      <DialogContent
        className={cn("overflow-hidden p-0", className)}
        showCloseButton={showCloseButton}
      >
        <Command className="[&_[cmdk-group-heading]]:text-muted-foreground **:data-[slot=command-input-wrapper]:h-12 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group]]:px-2 [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  );
}

function CommandInput({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Input>) {
  return (
    <div
      data-slot="command-input-wrapper"
      className="flex h-9 items-center gap-2 border-b px-3"
    >
      <SearchIcon className="size-4 shrink-0 opacity-50" />
      <CommandPrimitive.Input
        data-slot="command-input"
        className={cn(
          "placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        {...props}
      />
    </div>
  );
}

function CommandList({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.List>) {
  return (
    <CommandPrimitive.List
      data-slot="command-list"
      className={cn(
        "max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto",
        className
      )}
      {...props}
    />
  );
}

function CommandEmpty({
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Empty>) {
  return (
    <CommandPrimitive.Empty
      data-slot="command-empty"
      className="py-6 text-center text-sm"
      {...props}
    />
  );
}

function CommandGroup({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Group>) {
  return (
    <CommandPrimitive.Group
      data-slot="command-group"
      className={cn(
        "text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium",
        className
      )}
      {...props}
    />
  );
}

function CommandSeparator({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Separator>) {
  return (
    <CommandPrimitive.Separator
      data-slot="command-separator"
      className={cn("bg-border -mx-1 h-px", className)}
      {...props}
    />
  );
}

function CommandItem({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Item>) {
  return (
    <CommandPrimitive.Item
      data-slot="command-item"
      className={cn(
        "data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  );
}

function CommandShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="command-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  );
}

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
};


========================================
ARQUIVO: ./client/src/components/ui/context-menu.tsx
========================================
import * as React from "react";
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function ContextMenu({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Root>) {
  return <ContextMenuPrimitive.Root data-slot="context-menu" {...props} />;
}

function ContextMenuTrigger({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Trigger>) {
  return (
    <ContextMenuPrimitive.Trigger data-slot="context-menu-trigger" {...props} />
  );
}

function ContextMenuGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Group>) {
  return (
    <ContextMenuPrimitive.Group data-slot="context-menu-group" {...props} />
  );
}

function ContextMenuPortal({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Portal>) {
  return (
    <ContextMenuPrimitive.Portal data-slot="context-menu-portal" {...props} />
  );
}

function ContextMenuSub({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Sub>) {
  return <ContextMenuPrimitive.Sub data-slot="context-menu-sub" {...props} />;
}

function ContextMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioGroup>) {
  return (
    <ContextMenuPrimitive.RadioGroup
      data-slot="context-menu-radio-group"
      {...props}
    />
  );
}

function ContextMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <ContextMenuPrimitive.SubTrigger
      data-slot="context-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto" />
    </ContextMenuPrimitive.SubTrigger>
  );
}

function ContextMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubContent>) {
  return (
    <ContextMenuPrimitive.SubContent
      data-slot="context-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  );
}

function ContextMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Content>) {
  return (
    <ContextMenuPrimitive.Portal>
      <ContextMenuPrimitive.Content
        data-slot="context-menu-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-context-menu-content-available-height) min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </ContextMenuPrimitive.Portal>
  );
}

function ContextMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <ContextMenuPrimitive.Item
      data-slot="context-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  );
}

function ContextMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.CheckboxItem>) {
  return (
    <ContextMenuPrimitive.CheckboxItem
      data-slot="context-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.CheckboxItem>
  );
}

function ContextMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioItem>) {
  return (
    <ContextMenuPrimitive.RadioItem
      data-slot="context-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.RadioItem>
  );
}

function ContextMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <ContextMenuPrimitive.Label
      data-slot="context-menu-label"
      data-inset={inset}
      className={cn(
        "text-foreground px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  );
}

function ContextMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Separator>) {
  return (
    <ContextMenuPrimitive.Separator
      data-slot="context-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function ContextMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="context-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  );
}

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
};


========================================
ARQUIVO: ./client/src/components/ui/dialog.tsx
========================================
import { cn } from "@/lib/utils";
import * as DialogPrimitive from "@radix-ui/react-dialog";
import { XIcon } from "lucide-react";
import * as React from "react";

// Context to track composition state across dialog children
const DialogCompositionContext = React.createContext<{
  isComposing: () => boolean;
  setComposing: (composing: boolean) => void;
  justEndedComposing: () => boolean;
  markCompositionEnd: () => void;
}>({
  isComposing: () => false,
  setComposing: () => {},
  justEndedComposing: () => false,
  markCompositionEnd: () => {},
});

export const useDialogComposition = () =>
  React.useContext(DialogCompositionContext);

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  const composingRef = React.useRef(false);
  const justEndedRef = React.useRef(false);
  const endTimerRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);

  const contextValue = React.useMemo(
    () => ({
      isComposing: () => composingRef.current,
      setComposing: (composing: boolean) => {
        composingRef.current = composing;
      },
      justEndedComposing: () => justEndedRef.current,
      markCompositionEnd: () => {
        justEndedRef.current = true;
        if (endTimerRef.current) {
          clearTimeout(endTimerRef.current);
        }
        endTimerRef.current = setTimeout(() => {
          justEndedRef.current = false;
        }, 150);
      },
    }),
    []
  );

  return (
    <DialogCompositionContext.Provider value={contextValue}>
      <DialogPrimitive.Root data-slot="dialog" {...props} />
    </DialogCompositionContext.Provider>
  );
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />;
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />;
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />;
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  );
}

DialogOverlay.displayName = "DialogOverlay";

function DialogContent({
  className,
  children,
  showCloseButton = true,
  onEscapeKeyDown,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean;
}) {
  const { isComposing } = useDialogComposition();

  const handleEscapeKeyDown = React.useCallback(
    (e: KeyboardEvent) => {
      // Check both the native isComposing property and our context state
      // This handles Safari's timing issues with composition events
      const isCurrentlyComposing = (e as any).isComposing || isComposing();

      // If IME is composing, prevent dialog from closing
      if (isCurrentlyComposing) {
        e.preventDefault();
        return;
      }

      // Call user's onEscapeKeyDown if provided
      onEscapeKeyDown?.(e);
    },
    [isComposing, onEscapeKeyDown]
  );

  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        onEscapeKeyDown={handleEscapeKeyDown}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  );
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  );
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  );
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  );
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger
};



========================================
ARQUIVO: ./client/src/components/ui/drawer.tsx
========================================
import * as React from "react";
import { Drawer as DrawerPrimitive } from "vaul";

import { cn } from "@/lib/utils";

function Drawer({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) {
  return <DrawerPrimitive.Root data-slot="drawer" {...props} />;
}

function DrawerTrigger({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Trigger>) {
  return <DrawerPrimitive.Trigger data-slot="drawer-trigger" {...props} />;
}

function DrawerPortal({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Portal>) {
  return <DrawerPrimitive.Portal data-slot="drawer-portal" {...props} />;
}

function DrawerClose({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Close>) {
  return <DrawerPrimitive.Close data-slot="drawer-close" {...props} />;
}

function DrawerOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Overlay>) {
  return (
    <DrawerPrimitive.Overlay
      data-slot="drawer-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  );
}

function DrawerContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Content>) {
  return (
    <DrawerPortal data-slot="drawer-portal">
      <DrawerOverlay />
      <DrawerPrimitive.Content
        data-slot="drawer-content"
        className={cn(
          "group/drawer-content bg-background fixed z-50 flex h-auto flex-col",
          "data-[vaul-drawer-direction=top]:inset-x-0 data-[vaul-drawer-direction=top]:top-0 data-[vaul-drawer-direction=top]:mb-24 data-[vaul-drawer-direction=top]:max-h-[80vh] data-[vaul-drawer-direction=top]:rounded-b-lg data-[vaul-drawer-direction=top]:border-b",
          "data-[vaul-drawer-direction=bottom]:inset-x-0 data-[vaul-drawer-direction=bottom]:bottom-0 data-[vaul-drawer-direction=bottom]:mt-24 data-[vaul-drawer-direction=bottom]:max-h-[80vh] data-[vaul-drawer-direction=bottom]:rounded-t-lg data-[vaul-drawer-direction=bottom]:border-t",
          "data-[vaul-drawer-direction=right]:inset-y-0 data-[vaul-drawer-direction=right]:right-0 data-[vaul-drawer-direction=right]:w-3/4 data-[vaul-drawer-direction=right]:border-l data-[vaul-drawer-direction=right]:sm:max-w-sm",
          "data-[vaul-drawer-direction=left]:inset-y-0 data-[vaul-drawer-direction=left]:left-0 data-[vaul-drawer-direction=left]:w-3/4 data-[vaul-drawer-direction=left]:border-r data-[vaul-drawer-direction=left]:sm:max-w-sm",
          className
        )}
        {...props}
      >
        <div className="bg-muted mx-auto mt-4 hidden h-2 w-[100px] shrink-0 rounded-full group-data-[vaul-drawer-direction=bottom]/drawer-content:block" />
        {children}
      </DrawerPrimitive.Content>
    </DrawerPortal>
  );
}

function DrawerHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="drawer-header"
      className={cn(
        "flex flex-col gap-0.5 p-4 group-data-[vaul-drawer-direction=bottom]/drawer-content:text-center group-data-[vaul-drawer-direction=top]/drawer-content:text-center md:gap-1.5 md:text-left",
        className
      )}
      {...props}
    />
  );
}

function DrawerFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="drawer-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  );
}

function DrawerTitle({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Title>) {
  return (
    <DrawerPrimitive.Title
      data-slot="drawer-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  );
}

function DrawerDescription({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Description>) {
  return (
    <DrawerPrimitive.Description
      data-slot="drawer-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
};


========================================
ARQUIVO: ./client/src/components/ui/dropdown-menu.tsx
========================================
import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />;
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  );
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  );
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  );
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  );
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  );
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  );
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  );
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  );
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  );
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  );
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />;
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  );
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  );
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
};


========================================
ARQUIVO: ./client/src/components/ui/empty.tsx
========================================
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

function Empty({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="empty"
      className={cn(
        "flex min-w-0 flex-1 flex-col items-center justify-center gap-6 rounded-lg border-dashed p-6 text-center text-balance md:p-12",
        className
      )}
      {...props}
    />
  );
}

function EmptyHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="empty-header"
      className={cn(
        "flex max-w-sm flex-col items-center gap-2 text-center",
        className
      )}
      {...props}
    />
  );
}

const emptyMediaVariants = cva(
  "flex shrink-0 items-center justify-center mb-2 [&_svg]:pointer-events-none [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        icon: "bg-muted text-foreground flex size-10 shrink-0 items-center justify-center rounded-lg [&_svg:not([class*='size-'])]:size-6",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
);

function EmptyMedia({
  className,
  variant = "default",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof emptyMediaVariants>) {
  return (
    <div
      data-slot="empty-icon"
      data-variant={variant}
      className={cn(emptyMediaVariants({ variant, className }))}
      {...props}
    />
  );
}

function EmptyTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="empty-title"
      className={cn("text-lg font-medium tracking-tight", className)}
      {...props}
    />
  );
}

function EmptyDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <div
      data-slot="empty-description"
      className={cn(
        "text-muted-foreground [&>a:hover]:text-primary text-sm/relaxed [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  );
}

function EmptyContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="empty-content"
      className={cn(
        "flex w-full max-w-sm min-w-0 flex-col items-center gap-4 text-sm text-balance",
        className
      )}
      {...props}
    />
  );
}

export {
  Empty,
  EmptyHeader,
  EmptyTitle,
  EmptyDescription,
  EmptyContent,
  EmptyMedia,
};


========================================
ARQUIVO: ./client/src/components/ui/field.tsx
========================================
import { useMemo } from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";
import { Label } from "@/components/ui/label";
import { Separator } from "@/components/ui/separator";

function FieldSet({ className, ...props }: React.ComponentProps<"fieldset">) {
  return (
    <fieldset
      data-slot="field-set"
      className={cn(
        "flex flex-col gap-6",
        "has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3",
        className
      )}
      {...props}
    />
  );
}

function FieldLegend({
  className,
  variant = "legend",
  ...props
}: React.ComponentProps<"legend"> & { variant?: "legend" | "label" }) {
  return (
    <legend
      data-slot="field-legend"
      data-variant={variant}
      className={cn(
        "mb-3 font-medium",
        "data-[variant=legend]:text-base",
        "data-[variant=label]:text-sm",
        className
      )}
      {...props}
    />
  );
}

function FieldGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-group"
      className={cn(
        "group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4",
        className
      )}
      {...props}
    />
  );
}

const fieldVariants = cva(
  "group/field flex w-full gap-3 data-[invalid=true]:text-destructive",
  {
    variants: {
      orientation: {
        vertical: ["flex-col [&>*]:w-full [&>.sr-only]:w-auto"],
        horizontal: [
          "flex-row items-center",
          "[&>[data-slot=field-label]]:flex-auto",
          "has-[>[data-slot=field-content]]:items-start has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px",
        ],
        responsive: [
          "flex-col [&>*]:w-full [&>.sr-only]:w-auto @md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto",
          "@md/field-group:[&>[data-slot=field-label]]:flex-auto",
          "@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px",
        ],
      },
    },
    defaultVariants: {
      orientation: "vertical",
    },
  }
);

function Field({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof fieldVariants>) {
  return (
    <div
      role="group"
      data-slot="field"
      data-orientation={orientation}
      className={cn(fieldVariants({ orientation }), className)}
      {...props}
    />
  );
}

function FieldContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-content"
      className={cn(
        "group/field-content flex flex-1 flex-col gap-1.5 leading-snug",
        className
      )}
      {...props}
    />
  );
}

function FieldLabel({
  className,
  ...props
}: React.ComponentProps<typeof Label>) {
  return (
    <Label
      data-slot="field-label"
      className={cn(
        "group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50",
        "has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>*]:data-[slot=field]:p-4",
        "has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10",
        className
      )}
      {...props}
    />
  );
}

function FieldTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-label"
      className={cn(
        "flex w-fit items-center gap-2 text-sm leading-snug font-medium group-data-[disabled=true]/field:opacity-50",
        className
      )}
      {...props}
    />
  );
}

function FieldDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <p
      data-slot="field-description"
      className={cn(
        "text-muted-foreground text-sm leading-normal font-normal group-has-[[data-orientation=horizontal]]/field:text-balance",
        "last:mt-0 nth-last-2:-mt-1 [[data-variant=legend]+&]:-mt-1.5",
        "[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  );
}

function FieldSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"div"> & {
  children?: React.ReactNode;
}) {
  return (
    <div
      data-slot="field-separator"
      data-content={!!children}
      className={cn(
        "relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2",
        className
      )}
      {...props}
    >
      <Separator className="absolute inset-0 top-1/2" />
      {children && (
        <span
          className="bg-background text-muted-foreground relative mx-auto block w-fit px-2"
          data-slot="field-separator-content"
        >
          {children}
        </span>
      )}
    </div>
  );
}

function FieldError({
  className,
  children,
  errors,
  ...props
}: React.ComponentProps<"div"> & {
  errors?: Array<{ message?: string } | undefined>;
}) {
  const content = useMemo(() => {
    if (children) {
      return children;
    }

    if (!errors) {
      return null;
    }

    if (errors?.length === 1 && errors[0]?.message) {
      return errors[0].message;
    }

    return (
      <ul className="ml-4 flex list-disc flex-col gap-1">
        {errors.map(
          (error, index) =>
            error?.message && <li key={index}>{error.message}</li>
        )}
      </ul>
    );
  }, [children, errors]);

  if (!content) {
    return null;
  }

  return (
    <div
      role="alert"
      data-slot="field-error"
      className={cn("text-destructive text-sm font-normal", className)}
      {...props}
    >
      {content}
    </div>
  );
}

export {
  Field,
  FieldLabel,
  FieldDescription,
  FieldError,
  FieldGroup,
  FieldLegend,
  FieldSeparator,
  FieldSet,
  FieldContent,
  FieldTitle,
};


========================================
ARQUIVO: ./client/src/components/ui/form.tsx
========================================
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { Slot } from "@radix-ui/react-slot";
import {
  Controller,
  FormProvider,
  useFormContext,
  useFormState,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form";

import { cn } from "@/lib/utils";
import { Label } from "@/components/ui/label";

const Form = FormProvider;

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName;
};

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
);

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  );
};

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext);
  const itemContext = React.useContext(FormItemContext);
  const { getFieldState } = useFormContext();
  const formState = useFormState({ name: fieldContext.name });
  const fieldState = getFieldState(fieldContext.name, formState);

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>");
  }

  const { id } = itemContext;

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  };
};

type FormItemContextValue = {
  id: string;
};

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
);

function FormItem({ className, ...props }: React.ComponentProps<"div">) {
  const id = React.useId();

  return (
    <FormItemContext.Provider value={{ id }}>
      <div
        data-slot="form-item"
        className={cn("grid gap-2", className)}
        {...props}
      />
    </FormItemContext.Provider>
  );
}

function FormLabel({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  const { error, formItemId } = useFormField();

  return (
    <Label
      data-slot="form-label"
      data-error={!!error}
      className={cn("data-[error=true]:text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  );
}

function FormControl({ ...props }: React.ComponentProps<typeof Slot>) {
  const { error, formItemId, formDescriptionId, formMessageId } =
    useFormField();

  return (
    <Slot
      data-slot="form-control"
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  );
}

function FormDescription({ className, ...props }: React.ComponentProps<"p">) {
  const { formDescriptionId } = useFormField();

  return (
    <p
      data-slot="form-description"
      id={formDescriptionId}
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

function FormMessage({ className, ...props }: React.ComponentProps<"p">) {
  const { error, formMessageId } = useFormField();
  const body = error ? String(error?.message ?? "") : props.children;

  if (!body) {
    return null;
  }

  return (
    <p
      data-slot="form-message"
      id={formMessageId}
      className={cn("text-destructive text-sm", className)}
      {...props}
    >
      {body}
    </p>
  );
}

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
};


========================================
ARQUIVO: ./client/src/components/ui/hover-card.tsx
========================================
import * as React from "react";
import * as HoverCardPrimitive from "@radix-ui/react-hover-card";

import { cn } from "@/lib/utils";

function HoverCard({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Root>) {
  return <HoverCardPrimitive.Root data-slot="hover-card" {...props} />;
}

function HoverCardTrigger({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Trigger>) {
  return (
    <HoverCardPrimitive.Trigger data-slot="hover-card-trigger" {...props} />
  );
}

function HoverCardContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Content>) {
  return (
    <HoverCardPrimitive.Portal data-slot="hover-card-portal">
      <HoverCardPrimitive.Content
        data-slot="hover-card-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-64 origin-(--radix-hover-card-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className
        )}
        {...props}
      />
    </HoverCardPrimitive.Portal>
  );
}

export { HoverCard, HoverCardTrigger, HoverCardContent };


========================================
ARQUIVO: ./client/src/components/ui/input-group.tsx
========================================
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";

function InputGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="input-group"
      role="group"
      className={cn(
        "group/input-group border-input dark:bg-input/30 relative flex w-full items-center rounded-md border shadow-xs transition-[color,box-shadow] outline-none",
        "h-9 min-w-0 has-[>textarea]:h-auto",

        // Variants based on alignment.
        "has-[>[data-align=inline-start]]:[&>input]:pl-2",
        "has-[>[data-align=inline-end]]:[&>input]:pr-2",
        "has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3",
        "has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3",

        // Focus state.
        "has-[[data-slot=input-group-control]:focus-visible]:border-ring has-[[data-slot=input-group-control]:focus-visible]:ring-ring/50 has-[[data-slot=input-group-control]:focus-visible]:ring-[3px]",

        // Error state.
        "has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40",

        className
      )}
      {...props}
    />
  );
}

const inputGroupAddonVariants = cva(
  "text-muted-foreground flex h-auto cursor-text items-center justify-center gap-2 py-1.5 text-sm font-medium select-none [&>svg:not([class*='size-'])]:size-4 [&>kbd]:rounded-[calc(var(--radius)-5px)] group-data-[disabled=true]/input-group:opacity-50",
  {
    variants: {
      align: {
        "inline-start":
          "order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]",
        "inline-end":
          "order-last pr-3 has-[>button]:mr-[-0.45rem] has-[>kbd]:mr-[-0.35rem]",
        "block-start":
          "order-first w-full justify-start px-3 pt-3 [.border-b]:pb-3 group-has-[>input]/input-group:pt-2.5",
        "block-end":
          "order-last w-full justify-start px-3 pb-3 [.border-t]:pt-3 group-has-[>input]/input-group:pb-2.5",
      },
    },
    defaultVariants: {
      align: "inline-start",
    },
  }
);

function InputGroupAddon({
  className,
  align = "inline-start",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof inputGroupAddonVariants>) {
  return (
    <div
      role="group"
      data-slot="input-group-addon"
      data-align={align}
      className={cn(inputGroupAddonVariants({ align }), className)}
      onClick={e => {
        if ((e.target as HTMLElement).closest("button")) {
          return;
        }
        e.currentTarget.parentElement?.querySelector("input")?.focus();
      }}
      {...props}
    />
  );
}

const inputGroupButtonVariants = cva(
  "text-sm shadow-none flex gap-2 items-center",
  {
    variants: {
      size: {
        xs: "h-6 gap-1 px-2 rounded-[calc(var(--radius)-5px)] [&>svg:not([class*='size-'])]:size-3.5 has-[>svg]:px-2",
        sm: "h-8 px-2.5 gap-1.5 rounded-md has-[>svg]:px-2.5",
        "icon-xs":
          "size-6 rounded-[calc(var(--radius)-5px)] p-0 has-[>svg]:p-0",
        "icon-sm": "size-8 p-0 has-[>svg]:p-0",
      },
    },
    defaultVariants: {
      size: "xs",
    },
  }
);

function InputGroupButton({
  className,
  type = "button",
  variant = "ghost",
  size = "xs",
  ...props
}: Omit<React.ComponentProps<typeof Button>, "size"> &
  VariantProps<typeof inputGroupButtonVariants>) {
  return (
    <Button
      type={type}
      data-size={size}
      variant={variant}
      className={cn(inputGroupButtonVariants({ size }), className)}
      {...props}
    />
  );
}

function InputGroupText({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      className={cn(
        "text-muted-foreground flex items-center gap-2 text-sm [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  );
}

function InputGroupInput({
  className,
  ...props
}: React.ComponentProps<"input">) {
  return (
    <Input
      data-slot="input-group-control"
      className={cn(
        "flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent",
        className
      )}
      {...props}
    />
  );
}

function InputGroupTextarea({
  className,
  ...props
}: React.ComponentProps<"textarea">) {
  return (
    <Textarea
      data-slot="input-group-control"
      className={cn(
        "flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent",
        className
      )}
      {...props}
    />
  );
}

export {
  InputGroup,
  InputGroupAddon,
  InputGroupButton,
  InputGroupText,
  InputGroupInput,
  InputGroupTextarea,
};


========================================
ARQUIVO: ./client/src/components/ui/input-otp.tsx
========================================
import * as React from "react";
import { OTPInput, OTPInputContext } from "input-otp";
import { MinusIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function InputOTP({
  className,
  containerClassName,
  ...props
}: React.ComponentProps<typeof OTPInput> & {
  containerClassName?: string;
}) {
  return (
    <OTPInput
      data-slot="input-otp"
      containerClassName={cn(
        "flex items-center gap-2 has-disabled:opacity-50",
        containerClassName
      )}
      className={cn("disabled:cursor-not-allowed", className)}
      {...props}
    />
  );
}

function InputOTPGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="input-otp-group"
      className={cn("flex items-center", className)}
      {...props}
    />
  );
}

function InputOTPSlot({
  index,
  className,
  ...props
}: React.ComponentProps<"div"> & {
  index: number;
}) {
  const inputOTPContext = React.useContext(OTPInputContext);
  const { char, hasFakeCaret, isActive } = inputOTPContext?.slots[index] ?? {};

  return (
    <div
      data-slot="input-otp-slot"
      data-active={isActive}
      className={cn(
        "data-[active=true]:border-ring data-[active=true]:ring-ring/50 data-[active=true]:aria-invalid:ring-destructive/20 dark:data-[active=true]:aria-invalid:ring-destructive/40 aria-invalid:border-destructive data-[active=true]:aria-invalid:border-destructive dark:bg-input/30 border-input relative flex h-9 w-9 items-center justify-center border-y border-r text-sm shadow-xs transition-all outline-none first:rounded-l-md first:border-l last:rounded-r-md data-[active=true]:z-10 data-[active=true]:ring-[3px]",
        className
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="animate-caret-blink bg-foreground h-4 w-px duration-1000" />
        </div>
      )}
    </div>
  );
}

function InputOTPSeparator({ ...props }: React.ComponentProps<"div">) {
  return (
    <div data-slot="input-otp-separator" role="separator" {...props}>
      <MinusIcon />
    </div>
  );
}

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator };


========================================
ARQUIVO: ./client/src/components/ui/input.tsx
========================================
import { useDialogComposition } from "@/components/ui/dialog";
import { useComposition } from "@/hooks/useComposition";
import { cn } from "@/lib/utils";
import * as React from "react";

function Input({
  className,
  type,
  onKeyDown,
  onCompositionStart,
  onCompositionEnd,
  ...props
}: React.ComponentProps<"input">) {
  // Get dialog composition context if available (will be no-op if not inside Dialog)
  const dialogComposition = useDialogComposition();

  // Add composition event handlers to support input method editor (IME) for CJK languages.
  const {
    onCompositionStart: handleCompositionStart,
    onCompositionEnd: handleCompositionEnd,
    onKeyDown: handleKeyDown,
  } = useComposition<HTMLInputElement>({
    onKeyDown: (e) => {
      // Check if this is an Enter key that should be blocked
      const isComposing = (e.nativeEvent as any).isComposing || dialogComposition.justEndedComposing();

      // If Enter key is pressed while composing or just after composition ended,
      // don't call the user's onKeyDown (this blocks the business logic)
      if (e.key === "Enter" && isComposing) {
        return;
      }

      // Otherwise, call the user's onKeyDown
      onKeyDown?.(e);
    },
    onCompositionStart: e => {
      dialogComposition.setComposing(true);
      onCompositionStart?.(e);
    },
    onCompositionEnd: e => {
      // Mark that composition just ended - this helps handle the Enter key that confirms input
      dialogComposition.markCompositionEnd();
      // Delay setting composing to false to handle Safari's event order
      // In Safari, compositionEnd fires before the ESC keydown event
      setTimeout(() => {
        dialogComposition.setComposing(false);
      }, 100);
      onCompositionEnd?.(e);
    },
  });

  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      onCompositionStart={handleCompositionStart}
      onCompositionEnd={handleCompositionEnd}
      onKeyDown={handleKeyDown}
      {...props}
    />
  );
}

export { Input };


========================================
ARQUIVO: ./client/src/components/ui/item.tsx
========================================
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";
import { Separator } from "@/components/ui/separator";

function ItemGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      role="list"
      data-slot="item-group"
      className={cn("group/item-group flex flex-col", className)}
      {...props}
    />
  );
}

function ItemSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="item-separator"
      orientation="horizontal"
      className={cn("my-0", className)}
      {...props}
    />
  );
}

const itemVariants = cva(
  "group/item flex items-center border border-transparent text-sm rounded-md transition-colors [a]:hover:bg-accent/50 [a]:transition-colors duration-100 flex-wrap outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline: "border-border",
        muted: "bg-muted/50",
      },
      size: {
        default: "p-4 gap-4 ",
        sm: "py-3 px-4 gap-2.5",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
);

function Item({
  className,
  variant = "default",
  size = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"div"> &
  VariantProps<typeof itemVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "div";
  return (
    <Comp
      data-slot="item"
      data-variant={variant}
      data-size={size}
      className={cn(itemVariants({ variant, size, className }))}
      {...props}
    />
  );
}

const itemMediaVariants = cva(
  "flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none group-has-[[data-slot=item-description]]/item:translate-y-0.5",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        icon: "size-8 border rounded-sm bg-muted [&_svg:not([class*='size-'])]:size-4",
        image:
          "size-10 rounded-sm overflow-hidden [&_img]:size-full [&_img]:object-cover",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
);

function ItemMedia({
  className,
  variant = "default",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof itemMediaVariants>) {
  return (
    <div
      data-slot="item-media"
      data-variant={variant}
      className={cn(itemMediaVariants({ variant, className }))}
      {...props}
    />
  );
}

function ItemContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-content"
      className={cn(
        "flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none",
        className
      )}
      {...props}
    />
  );
}

function ItemTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-title"
      className={cn(
        "flex w-fit items-center gap-2 text-sm leading-snug font-medium",
        className
      )}
      {...props}
    />
  );
}

function ItemDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <p
      data-slot="item-description"
      className={cn(
        "text-muted-foreground line-clamp-2 text-sm leading-normal font-normal text-balance",
        "[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  );
}

function ItemActions({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-actions"
      className={cn("flex items-center gap-2", className)}
      {...props}
    />
  );
}

function ItemHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-header"
      className={cn(
        "flex basis-full items-center justify-between gap-2",
        className
      )}
      {...props}
    />
  );
}

function ItemFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-footer"
      className={cn(
        "flex basis-full items-center justify-between gap-2",
        className
      )}
      {...props}
    />
  );
}

export {
  Item,
  ItemMedia,
  ItemContent,
  ItemActions,
  ItemGroup,
  ItemSeparator,
  ItemTitle,
  ItemDescription,
  ItemHeader,
  ItemFooter,
};


========================================
ARQUIVO: ./client/src/components/ui/kbd.tsx
========================================
import { cn } from "@/lib/utils";

function Kbd({ className, ...props }: React.ComponentProps<"kbd">) {
  return (
    <kbd
      data-slot="kbd"
      className={cn(
        "bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium select-none",
        "[&_svg:not([class*='size-'])]:size-3",
        "[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10",
        className
      )}
      {...props}
    />
  );
}

function KbdGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <kbd
      data-slot="kbd-group"
      className={cn("inline-flex items-center gap-1", className)}
      {...props}
    />
  );
}

export { Kbd, KbdGroup };


========================================
ARQUIVO: ./client/src/components/ui/label.tsx
========================================
import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";

import { cn } from "@/lib/utils";

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  );
}

export { Label };


========================================
ARQUIVO: ./client/src/components/ui/menubar.tsx
========================================
import * as React from "react";
import * as MenubarPrimitive from "@radix-ui/react-menubar";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function Menubar({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Root>) {
  return (
    <MenubarPrimitive.Root
      data-slot="menubar"
      className={cn(
        "bg-background flex h-9 items-center gap-1 rounded-md border p-1 shadow-xs",
        className
      )}
      {...props}
    />
  );
}

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu data-slot="menubar-menu" {...props} />;
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group data-slot="menubar-group" {...props} />;
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal data-slot="menubar-portal" {...props} />;
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return (
    <MenubarPrimitive.RadioGroup data-slot="menubar-radio-group" {...props} />
  );
}

function MenubarTrigger({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Trigger>) {
  return (
    <MenubarPrimitive.Trigger
      data-slot="menubar-trigger"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex items-center rounded-sm px-2 py-1 text-sm font-medium outline-hidden select-none",
        className
      )}
      {...props}
    />
  );
}

function MenubarContent({
  className,
  align = "start",
  alignOffset = -4,
  sideOffset = 8,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Content>) {
  return (
    <MenubarPortal>
      <MenubarPrimitive.Content
        data-slot="menubar-content"
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[12rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </MenubarPortal>
  );
}

function MenubarItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <MenubarPrimitive.Item
      data-slot="menubar-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  );
}

function MenubarCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.CheckboxItem>) {
  return (
    <MenubarPrimitive.CheckboxItem
      data-slot="menubar-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.CheckboxItem>
  );
}

function MenubarRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioItem>) {
  return (
    <MenubarPrimitive.RadioItem
      data-slot="menubar-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.RadioItem>
  );
}

function MenubarLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <MenubarPrimitive.Label
      data-slot="menubar-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  );
}

function MenubarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Separator>) {
  return (
    <MenubarPrimitive.Separator
      data-slot="menubar-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function MenubarShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="menubar-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  );
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />;
}

function MenubarSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <MenubarPrimitive.SubTrigger
      data-slot="menubar-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-none select-none data-[inset]:pl-8",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto h-4 w-4" />
    </MenubarPrimitive.SubTrigger>
  );
}

function MenubarSubContent({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubContent>) {
  return (
    <MenubarPrimitive.SubContent
      data-slot="menubar-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  );
}

export {
  Menubar,
  MenubarPortal,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarGroup,
  MenubarSeparator,
  MenubarLabel,
  MenubarItem,
  MenubarShortcut,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarSub,
  MenubarSubTrigger,
  MenubarSubContent,
};


========================================
ARQUIVO: ./client/src/components/ui/navigation-menu.tsx
========================================
import * as React from "react";
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu";
import { cva } from "class-variance-authority";
import { ChevronDownIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function NavigationMenu({
  className,
  children,
  viewport = true,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Root> & {
  viewport?: boolean;
}) {
  return (
    <NavigationMenuPrimitive.Root
      data-slot="navigation-menu"
      data-viewport={viewport}
      className={cn(
        "group/navigation-menu relative flex max-w-max flex-1 items-center justify-center",
        className
      )}
      {...props}
    >
      {children}
      {viewport && <NavigationMenuViewport />}
    </NavigationMenuPrimitive.Root>
  );
}

function NavigationMenuList({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.List>) {
  return (
    <NavigationMenuPrimitive.List
      data-slot="navigation-menu-list"
      className={cn(
        "group flex flex-1 list-none items-center justify-center gap-1",
        className
      )}
      {...props}
    />
  );
}

function NavigationMenuItem({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Item>) {
  return (
    <NavigationMenuPrimitive.Item
      data-slot="navigation-menu-item"
      className={cn("relative", className)}
      {...props}
    />
  );
}

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=open]:hover:bg-accent data-[state=open]:text-accent-foreground data-[state=open]:focus:bg-accent data-[state=open]:bg-accent/50 focus-visible:ring-ring/50 outline-none transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1"
);

function NavigationMenuTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Trigger>) {
  return (
    <NavigationMenuPrimitive.Trigger
      data-slot="navigation-menu-trigger"
      className={cn(navigationMenuTriggerStyle(), "group", className)}
      {...props}
    >
      {children}{" "}
      <ChevronDownIcon
        className="relative top-[1px] ml-1 size-3 transition duration-300 group-data-[state=open]:rotate-180"
        aria-hidden="true"
      />
    </NavigationMenuPrimitive.Trigger>
  );
}

function NavigationMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Content>) {
  return (
    <NavigationMenuPrimitive.Content
      data-slot="navigation-menu-content"
      className={cn(
        "data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 top-0 left-0 w-full p-2 pr-2.5 md:absolute md:w-auto",
        "group-data-[viewport=false]/navigation-menu:bg-popover group-data-[viewport=false]/navigation-menu:text-popover-foreground group-data-[viewport=false]/navigation-menu:data-[state=open]:animate-in group-data-[viewport=false]/navigation-menu:data-[state=closed]:animate-out group-data-[viewport=false]/navigation-menu:data-[state=closed]:zoom-out-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:zoom-in-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:fade-in-0 group-data-[viewport=false]/navigation-menu:data-[state=closed]:fade-out-0 group-data-[viewport=false]/navigation-menu:top-full group-data-[viewport=false]/navigation-menu:mt-1.5 group-data-[viewport=false]/navigation-menu:overflow-hidden group-data-[viewport=false]/navigation-menu:rounded-md group-data-[viewport=false]/navigation-menu:border group-data-[viewport=false]/navigation-menu:shadow group-data-[viewport=false]/navigation-menu:duration-200 **:data-[slot=navigation-menu-link]:focus:ring-0 **:data-[slot=navigation-menu-link]:focus:outline-none",
        className
      )}
      {...props}
    />
  );
}

function NavigationMenuViewport({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Viewport>) {
  return (
    <div
      className={cn(
        "absolute top-full left-0 isolate z-50 flex justify-center"
      )}
    >
      <NavigationMenuPrimitive.Viewport
        data-slot="navigation-menu-viewport"
        className={cn(
          "origin-top-center bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border shadow md:w-[var(--radix-navigation-menu-viewport-width)]",
          className
        )}
        {...props}
      />
    </div>
  );
}

function NavigationMenuLink({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Link>) {
  return (
    <NavigationMenuPrimitive.Link
      data-slot="navigation-menu-link"
      className={cn(
        "data-[active=true]:focus:bg-accent data-[active=true]:hover:bg-accent data-[active=true]:bg-accent/50 data-[active=true]:text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus-visible:ring-ring/50 [&_svg:not([class*='text-'])]:text-muted-foreground flex flex-col gap-1 rounded-sm p-2 text-sm transition-all outline-none focus-visible:ring-[3px] focus-visible:outline-1 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  );
}

function NavigationMenuIndicator({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Indicator>) {
  return (
    <NavigationMenuPrimitive.Indicator
      data-slot="navigation-menu-indicator"
      className={cn(
        "data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden",
        className
      )}
      {...props}
    >
      <div className="bg-border relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm shadow-md" />
    </NavigationMenuPrimitive.Indicator>
  );
}

export {
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
  navigationMenuTriggerStyle,
};


========================================
ARQUIVO: ./client/src/components/ui/pagination.tsx
========================================
import * as React from "react";
import {
  ChevronLeftIcon,
  ChevronRightIcon,
  MoreHorizontalIcon,
} from "lucide-react";

import { cn } from "@/lib/utils";
import { Button, buttonVariants } from "@/components/ui/button";

function Pagination({ className, ...props }: React.ComponentProps<"nav">) {
  return (
    <nav
      role="navigation"
      aria-label="pagination"
      data-slot="pagination"
      className={cn("mx-auto flex w-full justify-center", className)}
      {...props}
    />
  );
}

function PaginationContent({
  className,
  ...props
}: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="pagination-content"
      className={cn("flex flex-row items-center gap-1", className)}
      {...props}
    />
  );
}

function PaginationItem({ ...props }: React.ComponentProps<"li">) {
  return <li data-slot="pagination-item" {...props} />;
}

type PaginationLinkProps = {
  isActive?: boolean;
} & Pick<React.ComponentProps<typeof Button>, "size"> &
  React.ComponentProps<"a">;

function PaginationLink({
  className,
  isActive,
  size = "icon",
  ...props
}: PaginationLinkProps) {
  return (
    <a
      aria-current={isActive ? "page" : undefined}
      data-slot="pagination-link"
      data-active={isActive}
      className={cn(
        buttonVariants({
          variant: isActive ? "outline" : "ghost",
          size,
        }),
        className
      )}
      {...props}
    />
  );
}

function PaginationPrevious({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to previous page"
      size="default"
      className={cn("gap-1 px-2.5 sm:pl-2.5", className)}
      {...props}
    >
      <ChevronLeftIcon />
      <span className="hidden sm:block">Previous</span>
    </PaginationLink>
  );
}

function PaginationNext({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to next page"
      size="default"
      className={cn("gap-1 px-2.5 sm:pr-2.5", className)}
      {...props}
    >
      <span className="hidden sm:block">Next</span>
      <ChevronRightIcon />
    </PaginationLink>
  );
}

function PaginationEllipsis({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      aria-hidden
      data-slot="pagination-ellipsis"
      className={cn("flex size-9 items-center justify-center", className)}
      {...props}
    >
      <MoreHorizontalIcon className="size-4" />
      <span className="sr-only">More pages</span>
    </span>
  );
}

export {
  Pagination,
  PaginationContent,
  PaginationLink,
  PaginationItem,
  PaginationPrevious,
  PaginationNext,
  PaginationEllipsis,
};


========================================
ARQUIVO: ./client/src/components/ui/popover.tsx
========================================
import * as React from "react";
import * as PopoverPrimitive from "@radix-ui/react-popover";

import { cn } from "@/lib/utils";

function Popover({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Root>) {
  return <PopoverPrimitive.Root data-slot="popover" {...props} />;
}

function PopoverTrigger({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {
  return <PopoverPrimitive.Trigger data-slot="popover-trigger" {...props} />;
}

function PopoverContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Content>) {
  return (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        data-slot="popover-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className
        )}
        {...props}
      />
    </PopoverPrimitive.Portal>
  );
}

function PopoverAnchor({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {
  return <PopoverPrimitive.Anchor data-slot="popover-anchor" {...props} />;
}

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor };


========================================
ARQUIVO: ./client/src/components/ui/progress.tsx
========================================
import * as React from "react";
import * as ProgressPrimitive from "@radix-ui/react-progress";

import { cn } from "@/lib/utils";

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  );
}

export { Progress };


========================================
ARQUIVO: ./client/src/components/ui/radio-group.tsx
========================================
import * as React from "react";
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group";
import { CircleIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function RadioGroup({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Root>) {
  return (
    <RadioGroupPrimitive.Root
      data-slot="radio-group"
      className={cn("grid gap-3", className)}
      {...props}
    />
  );
}

function RadioGroupItem({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Item>) {
  return (
    <RadioGroupPrimitive.Item
      data-slot="radio-group-item"
      className={cn(
        "border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator
        data-slot="radio-group-indicator"
        className="relative flex items-center justify-center"
      >
        <CircleIcon className="fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  );
}

export { RadioGroup, RadioGroupItem };


========================================
ARQUIVO: ./client/src/components/ui/resizable.tsx
========================================
import * as React from "react";
import { GripVerticalIcon } from "lucide-react";
import * as ResizablePrimitive from "react-resizable-panels";

import { cn } from "@/lib/utils";

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className
      )}
      {...props}
    />
  );
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />;
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean;
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        "bg-border focus-visible:ring-ring relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:translate-x-0 data-[panel-group-direction=vertical]:after:-translate-y-1/2 [&[data-panel-group-direction=vertical]>div]:rotate-90",
        className
      )}
      {...props}
    >
      {withHandle && (
        <div className="bg-border z-10 flex h-4 w-3 items-center justify-center rounded-xs border">
          <GripVerticalIcon className="size-2.5" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  );
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle };


========================================
ARQUIVO: ./client/src/components/ui/scroll-area.tsx
========================================
import * as React from "react";
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area";

import { cn } from "@/lib/utils";

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  );
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  );
}

export { ScrollArea, ScrollBar };


========================================
ARQUIVO: ./client/src/components/ui/select.tsx
========================================
import * as React from "react";
import * as SelectPrimitive from "@radix-ui/react-select";
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />;
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />;
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />;
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default";
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  );
}

function SelectContent({
  className,
  children,
  position = "popper",
  align = "center",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        align={align}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  );
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  );
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  );
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  );
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  );
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
};


========================================
ARQUIVO: ./client/src/components/ui/separator.tsx
========================================
import * as React from "react";
import * as SeparatorPrimitive from "@radix-ui/react-separator";

import { cn } from "@/lib/utils";

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  );
}

export { Separator };


========================================
ARQUIVO: ./client/src/components/ui/sheet.tsx
========================================
"use client";

import * as React from "react";
import * as SheetPrimitive from "@radix-ui/react-dialog";
import { XIcon } from "lucide-react";

import { cn } from "@/lib/utils";

function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
  return <SheetPrimitive.Root data-slot="sheet" {...props} />;
}

function SheetTrigger({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
  return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />;
}

function SheetClose({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Close>) {
  return <SheetPrimitive.Close data-slot="sheet-close" {...props} />;
}

function SheetPortal({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Portal>) {
  return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />;
}

function SheetOverlay({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
  return (
    <SheetPrimitive.Overlay
      data-slot="sheet-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  );
}

function SheetContent({
  className,
  children,
  side = "right",
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Content> & {
  side?: "top" | "right" | "bottom" | "left";
}) {
  return (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content
        data-slot="sheet-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
          side === "right" &&
            "data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",
          side === "left" &&
            "data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",
          side === "top" &&
            "data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",
          side === "bottom" &&
            "data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",
          className
        )}
        {...props}
      >
        {children}
        <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
          <XIcon className="size-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  );
}

function SheetHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-header"
      className={cn("flex flex-col gap-1.5 p-4", className)}
      {...props}
    />
  );
}

function SheetFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  );
}

function SheetTitle({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Title>) {
  return (
    <SheetPrimitive.Title
      data-slot="sheet-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  );
}

function SheetDescription({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Description>) {
  return (
    <SheetPrimitive.Description
      data-slot="sheet-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
};


========================================
ARQUIVO: ./client/src/components/ui/sidebar.tsx
========================================
"use client";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Separator } from "@/components/ui/separator";
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from "@/components/ui/sheet";
import { Skeleton } from "@/components/ui/skeleton";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { useIsMobile } from "@/hooks/useMobile";
import { cn } from "@/lib/utils";
import { Slot } from "@radix-ui/react-slot";
import { cva, VariantProps } from "class-variance-authority";
import { PanelLeftIcon } from "lucide-react";
import * as React from "react";

const SIDEBAR_COOKIE_NAME = "sidebar_state";
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7;
const SIDEBAR_WIDTH = "16rem";
const SIDEBAR_WIDTH_MOBILE = "18rem";
const SIDEBAR_WIDTH_ICON = "3rem";
const SIDEBAR_KEYBOARD_SHORTCUT = "b";

type SidebarContextProps = {
  state: "expanded" | "collapsed";
  open: boolean;
  setOpen: (open: boolean) => void;
  openMobile: boolean;
  setOpenMobile: (open: boolean) => void;
  isMobile: boolean;
  toggleSidebar: () => void;
};

const SidebarContext = React.createContext<SidebarContextProps | null>(null);

function useSidebar() {
  const context = React.useContext(SidebarContext);
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.");
  }

  return context;
}

function SidebarProvider({
  defaultOpen = true,
  open: openProp,
  onOpenChange: setOpenProp,
  className,
  style,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  defaultOpen?: boolean;
  open?: boolean;
  onOpenChange?: (open: boolean) => void;
}) {
  const isMobile = useIsMobile();
  const [openMobile, setOpenMobile] = React.useState(false);

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen);
  const open = openProp ?? _open;
  const setOpen = React.useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      const openState = typeof value === "function" ? value(open) : value;
      if (setOpenProp) {
        setOpenProp(openState);
      } else {
        _setOpen(openState);
      }

      // This sets the cookie to keep the sidebar state.
      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`;
    },
    [setOpenProp, open]
  );

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile ? setOpenMobile(open => !open) : setOpen(open => !open);
  }, [isMobile, setOpen, setOpenMobile]);

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (
        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
        (event.metaKey || event.ctrlKey)
      ) {
        event.preventDefault();
        toggleSidebar();
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [toggleSidebar]);

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? "expanded" : "collapsed";

  const contextValue = React.useMemo<SidebarContextProps>(
    () => ({
      state,
      open,
      setOpen,
      isMobile,
      openMobile,
      setOpenMobile,
      toggleSidebar,
    }),
    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
  );

  return (
    <SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          data-slot="sidebar-wrapper"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH,
              "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
              ...style,
            } as React.CSSProperties
          }
          className={cn(
            "group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full",
            className
          )}
          {...props}
        >
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>
  );
}

function Sidebar({
  side = "left",
  variant = "sidebar",
  collapsible = "offcanvas",
  disableTransition = false,
  className,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  side?: "left" | "right";
  variant?: "sidebar" | "floating" | "inset";
  collapsible?: "offcanvas" | "icon" | "none";
  disableTransition?: boolean;
}) {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar();

  if (collapsible === "none") {
    return (
      <div
        data-slot="sidebar"
        className={cn(
          "bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col",
          className
        )}
        {...props}
      >
        {children}
      </div>
    );
  }

  if (isMobile) {
    return (
      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-slot="sidebar"
          data-mobile="true"
          className="bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
            } as React.CSSProperties
          }
          side={side}
        >
          <SheetHeader className="sr-only">
            <SheetTitle>Sidebar</SheetTitle>
            <SheetDescription>Displays the mobile sidebar.</SheetDescription>
          </SheetHeader>
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>
    );
  }

  return (
    <div
      className="group peer text-sidebar-foreground hidden md:block"
      data-state={state}
      data-collapsible={state === "collapsed" ? collapsible : ""}
      data-variant={variant}
      data-side={side}
      data-slot="sidebar"
    >
      {/* This is what handles the sidebar gap on desktop */}
      <div
        data-slot="sidebar-gap"
        className={cn(
          "relative w-(--sidebar-width) bg-transparent",
          disableTransition
            ? "transition-none"
            : "transition-[width] duration-200 ease-linear",
          "group-data-[collapsible=offcanvas]:w-0",
          "group-data-[side=right]:rotate-180",
          variant === "floating" || variant === "inset"
            ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4)))]"
            : "group-data-[collapsible=icon]:w-(--sidebar-width-icon)"
        )}
      />
      <div
        data-slot="sidebar-container"
        className={cn(
          "fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) md:flex",
          disableTransition
            ? "transition-none"
            : "transition-[left,right,width] duration-200 ease-linear",
          side === "left"
            ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
            : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
          // Adjust the padding for floating and inset variants.
          variant === "floating" || variant === "inset"
            ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4))+2px)]"
            : "group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l",
          className
        )}
        {...props}
      >
        <div
          data-sidebar="sidebar"
          data-slot="sidebar-inner"
          className="bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm"
        >
          {children}
        </div>
      </div>
    </div>
  );
}

function SidebarTrigger({
  className,
  onClick,
  ...props
}: React.ComponentProps<typeof Button>) {
  const { toggleSidebar } = useSidebar();

  return (
    <Button
      data-sidebar="trigger"
      data-slot="sidebar-trigger"
      variant="ghost"
      size="icon"
      className={cn("size-7", className)}
      onClick={event => {
        onClick?.(event);
        toggleSidebar();
      }}
      {...props}
    >
      <PanelLeftIcon />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  );
}

function SidebarRail({ className, ...props }: React.ComponentProps<"button">) {
  const { toggleSidebar } = useSidebar();

  return (
    <button
      data-sidebar="rail"
      data-slot="sidebar-rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex",
        "in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props}
    />
  );
}

function SidebarInset({ className, ...props }: React.ComponentProps<"main">) {
  return (
    <main
      data-slot="sidebar-inset"
      className={cn(
        "bg-background relative flex w-full flex-1 flex-col",
        "md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2",
        className
      )}
      {...props}
    />
  );
}

function SidebarInput({
  className,
  ...props
}: React.ComponentProps<typeof Input>) {
  return (
    <Input
      data-slot="sidebar-input"
      data-sidebar="input"
      className={cn("bg-background h-8 w-full shadow-none", className)}
      {...props}
    />
  );
}

function SidebarHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-header"
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  );
}

function SidebarFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-footer"
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  );
}

function SidebarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="sidebar-separator"
      data-sidebar="separator"
      className={cn("bg-sidebar-border mx-2 w-auto", className)}
      {...props}
    />
  );
}

function SidebarContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-content"
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props}
    />
  );
}

function SidebarGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group"
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  );
}

function SidebarGroupLabel({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"div"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "div";

  return (
    <Comp
      data-slot="sidebar-group-label"
      data-sidebar="group-label"
      className={cn(
        "text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props}
    />
  );
}

function SidebarGroupAction({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      data-slot="sidebar-group-action"
      data-sidebar="group-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  );
}

function SidebarGroupContent({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group-content"
      data-sidebar="group-content"
      className={cn("w-full text-sm", className)}
      {...props}
    />
  );
}

function SidebarMenu({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu"
      data-sidebar="menu"
      className={cn("flex w-full min-w-0 flex-col gap-1", className)}
      {...props}
    />
  );
}

function SidebarMenuItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-item"
      data-sidebar="menu-item"
      className={cn("group/menu-item relative", className)}
      {...props}
    />
  );
}

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:p-0!",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
);

function SidebarMenuButton({
  asChild = false,
  isActive = false,
  variant = "default",
  size = "default",
  tooltip,
  className,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean;
  isActive?: boolean;
  tooltip?: string | React.ComponentProps<typeof TooltipContent>;
} & VariantProps<typeof sidebarMenuButtonVariants>) {
  const Comp = asChild ? Slot : "button";
  const { isMobile, state } = useSidebar();

  const button = (
    <Comp
      data-slot="sidebar-menu-button"
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props}
    />
  );

  if (!tooltip) {
    return button;
  }

  if (typeof tooltip === "string") {
    tooltip = {
      children: tooltip,
    };
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent
        side="right"
        align="center"
        hidden={state !== "collapsed" || isMobile}
        {...tooltip}
      />
    </Tooltip>
  );
}

function SidebarMenuAction({
  className,
  asChild = false,
  showOnHover = false,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean;
  showOnHover?: boolean;
}) {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      data-slot="sidebar-menu-action"
      data-sidebar="menu-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0",
        className
      )}
      {...props}
    />
  );
}

function SidebarMenuBadge({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-menu-badge"
      data-sidebar="menu-badge"
      className={cn(
        "text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none",
        "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  );
}

function SidebarMenuSkeleton({
  className,
  showIcon = false,
  ...props
}: React.ComponentProps<"div"> & {
  showIcon?: boolean;
}) {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`;
  }, []);

  return (
    <div
      data-slot="sidebar-menu-skeleton"
      data-sidebar="menu-skeleton"
      className={cn("flex h-8 items-center gap-2 rounded-md px-2", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 max-w-(--skeleton-width) flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  );
}

function SidebarMenuSub({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu-sub"
      data-sidebar="menu-sub"
      className={cn(
        "border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  );
}

function SidebarMenuSubItem({
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-sub-item"
      data-sidebar="menu-sub-item"
      className={cn("group/menu-sub-item relative", className)}
      {...props}
    />
  );
}

function SidebarMenuSubButton({
  asChild = false,
  size = "md",
  isActive = false,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean;
  size?: "sm" | "md";
  isActive?: boolean;
}) {
  const Comp = asChild ? Slot : "a";

  return (
    <Comp
      data-slot="sidebar-menu-sub-button"
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline-hidden focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  );
}

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar
};



========================================
ARQUIVO: ./client/src/components/ui/skeleton.tsx
========================================
import { cn } from "@/lib/utils";

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  );
}

export { Skeleton };


========================================
ARQUIVO: ./client/src/components/ui/slider.tsx
========================================
import * as React from "react";
import * as SliderPrimitive from "@radix-ui/react-slider";

import { cn } from "@/lib/utils";

function Slider({
  className,
  defaultValue,
  value,
  min = 0,
  max = 100,
  ...props
}: React.ComponentProps<typeof SliderPrimitive.Root>) {
  const _values = React.useMemo(
    () =>
      Array.isArray(value)
        ? value
        : Array.isArray(defaultValue)
          ? defaultValue
          : [min, max],
    [value, defaultValue, min, max]
  );

  return (
    <SliderPrimitive.Root
      data-slot="slider"
      defaultValue={defaultValue}
      value={value}
      min={min}
      max={max}
      className={cn(
        "relative flex w-full touch-none items-center select-none data-[disabled]:opacity-50 data-[orientation=vertical]:h-full data-[orientation=vertical]:min-h-44 data-[orientation=vertical]:w-auto data-[orientation=vertical]:flex-col",
        className
      )}
      {...props}
    >
      <SliderPrimitive.Track
        data-slot="slider-track"
        className={cn(
          "bg-muted relative grow overflow-hidden rounded-full data-[orientation=horizontal]:h-1.5 data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-1.5"
        )}
      >
        <SliderPrimitive.Range
          data-slot="slider-range"
          className={cn(
            "bg-primary absolute data-[orientation=horizontal]:h-full data-[orientation=vertical]:w-full"
          )}
        />
      </SliderPrimitive.Track>
      {Array.from({ length: _values.length }, (_, index) => (
        <SliderPrimitive.Thumb
          data-slot="slider-thumb"
          key={index}
          className="border-primary ring-ring/50 block size-4 shrink-0 rounded-full border bg-white shadow-sm transition-[color,box-shadow] hover:ring-4 focus-visible:ring-4 focus-visible:outline-hidden disabled:pointer-events-none disabled:opacity-50"
        />
      ))}
    </SliderPrimitive.Root>
  );
}

export { Slider };


========================================
ARQUIVO: ./client/src/components/ui/sonner.tsx
========================================
import { useTheme } from "next-themes";
import { Toaster as Sonner, type ToasterProps } from "sonner";

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme();

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  );
};

export { Toaster };


========================================
ARQUIVO: ./client/src/components/ui/spinner.tsx
========================================
import { Loader2Icon } from "lucide-react";

import { cn } from "@/lib/utils";

function Spinner({ className, ...props }: React.ComponentProps<"svg">) {
  return (
    <Loader2Icon
      role="status"
      aria-label="Loading"
      className={cn("size-4 animate-spin", className)}
      {...props}
    />
  );
}

export { Spinner };


========================================
ARQUIVO: ./client/src/components/ui/switch.tsx
========================================
import * as React from "react";
import * as SwitchPrimitive from "@radix-ui/react-switch";

import { cn } from "@/lib/utils";

function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        "peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={cn(
          "bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0"
        )}
      />
    </SwitchPrimitive.Root>
  );
}

export { Switch };


========================================
ARQUIVO: ./client/src/components/ui/table.tsx
========================================
import * as React from "react";

import { cn } from "@/lib/utils";

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  );
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  );
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  );
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  );
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  );
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  );
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  );
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  );
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
};


========================================
ARQUIVO: ./client/src/components/ui/tabs.tsx
========================================
import * as React from "react";
import * as TabsPrimitive from "@radix-ui/react-tabs";

import { cn } from "@/lib/utils";

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  );
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",
        className
      )}
      {...props}
    />
  );
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  );
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  );
}

export { Tabs, TabsList, TabsTrigger, TabsContent };


========================================
ARQUIVO: ./client/src/components/ui/textarea.tsx
========================================
import { useDialogComposition } from "@/components/ui/dialog";
import { useComposition } from "@/hooks/useComposition";
import { cn } from "@/lib/utils";
import * as React from "react";

function Textarea({
  className,
  onKeyDown,
  onCompositionStart,
  onCompositionEnd,
  ...props
}: React.ComponentProps<"textarea">) {
  // Get dialog composition context if available (will be no-op if not inside Dialog)
  const dialogComposition = useDialogComposition();

  // Add composition event handlers to support input method editor (IME) for CJK languages.
  const {
    onCompositionStart: handleCompositionStart,
    onCompositionEnd: handleCompositionEnd,
    onKeyDown: handleKeyDown,
  } = useComposition<HTMLTextAreaElement>({
    onKeyDown: (e) => {
      // Check if this is an Enter key that should be blocked
      const isComposing = (e.nativeEvent as any).isComposing || dialogComposition.justEndedComposing();

      // If Enter key is pressed while composing or just after composition ended,
      // don't call the user's onKeyDown (this blocks the business logic)
      // Note: For textarea, Shift+Enter should still work for newlines
      if (e.key === "Enter" && !e.shiftKey && isComposing) {
        return;
      }

      // Otherwise, call the user's onKeyDown
      onKeyDown?.(e);
    },
    onCompositionStart: e => {
      dialogComposition.setComposing(true);
      onCompositionStart?.(e);
    },
    onCompositionEnd: e => {
      // Mark that composition just ended - this helps handle the Enter key that confirms input
      dialogComposition.markCompositionEnd();
      // Delay setting composing to false to handle Safari's event order
      // In Safari, compositionEnd fires before the ESC keydown event
      setTimeout(() => {
        dialogComposition.setComposing(false);
      }, 100);
      onCompositionEnd?.(e);
    },
  });

  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      onCompositionStart={handleCompositionStart}
      onCompositionEnd={handleCompositionEnd}
      onKeyDown={handleKeyDown}
      {...props}
    />
  );
}

export { Textarea };


========================================
ARQUIVO: ./client/src/components/ui/toggle-group.tsx
========================================
"use client";

import * as React from "react";
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group";
import { type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";
import { toggleVariants } from "@/components/ui/toggle";

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
});

function ToggleGroup({
  className,
  variant,
  size,
  children,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <ToggleGroupPrimitive.Root
      data-slot="toggle-group"
      data-variant={variant}
      data-size={size}
      className={cn(
        "group/toggle-group flex w-fit items-center rounded-md data-[variant=outline]:shadow-xs",
        className
      )}
      {...props}
    >
      <ToggleGroupContext.Provider value={{ variant, size }}>
        {children}
      </ToggleGroupContext.Provider>
    </ToggleGroupPrimitive.Root>
  );
}

function ToggleGroupItem({
  className,
  children,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Item> &
  VariantProps<typeof toggleVariants>) {
  const context = React.useContext(ToggleGroupContext);

  return (
    <ToggleGroupPrimitive.Item
      data-slot="toggle-group-item"
      data-variant={context.variant || variant}
      data-size={context.size || size}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        "min-w-0 flex-1 shrink-0 rounded-none shadow-none first:rounded-l-md last:rounded-r-md focus:z-10 focus-visible:z-10 data-[variant=outline]:border-l-0 data-[variant=outline]:first:border-l",
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  );
}

export { ToggleGroup, ToggleGroupItem };


========================================
ARQUIVO: ./client/src/components/ui/toggle.tsx
========================================
import * as React from "react";
import * as TogglePrimitive from "@radix-ui/react-toggle";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium hover:bg-muted hover:text-muted-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] outline-none transition-[color,box-shadow] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive whitespace-nowrap",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent shadow-xs hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-2 min-w-9",
        sm: "h-8 px-1.5 min-w-8",
        lg: "h-10 px-2.5 min-w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
);

function Toggle({
  className,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof TogglePrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <TogglePrimitive.Root
      data-slot="toggle"
      className={cn(toggleVariants({ variant, size, className }))}
      {...props}
    />
  );
}

export { Toggle, toggleVariants };


========================================
ARQUIVO: ./client/src/components/ui/tooltip.tsx
========================================
import * as React from "react";
import * as TooltipPrimitive from "@radix-ui/react-tooltip";

import { cn } from "@/lib/utils";

function TooltipProvider({
  delayDuration = 0,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return (
    <TooltipPrimitive.Provider
      data-slot="tooltip-provider"
      delayDuration={delayDuration}
      {...props}
    />
  );
}

function Tooltip({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return (
    <TooltipProvider>
      <TooltipPrimitive.Root data-slot="tooltip" {...props} />
    </TooltipProvider>
  );
}

function TooltipTrigger({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />;
}

function TooltipContent({
  className,
  sideOffset = 0,
  children,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-foreground text-background animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",
          className
        )}
        {...props}
      >
        {children}
        <TooltipPrimitive.Arrow className="bg-foreground fill-foreground z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]" />
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  );
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider };


========================================
ARQUIVO: ./client/src/components/GlobalSearch.tsx
========================================
import { useState, useEffect } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Search, User, Target, FileText, TrendingUp, Calendar } from "lucide-react";
import { useLocation } from "wouter";

interface SearchResult {
  type: "employee" | "goal" | "evaluation" | "pdi" | "activity" | "page";
  title: string;
  subtitle?: string;
  url: string;
  icon: React.ReactNode;
}

interface GlobalSearchProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function GlobalSearch({ open, onOpenChange }: GlobalSearchProps) {
  const [query, setQuery] = useState("");
  const [results, setResults] = useState<SearchResult[]>([]);
  const [, setLocation] = useLocation();

  // Simular busca (em produÃ§Ã£o, usar tRPC query)
  useEffect(() => {
    if (!query.trim()) {
      setResults([]);
      return;
    }

    const mockResults: SearchResult[] = [
      // PÃ¡ginas do sistema
      {
        type: "page",
        title: "Dashboard",
        subtitle: "VisÃ£o geral do sistema",
        url: "/",
        icon: <TrendingUp className="h-4 w-4" />,
      },
      {
        type: "page",
        title: "Metas",
        subtitle: "Gerenciar metas",
        url: "/metas",
        icon: <Target className="h-4 w-4" />,
      },
      {
        type: "page",
        title: "AvaliaÃ§Ãµes",
        subtitle: "AvaliaÃ§Ãµes de desempenho",
        url: "/avaliacoes",
        icon: <FileText className="h-4 w-4" />,
      },
      {
        type: "page",
        title: "PDI",
        subtitle: "Plano de Desenvolvimento Individual",
        url: "/pdi",
        icon: <TrendingUp className="h-4 w-4" />,
      },
      {
        type: "page",
        title: "Minhas Atividades",
        subtitle: "Registro de atividades",
        url: "/minhas-atividades",
        icon: <Calendar className="h-4 w-4" />,
      },
      {
        type: "page",
        title: "Alertas",
        subtitle: "Central de alertas",
        url: "/alertas",
        icon: <Target className="h-4 w-4" />,
      },
      {
        type: "page",
        title: "DiscrepÃ¢ncias",
        subtitle: "AnÃ¡lise de discrepÃ¢ncias de ponto",
        url: "/discrepancias",
        icon: <FileText className="h-4 w-4" />,
      },
      {
        type: "page",
        title: "ImportaÃ§Ã£o de Ponto",
        subtitle: "Upload de registros de ponto",
        url: "/importacao-ponto",
        icon: <Calendar className="h-4 w-4" />,
      },
    ];

    const filtered = mockResults.filter(
      (r) =>
        r.title.toLowerCase().includes(query.toLowerCase()) ||
        r.subtitle?.toLowerCase().includes(query.toLowerCase())
    );

    setResults(filtered);
  }, [query]);

  const handleSelect = (result: SearchResult) => {
    setLocation(result.url);
    onOpenChange(false);
    setQuery("");
  };

  const getTypeLabel = (type: string) => {
    const labels: Record<string, string> = {
      employee: "Colaborador",
      goal: "Meta",
      evaluation: "AvaliaÃ§Ã£o",
      pdi: "PDI",
      activity: "Atividade",
      page: "PÃ¡gina",
    };
    return labels[type] || type;
  };

  const getTypeColor = (type: string) => {
    const colors: Record<string, string> = {
      employee: "bg-blue-100 text-blue-800",
      goal: "bg-green-100 text-green-800",
      evaluation: "bg-purple-100 text-purple-800",
      pdi: "bg-orange-100 text-orange-800",
      activity: "bg-yellow-100 text-yellow-800",
      page: "bg-gray-100 text-gray-800",
    };
    return colors[type] || "bg-gray-100 text-gray-800";
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Busca Global</DialogTitle>
        </DialogHeader>
        <div className="space-y-4">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Buscar colaboradores, metas, avaliaÃ§Ãµes, pÃ¡ginas..."
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              className="pl-10"
              autoFocus
            />
          </div>

          {query && results.length === 0 && (
            <div className="text-center py-8 text-muted-foreground">
              Nenhum resultado encontrado
            </div>
          )}

          {results.length > 0 && (
            <div className="max-h-96 overflow-y-auto space-y-2">
              {results.map((result, idx) => (
                <button
                  key={idx}
                  onClick={() => handleSelect(result)}
                  className="w-full text-left p-3 rounded-lg hover:bg-accent transition-colors flex items-start gap-3"
                >
                  <div className="mt-1">{result.icon}</div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="font-medium truncate">{result.title}</span>
                      <Badge variant="outline" className={`text-xs ${getTypeColor(result.type)}`}>
                        {getTypeLabel(result.type)}
                      </Badge>
                    </div>
                    {result.subtitle && (
                      <p className="text-sm text-muted-foreground truncate">{result.subtitle}</p>
                    )}
                  </div>
                </button>
              ))}
            </div>
          )}

          {!query && (
            <div className="text-sm text-muted-foreground">
              <p className="mb-2">Dica: Use atalhos de teclado</p>
              <ul className="space-y-1">
                <li>â€¢ <kbd className="px-2 py-1 bg-muted rounded">Ctrl+K</kbd> ou <kbd className="px-2 py-1 bg-muted rounded">Cmd+K</kbd> - Abrir busca</li>
                <li>â€¢ <kbd className="px-2 py-1 bg-muted rounded">Esc</kbd> - Fechar busca</li>
              </ul>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}

// Hook para atalho de teclado
export function useGlobalSearchShortcut(onOpen: () => void) {
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        onOpen();
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [onOpen]);
}


========================================
ARQUIVO: ./client/src/components/Breadcrumbs.tsx
========================================
import { Link, useLocation } from "wouter";
import { ChevronRight, Home } from "lucide-react";

interface BreadcrumbItem {
  label: string;
  href: string;
}

export function Breadcrumbs() {
  const [location] = useLocation();

  const getBreadcrumbs = (): BreadcrumbItem[] => {
    const pathSegments = location.split("/").filter(Boolean);
    
    const breadcrumbs: BreadcrumbItem[] = [
      { label: "InÃ­cio", href: "/" },
    ];

    // Mapeamento de rotas para labels legÃ­veis
    const routeLabels: Record<string, string> = {
      "metas": "Metas",
      "avaliacoes": "AvaliaÃ§Ãµes",
      "pdi": "PDI",
      "minhas-atividades": "Minhas Atividades",
      "relatorios-produtividade": "RelatÃ³rios de Produtividade",
      "alertas": "Alertas",
      "discrepancias": "DiscrepÃ¢ncias",
      "importacao-ponto": "ImportaÃ§Ã£o de Ponto",
      "descricao-cargos-uisa": "DescriÃ§Ã£o de Cargos UISA",
      "validacao-lider": "ValidaÃ§Ã£o do LÃ­der",
      "analise-gaps": "AnÃ¡lise de Gaps",
      "importacao-descricoes": "ImportaÃ§Ã£o de DescriÃ§Ãµes",
      "pesquisas-pulse": "Pesquisas Pulse",
      "dashboard-executivo": "Dashboard Executivo",
      "analytics-rh": "Analytics de RH",
      "performance-integrada": "Performance Integrada",
      "avaliacao-360": "AvaliaÃ§Ã£o 360Â°",
      "360-enhanced": "360Â° Enhanced",
      "calibracao": "CalibraÃ§Ã£o",
      "nine-box": "Nine Box",
      "nine-box-comparativo": "Nine Box Comparativo",
      "pdi-inteligente": "PDI Inteligente",
      "mapa-sucessao": "Mapa de SucessÃ£o",
      "trilhas-desenvolvimento": "Trilhas de Desenvolvimento",
    };

    let currentPath = "";
    pathSegments.forEach((segment, index) => {
      currentPath += `/${segment}`;
      
      // Pular IDs numÃ©ricos
      if (/^\d+$/.test(segment)) {
        breadcrumbs.push({
          label: `#${segment}`,
          href: currentPath,
        });
        return;
      }

      // Pular aÃ§Ãµes como "criar", "editar"
      if (["criar", "editar", "detalhes"].includes(segment)) {
        const actionLabels: Record<string, string> = {
          "criar": "Criar",
          "editar": "Editar",
          "detalhes": "Detalhes",
        };
        breadcrumbs.push({
          label: actionLabels[segment] || segment,
          href: currentPath,
        });
        return;
      }

      breadcrumbs.push({
        label: routeLabels[segment] || segment.split("-").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" "),
        href: currentPath,
      });
    });

    return breadcrumbs;
  };

  const breadcrumbs = getBreadcrumbs();

  if (breadcrumbs.length <= 1) {
    return null;
  }

  return (
    <nav className="flex items-center space-x-2 text-sm text-muted-foreground mb-6">
      {breadcrumbs.map((crumb, index) => (
        <div key={crumb.href} className="flex items-center">
          {index > 0 && <ChevronRight className="h-4 w-4 mx-2" />}
          {index === 0 && <Home className="h-4 w-4 mr-2" />}
          {index === breadcrumbs.length - 1 ? (
            <span className="font-medium text-foreground">{crumb.label}</span>
          ) : (
            <Link href={crumb.href} className="hover:text-foreground transition-colors">
              {crumb.label}
            </Link>
          )}
        </div>
      ))}
    </nav>
  );
}


========================================
ARQUIVO: ./client/src/const.ts
========================================
export { COOKIE_NAME, ONE_YEAR_MS } from "@shared/const";

export const APP_TITLE = import.meta.env.VITE_APP_TITLE || "Sistema AVD UISA";

export const APP_LOGO = "https://placehold.co/128x128/2563EB/FFFFFF?text=AVD";

// Generate login URL at runtime so redirect URI reflects the current origin.
export const getLoginUrl = () => {
  const oauthPortalUrl = import.meta.env.VITE_OAUTH_PORTAL_URL;
  const appId = import.meta.env.VITE_APP_ID;
  const redirectUri = `${window.location.origin}/api/oauth/callback`;
  const state = btoa(redirectUri);

  const url = new URL(`${oauthPortalUrl}/app-auth`);
  url.searchParams.set("appId", appId);
  url.searchParams.set("redirectUri", redirectUri);
  url.searchParams.set("state", state);
  url.searchParams.set("type", "signIn");

  return url.toString();
};


========================================
ARQUIVO: ./client/src/contexts/NotificationContext.tsx
========================================
import { createContext, useContext, useEffect, useState, ReactNode } from "react";
import { io, Socket } from "socket.io-client";
import { toast } from "sonner";
import { useAuth } from "@/_core/hooks/useAuth";

interface Notification {
  id: string;
  type: "meta" | "avaliacao" | "pdi" | "feedback" | "prazo";
  title: string;
  message: string;
  timestamp: Date;
  read: boolean;
  link?: string;
}

interface NotificationContextType {
  notifications: Notification[];
  unreadCount: number;
  markAsRead: (id: string) => void;
  markAllAsRead: () => void;
  clearNotifications: () => void;
}

const NotificationContext = createContext<NotificationContextType | undefined>(undefined);

export function NotificationProvider({ children }: { children: ReactNode }) {
  const { user } = useAuth();
  const [socket, setSocket] = useState<Socket | null>(null);
  const [notifications, setNotifications] = useState<Notification[]>([]);

  useEffect(() => {
    if (!user) return;

    // Conectar ao WebSocket
    const newSocket = io(window.location.origin, {
      auth: {
        userId: user.id,
      },
    });

    newSocket.on("connect", () => {
      console.log("WebSocket conectado");
    });

    newSocket.on("notification", (data: Omit<Notification, "id" | "read" | "timestamp">) => {
      const notification: Notification = {
        ...data,
        id: Math.random().toString(36).substr(2, 9),
        timestamp: new Date(),
        read: false,
      };

      setNotifications((prev) => [notification, ...prev]);

      // Mostrar toast
      toast(notification.title, {
        description: notification.message,
        action: notification.link ? {
          label: "Ver",
          onClick: () => window.location.href = notification.link!,
        } : undefined,
      });
    });

    newSocket.on("disconnect", () => {
      console.log("WebSocket desconectado");
    });

    setSocket(newSocket);

    return () => {
      newSocket.close();
    };
  }, [user]);

  const markAsRead = (id: string) => {
    setNotifications((prev) =>
      prev.map((n) => (n.id === id ? { ...n, read: true } : n))
    );
  };

  const markAllAsRead = () => {
    setNotifications((prev) => prev.map((n) => ({ ...n, read: true })));
  };

  const clearNotifications = () => {
    setNotifications([]);
  };

  const unreadCount = notifications.filter((n) => !n.read).length;

  return (
    <NotificationContext.Provider
      value={{
        notifications,
        unreadCount,
        markAsRead,
        markAllAsRead,
        clearNotifications,
      }}
    >
      {children}
    </NotificationContext.Provider>
  );
}

export function useNotifications() {
  const context = useContext(NotificationContext);
  if (context === undefined) {
    throw new Error("useNotifications must be used within a NotificationProvider");
  }
  return context;
}


========================================
ARQUIVO: ./client/src/contexts/ThemeContext.tsx
========================================
import React, { createContext, useContext, useEffect, useState } from "react";

type Theme = "light" | "dark";

interface ThemeContextType {
  theme: Theme;
  toggleTheme?: () => void;
  switchable: boolean;
}

const ThemeContext = createContext<ThemeContextType | undefined>(undefined);

interface ThemeProviderProps {
  children: React.ReactNode;
  defaultTheme?: Theme;
  switchable?: boolean;
}

export function ThemeProvider({
  children,
  defaultTheme = "light",
  switchable = false,
}: ThemeProviderProps) {
  const [theme, setTheme] = useState<Theme>(() => {
    if (switchable) {
      const stored = localStorage.getItem("theme");
      return (stored as Theme) || defaultTheme;
    }
    return defaultTheme;
  });

  useEffect(() => {
    const root = document.documentElement;
    if (theme === "dark") {
      root.classList.add("dark");
    } else {
      root.classList.remove("dark");
    }

    if (switchable) {
      localStorage.setItem("theme", theme);
    }
  }, [theme, switchable]);

  const toggleTheme = switchable
    ? () => {
        setTheme(prev => (prev === "light" ? "dark" : "light"));
      }
    : undefined;

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme, switchable }}>
      {children}
    </ThemeContext.Provider>
  );
}

export function useTheme() {
  const context = useContext(ThemeContext);
  if (!context) {
    throw new Error("useTheme must be used within ThemeProvider");
  }
  return context;
}


========================================
ARQUIVO: ./client/src/hooks/useComposition.ts
========================================
import { useRef } from "react";
import { usePersistFn } from "./usePersistFn";

export interface UseCompositionReturn<
  T extends HTMLInputElement | HTMLTextAreaElement,
> {
  onCompositionStart: React.CompositionEventHandler<T>;
  onCompositionEnd: React.CompositionEventHandler<T>;
  onKeyDown: React.KeyboardEventHandler<T>;
  isComposing: () => boolean;
}

export interface UseCompositionOptions<
  T extends HTMLInputElement | HTMLTextAreaElement,
> {
  onKeyDown?: React.KeyboardEventHandler<T>;
  onCompositionStart?: React.CompositionEventHandler<T>;
  onCompositionEnd?: React.CompositionEventHandler<T>;
}

type TimerResponse = ReturnType<typeof setTimeout>;

export function useComposition<
  T extends HTMLInputElement | HTMLTextAreaElement = HTMLInputElement,
>(options: UseCompositionOptions<T> = {}): UseCompositionReturn<T> {
  const {
    onKeyDown: originalOnKeyDown,
    onCompositionStart: originalOnCompositionStart,
    onCompositionEnd: originalOnCompositionEnd,
  } = options;

  const c = useRef(false);
  const timer = useRef<TimerResponse | null>(null);
  const timer2 = useRef<TimerResponse | null>(null);

  const onCompositionStart = usePersistFn((e: React.CompositionEvent<T>) => {
    if (timer.current) {
      clearTimeout(timer.current);
      timer.current = null;
    }
    if (timer2.current) {
      clearTimeout(timer2.current);
      timer2.current = null;
    }
    c.current = true;
    originalOnCompositionStart?.(e);
  });

  const onCompositionEnd = usePersistFn((e: React.CompositionEvent<T>) => {
    // ä½¿ç”¨ä¸¤å±‚ setTimeout æ¥å¤„ç† Safari æµè§ˆå™¨ä¸­ compositionEnd å…ˆäºŽ onKeyDown è§¦å‘çš„é—®é¢˜
    timer.current = setTimeout(() => {
      timer2.current = setTimeout(() => {
        c.current = false;
      });
    });
    originalOnCompositionEnd?.(e);
  });

  const onKeyDown = usePersistFn((e: React.KeyboardEvent<T>) => {
    // åœ¨ composition çŠ¶æ€ä¸‹ï¼Œé˜»æ­¢ ESC å’Œ Enterï¼ˆéž shift+Enterï¼‰äº‹ä»¶çš„å†’æ³¡
    if (
      c.current &&
      (e.key === "Escape" || (e.key === "Enter" && !e.shiftKey))
    ) {
      e.stopPropagation();
      return;
    }
    originalOnKeyDown?.(e);
  });

  const isComposing = usePersistFn(() => {
    return c.current;
  });

  return {
    onCompositionStart,
    onCompositionEnd,
    onKeyDown,
    isComposing,
  };
}


========================================
ARQUIVO: ./client/src/hooks/useMobile.tsx
========================================
import * as React from "react";

const MOBILE_BREAKPOINT = 768;

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(
    undefined
  );

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`);
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    };
    mql.addEventListener("change", onChange);
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    return () => mql.removeEventListener("change", onChange);
  }, []);

  return !!isMobile;
}


========================================
ARQUIVO: ./client/src/hooks/usePersistFn.ts
========================================
import { useRef } from "react";

type noop = (...args: any[]) => any;

/**
 * usePersistFn instead of useCallback to reduce cognitive load
 */
export function usePersistFn<T extends noop>(fn: T) {
  const fnRef = useRef<T>(fn);
  fnRef.current = fn;

  const persistFn = useRef<T>(null);
  if (!persistFn.current) {
    persistFn.current = function (this: unknown, ...args) {
      return fnRef.current!.apply(this, args);
    } as T;
  }

  return persistFn.current!;
}


========================================
ARQUIVO: ./client/src/lib/currency.ts
========================================
/**
 * UtilitÃ¡rios para formataÃ§Ã£o monetÃ¡ria em Real Brasileiro (R$)
 */

/**
 * Formata um nÃºmero como moeda brasileira (R$)
 * @param value - Valor numÃ©rico a ser formatado
 * @returns String formatada como R$ 1.234,56
 */
export function formatCurrency(value: number | string | null | undefined): string {
  if (value === null || value === undefined || value === '') {
    return 'R$ 0,00';
  }

  const numValue = typeof value === 'string' ? parseFloat(value) : value;

  if (isNaN(numValue)) {
    return 'R$ 0,00';
  }

  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  }).format(numValue);
}

/**
 * Remove formataÃ§Ã£o de moeda e retorna nÃºmero
 * @param formatted - String formatada como R$ 1.234,56
 * @returns NÃºmero decimal
 */
export function parseCurrency(formatted: string): number {
  if (!formatted) return 0;

  // Remove R$, espaÃ§os, pontos (separador de milhar) e substitui vÃ­rgula por ponto
  const cleaned = formatted
    .replace(/R\$\s?/g, '')
    .replace(/\./g, '')
    .replace(',', '.');

  const value = parseFloat(cleaned);
  return isNaN(value) ? 0 : value;
}

/**
 * Formata input de moeda enquanto o usuÃ¡rio digita
 * @param value - Valor atual do input
 * @returns Valor formatado
 */
export function formatCurrencyInput(value: string): string {
  // Remove tudo exceto nÃºmeros
  const numbers = value.replace(/\D/g, '');

  if (!numbers) return '';

  // Converte para centavos
  const cents = parseInt(numbers, 10);

  // Formata como moeda
  return formatCurrency(cents / 100);
}


========================================
ARQUIVO: ./client/src/lib/exportPDF.ts
========================================
import jsPDF from "jspdf";
import html2canvas from "html2canvas";

/**
 * UtilitÃ¡rio de ExportaÃ§Ã£o de RelatÃ³rios em PDF
 * 
 * FunÃ§Ãµes para exportar pÃ¡ginas do sistema em PDF com:
 * - Logo UISA
 * - CabeÃ§alho e rodapÃ©
 * - Data de geraÃ§Ã£o
 * - GrÃ¡ficos (Recharts, Chart.js)
 */

interface ExportPDFOptions {
  filename: string;
  title: string;
  subtitle?: string;
  elementId: string;
  orientation?: "portrait" | "landscape";
}

/**
 * Exporta um elemento HTML para PDF
 */
export async function exportToPDF(options: ExportPDFOptions): Promise<void> {
  const {
    filename,
    title,
    subtitle,
    elementId,
    orientation = "portrait",
  } = options;

  try {
    // Buscar elemento
    const element = document.getElementById(elementId);
    if (!element) {
      throw new Error(`Elemento ${elementId} nÃ£o encontrado`);
    }

    // Capturar elemento como imagem
    const canvas = await html2canvas(element, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: "#ffffff",
    });

    // Criar PDF
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF({
      orientation,
      unit: "mm",
      format: "a4",
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    // Adicionar cabeÃ§alho
    addHeader(pdf, title, subtitle);

    // Calcular dimensÃµes da imagem
    const imgWidth = pageWidth - 20; // Margem de 10mm de cada lado
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    // Adicionar imagem (comeÃ§ando abaixo do cabeÃ§alho)
    const startY = 35;
    let currentY = startY;

    // Se a imagem Ã© maior que uma pÃ¡gina, dividir em mÃºltiplas pÃ¡ginas
    if (imgHeight > pageHeight - startY - 20) {
      let remainingHeight = imgHeight;
      let sourceY = 0;

      while (remainingHeight > 0) {
        const pageContentHeight = pageHeight - startY - 20;
        const sourceHeight = (canvas.height * pageContentHeight) / imgHeight;

        pdf.addImage(
          imgData,
          "PNG",
          10,
          currentY,
          imgWidth,
          Math.min(remainingHeight, pageContentHeight)
        );

        remainingHeight -= pageContentHeight;
        sourceY += sourceHeight;

        if (remainingHeight > 0) {
          pdf.addPage();
          addHeader(pdf, title, subtitle);
          currentY = startY;
        }

        addFooter(pdf);
      }
    } else {
      // Imagem cabe em uma pÃ¡gina
      pdf.addImage(imgData, "PNG", 10, currentY, imgWidth, imgHeight);
      addFooter(pdf);
    }

    // Salvar PDF
    pdf.save(filename);
  } catch (error) {
    console.error("Erro ao exportar PDF:", error);
    throw error;
  }
}

/**
 * Adiciona cabeÃ§alho ao PDF
 */
function addHeader(pdf: jsPDF, title: string, subtitle?: string) {
  const pageWidth = pdf.internal.pageSize.getWidth();

  // Linha laranja UISA no topo
  pdf.setFillColor(243, 146, 0); // #F39200
  pdf.rect(0, 0, pageWidth, 8, "F");

  // TÃ­tulo
  pdf.setFontSize(16);
  pdf.setTextColor(30, 58, 95); // Azul escuro UISA
  pdf.setFont("helvetica", "bold");
  pdf.text(title, 10, 18);

  // SubtÃ­tulo (se fornecido)
  if (subtitle) {
    pdf.setFontSize(10);
    pdf.setTextColor(100, 100, 100);
    pdf.setFont("helvetica", "normal");
    pdf.text(subtitle, 10, 24);
  }

  // Data de geraÃ§Ã£o
  const now = new Date();
  const dateStr = now.toLocaleDateString("pt-BR", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
  pdf.setFontSize(8);
  pdf.setTextColor(150, 150, 150);
  pdf.text(`Gerado em: ${dateStr}`, pageWidth - 60, 18);

  // Linha separadora
  pdf.setDrawColor(200, 200, 200);
  pdf.line(10, 30, pageWidth - 10, 30);
}

/**
 * Adiciona rodapÃ© ao PDF
 */
function addFooter(pdf: jsPDF) {
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  // Linha separadora
  pdf.setDrawColor(200, 200, 200);
  pdf.line(10, pageHeight - 15, pageWidth - 10, pageHeight - 15);

  // Texto do rodapÃ©
  pdf.setFontSize(8);
  pdf.setTextColor(100, 100, 100);
  pdf.setFont("helvetica", "normal");
  pdf.text("Sistema AVD UISA - AvaliaÃ§Ã£o de Desempenho", 10, pageHeight - 10);

  // NÃºmero da pÃ¡gina
  const pageNumber = pdf.getCurrentPageInfo().pageNumber;
  pdf.text(`PÃ¡gina ${pageNumber}`, pageWidth - 30, pageHeight - 10);

  // Linha laranja UISA no rodapÃ©
  pdf.setFillColor(243, 146, 0); // #F39200
  pdf.rect(0, pageHeight - 5, pageWidth, 5, "F");
}

/**
 * Exporta Dashboard Executivo para PDF
 */
export async function exportDashboardExecutivo(): Promise<void> {
  await exportToPDF({
    filename: `dashboard-executivo-${new Date().toISOString().split("T")[0]}.pdf`,
    title: "Dashboard Executivo",
    subtitle: "VisÃ£o consolidada de performance e talentos - UISA",
    elementId: "dashboard-executivo-content",
    orientation: "landscape",
  });
}

/**
 * Exporta Mapa de SucessÃ£o para PDF
 */
export async function exportMapaSucessao(): Promise<void> {
  await exportToPDF({
    filename: `mapa-sucessao-${new Date().toISOString().split("T")[0]}.pdf`,
    title: "Mapa de SucessÃ£o",
    subtitle: "Planejamento estratÃ©gico de sucessÃ£o - UISA",
    elementId: "mapa-sucessao-content",
    orientation: "portrait",
  });
}

/**
 * Exporta PDI Inteligente para PDF
 */
export async function exportPDIInteligente(pdiId: number): Promise<void> {
  await exportToPDF({
    filename: `pdi-inteligente-${pdiId}-${new Date().toISOString().split("T")[0]}.pdf`,
    title: "PDI Inteligente",
    subtitle: "Plano de Desenvolvimento Individual - UISA",
    elementId: "pdi-inteligente-content",
    orientation: "portrait",
  });
}


========================================
ARQUIVO: ./client/src/lib/generate360PDF.ts
========================================
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

interface Evaluation360Data {
  evaluation: {
    id: number;
    employeeId: number;
    cycleId: number;
    finalScore: number | null;
  };
  averages: {
    self: number;
    manager: number;
    peers: number;
    subordinates: number;
  };
  responses: {
    self: any[];
    manager: any[];
    peers: any[];
    subordinates: any[];
  };
}

export async function generate360PDF(data: Evaluation360Data, employeeName: string = "Colaborador") {
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const margin = 20;
  let yPosition = margin;

  // TÃ­tulo
  pdf.setFontSize(20);
  pdf.setFont('helvetica', 'bold');
  pdf.text('RelatÃ³rio de AvaliaÃ§Ã£o 360Â°', margin, yPosition);
  yPosition += 15;

  // InformaÃ§Ãµes BÃ¡sicas
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'normal');
  pdf.text(`Colaborador: ${employeeName}`, margin, yPosition);
  yPosition += 7;
  pdf.text(`ID da AvaliaÃ§Ã£o: #${data.evaluation.id}`, margin, yPosition);
  yPosition += 7;
  pdf.text(`Ciclo: ${data.evaluation.cycleId}`, margin, yPosition);
  yPosition += 7;
  pdf.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, margin, yPosition);
  yPosition += 15;

  // Linha divisÃ³ria
  pdf.setDrawColor(200, 200, 200);
  pdf.line(margin, yPosition, pageWidth - margin, yPosition);
  yPosition += 10;

  // Nota Final
  if (data.evaluation.finalScore !== null) {
    pdf.setFontSize(14);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Nota Final', margin, yPosition);
    yPosition += 10;

    pdf.setFontSize(24);
    pdf.setTextColor(99, 102, 241); // Primary color
    pdf.text(data.evaluation.finalScore.toFixed(1), margin, yPosition);
    pdf.setTextColor(0, 0, 0);
    yPosition += 15;
  }

  // MÃ©dias por Tipo de Avaliador
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.text('MÃ©dias por Tipo de Avaliador', margin, yPosition);
  yPosition += 10;

  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'normal');

  const evaluatorTypes = [
    { label: 'AutoavaliaÃ§Ã£o', value: data.averages.self, color: [59, 130, 246] },
    { label: 'Gestor', value: data.averages.manager, color: [168, 85, 247] },
    { label: 'Pares', value: data.averages.peers, color: [34, 197, 94] },
    { label: 'Subordinados', value: data.averages.subordinates, color: [249, 115, 22] },
  ];

  evaluatorTypes.forEach(({ label, value, color }) => {
    pdf.setTextColor(0, 0, 0);
    pdf.text(label, margin, yPosition);
    
    pdf.setTextColor(color[0], color[1], color[2]);
    pdf.setFont('helvetica', 'bold');
    pdf.text(value.toFixed(1), margin + 60, yPosition);
    
    pdf.setFont('helvetica', 'normal');
    yPosition += 7;
  });

  pdf.setTextColor(0, 0, 0);
  yPosition += 10;

  // EstatÃ­sticas de Respostas
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.text('EstatÃ­sticas de Respostas', margin, yPosition);
  yPosition += 10;

  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'normal');

  const stats = [
    { label: 'AutoavaliaÃ§Ã£o', count: data.responses.self.length },
    { label: 'Gestor', count: data.responses.manager.length },
    { label: 'Pares', count: data.responses.peers.length },
    { label: 'Subordinados', count: data.responses.subordinates.length },
  ];

  stats.forEach(({ label, count }) => {
    pdf.text(`${label}: ${count} respostas`, margin, yPosition);
    yPosition += 7;
  });

  yPosition += 10;

  // AnÃ¡lise Comparativa
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.text('AnÃ¡lise Comparativa', margin, yPosition);
  yPosition += 10;

  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'normal');

  const avgAll = (data.averages.self + data.averages.manager + data.averages.peers + data.averages.subordinates) / 4;
  pdf.text(`MÃ©dia Geral: ${avgAll.toFixed(2)}`, margin, yPosition);
  yPosition += 7;

  const maxAvg = Math.max(data.averages.self, data.averages.manager, data.averages.peers, data.averages.subordinates);
  const minAvg = Math.min(data.averages.self, data.averages.manager, data.averages.peers, data.averages.subordinates);
  const variance = maxAvg - minAvg;

  pdf.text(`VariaÃ§Ã£o entre avaliadores: ${variance.toFixed(2)}`, margin, yPosition);
  yPosition += 7;

  if (variance < 0.5) {
    pdf.text('âœ“ AvaliaÃ§Ãµes consistentes (baixa variaÃ§Ã£o)', margin, yPosition);
  } else if (variance < 1.0) {
    pdf.text('âš  AvaliaÃ§Ãµes moderadamente variadas', margin, yPosition);
  } else {
    pdf.text('âš  AvaliaÃ§Ãµes significativamente divergentes', margin, yPosition);
  }
  yPosition += 15;

  // RecomendaÃ§Ãµes
  if (yPosition > pageHeight - 60) {
    pdf.addPage();
    yPosition = margin;
  }

  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.text('RecomendaÃ§Ãµes de Desenvolvimento', margin, yPosition);
  yPosition += 10;

  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'normal');

  const recommendations = [];

  if (data.averages.self > data.averages.manager + 0.5) {
    recommendations.push('â€¢ Considere alinhar autopercepÃ§Ã£o com a visÃ£o do gestor');
  }

  if (data.averages.peers < avgAll - 0.5) {
    recommendations.push('â€¢ Foco em melhorar relacionamento e colaboraÃ§Ã£o com pares');
  }

  if (data.averages.subordinates < avgAll - 0.5) {
    recommendations.push('â€¢ Desenvolver habilidades de lideranÃ§a e gestÃ£o de equipe');
  }

  if (variance > 1.0) {
    recommendations.push('â€¢ Buscar feedback adicional para entender divergÃªncias nas avaliaÃ§Ãµes');
  }

  if (avgAll >= 4.0) {
    recommendations.push('â€¢ Desempenho excelente! Considere assumir projetos de maior complexidade');
  } else if (avgAll < 3.0) {
    recommendations.push('â€¢ Elaborar Plano de Desenvolvimento Individual (PDI) focado nas Ã¡reas de melhoria');
  }

  if (recommendations.length === 0) {
    recommendations.push('â€¢ Manter o bom desempenho e buscar oportunidades de crescimento contÃ­nuo');
  }

  recommendations.forEach(rec => {
    if (yPosition > pageHeight - 20) {
      pdf.addPage();
      yPosition = margin;
    }
    const lines = pdf.splitTextToSize(rec, pageWidth - 2 * margin);
    lines.forEach((line: string) => {
      pdf.text(line, margin, yPosition);
      yPosition += 7;
    });
  });

  // RodapÃ©
  const footerY = pageHeight - 10;
  pdf.setFontSize(8);
  pdf.setTextColor(128, 128, 128);
  pdf.text('Sistema AVD UISA - AvaliaÃ§Ã£o de Desempenho', margin, footerY);
  pdf.text(`Gerado em ${new Date().toLocaleString('pt-BR')}`, pageWidth - margin - 50, footerY);

  // Salvar PDF
  pdf.save(`Relatorio_360_${data.evaluation.id}_${Date.now()}.pdf`);
}

export async function generate360PDFWithChart(
  data: Evaluation360Data,
  employeeName: string = "Colaborador",
  chartElement?: HTMLElement
) {
  // Se houver elemento de grÃ¡fico, capturar como imagem
  if (chartElement) {
    const canvas = await html2canvas(chartElement, {
      backgroundColor: '#ffffff',
      scale: 2,
    });

    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const margin = 20;

    // Adicionar informaÃ§Ãµes bÃ¡sicas
    pdf.setFontSize(20);
    pdf.setFont('helvetica', 'bold');
    pdf.text('RelatÃ³rio de AvaliaÃ§Ã£o 360Â°', margin, margin);

    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'normal');
    pdf.text(`Colaborador: ${employeeName}`, margin, margin + 15);
    pdf.text(`ID: #${data.evaluation.id} | Ciclo: ${data.evaluation.cycleId}`, margin, margin + 22);

    // Adicionar grÃ¡fico
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = pageWidth - 2 * margin;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    pdf.addImage(imgData, 'PNG', margin, margin + 30, imgWidth, imgHeight);

    // Continuar com o restante do relatÃ³rio
    pdf.addPage();
    let yPosition = margin;

    pdf.setFontSize(14);
    pdf.setFont('helvetica', 'bold');
    pdf.text('MÃ©dias Detalhadas', margin, yPosition);
    yPosition += 10;

    // ... (resto do conteÃºdo do PDF)

    pdf.save(`Relatorio_360_${data.evaluation.id}_${Date.now()}.pdf`);
  } else {
    // Fallback para versÃ£o sem grÃ¡fico
    await generate360PDF(data, employeeName);
  }
}


========================================
ARQUIVO: ./client/src/lib/generateICS.ts
========================================
/**
 * Gera arquivo .ics (iCalendar) para adicionar eventos ao calendÃ¡rio
 */

interface ICSEvent {
  title: string;
  description?: string;
  location?: string;
  startDate: Date;
  endDate: Date;
  url?: string;
}

export function generateICS(event: ICSEvent): string {
  const formatDate = (date: Date): string => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    const hours = String(date.getHours()).padStart(2, "0");
    const minutes = String(date.getMinutes()).padStart(2, "0");
    const seconds = String(date.getSeconds()).padStart(2, "0");
    return `${year}${month}${day}T${hours}${minutes}${seconds}`;
  };

  const escapeText = (text: string): string => {
    return text
      .replace(/\\/g, "\\\\")
      .replace(/;/g, "\\;")
      .replace(/,/g, "\\,")
      .replace(/\n/g, "\\n");
  };

  const now = new Date();
  const timestamp = formatDate(now);
  const uid = `${timestamp}-${Math.random().toString(36).substring(7)}@avd-uisa`;

  const lines = [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//AVD UISA//Sistema de AvaliaÃ§Ã£o de Desempenho//PT",
    "CALSCALE:GREGORIAN",
    "METHOD:PUBLISH",
    "BEGIN:VEVENT",
    `UID:${uid}`,
    `DTSTAMP:${timestamp}`,
    `DTSTART:${formatDate(event.startDate)}`,
    `DTEND:${formatDate(event.endDate)}`,
    `SUMMARY:${escapeText(event.title)}`,
  ];

  if (event.description) {
    lines.push(`DESCRIPTION:${escapeText(event.description)}`);
  }

  if (event.location) {
    lines.push(`LOCATION:${escapeText(event.location)}`);
  }

  if (event.url) {
    lines.push(`URL:${event.url}`);
  }

  lines.push("STATUS:CONFIRMED");
  lines.push("SEQUENCE:0");
  lines.push("END:VEVENT");
  lines.push("END:VCALENDAR");

  return lines.join("\r\n");
}

export function downloadICS(event: ICSEvent, filename: string): void {
  const icsContent = generateICS(event);
  const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename.endsWith(".ics") ? filename : `${filename}.ics`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
}


========================================
ARQUIVO: ./client/src/lib/reportGenerators.ts
========================================
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";
import ExcelJS from "exceljs";
import { Chart, ChartConfiguration, registerables } from "chart.js";

// Registrar todos os componentes do Chart.js
Chart.register(...registerables);

interface ReportData {
  name: string;
  description?: string;
  metrics: string[];
  data: any;
  generatedAt: string;
  chartType?: string;
}

interface MetricInfo {
  id: string;
  name: string;
  category: string;
}

/**
 * Gera um grÃ¡fico Chart.js e retorna como imagem base64
 */
async function generateChartImage(
  type: "bar" | "line" | "pie",
  labels: string[],
  data: number[],
  label: string
): Promise<string> {
  return new Promise((resolve) => {
    const canvas = document.createElement("canvas");
    canvas.width = 600;
    canvas.height = 400;
    
    const config: ChartConfiguration = {
      type,
      data: {
        labels,
        datasets: [{
          label,
          data,
          backgroundColor: type === "pie" 
            ? [
                "rgba(59, 130, 246, 0.8)",
                "rgba(16, 185, 129, 0.8)",
                "rgba(245, 158, 11, 0.8)",
                "rgba(239, 68, 68, 0.8)",
                "rgba(139, 92, 246, 0.8)",
                "rgba(236, 72, 153, 0.8)",
                "rgba(20, 184, 166, 0.8)",
              ]
            : "rgba(59, 130, 246, 0.8)",
          borderColor: type === "pie"
            ? [
                "rgb(59, 130, 246)",
                "rgb(16, 185, 129)",
                "rgb(245, 158, 11)",
                "rgb(239, 68, 68)",
                "rgb(139, 92, 246)",
                "rgb(236, 72, 153)",
                "rgb(20, 184, 166)",
              ]
            : "rgb(59, 130, 246)",
          borderWidth: 2,
        }],
      },
      options: {
        responsive: false,
        plugins: {
          legend: {
            display: type === "pie",
            position: "right",
          },
          title: {
            display: true,
            text: label,
            font: {
              size: 16,
              weight: "bold",
            },
          },
        },
        scales: type !== "pie" ? {
          y: {
            beginAtZero: true,
          },
        } : undefined,
      },
    };
    
    const chart = new Chart(canvas, config);
    
    // Aguardar renderizaÃ§Ã£o e converter para imagem
    setTimeout(() => {
      const imageData = canvas.toDataURL("image/png");
      chart.destroy();
      resolve(imageData);
    }, 100);
  });
}

/**
 * Gera PDF do relatÃ³rio com dados e grÃ¡ficos
 */
export async function generatePDF(reportData: ReportData, availableMetrics: MetricInfo[]) {
  const doc = new jsPDF();
  let yPosition = 20;
  
  // TÃ­tulo
  doc.setFontSize(20);
  doc.text(reportData.name || "RelatÃ³rio Customizado", 14, yPosition);
  yPosition += 8;
  
  // DescriÃ§Ã£o
  if (reportData.description) {
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(reportData.description, 14, yPosition);
    yPosition += 5;
  }
  
  // Data de geraÃ§Ã£o
  doc.setFontSize(8);
  doc.setTextColor(150);
  doc.text(`Gerado em: ${new Date(reportData.generatedAt).toLocaleString('pt-BR')}`, 14, yPosition);
  yPosition += 10;
  
  // Reset cor
  doc.setTextColor(0);
  
  // Preparar dados para tabela e grÃ¡ficos
  const tableData: any[] = [];
  let departmentData: { labels: string[]; values: number[] } | null = null;
  
  reportData.metrics.forEach((metricId) => {
    const metric = availableMetrics.find((m) => m.id === metricId);
    if (!metric) return;
    
    const value = reportData.data[metricId];
    
    if (metricId === "departmentBreakdown" && Array.isArray(value)) {
      // DistribuiÃ§Ã£o por departamento
      departmentData = {
        labels: value.map((dept: any) => dept.departmentName),
        values: value.map((dept: any) => dept.count),
      };
      value.forEach((dept: any) => {
        tableData.push([
          `${metric.name} - ${dept.departmentName}`,
          dept.count.toString(),
        ]);
      });
    } else if (value !== null && value !== undefined) {
      // MÃ©tricas simples
      const formattedValue = typeof value === "number" 
        ? value.toFixed(2) 
        : value.toString();
      tableData.push([metric.name, formattedValue]);
    }
  });
  
  // Adicionar grÃ¡fico de distribuiÃ§Ã£o por departamento se existir
  if (departmentData && reportData.chartType) {
    const chartType = reportData.chartType === "pie" ? "pie" : reportData.chartType === "line" ? "line" : "bar";
    const deptData = departmentData as { labels: string[]; values: number[] };
    const chartImage = await generateChartImage(
      chartType,
      deptData.labels,
      deptData.values,
      "DistribuiÃ§Ã£o por Departamento"
    );
    
    doc.addImage(chartImage, "PNG", 14, yPosition, 180, 120);
    yPosition += 130;
    
    // Adicionar nova pÃ¡gina se necessÃ¡rio
    if (yPosition > 250) {
      doc.addPage();
      yPosition = 20;
    }
  }
  
  // Adicionar tabela
  autoTable(doc, {
    head: [["MÃ©trica", "Valor"]],
    body: tableData,
    startY: yPosition,
    theme: "grid",
    headStyles: {
      fillColor: [59, 130, 246], // Blue
      textColor: 255,
      fontStyle: "bold",
    },
    styles: {
      fontSize: 10,
      cellPadding: 5,
    },
  });
  
  // Salvar PDF
  doc.save(`${reportData.name || "relatorio"}.pdf`);
}

/**
 * Gera Excel do relatÃ³rio com dados tabulados
 */
export async function generateExcel(reportData: ReportData, availableMetrics: MetricInfo[]) {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet("RelatÃ³rio");
  
  // TÃ­tulo
  worksheet.mergeCells("A1:B1");
  const titleCell = worksheet.getCell("A1");
  titleCell.value = reportData.name || "RelatÃ³rio Customizado";
  titleCell.font = { size: 16, bold: true };
  titleCell.alignment = { horizontal: "center", vertical: "middle" };
  
  // DescriÃ§Ã£o
  if (reportData.description) {
    worksheet.mergeCells("A2:B2");
    const descCell = worksheet.getCell("A2");
    descCell.value = reportData.description;
    descCell.font = { size: 10, italic: true };
    descCell.alignment = { horizontal: "center" };
  }
  
  // Data de geraÃ§Ã£o
  const startRow = reportData.description ? 3 : 2;
  worksheet.mergeCells(`A${startRow}:B${startRow}`);
  const dateCell = worksheet.getCell(`A${startRow}`);
  dateCell.value = `Gerado em: ${new Date(reportData.generatedAt).toLocaleString('pt-BR')}`;
  dateCell.font = { size: 8, color: { argb: "FF808080" } };
  dateCell.alignment = { horizontal: "center" };
  
  // CabeÃ§alho da tabela
  const headerRow = startRow + 2;
  worksheet.getCell(`A${headerRow}`).value = "MÃ©trica";
  worksheet.getCell(`B${headerRow}`).value = "Valor";
  
  const headerStyle = {
    font: { bold: true, color: { argb: "FFFFFFFF" } },
    fill: { type: "pattern" as const, pattern: "solid" as const, fgColor: { argb: "FF3B82F6" } },
    alignment: { horizontal: "center" as const, vertical: "middle" as const },
  };
  
  worksheet.getCell(`A${headerRow}`).style = headerStyle;
  worksheet.getCell(`B${headerRow}`).style = headerStyle;
  
  // Dados
  let currentRow = headerRow + 1;
  
  reportData.metrics.forEach((metricId) => {
    const metric = availableMetrics.find((m) => m.id === metricId);
    if (!metric) return;
    
    const value = reportData.data[metricId];
    
    if (metricId === "departmentBreakdown" && Array.isArray(value)) {
      // DistribuiÃ§Ã£o por departamento
      value.forEach((dept: any) => {
        worksheet.getCell(`A${currentRow}`).value = `${metric.name} - ${dept.departmentName}`;
        worksheet.getCell(`B${currentRow}`).value = dept.count;
        currentRow++;
      });
    } else if (value !== null && value !== undefined) {
      // MÃ©tricas simples
      worksheet.getCell(`A${currentRow}`).value = metric.name;
      worksheet.getCell(`B${currentRow}`).value = typeof value === "number" 
        ? parseFloat(value.toFixed(2)) 
        : value;
      currentRow++;
    }
  });
  
  // Ajustar largura das colunas
  worksheet.getColumn("A").width = 40;
  worksheet.getColumn("B").width = 20;
  
  // Adicionar bordas
  for (let row = headerRow; row < currentRow; row++) {
    ["A", "B"].forEach((col) => {
      const cell = worksheet.getCell(`${col}${row}`);
      cell.border = {
        top: { style: "thin" },
        left: { style: "thin" },
        bottom: { style: "thin" },
        right: { style: "thin" },
      };
    });
  }
  
  // Gerar e baixar arquivo
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], {
    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
  });
  
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `${reportData.name || "relatorio"}.xlsx`;
  link.click();
  window.URL.revokeObjectURL(url);
}


========================================
ARQUIVO: ./client/src/lib/trpc.ts
========================================
import { createTRPCReact } from "@trpc/react-query";
import type { AppRouter } from "../../../server/routers";

export const trpc = createTRPCReact<AppRouter>();


========================================
ARQUIVO: ./client/src/lib/utils.ts
========================================
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}


========================================
ARQUIVO: ./client/src/main.tsx
========================================
import { trpc } from "@/lib/trpc";
import { UNAUTHED_ERR_MSG } from '@shared/const';
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { httpBatchLink, TRPCClientError } from "@trpc/client";
import { createRoot } from "react-dom/client";
import superjson from "superjson";
import App from "./App";
import { getLoginUrl } from "./const";
import "./index.css";

const queryClient = new QueryClient();

const redirectToLoginIfUnauthorized = (error: unknown) => {
  if (!(error instanceof TRPCClientError)) return;
  if (typeof window === "undefined") return;

  const isUnauthorized = error.message === UNAUTHED_ERR_MSG;

  if (!isUnauthorized) return;

  window.location.href = getLoginUrl();
};

queryClient.getQueryCache().subscribe(event => {
  if (event.type === "updated" && event.action.type === "error") {
    const error = event.query.state.error;
    redirectToLoginIfUnauthorized(error);
    console.error("[API Query Error]", error);
  }
});

queryClient.getMutationCache().subscribe(event => {
  if (event.type === "updated" && event.action.type === "error") {
    const error = event.mutation.state.error;
    redirectToLoginIfUnauthorized(error);
    console.error("[API Mutation Error]", error);
  }
});

const trpcClient = trpc.createClient({
  links: [
    httpBatchLink({
      url: "/api/trpc",
      transformer: superjson,
      fetch(input, init) {
        return globalThis.fetch(input, {
          ...(init ?? {}),
          credentials: "include",
        });
      },
    }),
  ],
});

createRoot(document.getElementById("root")!).render(
  <trpc.Provider client={trpcClient} queryClient={queryClient}>
    <QueryClientProvider client={queryClient}>
      <App />
    </QueryClientProvider>
  </trpc.Provider>
);


========================================
ARQUIVO: ./client/src/pages/AdminSmtp.tsx
========================================
import { useState, useEffect } from "react";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { toast } from "sonner";
import { Loader2, Mail, Send, Settings, ShieldAlert, CheckCircle2 } from "lucide-react";
import { Alert, AlertDescription } from "@/components/ui/alert";

/**
 * PÃ¡gina de AdministraÃ§Ã£o SMTP
 * Permite configurar servidor SMTP para envio de e-mails automÃ¡ticos
 */

export default function AdminSmtp() {
  const { user } = useAuth();
  const [testEmail, setTestEmail] = useState("");
  const [isTesting, setIsTesting] = useState(false);

  // Buscar configuraÃ§Ãµes SMTP
  const { data: smtpConfig, isLoading, refetch } = trpc.admin.getSmtpConfig.useQuery();

  // Mutation para atualizar configuraÃ§Ãµes
  const updateMutation = trpc.admin.updateSmtpConfig.useMutation({
    onSuccess: () => {
      toast.success("ConfiguraÃ§Ãµes SMTP salvas com sucesso!");
      refetch();
    },
    onError: (error) => {
      toast.error(`Erro ao salvar: ${error.message}`);
    },
  });

  // Mutation para testar conexÃ£o
  const testMutation = trpc.admin.testSmtpConnection.useMutation({
    onSuccess: (data) => {
      if (data.success) {
        toast.success(data.message || "E-mail de teste enviado!");
      } else {
        toast.error(data.message || "Falha ao enviar e-mail de teste");
      }
      setIsTesting(false);
    },
    onError: (error) => {
      toast.error(`Erro ao testar: ${error.message}`);
      setIsTesting(false);
    },
  });

  // Estado do formulÃ¡rio
  const [formData, setFormData] = useState({
    host: "",
    port: 587,
    secure: false,
    user: "",
    pass: "",
    fromName: "Sistema AVD UISA",
    fromEmail: "",
  });

  // Carregar configuraÃ§Ãµes existentes
  useEffect(() => {
    if (smtpConfig) {
      setFormData(smtpConfig);
    }
  }, [smtpConfig]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    updateMutation.mutate(formData);
  };

  const handleTest = () => {
    if (!testEmail) {
      toast.error("Digite um e-mail para teste");
      return;
    }

    setIsTesting(true);
    testMutation.mutate({
      ...formData,
      testEmail,
    });
  };

  // Verificar se Ã© admin
  if (user?.role !== "admin") {
    return (
      <DashboardLayout>
        <Alert variant="destructive">
          <ShieldAlert className="h-4 w-4" />
          <AlertDescription>
            Acesso negado: apenas administradores podem acessar esta pÃ¡gina.
          </AlertDescription>
        </Alert>
      </DashboardLayout>
    );
  }

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="max-w-3xl mx-auto space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
            <Settings className="h-8 w-8" />
            ConfiguraÃ§Ãµes SMTP
          </h1>
          <p className="text-muted-foreground mt-2">
            Configure o servidor de e-mail para envio de notificaÃ§Ãµes automÃ¡ticas
          </p>
        </div>

        <Alert>
          <Mail className="h-4 w-4" />
          <AlertDescription>
            As configuraÃ§Ãµes SMTP sÃ£o necessÃ¡rias para o envio automÃ¡tico de e-mails de lembretes de metas, avaliaÃ§Ãµes pendentes e aÃ§Ãµes de PDI vencidas.
          </AlertDescription>
        </Alert>

        <form onSubmit={handleSubmit}>
          <Card>
            <CardHeader>
              <CardTitle>Servidor SMTP</CardTitle>
              <CardDescription>
                InformaÃ§Ãµes do servidor de e-mail (ex: Gmail, Outlook, servidor prÃ³prio)
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* Host */}
              <div className="space-y-2">
                <Label htmlFor="host">Host do Servidor</Label>
                <Input
                  id="host"
                  type="text"
                  placeholder="smtp.gmail.com"
                  value={formData.host}
                  onChange={(e) => setFormData({ ...formData, host: e.target.value })}
                  required
                />
                <p className="text-xs text-muted-foreground">
                  Ex: smtp.gmail.com, smtp.office365.com, smtp.seu-dominio.com
                </p>
              </div>

              {/* Port e Secure */}
              <div className="grid md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="port">Porta</Label>
                  <Input
                    id="port"
                    type="number"
                    placeholder="587"
                    value={formData.port}
                    onChange={(e) => setFormData({ ...formData, port: parseInt(e.target.value) })}
                    required
                  />
                  <p className="text-xs text-muted-foreground">
                    Comum: 587 (TLS) ou 465 (SSL)
                  </p>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="secure">ConexÃ£o Segura (SSL/TLS)</Label>
                  <div className="flex items-center space-x-2 pt-2">
                    <Switch
                      id="secure"
                      checked={formData.secure}
                      onCheckedChange={(checked) => setFormData({ ...formData, secure: checked })}
                    />
                    <Label htmlFor="secure" className="cursor-pointer">
                      {formData.secure ? "Ativado (porta 465)" : "Desativado (porta 587)"}
                    </Label>
                  </div>
                </div>
              </div>

              {/* UsuÃ¡rio e Senha */}
              <div className="space-y-2">
                <Label htmlFor="user">UsuÃ¡rio (E-mail)</Label>
                <Input
                  id="user"
                  type="email"
                  placeholder="seu-email@gmail.com"
                  value={formData.user}
                  onChange={(e) => setFormData({ ...formData, user: e.target.value })}
                  required
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="pass">Senha</Label>
                <Input
                  id="pass"
                  type="password"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  value={formData.pass}
                  onChange={(e) => setFormData({ ...formData, pass: e.target.value })}
                  required
                />
                <p className="text-xs text-muted-foreground">
                  Para Gmail, use uma <strong>Senha de App</strong> (nÃ£o a senha normal). Acesse: Conta Google â†’ SeguranÃ§a â†’ VerificaÃ§Ã£o em duas etapas â†’ Senhas de app
                </p>
              </div>

              {/* Remetente */}
              <div className="space-y-2">
                <Label htmlFor="fromName">Nome do Remetente</Label>
                <Input
                  id="fromName"
                  type="text"
                  placeholder="Sistema AVD UISA"
                  value={formData.fromName}
                  onChange={(e) => setFormData({ ...formData, fromName: e.target.value })}
                  required
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="fromEmail">E-mail do Remetente</Label>
                <Input
                  id="fromEmail"
                  type="email"
                  placeholder="noreply@empresa.com"
                  value={formData.fromEmail}
                  onChange={(e) => setFormData({ ...formData, fromEmail: e.target.value })}
                  required
                />
              </div>

              {/* BotÃ£o Salvar */}
              <div className="pt-4">
                <Button
                  type="submit"
                  className="w-full"
                  disabled={updateMutation.isPending}
                >
                  {updateMutation.isPending ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Salvando...
                    </>
                  ) : (
                    <>
                      <CheckCircle2 className="w-4 h-4 mr-2" />
                      Salvar ConfiguraÃ§Ãµes
                    </>
                  )}
                </Button>
              </div>
            </CardContent>
          </Card>
        </form>

        {/* Teste de ConexÃ£o */}
        <Card>
          <CardHeader>
            <CardTitle>Testar ConfiguraÃ§Ãµes</CardTitle>
            <CardDescription>
              Envie um e-mail de teste para verificar se as configuraÃ§Ãµes estÃ£o corretas
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="testEmail">E-mail de Teste</Label>
              <Input
                id="testEmail"
                type="email"
                placeholder="seu-email@exemplo.com"
                value={testEmail}
                onChange={(e) => setTestEmail(e.target.value)}
              />
            </div>

            <Button
              onClick={handleTest}
              variant="outline"
              className="w-full"
              disabled={isTesting || !testEmail}
            >
              {isTesting ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Enviando...
                </>
              ) : (
                <>
                  <Send className="w-4 h-4 mr-2" />
                  Enviar E-mail de Teste
                </>
              )}
            </Button>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Analytics.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Loader2, Users, TrendingDown, Clock, DollarSign, Download, BarChart3 } from "lucide-react";
import { CostCenterFilter } from "@/components/CostCenterFilter";
import { trpc } from "@/lib/trpc";
import { PieChart, Pie, Cell, BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";
import { toast } from "sonner";

const COLORS = ["#3B82F6", "#10B981", "#F59E0B", "#EF4444", "#8B5CF6", "#EC4899", "#14B8A6", "#F97316"];

export default function Analytics() {
  const [period, setPeriod] = useState("12m");
  const [department, setDepartment] = useState("todos");
  const [selectedCostCenter, setSelectedCostCenter] = useState<string>("all");

  const { data: kpis, isLoading: kpisLoading } = trpc.analytics.getKPIs.useQuery(
    selectedCostCenter !== "all" ? { costCenter: selectedCostCenter } : undefined
  );
  const { data: headcountByDept } = trpc.analytics.getHeadcountByDepartment.useQuery(
    selectedCostCenter !== "all" ? { costCenter: selectedCostCenter } : undefined
  );
  const { data: headcountByPosition } = trpc.analytics.getHeadcountByPosition.useQuery(
    selectedCostCenter !== "all" ? { costCenter: selectedCostCenter } : undefined
  );
  const { data: turnoverRate } = trpc.analytics.getTurnoverRate.useQuery();
  const { data: averageTenure } = trpc.analytics.getAverageTenure.useQuery();
  const { data: diversity } = trpc.analytics.getDiversityAnalysis.useQuery();
  const { data: growthProjection } = trpc.analytics.getGrowthProjection.useQuery();

  const handleExport = () => {
    toast.info("Exportando relatÃ³rio de Analytics...");
    setTimeout(() => toast.success("RelatÃ³rio exportado com sucesso!"), 1000);
  };

  if (kpisLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <div className="flex items-center gap-2">
              <BarChart3 className="h-6 w-6 text-primary" />
              <h1 className="text-2xl font-bold">Analytics de RH</h1>
            </div>
            <p className="text-sm text-muted-foreground">
              MÃ©tricas avanÃ§adas e anÃ¡lise de dados de pessoas - UISA
            </p>
          </div>
          <div className="flex items-center gap-3">
            <CostCenterFilter
              value={selectedCostCenter}
              onChange={setSelectedCostCenter}
            />
            <Select value={period} onValueChange={setPeriod}>
              <SelectTrigger className="w-32">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="6m">6 meses</SelectItem>
                <SelectItem value="12m">12 meses</SelectItem>
                <SelectItem value="24m">24 meses</SelectItem>
              </SelectContent>
            </Select>
            <Button onClick={handleExport}>
              <Download className="h-4 w-4 mr-2" />
              Exportar
            </Button>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">Total Headcount</CardTitle>
                <Users className="h-4 w-4 text-blue-500" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{kpis?.totalEmployees || 0}</div>
              <p className="text-xs text-muted-foreground mt-1">
                <span className="text-green-600">+5</span> vs. mÃªs anterior
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">Turnover Rate</CardTitle>
                <TrendingDown className="h-4 w-4 text-orange-500" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">2.8%</div>
              <p className="text-xs text-muted-foreground mt-1">
                <span className="text-green-600">-0.3%</span> vs. mÃªs anterior
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">Tempo MÃ©dio</CardTitle>
                <Clock className="h-4 w-4 text-purple-500" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">3.5 anos</div>
              <p className="text-xs text-muted-foreground mt-1">Tempo mÃ©dio de permanÃªncia</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">Custo por ContrataÃ§Ã£o</CardTitle>
                <DollarSign className="h-4 w-4 text-green-500" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">R$ 15.000</div>
              <p className="text-xs text-muted-foreground mt-1">MÃ©dia por contrataÃ§Ã£o</p>
            </CardContent>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Users className="h-5 w-5 text-blue-500" />
                DistribuiÃ§Ã£o por Departamento
              </CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={400}>
                <PieChart>
                  <Pie 
                    data={headcountByDept || []} 
                    dataKey="count" 
                    nameKey="department" 
                    cx="50%" 
                    cy="45%" 
                    outerRadius={80}
                    label={false}
                  >
                    {(headcountByDept || []).map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
                  <Legend 
                    verticalAlign="bottom" 
                    height={80}
                    wrapperStyle={{ paddingTop: "20px", maxHeight: "80px", overflow: "auto" }}
                  />
                </PieChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <BarChart3 className="h-5 w-5 text-green-500" />
                Top 15 Cargos
              </CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={headcountByPosition || []} layout="vertical">
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis type="number" />
                  <YAxis dataKey="position" type="category" width={150} />
                  <Tooltip />
                  <Bar dataKey="count" fill="#10B981" />
                </BarChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingDown className="h-5 w-5 text-orange-500" />
                Taxa de Turnover Mensal
              </CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={turnoverRate || []}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="month" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Line type="monotone" dataKey="rate" stroke="#F59E0B" strokeWidth={2} name="Taxa (%)" />
                </LineChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Clock className="h-5 w-5 text-purple-500" />
                Tempo MÃ©dio de PermanÃªncia
              </CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={averageTenure || []}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="department" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="tenure" fill="#8B5CF6" name="Anos" />
                </BarChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Users className="h-5 w-5 text-pink-500" />
                AnÃ¡lise de Diversidade
              </CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie data={diversity?.gender || []} dataKey="count" nameKey="gender" cx="50%" cy="50%" outerRadius={100} label>
                    {(diversity?.gender || []).map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
                  <Legend />
                </PieChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingDown className="h-5 w-5 text-green-500" />
                ProjeÃ§Ãµes de Crescimento
              </CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={growthProjection || []}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="month" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Line type="monotone" dataKey="actual" stroke="#3B82F6" strokeWidth={2} name="Real" />
                  <Line type="monotone" dataKey="projected" stroke="#10B981" strokeWidth={2} strokeDasharray="5 5" name="Projetado" />
                </LineChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/AnalyticsAvancado.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { LineChart, Line, BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";
import { TrendingUp, Users, Target, Award } from "lucide-react";
import DashboardLayout from "@/components/DashboardLayout";

/**
 * Analytics AvanÃ§ado - Dashboard com GrÃ¡ficos de EvoluÃ§Ã£o Temporal
 * 
 * Features:
 * - GrÃ¡fico de evoluÃ§Ã£o de progresso de metas por mÃªs
 * - GrÃ¡fico de taxa de conclusÃ£o de avaliaÃ§Ãµes 360Â°
 * - GrÃ¡fico de distribuiÃ§Ã£o de notas por departamento
 * - Filtros por perÃ­odo, departamento e colaborador
 */

export default function AnalyticsAvancado() {
  const [periodo, setPeriodo] = useState("2025");
  const [departamento, setDepartamento] = useState("todos");

  // Dados mockados - em produÃ§Ã£o virÃ£o do backend via tRPC
  const progressoMetasPorMes = [
    { mes: "Jan", progresso: 15, metas: 50 },
    { mes: "Fev", progresso: 28, metas: 50 },
    { mes: "Mar", progresso: 42, metas: 50 },
    { mes: "Abr", progresso: 55, metas: 50 },
    { mes: "Mai", progresso: 68, metas: 50 },
    { mes: "Jun", progresso: 75, metas: 50 },
    { mes: "Jul", progresso: 82, metas: 50 },
    { mes: "Ago", progresso: 88, metas: 50 },
    { mes: "Set", progresso: 92, metas: 50 },
    { mes: "Out", progresso: 95, metas: 50 },
    { mes: "Nov", progresso: 97, metas: 50 },
    { mes: "Dez", progresso: 100, metas: 50 },
  ];

  const taxaConclusaoAvaliacoes = [
    { mes: "Jan", autoavaliacao: 80, gestor: 60, consenso: 40 },
    { mes: "Fev", autoavaliacao: 85, gestor: 70, consenso: 55 },
    { mes: "Mar", autoavaliacao: 90, gestor: 80, consenso: 70 },
    { mes: "Abr", autoavaliacao: 92, gestor: 85, consenso: 75 },
    { mes: "Mai", autoavaliacao: 95, gestor: 88, consenso: 80 },
    { mes: "Jun", autoavaliacao: 98, gestor: 92, consenso: 85 },
  ];

  const distribuicaoNotasPorDepartamento = [
    { departamento: "Vendas", nota: 8.5 },
    { departamento: "TI", nota: 8.8 },
    { departamento: "Marketing", nota: 8.2 },
    { departamento: "Financeiro", nota: 8.7 },
    { departamento: "RH", nota: 9.0 },
    { departamento: "OperaÃ§Ãµes", nota: 8.4 },
  ];

  const distribuicaoColaboradoresPorNota = [
    { nota: "9-10", quantidade: 15, cor: "#10b981" },
    { nota: "7-8", quantidade: 35, cor: "#3b82f6" },
    { nota: "5-6", quantidade: 8, cor: "#f59e0b" },
    { nota: "0-4", quantidade: 2, cor: "#ef4444" },
  ];

  const COLORS = ["#10b981", "#3b82f6", "#f59e0b", "#ef4444"];

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold">Analytics AvanÃ§ado</h1>
          <p className="text-muted-foreground">
            AnÃ¡lise detalhada de desempenho com grÃ¡ficos de evoluÃ§Ã£o temporal
          </p>
        </div>

        {/* Filtros */}
        <Card>
          <CardHeader>
            <CardTitle>Filtros</CardTitle>
            <CardDescription>Personalize a visualizaÃ§Ã£o dos dados</CardDescription>
          </CardHeader>
          <CardContent className="flex gap-4">
            <div className="flex-1">
              <label className="text-sm font-medium mb-2 block">PerÃ­odo</label>
              <Select value={periodo} onValueChange={setPeriodo}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="2025">2025</SelectItem>
                  <SelectItem value="2024">2024</SelectItem>
                  <SelectItem value="2023">2023</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="flex-1">
              <label className="text-sm font-medium mb-2 block">Departamento</label>
              <Select value={departamento} onValueChange={setDepartamento}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos</SelectItem>
                  <SelectItem value="vendas">Vendas</SelectItem>
                  <SelectItem value="ti">TI</SelectItem>
                  <SelectItem value="marketing">Marketing</SelectItem>
                  <SelectItem value="financeiro">Financeiro</SelectItem>
                  <SelectItem value="rh">RH</SelectItem>
                  <SelectItem value="operacoes">OperaÃ§Ãµes</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </CardContent>
        </Card>

        {/* KPIs */}
        <div className="grid gap-4 md:grid-cols-4">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Progresso MÃ©dio</CardTitle>
              <TrendingUp className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">72%</div>
              <p className="text-xs text-muted-foreground">+12% vs mÃªs anterior</p>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Metas Ativas</CardTitle>
              <Target className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">50</div>
              <p className="text-xs text-muted-foreground">10 colaboradores</p>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">AvaliaÃ§Ãµes 360Â°</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">85%</div>
              <p className="text-xs text-muted-foreground">Taxa de conclusÃ£o</p>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Nota MÃ©dia</CardTitle>
              <Award className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">8.6</div>
              <p className="text-xs text-muted-foreground">+0.3 vs ano anterior</p>
            </CardContent>
          </Card>
        </div>

        {/* GrÃ¡fico 1: EvoluÃ§Ã£o de Progresso de Metas */}
        <Card>
          <CardHeader>
            <CardTitle>EvoluÃ§Ã£o de Progresso de Metas por MÃªs</CardTitle>
            <CardDescription>
              Acompanhe o progresso mÃ©dio das metas ao longo do ano
            </CardDescription>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={350}>
              <LineChart data={progressoMetasPorMes}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="mes" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="progresso"
                  stroke="#3b82f6"
                  strokeWidth={2}
                  name="Progresso MÃ©dio (%)"
                />
              </LineChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* GrÃ¡fico 2: Taxa de ConclusÃ£o de AvaliaÃ§Ãµes 360Â° */}
        <Card>
          <CardHeader>
            <CardTitle>Taxa de ConclusÃ£o de AvaliaÃ§Ãµes 360Â°</CardTitle>
            <CardDescription>
              Acompanhe o progresso das etapas de avaliaÃ§Ã£o 360Â°
            </CardDescription>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={350}>
              <LineChart data={taxaConclusaoAvaliacoes}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="mes" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="autoavaliacao"
                  stroke="#10b981"
                  strokeWidth={2}
                  name="AutoavaliaÃ§Ã£o (%)"
                />
                <Line
                  type="monotone"
                  dataKey="gestor"
                  stroke="#3b82f6"
                  strokeWidth={2}
                  name="AvaliaÃ§Ã£o Gestor (%)"
                />
                <Line
                  type="monotone"
                  dataKey="consenso"
                  stroke="#f59e0b"
                  strokeWidth={2}
                  name="Consenso (%)"
                />
              </LineChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        <div className="grid gap-4 md:grid-cols-2">
          {/* GrÃ¡fico 3: DistribuiÃ§Ã£o de Notas por Departamento */}
          <Card>
            <CardHeader>
              <CardTitle>Notas MÃ©dias por Departamento</CardTitle>
              <CardDescription>
                ComparaÃ§Ã£o de desempenho entre departamentos
              </CardDescription>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={distribuicaoNotasPorDepartamento}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="departamento" />
                  <YAxis domain={[0, 10]} />
                  <Tooltip />
                  <Bar dataKey="nota" fill="#3b82f6" name="Nota MÃ©dia" />
                </BarChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          {/* GrÃ¡fico 4: DistribuiÃ§Ã£o de Colaboradores por Faixa de Nota */}
          <Card>
            <CardHeader>
              <CardTitle>DistribuiÃ§Ã£o por Faixa de Nota</CardTitle>
              <CardDescription>
                Quantidade de colaboradores em cada faixa de desempenho
              </CardDescription>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={distribuicaoColaboradoresPorNota}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={({ nota, quantidade }) => `${nota}: ${quantidade}`}
                    outerRadius={100}
                    fill="#8884d8"
                    dataKey="quantidade"
                  >
                    {distribuicaoColaboradoresPorNota.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.cor} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/AnalyticsMetas.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import {
  BarChart3,
  TrendingUp,
  Clock,
  CheckCircle2,
  XCircle,
  AlertCircle,
  Calendar,
  Target,
} from "lucide-react";

/**
 * Dashboard de Analytics de Metas SMART
 * AnÃ¡lise avanÃ§ada com grÃ¡ficos de tendÃªncias, taxas de aprovaÃ§Ã£o e mÃ©tricas
 */
export default function AnalyticsMetas() {
  const [selectedPeriod, setSelectedPeriod] = useState("30");
  const [selectedDepartment, setSelectedDepartment] = useState<string>("all");

  // Buscar dados de analytics
  const { data: analytics, isLoading } = trpc.smartGoals.getAnalytics.useQuery({
    period: parseInt(selectedPeriod),
    departmentId: selectedDepartment === "all" ? undefined : parseInt(selectedDepartment),
  });

  // Buscar departamentos para filtro
  const { data: departments } = trpc.departments.list.useQuery();

  if (isLoading) {
    return (
      <div className="container mx-auto py-8">
        <div className="flex items-center justify-center h-64">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#F39200]"></div>
        </div>
      </div>
    );
  }

  const stats = analytics?.stats || {
    totalGoals: 0,
    completedGoals: 0,
    inProgressGoals: 0,
    overdueGoals: 0,
    approvalRate: 0,
    avgCompletionTime: 0,
  };

  const trends = analytics?.trends || [];
  const byDepartment = analytics?.byDepartment || [];
  const byCategory = analytics?.byCategory || [];

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-3">
            <BarChart3 className="w-8 h-8 text-[#F39200]" />
            Analytics de Metas SMART
          </h1>
          <p className="text-gray-600 mt-2">
            AnÃ¡lise detalhada de performance e tendÃªncias
          </p>
        </div>

        <div className="flex gap-3">
          <Select value={selectedPeriod} onValueChange={setSelectedPeriod}>
            <SelectTrigger className="w-40">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="7">Ãšltimos 7 dias</SelectItem>
              <SelectItem value="30">Ãšltimos 30 dias</SelectItem>
              <SelectItem value="90">Ãšltimos 90 dias</SelectItem>
              <SelectItem value="365">Ãšltimo ano</SelectItem>
            </SelectContent>
          </Select>

          <Select value={selectedDepartment} onValueChange={setSelectedDepartment}>
            <SelectTrigger className="w-48">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todos os Departamentos</SelectItem>
              {departments?.map((dept) => (
                <SelectItem key={dept.id} value={dept.id.toString()}>
                  {dept.name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total de Metas</CardTitle>
            <Target className="h-4 w-4 text-[#F39200]" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.totalGoals}</div>
            <p className="text-xs text-gray-600 mt-1">No perÃ­odo selecionado</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Taxa de ConclusÃ£o</CardTitle>
            <CheckCircle2 className="h-4 w-4 text-green-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {stats.totalGoals > 0
                ? ((stats.completedGoals / stats.totalGoals) * 100).toFixed(1)
                : 0}
              %
            </div>
            <p className="text-xs text-gray-600 mt-1">
              {stats.completedGoals} de {stats.totalGoals} metas
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Taxa de AprovaÃ§Ã£o</CardTitle>
            <TrendingUp className="h-4 w-4 text-blue-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.approvalRate.toFixed(1)}%</div>
            <p className="text-xs text-gray-600 mt-1">Metas aprovadas no 1Âº nÃ­vel</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Tempo MÃ©dio</CardTitle>
            <Clock className="h-4 w-4 text-purple-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.avgCompletionTime}</div>
            <p className="text-xs text-gray-600 mt-1">Dias para conclusÃ£o</p>
          </CardContent>
        </Card>
      </div>

      {/* GrÃ¡fico de TendÃªncias */}
      <Card>
        <CardHeader>
          <CardTitle>TendÃªncia de ConclusÃ£o de Metas</CardTitle>
          <CardDescription>EvoluÃ§Ã£o ao longo do tempo</CardDescription>
        </CardHeader>
        <CardContent>
          {trends.length > 0 ? (
            <div className="space-y-4">
              {trends.map((trend: any, index: number) => (
                <div key={index} className="flex items-center gap-4">
                  <div className="w-32 text-sm font-medium">{trend.period}</div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <div className="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                        <div
                          className="bg-[#F39200] h-full flex items-center justify-end pr-2 text-white text-xs font-bold"
                          style={{
                            width: `${Math.min((trend.completed / trend.total) * 100, 100)}%`,
                          }}
                        >
                          {trend.total > 0
                            ? `${((trend.completed / trend.total) * 100).toFixed(0)}%`
                            : ""}
                        </div>
                      </div>
                      <div className="text-sm text-gray-600 w-24">
                        {trend.completed}/{trend.total}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-12 text-gray-500">
              Sem dados de tendÃªncias no perÃ­odo selecionado
            </div>
          )}
        </CardContent>
      </Card>

      {/* Performance por Departamento */}
      <Card>
        <CardHeader>
          <CardTitle>Performance por Departamento</CardTitle>
          <CardDescription>Taxa de aprovaÃ§Ã£o e conclusÃ£o por Ã¡rea</CardDescription>
        </CardHeader>
        <CardContent>
          {byDepartment.length > 0 ? (
            <div className="space-y-4">
              {byDepartment.map((dept: any) => (
                <div key={dept.departmentId} className="border-b pb-4 last:border-0">
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="font-semibold">{dept.departmentName}</h4>
                    <Badge variant="outline">{dept.totalGoals} metas</Badge>
                  </div>
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <p className="text-gray-600">Taxa de AprovaÃ§Ã£o</p>
                      <p className="text-lg font-bold text-green-600">
                        {dept.approvalRate.toFixed(1)}%
                      </p>
                    </div>
                    <div>
                      <p className="text-gray-600">Taxa de ConclusÃ£o</p>
                      <p className="text-lg font-bold text-blue-600">
                        {dept.completionRate.toFixed(1)}%
                      </p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-12 text-gray-500">
              Sem dados de departamentos no perÃ­odo selecionado
            </div>
          )}
        </CardContent>
      </Card>

      {/* Performance por Categoria */}
      <Card>
        <CardHeader>
          <CardTitle>Tempo MÃ©dio de ConclusÃ£o por Categoria</CardTitle>
          <CardDescription>AnÃ¡lise de eficiÃªncia por tipo de meta</CardDescription>
        </CardHeader>
        <CardContent>
          {byCategory.length > 0 ? (
            <div className="space-y-3">
              {byCategory.map((cat: any) => (
                <div key={cat.category} className="flex items-center gap-4">
                  <div className="w-40">
                    <Badge className="bg-[#F39200]">{cat.category}</Badge>
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <Clock className="w-4 h-4 text-gray-400" />
                      <span className="font-semibold">{cat.avgDays} dias</span>
                      <span className="text-sm text-gray-600">
                        ({cat.totalGoals} metas)
                      </span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-12 text-gray-500">
              Sem dados de categorias no perÃ­odo selecionado
            </div>
          )}
        </CardContent>
      </Card>

      {/* Metas em Risco */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <AlertCircle className="w-5 h-5 text-red-600" />
            Metas em Risco
          </CardTitle>
          <CardDescription>Metas atrasadas ou sem progresso</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 gap-4">
            <div className="p-4 border rounded-lg">
              <div className="flex items-center gap-2 mb-2">
                <XCircle className="w-5 h-5 text-red-600" />
                <h4 className="font-semibold">Atrasadas</h4>
              </div>
              <p className="text-3xl font-bold text-red-600">{stats.overdueGoals}</p>
              <p className="text-sm text-gray-600 mt-1">
                {stats.totalGoals > 0
                  ? ((stats.overdueGoals / stats.totalGoals) * 100).toFixed(1)
                  : 0}
                % do total
              </p>
            </div>

            <div className="p-4 border rounded-lg">
              <div className="flex items-center gap-2 mb-2">
                <Calendar className="w-5 h-5 text-yellow-600" />
                <h4 className="font-semibold">Em Andamento</h4>
              </div>
              <p className="text-3xl font-bold text-yellow-600">{stats.inProgressGoals}</p>
              <p className="text-sm text-gray-600 mt-1">
                {stats.totalGoals > 0
                  ? ((stats.inProgressGoals / stats.totalGoals) * 100).toFixed(1)
                  : 0}
                % do total
              </p>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/AprovacaoCalibracoes.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { CheckCircle, XCircle, Clock, AlertTriangle, FileText } from "lucide-react";
import { toast } from "sonner";
import { useAuth } from "@/_core/hooks/useAuth";

/**
 * PÃ¡gina de AprovaÃ§Ã£o de CalibraÃ§Ãµes
 * Para Diretor de Gente e Diretor de Ãrea
 */
export default function AprovacaoCalibracoes() {
  const { user } = useAuth();
  const [selectedApproval, setSelectedApproval] = useState<any>(null);
  const [isApproveDialogOpen, setIsApproveDialogOpen] = useState(false);
  const [isRejectDialogOpen, setIsRejectDialogOpen] = useState(false);
  const [evidence, setEvidence] = useState("");
  const [comments, setComments] = useState("");

  const utils = trpc.useUtils();

  // Queries
  const { data: pendingMovements, isLoading } =
    trpc.calibrationDiretoria.listPendingMovements.useQuery();

  // Mutations
  const approveMutation = trpc.calibrationDiretoria.approveMovement.useMutation({
    onSuccess: () => {
      toast.success("MovimentaÃ§Ã£o aprovada com sucesso!");
      setIsApproveDialogOpen(false);
      setSelectedApproval(null);
      setEvidence("");
      setComments("");
      utils.calibrationDiretoria.listPendingMovements.invalidate();
    },
    onError: (error) => {
      toast.error(`Erro: ${error.message}`);
    },
  });

  const rejectMutation = trpc.calibrationDiretoria.rejectMovement.useMutation({
    onSuccess: () => {
      toast.success("MovimentaÃ§Ã£o rejeitada");
      setIsRejectDialogOpen(false);
      setSelectedApproval(null);
      setComments("");
      utils.calibrationDiretoria.listPendingMovements.invalidate();
    },
    onError: (error) => {
      toast.error(`Erro: ${error.message}`);
    },
  });

  const handleApprove = (approval: any) => {
    setSelectedApproval(approval);
    setEvidence("");
    setComments("");
    setIsApproveDialogOpen(true);
  };

  const handleReject = (approval: any) => {
    setSelectedApproval(approval);
    setComments("");
    setIsRejectDialogOpen(true);
  };

  const handleSubmitApproval = () => {
    if (!selectedApproval) return;

    // Verificar se Ã© Diretor de Ãrea e exigir evidÃªncias
    if (selectedApproval.approverRole === "area_director" && !evidence) {
      toast.error("EvidÃªncias sÃ£o obrigatÃ³rias para Diretor de Ãrea");
      return;
    }

    approveMutation.mutate({
      approvalId: selectedApproval.id,
      evidence: evidence || undefined,
      comments: comments || undefined,
    });
  };

  const handleSubmitRejection = () => {
    if (!selectedApproval) return;

    if (comments.length < 10) {
      toast.error("ComentÃ¡rio deve ter no mÃ­nimo 10 caracteres");
      return;
    }

    rejectMutation.mutate({
      approvalId: selectedApproval.id,
      comments,
    });
  };

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "pending":
        return (
          <Badge variant="outline" className="bg-yellow-50 text-yellow-700 border-yellow-300">
            <Clock className="w-3 h-3 mr-1" />
            Pendente
          </Badge>
        );
      case "approved":
        return (
          <Badge variant="outline" className="bg-green-50 text-green-700 border-green-300">
            <CheckCircle className="w-3 h-3 mr-1" />
            Aprovado
          </Badge>
        );
      case "rejected":
        return (
          <Badge variant="outline" className="bg-red-50 text-red-700 border-red-300">
            <XCircle className="w-3 h-3 mr-1" />
            Rejeitado
          </Badge>
        );
      default:
        return <Badge variant="outline">{status}</Badge>;
    }
  };

  const getRoleName = (role: string) => {
    switch (role) {
      case "hr":
        return "RH";
      case "people_director":
        return "Diretor de Gente";
      case "area_director":
        return "Diretor de Ãrea";
      default:
        return role;
    }
  };

  return (
    <div className="container mx-auto py-6 space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold flex items-center gap-3">
          <CheckCircle className="w-8 h-8 text-[#F39200]" />
          AprovaÃ§Ã£o de CalibraÃ§Ãµes
        </h1>
        <p className="text-gray-600 mt-2">
          Aprove ou rejeite movimentaÃ§Ãµes de colaboradores no Nine Box
        </p>
      </div>

      {/* EstatÃ­sticas */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-gray-600">
              Aguardando AprovaÃ§Ã£o
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-yellow-600">
              {pendingMovements?.filter((m: any) => m.calibrationApprovals?.status === "pending")
                .length || 0}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-gray-600">Aprovadas Hoje</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-green-600">0</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-gray-600">Rejeitadas Hoje</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-red-600">0</div>
          </CardContent>
        </Card>
      </div>

      {/* Lista de AprovaÃ§Ãµes Pendentes */}
      <Card>
        <CardHeader>
          <CardTitle>MovimentaÃ§Ãµes Pendentes</CardTitle>
          <CardDescription>
            Revise e aprove as movimentaÃ§Ãµes de colaboradores
          </CardDescription>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="text-center py-12 text-gray-500">Carregando...</div>
          ) : pendingMovements && pendingMovements.length > 0 ? (
            <div className="space-y-4">
              {pendingMovements.map((movement: any) => {
                const approval = movement.calibrationApprovals;
                const employee = movement.employees;

                return (
                  <div
                    key={movement.calibrationMovements.id}
                    className="border rounded-lg p-6 hover:shadow-md transition-shadow"
                  >
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex-1">
                        <h3 className="font-semibold text-lg">{employee?.name || "Colaborador"}</h3>
                        <p className="text-sm text-gray-600 mt-1">
                          MovimentaÃ§Ã£o solicitada em{" "}
                          {new Date(movement.calibrationMovements.createdAt).toLocaleDateString("pt-BR")}
                        </p>
                      </div>
                      {getStatusBadge(approval?.status || "pending")}
                    </div>

                    {/* Detalhes da MovimentaÃ§Ã£o */}
                    <div className="grid grid-cols-2 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                      <div>
                        <p className="text-xs text-gray-600 mb-1">PosiÃ§Ã£o Atual</p>
                        <p className="font-medium">
                          {movement.calibrationMovements.fromPerformance?.toUpperCase() || "N/A"}{" "}
                          Desempenho â€¢{" "}
                          {movement.calibrationMovements.fromPotential?.toUpperCase() || "N/A"}{" "}
                          Potencial
                        </p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-600 mb-1">Nova PosiÃ§Ã£o</p>
                        <p className="font-medium text-[#F39200]">
                          {movement.calibrationMovements.toPerformance?.toUpperCase()} Desempenho â€¢{" "}
                          {movement.calibrationMovements.toPotential?.toUpperCase()} Potencial
                        </p>
                      </div>
                    </div>

                    {/* Justificativa */}
                    <div className="mb-4">
                      <p className="text-sm font-medium mb-2">Justificativa:</p>
                      <p className="text-sm text-gray-700 p-3 bg-blue-50 rounded border border-blue-200">
                        {movement.calibrationMovements.justification}
                      </p>
                    </div>

                    {/* NÃ­vel de AprovaÃ§Ã£o */}
                    <div className="mb-4">
                      <p className="text-sm font-medium mb-2">NÃ­vel de AprovaÃ§Ã£o:</p>
                      <Badge variant="secondary">{getRoleName(approval?.approverRole || "")}</Badge>
                    </div>

                    {/* AÃ§Ãµes */}
                    {approval?.status === "pending" && (
                      <div className="flex gap-3 mt-4">
                        <Button
                          onClick={() => handleApprove(approval)}
                          className="bg-green-600 hover:bg-green-700"
                        >
                          <CheckCircle className="w-4 h-4 mr-2" />
                          Aprovar
                        </Button>
                        <Button
                          onClick={() => handleReject(approval)}
                          variant="destructive"
                        >
                          <XCircle className="w-4 h-4 mr-2" />
                          Rejeitar
                        </Button>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="text-center py-12 text-gray-500">
              Nenhuma movimentaÃ§Ã£o pendente de aprovaÃ§Ã£o
            </div>
          )}
        </CardContent>
      </Card>

      {/* Dialog de AprovaÃ§Ã£o */}
      <Dialog open={isApproveDialogOpen} onOpenChange={setIsApproveDialogOpen}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Aprovar MovimentaÃ§Ã£o</DialogTitle>
            <DialogDescription>
              {selectedApproval?.approverRole === "area_director"
                ? "Como Diretor de Ãrea, vocÃª deve obrigatoriamente inserir evidÃªncias"
                : "Confirme a aprovaÃ§Ã£o da movimentaÃ§Ã£o"}
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            {/* EvidÃªncias (obrigatÃ³rio para Diretor de Ãrea) */}
            {selectedApproval?.approverRole === "area_director" && (
              <div>
                <label className="text-sm font-medium mb-2 block flex items-center gap-2">
                  <FileText className="w-4 h-4" />
                  EvidÃªncias <span className="text-red-500">*</span>
                </label>
                <Textarea
                  placeholder="Descreva as evidÃªncias que justificam esta movimentaÃ§Ã£o..."
                  value={evidence}
                  onChange={(e) => setEvidence(e.target.value)}
                  rows={4}
                  className="resize-none"
                />
                <div className="flex items-center gap-2 mt-2">
                  <AlertTriangle className="w-4 h-4 text-yellow-600" />
                  <p className="text-xs text-yellow-700">
                    EvidÃªncias sÃ£o obrigatÃ³rias para Diretor de Ãrea
                  </p>
                </div>
              </div>
            )}

            {/* ComentÃ¡rios (opcional) */}
            <div>
              <label className="text-sm font-medium mb-2 block">
                ComentÃ¡rios (opcional)
              </label>
              <Textarea
                placeholder="Adicione comentÃ¡rios adicionais se necessÃ¡rio..."
                value={comments}
                onChange={(e) => setComments(e.target.value)}
                rows={3}
                className="resize-none"
              />
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setIsApproveDialogOpen(false)}>
              Cancelar
            </Button>
            <Button
              onClick={handleSubmitApproval}
              disabled={
                approveMutation.isPending ||
                (selectedApproval?.approverRole === "area_director" && !evidence)
              }
              className="bg-green-600 hover:bg-green-700"
            >
              {approveMutation.isPending ? "Aprovando..." : "Confirmar AprovaÃ§Ã£o"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog de RejeiÃ§Ã£o */}
      <Dialog open={isRejectDialogOpen} onOpenChange={setIsRejectDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Rejeitar MovimentaÃ§Ã£o</DialogTitle>
            <DialogDescription>
              Informe o motivo da rejeiÃ§Ã£o (obrigatÃ³rio)
            </DialogDescription>
          </DialogHeader>

          <div className="py-4">
            <Textarea
              placeholder="Descreva o motivo da rejeiÃ§Ã£o (mÃ­nimo 10 caracteres)..."
              value={comments}
              onChange={(e) => setComments(e.target.value)}
              rows={4}
              className="resize-none"
            />
            <p className="text-xs text-gray-500 mt-1">{comments.length} caracteres</p>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setIsRejectDialogOpen(false)}>
              Cancelar
            </Button>
            <Button
              onClick={handleSubmitRejection}
              disabled={rejectMutation.isPending || comments.length < 10}
              variant="destructive"
            >
              {rejectMutation.isPending ? "Rejeitando..." : "Confirmar RejeiÃ§Ã£o"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/AprovarMetas.tsx
========================================
import { useState } from "react";
import { Link } from "wouter";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { toast } from "sonner";
import {
  CheckCircle2,
  XCircle,
  Clock,
  Target,
  TrendingUp,
  Calendar,
  User,
  AlertCircle,
  FileText,
} from "lucide-react";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

/**
 * PÃ¡gina de AprovaÃ§Ã£o de Metas para Gestores/RH
 * Lista metas pendentes de aprovaÃ§Ã£o e permite aprovar/rejeitar
 */
export default function AprovarMetas() {
  const [cycleFilter, setCycleFilter] = useState<number | undefined>(undefined);
  const [categoryFilter, setCategoryFilter] = useState<string | undefined>(undefined);
  const [selectedGoal, setSelectedGoal] = useState<any>(null);
  const [showApproveDialog, setShowApproveDialog] = useState(false);
  const [showRejectDialog, setShowRejectDialog] = useState(false);
  const [comments, setComments] = useState("");

  // Buscar metas pendentes de aprovaÃ§Ã£o
  const { data: goals = [], isLoading, refetch } = trpc.smartGoals.list.useQuery({
    status: "pending_approval",
    cycleId: cycleFilter,
    category: categoryFilter as any,
  });

  // Buscar ciclos
  const { data: cycles = [] } = trpc.evaluationCycles.list.useQuery();

  // Aprovar meta
  const approveMutation = trpc.smartGoals.approve.useMutation({
    onSuccess: () => {
      toast.success("Meta aprovada com sucesso!");
      setShowApproveDialog(false);
      setComments("");
      setSelectedGoal(null);
      refetch();
    },
    onError: (error: any) => {
      toast.error("Erro ao aprovar meta", {
        description: error.message,
      });
    },
  });

  // Rejeitar meta
  const rejectMutation = trpc.smartGoals.reject.useMutation({
    onSuccess: () => {
      toast.success("Meta rejeitada");
      setShowRejectDialog(false);
      setComments("");
      setSelectedGoal(null);
      refetch();
    },
    onError: (error: any) => {
      toast.error("Erro ao rejeitar meta", {
        description: error.message,
      });
    },
  });

  const handleApprove = async () => {
    if (!selectedGoal) return;

    await approveMutation.mutateAsync({
      goalId: selectedGoal.id,
      comments: comments || undefined,
    });
  };

  const handleReject = async () => {
    if (!selectedGoal) return;

    if (!comments.trim()) {
      toast.error("Informe o motivo da rejeiÃ§Ã£o");
      return;
    }

    await rejectMutation.mutateAsync({
      goalId: selectedGoal.id,
      comments,
    });
  };

  const getCategoryLabel = (category: string) => {
    const labels: Record<string, string> = {
      financial: "Financeira",
      behavioral: "Comportamental",
      corporate: "Corporativa",
      development: "Desenvolvimento",
    };
    return labels[category] || category;
  };

  const getCategoryColor = (category: string) => {
    const colors: Record<string, string> = {
      financial: "text-green-600",
      behavioral: "text-blue-600",
      corporate: "text-purple-600",
      development: "text-orange-600",
    };
    return colors[category] || "text-gray-600";
  };

  const smartScore = (goal: any) =>
    [goal.isSpecific, goal.isMeasurable, goal.isAchievable, goal.isRelevant, goal.isTimeBound].filter(
      Boolean
    ).length * 20;

  if (isLoading) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {[1, 2, 3].map((i) => (
              <div key={i} className="h-32 bg-gray-200 rounded"></div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold text-gray-900">AprovaÃ§Ã£o de Metas</h1>
        <p className="text-gray-600 mt-1">
          Revise e aprove metas enviadas pelos colaboradores
        </p>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Pendentes de AprovaÃ§Ã£o</CardTitle>
            <Clock className="h-4 w-4 text-yellow-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{goals.length}</div>
            <p className="text-xs text-gray-500 mt-1">Aguardando sua anÃ¡lise</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Metas com BÃ´nus</CardTitle>
            <TrendingUp className="h-4 w-4 text-green-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {goals.filter((g) => g.bonusEligible).length}
            </div>
            <p className="text-xs text-gray-500 mt-1">ElegÃ­veis para bÃ´nus financeiro</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Score SMART MÃ©dio</CardTitle>
            <Target className="h-4 w-4 text-purple-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {goals.length > 0
                ? Math.round(goals.reduce((sum, g) => sum + smartScore(g), 0) / goals.length)
                : 0}
              /100
            </div>
            <p className="text-xs text-gray-500 mt-1">Qualidade das metas</p>
          </CardContent>
        </Card>
      </div>

      {/* Filtros */}
      <Card>
        <CardHeader>
          <CardTitle>Filtros</CardTitle>
        </CardHeader>
        <CardContent className="flex flex-wrap gap-4">
          <div className="w-full md:w-auto">
            <Label className="text-sm font-medium mb-2 block">Ciclo</Label>
            <Select
              value={cycleFilter?.toString() || "all"}
              onValueChange={(v) => setCycleFilter(v === "all" ? undefined : Number(v))}
            >
              <SelectTrigger className="w-[200px]">
                <SelectValue placeholder="Todos os ciclos" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todos os ciclos</SelectItem>
                {cycles.map((cycle: any) => (
                  <SelectItem key={cycle.id} value={cycle.id.toString()}>
                    {cycle.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="w-full md:w-auto">
            <Label className="text-sm font-medium mb-2 block">Categoria</Label>
            <Select
              value={categoryFilter || "all"}
              onValueChange={(v) => setCategoryFilter(v === "all" ? undefined : v)}
            >
              <SelectTrigger className="w-[200px]">
                <SelectValue placeholder="Todas as categorias" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todas as categorias</SelectItem>
                <SelectItem value="financial">Financeira</SelectItem>
                <SelectItem value="behavioral">Comportamental</SelectItem>
                <SelectItem value="corporate">Corporativa</SelectItem>
                <SelectItem value="development">Desenvolvimento</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardContent>
      </Card>

      {/* Lista de Metas */}
      <div className="space-y-4">
        <h2 className="text-xl font-bold">Metas Pendentes ({goals.length})</h2>

        {goals.length === 0 ? (
          <Card>
            <CardContent className="text-center py-12">
              <CheckCircle2 className="w-16 h-16 text-green-300 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-gray-900 mb-2">
                Nenhuma meta pendente
              </h3>
              <p className="text-gray-600">Todas as metas foram revisadas</p>
            </CardContent>
          </Card>
        ) : (
          goals.map((goal: any) => (
            <Card key={goal.id} className="hover:shadow-lg transition-shadow">
              <CardHeader>
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <CardTitle className="text-lg">{goal.title}</CardTitle>
                      <Badge className="bg-yellow-500">Aguardando AprovaÃ§Ã£o</Badge>
                      {goal.bonusEligible && (
                        <Badge variant="outline" className="bg-green-50 text-green-700">
                          ðŸ’° BÃ´nus
                        </Badge>
                      )}
                      <Badge variant="outline">
                        SMART: {smartScore(goal)}/100
                      </Badge>
                    </div>
                    <CardDescription className="line-clamp-2">
                      {goal.description}
                    </CardDescription>
                  </div>
                  <span className={`text-sm font-medium ${getCategoryColor(goal.category)}`}>
                    {getCategoryLabel(goal.category)}
                  </span>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                {/* InformaÃ§Ãµes do Colaborador */}
                <div className="flex items-center gap-4 text-sm">
                  <div className="flex items-center gap-2">
                    <User className="w-4 h-4 text-gray-400" />
                    <span className="text-gray-600">Colaborador:</span>
                    <span className="font-semibold">{goal.employeeName || "N/A"}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <Calendar className="w-4 h-4 text-gray-400" />
                    <span className="text-gray-600">PerÃ­odo:</span>
                    <span className="font-semibold">
                      {format(new Date(goal.startDate), "dd/MM/yyyy", { locale: ptBR })} -{" "}
                      {format(new Date(goal.endDate), "dd/MM/yyyy", { locale: ptBR })}
                    </span>
                  </div>
                </div>

                {/* MÃ©tricas */}
                {goal.measurementUnit && goal.targetValue && (
                  <div className="flex items-center gap-4 text-sm bg-blue-50 p-3 rounded-lg">
                    <div className="flex items-center gap-2">
                      <Target className="w-4 h-4 text-blue-600" />
                      <span className="text-blue-700">Meta:</span>
                      <span className="font-semibold text-blue-900">
                        {goal.targetValue} {goal.measurementUnit}
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-blue-700">Peso:</span>
                      <span className="font-semibold text-blue-900">{goal.weight}%</span>
                    </div>
                  </div>
                )}

                {/* CritÃ©rios SMART */}
                <div className="flex gap-2 flex-wrap">
                  {goal.isSpecific && (
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      âœ“ EspecÃ­fica
                    </Badge>
                  )}
                  {goal.isMeasurable && (
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      âœ“ MensurÃ¡vel
                    </Badge>
                  )}
                  {goal.isAchievable && (
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      âœ“ AtingÃ­vel
                    </Badge>
                  )}
                  {goal.isRelevant && (
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      âœ“ Relevante
                    </Badge>
                  )}
                  {goal.isTimeBound && (
                    <Badge variant="outline" className="bg-green-50 text-green-700">
                      âœ“ Temporal
                    </Badge>
                  )}
                </div>

                {/* AÃ§Ãµes */}
                <div className="flex gap-2 pt-2">
                  <Link href={`/metas/${goal.id}`}>
                    <Button variant="outline" size="sm">
                      <FileText className="w-4 h-4 mr-2" />
                      Ver Detalhes
                    </Button>
                  </Link>

                  <Dialog
                    open={showApproveDialog && selectedGoal?.id === goal.id}
                    onOpenChange={(open) => {
                      setShowApproveDialog(open);
                      if (!open) {
                        setSelectedGoal(null);
                        setComments("");
                      }
                    }}
                  >
                    <DialogTrigger asChild>
                      <Button
                        size="sm"
                        className="bg-green-600 hover:bg-green-700"
                        onClick={() => setSelectedGoal(goal)}
                      >
                        <CheckCircle2 className="w-4 h-4 mr-2" />
                        Aprovar
                      </Button>
                    </DialogTrigger>
                    <DialogContent>
                      <DialogHeader>
                        <DialogTitle>Aprovar Meta</DialogTitle>
                        <DialogDescription>
                          Confirme a aprovaÃ§Ã£o da meta: <strong>{goal.title}</strong>
                        </DialogDescription>
                      </DialogHeader>
                      <div className="space-y-4">
                        <div>
                          <Label htmlFor="approve-comments">ComentÃ¡rios (Opcional)</Label>
                          <Textarea
                            id="approve-comments"
                            placeholder="Adicione observaÃ§Ãµes ou orientaÃ§Ãµes..."
                            value={comments}
                            onChange={(e) => setComments(e.target.value)}
                            rows={3}
                            className="mt-1"
                          />
                        </div>
                        <div className="flex justify-end gap-2">
                          <Button
                            variant="outline"
                            onClick={() => {
                              setShowApproveDialog(false);
                              setComments("");
                              setSelectedGoal(null);
                            }}
                          >
                            Cancelar
                          </Button>
                          <Button
                            onClick={handleApprove}
                            disabled={approveMutation.isPending}
                            className="bg-green-600 hover:bg-green-700"
                          >
                            {approveMutation.isPending ? "Aprovando..." : "Confirmar AprovaÃ§Ã£o"}
                          </Button>
                        </div>
                      </div>
                    </DialogContent>
                  </Dialog>

                  <Dialog
                    open={showRejectDialog && selectedGoal?.id === goal.id}
                    onOpenChange={(open) => {
                      setShowRejectDialog(open);
                      if (!open) {
                        setSelectedGoal(null);
                        setComments("");
                      }
                    }}
                  >
                    <DialogTrigger asChild>
                      <Button
                        size="sm"
                        variant="destructive"
                        onClick={() => setSelectedGoal(goal)}
                      >
                        <XCircle className="w-4 h-4 mr-2" />
                        Rejeitar
                      </Button>
                    </DialogTrigger>
                    <DialogContent>
                      <DialogHeader>
                        <DialogTitle>Rejeitar Meta</DialogTitle>
                        <DialogDescription>
                          Informe o motivo da rejeiÃ§Ã£o da meta: <strong>{goal.title}</strong>
                        </DialogDescription>
                      </DialogHeader>
                      <div className="space-y-4">
                        <div className="bg-yellow-50 p-4 rounded-lg">
                          <div className="flex items-start gap-2">
                            <AlertCircle className="w-5 h-5 text-yellow-600 mt-0.5" />
                            <div>
                              <p className="text-sm font-medium text-yellow-900">AtenÃ§Ã£o</p>
                              <p className="text-sm text-yellow-700 mt-1">
                                O colaborador serÃ¡ notificado e deverÃ¡ revisar a meta antes de
                                reenviar para aprovaÃ§Ã£o.
                              </p>
                            </div>
                          </div>
                        </div>
                        <div>
                          <Label htmlFor="reject-comments">Motivo da RejeiÃ§Ã£o *</Label>
                          <Textarea
                            id="reject-comments"
                            placeholder="Explique o motivo da rejeiÃ§Ã£o e as melhorias necessÃ¡rias..."
                            value={comments}
                            onChange={(e) => setComments(e.target.value)}
                            rows={4}
                            className="mt-1"
                            required
                          />
                        </div>
                        <div className="flex justify-end gap-2">
                          <Button
                            variant="outline"
                            onClick={() => {
                              setShowRejectDialog(false);
                              setComments("");
                              setSelectedGoal(null);
                            }}
                          >
                            Cancelar
                          </Button>
                          <Button
                            onClick={handleReject}
                            disabled={rejectMutation.isPending}
                            variant="destructive"
                          >
                            {rejectMutation.isPending ? "Rejeitando..." : "Confirmar RejeiÃ§Ã£o"}
                          </Button>
                        </div>
                      </div>
                    </DialogContent>
                  </Dialog>
                </div>
              </CardContent>
            </Card>
          ))
        )}
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/AtualizarProgressoMeta.tsx
========================================
import { useState } from "react";
import { useParams, useLocation } from "wouter";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Progress } from "@/components/ui/progress";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { toast } from "sonner";
import {
  ArrowLeft,
  Save,
  AlertCircle,
  TrendingUp,
  Target,
  CheckCircle2,
  Plus,
  Calendar,
} from "lucide-react";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

/**
 * PÃ¡gina de AtualizaÃ§Ã£o de Progresso da Meta
 * Permite atualizar progresso, valor atual e adicionar marcos
 */
export default function AtualizarProgressoMeta() {
  const { id } = useParams();
  const [, navigate] = useLocation();
  const goalId = parseInt(id || "0");

  const [progress, setProgress] = useState("");
  const [currentValue, setCurrentValue] = useState("");
  const [comment, setComment] = useState("");

  // Buscar meta
  const { data: goal, isLoading, refetch } = trpc.smartGoals.getById.useQuery({ goalId });

  // Atualizar progresso
  const updateProgressMutation = trpc.smartGoals.updateProgress.useMutation({
    onSuccess: () => {
      toast.success("Progresso atualizado com sucesso!");
      setProgress("");
      setCurrentValue("");
      setComment("");
      refetch();
    },
    onError: (error: any) => {
      toast.error("Erro ao atualizar progresso", {
        description: error.message,
      });
    },
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!progress) {
      toast.error("Informe o progresso atual");
      return;
    }

    const progressNum = parseInt(progress);
    if (progressNum < 0 || progressNum > 100) {
      toast.error("Progresso deve estar entre 0 e 100");
      return;
    }

    const payload: any = {
      goalId,
      progress: progressNum,
    };
    if (currentValue) payload.currentValue = parseFloat(currentValue);
    if (comment) payload.comment = comment;

    await updateProgressMutation.mutateAsync(payload);
  };

  if (isLoading) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  if (!goal) {
    return (
      <div className="container mx-auto p-6">
        <Card>
          <CardContent className="text-center py-12">
            <AlertCircle className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">Meta nÃ£o encontrada</h3>
            <Button onClick={() => navigate("/metas")}>Voltar para Metas</Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!["approved", "in_progress"].includes(goal.status)) {
    return (
      <div className="container mx-auto p-6">
        <Card>
          <CardContent className="text-center py-12">
            <AlertCircle className="w-16 h-16 text-yellow-300 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">
              Meta nÃ£o disponÃ­vel para atualizaÃ§Ã£o
            </h3>
            <p className="text-gray-600 mb-4">
              Apenas metas aprovadas ou em andamento podem ter progresso atualizado
            </p>
            <Button onClick={() => navigate(`/metas/${goalId}`)}>Ver Detalhes</Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  const progressPercentage = goal.progress || 0;

  return (
    <div className="container mx-auto p-6 max-w-4xl">
      {/* Header */}
      <div className="mb-6">
        <Button variant="ghost" onClick={() => navigate(`/metas/${goalId}`)} className="mb-4">
          <ArrowLeft className="w-4 h-4 mr-2" />
          Voltar
        </Button>
        <h1 className="text-3xl font-bold text-gray-900">Atualizar Progresso</h1>
        <p className="text-gray-600 mt-1">{goal.title}</p>
      </div>

      {/* Progresso Atual */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <TrendingUp className="w-5 h-5" />
            Progresso Atual
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <span className="text-2xl font-bold">{progressPercentage}%</span>
              <Badge
                variant={
                  progressPercentage === 100
                    ? "default"
                    : progressPercentage >= 50
                    ? "secondary"
                    : "outline"
                }
              >
                {progressPercentage === 100
                  ? "ConcluÃ­da"
                  : progressPercentage >= 50
                  ? "Em Andamento"
                  : "Iniciando"}
              </Badge>
            </div>
            <Progress value={progressPercentage} className="h-3" />

            {goal.measurementUnit && goal.targetValue && (
              <div className="grid grid-cols-2 gap-4 pt-4">
                <div className="p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-blue-700 mb-1">Valor Atual</p>
                  <p className="text-2xl font-bold text-blue-900">
                    {goal.currentValue || 0} {goal.measurementUnit}
                  </p>
                </div>
                <div className="p-4 bg-green-50 rounded-lg">
                  <p className="text-sm text-green-700 mb-1">Valor Alvo</p>
                  <p className="text-2xl font-bold text-green-900">
                    {goal.targetValue} {goal.measurementUnit}
                  </p>
                </div>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* FormulÃ¡rio de AtualizaÃ§Ã£o */}
      <form onSubmit={handleSubmit} className="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>Nova AtualizaÃ§Ã£o</CardTitle>
            <CardDescription>
              Registre o progresso atual e adicione observaÃ§Ãµes relevantes
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="progress">Progresso (%) *</Label>
                <Input
                  id="progress"
                  type="number"
                  min="0"
                  max="100"
                  placeholder="Ex: 75"
                  value={progress}
                  onChange={(e) => setProgress(e.target.value)}
                  className="mt-1"
                  required
                />
                <p className="text-xs text-gray-500 mt-1">
                  Valor entre 0 e 100. Atual: {progressPercentage}%
                </p>
              </div>

              {goal.measurementUnit && (
                <div>
                  <Label htmlFor="currentValue">
                    Valor Atual ({goal.measurementUnit})
                  </Label>
                  <Input
                    id="currentValue"
                    type="number"
                    step="0.01"
                    placeholder={`Ex: ${goal.targetValue || 100}`}
                    value={currentValue}
                    onChange={(e) => setCurrentValue(e.target.value)}
                    className="mt-1"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Atual: {goal.currentValue || 0} / Meta: {goal.targetValue}
                  </p>
                </div>
              )}
            </div>

            <div>
              <Label htmlFor="comment">ComentÃ¡rio (Opcional)</Label>
              <Textarea
                id="comment"
                placeholder="Descreva as aÃ§Ãµes realizadas, desafios enfrentados ou prÃ³ximos passos..."
                value={comment}
                onChange={(e) => setComment(e.target.value)}
                rows={4}
                className="mt-1"
              />
              <p className="text-xs text-gray-500 mt-1">
                Registre informaÃ§Ãµes importantes sobre esta atualizaÃ§Ã£o
              </p>
            </div>

            <div className="bg-blue-50 p-4 rounded-lg">
              <div className="flex items-start gap-2">
                <AlertCircle className="w-5 h-5 text-blue-600 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-blue-900">Dica</p>
                  <p className="text-sm text-blue-700 mt-1">
                    Atualize o progresso regularmente para manter gestores e RH informados.
                    Quando atingir 100%, a meta serÃ¡ marcada como concluÃ­da automaticamente.
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        <div className="flex justify-end gap-2">
          <Button
            type="button"
            variant="outline"
            onClick={() => navigate(`/metas/${goalId}`)}
          >
            Cancelar
          </Button>
          <Button
            type="submit"
            disabled={updateProgressMutation.isPending}
            className="bg-[#F39200] hover:bg-[#d67e00]"
          >
            <Save className="w-4 h-4 mr-2" />
            {updateProgressMutation.isPending ? "Salvando..." : "Salvar AtualizaÃ§Ã£o"}
          </Button>
        </div>
      </form>

      {/* HistÃ³rico de AtualizaÃ§Ãµes */}
      {goal.comments && goal.comments.length > 0 && (
        <Card className="mt-6">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Calendar className="w-5 h-5" />
              HistÃ³rico de AtualizaÃ§Ãµes ({goal.comments.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {goal.comments
                .slice()
                .reverse()
                .map((commentItem: any) => (
                  <div key={commentItem.id} className="p-4 border rounded-lg">
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-semibold">{commentItem.authorName || "UsuÃ¡rio"}</span>
                      <span className="text-xs text-gray-500">
                        {format(new Date(commentItem.createdAt), "dd/MM/yyyy 'Ã s' HH:mm", {
                          locale: ptBR,
                        })}
                      </span>
                    </div>
                    <p className="text-sm text-gray-700 whitespace-pre-wrap">
                      {commentItem.comment}
                    </p>
                  </div>
                ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Marcos */}
      {goal.milestones && goal.milestones.length > 0 && (
        <Card className="mt-6">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Target className="w-5 h-5" />
              Marcos IntermediÃ¡rios ({goal.milestones.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {goal.milestones.map((milestone: any) => (
                <div key={milestone.id} className="flex items-center gap-4 p-4 border rounded-lg">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <h4 className="font-semibold">{milestone.title}</h4>
                      {milestone.status === "completed" && (
                        <CheckCircle2 className="w-4 h-4 text-green-600" />
                      )}
                    </div>
                    {milestone.description && (
                      <p className="text-sm text-gray-600 mb-2">{milestone.description}</p>
                    )}
                    <div className="flex items-center gap-4 text-xs text-gray-500">
                      <span>
                        Prazo:{" "}
                        {format(new Date(milestone.dueDate), "dd/MM/yyyy", { locale: ptBR })}
                      </span>
                      <span>Progresso: {milestone.progress || 0}%</span>
                    </div>
                  </div>
                  <Progress value={milestone.progress || 0} className="w-24 h-2" />
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/AuditTrail.tsx
========================================
import { useState } from "react";
import { Download, Filter, Search, Eye } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { trpc } from "@/lib/trpc";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";
import { toast } from "sonner";

export default function AuditTrail() {
  const [filters, setFilters] = useState({
    action: "all",
    entity: "all",
    userId: undefined as number | undefined,
  });
  const [page, setPage] = useState(0);
  const [selectedLog, setSelectedLog] = useState<number | null>(null);
  const pageSize = 50;

  // Buscar logs com filtros
  const { data, isLoading } = trpc.auditTrail.getLogs.useQuery({
    ...filters,
    limit: pageSize,
    offset: page * pageSize,
  });

  // Buscar detalhes de um log
  const { data: logDetails } = trpc.auditTrail.getLogDetails.useQuery(
    { id: selectedLog! },
    { enabled: selectedLog !== null }
  );

  const logs = data?.logs || [];
  const total = data?.total || 0;
  const totalPages = Math.ceil(total / pageSize);

  const handleExportCSV = () => {
    if (logs.length === 0) {
      toast.error("Nenhum log para exportar");
      return;
    }

    // Criar CSV
    const headers = ["ID", "UsuÃ¡rio", "AÃ§Ã£o", "Entidade", "Entidade ID", "Data", "IP"];
    const rows = logs.map((log) => [
      log.id,
      log.userId || "Sistema",
      log.action,
      log.entity,
      log.entityId || "-",
      format(new Date(log.createdAt), "dd/MM/yyyy HH:mm:ss", { locale: ptBR }),
      log.ipAddress || "-",
    ]);

    const csvContent = [
      headers.join(","),
      ...rows.map((row) => row.join(",")),
    ].join("\n");

    // Download
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `audit-trail-${format(new Date(), "yyyy-MM-dd")}.csv`;
    link.click();

    toast.success("CSV exportado com sucesso!");
  };

  const getActionBadge = (action: string) => {
    const variants: Record<string, "default" | "secondary" | "destructive" | "outline"> = {
      create: "default",
      update: "secondary",
      delete: "destructive",
      login: "outline",
    };
    return variants[action.toLowerCase()] || "outline";
  };

  return (
    <div className="container py-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">HistÃ³rico de AlteraÃ§Ãµes</h1>
          <p className="text-muted-foreground">
            Registro completo de todas as aÃ§Ãµes realizadas no sistema
          </p>
        </div>
        <Button onClick={handleExportCSV} disabled={logs.length === 0}>
          <Download className="mr-2 h-4 w-4" />
          Exportar CSV
        </Button>
      </div>

      {/* Filtros */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Filter className="h-5 w-5" />
            Filtros
          </CardTitle>
          <CardDescription>Filtre os logs por aÃ§Ã£o, entidade ou usuÃ¡rio</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label className="text-sm font-medium mb-2 block">AÃ§Ã£o</label>
              <Select
                value={filters.action}
                onValueChange={(value) => setFilters({ ...filters, action: value })}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Todas as aÃ§Ãµes" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todas</SelectItem>
                  <SelectItem value="create">Criar</SelectItem>
                  <SelectItem value="update">Atualizar</SelectItem>
                  <SelectItem value="delete">Excluir</SelectItem>
                  <SelectItem value="login">Login</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">Entidade</label>
              <Select
                value={filters.entity}
                onValueChange={(value) => setFilters({ ...filters, entity: value })}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Todas as entidades" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todas</SelectItem>
                  <SelectItem value="goal">Metas</SelectItem>
                  <SelectItem value="evaluation">AvaliaÃ§Ãµes</SelectItem>
                  <SelectItem value="pdi">PDI</SelectItem>
                  <SelectItem value="employee">Colaboradores</SelectItem>
                  <SelectItem value="user">UsuÃ¡rios</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">ID do UsuÃ¡rio</label>
              <Input
                type="number"
                placeholder="Digite o ID do usuÃ¡rio"
                value={filters.userId || ""}
                onChange={(e) =>
                  setFilters({
                    ...filters,
                    userId: e.target.value ? parseInt(e.target.value) : undefined,
                  })
                }
              />
            </div>
          </div>

          <div className="mt-4 flex gap-2">
            <Button
              variant="outline"
              onClick={() => {
                setFilters({ action: "all", entity: "all", userId: undefined });
                setPage(0);
              }}
            >
              Limpar Filtros
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Tabela de Logs */}
      <Card>
        <CardHeader>
          <CardTitle>Logs de Auditoria</CardTitle>
          <CardDescription>
            {total} registro{total !== 1 ? "s" : ""} encontrado{total !== 1 ? "s" : ""}
          </CardDescription>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="text-center py-8 text-muted-foreground">Carregando...</div>
          ) : logs.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">
              Nenhum log encontrado com os filtros aplicados
            </div>
          ) : (
            <>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>ID</TableHead>
                    <TableHead>UsuÃ¡rio</TableHead>
                    <TableHead>AÃ§Ã£o</TableHead>
                    <TableHead>Entidade</TableHead>
                    <TableHead>Entidade ID</TableHead>
                    <TableHead>Data/Hora</TableHead>
                    <TableHead>IP</TableHead>
                    <TableHead className="text-right">AÃ§Ãµes</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {logs.map((log) => (
                    <TableRow key={log.id}>
                      <TableCell className="font-mono text-sm">{log.id}</TableCell>
                      <TableCell>{log.userId || "Sistema"}</TableCell>
                      <TableCell>
                        <Badge variant={getActionBadge(log.action)}>{log.action}</Badge>
                      </TableCell>
                      <TableCell>{log.entity}</TableCell>
                      <TableCell>{log.entityId || "-"}</TableCell>
                      <TableCell className="text-sm">
                        {format(new Date(log.createdAt), "dd/MM/yyyy HH:mm:ss", {
                          locale: ptBR,
                        })}
                      </TableCell>
                      <TableCell className="font-mono text-xs">{log.ipAddress || "-"}</TableCell>
                      <TableCell className="text-right">
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setSelectedLog(log.id)}
                        >
                          <Eye className="h-4 w-4" />
                        </Button>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>

              {/* PaginaÃ§Ã£o */}
              {totalPages > 1 && (
                <div className="flex items-center justify-between mt-4">
                  <div className="text-sm text-muted-foreground">
                    PÃ¡gina {page + 1} de {totalPages}
                  </div>
                  <div className="flex gap-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setPage(page - 1)}
                      disabled={page === 0}
                    >
                      Anterior
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setPage(page + 1)}
                      disabled={page >= totalPages - 1}
                    >
                      PrÃ³xima
                    </Button>
                  </div>
                </div>
              )}
            </>
          )}
        </CardContent>
      </Card>

      {/* Dialog de Detalhes */}
      <Dialog open={selectedLog !== null} onOpenChange={() => setSelectedLog(null)}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Detalhes do Log #{selectedLog}</DialogTitle>
            <DialogDescription>InformaÃ§Ãµes completas sobre esta alteraÃ§Ã£o</DialogDescription>
          </DialogHeader>
          {logDetails && (
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">UsuÃ¡rio</p>
                  <p className="text-sm">{logDetails.userId || "Sistema"}</p>
                </div>
                <div>
                  <p className="text-sm font-medium text-muted-foreground">AÃ§Ã£o</p>
                  <Badge variant={getActionBadge(logDetails.action)}>{logDetails.action}</Badge>
                </div>
                <div>
                  <p className="text-sm font-medium text-muted-foreground">Entidade</p>
                  <p className="text-sm">{logDetails.entity}</p>
                </div>
                <div>
                  <p className="text-sm font-medium text-muted-foreground">ID da Entidade</p>
                  <p className="text-sm">{logDetails.entityId || "-"}</p>
                </div>
                <div>
                  <p className="text-sm font-medium text-muted-foreground">Data/Hora</p>
                  <p className="text-sm">
                    {format(new Date(logDetails.createdAt), "dd/MM/yyyy HH:mm:ss", {
                      locale: ptBR,
                    })}
                  </p>
                </div>
                <div>
                  <p className="text-sm font-medium text-muted-foreground">EndereÃ§o IP</p>
                  <p className="text-sm font-mono">{logDetails.ipAddress || "-"}</p>
                </div>
              </div>

              {logDetails.userAgent && (
                <div>
                  <p className="text-sm font-medium text-muted-foreground mb-1">User Agent</p>
                  <p className="text-xs font-mono bg-muted p-2 rounded">{logDetails.userAgent}</p>
                </div>
              )}

              {logDetails.changes && (
                <div>
                  <p className="text-sm font-medium text-muted-foreground mb-1">MudanÃ§as</p>
                  <pre className="text-xs bg-muted p-3 rounded overflow-auto max-h-64">
                    {JSON.stringify(JSON.parse(logDetails.changes), null, 2)}
                  </pre>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/Avaliacao360Autoavaliacao.tsx
========================================
import { useState } from "react";
import { useParams, useLocation } from "wouter";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Loader2, CheckCircle2, Circle, ArrowLeft, ArrowRight } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { toast } from "sonner";

/**
 * AvaliaÃ§Ã£o 360Â° - Etapa 1: AutoavaliaÃ§Ã£o
 * 
 * Fluxo:
 * 1. AutoavaliaÃ§Ã£o (colaborador) â† ESTA PÃGINA
 * 2. AvaliaÃ§Ã£o do Gestor
 * 3. Consenso do LÃ­der
 */

export default function Avaliacao360Autoavaliacao() {
  const params = useParams();
  const [, navigate] = useLocation();
  const evaluationId = parseInt(params.id || "0");

  const [responses, setResponses] = useState<Record<number, number>>({});

  // Queries
  const { data: evaluation, isLoading } = trpc.evaluation360.getEvaluationWithWorkflow.useQuery({ evaluationId });
  const { data: questions } = trpc.evaluation360.getQuestions.useQuery({ evaluationId });

  // Mutation
  const submitMutation = trpc.evaluation360.submitSelfAssessment.useMutation({
    onSuccess: () => {
      toast.success("AutoavaliaÃ§Ã£o enviada com sucesso! O gestor foi notificado por email.");
      navigate("/avaliacoes");
    },
    onError: (error: any) => {
      toast.error(`Erro ao enviar autoavaliaÃ§Ã£o: ${error.message}`);
    },
  });

  const handleSubmit = () => {
    if (!questions || Object.keys(responses).length < questions.length) {
      toast.error("Por favor, responda todas as perguntas antes de enviar.");
      return;
    }

    const answersArray = questions.map((q: any) => ({
      questionId: q.id,
      score: responses[q.id] || 0,
    }));

    submitMutation.mutate({
      evaluationId,
      responses: answersArray,
    });
  };

  const progress = questions ? (Object.keys(responses).length / questions.length) * 100 : 0;

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  if (!evaluation) {
    return (
      <DashboardLayout>
        <Card>
          <CardContent className="py-12 text-center">
            <h3 className="text-lg font-semibold mb-2">AvaliaÃ§Ã£o nÃ£o encontrada</h3>
            <Button onClick={() => navigate("/avaliacoes")}>Voltar</Button>
          </CardContent>
        </Card>
      </DashboardLayout>
    );
  }

  // Verificar se a etapa estÃ¡ correta
  if (evaluation.workflowStatus !== "pending_self") {
    return (
      <DashboardLayout>
        <Card>
          <CardContent className="py-12 text-center">
            <h3 className="text-lg font-semibold mb-2">AutoavaliaÃ§Ã£o jÃ¡ foi concluÃ­da</h3>
            <p className="text-sm text-muted-foreground mb-4">
              Status atual: {evaluation.workflowStatus}
            </p>
            <Button onClick={() => navigate("/avaliacoes")}>Voltar</Button>
          </CardContent>
        </Card>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6 max-w-4xl mx-auto">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={() => navigate("/avaliacoes")}>
            <ArrowLeft className="h-5 w-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-2xl font-bold">AvaliaÃ§Ã£o 360Â° - AutoavaliaÃ§Ã£o</h1>
            <p className="text-sm text-muted-foreground">
              Ciclo {evaluation.cycleId} â€¢ {evaluation.employeeName}
            </p>
          </div>
        </div>

        {/* Stepper - Indicador de Progresso */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <CheckCircle2 className="h-6 w-6 text-primary" />
                <div>
                  <p className="font-semibold">1. AutoavaliaÃ§Ã£o</p>
                  <p className="text-xs text-muted-foreground">Em andamento</p>
                </div>
              </div>
              <div className="flex-1 mx-4 h-0.5 bg-gray-200" />
              <div className="flex items-center gap-2 opacity-50">
                <Circle className="h-6 w-6" />
                <div>
                  <p className="font-semibold">2. AvaliaÃ§Ã£o Gestor</p>
                  <p className="text-xs text-muted-foreground">Pendente</p>
                </div>
              </div>
              <div className="flex-1 mx-4 h-0.5 bg-gray-200" />
              <div className="flex items-center gap-2 opacity-50">
                <Circle className="h-6 w-6" />
                <div>
                  <p className="font-semibold">3. Consenso LÃ­der</p>
                  <p className="text-xs text-muted-foreground">Pendente</p>
                </div>
              </div>
            </div>
            <Progress value={33} className="h-2" />
          </CardContent>
        </Card>

        {/* Progresso das Respostas */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm font-medium">Progresso das Respostas</p>
              <p className="text-sm text-muted-foreground">
                {Object.keys(responses).length} de {questions?.length || 0} perguntas
              </p>
            </div>
            <Progress value={progress} className="h-2" />
          </CardContent>
        </Card>

        {/* InstruÃ§Ãµes */}
        <Card className="bg-blue-50 border-blue-200">
          <CardContent className="pt-6">
            <h3 className="font-semibold mb-2 text-blue-900">InstruÃ§Ãµes</h3>
            <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
              <li>Avalie seu prÃ³prio desempenho de forma honesta e objetiva</li>
              <li>Use a escala de 1 (InsatisfatÃ³rio) a 5 (Excepcional)</li>
              <li>Responda todas as perguntas antes de enviar</li>
              <li>ApÃ³s enviar, seu gestor serÃ¡ notificado por email para fazer a avaliaÃ§Ã£o dele</li>
            </ul>
          </CardContent>
        </Card>

        {/* Perguntas */}
        <div className="space-y-4">
          {questions?.map((question: any, index: number) => (
            <Card key={question.id}>
              <CardHeader>
                <CardTitle className="text-base">
                  {index + 1}. {question.questionText}
                </CardTitle>
                {question.category && (
                  <Badge variant="outline" className="w-fit">
                    {question.category}
                  </Badge>
                )}
              </CardHeader>
              <CardContent>
                <div className="flex items-center gap-2">
                  {[1, 2, 3, 4, 5].map((score) => (
                    <Button
                      key={score}
                      variant={responses[question.id] === score ? "default" : "outline"}
                      size="lg"
                      className="flex-1"
                      onClick={() => setResponses({ ...responses, [question.id]: score })}
                    >
                      {score}
                    </Button>
                  ))}
                </div>
                <div className="flex justify-between mt-2 text-xs text-muted-foreground">
                  <span>1 - InsatisfatÃ³rio</span>
                  <span>3 - Adequado</span>
                  <span>5 - Excepcional</span>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        {/* BotÃ£o de Enviar */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="font-semibold">Pronto para enviar?</p>
                <p className="text-sm text-muted-foreground">
                  VocÃª respondeu {Object.keys(responses).length} de {questions?.length || 0} perguntas
                </p>
              </div>
              <Button
                size="lg"
                onClick={handleSubmit}
                disabled={submitMutation.isPending || Object.keys(responses).length < (questions?.length || 0)}
              >
                {submitMutation.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                Enviar AutoavaliaÃ§Ã£o
                <ArrowRight className="h-4 w-4 ml-2" />
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Avaliacao360Consenso.tsx
========================================
import { useState } from "react";
import { useParams, useLocation } from "wouter";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Loader2, CheckCircle2, ArrowLeft, Check, Eye, EyeOff } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { toast } from "sonner";

/**
 * AvaliaÃ§Ã£o 360Â° - Etapa 3: Consenso do LÃ­der
 * 
 * Fluxo:
 * 1. AutoavaliaÃ§Ã£o (colaborador) âœ“
 * 2. AvaliaÃ§Ã£o do Gestor âœ“
 * 3. Consenso do LÃ­der â† ESTA PÃGINA (FINAL)
 */

export default function Avaliacao360Consenso() {
  const params = useParams();
  const [, navigate] = useLocation();
  const evaluationId = parseInt(params.id || "0");

  const [responses, setResponses] = useState<Record<number, number>>({});
  const [showComparison, setShowComparison] = useState(true);

  // Queries
  const { data: evaluation, isLoading } = trpc.evaluation360.getEvaluationWithWorkflow.useQuery({ evaluationId });
  const { data: questions } = trpc.evaluation360.getQuestions.useQuery({ evaluationId });

  // Mutation
  const submitMutation = trpc.evaluation360.submitConsensus.useMutation({
    onSuccess: () => {
      toast.success("Consenso final enviado com sucesso! AvaliaÃ§Ã£o 360Â° concluÃ­da.");
      navigate("/avaliacoes");
    },
    onError: (error: any) => {
      toast.error(`Erro ao enviar consenso: ${error.message}`);
    },
  });

  const handleSubmit = () => {
    if (!questions || Object.keys(responses).length < questions.length) {
      toast.error("Por favor, defina o consenso para todas as perguntas antes de enviar.");
      return;
    }

    const answersArray = questions.map((q: any) => ({
      questionId: q.id,
      score: responses[q.id] || 0,
    }));

    // Calcular nota final (mÃ©dia das respostas)
    const finalScore = answersArray.reduce((sum, a) => sum + a.score, 0) / answersArray.length;

    submitMutation.mutate({
      evaluationId,
      finalScore,
      consensusNotes: "Consenso final do lÃ­der",
    });
  };

  const progress = questions ? (Object.keys(responses).length / questions.length) * 100 : 0;

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  if (!evaluation) {
    return (
      <DashboardLayout>
        <Card>
          <CardContent className="py-12 text-center">
            <h3 className="text-lg font-semibold mb-2">AvaliaÃ§Ã£o nÃ£o encontrada</h3>
            <Button onClick={() => navigate("/avaliacoes")}>Voltar</Button>
          </CardContent>
        </Card>
      </DashboardLayout>
    );
  }

  // Verificar se a etapa estÃ¡ correta
  if (evaluation.workflowStatus !== "pending_consensus") {
    return (
      <DashboardLayout>
        <Card>
          <CardContent className="py-12 text-center">
            <h3 className="text-lg font-semibold mb-2">
              {evaluation.workflowStatus === "completed"
                ? "Consenso jÃ¡ foi concluÃ­do"
                : "Aguardando etapas anteriores"}
            </h3>
            <p className="text-sm text-muted-foreground mb-4">
              Status atual: {evaluation.workflowStatus}
            </p>
            <Button onClick={() => navigate("/avaliacoes")}>Voltar</Button>
          </CardContent>
        </Card>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6 max-w-5xl mx-auto">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={() => navigate("/avaliacoes")}>
            <ArrowLeft className="h-5 w-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-2xl font-bold">AvaliaÃ§Ã£o 360Â° - Consenso do LÃ­der</h1>
            <p className="text-sm text-muted-foreground">
              Ciclo {evaluation.cycleId} â€¢ {evaluation.employeeName}
            </p>
          </div>
        </div>

        {/* Stepper - Indicador de Progresso */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2 opacity-50">
                <CheckCircle2 className="h-6 w-6 text-green-600" />
                <div>
                  <p className="font-semibold">1. AutoavaliaÃ§Ã£o</p>
                  <p className="text-xs text-green-600">ConcluÃ­da</p>
                </div>
              </div>
              <div className="flex-1 mx-4 h-0.5 bg-green-600" />
              <div className="flex items-center gap-2 opacity-50">
                <CheckCircle2 className="h-6 w-6 text-green-600" />
                <div>
                  <p className="font-semibold">2. AvaliaÃ§Ã£o Gestor</p>
                  <p className="text-xs text-green-600">ConcluÃ­da</p>
                </div>
              </div>
              <div className="flex-1 mx-4 h-0.5 bg-green-600" />
              <div className="flex items-center gap-2">
                <CheckCircle2 className="h-6 w-6 text-primary" />
                <div>
                  <p className="font-semibold">3. Consenso LÃ­der</p>
                  <p className="text-xs text-muted-foreground">Em andamento</p>
                </div>
              </div>
            </div>
            <Progress value={100} className="h-2" />
          </CardContent>
        </Card>

        {/* Progresso das Respostas */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm font-medium">Progresso do Consenso</p>
              <p className="text-sm text-muted-foreground">
                {Object.keys(responses).length} de {questions?.length || 0} perguntas
              </p>
            </div>
            <Progress value={progress} className="h-2" />
          </CardContent>
        </Card>

        {/* BotÃ£o para Ver ComparaÃ§Ã£o */}
        <Card className="bg-purple-50 border-purple-200">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="font-semibold text-purple-900">ComparaÃ§Ã£o de AvaliaÃ§Ãµes</h3>
                <p className="text-sm text-purple-800">
                  Visualize as diferenÃ§as entre autoavaliaÃ§Ã£o e avaliaÃ§Ã£o do gestor
                </p>
              </div>
              <Button
                variant="outline"
                onClick={() => setShowComparison(!showComparison)}
              >
                {showComparison ? <EyeOff className="h-4 w-4 mr-2" /> : <Eye className="h-4 w-4 mr-2" />}
                {showComparison ? "Ocultar" : "Ver ComparaÃ§Ã£o"}
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* InstruÃ§Ãµes */}
        <Card className="bg-green-50 border-green-200">
          <CardContent className="pt-6">
            <h3 className="font-semibold mb-2 text-green-900">InstruÃ§Ãµes</h3>
            <ul className="text-sm text-green-800 space-y-1 list-disc list-inside">
              <li>Analise as diferenÃ§as entre a autoavaliaÃ§Ã£o e a avaliaÃ§Ã£o do gestor</li>
              <li>Defina a nota de consenso final para cada competÃªncia</li>
              <li>Use a escala de 1 (InsatisfatÃ³rio) a 5 (Excepcional)</li>
              <li>Esta Ã© a nota final que serÃ¡ registrada no sistema</li>
            </ul>
          </CardContent>
        </Card>

        {/* Perguntas com ComparaÃ§Ã£o */}
        <div className="space-y-4">
          {questions?.map((question: any, index: number) => {
            const selfScore = question.selfScore || 0;
            const managerScore = question.managerScore || 0;
            const gap = Math.abs(selfScore - managerScore);
            const hasGap = gap >= 2;

            return (
              <Card key={question.id} className={hasGap ? "border-amber-300 bg-amber-50" : ""}>
                <CardHeader>
                  <CardTitle className="text-base">
                    {index + 1}. {question.questionText}
                  </CardTitle>
                  <div className="flex items-center gap-2 flex-wrap">
                    {question.category && (
                      <Badge variant="outline">{question.category}</Badge>
                    )}
                    {showComparison && (
                      <>
                        <Badge variant="secondary">
                          AutoavaliaÃ§Ã£o: {selfScore}
                        </Badge>
                        <Badge variant="secondary">
                          Gestor: {managerScore}
                        </Badge>
                        {hasGap && (
                          <Badge variant="destructive">
                            Gap: {gap} pontos
                          </Badge>
                        )}
                      </>
                    )}
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    {/* ComparaÃ§Ã£o Visual */}
                    {showComparison && (
                      <div className="grid grid-cols-2 gap-4 p-3 bg-white rounded-md">
                        <div>
                          <p className="text-xs font-medium mb-1">AutoavaliaÃ§Ã£o</p>
                          <div className="flex gap-1">
                            {[1, 2, 3, 4, 5].map((score) => (
                              <div
                                key={score}
                                className={`h-8 w-full rounded ${
                                  score <= selfScore ? "bg-blue-500" : "bg-gray-200"
                                }`}
                              />
                            ))}
                          </div>
                        </div>
                        <div>
                          <p className="text-xs font-medium mb-1">AvaliaÃ§Ã£o Gestor</p>
                          <div className="flex gap-1">
                            {[1, 2, 3, 4, 5].map((score) => (
                              <div
                                key={score}
                                className={`h-8 w-full rounded ${
                                  score <= managerScore ? "bg-purple-500" : "bg-gray-200"
                                }`}
                              />
                            ))}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Consenso */}
                    <div>
                      <p className="text-sm font-medium mb-2">Consenso Final</p>
                      <div className="flex items-center gap-2">
                        {[1, 2, 3, 4, 5].map((score) => (
                          <Button
                            key={score}
                            variant={responses[question.id] === score ? "default" : "outline"}
                            size="lg"
                            className="flex-1"
                            onClick={() => setResponses({ ...responses, [question.id]: score })}
                          >
                            {score}
                          </Button>
                        ))}
                      </div>
                      <div className="flex justify-between mt-2 text-xs text-muted-foreground">
                        <span>1 - InsatisfatÃ³rio</span>
                        <span>3 - Adequado</span>
                        <span>5 - Excepcional</span>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>

        {/* BotÃ£o de Enviar */}
        <Card className="bg-green-50 border-green-200">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="font-semibold text-green-900">Finalizar AvaliaÃ§Ã£o 360Â°</p>
                <p className="text-sm text-green-800">
                  VocÃª definiu o consenso para {Object.keys(responses).length} de {questions?.length || 0} perguntas
                </p>
              </div>
              <Button
                size="lg"
                onClick={handleSubmit}
                disabled={submitMutation.isPending || Object.keys(responses).length < (questions?.length || 0)}
                className="bg-green-600 hover:bg-green-700"
              >
                {submitMutation.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                <Check className="h-4 w-4 mr-2" />
                Finalizar Consenso
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Avaliacao360Enhanced.tsx
========================================
// @ts-nocheck
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { trpc } from "@/lib/trpc";
import { CheckCircle2, Clock, Users, Loader2, TrendingUp, AlertCircle, BarChart3, Download } from "lucide-react";
import { generate360PDF } from "@/lib/generate360PDF";
import { toast } from "sonner";
import { useState } from "react";
import { Radar } from "react-chartjs-2";

/**
 * PÃ¡gina de AvaliaÃ§Ã£o 360Â° Enhanced
 * Sistema completo de avaliaÃ§Ã£o 360Â° com mÃºltiplos avaliadores e grÃ¡ficos comparativos
 */

// Tipo esperado do endpoint getDetails
type EvaluationDetails = {
  averages: {
    self: number;
    manager: number;
    peers: number;
    subordinates: number;
  };
  responses: {
    self: any[];
    manager: any[];
    peers: any[];
    subordinates: any[];
  };
  [key: string]: any;
};

export default function Avaliacao360Enhanced() {
  const [selectedEvaluation, setSelectedEvaluation] = useState<number | null>(null);

  // Buscar lista de avaliaÃ§Ãµes 360Â°
  const { data: evaluations, isLoading } = trpc.evaluation360.list.useQuery({});

  // Buscar detalhes da avaliaÃ§Ã£o selecionada
  const { data: detailsRaw } = trpc.evaluation360.getDetails.useQuery(
    { evaluationId: selectedEvaluation || 0 },
    { enabled: !!selectedEvaluation }
  );
  const details = detailsRaw as EvaluationDetails | null | undefined;

  const stages = [
    { 
      name: "AutoavaliaÃ§Ã£o", 
      key: "selfEvaluationCompleted",
      icon: Users,
      color: "text-blue-600"
    },
    { 
      name: "AvaliaÃ§Ã£o do Gestor", 
      key: "managerEvaluationCompleted",
      icon: TrendingUp,
      color: "text-purple-600"
    },
    { 
      name: "AvaliaÃ§Ã£o de Pares", 
      key: "peersEvaluationCompleted",
      icon: Users,
      color: "text-green-600"
    },
    { 
      name: "AvaliaÃ§Ã£o de Subordinados", 
      key: "subordinatesEvaluationCompleted",
      icon: Users,
      color: "text-orange-600"
    },
  ];

  // Calcular progresso geral
  const calculateProgress = (evaluation: any) => {
    const completed = stages.filter(stage => evaluation[stage.key]).length;
    return (completed / stages.length) * 100;
  };

  // Preparar dados para grÃ¡fico radar
  const radarData = details ? {
    labels: ['AutoavaliaÃ§Ã£o', 'Gestor', 'Pares', 'Subordinados'],
    datasets: [
      {
        label: 'MÃ©dia de Notas',
        data: [
          details?.averages?.self ?? 0,
          details?.averages?.manager ?? 0,
          details?.averages?.peers ?? 0,
          details?.subordinates ?? 0,
        ],
        backgroundColor: 'rgba(99, 102, 241, 0.2)',
        borderColor: 'rgb(99, 102, 241)',
        borderWidth: 2,
        pointBackgroundColor: 'rgb(99, 102, 241)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgb(99, 102, 241)',
      },
    ],
  } : null;

  const radarOptions = {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      r: {
        beginAtZero: true,
        max: 5,
        ticks: {
          stepSize: 1,
        },
      },
    },
    plugins: {
      legend: {
        display: false,
      },
      title: {
        display: true,
        text: 'Comparativo de AvaliaÃ§Ãµes 360Â°',
      },
    },
  };

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <BarChart3 className="h-8 w-8" />
            360Â° Enhanced
          </h1>
          <p className="text-muted-foreground mt-2">
            AvaliaÃ§Ã£o 360Â° aprimorada com mÃºltiplos avaliadores e anÃ¡lise comparativa
          </p>
        </div>

        {/* EstatÃ­sticas Gerais */}
        <div className="grid md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Total de AvaliaÃ§Ãµes
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{evaluations?.length || 0}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                ConcluÃ­das
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-green-600">
                {evaluations?.filter(e => e.status === "concluida").length || 0}
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Em Andamento
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-yellow-600">
                {evaluations?.filter(e => e.status === "em_andamento").length || 0}
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Taxa de ConclusÃ£o
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {evaluations && evaluations.length > 0
                  ? Math.round((evaluations.filter(e => e.status === "concluida").length / evaluations.length) * 100)
                  : 0}%
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de AvaliaÃ§Ãµes */}
        <div className="space-y-4">
          {!evaluations || evaluations.length === 0 ? (
            <Card>
              <CardContent className="flex flex-col items-center justify-center py-12">
                <AlertCircle className="h-12 w-12 text-muted-foreground mb-4" />
                <p className="text-muted-foreground">Nenhuma avaliaÃ§Ã£o 360Â° encontrada</p>
              </CardContent>
            </Card>
          ) : (
            evaluations.map((evaluation) => {
              const progress = calculateProgress(evaluation);
              const isSelected = selectedEvaluation === evaluation.id;

              return (
                <Card key={evaluation.id} className={isSelected ? "border-primary" : ""}>
                  <CardHeader>
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <CardTitle className="text-base flex items-center gap-2">
                          {evaluation.employeeName || `Colaborador #${evaluation.employeeId}`}
                          <Badge variant="outline">Ciclo #{evaluation.cycleId}</Badge>
                          <Badge variant={
                            evaluation.status === "concluida" ? "default" :
                            evaluation.status === "em_andamento" ? "secondary" : "outline"
                          }>
                            {evaluation.status === "concluida" ? "ConcluÃ­da" :
                             evaluation.status === "em_andamento" ? "Em Andamento" : "Pendente"}
                          </Badge>
                        </CardTitle>
                        <CardDescription className="mt-2">
                          AvaliaÃ§Ã£o 360Â° - {progress.toFixed(0)}% completa
                        </CardDescription>
                      </div>
                      <div className="flex flex-col items-end gap-2">
                        <div className="text-right">
                          <div className="text-2xl font-bold">
                            {evaluation.finalScore !== null ? evaluation.finalScore.toFixed(1) : "N/A"}
                          </div>
                          <p className="text-xs text-muted-foreground">Nota Final</p>
                        </div>
                        {isSelected && details && (
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => {
                              try {
                                generate360PDF({
                                  evaluation,
                                  averages: details?.averages ?? { self: 0, manager: 0, peers: 0, subordinates: 0 },
                                  responses: details?.responses ?? { self: [], manager: [], peers: [], subordinates: [] },
                                }, evaluation.employeeName || `Colaborador #${evaluation.employeeId}`);
                                toast.success("RelatÃ³rio PDF gerado com sucesso!");
                              } catch (error) {
                                toast.error("Erro ao gerar PDF");
                              }
                            }}
                          >
                            <Download className="h-4 w-4 mr-2" />
                            Exportar PDF
                          </Button>
                        )}
                      </div>
                    </div>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {/* Barra de Progresso */}
                    <div className="space-y-2">
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-muted-foreground">Progresso Geral</span>
                        <span className="font-medium">{progress.toFixed(0)}%</span>
                      </div>
                      <div className="w-full bg-muted rounded-full h-2">
                        <div
                          className="bg-primary h-2 rounded-full transition-all"
                          style={{ width: `${progress}%` }}
                        />
                      </div>
                    </div>

                    {/* Etapas */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      {stages.map((stage) => {
                        const Icon = stage.icon;
                        const completed = (evaluation as any)[stage.key];
                        
                        return (
                          <div key={stage.name} className="flex items-center gap-2">
                            <Icon className={`h-4 w-4 ${completed ? 'text-green-600' : 'text-muted-foreground'}`} />
                            <div>
                              <p className="text-xs text-muted-foreground">{stage.name}</p>
                              <p className="text-sm font-medium">
                                {completed ? (
                                  <span className="text-green-600">Completa</span>
                                ) : (
                                  <span className="text-muted-foreground">Pendente</span>
                                )}
                              </p>
                            </div>
                          </div>
                        );
                      })}
                    </div>

                    {/* BotÃ£o de Detalhes */}
                    <div className="pt-2">
                      <Button
                        variant={isSelected ? "default" : "outline"}
                        size="sm"
                        onClick={() => setSelectedEvaluation(isSelected ? null : evaluation.id)}
                      >
                        {isSelected ? "Ocultar Detalhes" : "Ver Detalhes"}
                      </Button>
                    </div>

                    {/* Detalhes Expandidos */}
                    {isSelected && details && (
                      <div className="mt-4 pt-4 border-t space-y-4">
                        <div className="grid md:grid-cols-2 gap-6">
                          {/* GrÃ¡fico Radar */}
                          <div>
                            <h4 className="font-medium mb-4">AnÃ¡lise Comparativa</h4>
                            {radarData && (
                              <div style={{ height: '300px' }}>
                                <Radar data={radarData} options={radarOptions} />
                              </div>
                            )}
                          </div>

                          {/* MÃ©dias por Tipo */}
                          <div>
                            <h4 className="font-medium mb-4">MÃ©dias por Avaliador</h4>
                            <div className="space-y-3">
                              <div className="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-950 rounded">
                                <span className="text-sm font-medium">AutoavaliaÃ§Ã£o</span>
                                <span className="text-lg font-bold text-blue-600">
                                  {(details?.averages?.self ?? 0).toFixed(1)}
                                </span>
                              </div>
                              <div className="flex items-center justify-between p-3 bg-purple-50 dark:bg-purple-950 rounded">
                                <span className="text-sm font-medium">Gestor</span>
                                <span className="text-lg font-bold text-purple-600">
                                  {(details?.averages?.manager ?? 0).toFixed(1)}
                                </span>
                              </div>
                              <div className="flex items-center justify-between p-3 bg-green-50 dark:bg-green-950 rounded">
                                <span className="text-sm font-medium">Pares</span>
                                <span className="text-lg font-bold text-green-600">
                                  {(details?.averages?.peers ?? 0).toFixed(1)}
                                </span>
                              </div>
                              <div className="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-950 rounded">
                                <span className="text-sm font-medium">Subordinados</span>
                                <span className="text-lg font-bold text-orange-600">
                                  {(details?.averages?.subordinates ?? 0).toFixed(1)}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* EstatÃ­sticas de Respostas */}
                        <div>
                          <h4 className="font-medium mb-4">EstatÃ­sticas de Respostas</h4>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <Card>
                              <CardContent className="pt-4">
                                <p className="text-sm text-muted-foreground">AutoavaliaÃ§Ã£o</p>
                                <p className="text-2xl font-bold">{details?.responses?.self?.length ?? 0}</p>
                                <p className="text-xs text-muted-foreground">respostas</p>
                              </CardContent>
                            </Card>
                            <Card>
                              <CardContent className="pt-4">
                                <p className="text-sm text-muted-foreground">Gestor</p>
                                <p className="text-2xl font-bold">{details?.responses?.manager?.length ?? 0}</p>
                                <p className="text-xs text-muted-foreground">respostas</p>
                              </CardContent>
                            </Card>
                            <Card>
                              <CardContent className="pt-4">
                                <p className="text-sm text-muted-foreground">Pares</p>
                                <p className="text-2xl font-bold">{details?.responses?.peers?.length ?? 0}</p>
                                <p className="text-xs text-muted-foreground">respostas</p>
                              </CardContent>
                            </Card>
                            <Card>
                              <CardContent className="pt-4">
                                <p className="text-sm text-muted-foreground">Subordinados</p>
                                <p className="text-2xl font-bold">{details?.responses?.subordinates?.length ?? 0}</p>
                                <p className="text-xs text-muted-foreground">respostas</p>
                              </CardContent>
                            </Card>
                          </div>
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>
              );
            })
          )}
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Avaliacao360Gestor.tsx
========================================
import { useState } from "react";
import { useParams, useLocation } from "wouter";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Loader2, CheckCircle2, Circle, ArrowLeft, ArrowRight, Eye } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { toast } from "sonner";

/**
 * AvaliaÃ§Ã£o 360Â° - Etapa 2: AvaliaÃ§Ã£o do Gestor
 * 
 * Fluxo:
 * 1. AutoavaliaÃ§Ã£o (colaborador) âœ“
 * 2. AvaliaÃ§Ã£o do Gestor â† ESTA PÃGINA
 * 3. Consenso do LÃ­der
 */

export default function Avaliacao360Gestor() {
  const params = useParams();
  const [, navigate] = useLocation();
  const evaluationId = parseInt(params.id || "0");

  const [responses, setResponses] = useState<Record<number, number>>({});
  const [showSelfAssessment, setShowSelfAssessment] = useState(false);

  // Queries
  const { data: evaluation, isLoading } = trpc.evaluation360.getEvaluationWithWorkflow.useQuery({ evaluationId });
  const { data: questions } = trpc.evaluation360.getQuestions.useQuery({ evaluationId });

  // Mutation
  const submitMutation = trpc.evaluation360.submitManagerAssessment.useMutation({
    onSuccess: () => {
      toast.success("AvaliaÃ§Ã£o do gestor enviada com sucesso! O lÃ­der foi notificado por email.");
      navigate("/avaliacoes");
    },
    onError: (error: any) => {
      toast.error(`Erro ao enviar avaliaÃ§Ã£o: ${error.message}`);
    },
  });

  const handleSubmit = () => {
    if (!questions || Object.keys(responses).length < questions.length) {
      toast.error("Por favor, responda todas as perguntas antes de enviar.");
      return;
    }

    const answersArray = questions.map((q: any) => ({
      questionId: q.id,
      score: responses[q.id] || 0,
    }));

    submitMutation.mutate({
      evaluationId,
      responses: answersArray,
    });
  };

  const progress = questions ? (Object.keys(responses).length / questions.length) * 100 : 0;

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  if (!evaluation) {
    return (
      <DashboardLayout>
        <Card>
          <CardContent className="py-12 text-center">
            <h3 className="text-lg font-semibold mb-2">AvaliaÃ§Ã£o nÃ£o encontrada</h3>
            <Button onClick={() => navigate("/avaliacoes")}>Voltar</Button>
          </CardContent>
        </Card>
      </DashboardLayout>
    );
  }

  // Verificar se a etapa estÃ¡ correta
  if (evaluation.workflowStatus !== "pending_manager") {
    return (
      <DashboardLayout>
        <Card>
          <CardContent className="py-12 text-center">
            <h3 className="text-lg font-semibold mb-2">
              {evaluation.workflowStatus === "pending_self"
                ? "Aguardando autoavaliaÃ§Ã£o do colaborador"
                : "AvaliaÃ§Ã£o do gestor jÃ¡ foi concluÃ­da"}
            </h3>
            <p className="text-sm text-muted-foreground mb-4">
              Status atual: {evaluation.workflowStatus}
            </p>
            <Button onClick={() => navigate("/avaliacoes")}>Voltar</Button>
          </CardContent>
        </Card>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6 max-w-4xl mx-auto">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={() => navigate("/avaliacoes")}>
            <ArrowLeft className="h-5 w-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-2xl font-bold">AvaliaÃ§Ã£o 360Â° - AvaliaÃ§Ã£o do Gestor</h1>
            <p className="text-sm text-muted-foreground">
              Ciclo {evaluation.cycleId} â€¢ {evaluation.employeeName}
            </p>
          </div>
        </div>

        {/* Stepper - Indicador de Progresso */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2 opacity-50">
                <CheckCircle2 className="h-6 w-6 text-green-600" />
                <div>
                  <p className="font-semibold">1. AutoavaliaÃ§Ã£o</p>
                  <p className="text-xs text-green-600">ConcluÃ­da</p>
                </div>
              </div>
              <div className="flex-1 mx-4 h-0.5 bg-green-600" />
              <div className="flex items-center gap-2">
                <CheckCircle2 className="h-6 w-6 text-primary" />
                <div>
                  <p className="font-semibold">2. AvaliaÃ§Ã£o Gestor</p>
                  <p className="text-xs text-muted-foreground">Em andamento</p>
                </div>
              </div>
              <div className="flex-1 mx-4 h-0.5 bg-gray-200" />
              <div className="flex items-center gap-2 opacity-50">
                <Circle className="h-6 w-6" />
                <div>
                  <p className="font-semibold">3. Consenso LÃ­der</p>
                  <p className="text-xs text-muted-foreground">Pendente</p>
                </div>
              </div>
            </div>
            <Progress value={66} className="h-2" />
          </CardContent>
        </Card>

        {/* Progresso das Respostas */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm font-medium">Progresso das Respostas</p>
              <p className="text-sm text-muted-foreground">
                {Object.keys(responses).length} de {questions?.length || 0} perguntas
              </p>
            </div>
            <Progress value={progress} className="h-2" />
          </CardContent>
        </Card>

        {/* BotÃ£o para Ver AutoavaliaÃ§Ã£o */}
        <Card className="bg-blue-50 border-blue-200">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="font-semibold text-blue-900">AutoavaliaÃ§Ã£o do Colaborador</h3>
                <p className="text-sm text-blue-800">
                  VocÃª pode visualizar as respostas da autoavaliaÃ§Ã£o para comparaÃ§Ã£o
                </p>
              </div>
              <Button
                variant="outline"
                onClick={() => setShowSelfAssessment(!showSelfAssessment)}
              >
                <Eye className="h-4 w-4 mr-2" />
                {showSelfAssessment ? "Ocultar" : "Ver AutoavaliaÃ§Ã£o"}
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* InstruÃ§Ãµes */}
        <Card className="bg-amber-50 border-amber-200">
          <CardContent className="pt-6">
            <h3 className="font-semibold mb-2 text-amber-900">InstruÃ§Ãµes</h3>
            <ul className="text-sm text-amber-800 space-y-1 list-disc list-inside">
              <li>Avalie o desempenho do colaborador de forma objetiva e construtiva</li>
              <li>Use a escala de 1 (InsatisfatÃ³rio) a 5 (Excepcional)</li>
              <li>Compare com a autoavaliaÃ§Ã£o para identificar gaps de percepÃ§Ã£o</li>
              <li>ApÃ³s enviar, o lÃ­der serÃ¡ notificado para fazer o consenso final</li>
            </ul>
          </CardContent>
        </Card>

        {/* Perguntas */}
        <div className="space-y-4">
          {questions?.map((question: any, index: number) => (
            <Card key={question.id}>
              <CardHeader>
                <CardTitle className="text-base">
                  {index + 1}. {question.questionText}
                </CardTitle>
                <div className="flex items-center gap-2">
                  {question.category && (
                    <Badge variant="outline">{question.category}</Badge>
                  )}
                  {showSelfAssessment && (
                    <Badge variant="secondary">
                      AutoavaliaÃ§Ã£o: {question.selfScore || "N/A"}
                    </Badge>
                  )}
                </div>
              </CardHeader>
              <CardContent>
                <div className="flex items-center gap-2">
                  {[1, 2, 3, 4, 5].map((score) => (
                    <Button
                      key={score}
                      variant={responses[question.id] === score ? "default" : "outline"}
                      size="lg"
                      className="flex-1"
                      onClick={() => setResponses({ ...responses, [question.id]: score })}
                    >
                      {score}
                    </Button>
                  ))}
                </div>
                <div className="flex justify-between mt-2 text-xs text-muted-foreground">
                  <span>1 - InsatisfatÃ³rio</span>
                  <span>3 - Adequado</span>
                  <span>5 - Excepcional</span>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        {/* BotÃ£o de Enviar */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="font-semibold">Pronto para enviar?</p>
                <p className="text-sm text-muted-foreground">
                  VocÃª respondeu {Object.keys(responses).length} de {questions?.length || 0} perguntas
                </p>
              </div>
              <Button
                size="lg"
                onClick={handleSubmit}
                disabled={submitMutation.isPending || Object.keys(responses).length < (questions?.length || 0)}
              >
                {submitMutation.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                Enviar AvaliaÃ§Ã£o
                <ArrowRight className="h-4 w-4 ml-2" />
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Avaliacoes.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { trpc } from "@/lib/trpc";
import { AlertCircle, CheckCircle2, Clock, Users, Plus, Calendar } from "lucide-react";
import { toast } from "sonner";

export default function Avaliacoes() {
  const [isCreateCycleDialogOpen, setIsCreateCycleDialogOpen] = useState(false);
  const [newCycle, setNewCycle] = useState({
    name: "",
    year: new Date().getFullYear(),
    type: "",
    startDate: "",
    endDate: "",
    description: "",
  });

  const { data: evaluations } = trpc.evaluations.list.useQuery({});
  const { data: employee } = trpc.employees.getCurrent.useQuery();
  const { data: cycles, refetch: refetchCycles } = trpc.evaluationCycles.list.useQuery();

  // Mutation para criar ciclo
  const createCycleMutation = trpc.evaluationCycles.create.useMutation({
    onSuccess: () => {
      toast.success(`Ciclo "${newCycle.name}" criado com sucesso!`);
      setIsCreateCycleDialogOpen(false);
      setNewCycle({
        name: "",
        year: new Date().getFullYear(),
        type: "",
        startDate: "",
        endDate: "",
        description: "",
      });
      refetchCycles(); // Atualizar listagem
    },
    onError: (error) => {
      toast.error(`Erro ao criar ciclo: ${error.message}`);
    },
  });

  const getStatusBadge = (status: string) => {
    const variants: Record<string, { variant: any; label: string; icon: any }> = {
      pendente: { variant: "outline", label: "Pendente", icon: Clock },
      em_andamento: { variant: "default", label: "Em Andamento", icon: AlertCircle },
      concluida: { variant: "default", label: "ConcluÃ­da", icon: CheckCircle2 },
      cancelada: { variant: "destructive", label: "Cancelada", icon: AlertCircle },
    };

    const config = variants[status] || variants.pendente;
    const Icon = config.icon;

    return (
      <Badge variant={config.variant} className="gap-1">
        <Icon className="h-3 w-3" />
        {config.label}
      </Badge>
    );
  };

  const calculateProgress = (evaluation: any) => {
    let completed = 0;
    let total = 0;

    if (evaluation.type === "360") {
      total = 4; // auto, gestor, pares, subordinados
      if (evaluation.selfEvaluationCompleted) completed++;
      if (evaluation.managerEvaluationCompleted) completed++;
      if (evaluation.peersEvaluationCompleted) completed++;
      if (evaluation.subordinatesEvaluationCompleted) completed++;
    } else {
      total = 1;
      if (evaluation.selfEvaluationCompleted || evaluation.managerEvaluationCompleted) completed = 1;
    }

    return Math.round((completed / total) * 100);
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-start justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <Users className="h-8 w-8" />
              AvaliaÃ§Ãµes de Desempenho
            </h1>
            <p className="text-muted-foreground mt-2">
              Acompanhe suas avaliaÃ§Ãµes 360Â° e feedback de desempenho
            </p>
          </div>
          <Button onClick={() => setIsCreateCycleDialogOpen(true)}>
            <Plus className="h-4 w-4 mr-2" />
            Criar Novo Ciclo
          </Button>
        </div>

        {/* Stats */}
        <div className="grid gap-4 md:grid-cols-3">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                AvaliaÃ§Ãµes Ativas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {evaluations?.filter(e => e.status === "em_andamento").length || 0}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Pendentes
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {evaluations?.filter(e => e.status === "pendente").length || 0}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                ConcluÃ­das
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {evaluations?.filter(e => e.status === "concluida").length || 0}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Evaluations List */}
        <div className="space-y-4">
          {evaluations?.length === 0 ? (
            <Card>
              <CardContent className="flex flex-col items-center justify-center py-12">
                <Users className="h-12 w-12 text-muted-foreground mb-4" />
                <h3 className="font-semibold text-lg mb-2">Nenhuma avaliaÃ§Ã£o disponÃ­vel</h3>
                <p className="text-muted-foreground text-center">
                  Aguarde o inÃ­cio do prÃ³ximo ciclo de avaliaÃ§Ã£o
                </p>
              </CardContent>
            </Card>
          ) : (
            evaluations?.map((evaluation) => {
              const progress = calculateProgress(evaluation);
              
              return (
                <Card key={evaluation.id}>
                  <CardHeader>
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <CardTitle className="flex items-center gap-2">
                          AvaliaÃ§Ã£o {evaluation.type === "360" ? "360Â°" : "Tradicional"}
                          {getStatusBadge(evaluation.status)}
                        </CardTitle>
                        <CardDescription className="mt-2">
                          Ciclo {new Date().getFullYear()} - {evaluation.type === "360" ? "Feedback completo de mÃºltiplas perspectivas" : "AvaliaÃ§Ã£o de desempenho"}
                        </CardDescription>
                      </div>
                    </div>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {evaluation.type === "360" && (
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="flex items-center gap-2">
                          {evaluation.selfEvaluationCompleted ? (
                            <CheckCircle2 className="h-5 w-5 text-green-600" />
                          ) : (
                            <Clock className="h-5 w-5 text-muted-foreground" />
                          )}
                          <div>
                            <p className="text-sm font-medium">AutoavaliaÃ§Ã£o</p>
                            <p className="text-xs text-muted-foreground">
                              {evaluation.selfEvaluationCompleted ? "ConcluÃ­da" : "Pendente"}
                            </p>
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          {evaluation.managerEvaluationCompleted ? (
                            <CheckCircle2 className="h-5 w-5 text-green-600" />
                          ) : (
                            <Clock className="h-5 w-5 text-muted-foreground" />
                          )}
                          <div>
                            <p className="text-sm font-medium">Gestor</p>
                            <p className="text-xs text-muted-foreground">
                              {evaluation.managerEvaluationCompleted ? "ConcluÃ­da" : "Pendente"}
                            </p>
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          {evaluation.peersEvaluationCompleted ? (
                            <CheckCircle2 className="h-5 w-5 text-green-600" />
                          ) : (
                            <Clock className="h-5 w-5 text-muted-foreground" />
                          )}
                          <div>
                            <p className="text-sm font-medium">Pares</p>
                            <p className="text-xs text-muted-foreground">
                              {evaluation.peersEvaluationCompleted ? "ConcluÃ­da" : "Pendente"}
                            </p>
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          {evaluation.subordinatesEvaluationCompleted ? (
                            <CheckCircle2 className="h-5 w-5 text-green-600" />
                          ) : (
                            <Clock className="h-5 w-5 text-muted-foreground" />
                          )}
                          <div>
                            <p className="text-sm font-medium">Equipe</p>
                            <p className="text-xs text-muted-foreground">
                              {evaluation.subordinatesEvaluationCompleted ? "ConcluÃ­da" : "Pendente"}
                            </p>
                          </div>
                        </div>
                      </div>
                    )}

                    <div className="space-y-2">
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-muted-foreground">Progresso geral</span>
                        <span className="font-semibold">{progress}%</span>
                      </div>
                      <Progress value={progress} className="h-2" />
                    </div>

                    {evaluation.status === "em_andamento" && (
                      <div className="flex gap-2 pt-2">
                        {!evaluation.selfEvaluationCompleted && (
                          <Button>
                            Iniciar AutoavaliaÃ§Ã£o
                          </Button>
                        )}

                      </div>
                    )}

                    {evaluation.status === "concluida" && (
                      <div className="bg-muted p-4 rounded-lg">
                        <p className="text-sm font-medium mb-2">AvaliaÃ§Ã£o ConcluÃ­da</p>
                        <div className="flex gap-2">
                          <Button variant="outline" className="flex-1">
                            Ver RelatÃ³rio Completo
                          </Button>
                          <Button variant="outline" className="flex-1">
                            Download PDF
                          </Button>
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>
              );
            })
          )}
        </div>

        {/* Info Card */}
        <Card className="bg-muted/50">
          <CardHeader>
            <CardTitle className="text-base">Sobre a AvaliaÃ§Ã£o 360Â°</CardTitle>
          </CardHeader>
          <CardContent className="text-sm text-muted-foreground space-y-2">
            <p>
              A avaliaÃ§Ã£o 360Â° coleta feedback de mÃºltiplas perspectivas para fornecer uma visÃ£o completa do seu desempenho:
            </p>
            <ul className="list-disc list-inside space-y-1 ml-2">
              <li><strong>AutoavaliaÃ§Ã£o:</strong> Sua prÃ³pria percepÃ§Ã£o sobre seu desempenho</li>
              <li><strong>Gestor:</strong> AvaliaÃ§Ã£o do seu lÃ­der direto</li>
              <li><strong>Pares:</strong> Feedback de colegas do mesmo nÃ­vel</li>
              <li><strong>Equipe:</strong> AvaliaÃ§Ã£o dos seus subordinados (se aplicÃ¡vel)</li>
            </ul>
            <p className="pt-2">
              O resultado consolidado ajuda a identificar pontos fortes e oportunidades de desenvolvimento.
            </p>
          </CardContent>
        </Card>

        {/* Dialog de CriaÃ§Ã£o de Ciclo */}
        <Dialog open={isCreateCycleDialogOpen} onOpenChange={setIsCreateCycleDialogOpen}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <Calendar className="h-5 w-5" />
                Criar Novo Ciclo de AvaliaÃ§Ã£o
              </DialogTitle>
              <DialogDescription>
                Configure um novo ciclo de avaliaÃ§Ã£o de desempenho para sua organizaÃ§Ã£o
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4 py-4">
              {/* Nome do Ciclo */}
              <div className="space-y-2">
                <Label htmlFor="cycle-name">Nome do Ciclo *</Label>
                <Input
                  id="cycle-name"
                  placeholder="Ex: Ciclo de AvaliaÃ§Ã£o 2025"
                  value={newCycle.name}
                  onChange={(e) => setNewCycle({ ...newCycle, name: e.target.value })}
                />
              </div>

              {/* Ano e Tipo */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="cycle-year">Ano *</Label>
                  <Input
                    id="cycle-year"
                    type="number"
                    min={new Date().getFullYear()}
                    max={new Date().getFullYear() + 5}
                    value={newCycle.year}
                    onChange={(e) => setNewCycle({ ...newCycle, year: parseInt(e.target.value) })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="cycle-type">Tipo *</Label>
                  <Select
                    value={newCycle.type}
                    onValueChange={(value) => setNewCycle({ ...newCycle, type: value })}
                  >
                    <SelectTrigger id="cycle-type">
                      <SelectValue placeholder="Selecione o tipo" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="anual">Anual</SelectItem>
                      <SelectItem value="semestral">Semestral</SelectItem>
                      <SelectItem value="trimestral">Trimestral</SelectItem>
                      <SelectItem value="mensal">Mensal</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Datas */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="cycle-start">Data de InÃ­cio *</Label>
                  <Input
                    id="cycle-start"
                    type="date"
                    value={newCycle.startDate}
                    onChange={(e) => setNewCycle({ ...newCycle, startDate: e.target.value })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="cycle-end">Data de Fim *</Label>
                  <Input
                    id="cycle-end"
                    type="date"
                    value={newCycle.endDate}
                    onChange={(e) => setNewCycle({ ...newCycle, endDate: e.target.value })}
                  />
                </div>
              </div>

              {/* DescriÃ§Ã£o */}
              <div className="space-y-2">
                <Label htmlFor="cycle-description">DescriÃ§Ã£o</Label>
                <Textarea
                  id="cycle-description"
                  placeholder="Descreva os objetivos e escopo deste ciclo..."
                  value={newCycle.description}
                  onChange={(e) => setNewCycle({ ...newCycle, description: e.target.value })}
                  rows={3}
                />
              </div>

              {/* InformaÃ§Ã£o */}
              <div className="rounded-lg border p-4 bg-muted/50">
                <p className="text-sm text-muted-foreground">
                  <strong>Importante:</strong> ApÃ³s criar o ciclo, vocÃª poderÃ¡ ativÃ¡-lo e iniciar as avaliaÃ§Ãµes de desempenho.
                  Certifique-se de que as datas estÃ£o corretas antes de criar.
                </p>
              </div>
            </div>

            <DialogFooter>
              <Button
                variant="outline"
                onClick={() => {
                  setIsCreateCycleDialogOpen(false);
                  setNewCycle({
                    name: "",
                    year: new Date().getFullYear(),
                    type: "",
                    startDate: "",
                    endDate: "",
                    description: "",
                  });
                }}
              >
                Cancelar
              </Button>
              <Button
                onClick={() => {
                  if (!newCycle.name || !newCycle.type || !newCycle.startDate || !newCycle.endDate) {
                    toast.error("Preencha todos os campos obrigatÃ³rios");
                    return;
                  }

                  if (new Date(newCycle.startDate) >= new Date(newCycle.endDate)) {
                    toast.error("A data de inÃ­cio deve ser anterior Ã  data de fim");
                    return;
                  }

                  // Criar ciclo no backend
                  createCycleMutation.mutate({
                    name: newCycle.name,
                    year: newCycle.year,
                    type: newCycle.type as any, // Type assertion para aceitar todos os tipos
                    startDate: new Date(newCycle.startDate).toISOString(),
                    endDate: new Date(newCycle.endDate).toISOString(),
                    description: newCycle.description || undefined,
                  });
                }}
                disabled={!newCycle.name || !newCycle.type || !newCycle.startDate || !newCycle.endDate || createCycleMutation.isPending}
              >
                Criar Ciclo
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Avaliar360.tsx
========================================
import DashboardLayout from "@/components/DashboardLayout";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { trpc } from "@/lib/trpc";
import { AlertCircle, CheckCircle2, ChevronLeft, ChevronRight, Clipboard, Loader2, Send } from "lucide-react";
import { useState, useMemo } from "react";
import { useParams } from "wouter";
import { toast } from "sonner";

/**
 * PÃ¡gina de FormulÃ¡rio de AvaliaÃ§Ã£o 360Â° Interativo
 * Permite responder avaliaÃ§Ãµes 360Â° com perguntas organizadas por categoria
 */

interface Question {
  id: number;
  category: string;
  text: string;
}

export default function Avaliar360() {
  const params = useParams();
  const evaluationId = params.evaluationId ? parseInt(params.evaluationId) : null;

  const [evaluatorType, setEvaluatorType] = useState<"self" | "manager" | "peer" | "subordinate">("self");
  const [currentCategory, setCurrentCategory] = useState(0);
  const [responses, setResponses] = useState<Record<number, { score?: number; text?: string }>>({});

  // Buscar perguntas
  const { data: questions, isLoading } = trpc.evaluation360.getQuestions.useQuery({ evaluationId: evaluationId || 0 });

  // Mutation para submeter feedback
  const submitFeedbackMutation = trpc.evaluation360.submitFeedback.useMutation({
    onSuccess: () => {
      toast.success("Resposta salva com sucesso!");
    },
    onError: (error: any) => {
      toast.error(`Erro ao salvar resposta: ${error.message}`);
    },
  });

  // Agrupar perguntas por categoria
  const categorizedQuestions = useMemo(() => {
    if (!questions) return [];
    
    const categories: Record<string, typeof questions> = {};
    questions.forEach((q: Question) => {
      const cat = q.category || "Sem Categoria";
      if (!categories[cat]) categories[cat] = [];
      categories[cat].push(q);
    });

    return Object.entries(categories).map(([category, qs]) => ({
      category,
      questions: qs,
    }));
  }, [questions]);

  const currentCategoryData = categorizedQuestions[currentCategory];

  // Calcular progresso
  const totalQuestions = questions?.length || 0;
  const answeredQuestions = Object.keys(responses).length;
  const progress = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;

  const handleScoreChange = (questionId: number, score: number) => {
    setResponses(prev => ({
      ...prev,
      [questionId]: { ...prev[questionId], score },
    }));
  };

  const handleTextChange = (questionId: number, text: string) => {
    setResponses(prev => ({
      ...prev,
      [questionId]: { ...prev[questionId], text },
    }));
  };

  const handleSubmitAll = async () => {
    if (!evaluationId) {
      toast.error("ID de avaliaÃ§Ã£o invÃ¡lido");
      return;
    }

    const unanswered = questions?.filter((q: Question) => 
      !responses[q.id]?.score
    );

    if (unanswered && unanswered.length > 0) {
      toast.error(`Existem ${unanswered.length} perguntas nÃ£o respondidas`);
      return;
    }

    try {
      // Consolidar todas as respostas em um feedback textual
      const feedbackText = Object.entries(responses)
        .map(([questionIdStr, response]) => {
          const question = questions?.find(q => q.id === parseInt(questionIdStr));
          return `${question?.text}: Nota ${response.score}/5${response.text ? ` - ${response.text}` : ''}`;
        })
        .join('\n\n');

      await submitFeedbackMutation.mutateAsync({
        evaluationId,
        feedback: feedbackText,
      });
      toast.success("AvaliaÃ§Ã£o enviada com sucesso!");
      setResponses({});
    } catch (error) {
      toast.error("Erro ao enviar avaliaÃ§Ã£o");
    }
  };

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  if (!evaluationId) {
    return (
      <DashboardLayout>
        <Card>
          <CardContent className="flex flex-col items-center justify-center py-12">
            <AlertCircle className="h-12 w-12 text-destructive mb-4" />
            <p className="text-muted-foreground">ID de avaliaÃ§Ã£o nÃ£o fornecido</p>
          </CardContent>
        </Card>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Clipboard className="h-8 w-8" />
            AvaliaÃ§Ã£o 360Â°
          </h1>
          <p className="text-muted-foreground mt-2">
            Responda as perguntas de forma honesta e construtiva
          </p>
        </div>

        {/* ConfiguraÃ§Ãµes */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">ConfiguraÃ§Ãµes da AvaliaÃ§Ã£o</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Tipo de Avaliador</Label>
                <Select value={evaluatorType} onValueChange={(v: any) => setEvaluatorType(v)}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="self">AutoavaliaÃ§Ã£o</SelectItem>
                    <SelectItem value="manager">Gestor</SelectItem>
                    <SelectItem value="peer">Par/Colega</SelectItem>
                    <SelectItem value="subordinate">Subordinado</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label>AvaliaÃ§Ã£o ID</Label>
                <div className="flex items-center h-10 px-3 bg-muted rounded-md">
                  <span className="text-sm font-medium">#{evaluationId}</span>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Progresso */}
        <Card>
          <CardContent className="pt-6">
            <div className="space-y-2">
              <div className="flex items-center justify-between text-sm">
                <span className="text-muted-foreground">Progresso Geral</span>
                <span className="font-medium">
                  {answeredQuestions} / {totalQuestions} perguntas ({progress.toFixed(0)}%)
                </span>
              </div>
              <div className="w-full bg-muted rounded-full h-2">
                <div
                  className="bg-primary h-2 rounded-full transition-all"
                  style={{ width: `${progress}%` }}
                />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* NavegaÃ§Ã£o de Categorias */}
        {categorizedQuestions.length > 0 && (
          <div className="flex items-center gap-2 overflow-x-auto pb-2">
            {categorizedQuestions.map((cat, idx) => (
              <Button
                key={idx}
                variant={currentCategory === idx ? "default" : "outline"}
                size="sm"
                onClick={() => setCurrentCategory(idx)}
              >
                {cat.category}
              </Button>
            ))}
          </div>
        )}

        {/* Perguntas da Categoria Atual */}
        {currentCategoryData && (
          <Card>
            <CardHeader>
              <CardTitle>{currentCategoryData.category}</CardTitle>
              <CardDescription>
                {currentCategoryData.questions.length} perguntas nesta categoria
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {currentCategoryData.questions.map((question: Question, idx: number) => (
                <div key={question.id} className="space-y-3 pb-6 border-b last:border-b-0">
                  <div className="flex items-start gap-3">
                    <div className="flex-shrink-0 w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                      <span className="text-sm font-medium">{idx + 1}</span>
                    </div>
                    <div className="flex-1 space-y-3">
                      <p className="font-medium">{question.text}</p>

                      <div className="space-y-2">
                        <Label className="text-sm text-muted-foreground">
                          Escala de 1 (Discordo Totalmente) a 5 (Concordo Totalmente)
                        </Label>
                        <RadioGroup
                          value={responses[question.id]?.score?.toString() || ""}
                          onValueChange={(v) => handleScoreChange(question.id, parseInt(v))}
                        >
                          <div className="flex gap-4">
                            {[1, 2, 3, 4, 5].map(score => (
                              <div key={score} className="flex items-center space-x-2">
                                <RadioGroupItem value={score.toString()} id={`q${question.id}-${score}`} />
                                <Label htmlFor={`q${question.id}-${score}`} className="cursor-pointer">
                                  {score}
                                </Label>
                              </div>
                            ))}
                          </div>
                        </RadioGroup>
                      </div>

                      {responses[question.id] && (
                        <div className="flex items-center gap-2 text-sm text-green-600">
                          <CheckCircle2 className="h-4 w-4" />
                          <span>Respondida</span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </CardContent>
          </Card>
        )}

        {/* NavegaÃ§Ã£o e Envio */}
        <div className="flex items-center justify-between">
          <Button
            variant="outline"
            onClick={() => setCurrentCategory(Math.max(0, currentCategory - 1))}
            disabled={currentCategory === 0}
          >
            <ChevronLeft className="h-4 w-4 mr-2" />
            Categoria Anterior
          </Button>

          {currentCategory === categorizedQuestions.length - 1 ? (
            <Button
              onClick={handleSubmitAll}
              disabled={submitFeedbackMutation.isPending}
              size="lg"
            >
              {submitFeedbackMutation.isPending ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Enviando...
                </>
              ) : (
                <>
                  <Send className="h-4 w-4 mr-2" />
                  Enviar AvaliaÃ§Ã£o
                </>
              )}
            </Button>
          ) : (
            <Button
              onClick={() => setCurrentCategory(Math.min(categorizedQuestions.length - 1, currentCategory + 1))}
            >
              PrÃ³xima Categoria
              <ChevronRight className="h-4 w-4 ml-2" />
            </Button>
          )}
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Badges.tsx
========================================
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { trpc } from "@/lib/trpc";
import { Trophy, Award, Star, Lock, TrendingUp } from "lucide-react";
import * as LucideIcons from "lucide-react";

export default function Badges() {
  const { data: allBadges, isLoading: loadingBadges } = trpc.badges.getBadges.useQuery();
  const { data: myBadges, isLoading: loadingMyBadges } = trpc.badges.getEmployeeBadges.useQuery({});
  const { data: ranking, isLoading: loadingRanking } = trpc.badges.getRanking.useQuery({ limit: 10 });
  const { data: stats } = trpc.badges.getStats.useQuery();

  const earnedBadgeIds = new Set(myBadges?.badges.map((b) => b.badgeId) || []);

  const getIcon = (iconName: string | null) => {
    if (!iconName) return Trophy;
    const Icon = (LucideIcons as any)[iconName];
    return Icon || Trophy;
  };

  const getCategoryColor = (category: string) => {
    const colors: Record<string, string> = {
      metas: "bg-blue-500",
      pdi: "bg-green-500",
      avaliacao: "bg-purple-500",
      feedback: "bg-orange-500",
      geral: "bg-gray-500",
    };
    return colors[category] || "bg-gray-500";
  };

  if (loadingBadges || loadingMyBadges || loadingRanking) {
    return (
      <div className="container py-8">
        <div className="flex items-center justify-center h-64">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p className="text-muted-foreground">Carregando badges...</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="container py-8">
      <div className="mb-8">
        <h1 className="text-3xl font-bold mb-2">ðŸ† Conquistas e Badges</h1>
        <p className="text-muted-foreground">
          Acompanhe suas conquistas e compare seu desempenho com outros colaboradores
        </p>
      </div>

      {/* Cards de EstatÃ­sticas */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground">Pontos Totais</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <Star className="h-5 w-5 text-yellow-500" />
              <span className="text-2xl font-bold">{myBadges?.totalPoints || 0}</span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground">Badges Conquistados</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <Award className="h-5 w-5 text-blue-500" />
              <span className="text-2xl font-bold">
                {myBadges?.badgeCount || 0}/{stats?.totalBadgesAvailable || 0}
              </span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground">Progresso</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <TrendingUp className="h-5 w-5 text-green-500" />
              <span className="text-2xl font-bold">
                {stats?.totalBadgesAvailable
                  ? Math.round(((myBadges?.badgeCount || 0) / stats.totalBadgesAvailable) * 100)
                  : 0}
                %
              </span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground">PosiÃ§Ã£o no Ranking</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <Trophy className="h-5 w-5 text-amber-500" />
              <span className="text-2xl font-bold">
                {ranking && myBadges && myBadges.badges.length > 0
                  ? (ranking.findIndex((r) => r.employeeId === myBadges.badges[0].badgeId) + 1 || "-")
                  : "-"}Âº
              </span>
            </div>
          </CardContent>
        </Card>
      </div>

      <Tabs defaultValue="my-badges" className="space-y-4">
        <TabsList>
          <TabsTrigger value="my-badges">Minhas Conquistas</TabsTrigger>
          <TabsTrigger value="all-badges">Todos os Badges</TabsTrigger>
          <TabsTrigger value="ranking">Ranking</TabsTrigger>
        </TabsList>

        {/* Minhas Conquistas */}
        <TabsContent value="my-badges" className="space-y-4">
          {myBadges && myBadges.badges.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {myBadges.badges.map((item) => {
                const Icon = getIcon(item.badge.icon);
                return (
                  <Card key={item.id} className="relative overflow-hidden">
                    <div className={`absolute top-0 left-0 w-2 h-full ${getCategoryColor(item.badge.category)}`} />
                    <CardHeader>
                      <div className="flex items-start justify-between">
                        <div className="flex items-center gap-3">
                          <div className="p-3 rounded-lg bg-primary/10">
                            <Icon className="h-6 w-6 text-primary" />
                          </div>
                          <div>
                            <CardTitle className="text-lg">{item.badge.name}</CardTitle>
                            <CardDescription className="text-xs mt-1">
                              Conquistado em {new Date(item.earnedAt).toLocaleDateString("pt-BR")}
                            </CardDescription>
                          </div>
                        </div>
                        <Badge variant="secondary" className="ml-2">
                          +{item.badge.points} pts
                        </Badge>
                      </div>
                    </CardHeader>
                    <CardContent>
                      <p className="text-sm text-muted-foreground">{item.badge.description}</p>
                    </CardContent>
                  </Card>
                );
              })}
            </div>
          ) : (
            <Card>
              <CardContent className="py-12 text-center">
                <Trophy className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
                <p className="text-lg font-medium mb-2">Nenhum badge conquistado ainda</p>
                <p className="text-muted-foreground">
                  Complete metas, PDIs e avaliaÃ§Ãµes para ganhar seus primeiros badges!
                </p>
              </CardContent>
            </Card>
          )}
        </TabsContent>

        {/* Todos os Badges */}
        <TabsContent value="all-badges" className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {allBadges?.map((badge) => {
              const Icon = getIcon(badge.icon);
              const isEarned = earnedBadgeIds.has(badge.id);

              return (
                <Card
                  key={badge.id}
                  className={`relative overflow-hidden ${!isEarned ? "opacity-60" : ""}`}
                >
                  <div className={`absolute top-0 left-0 w-2 h-full ${getCategoryColor(badge.category)}`} />
                  <CardHeader>
                    <div className="flex items-start justify-between">
                      <div className="flex items-center gap-3">
                        <div className={`p-3 rounded-lg ${isEarned ? "bg-primary/10" : "bg-muted"}`}>
                          {isEarned ? (
                            <Icon className="h-6 w-6 text-primary" />
                          ) : (
                            <Lock className="h-6 w-6 text-muted-foreground" />
                          )}
                        </div>
                        <div>
                          <CardTitle className="text-lg">{badge.name}</CardTitle>
                          <CardDescription className="text-xs mt-1 capitalize">{badge.category}</CardDescription>
                        </div>
                      </div>
                      <Badge variant={isEarned ? "default" : "secondary"} className="ml-2">
                        {badge.points} pts
                      </Badge>
                    </div>
                  </CardHeader>
                  <CardContent>
                    <p className="text-sm text-muted-foreground">{badge.description}</p>
                    {!isEarned && (
                      <p className="text-xs text-muted-foreground mt-2 italic">ðŸ”’ Bloqueado</p>
                    )}
                  </CardContent>
                </Card>
              );
            })}
          </div>
        </TabsContent>

        {/* Ranking */}
        <TabsContent value="ranking" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>ðŸ† Top 10 Colaboradores</CardTitle>
              <CardDescription>Ranking por pontos acumulados</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {ranking?.map((item, index) => (
                  <div
                    key={item.employeeId}
                    className="flex items-center justify-between p-4 rounded-lg border bg-card hover:bg-accent/50 transition-colors"
                  >
                    <div className="flex items-center gap-4">
                      <div
                        className={`flex items-center justify-center w-10 h-10 rounded-full font-bold ${
                          index === 0
                            ? "bg-yellow-500 text-white"
                            : index === 1
                            ? "bg-gray-400 text-white"
                            : index === 2
                            ? "bg-amber-700 text-white"
                            : "bg-muted text-muted-foreground"
                        }`}
                      >
                        {index + 1}
                      </div>
                      <div>
                        <p className="font-medium">{item.employee.name}</p>
                        <p className="text-sm text-muted-foreground">
                          {item.badgeCount} {item.badgeCount === 1 ? "badge" : "badges"}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Star className="h-5 w-5 text-yellow-500" />
                      <span className="text-lg font-bold">{item.totalPoints}</span>
                      <span className="text-sm text-muted-foreground">pts</span>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/BenchmarkingMercado.tsx
========================================
import { useState } from "react";
import { useLocation } from "wouter";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Loader2, TrendingUp, TrendingDown, Minus, ArrowLeft } from "lucide-react";
import { trpc } from "@/lib/trpc";
import {
  Chart as ChartJS,
  RadialLinearScale,
  PointElement,
  LineElement,
  Filler,
  Tooltip,
  Legend,
} from "chart.js";
import { Radar } from "react-chartjs-2";

ChartJS.register(RadialLinearScale, PointElement, LineElement, Filler, Tooltip, Legend);

/**
 * Benchmarking UISA vs Mercado
 * 
 * Compara perfis DISC e Big Five da UISA com 21 perfis de referÃªncia do mercado
 * segmentados por setor e cargo.
 */

// Perfis de referÃªncia do mercado (dados simulados - substituir por dados reais)
const MARKET_PROFILES = {
  disc: {
    "Tecnologia - Desenvolvedor": { D: 35, I: 45, S: 55, C: 65 },
    "Tecnologia - Gerente de TI": { D: 70, I: 60, S: 40, C: 50 },
    "Financeiro - Analista": { D: 30, I: 35, S: 50, C: 85 },
    "Financeiro - CFO": { D: 75, I: 55, S: 35, C: 70 },
    "Vendas - Executivo de Contas": { D: 65, I: 85, S: 45, C: 30 },
    "Vendas - Gerente Comercial": { D: 80, I: 75, S: 40, C: 45 },
    "RH - Analista": { D: 25, I: 70, S: 80, C: 45 },
    "RH - Diretor": { D: 60, I: 75, S: 60, C: 55 },
    "OperaÃ§Ãµes - Supervisor": { D: 70, I: 45, S: 55, C: 60 },
    "OperaÃ§Ãµes - Diretor": { D: 85, I: 50, S: 40, C: 65 },
    "Marketing - Analista": { D: 40, I: 75, S: 50, C: 55 },
    "Marketing - CMO": { D: 70, I: 80, S: 45, C: 60 },
    "Engenharia - Engenheiro": { D: 45, I: 40, S: 50, C: 80 },
    "Engenharia - Gerente": { D: 75, I: 55, S: 45, C: 70 },
    "JurÃ­dico - Advogado": { D: 50, I: 45, S: 40, C: 90 },
    "JurÃ­dico - Diretor JurÃ­dico": { D: 70, I: 60, S: 35, C: 85 },
    "Atendimento - Atendente": { D: 20, I: 75, S: 85, C: 40 },
    "Atendimento - Gerente": { D: 55, I: 70, S: 65, C: 50 },
    "LogÃ­stica - Coordenador": { D: 65, I: 40, S: 60, C: 70 },
    "LogÃ­stica - Diretor": { D: 80, I: 50, S: 45, C: 75 },
    "Administrativo - Assistente": { D: 30, I: 50, S: 70, C: 75 },
  },
  bigFive: {
    "Tecnologia - Desenvolvedor": { O: 75, C: 70, E: 40, A: 55, N: 45 },
    "Tecnologia - Gerente de TI": { O: 70, C: 75, E: 65, A: 60, N: 40 },
    "Financeiro - Analista": { O: 50, C: 90, E: 45, A: 55, N: 50 },
    "Financeiro - CFO": { O: 65, C: 85, E: 70, A: 60, N: 35 },
    "Vendas - Executivo de Contas": { O: 60, C: 55, E: 90, A: 70, N: 40 },
    "Vendas - Gerente Comercial": { O: 65, C: 65, E: 85, A: 65, N: 35 },
    "RH - Analista": { O: 70, C: 65, E: 75, A: 85, N: 45 },
    "RH - Diretor": { O: 75, C: 70, E: 80, A: 80, N: 35 },
    "OperaÃ§Ãµes - Supervisor": { O: 55, C: 80, E: 60, A: 60, N: 40 },
    "OperaÃ§Ãµes - Diretor": { O: 65, C: 85, E: 75, A: 65, N: 30 },
    "Marketing - Analista": { O: 85, C: 60, E: 70, A: 65, N: 45 },
    "Marketing - CMO": { O: 90, C: 70, E: 80, A: 70, N: 35 },
    "Engenharia - Engenheiro": { O: 80, C: 85, E: 45, A: 55, N: 40 },
    "Engenharia - Gerente": { O: 75, C: 80, E: 65, A: 60, N: 35 },
    "JurÃ­dico - Advogado": { O: 60, C: 90, E: 50, A: 55, N: 45 },
    "JurÃ­dico - Diretor JurÃ­dico": { O: 70, C: 90, E: 65, A: 60, N: 35 },
    "Atendimento - Atendente": { O: 55, C: 60, E: 80, A: 90, N: 50 },
    "Atendimento - Gerente": { O: 65, C: 70, E: 75, A: 85, N: 40 },
    "LogÃ­stica - Coordenador": { O: 50, C: 85, E: 55, A: 60, N: 40 },
    "LogÃ­stica - Diretor": { O: 60, C: 90, E: 70, A: 65, N: 30 },
    "Administrativo - Assistente": { O: 55, C: 80, E: 60, A: 75, N: 50 },
  },
};

export default function BenchmarkingMercado() {
  const [, navigate] = useLocation();
  const [selectedProfile, setSelectedProfile] = useState<string>("Tecnologia - Desenvolvedor");
  const [testType, setTestType] = useState<"disc" | "bigFive">("disc");

  // Query para buscar mÃ©dias da UISA (comentado - implementar endpoint depois)
  // const { data: uisaAverages, isLoading } = trpc.psychometric.getAverages.useQuery();
  const isLoading = false;

  // Dados do perfil selecionado
  const marketProfile = testType === "disc" 
    ? MARKET_PROFILES.disc[selectedProfile as keyof typeof MARKET_PROFILES.disc]
    : MARKET_PROFILES.bigFive[selectedProfile as keyof typeof MARKET_PROFILES.bigFive];

  // Dados da UISA (simulados - substituir por dados reais)
  const uisaProfile = testType === "disc"
    ? { D: 55, I: 60, S: 50, C: 65 }
    : { O: 70, C: 75, E: 65, A: 70, N: 40 };

  // ConfiguraÃ§Ã£o do grÃ¡fico radar
  const radarData = {
    labels: testType === "disc" 
      ? ["DominÃ¢ncia", "InfluÃªncia", "Estabilidade", "Conformidade"]
      : ["Abertura", "Conscienciosidade", "ExtroversÃ£o", "Amabilidade", "Neuroticismo"],
    datasets: [
      {
        label: "UISA",
        data: Object.values(uisaProfile),
        backgroundColor: "rgba(59, 130, 246, 0.2)",
        borderColor: "rgb(59, 130, 246)",
        borderWidth: 2,
        pointBackgroundColor: "rgb(59, 130, 246)",
        pointBorderColor: "#fff",
        pointHoverBackgroundColor: "#fff",
        pointHoverBorderColor: "rgb(59, 130, 246)",
      },
      {
        label: `Mercado: ${selectedProfile}`,
        data: Object.values(marketProfile),
        backgroundColor: "rgba(16, 185, 129, 0.2)",
        borderColor: "rgb(16, 185, 129)",
        borderWidth: 2,
        pointBackgroundColor: "rgb(16, 185, 129)",
        pointBorderColor: "#fff",
        pointHoverBackgroundColor: "#fff",
        pointHoverBorderColor: "rgb(16, 185, 129)",
      },
    ],
  };

  const radarOptions = {
    scales: {
      r: {
        beginAtZero: true,
        max: 100,
        ticks: {
          stepSize: 20,
        },
      },
    },
    plugins: {
      legend: {
        position: "top" as const,
      },
    },
  };

  // Calcular diferenÃ§as
  const differences = Object.keys(uisaProfile).map((key) => {
    const uisaValue = uisaProfile[key as keyof typeof uisaProfile] || 0;
    const marketValue = marketProfile[key as keyof typeof marketProfile] || 0;
    const diff = uisaValue - marketValue;
    return {
      dimension: key,
      uisa: uisaValue,
      market: marketValue,
      diff,
      percentage: ((diff / marketValue) * 100).toFixed(1),
    };
  });

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6 max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={() => navigate("/")}>
            <ArrowLeft className="h-5 w-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-2xl font-bold">Benchmarking UISA vs Mercado</h1>
            <p className="text-sm text-muted-foreground">
              Compare perfis psicomÃ©tricos da UISA com referÃªncias do mercado por setor e cargo
            </p>
          </div>
        </div>

        {/* Filtros */}
        <Card>
          <CardHeader>
            <CardTitle>ConfiguraÃ§Ãµes de ComparaÃ§Ã£o</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="text-sm font-medium mb-2 block">Tipo de Teste</label>
                <Select value={testType} onValueChange={(value) => setTestType(value as "disc" | "bigFive")}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="disc">DISC</SelectItem>
                    <SelectItem value="bigFive">Big Five</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div>
                <label className="text-sm font-medium mb-2 block">Perfil de ReferÃªncia do Mercado</label>
                <Select value={selectedProfile} onValueChange={setSelectedProfile}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {Object.keys(testType === "disc" ? MARKET_PROFILES.disc : MARKET_PROFILES.bigFive).map((profile) => (
                      <SelectItem key={profile} value={profile}>
                        {profile}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* GrÃ¡fico Radar */}
        <Card>
          <CardHeader>
            <CardTitle>ComparaÃ§Ã£o Visual - GrÃ¡fico Radar</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[500px] flex items-center justify-center">
              <Radar data={radarData} options={radarOptions} />
            </div>
          </CardContent>
        </Card>

        {/* Tabela de DiferenÃ§as */}
        <Card>
          <CardHeader>
            <CardTitle>AnÃ¡lise Detalhada de DiferenÃ§as</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4">DimensÃ£o</th>
                    <th className="text-center py-3 px-4">UISA</th>
                    <th className="text-center py-3 px-4">Mercado</th>
                    <th className="text-center py-3 px-4">DiferenÃ§a</th>
                    <th className="text-center py-3 px-4">%</th>
                    <th className="text-center py-3 px-4">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {differences.map((item) => {
                    const isHigher = item.diff > 0;
                    const isSignificant = Math.abs(item.diff) >= 10;

                    return (
                      <tr key={item.dimension} className="border-b hover:bg-gray-50">
                        <td className="py-3 px-4 font-medium">
                          {testType === "disc" 
                            ? { D: "DominÃ¢ncia", I: "InfluÃªncia", S: "Estabilidade", C: "Conformidade" }[item.dimension]
                            : { O: "Abertura", C: "Conscienciosidade", E: "ExtroversÃ£o", A: "Amabilidade", N: "Neuroticismo" }[item.dimension]
                          }
                        </td>
                        <td className="text-center py-3 px-4">
                          <Badge variant="secondary">{item.uisa}</Badge>
                        </td>
                        <td className="text-center py-3 px-4">
                          <Badge variant="outline">{item.market}</Badge>
                        </td>
                        <td className="text-center py-3 px-4">
                          <span className={isHigher ? "text-green-600 font-semibold" : item.diff < 0 ? "text-red-600 font-semibold" : ""}>
                            {item.diff > 0 ? "+" : ""}{item.diff}
                          </span>
                        </td>
                        <td className="text-center py-3 px-4">
                          <span className={isHigher ? "text-green-600" : item.diff < 0 ? "text-red-600" : ""}>
                            {item.percentage}%
                          </span>
                        </td>
                        <td className="text-center py-3 px-4">
                          {isHigher ? (
                            <div className="flex items-center justify-center gap-1 text-green-600">
                              <TrendingUp className="h-4 w-4" />
                              <span className="text-xs">{isSignificant ? "Muito acima" : "Acima"}</span>
                            </div>
                          ) : item.diff < 0 ? (
                            <div className="flex items-center justify-center gap-1 text-red-600">
                              <TrendingDown className="h-4 w-4" />
                              <span className="text-xs">{isSignificant ? "Muito abaixo" : "Abaixo"}</span>
                            </div>
                          ) : (
                            <div className="flex items-center justify-center gap-1 text-gray-600">
                              <Minus className="h-4 w-4" />
                              <span className="text-xs">Igual</span>
                            </div>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>

        {/* Insights */}
        <Card className="bg-blue-50 border-blue-200">
          <CardHeader>
            <CardTitle className="text-blue-900">Insights e RecomendaÃ§Ãµes</CardTitle>
          </CardHeader>
          <CardContent>
            <ul className="space-y-2 text-sm text-blue-800">
              <li>â€¢ <strong>DiferenÃ§as significativas</strong> (â‰¥10 pontos) indicam Ã¡reas de desenvolvimento prioritÃ¡rias</li>
              <li>â€¢ <strong>Valores acima do mercado</strong> podem representar vantagens competitivas</li>
              <li>â€¢ <strong>Valores abaixo do mercado</strong> sugerem oportunidades de treinamento e desenvolvimento</li>
              <li>â€¢ Use esses dados para direcionar programas de T&D e recrutamento estratÃ©gico</li>
            </ul>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Calibracao.tsx
========================================
import DashboardLayout from "@/components/DashboardLayout";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { trpc } from "@/lib/trpc";
import { AlertCircle, ArrowDownUp, CheckCircle2, Edit, History, Loader2, TrendingDown, TrendingUp } from "lucide-react";
import { useState } from "react";
import { toast } from "sonner";

/**
 * PÃ¡gina de CalibraÃ§Ã£o de AvaliaÃ§Ãµes
 * Permite ajustar notas de avaliaÃ§Ãµes em reuniÃµes de consenso
 */

export default function Calibracao() {
  const [selectedEvaluation, setSelectedEvaluation] = useState<any | null>(null);
  const [showCalibrationDialog, setShowCalibrationDialog] = useState(false);
  const [showHistoryDialog, setShowHistoryDialog] = useState(false);
  const [calibrationData, setCalibrationData] = useState({
    originalScore: 0,
    newScore: 0,
    reason: "",
  });

  // Buscar avaliaÃ§Ãµes
  const { data: evaluations, isLoading, refetch } = trpc.calibration.getEvaluations.useQuery({});

  // Buscar histÃ³rico de calibraÃ§Ã£o
  const { data: history } = trpc.calibration.getHistory.useQuery(
    { evaluationId: selectedEvaluation?.id || 0 },
    { enabled: !!selectedEvaluation && showHistoryDialog }
  );

  // Mutation para salvar calibraÃ§Ã£o
  const saveCalibrationMutation = trpc.calibration.saveCalibration.useMutation({
    onSuccess: () => {
      toast.success("CalibraÃ§Ã£o salva com sucesso!");
      setShowCalibrationDialog(false);
      refetch();
    },
    onError: (error) => {
      toast.error(`Erro ao salvar calibraÃ§Ã£o: ${error.message}`);
    },
  });

  const handleOpenCalibration = (evaluation: any) => {
    setSelectedEvaluation(evaluation);
    setCalibrationData({
      originalScore: evaluation.finalScore || 0,
      newScore: evaluation.finalScore || 0,
      reason: "",
    });
    setShowCalibrationDialog(true);
  };

  const handleSaveCalibration = () => {
    if (!calibrationData.reason.trim()) {
      toast.error("Por favor, informe o motivo da calibraÃ§Ã£o");
      return;
    }

    if (calibrationData.newScore === calibrationData.originalScore) {
      toast.error("A nova nota deve ser diferente da nota original");
      return;
    }

    if (calibrationData.newScore < 0 || calibrationData.newScore > 100) {
      toast.error("A nota deve estar entre 0 e 100");
      return;
    }

    // Criar sessÃ£o temporÃ¡ria (em produÃ§Ã£o, criar sessÃ£o antes)
    saveCalibrationMutation.mutate({
      sessionId: 1, // TODO: Criar sessÃ£o real
      evaluationId: selectedEvaluation.id,
      originalScore: calibrationData.originalScore,
      calibratedScore: calibrationData.newScore,
      reason: calibrationData.reason,
    });
  };

  const getScoreDiff = () => {
    const diff = calibrationData.newScore - calibrationData.originalScore;
    if (diff > 0) {
      return (
        <div className="flex items-center gap-1 text-green-600 dark:text-green-400">
          <TrendingUp className="h-4 w-4" />
          <span>+{diff.toFixed(1)}</span>
        </div>
      );
    } else if (diff < 0) {
      return (
        <div className="flex items-center gap-1 text-red-600 dark:text-red-400">
          <TrendingDown className="h-4 w-4" />
          <span>{diff.toFixed(1)}</span>
        </div>
      );
    }
    return null;
  };

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
            <ArrowDownUp className="h-8 w-8" />
            CalibraÃ§Ã£o de AvaliaÃ§Ãµes
          </h1>
          <p className="text-muted-foreground mt-2">
            Ajuste as notas das avaliaÃ§Ãµes em reuniÃµes de consenso para garantir consistÃªncia
          </p>
        </div>

        {/* EstatÃ­sticas */}
        <div className="grid md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Total de AvaliaÃ§Ãµes
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{evaluations?.length || 0}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                ConcluÃ­das
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-green-600">
                {evaluations?.filter(e => e.status === "concluida").length || 0}
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Em Andamento
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-yellow-600">
                {evaluations?.filter(e => e.status === "em_andamento").length || 0}
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                MÃ©dia Geral
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {evaluations && evaluations.length > 0
                  ? (evaluations.reduce((sum, e) => sum + (e.finalScore || 0), 0) / evaluations.length).toFixed(1)
                  : "0.0"}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de AvaliaÃ§Ãµes */}
        <div className="space-y-4">
          {!evaluations || evaluations.length === 0 ? (
            <Card>
              <CardContent className="flex flex-col items-center justify-center py-12">
                <AlertCircle className="h-12 w-12 text-muted-foreground mb-4" />
                <p className="text-muted-foreground">Nenhuma avaliaÃ§Ã£o encontrada</p>
              </CardContent>
            </Card>
          ) : (
            evaluations.map((evaluation) => (
              <Card key={evaluation.id}>
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <CardTitle className="text-base flex items-center gap-2">
                        Colaborador #{evaluation.employeeId}
                        <Badge variant="outline">Ciclo #{evaluation.cycleId}</Badge>
                        <Badge variant={
                          evaluation.status === "concluida" ? "default" :
                          evaluation.status === "em_andamento" ? "secondary" : "outline"
                        }>
                          {evaluation.status === "concluida" ? "ConcluÃ­da" :
                           evaluation.status === "em_andamento" ? "Em Andamento" : "Pendente"}
                        </Badge>
                      </CardTitle>
                      <CardDescription className="mt-2">
                        AvaliaÃ§Ã£o {evaluation.type}
                      </CardDescription>
                    </div>
                    <div className="text-right">
                      <div className="text-2xl font-bold">
                        {evaluation.finalScore !== null ? evaluation.finalScore.toFixed(1) : "N/A"}
                      </div>
                      <p className="text-xs text-muted-foreground">Nota Final</p>
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <p className="text-muted-foreground">AutoavaliaÃ§Ã£o</p>
                      <p className="font-medium flex items-center gap-1">
                        {evaluation.selfEvaluationCompleted ? (
                          <>
                            <CheckCircle2 className="h-3 w-3 text-green-600" />
                            Completa
                          </>
                        ) : (
                          "Pendente"
                        )}
                      </p>
                    </div>
                    <div>
                      <p className="text-muted-foreground">Gestor</p>
                      <p className="font-medium flex items-center gap-1">
                        {evaluation.managerEvaluationCompleted ? (
                          <>
                            <CheckCircle2 className="h-3 w-3 text-green-600" />
                            Completa
                          </>
                        ) : (
                          "Pendente"
                        )}
                      </p>
                    </div>
                    <div>
                      <p className="text-muted-foreground">Pares</p>
                      <p className="font-medium flex items-center gap-1">
                        {evaluation.peersEvaluationCompleted ? (
                          <>
                            <CheckCircle2 className="h-3 w-3 text-green-600" />
                            Completa
                          </>
                        ) : (
                          "Pendente"
                        )}
                      </p>
                    </div>
                    <div>
                      <p className="text-muted-foreground">Subordinados</p>
                      <p className="font-medium flex items-center gap-1">
                        {evaluation.subordinatesEvaluationCompleted ? (
                          <>
                            <CheckCircle2 className="h-3 w-3 text-green-600" />
                            Completa
                          </>
                        ) : (
                          "Pendente"
                        )}
                      </p>
                    </div>
                  </div>

                  <div className="flex gap-2 pt-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleOpenCalibration(evaluation)}
                      disabled={!evaluation.finalScore}
                    >
                      <Edit className="h-4 w-4 mr-2" />
                      Calibrar
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => {
                        setSelectedEvaluation(evaluation);
                        setShowHistoryDialog(true);
                      }}
                    >
                      <History className="h-4 w-4 mr-2" />
                      HistÃ³rico
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))
          )}
        </div>
      </div>

      {/* Dialog de CalibraÃ§Ã£o */}
      <Dialog open={showCalibrationDialog} onOpenChange={setShowCalibrationDialog}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Calibrar AvaliaÃ§Ã£o</DialogTitle>
            <DialogDescription>
              Ajuste a nota final da avaliaÃ§Ã£o e informe o motivo
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>Nota Original</Label>
              <Input
                type="number"
                value={calibrationData.originalScore}
                disabled
                className="bg-muted"
              />
            </div>

            <div className="space-y-2">
              <Label>Nova Nota (0-100)</Label>
              <Input
                type="number"
                min="0"
                max="100"
                step="0.1"
                value={calibrationData.newScore}
                onChange={(e) => setCalibrationData({
                  ...calibrationData,
                  newScore: parseFloat(e.target.value) || 0
                })}
              />
            </div>

            {getScoreDiff() && (
              <div className="flex items-center gap-2 p-3 bg-muted rounded-lg">
                <span className="text-sm text-muted-foreground">DiferenÃ§a:</span>
                {getScoreDiff()}
              </div>
            )}

            <div className="space-y-2">
              <Label>Motivo da CalibraÃ§Ã£o *</Label>
              <Textarea
                placeholder="Descreva o motivo do ajuste (ex: alinhamento com critÃ©rios do departamento, consenso da equipe...)"
                value={calibrationData.reason}
                onChange={(e) => setCalibrationData({
                  ...calibrationData,
                  reason: e.target.value
                })}
                rows={4}
              />
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowCalibrationDialog(false)}>
              Cancelar
            </Button>
            <Button
              onClick={handleSaveCalibration}
              disabled={saveCalibrationMutation.isPending}
            >
              {saveCalibrationMutation.isPending ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Salvando...
                </>
              ) : (
                "Salvar CalibraÃ§Ã£o"
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog de HistÃ³rico */}
      <Dialog open={showHistoryDialog} onOpenChange={setShowHistoryDialog}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>HistÃ³rico de CalibraÃ§Ãµes</DialogTitle>
            <DialogDescription>
              Todas as calibraÃ§Ãµes realizadas para esta avaliaÃ§Ã£o
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4 max-h-96 overflow-y-auto">
            {!history || history.length === 0 ? (
              <div className="text-center py-8 text-muted-foreground">
                Nenhuma calibraÃ§Ã£o realizada ainda
              </div>
            ) : (
              history.map((item) => (
                <Card key={item.id}>
                  <CardContent className="pt-4">
                    <div className="flex items-start justify-between mb-2">
                      <div>
                        <p className="font-medium">
                          {item.originalScore} â†’ {item.calibratedScore}
                        </p>
                        <p className="text-sm text-muted-foreground">
                          Revisado por #{item.reviewedBy}
                        </p>
                      </div>
                      <div className="text-right text-sm text-muted-foreground">
                        {new Date(item.createdAt).toLocaleDateString('pt-BR')}
                      </div>
                    </div>
                    <p className="text-sm mt-2 p-3 bg-muted rounded">
                      {item.reason}
                    </p>
                  </CardContent>
                </Card>
              ))
            )}
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowHistoryDialog(false)}>
              Fechar
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/CentrosCusto.tsx
========================================
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { DollarSign } from "lucide-react";

export default function CentrosCusto() {
  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div className="flex items-center gap-2">
          <DollarSign className="h-8 w-8" />
          <h1 className="text-3xl font-bold">Centros de Custo</h1>
        </div>
        <Card>
          <CardHeader>
            <CardTitle>Em desenvolvimento</CardTitle>
          </CardHeader>
          <CardContent>
            <p>PÃ¡gina de gestÃ£o de centros de custo em desenvolvimento.</p>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/CiclosAvaliacao.tsx
========================================
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { trpc } from "@/lib/trpc";
import { Calendar, CheckCircle2, Clock, Loader2, Pause, Play, Plus, Trash2, XCircle } from "lucide-react";
import { useState } from "react";
import { toast } from "sonner";

/**
 * PÃ¡gina de GestÃ£o de Ciclos de AvaliaÃ§Ã£o
 * CRUD completo para criar e gerenciar ciclos anuais/semestrais/trimestrais
 */
export default function CiclosAvaliacao() {
  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
  const [formData, setFormData] = useState({
    name: "",
    year: new Date().getFullYear(),
    type: "anual" as "anual" | "semestral" | "trimestral",
    startDate: "",
    endDate: "",
    selfEvaluationDeadline: "",
    managerEvaluationDeadline: "",
    consensusDeadline: "",
    description: "",
  });

  const { data: cycles, isLoading, refetch } = trpc.evaluationCycles.list.useQuery();

  const createMutation = trpc.evaluationCycles.create.useMutation({
    onSuccess: () => {
      toast.success("Ciclo criado com sucesso!");
      setIsCreateDialogOpen(false);
      refetch();
      setFormData({
        name: "",
        year: new Date().getFullYear(),
        type: "anual",
        startDate: "",
        endDate: "",
        selfEvaluationDeadline: "",
        managerEvaluationDeadline: "",
        consensusDeadline: "",
        description: "",
      });
    },
    onError: (error) => {
      toast.error(`Erro ao criar ciclo: ${error.message}`);
    },
  });

  const activateMutation = trpc.evaluationCycles.activate.useMutation({
    onSuccess: () => {
      toast.success("Ciclo ativado!");
      refetch();
    },
  });

  const deactivateMutation = trpc.evaluationCycles.deactivate.useMutation({
    onSuccess: () => {
      toast.success("Ciclo desativado!");
      refetch();
    },
  });

  const completeMutation = trpc.evaluationCycles.complete.useMutation({
    onSuccess: () => {
      toast.success("Ciclo concluÃ­do!");
      refetch();
    },
  });

  const deleteMutation = trpc.evaluationCycles.delete.useMutation({
    onSuccess: () => {
      toast.success("Ciclo deletado!");
      refetch();
    },
  });

  const handleCreate = () => {
    createMutation.mutate(formData);
  };

  const getStatusBadge = (status: string) => {
    const statusMap = {
      planejamento: { label: "Planejamento", variant: "secondary" as const, icon: Clock },
      em_andamento: { label: "Em Andamento", variant: "default" as const, icon: Play },
      concluido: { label: "ConcluÃ­do", variant: "outline" as const, icon: CheckCircle2 },
      cancelado: { label: "Cancelado", variant: "destructive" as const, icon: XCircle },
    };

    const config = statusMap[status as keyof typeof statusMap] || statusMap.planejamento;
    const Icon = config.icon;

    return (
      <Badge variant={config.variant} className="flex items-center gap-1">
        <Icon className="h-3 w-3" />
        {config.label}
      </Badge>
    );
  };

  const getTypeBadge = (type: string) => {
    const typeMap = {
      anual: { label: "Anual", color: "bg-blue-100 text-blue-800" },
      semestral: { label: "Semestral", color: "bg-green-100 text-green-800" },
      trimestral: { label: "Trimestral", color: "bg-purple-100 text-purple-800" },
    };

    const config = typeMap[type as keyof typeof typeMap] || typeMap.anual;

    return (
      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.color}`}>
        {config.label}
      </span>
    );
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">GestÃ£o de Ciclos de AvaliaÃ§Ã£o</h1>
          <p className="text-muted-foreground mt-1">
            Crie e gerencie ciclos anuais, semestrais ou trimestrais de avaliaÃ§Ã£o 360Â°
          </p>
        </div>

        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>
          <DialogTrigger asChild>
            <Button size="lg">
              <Plus className="h-5 w-5 mr-2" />
              Novo Ciclo
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle>Criar Novo Ciclo de AvaliaÃ§Ã£o</DialogTitle>
              <DialogDescription>
                Defina o perÃ­odo, tipo e prazos de cada etapa do ciclo
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4 py-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="name">Nome do Ciclo *</Label>
                  <Input
                    id="name"
                    placeholder="Ex: AvaliaÃ§Ã£o Anual 2026"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="year">Ano *</Label>
                  <Input
                    id="year"
                    type="number"
                    value={formData.year}
                    onChange={(e) => setFormData({ ...formData, year: parseInt(e.target.value) })}
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="type">Tipo de Ciclo *</Label>
                <Select
                  value={formData.type}
                  onValueChange={(value: any) => setFormData({ ...formData, type: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="anual">Anual</SelectItem>
                    <SelectItem value="semestral">Semestral</SelectItem>
                    <SelectItem value="trimestral">Trimestral</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="startDate">Data InÃ­cio *</Label>
                  <Input
                    id="startDate"
                    type="date"
                    value={formData.startDate}
                    onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="endDate">Data Fim *</Label>
                  <Input
                    id="endDate"
                    type="date"
                    value={formData.endDate}
                    onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                  />
                </div>
              </div>

              <div className="border-t pt-4">
                <h3 className="font-medium mb-3">Prazos por Etapa do Fluxo 360Â°</h3>

                <div className="space-y-3">
                  <div className="space-y-2">
                    <Label htmlFor="selfDeadline">Prazo AutoavaliaÃ§Ã£o</Label>
                    <Input
                      id="selfDeadline"
                      type="date"
                      value={formData.selfEvaluationDeadline}
                      onChange={(e) => setFormData({ ...formData, selfEvaluationDeadline: e.target.value })}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="managerDeadline">Prazo AvaliaÃ§Ã£o do Gestor</Label>
                    <Input
                      id="managerDeadline"
                      type="date"
                      value={formData.managerEvaluationDeadline}
                      onChange={(e) => setFormData({ ...formData, managerEvaluationDeadline: e.target.value })}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="consensusDeadline">Prazo Consenso do LÃ­der</Label>
                    <Input
                      id="consensusDeadline"
                      type="date"
                      value={formData.consensusDeadline}
                      onChange={(e) => setFormData({ ...formData, consensusDeadline: e.target.value })}
                    />
                  </div>
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="description">DescriÃ§Ã£o</Label>
                <Textarea
                  id="description"
                  placeholder="Descreva os objetivos e escopo deste ciclo..."
                  rows={3}
                  value={formData.description}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                />
              </div>
            </div>

            <div className="flex justify-end gap-2">
              <Button variant="outline" onClick={() => setIsCreateDialogOpen(false)}>
                Cancelar
              </Button>
              <Button onClick={handleCreate} disabled={createMutation.isPending}>
                {createMutation.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                Criar Ciclo
              </Button>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      {/* Lista de Ciclos */}
      <div className="grid gap-4">
        {cycles && cycles.length === 0 && (
          <Card>
            <CardContent className="py-12 text-center">
              <Calendar className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
              <p className="text-muted-foreground">Nenhum ciclo criado ainda</p>
              <p className="text-sm text-muted-foreground mt-1">
                Clique em "Novo Ciclo" para comeÃ§ar
              </p>
            </CardContent>
          </Card>
        )}

        {cycles?.map((cycle) => (
          <Card key={cycle.id}>
            <CardHeader>
              <div className="flex items-start justify-between">
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    <CardTitle>{cycle.name}</CardTitle>
                    {getTypeBadge(cycle.type)}
                    {getStatusBadge(cycle.status)}
                  </div>
                  <CardDescription>
                    {new Date(cycle.startDate).toLocaleDateString("pt-BR")} -{" "}
                    {new Date(cycle.endDate).toLocaleDateString("pt-BR")}
                  </CardDescription>
                </div>

                <div className="flex gap-2">
                  {cycle.status === "planejamento" && (
                    <Button
                      size="sm"
                      variant="default"
                      onClick={() => activateMutation.mutate({ id: cycle.id })}
                    >
                      <Play className="h-4 w-4 mr-1" />
                      Ativar
                    </Button>
                  )}

                  {cycle.status === "em_andamento" && (
                    <>
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => completeMutation.mutate({ id: cycle.id })}
                      >
                        <CheckCircle2 className="h-4 w-4 mr-1" />
                        Concluir
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => deactivateMutation.mutate({ id: cycle.id })}
                      >
                        <Pause className="h-4 w-4 mr-1" />
                        Cancelar
                      </Button>
                    </>
                  )}

                  {(cycle.status === "concluido" || cycle.status === "cancelado") && (
                    <Button
                      size="sm"
                      variant="destructive"
                      onClick={() => {
                        if (confirm("Tem certeza que deseja deletar este ciclo?")) {
                          deleteMutation.mutate({ id: cycle.id });
                        }
                      }}
                    >
                      <Trash2 className="h-4 w-4 mr-1" />
                      Deletar
                    </Button>
                  )}
                </div>
              </div>
            </CardHeader>

            <CardContent>
              {cycle.description && (
                <p className="text-sm text-muted-foreground mb-4">{cycle.description}</p>
              )}

              {(cycle.selfEvaluationDeadline || cycle.managerEvaluationDeadline || cycle.consensusDeadline) && (
                <div className="border-t pt-4">
                  <h4 className="text-sm font-medium mb-2">Prazos por Etapa:</h4>
                  <div className="grid grid-cols-3 gap-4 text-sm">
                    {cycle.selfEvaluationDeadline && (
                      <div>
                        <span className="text-muted-foreground">AutoavaliaÃ§Ã£o:</span>
                        <p className="font-medium">
                          {new Date(cycle.selfEvaluationDeadline).toLocaleDateString("pt-BR")}
                        </p>
                      </div>
                    )}
                    {cycle.managerEvaluationDeadline && (
                      <div>
                        <span className="text-muted-foreground">Gestor:</span>
                        <p className="font-medium">
                          {new Date(cycle.managerEvaluationDeadline).toLocaleDateString("pt-BR")}
                        </p>
                      </div>
                    )}
                    {cycle.consensusDeadline && (
                      <div>
                        <span className="text-muted-foreground">Consenso:</span>
                        <p className="font-medium">
                          {new Date(cycle.consensusDeadline).toLocaleDateString("pt-BR")}
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/ComponentShowcase.tsx
========================================
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { AspectRatio } from "@/components/ui/aspect-ratio";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";
import { Button } from "@/components/ui/button";
import { Calendar } from "@/components/ui/calendar";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselNext,
  CarouselPrevious,
} from "@/components/ui/carousel";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from "@/components/ui/command";
import {
  ContextMenu,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuTrigger,
} from "@/components/ui/context-menu";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  Drawer,
  DrawerClose,
  DrawerContent,
  DrawerDescription,
  DrawerFooter,
  DrawerHeader,
  DrawerTitle,
  DrawerTrigger,
} from "@/components/ui/drawer";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  HoverCard,
  HoverCardContent,
  HoverCardTrigger,
} from "@/components/ui/hover-card";
import { Input } from "@/components/ui/input";
import {
  InputOTP,
  InputOTPGroup,
  InputOTPSlot,
} from "@/components/ui/input-otp";
import { Label } from "@/components/ui/label";
import {
  Menubar,
  MenubarContent,
  MenubarItem,
  MenubarMenu,
  MenubarSeparator,
  MenubarTrigger,
} from "@/components/ui/menubar";
import {
  Pagination,
  PaginationContent,
  PaginationItem,
  PaginationLink,
  PaginationNext,
  PaginationPrevious,
} from "@/components/ui/pagination";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";
import { Progress } from "@/components/ui/progress";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from "@/components/ui/resizable";
import { ScrollArea } from "@/components/ui/scroll-area";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Separator } from "@/components/ui/separator";
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet";
import { Skeleton } from "@/components/ui/skeleton";
import { Slider } from "@/components/ui/slider";
import { Switch } from "@/components/ui/switch";
import {
  Table,
  TableBody,
  TableCaption,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Textarea } from "@/components/ui/textarea";
import { Toggle } from "@/components/ui/toggle";
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { useTheme } from "@/contexts/ThemeContext";
import { format } from "date-fns";
import { zhCN } from "date-fns/locale";
import {
  AlertCircle,
  CalendarIcon,
  Check,
  Clock,
  Moon,
  Sun,
  X,
} from "lucide-react";
import { useState } from "react";
import { toast as sonnerToast } from "sonner";
import { AIChatBox, type Message } from "@/components/AIChatBox";

export default function ComponentsShowcase() {
  const { theme, toggleTheme } = useTheme();
  const [date, setDate] = useState<Date | undefined>(new Date());
  const [datePickerDate, setDatePickerDate] = useState<Date>();
  const [selectedFruits, setSelectedFruits] = useState<string[]>([]);
  const [progress, setProgress] = useState(33);
  const [currentPage, setCurrentPage] = useState(2);
  const [openCombobox, setOpenCombobox] = useState(false);
  const [selectedFramework, setSelectedFramework] = useState("");
  const [selectedMonth, setSelectedMonth] = useState("");
  const [selectedYear, setSelectedYear] = useState("");
  const [dialogInput, setDialogInput] = useState("");
  const [dialogOpen, setDialogOpen] = useState(false);

  // AI ChatBox demo state
  const [chatMessages, setChatMessages] = useState<Message[]>([
    { role: "system", content: "You are a helpful assistant." },
  ]);
  const [isChatLoading, setIsChatLoading] = useState(false);

  const handleDialogSubmit = () => {
    console.log("Dialog submitted with value:", dialogInput);
    sonnerToast.success("Submitted successfully", {
      description: `Input: ${dialogInput}`,
    });
    setDialogInput("");
    setDialogOpen(false);
  };

  const handleDialogKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === "Enter" && !e.nativeEvent.isComposing) {
      e.preventDefault();
      handleDialogSubmit();
    }
  };

  const handleChatSend = (content: string) => {
    // Add user message
    const newMessages: Message[] = [...chatMessages, { role: "user", content }];
    setChatMessages(newMessages);

    // Simulate AI response with delay
    setIsChatLoading(true);
    setTimeout(() => {
      const aiResponse: Message = {
        role: "assistant",
        content: `This is a **demo response**. In a real app, you would call a tRPC mutation here:\n\n\`\`\`typescript\nconst chatMutation = trpc.ai.chat.useMutation({\n  onSuccess: (response) => {\n    setChatMessages(prev => [...prev, {\n      role: "assistant",\n      content: response.choices[0].message.content\n    }]);\n  }\n});\n\nchatMutation.mutate({ messages: newMessages });\n\`\`\`\n\nYour message was: "${content}"`,
      };
      setChatMessages([...newMessages, aiResponse]);
      setIsChatLoading(false);
    }, 1500);
  };

  return (
    <div className="min-h-screen bg-background text-foreground">
      <main className="container max-w-6xl mx-auto">
        <div className="space-y-2 justify-between flex">
          <h2 className="text-3xl font-bold tracking-tight mb-6">
            Shadcn/ui Component Library
          </h2>
          <Button variant="outline" size="icon" onClick={toggleTheme}>
            {theme === "light" ? (
              <Moon className="h-5 w-5" />
            ) : (
              <Sun className="h-5 w-5" />
            )}
          </Button>
        </div>

        <div className="space-y-12">
          {/* Text Colors Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Text Colors</h3>
            <Card>
              <CardContent className="pt-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-3">
                    <div>
                      <p className="text-sm text-muted-foreground mb-1">
                        Foreground (Default)
                      </p>
                      <p className="text-foreground text-lg">
                        Default text color for main content
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground mb-1">
                        Muted Foreground
                      </p>
                      <p className="text-muted-foreground text-lg">
                        Muted text for secondary information
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground mb-1">
                        Primary
                      </p>
                      <p className="text-primary text-lg font-medium">
                        Primary brand color text
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground mb-1">
                        Secondary Foreground
                      </p>
                      <p className="text-secondary-foreground text-lg">
                        Secondary action text color
                      </p>
                    </div>
                  </div>
                  <div className="space-y-3">
                    <div>
                      <p className="text-sm text-muted-foreground mb-1">
                        Accent Foreground
                      </p>
                      <p className="text-accent-foreground text-lg">
                        Accent text for emphasis
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground mb-1">
                        Destructive
                      </p>
                      <p className="text-destructive text-lg font-medium">
                        Error or destructive action text
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground mb-1">
                        Card Foreground
                      </p>
                      <p className="text-card-foreground text-lg">
                        Text color on card backgrounds
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground mb-1">
                        Popover Foreground
                      </p>
                      <p className="text-popover-foreground text-lg">
                        Text color in popovers
                      </p>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Color Combinations Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Color Combinations</h3>
            <Card>
              <CardContent className="pt-6">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div className="bg-primary text-primary-foreground rounded-lg p-4">
                    <p className="font-medium mb-1">Primary</p>
                    <p className="text-sm opacity-90">
                      Primary background with foreground text
                    </p>
                  </div>
                  <div className="bg-secondary text-secondary-foreground rounded-lg p-4">
                    <p className="font-medium mb-1">Secondary</p>
                    <p className="text-sm opacity-90">
                      Secondary background with foreground text
                    </p>
                  </div>
                  <div className="bg-muted text-muted-foreground rounded-lg p-4">
                    <p className="font-medium mb-1">Muted</p>
                    <p className="text-sm opacity-90">
                      Muted background with foreground text
                    </p>
                  </div>
                  <div className="bg-accent text-accent-foreground rounded-lg p-4">
                    <p className="font-medium mb-1">Accent</p>
                    <p className="text-sm opacity-90">
                      Accent background with foreground text
                    </p>
                  </div>
                  <div className="bg-destructive text-destructive-foreground rounded-lg p-4">
                    <p className="font-medium mb-1">Destructive</p>
                    <p className="text-sm opacity-90">
                      Destructive background with foreground text
                    </p>
                  </div>
                  <div className="bg-card text-card-foreground rounded-lg p-4 border">
                    <p className="font-medium mb-1">Card</p>
                    <p className="text-sm opacity-90">
                      Card background with foreground text
                    </p>
                  </div>
                  <div className="bg-popover text-popover-foreground rounded-lg p-4 border">
                    <p className="font-medium mb-1">Popover</p>
                    <p className="text-sm opacity-90">
                      Popover background with foreground text
                    </p>
                  </div>
                  <div className="bg-background text-foreground rounded-lg p-4 border">
                    <p className="font-medium mb-1">Background</p>
                    <p className="text-sm opacity-90">
                      Default background with foreground text
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Buttons Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Buttons</h3>
            <Card>
              <CardContent className="pt-6">
                <div className="flex flex-wrap gap-4">
                  <Button>Default</Button>
                  <Button variant="secondary">Secondary</Button>
                  <Button variant="destructive">Destructive</Button>
                  <Button variant="outline">Outline</Button>
                  <Button variant="ghost">Ghost</Button>
                  <Button variant="link">Link</Button>
                  <Button size="sm">Small</Button>
                  <Button size="lg">Large</Button>
                  <Button size="icon">
                    <Check className="h-4 w-4" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Form Inputs Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Form Inputs</h3>
            <Card>
              <CardContent className="pt-6 space-y-6">
                <div className="space-y-2">
                  <Label htmlFor="email">Email</Label>
                  <Input id="email" type="email" placeholder="Email" />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="message">Message</Label>
                  <Textarea
                    id="message"
                    placeholder="Type your message here."
                  />
                </div>
                <div className="space-y-2">
                  <Label>Select</Label>
                  <Select>
                    <SelectTrigger>
                      <SelectValue placeholder="Select a fruit" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="apple">Apple</SelectItem>
                      <SelectItem value="banana">Banana</SelectItem>
                      <SelectItem value="orange">Orange</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="flex items-center space-x-2">
                  <Checkbox id="terms" />
                  <Label htmlFor="terms">Accept terms and conditions</Label>
                </div>
                <div className="flex items-center space-x-2">
                  <Switch id="airplane-mode" />
                  <Label htmlFor="airplane-mode">Airplane Mode</Label>
                </div>
                <div className="space-y-2">
                  <Label>Radio Group</Label>
                  <RadioGroup defaultValue="option-one">
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="option-one" id="option-one" />
                      <Label htmlFor="option-one">Option One</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="option-two" id="option-two" />
                      <Label htmlFor="option-two">Option Two</Label>
                    </div>
                  </RadioGroup>
                </div>
                <div className="space-y-2">
                  <Label>Slider</Label>
                  <Slider defaultValue={[50]} max={100} step={1} />
                </div>
                <div className="space-y-2">
                  <Label>Input OTP</Label>
                  <InputOTP maxLength={6}>
                    <InputOTPGroup>
                      <InputOTPSlot index={0} />
                      <InputOTPSlot index={1} />
                      <InputOTPSlot index={2} />
                      <InputOTPSlot index={3} />
                      <InputOTPSlot index={4} />
                      <InputOTPSlot index={5} />
                    </InputOTPGroup>
                  </InputOTP>
                </div>
                <div className="space-y-2">
                  <Label>Date Time Picker</Label>
                  <Popover>
                    <PopoverTrigger asChild>
                      <Button
                        variant="outline"
                        className={`w-full justify-start text-left font-normal ${
                          !datePickerDate && "text-muted-foreground"
                        }`}
                      >
                        <CalendarIcon className="mr-2 h-4 w-4" />
                        {datePickerDate ? (
                          format(datePickerDate, "PPP HH:mm", { locale: zhCN })
                        ) : (
                          <span>Select date and time</span>
                        )}
                      </Button>
                    </PopoverTrigger>
                    <PopoverContent className="w-auto p-0" align="start">
                      <div className="p-3 space-y-3">
                        <Calendar
                          mode="single"
                          selected={datePickerDate}
                          onSelect={setDatePickerDate}
                        />
                        <div className="border-t pt-3 space-y-2">
                          <Label className="flex items-center gap-2">
                            <Clock className="h-4 w-4" />
                            Time
                          </Label>
                          <div className="flex gap-2">
                            <Input
                              type="time"
                              value={
                                datePickerDate
                                  ? format(datePickerDate, "HH:mm")
                                  : "00:00"
                              }
                              onChange={e => {
                                const [hours, minutes] =
                                  e.target.value.split(":");
                                const newDate = datePickerDate
                                  ? new Date(datePickerDate)
                                  : new Date();
                                newDate.setHours(parseInt(hours));
                                newDate.setMinutes(parseInt(minutes));
                                setDatePickerDate(newDate);
                              }}
                            />
                          </div>
                        </div>
                      </div>
                    </PopoverContent>
                  </Popover>
                  {datePickerDate && (
                    <p className="text-sm text-muted-foreground">
                      Selected:{" "}
                      {format(datePickerDate, "yyyy/MM/dd  HH:mm", {
                        locale: zhCN,
                      })}
                    </p>
                  )}
                </div>
                <div className="space-y-2">
                  <Label>Searchable Dropdown</Label>
                  <Popover open={openCombobox} onOpenChange={setOpenCombobox}>
                    <PopoverTrigger asChild>
                      <Button
                        variant="outline"
                        role="combobox"
                        aria-expanded={openCombobox}
                        className="w-full justify-between"
                      >
                        {selectedFramework
                          ? [
                              { value: "react", label: "React" },
                              { value: "vue", label: "Vue" },
                              { value: "angular", label: "Angular" },
                              { value: "svelte", label: "Svelte" },
                              { value: "nextjs", label: "Next.js" },
                              { value: "nuxt", label: "Nuxt" },
                              { value: "remix", label: "Remix" },
                            ].find(fw => fw.value === selectedFramework)?.label
                          : "Select framework..."}
                        <CalendarIcon className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                      </Button>
                    </PopoverTrigger>
                    <PopoverContent className="w-full p-0">
                      <Command>
                        <CommandInput placeholder="Search frameworks..." />
                        <CommandList>
                          <CommandEmpty>No framework found</CommandEmpty>
                          <CommandGroup>
                            {[
                              { value: "react", label: "React" },
                              { value: "vue", label: "Vue" },
                              { value: "angular", label: "Angular" },
                              { value: "svelte", label: "Svelte" },
                              { value: "nextjs", label: "Next.js" },
                              { value: "nuxt", label: "Nuxt" },
                              { value: "remix", label: "Remix" },
                            ].map(framework => (
                              <CommandItem
                                key={framework.value}
                                value={framework.value}
                                onSelect={currentValue => {
                                  setSelectedFramework(
                                    currentValue === selectedFramework
                                      ? ""
                                      : currentValue
                                  );
                                  setOpenCombobox(false);
                                }}
                              >
                                <Check
                                  className={`mr-2 h-4 w-4 ${
                                    selectedFramework === framework.value
                                      ? "opacity-100"
                                      : "opacity-0"
                                  }`}
                                />
                                {framework.label}
                              </CommandItem>
                            ))}
                          </CommandGroup>
                        </CommandList>
                      </Command>
                    </PopoverContent>
                  </Popover>
                  {selectedFramework && (
                    <p className="text-sm text-muted-foreground">
                      Selected:{" "}
                      {
                        [
                          { value: "react", label: "React" },
                          { value: "vue", label: "Vue" },
                          { value: "angular", label: "Angular" },
                          { value: "svelte", label: "Svelte" },
                          { value: "nextjs", label: "Next.js" },
                          { value: "nuxt", label: "Nuxt" },
                          { value: "remix", label: "Remix" },
                        ].find(fw => fw.value === selectedFramework)?.label
                      }
                    </p>
                  )}
                </div>
                <div className="space-y-2">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <Label htmlFor="month" className="text-sm font-medium">
                        Month
                      </Label>
                      <Select
                        value={selectedMonth}
                        onValueChange={setSelectedMonth}
                      >
                        <SelectTrigger id="month">
                          <SelectValue placeholder="MM" />
                        </SelectTrigger>
                        <SelectContent>
                          {Array.from({ length: 12 }, (_, i) => i + 1).map(
                            month => (
                              <SelectItem
                                key={month}
                                value={month.toString().padStart(2, "0")}
                              >
                                {month.toString().padStart(2, "0")}
                              </SelectItem>
                            )
                          )}
                        </SelectContent>
                      </Select>
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="year" className="text-sm font-medium">
                        Year
                      </Label>
                      <Select
                        value={selectedYear}
                        onValueChange={setSelectedYear}
                      >
                        <SelectTrigger id="year">
                          <SelectValue placeholder="YYYY" />
                        </SelectTrigger>
                        <SelectContent>
                          {Array.from(
                            { length: 10 },
                            (_, i) => new Date().getFullYear() - 5 + i
                          ).map(year => (
                            <SelectItem key={year} value={year.toString()}>
                              {year}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>
                  </div>
                  {selectedMonth && selectedYear && (
                    <p className="text-sm text-muted-foreground">
                      Selected: {selectedYear}/{selectedMonth}/
                    </p>
                  )}
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Data Display Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Data Display</h3>
            <Card>
              <CardContent className="pt-6 space-y-6">
                <div className="space-y-2">
                  <Label>Badges</Label>
                  <div className="flex flex-wrap gap-2">
                    <Badge>Default</Badge>
                    <Badge variant="secondary">Secondary</Badge>
                    <Badge variant="destructive">Destructive</Badge>
                    <Badge variant="outline">Outline</Badge>
                  </div>
                </div>
                <Separator />
                <div className="space-y-2">
                  <Label>Avatar</Label>
                  <div className="flex gap-4">
                    <Avatar>
                      <AvatarImage src="https://github.com/shadcn.png" />
                      <AvatarFallback>CN</AvatarFallback>
                    </Avatar>
                    <Avatar>
                      <AvatarFallback>AB</AvatarFallback>
                    </Avatar>
                  </div>
                </div>
                <Separator />
                <div className="space-y-2">
                  <Label>Progress</Label>
                  <Progress value={progress} />
                  <div className="flex gap-2">
                    <Button
                      size="sm"
                      onClick={() => setProgress(Math.max(0, progress - 10))}
                    >
                      -10
                    </Button>
                    <Button
                      size="sm"
                      onClick={() => setProgress(Math.min(100, progress + 10))}
                    >
                      +10
                    </Button>
                  </div>
                </div>
                <Separator />
                <div className="space-y-2">
                  <Label>Skeleton</Label>
                  <div className="space-y-2">
                    <Skeleton className="h-4 w-full" />
                    <Skeleton className="h-4 w-3/4" />
                    <Skeleton className="h-4 w-1/2" />
                  </div>
                </div>
                <Separator />
                <div className="space-y-2">
                  <Label>Pagination</Label>
                  <Pagination>
                    <PaginationContent>
                      <PaginationItem>
                        <PaginationPrevious
                          href="#"
                          onClick={e => {
                            e.preventDefault();
                            setCurrentPage(Math.max(1, currentPage - 1));
                          }}
                        />
                      </PaginationItem>
                      {[1, 2, 3, 4, 5].map(page => (
                        <PaginationItem key={page}>
                          <PaginationLink
                            href="#"
                            isActive={currentPage === page}
                            onClick={e => {
                              e.preventDefault();
                              setCurrentPage(page);
                            }}
                          >
                            {page}
                          </PaginationLink>
                        </PaginationItem>
                      ))}
                      <PaginationItem>
                        <PaginationNext
                          href="#"
                          onClick={e => {
                            e.preventDefault();
                            setCurrentPage(Math.min(5, currentPage + 1));
                          }}
                        />
                      </PaginationItem>
                    </PaginationContent>
                  </Pagination>
                  <p className="text-sm text-muted-foreground text-center">
                    Current page: {currentPage}
                  </p>
                </div>
                <Separator />
                <div className="space-y-2">
                  <Label>Table</Label>
                  <Table>
                    <TableCaption>A list of your recent invoices.</TableCaption>
                    <TableHeader>
                      <TableRow>
                        <TableHead className="w-[100px]">Invoice</TableHead>
                        <TableHead>Status</TableHead>
                        <TableHead>Method</TableHead>
                        <TableHead className="text-right">Amount</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      <TableRow>
                        <TableCell className="font-medium">INV001</TableCell>
                        <TableCell>Paid</TableCell>
                        <TableCell>Credit Card</TableCell>
                        <TableCell className="text-right">$250.00</TableCell>
                      </TableRow>
                      <TableRow>
                        <TableCell className="font-medium">INV002</TableCell>
                        <TableCell>Pending</TableCell>
                        <TableCell>PayPal</TableCell>
                        <TableCell className="text-right">$150.00</TableCell>
                      </TableRow>
                      <TableRow>
                        <TableCell className="font-medium">INV003</TableCell>
                        <TableCell>Unpaid</TableCell>
                        <TableCell>Bank Transfer</TableCell>
                        <TableCell className="text-right">$350.00</TableCell>
                      </TableRow>
                    </TableBody>
                  </Table>
                </div>
                <Separator />
                <div className="space-y-2">
                  <Label>Menubar</Label>
                  <Menubar>
                    <MenubarMenu>
                      <MenubarTrigger>File</MenubarTrigger>
                      <MenubarContent>
                        <MenubarItem>New Tab</MenubarItem>
                        <MenubarItem>New Window</MenubarItem>
                        <MenubarSeparator />
                        <MenubarItem>Share</MenubarItem>
                        <MenubarSeparator />
                        <MenubarItem>Print</MenubarItem>
                      </MenubarContent>
                    </MenubarMenu>
                    <MenubarMenu>
                      <MenubarTrigger>Edit</MenubarTrigger>
                      <MenubarContent>
                        <MenubarItem>Undo</MenubarItem>
                        <MenubarItem>Redo</MenubarItem>
                      </MenubarContent>
                    </MenubarMenu>
                    <MenubarMenu>
                      <MenubarTrigger>View</MenubarTrigger>
                      <MenubarContent>
                        <MenubarItem>Reload</MenubarItem>
                        <MenubarItem>Force Reload</MenubarItem>
                      </MenubarContent>
                    </MenubarMenu>
                  </Menubar>
                </div>
                <Separator />
                <div className="space-y-2">
                  <Label>Breadcrumb</Label>
                  <Breadcrumb>
                    <BreadcrumbList>
                      <BreadcrumbItem>
                        <BreadcrumbLink href="/">Home</BreadcrumbLink>
                      </BreadcrumbItem>
                      <BreadcrumbSeparator />
                      <BreadcrumbItem>
                        <BreadcrumbLink href="/components">
                          Components
                        </BreadcrumbLink>
                      </BreadcrumbItem>
                      <BreadcrumbSeparator />
                      <BreadcrumbItem>
                        <BreadcrumbPage>Breadcrumb</BreadcrumbPage>
                      </BreadcrumbItem>
                    </BreadcrumbList>
                  </Breadcrumb>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Alerts Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Alerts</h3>
            <div className="space-y-4">
              <Alert>
                <AlertCircle className="h-4 w-4" />
                <AlertTitle>Heads up!</AlertTitle>
                <AlertDescription>
                  You can add components to your app using the cli.
                </AlertDescription>
              </Alert>
              <Alert variant="destructive">
                <X className="h-4 w-4" />
                <AlertTitle>Error</AlertTitle>
                <AlertDescription>
                  Your session has expired. Please log in again.
                </AlertDescription>
              </Alert>
            </div>
          </section>

          {/* Tabs Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Tabs</h3>
            <Tabs defaultValue="account" className="w-full">
              <TabsList className="grid w-full grid-cols-3">
                <TabsTrigger value="account">Account</TabsTrigger>
                <TabsTrigger value="password">Password</TabsTrigger>
                <TabsTrigger value="settings">Settings</TabsTrigger>
              </TabsList>
              <TabsContent value="account">
                <Card>
                  <CardHeader>
                    <CardTitle>Account</CardTitle>
                    <CardDescription>
                      Make changes to your account here.
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-2">
                    <div className="space-y-1">
                      <Label htmlFor="name">Name</Label>
                      <Input id="name" defaultValue="Pedro Duarte" />
                    </div>
                  </CardContent>
                  <CardFooter>
                    <Button>Save changes</Button>
                  </CardFooter>
                </Card>
              </TabsContent>
              <TabsContent value="password">
                <Card>
                  <CardHeader>
                    <CardTitle>Password</CardTitle>
                    <CardDescription>
                      Change your password here.
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-2">
                    <div className="space-y-1">
                      <Label htmlFor="current">Current password</Label>
                      <Input id="current" type="password" />
                    </div>
                    <div className="space-y-1">
                      <Label htmlFor="new">New password</Label>
                      <Input id="new" type="password" />
                    </div>
                  </CardContent>
                  <CardFooter>
                    <Button>Save password</Button>
                  </CardFooter>
                </Card>
              </TabsContent>
              <TabsContent value="settings">
                <Card>
                  <CardHeader>
                    <CardTitle>Settings</CardTitle>
                    <CardDescription>
                      Manage your settings here.
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <p className="text-sm text-muted-foreground">
                      Settings content goes here.
                    </p>
                  </CardContent>
                </Card>
              </TabsContent>
            </Tabs>
          </section>

          {/* Accordion Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Accordion</h3>
            <Accordion type="single" collapsible className="w-full">
              <AccordionItem value="item-1">
                <AccordionTrigger>Is it accessible?</AccordionTrigger>
                <AccordionContent>
                  Yes. It adheres to the WAI-ARIA design pattern.
                </AccordionContent>
              </AccordionItem>
              <AccordionItem value="item-2">
                <AccordionTrigger>Is it styled?</AccordionTrigger>
                <AccordionContent>
                  Yes. It comes with default styles that matches the other
                  components' aesthetic.
                </AccordionContent>
              </AccordionItem>
              <AccordionItem value="item-3">
                <AccordionTrigger>Is it animated?</AccordionTrigger>
                <AccordionContent>
                  Yes. It's animated by default, but you can disable it if you
                  prefer.
                </AccordionContent>
              </AccordionItem>
            </Accordion>
          </section>

          {/* Collapsible Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Collapsible</h3>
            <Collapsible>
              <Card>
                <CardHeader>
                  <CollapsibleTrigger asChild>
                    <Button variant="ghost" className="w-full justify-between">
                      <CardTitle>@peduarte starred 3 repositories</CardTitle>
                    </Button>
                  </CollapsibleTrigger>
                </CardHeader>
                <CollapsibleContent>
                  <CardContent>
                    <div className="space-y-2">
                      <div className="rounded-md border px-4 py-3 font-mono text-sm">
                        @radix-ui/primitives
                      </div>
                      <div className="rounded-md border px-4 py-3 font-mono text-sm">
                        @radix-ui/colors
                      </div>
                      <div className="rounded-md border px-4 py-3 font-mono text-sm">
                        @stitches/react
                      </div>
                    </div>
                  </CardContent>
                </CollapsibleContent>
              </Card>
            </Collapsible>
          </section>

          {/* Dialog, Sheet, Drawer Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Overlays</h3>
            <Card>
              <CardContent className="pt-6">
                <div className="flex flex-wrap gap-4">
                  <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
                    <DialogTrigger asChild>
                      <Button variant="outline">Open Dialog</Button>
                    </DialogTrigger>
                    <DialogContent>
                      <DialogHeader>
                        <DialogTitle>Test Input</DialogTitle>
                        <DialogDescription>
                          Enter some text below. Press Enter to submit (IME composition supported).
                        </DialogDescription>
                      </DialogHeader>
                      <div className="space-y-4 py-4">
                        <div className="space-y-2">
                          <Label htmlFor="dialog-input">Input</Label>
                          <Input
                            id="dialog-input"
                            placeholder="Type something..."
                            value={dialogInput}
                            onChange={(e) => setDialogInput(e.target.value)}
                            onKeyDown={handleDialogKeyDown}
                            autoFocus
                          />
                        </div>
                      </div>
                      <div className="flex justify-end gap-2">
                        <Button
                          variant="outline"
                          onClick={() => setDialogOpen(false)}
                        >
                          Cancel
                        </Button>
                        <Button onClick={handleDialogSubmit}>Submit</Button>
                      </div>
                    </DialogContent>
                  </Dialog>

                  <Sheet>
                    <SheetTrigger asChild>
                      <Button variant="outline">Open Sheet</Button>
                    </SheetTrigger>
                    <SheetContent>
                      <SheetHeader>
                        <SheetTitle>Edit profile</SheetTitle>
                        <SheetDescription>
                          Make changes to your profile here. Click save when
                          you're done.
                        </SheetDescription>
                      </SheetHeader>
                    </SheetContent>
                  </Sheet>

                  <Drawer>
                    <DrawerTrigger asChild>
                      <Button variant="outline">Open Drawer</Button>
                    </DrawerTrigger>
                    <DrawerContent>
                      <DrawerHeader>
                        <DrawerTitle>Are you absolutely sure?</DrawerTitle>
                        <DrawerDescription>
                          This action cannot be undone.
                        </DrawerDescription>
                      </DrawerHeader>
                      <DrawerFooter>
                        <Button>Submit</Button>
                        <DrawerClose asChild>
                          <Button variant="outline">Cancel</Button>
                        </DrawerClose>
                      </DrawerFooter>
                    </DrawerContent>
                  </Drawer>

                  <Popover>
                    <PopoverTrigger asChild>
                      <Button variant="outline">Open Popover</Button>
                    </PopoverTrigger>
                    <PopoverContent>
                      <div className="space-y-2">
                        <h4 className="font-medium leading-none">Dimensions</h4>
                        <p className="text-sm text-muted-foreground">
                          Set the dimensions for the layer.
                        </p>
                      </div>
                    </PopoverContent>
                  </Popover>

                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button variant="outline">Hover me</Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>Add to library</p>
                    </TooltipContent>
                  </Tooltip>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Menus Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Menus</h3>
            <Card>
              <CardContent className="pt-6">
                <div className="flex flex-wrap gap-4">
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button variant="outline">Dropdown Menu</Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent>
                      <DropdownMenuLabel>My Account</DropdownMenuLabel>
                      <DropdownMenuSeparator />
                      <DropdownMenuItem>Profile</DropdownMenuItem>
                      <DropdownMenuItem>Billing</DropdownMenuItem>
                      <DropdownMenuItem>Team</DropdownMenuItem>
                      <DropdownMenuItem>Subscription</DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>

                  <ContextMenu>
                    <ContextMenuTrigger asChild>
                      <Button variant="outline">Right Click Me</Button>
                    </ContextMenuTrigger>
                    <ContextMenuContent>
                      <ContextMenuItem>Profile</ContextMenuItem>
                      <ContextMenuItem>Billing</ContextMenuItem>
                      <ContextMenuItem>Team</ContextMenuItem>
                      <ContextMenuItem>Subscription</ContextMenuItem>
                    </ContextMenuContent>
                  </ContextMenu>

                  <HoverCard>
                    <HoverCardTrigger asChild>
                      <Button variant="outline">Hover Card</Button>
                    </HoverCardTrigger>
                    <HoverCardContent>
                      <div className="space-y-2">
                        <h4 className="text-sm font-semibold">@nextjs</h4>
                        <p className="text-sm">
                          The React Framework â€“ created and maintained by
                          @vercel.
                        </p>
                      </div>
                    </HoverCardContent>
                  </HoverCard>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Calendar Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Calendar</h3>
            <Card>
              <CardContent className="pt-6 flex justify-center">
                <Calendar
                  mode="single"
                  selected={date}
                  onSelect={setDate}
                  className="rounded-md border"
                />
              </CardContent>
            </Card>
          </section>

          {/* Carousel Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Carousel</h3>
            <Card>
              <CardContent className="pt-6">
                <Carousel className="w-full max-w-xs mx-auto">
                  <CarouselContent>
                    {Array.from({ length: 5 }).map((_, index) => (
                      <CarouselItem key={index}>
                        <div className="p-1">
                          <Card>
                            <CardContent className="flex aspect-square items-center justify-center p-6">
                              <span className="text-4xl font-semibold">
                                {index + 1}
                              </span>
                            </CardContent>
                          </Card>
                        </div>
                      </CarouselItem>
                    ))}
                  </CarouselContent>
                  <CarouselPrevious />
                  <CarouselNext />
                </Carousel>
              </CardContent>
            </Card>
          </section>

          {/* Toggle Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Toggle</h3>
            <Card>
              <CardContent className="pt-6 space-y-4">
                <div className="space-y-2">
                  <Label>Toggle</Label>
                  <div className="flex gap-2">
                    <Toggle aria-label="Toggle italic">
                      <span className="font-bold">B</span>
                    </Toggle>
                    <Toggle aria-label="Toggle italic">
                      <span className="italic">I</span>
                    </Toggle>
                    <Toggle aria-label="Toggle underline">
                      <span className="underline">U</span>
                    </Toggle>
                  </div>
                </div>
                <Separator />
                <div className="space-y-2">
                  <Label>Toggle Group</Label>
                  <ToggleGroup type="multiple">
                    <ToggleGroupItem value="bold" aria-label="Toggle bold">
                      <span className="font-bold">B</span>
                    </ToggleGroupItem>
                    <ToggleGroupItem value="italic" aria-label="Toggle italic">
                      <span className="italic">I</span>
                    </ToggleGroupItem>
                    <ToggleGroupItem
                      value="underline"
                      aria-label="Toggle underline"
                    >
                      <span className="underline">U</span>
                    </ToggleGroupItem>
                  </ToggleGroup>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Aspect Ratio & Scroll Area Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Layout Components</h3>
            <Card>
              <CardContent className="pt-6 space-y-6">
                <div className="space-y-2">
                  <Label>Aspect Ratio (16/9)</Label>
                  <AspectRatio ratio={16 / 9} className="bg-muted">
                    <div className="flex h-full items-center justify-center">
                      <p className="text-muted-foreground">16:9 Aspect Ratio</p>
                    </div>
                  </AspectRatio>
                </div>
                <Separator />
                <div className="space-y-2">
                  <Label>Scroll Area</Label>
                  <ScrollArea className="h-[200px] w-full rounded-md border overflow-hidden">
                    <div className="p-4">
                      <div className="space-y-4">
                        {Array.from({ length: 20 }).map((_, i) => (
                          <div key={i} className="text-sm">
                            Item {i + 1}: This is a scrollable content area
                          </div>
                        ))}
                      </div>
                    </div>
                  </ScrollArea>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Resizable Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Resizable Panels</h3>
            <Card>
              <CardContent className="pt-6">
                <ResizablePanelGroup
                  direction="horizontal"
                  className="min-h-[200px] rounded-lg border"
                >
                  <ResizablePanel defaultSize={50}>
                    <div className="flex h-full items-center justify-center p-6">
                      <span className="font-semibold">Panel One</span>
                    </div>
                  </ResizablePanel>
                  <ResizableHandle />
                  <ResizablePanel defaultSize={50}>
                    <div className="flex h-full items-center justify-center p-6">
                      <span className="font-semibold">Panel Two</span>
                    </div>
                  </ResizablePanel>
                </ResizablePanelGroup>
              </CardContent>
            </Card>
          </section>

          {/* Toast Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">Toast</h3>
            <Card>
              <CardContent className="pt-6 space-y-4">
                <div className="space-y-2">
                  <Label>Sonner Toast</Label>
                  <div className="flex flex-wrap gap-2">
                    <Button
                      variant="outline"
                      onClick={() => {
                        sonnerToast.success("Operation successful", {
                          description: "Your changes have been saved",
                        });
                      }}
                    >
                      Success
                    </Button>
                    <Button
                      variant="outline"
                      onClick={() => {
                        sonnerToast.error("Operation failed", {
                          description:
                            "Cannot complete operation, please try again",
                        });
                      }}
                    >
                      Error
                    </Button>
                    <Button
                      variant="outline"
                      onClick={() => {
                        sonnerToast.info("Information", {
                          description: "This is an information message",
                        });
                      }}
                    >
                      Info
                    </Button>
                    <Button
                      variant="outline"
                      onClick={() => {
                        sonnerToast.warning("Warning", {
                          description:
                            "Please note the impact of this operation",
                        });
                      }}
                    >
                      Warning
                    </Button>
                    <Button
                      variant="outline"
                      onClick={() => {
                        sonnerToast.loading("Loading", {
                          description: "Please wait",
                        });
                      }}
                    >
                      Loading
                    </Button>
                    <Button
                      variant="outline"
                      onClick={() => {
                        const promise = new Promise(resolve =>
                          setTimeout(resolve, 2000)
                        );
                        sonnerToast.promise(promise, {
                          loading: "Processing...",
                          success: "Processing complete!",
                          error: "Processing failed",
                        });
                      }}
                    >
                      Promise
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* AI ChatBox Section */}
          <section className="space-y-4">
            <h3 className="text-2xl font-semibold">AI ChatBox</h3>
            <Card>
              <CardContent className="pt-6">
                <div className="space-y-4">
                  <div className="text-sm text-muted-foreground">
                    <p>
                      A ready-to-use chat interface component that integrates with the LLM system.
                      Features markdown rendering, auto-scrolling, and loading states.
                    </p>
                    <p className="mt-2">
                      This is a demo with simulated responses. In a real app, you'd connect it to a tRPC mutation.
                    </p>
                  </div>
                  <AIChatBox
                    messages={chatMessages}
                    onSendMessage={handleChatSend}
                    isLoading={isChatLoading}
                    placeholder="Try sending a message..."
                    height="500px"
                    emptyStateMessage="How can I help you today?"
                    suggestedPrompts={[
                      "What is React?",
                      "Explain TypeScript",
                      "How to use tRPC?",
                      "Best practices for web development",
                    ]}
                  />
                </div>
              </CardContent>
            </Card>
          </section>
        </div>
      </main>

      <footer className="border-t py-6 mt-12">
        <div className="container text-center text-sm text-muted-foreground">
          <p>Shadcn/ui Component Showcase</p>
        </div>
      </footer>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/ConfiguracaoBonus.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Plus, Edit, Trash2, DollarSign, Percent } from "lucide-react";
import { toast } from "sonner";

/**
 * PÃ¡gina de ConfiguraÃ§Ã£o de BÃ´nus por FunÃ§Ã£o
 * Permite cadastrar quantos salÃ¡rios cada funÃ§Ã£o tem direito + bÃ´nus extra em %
 */
export default function ConfiguracaoBonus() {
  const [dialogOpen, setDialogOpen] = useState(false);
  const [editingConfig, setEditingConfig] = useState<any>(null);

  // Form state
  const [selectedPositionId, setSelectedPositionId] = useState<string>("");
  const [baseSalaryMultiplier, setBaseSalaryMultiplier] = useState("");
  const [extraBonusPercentage, setExtraBonusPercentage] = useState("");

  // Queries
  const { data: configs = [], refetch } = trpc.bonus.listConfigs.useQuery();
  const { data: positions = [] } = trpc.positions.list.useQuery();

  // Mutations
  const createMutation = trpc.bonus.createConfig.useMutation({
    onSuccess: () => {
      toast.success("ConfiguraÃ§Ã£o de bÃ´nus criada com sucesso!");
      refetch();
      closeDialog();
    },
    onError: (error: any) => {
      toast.error("Erro ao criar configuraÃ§Ã£o", {
        description: error.message,
      });
    },
  });

  const updateMutation = trpc.bonus.updateConfig.useMutation({
    onSuccess: () => {
      toast.success("ConfiguraÃ§Ã£o atualizada com sucesso!");
      refetch();
      closeDialog();
    },
    onError: (error: any) => {
      toast.error("Erro ao atualizar configuraÃ§Ã£o", {
        description: error.message,
      });
    },
  });

  const deleteMutation = trpc.bonus.deleteConfig.useMutation({
    onSuccess: () => {
      toast.success("ConfiguraÃ§Ã£o excluÃ­da com sucesso!");
      refetch();
    },
    onError: (error: any) => {
      toast.error("Erro ao excluir configuraÃ§Ã£o", {
        description: error.message,
      });
    },
  });

  const closeDialog = () => {
    setDialogOpen(false);
    setEditingConfig(null);
    setSelectedPositionId("");
    setBaseSalaryMultiplier("");
    setExtraBonusPercentage("");
  };

  const openEditDialog = (config: any) => {
    setEditingConfig(config);
    setSelectedPositionId(config.positionId.toString());
    setBaseSalaryMultiplier(config.baseSalaryMultiplier);
    setExtraBonusPercentage(config.extraBonusPercentage);
    setDialogOpen(true);
  };

  const handleSubmit = () => {
    if (!selectedPositionId || !baseSalaryMultiplier || !extraBonusPercentage) {
      toast.error("Preencha todos os campos");
      return;
    }

    const position = positions.find((p: any) => p.id === Number(selectedPositionId));
    if (!position) {
      toast.error("FunÃ§Ã£o nÃ£o encontrada");
      return;
    }

    if (editingConfig) {
      updateMutation.mutate({
        id: editingConfig.id,
        baseSalaryMultiplier: parseFloat(baseSalaryMultiplier),
        extraBonusPercentage: parseFloat(extraBonusPercentage),
      });
    } else {
      createMutation.mutate({
        positionId: Number(selectedPositionId),
        positionName: position.title,
        baseSalaryMultiplier: parseFloat(baseSalaryMultiplier),
        extraBonusPercentage: parseFloat(extraBonusPercentage),
      });
    }
  };

  const handleDelete = (id: number) => {
    if (confirm("Tem certeza que deseja excluir esta configuraÃ§Ã£o?")) {
      deleteMutation.mutate({ id });
    }
  };

  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">ConfiguraÃ§Ã£o de BÃ´nus</h1>
          <p className="text-gray-600 mt-1">
            Defina quantos salÃ¡rios cada funÃ§Ã£o tem direito e o percentual de bÃ´nus extra
          </p>
        </div>

        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
          <DialogTrigger asChild>
            <Button className="bg-[#F39200] hover:bg-[#d67e00]">
              <Plus className="w-4 h-4 mr-2" />
              Nova ConfiguraÃ§Ã£o
            </Button>
          </DialogTrigger>
          <DialogContent className="sm:max-w-[500px]">
            <DialogHeader>
              <DialogTitle>
                {editingConfig ? "Editar ConfiguraÃ§Ã£o" : "Nova ConfiguraÃ§Ã£o de BÃ´nus"}
              </DialogTitle>
              <DialogDescription>
                Configure o multiplicador de salÃ¡rio e o bÃ´nus extra para a funÃ§Ã£o
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4 py-4">
              <div className="space-y-2">
                <Label htmlFor="position">FunÃ§Ã£o</Label>
                <Select
                  value={selectedPositionId}
                  onValueChange={setSelectedPositionId}
                  disabled={!!editingConfig}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione uma funÃ§Ã£o" />
                  </SelectTrigger>
                  <SelectContent>
                    {positions.map((position: any) => (
                      <SelectItem key={position.id} value={position.id.toString()}>
                        {position.title}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="multiplier">Multiplicador de SalÃ¡rio</Label>
                <div className="relative">
                  <DollarSign className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                  <Input
                    id="multiplier"
                    type="number"
                    step="0.1"
                    min="0"
                    max="10"
                    placeholder="Ex: 1.5 (1.5 salÃ¡rios)"
                    value={baseSalaryMultiplier}
                    onChange={(e) => setBaseSalaryMultiplier(e.target.value)}
                    className="pl-10"
                  />
                </div>
                <p className="text-xs text-gray-500">
                  Quantos salÃ¡rios a funÃ§Ã£o tem direito (ex: 1.5 = um salÃ¡rio e meio)
                </p>
              </div>

              <div className="space-y-2">
                <Label htmlFor="extra">BÃ´nus Extra (%)</Label>
                <div className="relative">
                  <Percent className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                  <Input
                    id="extra"
                    type="number"
                    step="1"
                    min="0"
                    max="100"
                    placeholder="Ex: 10 (10% adicional)"
                    value={extraBonusPercentage}
                    onChange={(e) => setExtraBonusPercentage(e.target.value)}
                    className="pl-10"
                  />
                </div>
                <p className="text-xs text-gray-500">
                  Percentual adicional sobre o valor calculado
                </p>
              </div>

              {/* Exemplo de cÃ¡lculo */}
              {baseSalaryMultiplier && extraBonusPercentage && (
                <Card className="bg-blue-50 border-blue-200">
                  <CardContent className="pt-4">
                    <p className="text-sm font-semibold text-blue-900 mb-2">
                      Exemplo de CÃ¡lculo:
                    </p>
                    <p className="text-xs text-blue-700">
                      SalÃ¡rio Base: R$ 5.000,00
                      <br />
                      BÃ´nus Base: R$ {(5000 * parseFloat(baseSalaryMultiplier)).toFixed(2)}
                      <br />
                      BÃ´nus Extra ({extraBonusPercentage}%): R${" "}
                      {(
                        5000 *
                        parseFloat(baseSalaryMultiplier) *
                        (parseFloat(extraBonusPercentage) / 100)
                      ).toFixed(2)}
                      <br />
                      <strong>
                        Total: R${" "}
                        {(
                          5000 * parseFloat(baseSalaryMultiplier) +
                          5000 *
                            parseFloat(baseSalaryMultiplier) *
                            (parseFloat(extraBonusPercentage) / 100)
                        ).toFixed(2)}
                      </strong>
                    </p>
                  </CardContent>
                </Card>
              )}
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={closeDialog}>
                Cancelar
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={createMutation.isPending || updateMutation.isPending}
                className="bg-[#F39200] hover:bg-[#d67e00]"
              >
                {createMutation.isPending || updateMutation.isPending
                  ? "Salvando..."
                  : editingConfig
                    ? "Atualizar"
                    : "Criar"}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>

      {/* Tabela de ConfiguraÃ§Ãµes */}
      <Card>
        <CardHeader>
          <CardTitle>ConfiguraÃ§Ãµes Cadastradas</CardTitle>
          <CardDescription>
            {configs.length} {configs.length === 1 ? "funÃ§Ã£o configurada" : "funÃ§Ãµes configuradas"}
          </CardDescription>
        </CardHeader>
        <CardContent>
          {configs.length === 0 ? (
            <div className="text-center py-12">
              <DollarSign className="w-16 h-16 text-gray-300 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-gray-900 mb-2">
                Nenhuma configuraÃ§Ã£o cadastrada
              </h3>
              <p className="text-gray-600 mb-4">
                Comece criando a primeira configuraÃ§Ã£o de bÃ´nus por funÃ§Ã£o
              </p>
            </div>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>FunÃ§Ã£o</TableHead>
                  <TableHead className="text-center">Multiplicador</TableHead>
                  <TableHead className="text-center">BÃ´nus Extra</TableHead>
                  <TableHead className="text-center">Status</TableHead>
                  <TableHead className="text-right">AÃ§Ãµes</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {configs.map((config: any) => (
                  <TableRow key={config.id}>
                    <TableCell className="font-medium">{config.positionName}</TableCell>
                    <TableCell className="text-center">
                      <Badge variant="outline" className="bg-green-50 text-green-700">
                        {parseFloat(config.baseSalaryMultiplier).toFixed(1)}x salÃ¡rio
                      </Badge>
                    </TableCell>
                    <TableCell className="text-center">
                      <Badge variant="outline" className="bg-blue-50 text-blue-700">
                        +{parseFloat(config.extraBonusPercentage).toFixed(0)}%
                      </Badge>
                    </TableCell>
                    <TableCell className="text-center">
                      {config.isActive ? (
                        <Badge className="bg-green-500">Ativo</Badge>
                      ) : (
                        <Badge variant="secondary">Inativo</Badge>
                      )}
                    </TableCell>
                    <TableCell className="text-right">
                      <div className="flex justify-end gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => openEditDialog(config)}
                        >
                          <Edit className="w-4 h-4" />
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleDelete(config.id)}
                          disabled={deleteMutation.isPending}
                        >
                          <Trash2 className="w-4 h-4 text-red-600" />
                        </Button>
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>

      {/* InformaÃ§Ãµes */}
      <Card className="bg-amber-50 border-amber-200">
        <CardHeader>
          <CardTitle className="text-amber-900">â„¹ï¸ Como Funciona</CardTitle>
        </CardHeader>
        <CardContent className="text-sm text-amber-800 space-y-2">
          <p>
            <strong>Multiplicador de SalÃ¡rio:</strong> Define quantos salÃ¡rios a funÃ§Ã£o tem direito.
            Exemplo: 1.5 significa que o colaborador receberÃ¡ 1.5 vezes seu salÃ¡rio base como bÃ´nus.
          </p>
          <p>
            <strong>BÃ´nus Extra (%):</strong> Percentual adicional aplicado sobre o valor calculado.
            Exemplo: 10% de bÃ´nus extra sobre R$ 7.500 = R$ 750 adicionais.
          </p>
          <p>
            <strong>CÃ¡lculo Final:</strong> (SalÃ¡rio Base Ã— Multiplicador) + (Valor Calculado Ã—
            BÃ´nus Extra %)
          </p>
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/ConfiguracaoIntegracoes.tsx
========================================
import { useState, useEffect } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { toast } from "sonner";
import { MessageSquare, Send, Video, CheckCircle } from "lucide-react";

/**
 * PÃ¡gina de ConfiguraÃ§Ã£o de IntegraÃ§Ãµes Externas
 * Microsoft Teams, Slack e Google Meet
 */
export default function ConfiguracaoIntegracoes() {
  const [teamsWebhook, setTeamsWebhook] = useState("");
  const [slackWebhook, setSlackWebhook] = useState("");
  const [slackChannel, setSlackChannel] = useState("#geral");
  const [googleMeetEnabled, setGoogleMeetEnabled] = useState(false);

  const utils = trpc.useUtils();

  // Queries
  const { data: config, isLoading } = trpc.integrations.getConfig.useQuery();

  // Mutations
  const saveConfigMutation = trpc.integrations.saveConfig.useMutation({
    onSuccess: () => {
      toast.success("ConfiguraÃ§Ãµes salvas com sucesso!");
      utils.integrations.getConfig.invalidate();
    },
    onError: (error) => {
      toast.error(`Erro: ${error.message}`);
    },
  });

  const testTeamsMutation = trpc.integrations.testTeams.useMutation({
    onSuccess: ({ success }) => {
      if (success) {
        toast.success("Teste enviado com sucesso! Verifique o canal do Teams.");
      } else {
        toast.error("Falha ao enviar teste. Verifique o webhook.");
      }
    },
    onError: (error) => {
      toast.error(`Erro: ${error.message}`);
    },
  });

  const testSlackMutation = trpc.integrations.testSlack.useMutation({
    onSuccess: ({ success }) => {
      if (success) {
        toast.success("Teste enviado com sucesso! Verifique o canal do Slack.");
      } else {
        toast.error("Falha ao enviar teste. Verifique o webhook.");
      }
    },
    onError: (error) => {
      toast.error(`Erro: ${error.message}`);
    },
  });

  // Carregar configuraÃ§Ãµes
  useEffect(() => {
    if (config) {
      setTeamsWebhook(config.teamsWebhookUrl);
      setSlackWebhook(config.slackWebhookUrl);
      setSlackChannel(config.slackChannel || "#geral");
      setGoogleMeetEnabled(config.googleMeetEnabled);
    }
  }, [config]);

  const handleSave = () => {
    saveConfigMutation.mutate({
      teamsWebhookUrl: teamsWebhook || undefined,
      slackWebhookUrl: slackWebhook || undefined,
      slackChannel: slackChannel || undefined,
      googleMeetEnabled,
    });
  };

  const handleTestTeams = () => {
    if (!teamsWebhook) {
      toast.error("Configure o webhook do Teams primeiro");
      return;
    }
    testTeamsMutation.mutate({ webhookUrl: teamsWebhook });
  };

  const handleTestSlack = () => {
    if (!slackWebhook) {
      toast.error("Configure o webhook do Slack primeiro");
      return;
    }
    testSlackMutation.mutate({
      webhookUrl: slackWebhook,
      channel: slackChannel,
    });
  };

  return (
    <div className="container mx-auto py-6 space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold flex items-center gap-3">
          <Send className="w-8 h-8 text-[#F39200]" />
          ConfiguraÃ§Ã£o de IntegraÃ§Ãµes
        </h1>
        <p className="text-gray-600 mt-2">
          Configure integraÃ§Ãµes com Microsoft Teams, Slack e Google Meet
        </p>
      </div>

      {isLoading ? (
        <div className="text-center py-12 text-gray-500">Carregando...</div>
      ) : (
        <div className="space-y-6">
          {/* Microsoft Teams */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <MessageSquare className="w-5 h-5 text-blue-600" />
                Microsoft Teams
              </CardTitle>
              <CardDescription>
                Configure o webhook do Teams para receber notificaÃ§Ãµes automÃ¡ticas
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <Label htmlFor="teams-webhook">Webhook URL</Label>
                <Input
                  id="teams-webhook"
                  type="url"
                  placeholder="https://outlook.office.com/webhook/..."
                  value={teamsWebhook}
                  onChange={(e) => setTeamsWebhook(e.target.value)}
                  className="mt-1"
                />
                <p className="text-xs text-gray-500 mt-1">
                  Crie um webhook no Teams: ConfiguraÃ§Ãµes do Canal â†’ Conectores â†’ Incoming Webhook
                </p>
              </div>

              <Button
                onClick={handleTestTeams}
                disabled={!teamsWebhook || testTeamsMutation.isPending}
                variant="outline"
              >
                {testTeamsMutation.isPending ? "Enviando..." : "Enviar Teste"}
              </Button>
            </CardContent>
          </Card>

          {/* Slack */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <MessageSquare className="w-5 h-5 text-purple-600" />
                Slack
              </CardTitle>
              <CardDescription>
                Configure o webhook do Slack para receber notificaÃ§Ãµes automÃ¡ticas
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <Label htmlFor="slack-webhook">Webhook URL</Label>
                <Input
                  id="slack-webhook"
                  type="url"
                  placeholder="https://hooks.slack.com/services/..."
                  value={slackWebhook}
                  onChange={(e) => setSlackWebhook(e.target.value)}
                  className="mt-1"
                />
                <p className="text-xs text-gray-500 mt-1">
                  Crie um webhook no Slack: ConfiguraÃ§Ãµes â†’ Incoming Webhooks
                </p>
              </div>

              <div>
                <Label htmlFor="slack-channel">Canal PadrÃ£o</Label>
                <Input
                  id="slack-channel"
                  type="text"
                  placeholder="#geral"
                  value={slackChannel}
                  onChange={(e) => setSlackChannel(e.target.value)}
                  className="mt-1"
                />
              </div>

              <Button
                onClick={handleTestSlack}
                disabled={!slackWebhook || testSlackMutation.isPending}
                variant="outline"
              >
                {testSlackMutation.isPending ? "Enviando..." : "Enviar Teste"}
              </Button>
            </CardContent>
          </Card>

          {/* Google Meet */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Video className="w-5 h-5 text-green-600" />
                Google Meet
              </CardTitle>
              <CardDescription>
                Habilite a criaÃ§Ã£o automÃ¡tica de reuniÃµes no Google Meet
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <div>
                  <Label htmlFor="google-meet-enabled">Habilitar Google Meet</Label>
                  <p className="text-sm text-gray-500">
                    Permite criar reuniÃµes automaticamente para feedbacks e calibraÃ§Ãµes
                  </p>
                </div>
                <Switch
                  id="google-meet-enabled"
                  checked={googleMeetEnabled}
                  onCheckedChange={setGoogleMeetEnabled}
                />
              </div>

              {googleMeetEnabled && (
                <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                  <p className="text-sm text-blue-700">
                    <CheckCircle className="w-4 h-4 inline mr-2" />
                    Google Meet habilitado. Os usuÃ¡rios precisarÃ£o autorizar o acesso ao Google Calendar
                    na primeira vez que criarem uma reuniÃ£o.
                  </p>
                </div>
              )}
            </CardContent>
          </Card>

          {/* BotÃ£o Salvar */}
          <div className="flex justify-end">
            <Button
              onClick={handleSave}
              disabled={saveConfigMutation.isPending}
              className="bg-[#F39200] hover:bg-[#D17E00]"
            >
              {saveConfigMutation.isPending ? "Salvando..." : "Salvar ConfiguraÃ§Ãµes"}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/ConfiguracaoWorkflowsBonus.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import {
  Workflow,
  Plus,
  Trash2,
  Edit,
  Users,
  CheckCircle2,
  ArrowRight,
  Settings,
} from "lucide-react";

/**
 * PÃ¡gina de ConfiguraÃ§Ã£o de Workflows de BÃ´nus
 * Interface para criar e gerenciar workflows personalizados de aprovaÃ§Ã£o
 */
export default function ConfiguracaoWorkflowsBonus() {
  const [showCreateDialog, setShowCreateDialog] = useState(false);
  const [workflowName, setWorkflowName] = useState("");
  const [selectedApprovers, setSelectedApprovers] = useState<
    Array<{ level: number; approverId: number; approverName: string; role: string }>
  >([]);
  const [currentLevel, setCurrentLevel] = useState(1);
  const [selectedEmployee, setSelectedEmployee] = useState<number | null>(null);
  const [selectedRole, setSelectedRole] = useState<string>("manager");

  // Buscar workflows existentes
  const { data: workflows, refetch } = trpc.bonus.listWorkflows.useQuery();

  // Buscar funcionÃ¡rios para seleÃ§Ã£o de aprovadores
  const { data: employees } = trpc.employees.list.useQuery();

  // Mutations
  const createWorkflowMutation = trpc.bonus.createWorkflow.useMutation({
    onSuccess: () => {
      toast.success("Workflow criado com sucesso!");
      setShowCreateDialog(false);
      resetForm();
      refetch();
    },
    onError: (error) => {
      toast.error("Erro ao criar workflow", {
        description: error.message,
      });
    },
  });

  const deleteWorkflowMutation = trpc.bonus.deleteWorkflow.useMutation({
    onSuccess: () => {
      toast.success("Workflow excluÃ­do com sucesso!");
      refetch();
    },
    onError: (error) => {
      toast.error("Erro ao excluir workflow", {
        description: error.message,
      });
    },
  });

  const resetForm = () => {
    setWorkflowName("");
    setSelectedApprovers([]);
    setCurrentLevel(1);
    setSelectedEmployee(null);
    setSelectedRole("manager");
  };

  const handleAddApprover = () => {
    if (!selectedEmployee) {
      toast.error("Selecione um aprovador");
      return;
    }

    const employee = employees?.find((e) => e.employee.id === selectedEmployee);
    if (!employee) return;

    setSelectedApprovers([
      ...selectedApprovers,
      {
        level: currentLevel,
        approverId: selectedEmployee,
        approverName: employee.employee.name,
        role: selectedRole,
      },
    ]);

    setCurrentLevel(currentLevel + 1);
    setSelectedEmployee(null);
  };

  const handleRemoveApprover = (level: number) => {
    setSelectedApprovers(selectedApprovers.filter((a) => a.level !== level));
    // Reordenar nÃ­veis
    const reordered = selectedApprovers
      .filter((a) => a.level !== level)
      .map((a, index) => ({ ...a, level: index + 1 }));
    setSelectedApprovers(reordered);
    setCurrentLevel(reordered.length + 1);
  };

  const handleCreateWorkflow = async () => {
    if (!workflowName.trim()) {
      toast.error("Digite um nome para o workflow");
      return;
    }

    if (selectedApprovers.length === 0) {
      toast.error("Adicione pelo menos um aprovador");
      return;
    }

    await createWorkflowMutation.mutateAsync({
      name: workflowName,
      approvers: selectedApprovers.map(a => ({
        employeeId: a.approverId,
        role: a.role,
      })),
    });
  };

  const handleDeleteWorkflow = async (workflowId: number) => {
    if (confirm("Tem certeza que deseja excluir este workflow?")) {
      await deleteWorkflowMutation.mutateAsync({ id: workflowId });
    }
  };

  const getRoleLabel = (role: string) => {
    const labels: Record<string, string> = {
      manager: "Gestor",
      hr: "RH",
      hr_manager: "Gerente RH",
      director: "Diretor de Gente",
      finance: "Financeiro",
    };
    return labels[role] || role;
  };

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-3">
            <Workflow className="w-8 h-8 text-[#F39200]" />
            Workflows de AprovaÃ§Ã£o de BÃ´nus
          </h1>
          <p className="text-gray-600 mt-2">
            Configure workflows personalizados com atÃ© 5 nÃ­veis de aprovaÃ§Ã£o
          </p>
        </div>

        <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>
          <DialogTrigger asChild>
            <Button className="bg-[#F39200] hover:bg-[#d67e00]">
              <Plus className="w-4 h-4 mr-2" />
              Novo Workflow
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>Criar Novo Workflow</DialogTitle>
              <DialogDescription>
                Configure um workflow personalizado de aprovaÃ§Ã£o de bÃ´nus
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-6">
              {/* Nome do Workflow */}
              <div>
                <Label>Nome do Workflow</Label>
                <Input
                  placeholder="Ex: Workflow PadrÃ£o de BÃ´nus"
                  value={workflowName}
                  onChange={(e) => setWorkflowName(e.target.value)}
                />
              </div>

              {/* Adicionar Aprovador */}
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg">Adicionar Aprovador - NÃ­vel {currentLevel}</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label>Aprovador</Label>
                      <Select
                        value={selectedEmployee?.toString()}
                        onValueChange={(value) => setSelectedEmployee(parseInt(value))}
                      >
                        <SelectTrigger>
                          <SelectValue placeholder="Selecione..." />
                        </SelectTrigger>
                        <SelectContent>
                          {employees?.map((emp) => (
                            <SelectItem key={emp.employee.id} value={emp.employee.id.toString()}>
                              {emp.employee.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div>
                      <Label>FunÃ§Ã£o</Label>
                      <Select value={selectedRole} onValueChange={setSelectedRole}>
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="manager">Gestor</SelectItem>
                          <SelectItem value="hr">RH</SelectItem>
                          <SelectItem value="hr_manager">Gerente RH</SelectItem>
                          <SelectItem value="director">Diretor de Gente</SelectItem>
                          <SelectItem value="finance">Financeiro</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>

                  <Button
                    onClick={handleAddApprover}
                    variant="outline"
                    className="w-full"
                    disabled={currentLevel > 5}
                  >
                    <Plus className="w-4 h-4 mr-2" />
                    Adicionar NÃ­vel {currentLevel}
                  </Button>

                  {currentLevel > 5 && (
                    <p className="text-sm text-red-600">MÃ¡ximo de 5 nÃ­veis de aprovaÃ§Ã£o</p>
                  )}
                </CardContent>
              </Card>

              {/* VisualizaÃ§Ã£o do Workflow */}
              {selectedApprovers.length > 0 && (
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg">Fluxo de AprovaÃ§Ã£o</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-3">
                      {selectedApprovers.map((approver, index) => (
                        <div key={approver.level}>
                          <div className="flex items-center gap-3 p-3 border rounded-lg">
                            <div className="flex items-center justify-center w-8 h-8 rounded-full bg-[#F39200] text-white font-bold">
                              {approver.level}
                            </div>
                            <div className="flex-1">
                              <p className="font-semibold">{approver.approverName}</p>
                              <p className="text-sm text-gray-600">{getRoleLabel(approver.role)}</p>
                            </div>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => handleRemoveApprover(approver.level)}
                            >
                              <Trash2 className="w-4 h-4 text-red-600" />
                            </Button>
                          </div>
                          {index < selectedApprovers.length - 1 && (
                            <div className="flex justify-center py-2">
                              <ArrowRight className="w-5 h-5 text-gray-400" />
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              )}

              {/* BotÃµes */}
              <div className="flex justify-end gap-2">
                <Button variant="outline" onClick={() => setShowCreateDialog(false)}>
                  Cancelar
                </Button>
                <Button
                  onClick={handleCreateWorkflow}
                  disabled={createWorkflowMutation.isPending}
                  className="bg-[#F39200] hover:bg-[#d67e00]"
                >
                  {createWorkflowMutation.isPending ? "Criando..." : "Criar Workflow"}
                </Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      {/* Lista de Workflows */}
      <div className="grid gap-6">
        {workflows && workflows.length > 0 ? (
          workflows.map((workflow: any) => (
            <Card key={workflow.id}>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <div>
                    <CardTitle className="flex items-center gap-2">
                      <Workflow className="w-5 h-5 text-[#F39200]" />
                      {workflow.name}
                    </CardTitle>
                    <CardDescription>
                      {workflow.approvers?.length || 0} nÃ­veis de aprovaÃ§Ã£o
                    </CardDescription>
                  </div>
                  <div className="flex gap-2">
                    {workflow.isActive && (
                      <Badge className="bg-green-500">
                        <CheckCircle2 className="w-3 h-3 mr-1" />
                        Ativo
                      </Badge>
                    )}
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleDeleteWorkflow(workflow.id)}
                      disabled={deleteWorkflowMutation.isPending}
                    >
                      <Trash2 className="w-4 h-4 text-red-600" />
                    </Button>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                <div className="flex items-center gap-3">
                  {workflow.approvers?.map((approver: any, index: number) => (
                    <div key={approver.level} className="flex items-center gap-2">
                      <div className="flex items-center gap-2 px-3 py-2 border rounded-lg bg-gray-50">
                        <div className="flex items-center justify-center w-6 h-6 rounded-full bg-[#F39200] text-white text-xs font-bold">
                          {approver.level}
                        </div>
                        <div>
                          <p className="text-sm font-semibold">{approver.approverName}</p>
                          <p className="text-xs text-gray-600">{getRoleLabel(approver.role)}</p>
                        </div>
                      </div>
                      {index < (workflow.approvers?.length || 0) - 1 && (
                        <ArrowRight className="w-4 h-4 text-gray-400" />
                      )}
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          ))
        ) : (
          <Card>
            <CardContent className="text-center py-12">
              <Settings className="w-16 h-16 mx-auto mb-4 text-gray-300" />
              <p className="text-gray-600 mb-2">Nenhum workflow configurado</p>
              <p className="text-sm text-gray-500">
                Crie seu primeiro workflow de aprovaÃ§Ã£o de bÃ´nus
              </p>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/Configuracoes.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { toast } from "sonner";
import { Settings, Database, Mail, Building2, Award, Calendar } from "lucide-react";

export default function Configuracoes() {
  const [emailEnabled, setEmailEnabled] = useState(true);
  const [totvsEnabled, setTotvsEnabled] = useState(false);

  const handleSaveGeneral = () => {
    toast.success("ConfiguraÃ§Ãµes gerais salvas com sucesso!");
  };

  const handleSaveEmail = () => {
    toast.success("ConfiguraÃ§Ãµes de e-mail salvas com sucesso!");
  };

  const handleSaveTOTVS = () => {
    toast.success("ConfiguraÃ§Ãµes TOTVS salvas com sucesso!");
  };

  const handleTestEmail = () => {
    toast.info("Enviando e-mail de teste...");
    setTimeout(() => {
      toast.success("E-mail de teste enviado com sucesso!");
    }, 2000);
  };

  const handleTestTOTVS = () => {
    toast.info("Testando conexÃ£o TOTVS...");
    setTimeout(() => {
      toast.success("ConexÃ£o TOTVS estabelecida com sucesso!");
    }, 2000);
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold">ConfiguraÃ§Ãµes do Sistema</h1>
          <p className="text-muted-foreground">
            Gerencie as configuraÃ§Ãµes gerais do sistema AVD UISA
          </p>
        </div>

        <Tabs defaultValue="geral" className="space-y-4">
          <TabsList className="grid w-full grid-cols-6">
            <TabsTrigger value="geral">
              <Settings className="h-4 w-4 mr-2" />
              Geral
            </TabsTrigger>
            <TabsTrigger value="ciclos">
              <Calendar className="h-4 w-4 mr-2" />
              Ciclos
            </TabsTrigger>
            <TabsTrigger value="competencias">
              <Award className="h-4 w-4 mr-2" />
              CompetÃªncias
            </TabsTrigger>
            <TabsTrigger value="departamentos">
              <Building2 className="h-4 w-4 mr-2" />
              Departamentos
            </TabsTrigger>
            <TabsTrigger value="email">
              <Mail className="h-4 w-4 mr-2" />
              E-mail
            </TabsTrigger>
            <TabsTrigger value="totvs">
              <Database className="h-4 w-4 mr-2" />
              TOTVS RM
            </TabsTrigger>
          </TabsList>

          {/* ConfiguraÃ§Ãµes Gerais */}
          <TabsContent value="geral" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>ConfiguraÃ§Ãµes Gerais</CardTitle>
                <CardDescription>
                  Configure os parÃ¢metros gerais do sistema
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="company-name">Nome da Empresa</Label>
                  <Input id="company-name" defaultValue="UISA - Usina Itamarati S/A" />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="system-name">Nome do Sistema</Label>
                  <Input id="system-name" defaultValue="Sistema AVD UISA" />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="support-email">E-mail de Suporte</Label>
                  <Input id="support-email" type="email" defaultValue="suporte@uisa.com.br" />
                </div>
                <Button onClick={handleSaveGeneral}>Salvar ConfiguraÃ§Ãµes</Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Ciclos de AvaliaÃ§Ã£o */}
          <TabsContent value="ciclos" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Ciclos de AvaliaÃ§Ã£o</CardTitle>
                <CardDescription>
                  Gerencie os ciclos de avaliaÃ§Ã£o de desempenho
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="cycle-name">Nome do Ciclo</Label>
                  <Input id="cycle-name" placeholder="Ex: Ciclo 2025" />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="cycle-start">Data de InÃ­cio</Label>
                    <Input id="cycle-start" type="date" />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="cycle-end">Data de TÃ©rmino</Label>
                    <Input id="cycle-end" type="date" />
                  </div>
                </div>
                <Button>Criar Novo Ciclo</Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* CompetÃªncias */}
          <TabsContent value="competencias" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>CompetÃªncias</CardTitle>
                <CardDescription>
                  Gerencie as competÃªncias avaliadas no sistema
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="competency-name">Nome da CompetÃªncia</Label>
                  <Input id="competency-name" placeholder="Ex: LideranÃ§a" />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="competency-desc">DescriÃ§Ã£o</Label>
                  <Input id="competency-desc" placeholder="DescriÃ§Ã£o da competÃªncia" />
                </div>
                <Button>Adicionar CompetÃªncia</Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Departamentos */}
          <TabsContent value="departamentos" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Departamentos</CardTitle>
                <CardDescription>
                  Gerencie os departamentos da organizaÃ§Ã£o
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="dept-code">CÃ³digo</Label>
                  <Input id="dept-code" placeholder="Ex: DEPT001" />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="dept-name">Nome do Departamento</Label>
                  <Input id="dept-name" placeholder="Ex: Recursos Humanos" />
                </div>
                <Button>Adicionar Departamento</Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* ConfiguraÃ§Ãµes de E-mail */}
          <TabsContent value="email" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>ConfiguraÃ§Ãµes de E-mail</CardTitle>
                <CardDescription>
                  Configure o servidor SMTP para envio de e-mails
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label>NotificaÃ§Ãµes por E-mail</Label>
                    <p className="text-sm text-muted-foreground">
                      Ativar envio automÃ¡tico de notificaÃ§Ãµes
                    </p>
                  </div>
                  <Switch checked={emailEnabled} onCheckedChange={setEmailEnabled} />
                </div>

                {emailEnabled && (
                  <>
                    <div className="space-y-2">
                      <Label htmlFor="smtp-host">Servidor SMTP</Label>
                      <Input id="smtp-host" defaultValue="smtp.gmail.com" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label htmlFor="smtp-port">Porta</Label>
                        <Input id="smtp-port" defaultValue="587" />
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor="smtp-secure">SeguranÃ§a</Label>
                        <Input id="smtp-secure" defaultValue="TLS" disabled />
                      </div>
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="smtp-user">UsuÃ¡rio</Label>
                      <Input id="smtp-user" defaultValue="avd@uisa.com.br" />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="smtp-pass">Senha de App</Label>
                      <Input id="smtp-pass" type="password" defaultValue="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                    </div>
                    <div className="flex gap-2">
                      <Button onClick={handleSaveEmail}>Salvar ConfiguraÃ§Ãµes</Button>
                      <Button variant="outline" onClick={handleTestEmail}>
                        Testar ConexÃ£o
                      </Button>
                    </div>
                  </>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* ConfiguraÃ§Ãµes TOTVS RM */}
          <TabsContent value="totvs" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>IntegraÃ§Ã£o TOTVS RM</CardTitle>
                <CardDescription>
                  Configure a integraÃ§Ã£o com o sistema TOTVS RM
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label>SincronizaÃ§Ã£o AutomÃ¡tica</Label>
                    <p className="text-sm text-muted-foreground">
                      Sincronizar dados automaticamente com TOTVS RM
                    </p>
                  </div>
                  <Switch checked={totvsEnabled} onCheckedChange={setTotvsEnabled} />
                </div>

                {totvsEnabled && (
                  <>
                    <div className="space-y-2">
                      <Label htmlFor="totvs-url">URL da API</Label>
                      <Input id="totvs-url" placeholder="https://api.totvs.com.br/rm" />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="totvs-tenant">Tenant ID</Label>
                      <Input id="totvs-tenant" placeholder="CNPJ da empresa" />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="totvs-key">App Key</Label>
                      <Input id="totvs-key" type="password" placeholder="Chave de aplicaÃ§Ã£o" />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="totvs-secret">App Secret</Label>
                      <Input id="totvs-secret" type="password" placeholder="Secret da aplicaÃ§Ã£o" />
                    </div>
                    <div className="flex gap-2">
                      <Button onClick={handleSaveTOTVS}>Salvar ConfiguraÃ§Ãµes</Button>
                      <Button variant="outline" onClick={handleTestTOTVS}>
                        Testar ConexÃ£o
                      </Button>
                    </div>
                  </>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/ConfiguracoesSMTP.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { trpc } from "@/lib/trpc";
import { Mail, Save, Send, Loader2 } from "lucide-react";
import { toast } from "sonner";

/**
 * ConfiguraÃ§Ãµes SMTP
 * 
 * PÃ¡gina para configurar servidor SMTP para envio de e-mails
 */

export default function ConfiguracoesSMTP() {
  const [config, setConfig] = useState({
    host: "",
    port: 587,
    secure: false,
    user: "",
    password: "",
    fromEmail: "",
    fromName: "Sistema AVD UISA",
  });

  const [testEmail, setTestEmail] = useState("rodrigo.goncalves@uisa.com.br");

  // Buscar configuraÃ§Ã£o existente
  const { data: existingConfig, isLoading } = trpc.smtpConfig.get.useQuery();

  // Mutation para salvar configuraÃ§Ã£o
  const saveConfigMutation = trpc.smtpConfig.save.useMutation({
    onSuccess: () => {
      toast.success("ConfiguraÃ§Ã£o SMTP salva com sucesso!");
    },
    onError: (error) => {
      toast.error(`Erro ao salvar configuraÃ§Ã£o: ${error.message}`);
    },
  });

  // Mutation para testar e-mail
  const sendTestMutation = trpc.email.sendTest.useMutation({
    onSuccess: () => {
      toast.success(`E-mail de teste enviado para ${testEmail}!`);
    },
    onError: (error) => {
      toast.error(`Erro ao enviar e-mail: ${error.message}`);
    },
  });

  // Carregar configuraÃ§Ã£o existente quando disponÃ­vel
  useState(() => {
    if (existingConfig) {
      setConfig({
        host: existingConfig.host,
        port: existingConfig.port,
        secure: existingConfig.secure ?? false,
        user: existingConfig.user,
        password: "", // NÃ£o mostrar senha por seguranÃ§a
        fromEmail: existingConfig.fromEmail,
        fromName: existingConfig.fromName,
      });
    }
  });

  const handleSave = () => {
    if (!config.host || !config.user || !config.fromEmail) {
      toast.error("Preencha todos os campos obrigatÃ³rios");
      return;
    }

    saveConfigMutation.mutate({
      host: config.host,
      port: config.port,
      secure: config.secure,
      user: config.user,
      password: config.password || undefined, // SÃ³ atualizar se fornecida
      fromEmail: config.fromEmail,
      fromName: config.fromName,
    });
  };

  const handleTest = () => {
    if (!testEmail) {
      toast.error("Digite um e-mail para teste");
      return;
    }

    sendTestMutation.mutate({ recipientEmail: testEmail });
  };

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-64">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold">ConfiguraÃ§Ãµes SMTP</h1>
          <p className="text-muted-foreground">
            Configure o servidor de e-mail para envio de notificaÃ§Ãµes
          </p>
        </div>

        {/* ConfiguraÃ§Ã£o SMTP */}
        <Card>
          <CardHeader>
            <div className="flex items-center gap-2">
              <Mail className="h-5 w-5 text-primary" />
              <CardTitle>Servidor SMTP</CardTitle>
            </div>
            <CardDescription>
              InformaÃ§Ãµes do servidor de e-mail para envio de notificaÃ§Ãµes
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Host */}
            <div className="grid gap-2">
              <Label htmlFor="host">Host do Servidor *</Label>
              <Input
                id="host"
                placeholder="smtp.gmail.com"
                value={config.host}
                onChange={(e) => setConfig({ ...config, host: e.target.value })}
              />
              <p className="text-sm text-muted-foreground">
                EndereÃ§o do servidor SMTP (ex: smtp.gmail.com, smtp.office365.com)
              </p>
            </div>

            {/* Porta e SeguranÃ§a */}
            <div className="grid gap-4 md:grid-cols-2">
              <div className="grid gap-2">
                <Label htmlFor="port">Porta *</Label>
                <Input
                  id="port"
                  type="number"
                  value={config.port}
                  onChange={(e) => setConfig({ ...config, port: parseInt(e.target.value) })}
                />
                <p className="text-sm text-muted-foreground">
                  Porta padrÃ£o: 587 (TLS) ou 465 (SSL)
                </p>
              </div>

              <div className="grid gap-2">
                <Label htmlFor="secure">Usar SSL/TLS</Label>
                <div className="flex items-center space-x-2 h-10">
                  <Switch
                    id="secure"
                    checked={config.secure}
                    onCheckedChange={(checked) => setConfig({ ...config, secure: checked })}
                  />
                  <Label htmlFor="secure" className="cursor-pointer">
                    {config.secure ? "SSL (porta 465)" : "TLS (porta 587)"}
                  </Label>
                </div>
              </div>
            </div>

            {/* UsuÃ¡rio e Senha */}
            <div className="grid gap-4 md:grid-cols-2">
              <div className="grid gap-2">
                <Label htmlFor="user">UsuÃ¡rio *</Label>
                <Input
                  id="user"
                  type="email"
                  placeholder="seu-email@exemplo.com"
                  value={config.user}
                  onChange={(e) => setConfig({ ...config, user: e.target.value })}
                />
              </div>

              <div className="grid gap-2">
                <Label htmlFor="password">Senha {existingConfig ? "(deixe vazio para manter)" : "*"}</Label>
                <Input
                  id="password"
                  type="password"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  value={config.password}
                  onChange={(e) => setConfig({ ...config, password: e.target.value })}
                />
              </div>
            </div>

            {/* Remetente */}
            <div className="grid gap-4 md:grid-cols-2">
              <div className="grid gap-2">
                <Label htmlFor="fromEmail">E-mail do Remetente *</Label>
                <Input
                  id="fromEmail"
                  type="email"
                  placeholder="noreply@uisa.com.br"
                  value={config.fromEmail}
                  onChange={(e) => setConfig({ ...config, fromEmail: e.target.value })}
                />
              </div>

              <div className="grid gap-2">
                <Label htmlFor="fromName">Nome do Remetente</Label>
                <Input
                  id="fromName"
                  placeholder="Sistema AVD UISA"
                  value={config.fromName}
                  onChange={(e) => setConfig({ ...config, fromName: e.target.value })}
                />
              </div>
            </div>

            {/* BotÃ£o Salvar */}
            <div className="flex justify-end">
              <Button
                onClick={handleSave}
                disabled={saveConfigMutation.isPending}
              >
                {saveConfigMutation.isPending ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Salvando...
                  </>
                ) : (
                  <>
                    <Save className="h-4 w-4 mr-2" />
                    Salvar ConfiguraÃ§Ã£o
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Teste de E-mail */}
        <Card>
          <CardHeader>
            <div className="flex items-center gap-2">
              <Send className="h-5 w-5 text-primary" />
              <CardTitle>Testar Envio de E-mail</CardTitle>
            </div>
            <CardDescription>
              Envie um e-mail de teste para verificar se a configuraÃ§Ã£o estÃ¡ correta
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid gap-2">
              <Label htmlFor="testEmail">E-mail de Teste</Label>
              <Input
                id="testEmail"
                type="email"
                placeholder="rodrigo.goncalves@uisa.com.br"
                value={testEmail}
                onChange={(e) => setTestEmail(e.target.value)}
              />
            </div>

            <Button
              onClick={handleTest}
              disabled={sendTestMutation.isPending || !testEmail}
              variant="outline"
            >
              {sendTestMutation.isPending ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Enviando...
                </>
              ) : (
                <>
                  <Send className="h-4 w-4 mr-2" />
                  Enviar E-mail de Teste
                </>
              )}
            </Button>

            {existingConfig && (
              <div className="rounded-lg border p-4 bg-muted/50">
                <p className="text-sm text-muted-foreground">
                  <strong>Ãšltima configuraÃ§Ã£o salva:</strong> {new Date(existingConfig.updatedAt).toLocaleString("pt-BR")}
                </p>
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/CriarDescricaoCargo.tsx
========================================
import { useState } from "react";
import { useLocation } from "wouter";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { trpc } from "@/lib/trpc";
import { toast } from "sonner";
import { Plus, Trash2, Save, Send, ChevronLeft, ChevronRight } from "lucide-react";
import DashboardLayout from "@/components/DashboardLayout";
import { Badge } from "@/components/ui/badge";

type Responsibility = {
  category: string;
  description: string;
  displayOrder: number;
};

type Knowledge = {
  name: string;
  level: "basico" | "intermediario" | "avancado" | "obrigatorio";
  displayOrder: number;
};

type Competency = {
  name: string;
  type: "competencia" | "habilidade";
  displayOrder: number;
};

export default function CriarDescricaoCargo() {
  const [, setLocation] = useLocation();
  const navigate = (path: string) => setLocation(path);
  const [currentStep, setCurrentStep] = useState(1);

  // SeÃ§Ã£o 1: InformaÃ§Ãµes BÃ¡sicas
  const [positionId, setPositionId] = useState<number>(1);
  const [positionTitle, setPositionTitle] = useState("");
  const [departmentId, setDepartmentId] = useState<number>(1);
  const [departmentName, setDepartmentName] = useState("");
  const [cbo, setCbo] = useState("");
  const [division, setDivision] = useState("");
  const [reportsTo, setReportsTo] = useState("");
  const [revision, setRevision] = useState("1.0");

  // SeÃ§Ã£o 2: Objetivo Principal
  const [mainObjective, setMainObjective] = useState("");

  // SeÃ§Ã£o 3: Responsabilidades
  const [responsibilities, setResponsibilities] = useState<Responsibility[]>([
    { category: "Processo", description: "", displayOrder: 0 },
  ]);

  // SeÃ§Ã£o 4: Conhecimentos TÃ©cnicos
  const [knowledge, setKnowledge] = useState<Knowledge[]>([
    { name: "", level: "basico", displayOrder: 0 },
  ]);

  // SeÃ§Ã£o 5: Treinamento ObrigatÃ³rio
  const [mandatoryTraining, setMandatoryTraining] = useState<string[]>([""]);

  // SeÃ§Ã£o 6: CompetÃªncias/Habilidades
  const [competencies, setCompetencies] = useState<Competency[]>([
    { name: "", type: "competencia", displayOrder: 0 },
  ]);

  // SeÃ§Ã£o 7: QualificaÃ§Ã£o Desejada
  const [educationLevel, setEducationLevel] = useState("");
  const [requiredExperience, setRequiredExperience] = useState("");

  // SeÃ§Ã£o 8: e-Social
  const [eSocialSpecs, setESocialSpecs] = useState("");

  const createMutation = trpc.jobDescriptions.create.useMutation({
    onSuccess: () => {
      toast.success("DescriÃ§Ã£o de cargo criada com sucesso!");
      navigate("/descricao-cargos-uisa");
    },
    onError: (error) => {
      toast.error("Erro ao criar descriÃ§Ã£o: " + error.message);
    },
  });

  const handleSaveDraft = () => {
    createMutation.mutate({
      positionId,
      positionTitle,
      departmentId,
      departmentName,
      cbo,
      division,
      reportsTo,
      revision,
      mainObjective,
      mandatoryTraining: mandatoryTraining.filter(t => t.trim() !== ""),
      educationLevel,
      requiredExperience,
      eSocialSpecs,
      responsibilities: responsibilities.filter(r => r.description.trim() !== ""),
      knowledge: knowledge.filter(k => k.name.trim() !== ""),
      competencies: competencies.filter(c => c.name.trim() !== ""),
    });
  };

  const addResponsibility = () => {
    setResponsibilities([...responsibilities, { category: "Processo", description: "", displayOrder: responsibilities.length }]);
  };

  const removeResponsibility = (index: number) => {
    setResponsibilities(responsibilities.filter((_, i) => i !== index));
  };

  const addKnowledge = () => {
    setKnowledge([...knowledge, { name: "", level: "basico", displayOrder: knowledge.length }]);
  };

  const removeKnowledge = (index: number) => {
    setKnowledge(knowledge.filter((_, i) => i !== index));
  };

  const addTraining = () => {
    setMandatoryTraining([...mandatoryTraining, ""]);
  };

  const removeTraining = (index: number) => {
    setMandatoryTraining(mandatoryTraining.filter((_, i) => i !== index));
  };

  const addCompetency = () => {
    setCompetencies([...competencies, { name: "", type: "competencia", displayOrder: competencies.length }]);
  };

  const removeCompetency = (index: number) => {
    setCompetencies(competencies.filter((_, i) => i !== index));
  };

  const steps = [
    { number: 1, title: "InformaÃ§Ãµes BÃ¡sicas" },
    { number: 2, title: "Objetivo Principal" },
    { number: 3, title: "Responsabilidades" },
    { number: 4, title: "Conhecimentos TÃ©cnicos" },
    { number: 5, title: "Treinamento ObrigatÃ³rio" },
    { number: 6, title: "CompetÃªncias/Habilidades" },
    { number: 7, title: "QualificaÃ§Ã£o Desejada" },
    { number: 8, title: "e-Social" },
  ];

  return (
    <DashboardLayout>
      <div className="container mx-auto py-8">
        <div className="mb-8">
          <h1 className="text-3xl font-bold mb-2">Nova DescriÃ§Ã£o de Cargo</h1>
          <p className="text-muted-foreground">Template UISA - Preencha todas as seÃ§Ãµes</p>
        </div>

        {/* Wizard Steps */}
        <div className="mb-8">
          <div className="flex items-center justify-between">
            {steps.map((step, index) => (
              <div key={step.number} className="flex items-center">
                <div className="flex flex-col items-center">
                  <div
                    className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
                      currentStep === step.number
                        ? "bg-primary text-primary-foreground"
                        : currentStep > step.number
                        ? "bg-green-500 text-white"
                        : "bg-muted text-muted-foreground"
                    }`}
                  >
                    {step.number}
                  </div>
                  <span className="text-xs mt-2 text-center max-w-[100px]">{step.title}</span>
                </div>
                {index < steps.length - 1 && (
                  <div className={`h-1 w-12 mx-2 ${currentStep > step.number ? "bg-green-500" : "bg-muted"}`} />
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Step Content */}
        <Card>
          <CardHeader>
            <CardTitle>SeÃ§Ã£o {currentStep}: {steps[currentStep - 1].title}</CardTitle>
          </CardHeader>
          <CardContent>
            {/* SeÃ§Ã£o 1: InformaÃ§Ãµes BÃ¡sicas */}
            {currentStep === 1 && (
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Cargo *</Label>
                    <Input value={positionTitle} onChange={(e) => setPositionTitle(e.target.value)} placeholder="Ex: Analista Planejamento Custos SR" />
                  </div>
                  <div>
                    <Label>Departamento *</Label>
                    <Input value={departmentName} onChange={(e) => setDepartmentName(e.target.value)} placeholder="Ex: PLANEJAMENTO CUSTOS" />
                  </div>
                  <div>
                    <Label>CBO</Label>
                    <Input value={cbo} onChange={(e) => setCbo(e.target.value)} placeholder="CÃ³digo Brasileiro de OcupaÃ§Ãµes" />
                  </div>
                  <div>
                    <Label>DivisÃ£o</Label>
                    <Input value={division} onChange={(e) => setDivision(e.target.value)} placeholder="Ex: ADMINISTRATIVA" />
                  </div>
                  <div>
                    <Label>Reporta para (Superior Imediato)</Label>
                    <Input value={reportsTo} onChange={(e) => setReportsTo(e.target.value)} placeholder="Ex: COORDENADOR PLANEJAMENTO CUSTOS" />
                  </div>
                  <div>
                    <Label>RevisÃ£o</Label>
                    <Input value={revision} onChange={(e) => setRevision(e.target.value)} placeholder="Ex: 1.0" />
                  </div>
                </div>
              </div>
            )}

            {/* SeÃ§Ã£o 2: Objetivo Principal */}
            {currentStep === 2 && (
              <div>
                <Label>Objetivo Principal do Cargo *</Label>
                <Textarea
                  value={mainObjective}
                  onChange={(e) => setMainObjective(e.target.value)}
                  placeholder="Descreva o objetivo principal do cargo..."
                  rows={8}
                  className="mt-2"
                />
              </div>
            )}

            {/* SeÃ§Ã£o 3: Responsabilidades */}
            {currentStep === 3 && (
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <Label>Responsabilidades por Categoria</Label>
                  <Button onClick={addResponsibility} size="sm">
                    <Plus className="w-4 h-4 mr-2" />
                    Adicionar
                  </Button>
                </div>
                {responsibilities.map((resp, index) => (
                  <div key={index} className="border p-4 rounded-lg space-y-2">
                    <div className="flex justify-between items-center">
                      <Select
                        value={resp.category}
                        onValueChange={(value) => {
                          const newResp = [...responsibilities];
                          newResp[index].category = value;
                          setResponsibilities(newResp);
                        }}
                      >
                        <SelectTrigger className="w-[250px]">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="Processo">Processo</SelectItem>
                          <SelectItem value="AnÃ¡lise KPI">AnÃ¡lise KPI</SelectItem>
                          <SelectItem value="Planejamento">Planejamento</SelectItem>
                          <SelectItem value="Budget/Capex/Forecast">Budget/Capex/Forecast</SelectItem>
                          <SelectItem value="Resultados">Resultados</SelectItem>
                        </SelectContent>
                      </Select>
                      <Button variant="destructive" size="sm" onClick={() => removeResponsibility(index)}>
                        <Trash2 className="w-4 h-4" />
                      </Button>
                    </div>
                    <Textarea
                      value={resp.description}
                      onChange={(e) => {
                        const newResp = [...responsibilities];
                        newResp[index].description = e.target.value;
                        setResponsibilities(newResp);
                      }}
                      placeholder="Descreva a responsabilidade..."
                      rows={3}
                    />
                  </div>
                ))}
              </div>
            )}

            {/* SeÃ§Ã£o 4: Conhecimentos TÃ©cnicos */}
            {currentStep === 4 && (
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <Label>Conhecimentos TÃ©cnicos</Label>
                  <Button onClick={addKnowledge} size="sm">
                    <Plus className="w-4 h-4 mr-2" />
                    Adicionar
                  </Button>
                </div>
                <div className="grid gap-4">
                  {knowledge.map((k, index) => (
                    <div key={index} className="flex gap-4 items-center">
                      <Input
                        value={k.name}
                        onChange={(e) => {
                          const newK = [...knowledge];
                          newK[index].name = e.target.value;
                          setKnowledge(newK);
                        }}
                        placeholder="Ex: Office, AnÃ¡lise de Processos"
                        className="flex-1"
                      />
                      <Select
                        value={k.level}
                        onValueChange={(value: any) => {
                          const newK = [...knowledge];
                          newK[index].level = value;
                          setKnowledge(newK);
                        }}
                      >
                        <SelectTrigger className="w-[180px]">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="basico">BÃ¡sico</SelectItem>
                          <SelectItem value="intermediario">IntermediÃ¡rio</SelectItem>
                          <SelectItem value="avancado">AvanÃ§ado</SelectItem>
                          <SelectItem value="obrigatorio">ObrigatÃ³rio</SelectItem>
                        </SelectContent>
                      </Select>
                      <Button variant="destructive" size="sm" onClick={() => removeKnowledge(index)}>
                        <Trash2 className="w-4 h-4" />
                      </Button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* SeÃ§Ã£o 5: Treinamento ObrigatÃ³rio */}
            {currentStep === 5 && (
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <Label>Treinamentos ObrigatÃ³rios</Label>
                  <Button onClick={addTraining} size="sm">
                    <Plus className="w-4 h-4 mr-2" />
                    Adicionar
                  </Button>
                </div>
                {mandatoryTraining.map((training, index) => (
                  <div key={index} className="flex gap-4">
                    <Input
                      value={training}
                      onChange={(e) => {
                        const newTraining = [...mandatoryTraining];
                        newTraining[index] = e.target.value;
                        setMandatoryTraining(newTraining);
                      }}
                      placeholder="Nome do treinamento obrigatÃ³rio"
                      className="flex-1"
                    />
                    <Button variant="destructive" size="sm" onClick={() => removeTraining(index)}>
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </div>
                ))}
              </div>
            )}

            {/* SeÃ§Ã£o 6: CompetÃªncias/Habilidades */}
            {currentStep === 6 && (
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <Label>CompetÃªncias e Habilidades</Label>
                  <Button onClick={addCompetency} size="sm">
                    <Plus className="w-4 h-4 mr-2" />
                    Adicionar
                  </Button>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  {competencies.map((comp, index) => (
                    <div key={index} className="flex gap-2 items-center">
                      <Input
                        value={comp.name}
                        onChange={(e) => {
                          const newComp = [...competencies];
                          newComp[index].name = e.target.value;
                          setCompetencies(newComp);
                        }}
                        placeholder="Ex: Planejamento, ComunicaÃ§Ã£o"
                        className="flex-1"
                      />
                      <Select
                        value={comp.type}
                        onValueChange={(value: any) => {
                          const newComp = [...competencies];
                          newComp[index].type = value;
                          setCompetencies(newComp);
                        }}
                      >
                        <SelectTrigger className="w-[140px]">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="competencia">CompetÃªncia</SelectItem>
                          <SelectItem value="habilidade">Habilidade</SelectItem>
                        </SelectContent>
                      </Select>
                      <Button variant="destructive" size="sm" onClick={() => removeCompetency(index)}>
                        <Trash2 className="w-4 h-4" />
                      </Button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* SeÃ§Ã£o 7: QualificaÃ§Ã£o Desejada */}
            {currentStep === 7 && (
              <div className="space-y-4">
                <div>
                  <Label>FormaÃ§Ã£o</Label>
                  <Input
                    value={educationLevel}
                    onChange={(e) => setEducationLevel(e.target.value)}
                    placeholder="Ex: Ensino Superior"
                    className="mt-2"
                  />
                </div>
                <div>
                  <Label>ExperiÃªncia Requerida</Label>
                  <Textarea
                    value={requiredExperience}
                    onChange={(e) => setRequiredExperience(e.target.value)}
                    placeholder="Ex: DesejÃ¡vel de 4 a 6 anos no cargo ou posiÃ§Ãµes similares"
                    rows={4}
                    className="mt-2"
                  />
                </div>
              </div>
            )}

            {/* SeÃ§Ã£o 8: e-Social */}
            {currentStep === 8 && (
              <div>
                <Label>EspecificaÃ§Ãµes e-Social</Label>
                <Textarea
                  value={eSocialSpecs}
                  onChange={(e) => setESocialSpecs(e.target.value)}
                  placeholder="EspecificaÃ§Ãµes do Programa de Medicina e SeguranÃ§a do Trabalho (PCMSO, PPRA)"
                  rows={6}
                  className="mt-2"
                />
              </div>
            )}
          </CardContent>
        </Card>

        {/* Navigation Buttons */}
        <div className="flex justify-between mt-6">
          <Button
            variant="outline"
            onClick={() => setCurrentStep(Math.max(1, currentStep - 1))}
            disabled={currentStep === 1}
          >
            <ChevronLeft className="w-4 h-4 mr-2" />
            Anterior
          </Button>

          <div className="flex gap-2">
            <Button variant="outline" onClick={handleSaveDraft} disabled={createMutation.isPending}>
              <Save className="w-4 h-4 mr-2" />
              Salvar Rascunho
            </Button>

            {currentStep < 8 ? (
              <Button onClick={() => setCurrentStep(Math.min(8, currentStep + 1))}>
                PrÃ³ximo
                <ChevronRight className="w-4 h-4 ml-2" />
              </Button>
            ) : (
              <Button onClick={handleSaveDraft} disabled={createMutation.isPending}>
                <Send className="w-4 h-4 mr-2" />
                Finalizar e Salvar
              </Button>
            )}
          </div>
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/CriarMetaSMART.tsx
========================================
import { useState } from "react";
import { useLocation } from "wouter";
import { formatCurrency, parseCurrency, formatCurrencyInput } from "@/lib/currency";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { toast } from "sonner";
import {
  CheckCircle2,
  XCircle,
  AlertCircle,
  ArrowLeft,
  ArrowRight,
  Save,
  Target,
} from "lucide-react";

/**
 * Wizard de CriaÃ§Ã£o de Meta SMART
 * ValidaÃ§Ã£o em tempo real dos 5 critÃ©rios SMART
 */
export default function CriarMetaSMART() {
  const [, setLocation] = useLocation();
  // Toast jÃ¡ importado do sonner
  const [step, setStep] = useState(1);

  // Form state
  const [formData, setFormData] = useState({
    title: "",
    description: "",
    type: "individual" as "individual" | "team" | "organizational",
    category: "development" as "financial" | "behavioral" | "corporate" | "development",
    measurementUnit: "",
    targetValue: "",
    weight: "10",
    startDate: "",
    endDate: "",
    bonusEligible: false,
    bonusPercentage: "",
    bonusAmount: "",
    cycleId: "",
    pdiPlanId: "",
  });

  // Buscar ciclos
  const { data: cycles = [] } = trpc.cyclesLegacy.list.useQuery();

  // Buscar PDIs do colaborador
  const { data: pdis = [] } = trpc.pdi.list.useQuery({});

  // ValidaÃ§Ã£o SMART
  const [validation, setValidation] = useState<any>(null);
  const validateMutation = trpc.smartGoals.validateSMART.useMutation();

  // Criar meta
  const createMutation = trpc.smartGoals.createSMART.useMutation({
    onSuccess: (data) => {
      toast.success("Meta criada com sucesso!", {
        description: `Score SMART: ${data.validation.score}/100`,
      });
      setLocation("/metas");
    },
    onError: (error) => {
      toast.error("Erro ao criar meta", {
        description: error.message,
      });
    },
  });

  const handleValidate = async () => {
    if (!formData.title || !formData.description || !formData.startDate || !formData.endDate) {
      toast.error("Campos obrigatÃ³rios", {
        description: "Preencha tÃ­tulo, descriÃ§Ã£o e datas",
      });
      return;
    }

    const result = await validateMutation.mutateAsync({
      title: formData.title,
      description: formData.description,
      measurementUnit: formData.measurementUnit,
      targetValue: formData.targetValue ? parseFloat(formData.targetValue) : undefined,
      startDate: formData.startDate,
      endDate: formData.endDate,
    });
    setValidation(result);
  };

  const handleSubmit = async () => {
    if (!formData.cycleId) {
      toast.error("Ciclo obrigatÃ³rio", {
        description: "Selecione um ciclo de avaliaÃ§Ã£o",
      });
      return;
    }

    // Validar bÃ´nus exclusivo
    if (formData.bonusEligible) {
      if (formData.bonusPercentage && formData.bonusAmount) {
        toast.error("BÃ´nus invÃ¡lido", {
          description: "Escolha apenas um tipo de bÃ´nus: percentual OU fixo",
        });
        return;
      }
      if (!formData.bonusPercentage && !formData.bonusAmount) {
        toast.error("BÃ´nus obrigatÃ³rio", {
          description: "Preencha o bÃ´nus percentual ou fixo",
        });
        return;
      }
    }

    await createMutation.mutateAsync({
      title: formData.title,
      description: formData.description,
      type: formData.type,
      category: formData.category,
      measurementUnit: formData.measurementUnit || undefined,
      targetValue: formData.targetValue ? parseFloat(formData.targetValue) : undefined,
      weight: parseInt(formData.weight),
      startDate: formData.startDate,
      endDate: formData.endDate,
      bonusEligible: formData.bonusEligible,
      bonusPercentage: formData.bonusPercentage ? parseFloat(formData.bonusPercentage) : undefined,
      bonusAmount: formData.bonusAmount ? parseFloat(formData.bonusAmount) : undefined,
      cycleId: parseInt(formData.cycleId),
      pdiPlanId: formData.pdiPlanId ? parseInt(formData.pdiPlanId) : undefined,
    });
  };

  const renderSMARTIndicator = (criterion: string, value: boolean | undefined) => {
    if (value === undefined) return null;
    return value ? (
      <CheckCircle2 className="w-5 h-5 text-green-600" />
    ) : (
      <XCircle className="w-5 h-5 text-red-600" />
    );
  };

  const smartScore = validation?.data
    ? [
        validation.data.isSpecific,
        validation.data.isMeasurable,
        validation.data.isAchievable,
        validation.data.isRelevant,
        validation.data.isTimeBound,
      ].filter(Boolean).length * 20
    : 0;

  return (
    <div className="container mx-auto p-6 max-w-4xl">
      {/* Header */}
      <div className="mb-6">
        <Button variant="ghost" onClick={() => setLocation("/metas")} className="mb-4">
          <ArrowLeft className="w-4 h-4 mr-2" />
          Voltar
        </Button>
        <h1 className="text-3xl font-bold text-gray-900">Criar Nova Meta SMART</h1>
        <p className="text-gray-600 mt-1">
          Defina uma meta com critÃ©rios SMART para garantir clareza e atingibilidade
        </p>
      </div>

      {/* Progress Steps */}
      <div className="mb-8">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm font-medium">Passo {step} de 3</span>
          <span className="text-sm text-gray-600">
            {step === 1 && "InformaÃ§Ãµes BÃ¡sicas"}
            {step === 2 && "MÃ©tricas e Datas"}
            {step === 3 && "BÃ´nus e VinculaÃ§Ã£o"}
          </span>
        </div>
        <Progress value={(step / 3) * 100} className="h-2" />
      </div>

      {/* Step 1: InformaÃ§Ãµes BÃ¡sicas */}
      {step === 1 && (
        <Card>
          <CardHeader>
            <CardTitle>InformaÃ§Ãµes BÃ¡sicas</CardTitle>
            <CardDescription>
              Defina o tÃ­tulo, descriÃ§Ã£o e categoria da meta
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="title">TÃ­tulo da Meta *</Label>
              <Input
                id="title"
                placeholder="Ex: Aumentar vendas em 20%"
                value={formData.title}
                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                className="mt-1"
              />
              <p className="text-xs text-gray-500 mt-1">MÃ­nimo 10 caracteres</p>
            </div>

            <div>
              <Label htmlFor="description">DescriÃ§Ã£o Detalhada *</Label>
              <Textarea
                id="description"
                placeholder="Descreva a meta com detalhes, incluindo o impacto esperado e a estratÃ©gia para atingi-la..."
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                rows={5}
                className="mt-1"
              />
              <p className="text-xs text-gray-500 mt-1">
                MÃ­nimo 50 caracteres. Use verbos de aÃ§Ã£o (aumentar, reduzir, melhorar, etc.)
              </p>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="type">Tipo de Meta</Label>
                <Select
                  value={formData.type}
                  onValueChange={(v: any) => setFormData({ ...formData, type: v })}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="individual">Individual</SelectItem>
                    <SelectItem value="team">Equipe</SelectItem>
                    <SelectItem value="organizational">Organizacional</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="category">Categoria</Label>
                <Select
                  value={formData.category}
                  onValueChange={(v: any) => setFormData({ ...formData, category: v })}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="financial">Financeira</SelectItem>
                    <SelectItem value="behavioral">Comportamental</SelectItem>
                    <SelectItem value="corporate">Corporativa</SelectItem>
                    <SelectItem value="development">Desenvolvimento</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div>
              <Label htmlFor="cycleId">Ciclo de AvaliaÃ§Ã£o *</Label>
              <Select
                value={formData.cycleId}
                onValueChange={(v) => setFormData({ ...formData, cycleId: v })}
              >
                <SelectTrigger className="mt-1">
                  <SelectValue placeholder="Selecione o ciclo" />
                </SelectTrigger>
                <SelectContent>
                  {cycles.map((cycle: any) => (
                    <SelectItem key={cycle.id} value={cycle.id.toString()}>
                      {cycle.name} ({new Date(cycle.startDate).getFullYear()})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="flex justify-end">
              <Button onClick={() => setStep(2)} className="bg-[#F39200] hover:bg-[#d67e00]">
                PrÃ³ximo
                <ArrowRight className="w-4 h-4 ml-2" />
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Step 2: MÃ©tricas e Datas */}
      {step === 2 && (
        <Card>
          <CardHeader>
            <CardTitle>MÃ©tricas e Datas</CardTitle>
            <CardDescription>
              Defina como a meta serÃ¡ medida e o prazo para conclusÃ£o
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="measurementUnit">Unidade de Medida</Label>
                <Input
                  id="measurementUnit"
                  placeholder="Ex: R$, %, unidades"
                  value={formData.measurementUnit}
                  onChange={(e) =>
                    setFormData({ ...formData, measurementUnit: e.target.value })
                  }
                  className="mt-1"
                />
              </div>

              <div>
                <Label htmlFor="targetValue">Valor Alvo</Label>
                <Input
                  id="targetValue"
                  type="number"
                  placeholder="Ex: 100"
                  value={formData.targetValue}
                  onChange={(e) => setFormData({ ...formData, targetValue: e.target.value })}
                  className="mt-1"
                />
              </div>
            </div>

            <div>
              <Label htmlFor="weight">Peso da Meta (1-100)</Label>
              <Input
                id="weight"
                type="number"
                min="1"
                max="100"
                value={formData.weight}
                onChange={(e) => setFormData({ ...formData, weight: e.target.value })}
                className="mt-1"
              />
              <p className="text-xs text-gray-500 mt-1">
                Peso usado para cÃ¡lculo de bÃ´nus e performance
              </p>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="startDate">Data de InÃ­cio *</Label>
                <Input
                  id="startDate"
                  type="date"
                  value={formData.startDate}
                  onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                  className="mt-1"
                />
              </div>

              <div>
                <Label htmlFor="endDate">Data de TÃ©rmino *</Label>
                <Input
                  id="endDate"
                  type="date"
                  value={formData.endDate}
                  onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                  className="mt-1"
                />
              </div>
            </div>

            <div className="bg-blue-50 p-4 rounded-lg">
              <div className="flex items-start gap-2">
                <AlertCircle className="w-5 h-5 text-blue-600 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-blue-900">Dica SMART</p>
                  <p className="text-sm text-blue-700 mt-1">
                    O prazo deve estar entre 1 mÃªs e 24 meses para ser considerado temporal
                    (Time-bound)
                  </p>
                </div>
              </div>
            </div>

            <div className="flex justify-between">
              <Button variant="outline" onClick={() => setStep(1)}>
                <ArrowLeft className="w-4 h-4 mr-2" />
                Voltar
              </Button>
              <Button onClick={() => setStep(3)} className="bg-[#F39200] hover:bg-[#d67e00]">
                PrÃ³ximo
                <ArrowRight className="w-4 h-4 ml-2" />
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Step 3: BÃ´nus e VinculaÃ§Ã£o */}
      {step === 3 && (
        <div className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>BÃ´nus e VinculaÃ§Ã£o</CardTitle>
              <CardDescription>
                Configure elegibilidade para bÃ´nus e vincule com PDI
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between p-4 border rounded-lg">
                <div>
                  <Label htmlFor="bonusEligible" className="text-base font-medium">
                    ElegÃ­vel para BÃ´nus Financeiro
                  </Label>
                  <p className="text-sm text-gray-600 mt-1">
                    Ativar se esta meta deve contar para cÃ¡lculo de bÃ´nus
                  </p>
                </div>
                <Switch
                  id="bonusEligible"
                  checked={formData.bonusEligible}
                  onCheckedChange={(checked) =>
                    setFormData({ ...formData, bonusEligible: checked })
                  }
                />
              </div>

              {formData.bonusEligible && (
                <div className="space-y-4 p-4 bg-green-50 rounded-lg">
                  <p className="text-sm font-medium text-gray-700">
                    Escolha o tipo de bÃ´nus (apenas um):
                  </p>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="bonusPercentage">BÃ´nus Percentual (%)</Label>
                      <Input
                        id="bonusPercentage"
                        type="number"
                        step="0.01"
                        placeholder="Ex: 5.5"
                        value={formData.bonusPercentage}
                        onChange={(e) =>
                          setFormData({ 
                            ...formData, 
                            bonusPercentage: e.target.value,
                            bonusAmount: "" // Limpa o outro campo
                          })
                        }
                        disabled={!!formData.bonusAmount}
                        className="mt-1"
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        Percentual do salÃ¡rio
                      </p>
                    </div>

                    <div>
                      <Label htmlFor="bonusAmount">BÃ´nus Fixo</Label>
                      <Input
                        id="bonusAmount"
                        type="text"
                        placeholder="R$ 1.000,00"
                        value={formData.bonusAmount ? formatCurrency(parseFloat(formData.bonusAmount)) : ''}
                        onChange={(e) => {
                          const formatted = formatCurrencyInput(e.target.value);
                          const numValue = parseCurrency(formatted);
                          setFormData({ 
                            ...formData, 
                            bonusAmount: numValue.toString(),
                            bonusPercentage: "" // Limpa o outro campo
                          });
                        }}
                        disabled={!!formData.bonusPercentage}
                        className="mt-1"
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        Valor fixo em reais (R$)
                      </p>
                    </div>
                  </div>
                  {!formData.bonusPercentage && !formData.bonusAmount && (
                    <p className="text-xs text-orange-600 flex items-center gap-1">
                      <AlertCircle className="w-3 h-3" />
                      Preencha um dos campos de bÃ´nus
                    </p>
                  )}
                </div>
              )}

              <div>
                <Label htmlFor="pdiPlanId">Vincular com PDI (Opcional)</Label>
                <Select
                  value={formData.pdiPlanId}
                  onValueChange={(v) => setFormData({ ...formData, pdiPlanId: v })}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue placeholder="Selecione um PDI" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="none">Nenhum</SelectItem>
                    {pdis.map((pdi: any) => (
                      <SelectItem key={pdi.id} value={pdi.id.toString()}>
                        {pdi.title || `PDI #${pdi.id}`}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <p className="text-xs text-gray-500 mt-1">
                  Vincule esta meta com um Plano de Desenvolvimento Individual
                </p>
              </div>

              <div className="flex justify-between">
                <Button variant="outline" onClick={() => setStep(2)}>
                  <ArrowLeft className="w-4 h-4 mr-2" />
                  Voltar
                </Button>
                <Button
                  onClick={handleValidate}
                  variant="outline"
                  disabled={validateMutation.isPending}
                  className="border-blue-600 text-blue-600 hover:bg-blue-50"
                >
                  <Target className="w-4 h-4 mr-2" />
                  Validar SMART
                </Button>
              </div>
            </CardContent>
          </Card>

          {/* ValidaÃ§Ã£o SMART */}
          {validation?.data && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <span>ValidaÃ§Ã£o SMART</span>
                  <Badge
                    variant={smartScore >= 80 ? "default" : "destructive"}
                    className="text-lg px-4 py-1"
                  >
                    {smartScore}/100
                  </Badge>
                </CardTitle>
                <CardDescription>
                  Sua meta atende {smartScore / 20} de 5 critÃ©rios SMART
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex items-center justify-between p-3 border rounded-lg">
                  <div>
                    <p className="font-medium">S - EspecÃ­fica (Specific)</p>
                    <p className="text-sm text-gray-600">
                      A meta Ã© clara e bem definida?
                    </p>
                  </div>
                  {renderSMARTIndicator("specific", validation.data.isSpecific)}
                </div>

                <div className="flex items-center justify-between p-3 border rounded-lg">
                  <div>
                    <p className="font-medium">M - MensurÃ¡vel (Measurable)</p>
                    <p className="text-sm text-gray-600">
                      Possui unidade de medida e valor alvo?
                    </p>
                  </div>
                  {renderSMARTIndicator("measurable", validation.data.isMeasurable)}
                </div>

                <div className="flex items-center justify-between p-3 border rounded-lg">
                  <div>
                    <p className="font-medium">A - AtingÃ­vel (Achievable)</p>
                    <p className="text-sm text-gray-600">
                      O valor alvo Ã© realista?
                    </p>
                  </div>
                  {renderSMARTIndicator("achievable", validation.data.isAchievable)}
                </div>

                <div className="flex items-center justify-between p-3 border rounded-lg">
                  <div>
                    <p className="font-medium">R - Relevante (Relevant)</p>
                    <p className="text-sm text-gray-600">
                      Demonstra impacto e alinhamento estratÃ©gico?
                    </p>
                  </div>
                  {renderSMARTIndicator("relevant", validation.data.isRelevant)}
                </div>

                <div className="flex items-center justify-between p-3 border rounded-lg">
                  <div>
                    <p className="font-medium">T - Temporal (Time-bound)</p>
                    <p className="text-sm text-gray-600">
                      Tem prazo definido (1-24 meses)?
                    </p>
                  </div>
                  {renderSMARTIndicator("timebound", validation.data.isTimeBound)}
                </div>

                {validation.data.feedback.length > 0 && (
                  <div className="bg-yellow-50 p-4 rounded-lg">
                    <p className="font-medium text-yellow-900 mb-2">SugestÃµes de Melhoria:</p>
                    <ul className="list-disc list-inside space-y-1">
                      {validation.feedback.map((feedback: string, i: number) => (
                        <li key={i} className="text-sm text-yellow-800">
                          {feedback}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                <Button
                  onClick={handleSubmit}
                  disabled={createMutation.isPending}
                  className="w-full bg-[#F39200] hover:bg-[#d67e00] mt-4"
                  size="lg"
                >
                  <Save className="w-4 h-4 mr-2" />
                  {createMutation.isPending ? "Salvando..." : "Criar Meta"}
                </Button>
              </CardContent>
            </Card>
          )}
        </div>
      )}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/DashboardBonusRH.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  DollarSign,
  TrendingUp,
  Users,
  CheckCircle2,
  Clock,
  XCircle,
  Search,
  FileText,
  Send,
} from "lucide-react";
import { toast } from "sonner";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

/**
 * Dashboard de RH para GestÃ£o de BÃ´nus
 * VisualizaÃ§Ã£o consolidada, cÃ¡lculo de elegibilidade e aprovaÃ§Ã£o de bÃ´nus
 */
export default function DashboardBonusRH() {
  const [selectedCycleId, setSelectedCycleId] = useState<number | undefined>(undefined);
  const [approvalDialogOpen, setApprovalDialogOpen] = useState(false);
  const [selectedEmployee, setSelectedEmployee] = useState<any>(null);
  const [extraBonusPercentage, setExtraBonusPercentage] = useState("0");
  const [selectedWorkflowId, setSelectedWorkflowId] = useState<string>("");
  const [searchTerm, setSearchTerm] = useState("");

  // Queries
  const { data: dashboard, refetch: refetchDashboard } = trpc.bonus.getDashboard.useQuery({
    cycleId: selectedCycleId,
  });

  const { data: cycles = [] } = trpc.cyclesLegacy.list.useQuery();
  const { data: workflows = [] } = trpc.bonus.listWorkflows.useQuery();
  const { data: pendingApprovals = [] } = trpc.bonus.myPendingApprovals.useQuery();

  // Mutations
  const initiateMutation = trpc.bonus.initiateApproval.useMutation({
    onSuccess: () => {
      toast.success("Processo de aprovaÃ§Ã£o iniciado com sucesso!");
      refetchDashboard();
      setApprovalDialogOpen(false);
      setSelectedEmployee(null);
      setExtraBonusPercentage("0");
      setSelectedWorkflowId("");
    },
    onError: (error: any) => {
      toast.error("Erro ao iniciar aprovaÃ§Ã£o", {
        description: error.message,
      });
    },
  });

  const approveMutation = trpc.bonus.approveLevel.useMutation({
    onSuccess: () => {
      toast.success("BÃ´nus aprovado com sucesso!");
      refetchDashboard();
    },
    onError: (error: any) => {
      toast.error("Erro ao aprovar bÃ´nus", {
        description: error.message,
      });
    },
  });

  const openApprovalDialog = async (employee: any) => {
    if (!selectedCycleId) {
      toast.error("Selecione um ciclo primeiro");
      return;
    }

    setSelectedEmployee(employee);
    setApprovalDialogOpen(true);
  };

  const handleInitiateApproval = () => {
    if (!selectedEmployee || !selectedWorkflowId || !selectedCycleId) {
      toast.error("Preencha todos os campos");
      return;
    }

    const eligibleAmount = parseFloat(selectedEmployee.eligibleAmount || "0");
    const extraPercentage = parseFloat(extraBonusPercentage);

    initiateMutation.mutate({
      employeeId: selectedEmployee.employeeId,
      cycleId: selectedCycleId,
      workflowId: Number(selectedWorkflowId),
      eligibleAmount,
      extraBonusPercentage: extraPercentage,
    });
  };

  const handleApprove = (approvalId: number, level: number) => {
    if (confirm("Confirma a aprovaÃ§Ã£o deste bÃ´nus?")) {
      approveMutation.mutate({
        approvalId,
        level,
        action: "approved",
      });
    }
  };

  const handleReject = (approvalId: number, level: number) => {
    const comments = prompt("Motivo da rejeiÃ§Ã£o:");
    if (comments) {
      approveMutation.mutate({
        approvalId,
        level,
        action: "rejected",
        comments,
      });
    }
  };

  const filteredApprovals = dashboard?.approvals?.filter((approval: any) =>
    approval.employeeName?.toLowerCase().includes(searchTerm.toLowerCase())
  ) || [];

  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Dashboard de BÃ´nus - RH</h1>
          <p className="text-gray-600 mt-1">
            Gerencie aprovaÃ§Ãµes de bÃ´nus e visualize estatÃ­sticas consolidadas
          </p>
        </div>

        <div className="w-64">
          <Label>Ciclo de AvaliaÃ§Ã£o</Label>
          <Select
            value={selectedCycleId?.toString() || ""}
            onValueChange={(v) => setSelectedCycleId(v ? Number(v) : undefined)}
          >
            <SelectTrigger>
              <SelectValue placeholder="Selecione um ciclo" />
            </SelectTrigger>
            <SelectContent>
              {cycles.map((cycle: any) => (
                <SelectItem key={cycle.id} value={cycle.id.toString()}>
                  {cycle.name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total de AprovaÃ§Ãµes</CardTitle>
            <Users className="h-4 w-4 text-blue-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{dashboard?.totalApprovals || 0}</div>
            <p className="text-xs text-gray-500 mt-1">Colaboradores no ciclo</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">BÃ´nus ElegÃ­vel</CardTitle>
            <DollarSign className="h-4 w-4 text-green-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              R$ {dashboard?.totalEligible?.toFixed(2) || "0.00"}
            </div>
            <p className="text-xs text-gray-500 mt-1">Baseado em metas concluÃ­das</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">BÃ´nus Final</CardTitle>
            <TrendingUp className="h-4 w-4 text-emerald-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              R$ {dashboard?.totalFinal?.toFixed(2) || "0.00"}
            </div>
            <p className="text-xs text-gray-500 mt-1">Com bÃ´nus extra aplicado</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Status</CardTitle>
            <CheckCircle2 className="h-4 w-4 text-purple-600" />
          </CardHeader>
          <CardContent>
            <div className="flex gap-2 text-sm">
              <Badge className="bg-yellow-500">{dashboard?.pendingCount || 0} Pendentes</Badge>
              <Badge className="bg-green-500">{dashboard?.approvedCount || 0} Aprovados</Badge>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Tabs */}
      <Tabs defaultValue="all" className="space-y-4">
        <TabsList>
          <TabsTrigger value="all">Todos ({filteredApprovals.length})</TabsTrigger>
          <TabsTrigger value="pending">
            Pendentes ({dashboard?.pendingCount || 0})
          </TabsTrigger>
          <TabsTrigger value="my-approvals">
            Minhas AprovaÃ§Ãµes ({pendingApprovals.length})
          </TabsTrigger>
        </TabsList>

        {/* Tab: Todos */}
        <TabsContent value="all" className="space-y-4">
          <Card>
            <CardHeader>
              <div className="flex justify-between items-center">
                <div>
                  <CardTitle>AprovaÃ§Ãµes de BÃ´nus</CardTitle>
                  <CardDescription>
                    Lista completa de colaboradores elegÃ­veis para bÃ´nus
                  </CardDescription>
                </div>
                <div className="w-64">
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                    <Input
                      placeholder="Buscar colaborador..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="pl-10"
                    />
                  </div>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              {filteredApprovals.length === 0 ? (
                <div className="text-center py-12">
                  <DollarSign className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <h3 className="text-lg font-semibold text-gray-900 mb-2">
                    Nenhuma aprovaÃ§Ã£o encontrada
                  </h3>
                  <p className="text-gray-600">
                    Selecione um ciclo para visualizar as aprovaÃ§Ãµes de bÃ´nus
                  </p>
                </div>
              ) : (
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Colaborador</TableHead>
                      <TableHead className="text-right">BÃ´nus ElegÃ­vel</TableHead>
                      <TableHead className="text-right">BÃ´nus Final</TableHead>
                      <TableHead className="text-center">Status</TableHead>
                      <TableHead className="text-right">AÃ§Ãµes</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredApprovals.map((approval: any) => (
                      <TableRow key={approval.id}>
                        <TableCell className="font-medium">
                          {approval.employeeName || "N/A"}
                        </TableCell>
                        <TableCell className="text-right">
                          R$ {parseFloat(approval.eligibleAmount).toFixed(2)}
                        </TableCell>
                        <TableCell className="text-right">
                          R$ {parseFloat(approval.finalAmount).toFixed(2)}
                        </TableCell>
                        <TableCell className="text-center">
                          {approval.status === "pending" && (
                            <Badge className="bg-yellow-500">
                              <Clock className="w-3 h-3 mr-1" />
                              Pendente
                            </Badge>
                          )}
                          {approval.status === "approved" && (
                            <Badge className="bg-green-500">
                              <CheckCircle2 className="w-3 h-3 mr-1" />
                              Aprovado
                            </Badge>
                          )}
                          {approval.status === "rejected" && (
                            <Badge variant="destructive">
                              <XCircle className="w-3 h-3 mr-1" />
                              Rejeitado
                            </Badge>
                          )}
                        </TableCell>
                        <TableCell className="text-right">
                          {approval.status === "pending" && (
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => openApprovalDialog(approval)}
                            >
                              <FileText className="w-4 h-4 mr-2" />
                              Iniciar AprovaÃ§Ã£o
                            </Button>
                          )}
                          {approval.status === "approved" && (
                            <Button size="sm" variant="outline" disabled>
                              <CheckCircle2 className="w-4 h-4 mr-2" />
                              ConcluÃ­do
                            </Button>
                          )}
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* Tab: Pendentes */}
        <TabsContent value="pending">
          <Card>
            <CardHeader>
              <CardTitle>AprovaÃ§Ãµes Pendentes</CardTitle>
              <CardDescription>
                {dashboard?.pendingCount || 0} aprovaÃ§Ãµes aguardando processamento
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Colaborador</TableHead>
                    <TableHead className="text-right">BÃ´nus ElegÃ­vel</TableHead>
                    <TableHead className="text-right">BÃ´nus Final</TableHead>
                    <TableHead className="text-center">NÃ­vel Atual</TableHead>
                    <TableHead className="text-right">AÃ§Ãµes</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredApprovals
                    .filter((a: any) => a.status === "pending")
                    .map((approval: any) => (
                      <TableRow key={approval.id}>
                        <TableCell className="font-medium">
                          {approval.employeeName || "N/A"}
                        </TableCell>
                        <TableCell className="text-right">
                          R$ {parseFloat(approval.eligibleAmount).toFixed(2)}
                        </TableCell>
                        <TableCell className="text-right">
                          R$ {parseFloat(approval.finalAmount).toFixed(2)}
                        </TableCell>
                        <TableCell className="text-center">
                          <Badge variant="outline">NÃ­vel {approval.currentLevel}</Badge>
                        </TableCell>
                        <TableCell className="text-right">
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => openApprovalDialog(approval)}
                          >
                            Processar
                          </Button>
                        </TableCell>
                      </TableRow>
                    ))}
                </TableBody>
              </Table>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Tab: Minhas AprovaÃ§Ãµes */}
        <TabsContent value="my-approvals">
          <Card>
            <CardHeader>
              <CardTitle>Minhas AprovaÃ§Ãµes Pendentes</CardTitle>
              <CardDescription>
                {pendingApprovals.length} aprovaÃ§Ãµes aguardando sua anÃ¡lise
              </CardDescription>
            </CardHeader>
            <CardContent>
              {pendingApprovals.length === 0 ? (
                <div className="text-center py-12">
                  <CheckCircle2 className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <h3 className="text-lg font-semibold text-gray-900 mb-2">
                    Nenhuma aprovaÃ§Ã£o pendente
                  </h3>
                  <p className="text-gray-600">
                    VocÃª nÃ£o possui aprovaÃ§Ãµes pendentes no momento
                  </p>
                </div>
              ) : (
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Colaborador</TableHead>
                      <TableHead>Ciclo</TableHead>
                      <TableHead className="text-right">Valor Final</TableHead>
                      <TableHead className="text-center">NÃ­vel</TableHead>
                      <TableHead className="text-right">AÃ§Ãµes</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {pendingApprovals.map((approval: any) => (
                      <TableRow key={approval.id}>
                        <TableCell className="font-medium">
                          {approval.employeeName || "N/A"}
                        </TableCell>
                        <TableCell>{approval.cycleName || "N/A"}</TableCell>
                        <TableCell className="text-right">
                          R$ {parseFloat(approval.finalAmount).toFixed(2)}
                        </TableCell>
                        <TableCell className="text-center">
                          <Badge variant="outline">NÃ­vel {approval.currentLevel}</Badge>
                        </TableCell>
                        <TableCell className="text-right">
                          <div className="flex justify-end gap-2">
                            <Button
                              size="sm"
                              className="bg-green-600 hover:bg-green-700"
                              onClick={() => handleApprove(approval.id, approval.currentLevel)}
                              disabled={approveMutation.isPending}
                            >
                              <CheckCircle2 className="w-4 h-4 mr-1" />
                              Aprovar
                            </Button>
                            <Button
                              size="sm"
                              variant="destructive"
                              onClick={() => handleReject(approval.id, approval.currentLevel)}
                              disabled={approveMutation.isPending}
                            >
                              <XCircle className="w-4 h-4 mr-1" />
                              Rejeitar
                            </Button>
                          </div>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Dialog de IniciaÃ§Ã£o de AprovaÃ§Ã£o */}
      <Dialog open={approvalDialogOpen} onOpenChange={setApprovalDialogOpen}>
        <DialogContent className="sm:max-w-[500px]">
          <DialogHeader>
            <DialogTitle>Iniciar Processo de AprovaÃ§Ã£o</DialogTitle>
            <DialogDescription>
              Configure o bÃ´nus extra e selecione o workflow de aprovaÃ§Ã£o
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>Colaborador</Label>
              <Input value={selectedEmployee?.employeeName || ""} disabled />
            </div>

            <div className="space-y-2">
              <Label>BÃ´nus ElegÃ­vel</Label>
              <Input
                value={`R$ ${parseFloat(selectedEmployee?.eligibleAmount || "0").toFixed(2)}`}
                disabled
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="extra-bonus">BÃ´nus Extra (%)</Label>
              <Input
                id="extra-bonus"
                type="number"
                min="0"
                max="100"
                value={extraBonusPercentage}
                onChange={(e) => setExtraBonusPercentage(e.target.value)}
                placeholder="Ex: 10 (10% adicional)"
              />
              <p className="text-xs text-gray-500">
                Percentual adicional sobre o valor elegÃ­vel
              </p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="workflow">Workflow de AprovaÃ§Ã£o</Label>
              <Select value={selectedWorkflowId} onValueChange={setSelectedWorkflowId}>
                <SelectTrigger>
                  <SelectValue placeholder="Selecione um workflow" />
                </SelectTrigger>
                <SelectContent>
                  {workflows
                    .filter((w: any) => w.isActive)
                    .map((workflow: any) => (
                      <SelectItem key={workflow.id} value={workflow.id.toString()}>
                        {workflow.name}
                      </SelectItem>
                    ))}
                </SelectContent>
              </Select>
            </div>

            {/* CÃ¡lculo Final */}
            {selectedEmployee && extraBonusPercentage && (
              <Card className="bg-blue-50 border-blue-200">
                <CardContent className="pt-4">
                  <p className="text-sm font-semibold text-blue-900 mb-2">CÃ¡lculo Final:</p>
                  <p className="text-xs text-blue-700">
                    BÃ´nus ElegÃ­vel: R${" "}
                    {parseFloat(selectedEmployee.eligibleAmount || "0").toFixed(2)}
                    <br />
                    BÃ´nus Extra ({extraBonusPercentage}%): R${" "}
                    {(
                      parseFloat(selectedEmployee.eligibleAmount || "0") *
                      (parseFloat(extraBonusPercentage) / 100)
                    ).toFixed(2)}
                    <br />
                    <strong>
                      Total: R${" "}
                      {(
                        parseFloat(selectedEmployee.eligibleAmount || "0") +
                        parseFloat(selectedEmployee.eligibleAmount || "0") *
                          (parseFloat(extraBonusPercentage) / 100)
                      ).toFixed(2)}
                    </strong>
                  </p>
                </CardContent>
              </Card>
            )}
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setApprovalDialogOpen(false)}>
              Cancelar
            </Button>
            <Button
              onClick={handleInitiateApproval}
              disabled={initiateMutation.isPending}
              className="bg-[#F39200] hover:bg-[#d67e00]"
            >
              {initiateMutation.isPending ? "Iniciando..." : "Iniciar AprovaÃ§Ã£o"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/DashboardComparativoTestes.tsx
========================================
import { useState } from "react";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Loader2, TrendingUp, Users, Building2, Briefcase } from "lucide-react";
import { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer, Legend, Tooltip } from "recharts";

/**
 * Dashboard Comparativo de Testes PsicomÃ©tricos
 * Visualiza resultados agregados por departamento, cargo ou equipe
 */

const TEST_OPTIONS = [
  { value: "disc", label: "DISC - Comportamental" },
  { value: "bigfive", label: "Big Five - Personalidade" },
  { value: "mbti", label: "MBTI - Tipo de Personalidade" },
  { value: "ie", label: "InteligÃªncia Emocional" },
  { value: "vark", label: "Estilos de Aprendizagem" },
  { value: "leadership", label: "Estilos de LideranÃ§a" },
  { value: "careeranchors", label: "Ã‚ncoras de Carreira" },
];

const GROUP_OPTIONS = [
  { value: "department", label: "Departamento", icon: Building2 },
  { value: "position", label: "Cargo", icon: Briefcase },
  { value: "team", label: "Equipe (Gestor)", icon: Users },
];

export default function DashboardComparativoTestes() {
  const { user } = useAuth();
  const [groupBy, setGroupBy] = useState<"department" | "position" | "team">("department");
  const [testType, setTestType] = useState<string>("disc");

  // Buscar resultados agregados
  const { data: aggregatedData, isLoading } = trpc.psychometric.getAggregatedResults.useQuery({
    groupBy,
    testType: testType as any,
  });

  // Preparar dados para grÃ¡fico radar DISC
  const prepareDiscRadarData = (group: any) => {
    if (!group.averages?.disc) return [];
    return [
      { dimension: "DominÃ¢ncia", value: group.averages.disc.D },
      { dimension: "InfluÃªncia", value: group.averages.disc.I },
      { dimension: "Estabilidade", value: group.averages.disc.S },
      { dimension: "Conformidade", value: group.averages.disc.C },
    ];
  };

  // Preparar dados para grÃ¡fico radar Big Five
  const prepareBigFiveRadarData = (group: any) => {
    if (!group.averages?.bigfive) return [];
    return [
      { dimension: "Abertura", value: group.averages.bigfive.O * 100 },
      { dimension: "Conscienciosidade", value: group.averages.bigfive.C * 100 },
      { dimension: "ExtroversÃ£o", value: group.averages.bigfive.E * 100 },
      { dimension: "Amabilidade", value: group.averages.bigfive.A * 100 },
      { dimension: "Neuroticismo", value: group.averages.bigfive.N * 100 },
    ];
  };

  if (user?.role !== 'admin') {
    return (
      <DashboardLayout>
        <Card>
          <CardHeader>
            <CardTitle>Acesso Negado</CardTitle>
            <CardDescription>Apenas administradores podem acessar este dashboard</CardDescription>
          </CardHeader>
        </Card>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
            <TrendingUp className="h-8 w-8" />
            Dashboard Comparativo de Testes
          </h1>
          <p className="text-muted-foreground mt-2">
            AnÃ¡lise comparativa de perfis psicomÃ©tricos por grupo
          </p>
        </div>

        {/* Filtros */}
        <Card className="border-orange-200 bg-gradient-to-r from-orange-50 to-yellow-50">
          <CardHeader>
            <CardTitle>Filtros de AnÃ¡lise</CardTitle>
          </CardHeader>
          <CardContent className="grid md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <label className="text-sm font-medium">Agrupar Por</label>
              <Select value={groupBy} onValueChange={(value: any) => setGroupBy(value)}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {GROUP_OPTIONS.map(option => {
                    const Icon = option.icon;
                    return (
                      <SelectItem key={option.value} value={option.value}>
                        <div className="flex items-center gap-2">
                          <Icon className="h-4 w-4" />
                          {option.label}
                        </div>
                      </SelectItem>
                    );
                  })}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Tipo de Teste</label>
              <Select value={testType} onValueChange={setTestType}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {TEST_OPTIONS.map(option => (
                    <SelectItem key={option.value} value={option.value}>
                      {option.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </CardContent>
        </Card>

        {/* Resultados */}
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="w-8 h-8 animate-spin text-primary" />
          </div>
        ) : !aggregatedData || aggregatedData.length === 0 ? (
          <Card>
            <CardContent className="py-12 text-center">
              <p className="text-muted-foreground">
                Nenhum resultado encontrado para os filtros selecionados
              </p>
            </CardContent>
          </Card>
        ) : (
          <div className="grid md:grid-cols-2 gap-6">
            {aggregatedData.map((group: any) => {
              const radarData = testType === "disc" 
                ? prepareDiscRadarData(group)
                : testType === "bigfive"
                ? prepareBigFiveRadarData(group)
                : [];

              return (
                <Card key={group.groupKey} className="border-2">
                  <CardHeader>
                    <div className="flex items-center justify-between">
                      <CardTitle className="text-lg">{group.groupName}</CardTitle>
                      <Badge variant="secondary">
                        {group.count} teste{group.count !== 1 ? 's' : ''}
                      </Badge>
                    </div>
                    <CardDescription>
                      Perfil mÃ©dio do grupo
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    {radarData.length > 0 ? (
                      <ResponsiveContainer width="100%" height={300}>
                        <RadarChart data={radarData}>
                          <PolarGrid stroke="#e5e7eb" />
                          <PolarAngleAxis 
                            dataKey="dimension" 
                            tick={{ fill: '#6b7280', fontSize: 12 }}
                          />
                          <PolarRadiusAxis 
                            angle={90} 
                            domain={[0, 100]}
                            tick={{ fill: '#6b7280', fontSize: 10 }}
                          />
                          <Radar
                            name={group.groupName}
                            dataKey="value"
                            stroke="#F39200"
                            fill="#F39200"
                            fillOpacity={0.6}
                          />
                          <Tooltip 
                            contentStyle={{ 
                              backgroundColor: 'white', 
                              border: '1px solid #e5e7eb',
                              borderRadius: '8px'
                            }}
                            formatter={(value: any) => [value.toFixed(1), 'PontuaÃ§Ã£o']}
                          />
                        </RadarChart>
                      </ResponsiveContainer>
                    ) : (
                      <div className="py-12 text-center text-muted-foreground">
                        GrÃ¡fico nÃ£o disponÃ­vel para este tipo de teste
                      </div>
                    )}

                    {/* Detalhes numÃ©ricos */}
                    {testType === "disc" && group.averages?.disc && (
                      <div className="mt-4 grid grid-cols-2 gap-3">
                        <div className="bg-red-50 p-3 rounded-lg border border-red-200">
                          <div className="text-xs text-red-600 font-medium">DominÃ¢ncia</div>
                          <div className="text-2xl font-bold text-red-700">
                            {group.averages.disc.D.toFixed(1)}
                          </div>
                        </div>
                        <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                          <div className="text-xs text-yellow-600 font-medium">InfluÃªncia</div>
                          <div className="text-2xl font-bold text-yellow-700">
                            {group.averages.disc.I.toFixed(1)}
                          </div>
                        </div>
                        <div className="bg-green-50 p-3 rounded-lg border border-green-200">
                          <div className="text-xs text-green-600 font-medium">Estabilidade</div>
                          <div className="text-2xl font-bold text-green-700">
                            {group.averages.disc.S.toFixed(1)}
                          </div>
                        </div>
                        <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                          <div className="text-xs text-blue-600 font-medium">Conformidade</div>
                          <div className="text-2xl font-bold text-blue-700">
                            {group.averages.disc.C.toFixed(1)}
                          </div>
                        </div>
                      </div>
                    )}

                    {testType === "bigfive" && group.averages?.bigfive && (
                      <div className="mt-4 space-y-2">
                        {[
                          { key: 'O', label: 'Abertura', color: 'purple' },
                          { key: 'C', label: 'Conscienciosidade', color: 'blue' },
                          { key: 'E', label: 'ExtroversÃ£o', color: 'orange' },
                          { key: 'A', label: 'Amabilidade', color: 'green' },
                          { key: 'N', label: 'Neuroticismo', color: 'red' },
                        ].map(({ key, label, color }) => (
                          <div key={key} className="flex items-center justify-between text-sm">
                            <span className="font-medium">{label}</span>
                            <span className={`text-${color}-600 font-bold`}>
                              {(group.averages.bigfive[key] * 100).toFixed(1)}%
                            </span>
                          </div>
                        ))}
                      </div>
                    )}
                  </CardContent>
                </Card>
              );
            })}
          </div>
        )}

        {/* Insights */}
        {aggregatedData && aggregatedData.length > 0 && (
          <Card className="border-blue-200 bg-gradient-to-r from-blue-50 to-cyan-50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                ðŸ’¡ Insights AutomÃ¡ticos
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <p className="text-sm">
                <strong>Total de grupos analisados:</strong> {aggregatedData.length}
              </p>
              <p className="text-sm">
                <strong>Total de testes:</strong>{' '}
                {aggregatedData.reduce((sum: number, g: any) => sum + g.count, 0)}
              </p>
              {testType === "disc" && aggregatedData.some((g: any) => g.averages?.disc) && (
                <div className="pt-2 border-t">
                  <p className="text-sm font-medium mb-2">Perfil DISC predominante por grupo:</p>
                  <div className="space-y-1">
                    {aggregatedData.map((group: any) => {
                      if (!group.averages?.disc) return null;
                      const disc = group.averages.disc;
                      const max = Math.max(disc.D, disc.I, disc.S, disc.C);
                      const dominant = 
                        max === disc.D ? "DominÃ¢ncia" :
                        max === disc.I ? "InfluÃªncia" :
                        max === disc.S ? "Estabilidade" : "Conformidade";
                      return (
                        <p key={group.groupKey} className="text-sm">
                          â€¢ <strong>{group.groupName}:</strong> {dominant}
                        </p>
                      );
                    })}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/DashboardEmails.tsx
========================================
import { useState } from "react";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { toast } from "sonner";
import { Mail, Search, RefreshCw, CheckCircle2, XCircle, Clock, TrendingUp, TrendingDown } from "lucide-react";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

export default function DashboardEmails() {
  const { user, loading: authLoading } = useAuth();
  const [searchTerm, setSearchTerm] = useState("");
  const [statusFilter, setStatusFilter] = useState<string>("all");
  const [typeFilter, setTypeFilter] = useState<string>("all");

  // Queries
  const { data: emailMetrics, isLoading, refetch } = trpc.emails.getMetrics.useQuery();
  const { data: emailHistory } = trpc.emails.getHistory.useQuery();

  // Mutations
  const resendEmailMutation = trpc.emails.resend.useMutation({
    onSuccess: () => {
      toast.success("Email reenviado com sucesso!");
      refetch();
    },
    onError: (error: any) => {
      toast.error(`Erro ao reenviar: ${error.message}`);
    },
  });

  const handleResend = (emailId: number) => {
    if (confirm("Deseja realmente reenviar este email?")) {
      resendEmailMutation.mutate({ emailId });
    }
  };

  if (authLoading || !user) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-64">
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mx-auto"></div>
            <p className="mt-4 text-gray-600">Carregando...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  if (user.role !== "admin" && user.role !== "rh") {
    return (
      <DashboardLayout>
        <div className="text-center py-12">
          <h2 className="text-2xl font-bold text-gray-900">Acesso Negado</h2>
          <p className="mt-2 text-gray-600">Apenas administradores e RH podem acessar esta pÃ¡gina.</p>
        </div>
      </DashboardLayout>
    );
  }

  const filteredHistory = emailHistory?.filter((email: any) => {
    const matchesSearch = email.recipient.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         email.subject?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesStatus = statusFilter === "all" || email.status === statusFilter;
    const matchesType = typeFilter === "all" || email.emailType === typeFilter;
    return matchesSearch && matchesStatus && matchesType;
  }) || [];

  const totalEmails = emailMetrics?.total || 0;
  const successRate = totalEmails > 0 ? ((emailMetrics?.sent || 0) / totalEmails * 100).toFixed(1) : "0.0";
  const failureRate = totalEmails > 0 ? ((emailMetrics?.failed || 0) / totalEmails * 100).toFixed(1) : "0.0";

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">Dashboard de Emails</h1>
            <p className="mt-2 text-gray-600">
              Monitore e gerencie todos os emails enviados pelo sistema
            </p>
          </div>
          <Button onClick={() => refetch()} variant="outline" size="sm">
            <RefreshCw className="h-4 w-4 mr-2" />
            Atualizar
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Total de Emails</CardTitle>
              <Mail className="h-4 w-4 text-gray-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{totalEmails}</div>
              <p className="text-xs text-gray-600 mt-1">Enviados pelo sistema</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Emails Enviados</CardTitle>
              <CheckCircle2 className="h-4 w-4 text-green-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-green-600">{emailMetrics?.sent || 0}</div>
              <div className="flex items-center gap-1 text-xs text-gray-600 mt-1">
                <TrendingUp className="h-3 w-3 text-green-600" />
                <span>{successRate}% de sucesso</span>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Emails Falhados</CardTitle>
              <XCircle className="h-4 w-4 text-red-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-red-600">{emailMetrics?.failed || 0}</div>
              <div className="flex items-center gap-1 text-xs text-gray-600 mt-1">
                <TrendingDown className="h-3 w-3 text-red-600" />
                <span>{failureRate}% de falha</span>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Emails Pendentes</CardTitle>
              <Clock className="h-4 w-4 text-orange-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-orange-600">{emailMetrics?.pending || 0}</div>
              <p className="text-xs text-gray-600 mt-1">Aguardando envio</p>
            </CardContent>
          </Card>
        </div>

        {/* Filtros */}
        <Card>
          <CardHeader>
            <CardTitle>Filtros</CardTitle>
            <CardDescription>Refine a visualizaÃ§Ã£o do histÃ³rico de emails</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                <Input
                  placeholder="Buscar por destinatÃ¡rio ou assunto..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10"
                />
              </div>

              <Select value={statusFilter} onValueChange={setStatusFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Filtrar por status" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os status</SelectItem>
                  <SelectItem value="sent">Enviados</SelectItem>
                  <SelectItem value="failed">Falhados</SelectItem>
                  <SelectItem value="pending">Pendentes</SelectItem>
                </SelectContent>
              </Select>

              <Select value={typeFilter} onValueChange={setTypeFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Filtrar por tipo" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os tipos</SelectItem>
                  <SelectItem value="goal_notification">NotificaÃ§Ã£o de Meta</SelectItem>
                  <SelectItem value="evaluation_notification">NotificaÃ§Ã£o de AvaliaÃ§Ã£o</SelectItem>
                  <SelectItem value="test_invite">Convite para Teste</SelectItem>
                  <SelectItem value="pdi_notification">NotificaÃ§Ã£o de PDI</SelectItem>
                  <SelectItem value="system">Sistema</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </CardContent>
        </Card>

        {/* HistÃ³rico de Emails */}
        <Card>
          <CardHeader>
            <CardTitle>HistÃ³rico de Emails</CardTitle>
            <CardDescription>
              {filteredHistory.length} email(s) encontrado(s)
            </CardDescription>
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <div className="text-center py-8">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mx-auto"></div>
                <p className="mt-4 text-gray-600">Carregando histÃ³rico...</p>
              </div>
            ) : filteredHistory.length > 0 ? (
              <div className="overflow-x-auto">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Data/Hora</TableHead>
                      <TableHead>DestinatÃ¡rio</TableHead>
                      <TableHead>Assunto</TableHead>
                      <TableHead>Tipo</TableHead>
                      <TableHead>Status</TableHead>
                      <TableHead className="text-right">AÃ§Ãµes</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredHistory.map((email: any) => (
                      <TableRow key={email.id}>
                        <TableCell className="font-mono text-sm">
                          {format(new Date(email.sentAt || email.createdAt), "dd/MM/yyyy HH:mm", { locale: ptBR })}
                        </TableCell>
                        <TableCell>{email.recipient}</TableCell>
                        <TableCell className="max-w-xs truncate">{email.subject || "-"}</TableCell>
                        <TableCell>
                          <Badge variant="outline" className="text-xs">
                            {email.emailType === "goal_notification" && "Meta"}
                            {email.emailType === "evaluation_notification" && "AvaliaÃ§Ã£o"}
                            {email.emailType === "test_invite" && "Teste"}
                            {email.emailType === "pdi_notification" && "PDI"}
                            {email.emailType === "system" && "Sistema"}
                          </Badge>
                        </TableCell>
                        <TableCell>
                          {email.status === "sent" && (
                            <Badge className="bg-green-100 text-green-800 hover:bg-green-100">
                              <CheckCircle2 className="h-3 w-3 mr-1" />
                              Enviado
                            </Badge>
                          )}
                          {email.status === "failed" && (
                            <Badge className="bg-red-100 text-red-800 hover:bg-red-100">
                              <XCircle className="h-3 w-3 mr-1" />
                              Falhou
                            </Badge>
                          )}
                          {email.status === "pending" && (
                            <Badge className="bg-orange-100 text-orange-800 hover:bg-orange-100">
                              <Clock className="h-3 w-3 mr-1" />
                              Pendente
                            </Badge>
                          )}
                        </TableCell>
                        <TableCell className="text-right">
                          {email.status === "failed" && (
                            <Button
                              size="sm"
                              variant="ghost"
                              onClick={() => handleResend(email.id)}
                              disabled={resendEmailMutation.isPending}
                            >
                              <RefreshCw className="h-4 w-4" />
                            </Button>
                          )}
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                Nenhum email encontrado com os filtros aplicados
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/DashboardExecutivo.tsx
========================================
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";
import { 
  BarChart3, 
  TrendingUp, 
  Users, 
  Activity, 
  AlertTriangle, 
  Download,
  ArrowLeft,
  Trophy,
  Target
} from "lucide-react";
import { Link } from "wouter";
import { exportDashboardExecutivo } from "@/lib/exportPDF";
import { toast } from "sonner";
import {
  BarChart,
  Bar,
  LineChart,
  Line,
  PieChart,
  Pie,
  Cell,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from "recharts";
import { useState } from "react";

/**
 * Dashboard Executivo - VisÃ£o consolidada de performance e talentos
 * Baseado nas telas de referÃªncia UISA
 */
export default function DashboardExecutivo() {
  const [selectedDepartment, setSelectedDepartment] = useState<string>("todos");

  // Queries
  const { data: kpis, isLoading: kpisLoading } = trpc.executive.getKPIs.useQuery({});
  const { data: performanceByDept, isLoading: perfDeptLoading } =
    trpc.executive.getPerformanceByDepartment.useQuery({});
  const { data: performanceTrend, isLoading: perfTrendLoading } =
    trpc.executive.getPerformanceTrend.useQuery();
  const { data: successionCoverage, isLoading: successionLoading } =
    trpc.executive.getSuccessionCoverage.useQuery();
  const { data: topPerformers, isLoading: topPerfLoading } =
    trpc.executive.getTopPerformers.useQuery({ limit: 10 });
  const { data: flightRisk, isLoading: flightRiskLoading } =
    trpc.executive.getFlightRisk.useQuery({ riskLevel: "alto", limit: 10 });
  const { data: nineBoxData, isLoading: nineBoxLoading } =
    trpc.executive.getPerformanceDistribution.useQuery({});

  // Calcular engajamento mÃ©dio (simulado)
  const engajamento = 8.2;

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <div className="border-b bg-card">
        <div className="container py-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Link href="/">
                <Button variant="ghost" size="icon">
                  <ArrowLeft className="h-5 w-5" />
                </Button>
              </Link>
              <div>
                <div className="flex items-center gap-2">
                  <BarChart3 className="h-6 w-6 text-primary" />
                  <h1 className="text-2xl font-bold">Dashboard Executivo</h1>
                </div>
                <p className="text-sm text-muted-foreground">
                  VisÃ£o consolidada de performance e talentos - UISA
                </p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <Select value={selectedDepartment} onValueChange={setSelectedDepartment}>
                <SelectTrigger className="w-[200px]">
                  <SelectValue placeholder="Filtrar departamento" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos os Departamentos</SelectItem>
                  <SelectItem value="comercial">Comercial</SelectItem>
                  <SelectItem value="ti">TI</SelectItem>
                  <SelectItem value="financeiro">Financeiro</SelectItem>
                  <SelectItem value="rh">RH</SelectItem>
                  <SelectItem value="operacoes">OperaÃ§Ãµes</SelectItem>
                </SelectContent>
              </Select>
              <Button
                onClick={async () => {
                  try {
                    toast.info("Gerando PDF...");
                    await exportDashboardExecutivo();
                    toast.success("PDF exportado com sucesso!");
                  } catch (error) {
                    toast.error("Erro ao exportar PDF");
                  }
                }}
              >
                <Download className="h-4 w-4 mr-2" />
                Exportar PDF
              </Button>
            </div>
          </div>
        </div>
      </div>

      <div className="container py-8 space-y-6" id="dashboard-executivo-content">
        {/* KPIs Principais */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          {/* Headcount */}
          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Headcount
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                  <Users className="h-5 w-5 text-blue-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              {kpisLoading ? (
                <Skeleton className="h-10 w-20" />
              ) : (
                <>
                  <div className="text-3xl font-bold">{kpis?.totalEmployees || 0}</div>
                  <p className="text-xs text-green-600 mt-1">
                    â†‘ +5 vs. mÃªs anterior
                  </p>
                </>
              )}
            </CardContent>
          </Card>

          {/* Performance */}
          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Performance
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                  <Activity className="h-5 w-5 text-green-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              {kpisLoading ? (
                <Skeleton className="h-10 w-20" />
              ) : (
                <>
                  <div className="text-3xl font-bold">
                    {kpis?.avgPerformanceScore ? `${(kpis.avgPerformanceScore * 20).toFixed(0)}%` : "0%"}
                  </div>
                  <p className="text-xs text-green-600 mt-1">
                    â†‘ +3% vs. ciclo anterior
                  </p>
                </>
              )}
            </CardContent>
          </Card>

          {/* Engajamento */}
          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Engajamento
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                  <Target className="h-5 w-5 text-purple-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{engajamento}</div>
              <p className="text-xs text-muted-foreground mt-1">â€” 0 estÃ¡vel</p>
            </CardContent>
          </Card>

          {/* Flight Risk */}
          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Flight Risk
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-red-100 flex items-center justify-center">
                  <AlertTriangle className="h-5 w-5 text-red-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              {flightRiskLoading ? (
                <Skeleton className="h-10 w-20" />
              ) : (
                <>
                  <div className="text-3xl font-bold">{flightRisk?.length || 12}</div>
                  <p className="text-xs text-red-600 mt-1">
                    â†“ -3 vs. mÃªs anterior
                  </p>
                </>
              )}
            </CardContent>
          </Card>
        </div>

        {/* GrÃ¡ficos Principais */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* DistribuiÃ§Ã£o Nine Box */}
          <Card>
            <CardHeader>
              <div className="flex items-center gap-2">
                <div className="h-8 w-8 rounded bg-blue-100 flex items-center justify-center">
                  <BarChart3 className="h-4 w-4 text-blue-600" />
                </div>
                <CardTitle>DistribuiÃ§Ã£o Nine Box</CardTitle>
              </div>
            </CardHeader>
            <CardContent>
              {nineBoxLoading ? (
                <Skeleton className="h-[300px] w-full" />
              ) : nineBoxData && nineBoxData.length > 0 ? (
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={nineBoxData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="category" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Bar dataKey="count" fill="#3B82F6" name="Colaboradores" />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-[300px] flex items-center justify-center text-muted-foreground">
                  <p>Nenhum dado de Nine Box disponÃ­vel</p>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Performance por Departamento */}
          <Card>
            <CardHeader>
              <div className="flex items-center gap-2">
                <div className="h-8 w-8 rounded bg-green-100 flex items-center justify-center">
                  <BarChart3 className="h-4 w-4 text-green-600" />
                </div>
                <CardTitle>Performance por Departamento</CardTitle>
              </div>
            </CardHeader>
            <CardContent>
              {perfDeptLoading ? (
                <Skeleton className="h-[300px] w-full" />
              ) : (
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={performanceByDept || []}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                    <XAxis dataKey="department" tick={{ fontSize: 12 }} />
                    <YAxis tick={{ fontSize: 12 }} />
                    <Tooltip />
                    <Bar dataKey="avgScore" fill="#3B82F6" radius={[4, 4, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              )}
            </CardContent>
          </Card>

          {/* TendÃªncia de Performance (6 meses) */}
          <Card>
            <CardHeader>
              <div className="flex items-center gap-2">
                <div className="h-8 w-8 rounded bg-purple-100 flex items-center justify-center">
                  <TrendingUp className="h-4 w-4 text-purple-600" />
                </div>
                <CardTitle>TendÃªncia de Performance (6 meses)</CardTitle>
              </div>
            </CardHeader>
            <CardContent>
              {perfTrendLoading ? (
                <Skeleton className="h-[300px] w-full" />
              ) : (
                <ResponsiveContainer width="100%" height={300}>
                  <LineChart data={performanceTrend || []}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                    <XAxis dataKey="month" tick={{ fontSize: 12 }} />
                    <YAxis tick={{ fontSize: 12 }} domain={[0, 100]} />
                    <Tooltip />
                    <Line
                      type="monotone"
                      dataKey="avgPerformance"
                      stroke="#8B5CF6"
                      strokeWidth={3}
                      dot={{ fill: "#8B5CF6", r: 4 }}
                    />
                  </LineChart>
                </ResponsiveContainer>
              )}
            </CardContent>
          </Card>

          {/* Cobertura de SucessÃ£o */}
          <Card>
            <CardHeader>
              <div className="flex items-center gap-2">
                <div className="h-8 w-8 rounded bg-orange-100 flex items-center justify-center">
                  <Users className="h-4 w-4 text-orange-600" />
                </div>
                <CardTitle>Cobertura de SucessÃ£o</CardTitle>
              </div>
            </CardHeader>
            <CardContent>
              {successionLoading ? (
                <Skeleton className="h-[300px] w-full" />
              ) : (
                <div className="flex items-center gap-8">
                  <ResponsiveContainer width="60%" height={300}>
                    <PieChart>
                      <Pie
                        data={successionCoverage || []}
                        cx="50%"
                        cy="50%"
                        innerRadius={60}
                        outerRadius={100}
                        dataKey="value"
                        label
                      >
                        {(successionCoverage || []).map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.color} />
                        ))}
                      </Pie>
                      <Tooltip />
                    </PieChart>
                  </ResponsiveContainer>
                  <div className="flex-1 space-y-3">
                    {(successionCoverage || []).map((item, idx) => (
                      <div key={idx} className="flex items-center gap-2">
                        <div
                          className="h-3 w-3 rounded-full"
                          style={{ backgroundColor: item.color }}
                        />
                        <span className="text-sm">{item.label}</span>
                        <span className="ml-auto font-semibold">{item.value}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        {/* Listas: Top Performers e Flight Risk */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Top 10 Performers */}
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="h-8 w-8 rounded bg-yellow-100 flex items-center justify-center">
                    <Trophy className="h-4 w-4 text-yellow-600" />
                  </div>
                  <CardTitle>Top 10 Performers</CardTitle>
                </div>
                <Link href="/performance">
                  <Button variant="link" size="sm" className="text-primary">
                    Ver todos â†’
                  </Button>
                </Link>
              </div>
            </CardHeader>
            <CardContent>
              {topPerfLoading ? (
                <div className="space-y-3">
                  {[...Array(5)].map((_, i) => (
                    <Skeleton key={i} className="h-16 w-full" />
                  ))}
                </div>
              ) : (
                <div className="space-y-3">
                  {(topPerformers || []).map((performer, idx) => (
                    <div
                      key={performer.id}
                      className="flex items-center gap-3 p-3 rounded-lg border hover:bg-accent transition-colors"
                    >
                      <div className="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold">
                        {performer.name.charAt(0)}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-medium truncate">{performer.name}</p>
                        <p className="text-xs text-muted-foreground truncate">
                          {performer.position} â€¢ {performer.department}
                        </p>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-green-600">{performer.score.toFixed(1)}</p>
                        <p className="text-xs text-muted-foreground">Score</p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Flight Risk (Alto) */}
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="h-8 w-8 rounded bg-red-100 flex items-center justify-center">
                    <AlertTriangle className="h-4 w-4 text-red-600" />
                  </div>
                  <CardTitle>Flight Risk (Alto)</CardTitle>
                </div>
                <Link href="/flight-risk">
                  <Button variant="link" size="sm" className="text-primary">
                    Ver todos â†’
                  </Button>
                </Link>
              </div>
            </CardHeader>
            <CardContent>
              {flightRiskLoading ? (
                <div className="space-y-3">
                  {[...Array(5)].map((_, i) => (
                    <Skeleton key={i} className="h-16 w-full" />
                  ))}
                </div>
              ) : (
                <div className="space-y-3">
                  {(flightRisk || []).slice(0, 10).map((person) => (
                    <div
                      key={person.id}
                      className="flex items-center gap-3 p-3 rounded-lg border hover:bg-accent transition-colors"
                    >
                      <div className="h-10 w-10 rounded-full bg-gradient-to-br from-red-500 to-orange-600 flex items-center justify-center text-white font-semibold">
                        {person.name.charAt(0)}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-medium truncate">{person.name}</p>
                        <p className="text-xs text-muted-foreground truncate">
                          {person.position} â€¢ {person.department}
                        </p>
                      </div>
                      <div className="text-right">
                        <div className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 text-red-700 text-xs font-medium">
                          Alto
                        </div>
                        <p className="text-xs text-muted-foreground mt-1">
                          Risco: {person.riskScore}/10
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        {/* Status de SucessÃ£o - PosiÃ§Ãµes CrÃ­ticas */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div>
                <div className="flex items-center gap-2">
                  <div className="h-8 w-8 rounded bg-blue-100 flex items-center justify-center">
                    <Target className="h-4 w-4 text-blue-600" />
                  </div>
                  <CardTitle>Status de SucessÃ£o - PosiÃ§Ãµes CrÃ­ticas</CardTitle>
                </div>
              </div>
              <Link href="/sucessao">
                <Button variant="link" className="text-primary">
                  Ver mapa completo â†’
                </Button>
              </Link>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="p-6 rounded-lg bg-red-50 border border-red-200">
                <div className="text-4xl font-bold text-red-600">8</div>
                <p className="text-sm text-red-700 mt-1">Sem Cobertura</p>
              </div>
              <div className="p-6 rounded-lg bg-yellow-50 border border-yellow-200">
                <div className="text-4xl font-bold text-yellow-600">15</div>
                <p className="text-sm text-yellow-700 mt-1">Cobertura MÃ­nima</p>
              </div>
              <div className="p-6 rounded-lg bg-green-50 border border-green-200">
                <div className="text-4xl font-bold text-green-600">22</div>
                <p className="text-sm text-green-700 mt-1">Cobertura Adequada</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/DashboardExecutivoConsolidado.tsx
========================================
import { useState } from "react";
import { useLocation } from "wouter";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { 
  Loader2, 
  TrendingUp, 
  TrendingDown,
  Users, 
  Target, 
  Award, 
  CheckCircle2,
  AlertCircle,
  BarChart3,
  PieChart,
  Activity
} from "lucide-react";
import { trpc } from "@/lib/trpc";

/**
 * Dashboard Executivo Consolidado
 * 
 * Agrega KPIs de todos os mÃ³dulos do sistema:
 * - Nine Box (distribuiÃ§Ã£o por quadrante)
 * - PDI (em desenvolvimento, concluÃ­dos)
 * - SucessÃ£o (posiÃ§Ãµes crÃ­ticas, cobertura)
 * - AvaliaÃ§Ã£o 360Â° (em andamento, concluÃ­das)
 * - Metas (atingidas, em risco)
 * - Benchmarking (gaps significativos)
 */

export default function DashboardExecutivoConsolidado() {
  const [, navigate] = useLocation();
  const [selectedDepartment, setSelectedDepartment] = useState<string>("todos");
  const [selectedPeriod, setSelectedPeriod] = useState<string>("2025");

  // Queries para buscar KPIs de cada mÃ³dulo
  // TODO: Implementar endpoints getDistribution e getStats nos routers
  const nineBoxData = { total: 150, altoDesempenho: 45, q1: 5, q2: 10, q3: 15, q4: 12, q5: 25, q6: 18, q7: 8, q8: 12, q9: 45 };
  const pdiData = { total: 78, percentualConclusao: 65 };
  const successionData = { posicoesCriticas: 12, cobertura: 75 };
  const goalsData = { total: 120, avgAlignmentGeral: 82 };
  const isLoading = false;

  // Dados simulados para demonstraÃ§Ã£o (substituir por dados reais)
  const evaluation360Stats = {
    total: 45,
    emAndamento: 18,
    concluidas: 27,
    percentualConclusao: 60,
  };

  const benchmarkingStats = {
    gapsSignificativos: 5,
    dimensoesAnalisadas: 9,
    percentualAcimaMercado: 55,
  };

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6 max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">Dashboard Executivo Consolidado</h1>
            <p className="text-sm text-muted-foreground">
              VisÃ£o estratÃ©gica consolidada de todos os mÃ³dulos de gestÃ£o de talentos
            </p>
          </div>
          <div className="flex gap-2">
            <Select value={selectedPeriod} onValueChange={setSelectedPeriod}>
              <SelectTrigger className="w-32">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="2024">2024</SelectItem>
                <SelectItem value="2025">2025</SelectItem>
                <SelectItem value="2026">2026</SelectItem>
              </SelectContent>
            </Select>
            <Select value={selectedDepartment} onValueChange={setSelectedDepartment}>
              <SelectTrigger className="w-48">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="todos">Todos os Departamentos</SelectItem>
                <SelectItem value="ti">TI</SelectItem>
                <SelectItem value="rh">RH</SelectItem>
                <SelectItem value="financeiro">Financeiro</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* KPIs Principais */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate("/nine-box")}>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-gray-600">Nine Box</CardTitle>
                <PieChart className="h-5 w-5 text-blue-600" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{nineBoxData?.total || 0}</div>
              <p className="text-xs text-gray-500 mt-1">Colaboradores mapeados</p>
              <div className="mt-3 flex items-center gap-2">
                <Badge variant="secondary" className="text-xs">
                  {nineBoxData?.altoDesempenho || 0} Alto Desempenho
                </Badge>
              </div>
            </CardContent>
          </Card>

          <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate("/pdi-inteligente")}>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-gray-600">PDI Ativos</CardTitle>
                <Target className="h-5 w-5 text-green-600" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{pdiData?.total || 0}</div>
              <p className="text-xs text-gray-500 mt-1">Planos em desenvolvimento</p>
              <div className="mt-3 flex items-center gap-2">
                <TrendingUp className="h-4 w-4 text-green-600" />
                <span className="text-sm font-medium text-green-600">
                  {pdiData?.percentualConclusao || 0}% concluÃ­dos
                </span>
              </div>
            </CardContent>
          </Card>

          <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate("/mapa-sucessao-completo")}>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-gray-600">SucessÃ£o</CardTitle>
                <Users className="h-5 w-5 text-purple-600" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{successionData?.posicoesCriticas || 0}</div>
              <p className="text-xs text-gray-500 mt-1">PosiÃ§Ãµes crÃ­ticas</p>
              <div className="mt-3 flex items-center gap-2">
                {(successionData?.cobertura || 0) >= 70 ? (
                  <CheckCircle2 className="h-4 w-4 text-green-600" />
                ) : (
                  <AlertCircle className="h-4 w-4 text-red-600" />
                )}
                <span className={`text-sm font-medium ${(successionData?.cobertura || 0) >= 70 ? "text-green-600" : "text-red-600"}`}>
                  {successionData?.cobertura || 0}% cobertura
                </span>
              </div>
            </CardContent>
          </Card>

          <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate("/metas-cascata")}>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-gray-600">Metas em Cascata</CardTitle>
                <Activity className="h-5 w-5 text-orange-600" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{goalsData?.total || 0}</div>
              <p className="text-xs text-gray-500 mt-1">Metas ativas</p>
              <div className="mt-3 flex items-center gap-2">
                <TrendingUp className="h-4 w-4 text-orange-600" />
                <span className="text-sm font-medium text-orange-600">
                  {goalsData?.avgAlignmentGeral || 0}% alinhamento
                </span>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* SeÃ§Ã£o de AvaliaÃ§Ã£o 360Â° e Benchmarking */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate("/avaliacoes")}>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Award className="h-5 w-5 text-blue-600" />
                AvaliaÃ§Ã£o 360Â°
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">Total de AvaliaÃ§Ãµes</span>
                  <span className="text-2xl font-bold">{evaluation360Stats.total}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">Em Andamento</span>
                  <Badge variant="secondary">{evaluation360Stats.emAndamento}</Badge>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">ConcluÃ­das</span>
                  <Badge className="bg-green-100 text-green-800">{evaluation360Stats.concluidas}</Badge>
                </div>
                <div className="pt-2 border-t">
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-600">Percentual de ConclusÃ£o</span>
                    <span className="font-semibold text-green-600">{evaluation360Stats.percentualConclusao}%</span>
                  </div>
                  <div className="mt-2 w-full bg-gray-200 rounded-full h-2">
                    <div
                      className="bg-green-500 h-2 rounded-full transition-all"
                      style={{ width: `${evaluation360Stats.percentualConclusao}%` }}
                    />
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => navigate("/benchmarking")}>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <BarChart3 className="h-5 w-5 text-purple-600" />
                Benchmarking de Mercado
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">DimensÃµes Analisadas</span>
                  <span className="text-2xl font-bold">{benchmarkingStats.dimensoesAnalisadas}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">Gaps Significativos</span>
                  <Badge variant="destructive">{benchmarkingStats.gapsSignificativos}</Badge>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">Acima do Mercado</span>
                  <Badge className="bg-green-100 text-green-800">{benchmarkingStats.percentualAcimaMercado}%</Badge>
                </div>
                <div className="pt-2 border-t">
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-600">PosiÃ§Ã£o Competitiva</span>
                    <span className="font-semibold text-green-600">
                      {benchmarkingStats.percentualAcimaMercado >= 60 ? "Forte" : benchmarkingStats.percentualAcimaMercado >= 40 ? "Moderada" : "Fraca"}
                    </span>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* DistribuiÃ§Ã£o Nine Box */}
        <Card>
          <CardHeader>
            <CardTitle>DistribuiÃ§Ã£o Nine Box - Talentos por Quadrante</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-3 gap-4">
              {/* Linha 3 (Alto Potencial) */}
              <Card className="bg-green-50 border-green-200">
                <CardContent className="p-4 text-center">
                  <div className="text-2xl font-bold text-green-700">{nineBoxData?.q7 || 0}</div>
                  <div className="text-xs text-gray-600 mt-1">Baixo Desempenho<br />Alto Potencial</div>
                </CardContent>
              </Card>
              <Card className="bg-green-100 border-green-300">
                <CardContent className="p-4 text-center">
                  <div className="text-2xl font-bold text-green-800">{nineBoxData?.q8 || 0}</div>
                  <div className="text-xs text-gray-600 mt-1">MÃ©dio Desempenho<br />Alto Potencial</div>
                </CardContent>
              </Card>
              <Card className="bg-green-200 border-green-400">
                <CardContent className="p-4 text-center">
                  <div className="text-2xl font-bold text-green-900">{nineBoxData?.q9 || 0}</div>
                  <div className="text-xs text-gray-600 mt-1">Alto Desempenho<br />Alto Potencial</div>
                  <Badge className="mt-2 bg-yellow-500">Estrelas</Badge>
                </CardContent>
              </Card>

              {/* Linha 2 (MÃ©dio Potencial) */}
              <Card className="bg-yellow-50 border-yellow-200">
                <CardContent className="p-4 text-center">
                  <div className="text-2xl font-bold text-yellow-700">{nineBoxData?.q4 || 0}</div>
                  <div className="text-xs text-gray-600 mt-1">Baixo Desempenho<br />MÃ©dio Potencial</div>
                </CardContent>
              </Card>
              <Card className="bg-yellow-100 border-yellow-300">
                <CardContent className="p-4 text-center">
                  <div className="text-2xl font-bold text-yellow-800">{nineBoxData?.q5 || 0}</div>
                  <div className="text-xs text-gray-600 mt-1">MÃ©dio Desempenho<br />MÃ©dio Potencial</div>
                </CardContent>
              </Card>
              <Card className="bg-yellow-200 border-yellow-400">
                <CardContent className="p-4 text-center">
                  <div className="text-2xl font-bold text-yellow-900">{nineBoxData?.q6 || 0}</div>
                  <div className="text-xs text-gray-600 mt-1">Alto Desempenho<br />MÃ©dio Potencial</div>
                </CardContent>
              </Card>

              {/* Linha 1 (Baixo Potencial) */}
              <Card className="bg-red-50 border-red-200">
                <CardContent className="p-4 text-center">
                  <div className="text-2xl font-bold text-red-700">{nineBoxData?.q1 || 0}</div>
                  <div className="text-xs text-gray-600 mt-1">Baixo Desempenho<br />Baixo Potencial</div>
                  <Badge variant="destructive" className="mt-2">AtenÃ§Ã£o</Badge>
                </CardContent>
              </Card>
              <Card className="bg-red-100 border-red-300">
                <CardContent className="p-4 text-center">
                  <div className="text-2xl font-bold text-red-800">{nineBoxData?.q2 || 0}</div>
                  <div className="text-xs text-gray-600 mt-1">MÃ©dio Desempenho<br />Baixo Potencial</div>
                </CardContent>
              </Card>
              <Card className="bg-red-200 border-red-400">
                <CardContent className="p-4 text-center">
                  <div className="text-2xl font-bold text-red-900">{nineBoxData?.q3 || 0}</div>
                  <div className="text-xs text-gray-600 mt-1">Alto Desempenho<br />Baixo Potencial</div>
                </CardContent>
              </Card>
            </div>
          </CardContent>
        </Card>

        {/* Insights e RecomendaÃ§Ãµes */}
        <Card className="bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200">
          <CardHeader>
            <CardTitle className="text-blue-900">Insights EstratÃ©gicos</CardTitle>
          </CardHeader>
          <CardContent>
            <ul className="space-y-2 text-sm text-blue-800">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="h-5 w-5 text-green-600 flex-shrink-0 mt-0.5" />
                <span><strong>Nine Box:</strong> {nineBoxData?.altoDesempenho || 0} colaboradores identificados como alto desempenho - foco em retenÃ§Ã£o e desenvolvimento</span>
              </li>
              <li className="flex items-start gap-2">
                {(successionData?.cobertura || 0) >= 70 ? (
                  <CheckCircle2 className="h-5 w-5 text-green-600 flex-shrink-0 mt-0.5" />
                ) : (
                  <AlertCircle className="h-5 w-5 text-red-600 flex-shrink-0 mt-0.5" />
                )}
                <span><strong>SucessÃ£o:</strong> {successionData?.cobertura || 0}% de cobertura - {(successionData?.cobertura || 0) >= 70 ? "cobertura adequada" : "necessÃ¡rio aumentar pipeline de sucessores"}</span>
              </li>
              <li className="flex items-start gap-2">
                <TrendingUp className="h-5 w-5 text-orange-600 flex-shrink-0 mt-0.5" />
                <span><strong>Metas:</strong> {goalsData?.avgAlignmentGeral || 0}% de alinhamento geral na cascata - {(goalsData?.avgAlignmentGeral || 0) >= 80 ? "excelente alinhamento estratÃ©gico" : "oportunidade de melhorar alinhamento"}</span>
              </li>
              <li className="flex items-start gap-2">
                <Activity className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" />
                <span><strong>AvaliaÃ§Ã£o 360Â°:</strong> {evaluation360Stats.percentualConclusao}% de conclusÃ£o - {evaluation360Stats.percentualConclusao >= 80 ? "Ã³tima adesÃ£o" : "incentivar conclusÃ£o das avaliaÃ§Ãµes pendentes"}</span>
              </li>
              <li className="flex items-start gap-2">
                <BarChart3 className="h-5 w-5 text-purple-600 flex-shrink-0 mt-0.5" />
                <span><strong>Benchmarking:</strong> {benchmarkingStats.gapsSignificativos} gaps significativos identificados - priorizar aÃ§Ãµes de desenvolvimento nessas dimensÃµes</span>
              </li>
            </ul>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/DashboardGestor.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { trpc } from "@/lib/trpc";
import {
  Users,
  Target,
  TrendingUp,
  AlertCircle,
  CheckCircle2,
  Clock,
  BarChart3,
  FileText,
  Award,
} from "lucide-react";
import { useAuth } from "@/_core/hooks/useAuth";

/**
 * Dashboard EspecÃ­fico para Gestores
 * 
 * VisÃ£o consolidada da equipe direta do gestor logado:
 * - KPIs da equipe (performance mÃ©dia, metas, PDIs)
 * - Lista de subordinados diretos
 * - Metas da equipe com progresso
 * - AvaliaÃ§Ãµes pendentes
 * - PDIs da equipe
 * - GrÃ¡ficos de performance
 */

export default function DashboardGestor() {
  const { user } = useAuth();
  const [selectedTab, setSelectedTab] = useState("visao-geral");

  // Queries
  const { data: teamData, isLoading: teamLoading } = trpc.employees.getTeamByManager.useQuery(
    { managerId: user?.id || 0 },
    { enabled: !!user?.id }
  );

  const { data: teamGoals, isLoading: goalsLoading } = trpc.goals.getTeamGoals.useQuery(
    { managerId: user?.id || 0 },
    { enabled: !!user?.id }
  );

  const { data: teamPDIs, isLoading: pdisLoading } = trpc.pdi.getTeamPDIs.useQuery(
    { managerId: user?.id || 0 },
    { enabled: !!user?.id }
  );

  const { data: pendingEvaluations, isLoading: evaluationsLoading } = trpc.evaluations.getPendingByManager.useQuery(
    { managerId: user?.id || 0 },
    { enabled: !!user?.id }
  );

  // Calcular KPIs
  const teamSize = teamData?.length || 0;
  const avgPerformance = 0; // TODO: Calcular com base em avaliaÃ§Ãµes reais
  const completedGoals = teamGoals?.filter((g: any) => g.status === "concluida").length || 0;
  const totalGoals = teamGoals?.length || 0;
  const activePDIs = teamPDIs?.filter((p: any) => p.status === "em_andamento").length || 0;
  const pendingEvaluationsCount = pendingEvaluations?.length || 0;

  const isLoading = teamLoading || goalsLoading || pdisLoading || evaluationsLoading;

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold">Minha Equipe</h1>
          <p className="text-muted-foreground">
            VisÃ£o consolidada da performance e desenvolvimento dos seus subordinados diretos
          </p>
        </div>

        {/* KPIs da Equipe */}
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Tamanho da Equipe</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{teamSize}</div>
              <p className="text-xs text-muted-foreground">
                Subordinados diretos
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Performance MÃ©dia</CardTitle>
              <TrendingUp className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{avgPerformance.toFixed(1)}</div>
              <p className="text-xs text-muted-foreground">
                De 0 a 100 pontos
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Metas ConcluÃ­das</CardTitle>
              <Target className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{completedGoals}/{totalGoals}</div>
              <p className="text-xs text-muted-foreground">
                {totalGoals > 0 ? `${Math.round((completedGoals / totalGoals) * 100)}%` : "0%"} de conclusÃ£o
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">AÃ§Ãµes Pendentes</CardTitle>
              <AlertCircle className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{pendingEvaluationsCount + activePDIs}</div>
              <p className="text-xs text-muted-foreground">
                {pendingEvaluationsCount} avaliaÃ§Ãµes + {activePDIs} PDIs
              </p>
            </CardContent>
          </Card>
        </div>

        {/* Tabs de ConteÃºdo */}
        <Tabs value={selectedTab} onValueChange={setSelectedTab}>
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="visao-geral">VisÃ£o Geral</TabsTrigger>
            <TabsTrigger value="metas">Metas da Equipe</TabsTrigger>
            <TabsTrigger value="avaliacoes">AvaliaÃ§Ãµes Pendentes</TabsTrigger>
            <TabsTrigger value="pdis">PDIs da Equipe</TabsTrigger>
          </TabsList>

          {/* VisÃ£o Geral */}
          <TabsContent value="visao-geral" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Subordinados Diretos</CardTitle>
                <CardDescription>
                  Lista completa da sua equipe com status de performance
                </CardDescription>
              </CardHeader>
              <CardContent>
                {isLoading ? (
                  <div className="flex items-center justify-center py-8">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                  </div>
                ) : teamSize === 0 ? (
                  <div className="text-center py-8 text-muted-foreground">
                    <Users className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <p>Nenhum subordinado direto encontrado</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {teamData?.map((employee: any) => (
                      <div key={employee.id} className="flex items-center justify-between p-4 border rounded-lg">
                        <div className="flex-1">
                          <div className="flex items-center gap-3">
                            <div>
                              <p className="font-medium">{employee.name}</p>
                              <p className="text-sm text-muted-foreground">
                                {employee.position?.title || "Sem cargo"} - {employee.department?.name || "Sem departamento"}
                              </p>
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center gap-4">
                          <div className="text-right">
                            <p className="text-sm font-medium">Status</p>
                            <Badge variant="secondary">
                              Ativo
                            </Badge>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>

            {/* AÃ§Ãµes Urgentes */}
            <Card>
              <CardHeader>
                <CardTitle>AÃ§Ãµes Urgentes</CardTitle>
                <CardDescription>
                  Itens que requerem sua atenÃ§Ã£o imediata
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {pendingEvaluationsCount > 0 && (
                    <div className="flex items-center gap-3 p-3 bg-yellow-50 dark:bg-yellow-950 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                      <AlertCircle className="h-5 w-5 text-yellow-600" />
                      <div className="flex-1">
                        <p className="font-medium">AvaliaÃ§Ãµes Pendentes</p>
                        <p className="text-sm text-muted-foreground">
                          {pendingEvaluationsCount} avaliaÃ§Ãµes aguardando sua anÃ¡lise
                        </p>
                      </div>
                      <Button size="sm" onClick={() => setSelectedTab("avaliacoes")}>
                        Ver AvaliaÃ§Ãµes
                      </Button>
                    </div>
                  )}

                  {activePDIs > 0 && (
                    <div className="flex items-center gap-3 p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg">
                      <FileText className="h-5 w-5 text-blue-600" />
                      <div className="flex-1">
                        <p className="font-medium">PDIs Ativos</p>
                        <p className="text-sm text-muted-foreground">
                          {activePDIs} PDIs em andamento requerem acompanhamento
                        </p>
                      </div>
                      <Button size="sm" variant="outline" onClick={() => setSelectedTab("pdis")}>
                        Ver PDIs
                      </Button>
                    </div>
                  )}

                  {pendingEvaluationsCount === 0 && activePDIs === 0 && (
                    <div className="text-center py-8 text-muted-foreground">
                      <CheckCircle2 className="h-12 w-12 mx-auto mb-4 opacity-50 text-green-600" />
                      <p>Nenhuma aÃ§Ã£o urgente no momento</p>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Metas da Equipe */}
          <TabsContent value="metas" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Metas da Equipe</CardTitle>
                <CardDescription>
                  Acompanhamento de todas as metas dos seus subordinados
                </CardDescription>
              </CardHeader>
              <CardContent>
                {goalsLoading ? (
                  <div className="flex items-center justify-center py-8">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                  </div>
                ) : !teamGoals || teamGoals.length === 0 ? (
                  <div className="text-center py-8 text-muted-foreground">
                    <Target className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <p>Nenhuma meta encontrada</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {teamGoals?.map((goal: any) => (
                      <div key={goal.id} className="p-4 border rounded-lg space-y-3">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <p className="font-medium">{goal.title}</p>
                            <p className="text-sm text-muted-foreground">
                              {goal.employee?.name} - {goal.category}
                            </p>
                          </div>
                          <Badge variant={
                            goal.status === "concluida" ? "default" :
                            goal.status === "em_andamento" ? "secondary" : "outline"
                          }>
                            {goal.status === "concluida" ? "ConcluÃ­da" :
                             goal.status === "em_andamento" ? "Em Andamento" : "Pendente"}
                          </Badge>
                        </div>
                        <div className="space-y-2">
                          <div className="flex items-center justify-between text-sm">
                            <span>Progresso</span>
                            <span className="font-medium">{goal.progress}%</span>
                          </div>
                          <Progress value={goal.progress} />
                        </div>
                        <div className="flex items-center gap-2 text-sm text-muted-foreground">
                          <Clock className="h-4 w-4" />
                          <span>Prazo: {new Date(goal.endDate).toLocaleDateString("pt-BR")}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* AvaliaÃ§Ãµes Pendentes */}
          <TabsContent value="avaliacoes" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>AvaliaÃ§Ãµes Pendentes</CardTitle>
                <CardDescription>
                  AvaliaÃ§Ãµes que aguardam sua anÃ¡lise e aprovaÃ§Ã£o
                </CardDescription>
              </CardHeader>
              <CardContent>
                {evaluationsLoading ? (
                  <div className="flex items-center justify-center py-8">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                  </div>
                ) : !pendingEvaluations || pendingEvaluations.length === 0 ? (
                  <div className="text-center py-8 text-muted-foreground">
                    <CheckCircle2 className="h-12 w-12 mx-auto mb-4 opacity-50 text-green-600" />
                    <p>Nenhuma avaliaÃ§Ã£o pendente</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {pendingEvaluations?.map((evaluation: any) => (
                      <div key={evaluation.id} className="p-4 border rounded-lg">
                        <div className="flex items-center justify-between mb-3">
                          <div>
                            <p className="font-medium">{evaluation.employee?.name}</p>
                            <p className="text-sm text-muted-foreground">
                              AvaliaÃ§Ã£o {evaluation.type} - Ciclo {evaluation.cycle?.name}
                            </p>
                          </div>
                          <Badge variant="outline">Pendente</Badge>
                        </div>
                        <Button size="sm" className="w-full">
                          Avaliar Agora
                        </Button>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          {/* PDIs da Equipe */}
          <TabsContent value="pdis" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>PDIs da Equipe</CardTitle>
                <CardDescription>
                  Planos de Desenvolvimento Individual em andamento
                </CardDescription>
              </CardHeader>
              <CardContent>
                {pdisLoading ? (
                  <div className="flex items-center justify-center py-8">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                  </div>
                ) : !teamPDIs || teamPDIs.length === 0 ? (
                  <div className="text-center py-8 text-muted-foreground">
                    <FileText className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <p>Nenhum PDI encontrado</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {teamPDIs?.map((pdi: any) => (
                      <div key={pdi.id} className="p-4 border rounded-lg space-y-3">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <p className="font-medium">{pdi.employee?.name}</p>
                            <p className="text-sm text-muted-foreground">
                              Cargo Alvo: {pdi.targetPosition?.title || "NÃ£o definido"}
                            </p>
                          </div>
                          <Badge variant={
                            pdi.status === "concluido" ? "default" :
                            pdi.status === "em_andamento" ? "secondary" : "outline"
                          }>
                            {pdi.status === "concluido" ? "ConcluÃ­do" :
                             pdi.status === "em_andamento" ? "Em Andamento" : pdi.status}
                          </Badge>
                        </div>
                        <div className="space-y-2">
                          <div className="flex items-center justify-between text-sm">
                            <span>Progresso Geral</span>
                            <span className="font-medium">{pdi.overallProgress}%</span>
                          </div>
                          <Progress value={pdi.overallProgress} />
                        </div>
                        <div className="flex items-center gap-2 text-sm text-muted-foreground">
                          <Clock className="h-4 w-4" />
                          <span>
                            {new Date(pdi.startDate).toLocaleDateString("pt-BR")} - {new Date(pdi.endDate).toLocaleDateString("pt-BR")}
                          </span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Departamentos.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Building2, Plus, Pencil, Trash2, Search } from "lucide-react";

interface Department {
  id: number;
  code: string;
  name: string;
  description: string | null;
  managerId: number | null;
  parentId: number | null;
  active: boolean;
  createdAt: Date;
  updatedAt: Date;
}

export default function Departamentos() {
  const [search, setSearch] = useState("");
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [editingDepartment, setEditingDepartment] = useState<Department | null>(null);
  const [formData, setFormData] = useState({
    code: "",
    name: "",
    description: "",
    active: true,
  });

  const utils = trpc.useUtils();
  const { data: departments, isLoading } = trpc.organization.departments.list.useQuery({ search });

  const createMutation = trpc.organization.departments.create.useMutation({
    onSuccess: () => {
      toast.success("Departamento criado com sucesso!");
      utils.organization.departments.list.invalidate();
      closeDialog();
    },
    onError: (error) => {
      toast.error(`Erro ao criar departamento: ${error.message}`);
    },
  });

  const updateMutation = trpc.organization.departments.update.useMutation({
    onSuccess: () => {
      toast.success("Departamento atualizado com sucesso!");
      utils.organization.departments.list.invalidate();
      closeDialog();
    },
    onError: (error) => {
      toast.error(`Erro ao atualizar departamento: ${error.message}`);
    },
  });

  const deleteMutation = trpc.organization.departments.delete.useMutation({
    onSuccess: () => {
      toast.success("Departamento excluÃ­do com sucesso!");
      utils.organization.departments.list.invalidate();
    },
    onError: (error) => {
      toast.error(`Erro ao excluir departamento: ${error.message}`);
    },
  });

  const openCreateDialog = () => {
    setEditingDepartment(null);
    setFormData({
      code: "",
      name: "",
      description: "",
      active: true,
    });
    setIsDialogOpen(true);
  };

  const openEditDialog = (department: Department) => {
    setEditingDepartment(department);
    setFormData({
      code: department.code,
      name: department.name,
      description: department.description || "",
      active: department.active,
    });
    setIsDialogOpen(true);
  };

  const closeDialog = () => {
    setIsDialogOpen(false);
    setEditingDepartment(null);
    setFormData({
      code: "",
      name: "",
      description: "",
      active: true,
    });
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    if (editingDepartment) {
      updateMutation.mutate({
        id: editingDepartment.id,
        ...formData,
      });
    } else {
      createMutation.mutate(formData);
    }
  };

  const handleDelete = (id: number) => {
    if (confirm("Tem certeza que deseja excluir este departamento?")) {
      deleteMutation.mutate({ id });
    }
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-2">
              <Building2 className="h-8 w-8" />
              Departamentos
            </h1>
            <p className="text-muted-foreground mt-1">
              Gerencie a estrutura organizacional da empresa
            </p>
          </div>
          <Button onClick={openCreateDialog}>
            <Plus className="h-4 w-4 mr-2" />
            Novo Departamento
          </Button>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>Departamentos Cadastrados</CardTitle>
            <CardDescription>
              Lista de todos os departamentos da organizaÃ§Ã£o
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="mb-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="Buscar por nome ou cÃ³digo..."
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                  className="pl-10"
                />
              </div>
            </div>

            {isLoading ? (
              <div className="text-center py-8 text-muted-foreground">
                Carregando departamentos...
              </div>
            ) : !departments || departments.length === 0 ? (
              <div className="text-center py-8 text-muted-foreground">
                Nenhum departamento encontrado
              </div>
            ) : (
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>CÃ³digo</TableHead>
                    <TableHead>Nome</TableHead>
                    <TableHead>DescriÃ§Ã£o</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead className="text-right">AÃ§Ãµes</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {departments.map((dept) => (
                    <TableRow key={dept.id}>
                      <TableCell className="font-mono">{dept.code}</TableCell>
                      <TableCell className="font-medium">{dept.name}</TableCell>
                      <TableCell className="text-muted-foreground">
                        {dept.description || "-"}
                      </TableCell>
                      <TableCell>
                        {dept.active ? (
                          <Badge variant="default">Ativo</Badge>
                        ) : (
                          <Badge variant="secondary">Inativo</Badge>
                        )}
                      </TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2">
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => openEditDialog(dept)}
                          >
                            <Pencil className="h-4 w-4" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => handleDelete(dept.id)}
                          >
                            <Trash2 className="h-4 w-4 text-destructive" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            )}
          </CardContent>
        </Card>

        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>
                {editingDepartment ? "Editar Departamento" : "Novo Departamento"}
              </DialogTitle>
              <DialogDescription>
                {editingDepartment
                  ? "Atualize as informaÃ§Ãµes do departamento"
                  : "Preencha os dados do novo departamento"}
              </DialogDescription>
            </DialogHeader>

            <form onSubmit={handleSubmit}>
              <div className="space-y-4">
                <div>
                  <Label htmlFor="code">CÃ³digo *</Label>
                  <Input
                    id="code"
                    value={formData.code}
                    onChange={(e) => setFormData({ ...formData, code: e.target.value })}
                    placeholder="Ex: TI, RH, FIN"
                    required
                  />
                </div>

                <div>
                  <Label htmlFor="name">Nome *</Label>
                  <Input
                    id="name"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    placeholder="Ex: Tecnologia da InformaÃ§Ã£o"
                    required
                  />
                </div>

                <div>
                  <Label htmlFor="description">DescriÃ§Ã£o</Label>
                  <Textarea
                    id="description"
                    value={formData.description}
                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    placeholder="Descreva as responsabilidades do departamento"
                    rows={3}
                  />
                </div>

                <div className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="active"
                    checked={formData.active}
                    onChange={(e) => setFormData({ ...formData, active: e.target.checked })}
                    className="h-4 w-4"
                  />
                  <Label htmlFor="active">Departamento ativo</Label>
                </div>
              </div>

              <DialogFooter className="mt-6">
                <Button type="button" variant="outline" onClick={closeDialog}>
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={createMutation.isPending || updateMutation.isPending}
                >
                  {editingDepartment ? "Atualizar" : "Criar"}
                </Button>
              </DialogFooter>
            </form>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/DescricaoCargos.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Plus, Pencil, Trash2, Briefcase, DollarSign, FileText } from "lucide-react";
import { toast } from "sonner";

interface Cargo {
  id: number;
  code: string;
  title: string;
  description: string;
  level: string;
  department: string;
  salaryMin: number;
  salaryMax: number;
  active: boolean;
}

export default function DescricaoCargos() {
  const [cargos] = useState<Cargo[]>([
    {
      id: 1,
      code: "DEV-001",
      title: "Desenvolvedor Full Stack",
      description: "ResponsÃ¡vel pelo desenvolvimento de aplicaÃ§Ãµes web completas, desde o frontend atÃ© o backend.",
      level: "pleno",
      department: "Tecnologia",
      salaryMin: 8000,
      salaryMax: 12000,
      active: true,
    },
    {
      id: 2,
      code: "GER-001",
      title: "Gerente de Projetos",
      description: "Gerencia projetos de TI, coordena equipes e garante a entrega dentro do prazo e orÃ§amento.",
      level: "gerente",
      department: "Tecnologia",
      salaryMin: 15000,
      salaryMax: 20000,
      active: true,
    },
    {
      id: 3,
      code: "ANA-001",
      title: "Analista de RH",
      description: "Realiza processos de recrutamento, seleÃ§Ã£o e desenvolvimento de pessoas.",
      level: "pleno",
      department: "Recursos Humanos",
      salaryMin: 6000,
      salaryMax: 9000,
      active: true,
    },
  ]);

  const [showForm, setShowForm] = useState(false);

  const handleAddCargo = () => {
    setShowForm(true);
  };

  const handleSaveCargo = () => {
    toast.success("Cargo salvo com sucesso!");
    setShowForm(false);
  };

  const handleDeleteCargo = (id: number) => {
    toast.success("Cargo excluÃ­do com sucesso!");
  };

  const getLevelBadge = (level: string) => {
    const colors: Record<string, string> = {
      junior: "bg-green-500",
      pleno: "bg-blue-500",
      senior: "bg-purple-500",
      especialista: "bg-orange-500",
      coordenador: "bg-yellow-500",
      gerente: "bg-red-500",
      diretor: "bg-gray-800",
    };
    return <Badge className={colors[level] || "bg-gray-500"}>{level.toUpperCase()}</Badge>;
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">DescriÃ§Ã£o de Cargos e SalÃ¡rios</h1>
            <p className="text-muted-foreground">
              Gerencie cargos, responsabilidades e faixas salariais
            </p>
          </div>
          <Button onClick={handleAddCargo}>
            <Plus className="mr-2 h-4 w-4" />
            Novo Cargo
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid gap-4 md:grid-cols-3">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Total de Cargos</CardTitle>
              <Briefcase className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{cargos.length}</div>
              <p className="text-xs text-muted-foreground">
                {cargos.filter((c) => c.active).length} ativos
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Faixa Salarial MÃ©dia</CardTitle>
              <DollarSign className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                R$ {((cargos.reduce((acc, c) => acc + c.salaryMin + c.salaryMax, 0) / (cargos.length * 2)) / 1000).toFixed(1)}k
              </div>
              <p className="text-xs text-muted-foreground">MÃ©dia geral</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Departamentos</CardTitle>
              <FileText className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {new Set(cargos.map((c) => c.department)).size}
              </div>
              <p className="text-xs text-muted-foreground">Com cargos cadastrados</p>
            </CardContent>
          </Card>
        </div>

        {/* FormulÃ¡rio de Novo Cargo */}
        {showForm && (
          <Card>
            <CardHeader>
              <CardTitle>Novo Cargo</CardTitle>
              <CardDescription>Preencha as informaÃ§Ãµes do cargo</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid gap-4 md:grid-cols-2">
                <div className="space-y-2">
                  <Label htmlFor="code">CÃ³digo</Label>
                  <Input id="code" placeholder="DEV-001" />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="title">TÃ­tulo do Cargo</Label>
                  <Input id="title" placeholder="Desenvolvedor Full Stack" />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="description">DescriÃ§Ã£o</Label>
                <Textarea
                  id="description"
                  placeholder="Descreva as responsabilidades e atribuiÃ§Ãµes do cargo..."
                  rows={4}
                />
              </div>

              <div className="grid gap-4 md:grid-cols-3">
                <div className="space-y-2">
                  <Label htmlFor="level">NÃ­vel</Label>
                  <Select>
                    <SelectTrigger>
                      <SelectValue placeholder="Selecione" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="junior">JÃºnior</SelectItem>
                      <SelectItem value="pleno">Pleno</SelectItem>
                      <SelectItem value="senior">SÃªnior</SelectItem>
                      <SelectItem value="especialista">Especialista</SelectItem>
                      <SelectItem value="coordenador">Coordenador</SelectItem>
                      <SelectItem value="gerente">Gerente</SelectItem>
                      <SelectItem value="diretor">Diretor</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="salaryMin">SalÃ¡rio MÃ­nimo (R$)</Label>
                  <Input id="salaryMin" type="number" placeholder="8000" />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="salaryMax">SalÃ¡rio MÃ¡ximo (R$)</Label>
                  <Input id="salaryMax" type="number" placeholder="12000" />
                </div>
              </div>

              <div className="flex justify-end gap-2">
                <Button variant="outline" onClick={() => setShowForm(false)}>
                  Cancelar
                </Button>
                <Button onClick={handleSaveCargo}>Salvar Cargo</Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Tabela de Cargos */}
        <Card>
          <CardHeader>
            <CardTitle>Cargos Cadastrados</CardTitle>
            <CardDescription>Lista completa de cargos e faixas salariais</CardDescription>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>CÃ³digo</TableHead>
                  <TableHead>Cargo</TableHead>
                  <TableHead>NÃ­vel</TableHead>
                  <TableHead>Departamento</TableHead>
                  <TableHead>Faixa Salarial</TableHead>
                  <TableHead>Status</TableHead>
                  <TableHead className="text-right">AÃ§Ãµes</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {cargos.map((cargo) => (
                  <TableRow key={cargo.id}>
                    <TableCell className="font-medium">{cargo.code}</TableCell>
                    <TableCell>
                      <div>
                        <div className="font-medium">{cargo.title}</div>
                        <div className="text-sm text-muted-foreground line-clamp-1">
                          {cargo.description}
                        </div>
                      </div>
                    </TableCell>
                    <TableCell>{getLevelBadge(cargo.level)}</TableCell>
                    <TableCell>{cargo.department}</TableCell>
                    <TableCell>
                      R$ {(cargo.salaryMin / 1000).toFixed(1)}k - R${" "}
                      {(cargo.salaryMax / 1000).toFixed(1)}k
                    </TableCell>
                    <TableCell>
                      <Badge variant={cargo.active ? "default" : "secondary"}>
                        {cargo.active ? "Ativo" : "Inativo"}
                      </Badge>
                    </TableCell>
                    <TableCell className="text-right">
                      <div className="flex justify-end gap-2">
                        <Button variant="ghost" size="icon">
                          <Pencil className="h-4 w-4" />
                        </Button>
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => handleDeleteCargo(cargo.id)}
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/DescricaoCargosUISA.tsx
========================================
import { useState } from "react";
import { useLocation } from "wouter";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { trpc } from "@/lib/trpc";
import DashboardLayout from "@/components/DashboardLayout";
import { Plus, FileText, CheckCircle, XCircle, Clock, Eye } from "lucide-react";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { toast } from "sonner";

export default function DescricaoCargosUISA() {
  const [, setLocation] = useLocation();
  const navigate = (path: string) => setLocation(path);
  const [selectedJob, setSelectedJob] = useState<any>(null);
  const [approvalDialog, setApprovalDialog] = useState(false);
  const [rejectDialog, setRejectDialog] = useState(false);
  const [comments, setComments] = useState("");
  const [selectedApprovalId, setSelectedApprovalId] = useState<number | null>(null);

  const { data: jobDescriptions, refetch } = trpc.jobDescriptions.list.useQuery({});

  const approveMutation = trpc.jobDescriptions.approve.useMutation({
    onSuccess: () => {
      toast.success("DescriÃ§Ã£o aprovada com sucesso!");
      setApprovalDialog(false);
      setComments("");
      refetch();
    },
    onError: (error) => {
      toast.error("Erro ao aprovar: " + error.message);
    },
  });

  const rejectMutation = trpc.jobDescriptions.reject.useMutation({
    onSuccess: () => {
      toast.success("DescriÃ§Ã£o rejeitada");
      setRejectDialog(false);
      setComments("");
      refetch();
    },
    onError: (error) => {
      toast.error("Erro ao rejeitar: " + error.message);
    },
  });

  const getStatusBadge = (status: string) => {
    const statusMap: Record<string, { label: string; variant: any }> = {
      draft: { label: "Rascunho", variant: "secondary" },
      pending_occupant: { label: "Aguardando Ocupante", variant: "default" },
      pending_manager: { label: "Aguardando Superior", variant: "default" },
      pending_hr: { label: "Aguardando RH", variant: "default" },
      approved: { label: "Aprovado", variant: "default" },
      rejected: { label: "Rejeitado", variant: "destructive" },
    };

    const { label, variant } = statusMap[status] || { label: status, variant: "secondary" };

    return <Badge variant={variant}>{label}</Badge>;
  };

  const handleApprove = () => {
    if (selectedApprovalId) {
      approveMutation.mutate({ approvalId: selectedApprovalId, comments });
    }
  };

  const handleReject = () => {
    if (selectedApprovalId && comments.trim()) {
      rejectMutation.mutate({ approvalId: selectedApprovalId, comments });
    } else {
      toast.error("ComentÃ¡rio obrigatÃ³rio para rejeiÃ§Ã£o");
    }
  };

  return (
    <DashboardLayout>
      <div className="container mx-auto py-8">
        <div className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold mb-2">DescriÃ§Ã£o de Cargos - Template UISA</h1>
            <p className="text-muted-foreground">Gerencie descriÃ§Ãµes de cargo com workflow de aprovaÃ§Ã£o</p>
          </div>
          <Button onClick={() => navigate("/descricao-cargos-uisa/criar")}>
            <Plus className="w-4 h-4 mr-2" />
            Nova DescriÃ§Ã£o
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-4 gap-4 mb-8">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Total de DescriÃ§Ãµes</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{jobDescriptions?.length || 0}</div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Pendentes de AprovaÃ§Ã£o</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">
                {jobDescriptions?.filter(j => j.status.includes("pending")).length || 0}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Aprovadas</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-green-600">
                {jobDescriptions?.filter(j => j.status === "approved").length || 0}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Rascunhos</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">
                {jobDescriptions?.filter(j => j.status === "draft").length || 0}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Tabela de DescriÃ§Ãµes */}
        <Card>
          <CardHeader>
            <CardTitle>DescriÃ§Ãµes de Cargo</CardTitle>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Cargo</TableHead>
                  <TableHead>Departamento</TableHead>
                  <TableHead>DivisÃ£o</TableHead>
                  <TableHead>Status</TableHead>
                  <TableHead>Criado em</TableHead>
                  <TableHead>AÃ§Ãµes</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {jobDescriptions?.map((job) => (
                  <TableRow key={job.id}>
                    <TableCell className="font-medium">{job.positionTitle}</TableCell>
                    <TableCell>{job.departmentName}</TableCell>
                    <TableCell>{job.division || "-"}</TableCell>
                    <TableCell>{getStatusBadge(job.status)}</TableCell>
                    <TableCell>{new Date(job.createdAt).toLocaleDateString("pt-BR")}</TableCell>
                    <TableCell>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => navigate(`/descricao-cargos-uisa/${job.id}`)}
                      >
                        <Eye className="w-4 h-4 mr-2" />
                        Ver Detalhes
                      </Button>
                    </TableCell>
                  </TableRow>
                ))}
                {(!jobDescriptions || jobDescriptions.length === 0) && (
                  <TableRow>
                    <TableCell colSpan={6} className="text-center py-8 text-muted-foreground">
                      Nenhuma descriÃ§Ã£o de cargo cadastrada
                    </TableCell>
                  </TableRow>
                )}
              </TableBody>
            </Table>
          </CardContent>
        </Card>

        {/* Dialog de AprovaÃ§Ã£o */}
        <Dialog open={approvalDialog} onOpenChange={setApprovalDialog}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Aprovar DescriÃ§Ã£o de Cargo</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <Label>ComentÃ¡rios (opcional)</Label>
                <Textarea
                  value={comments}
                  onChange={(e) => setComments(e.target.value)}
                  placeholder="Adicione comentÃ¡rios sobre a aprovaÃ§Ã£o..."
                  rows={4}
                />
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setApprovalDialog(false)}>
                Cancelar
              </Button>
              <Button onClick={handleApprove} disabled={approveMutation.isPending}>
                <CheckCircle className="w-4 h-4 mr-2" />
                Aprovar
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* Dialog de RejeiÃ§Ã£o */}
        <Dialog open={rejectDialog} onOpenChange={setRejectDialog}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Rejeitar DescriÃ§Ã£o de Cargo</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <Label>Motivo da RejeiÃ§Ã£o *</Label>
                <Textarea
                  value={comments}
                  onChange={(e) => setComments(e.target.value)}
                  placeholder="Descreva o motivo da rejeiÃ§Ã£o..."
                  rows={4}
                />
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setRejectDialog(false)}>
                Cancelar
              </Button>
              <Button variant="destructive" onClick={handleReject} disabled={rejectMutation.isPending}>
                <XCircle className="w-4 h-4 mr-2" />
                Rejeitar
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/DetalhesDescricaoCargo.tsx
========================================
import { useLocation } from "wouter";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { trpc } from "@/lib/trpc";
import DashboardLayout from "@/components/DashboardLayout";
import { ArrowLeft, CheckCircle, XCircle, Clock, FileText, Download } from "lucide-react";
import { Separator } from "@/components/ui/separator";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { toast } from "sonner";
import { useState } from "react";

export default function DetalhesDescricaoCargo({ params }: { params: { id: string } }) {
  const [, setLocation] = useLocation();
  const navigate = (path: string) => setLocation(path);
  const [approvalDialog, setApprovalDialog] = useState(false);
  const [rejectDialog, setRejectDialog] = useState(false);
  const [comments, setComments] = useState("");
  const [selectedApprovalId, setSelectedApprovalId] = useState<number | null>(null);

  const { data: jobDesc, refetch } = trpc.jobDescriptions.getById.useQuery({ id: parseInt(params.id) });
  
  const exportPDFMutation = trpc.jobDescriptionsPDF.exportPDF.useMutation({
    onSuccess: (data) => {
      // Converter base64 para blob e fazer download
      const byteCharacters = atob(data.pdfBase64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: 'application/pdf' });
      
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = data.filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
      
      toast.success('PDF gerado com sucesso!');
    },
    onError: (error) => {
      toast.error('Erro ao gerar PDF: ' + error.message);
    },
  });

  const approveMutation = trpc.jobDescriptions.approve.useMutation({
    onSuccess: () => {
      toast.success("Aprovado com sucesso!");
      setApprovalDialog(false);
      setComments("");
      refetch();
    },
  });

  const rejectMutation = trpc.jobDescriptions.reject.useMutation({
    onSuccess: () => {
      toast.success("Rejeitado");
      setRejectDialog(false);
      setComments("");
      refetch();
    },
  });

  const getStatusBadge = (status: string) => {
    const statusMap: Record<string, { label: string; color: string }> = {
      pending: { label: "Pendente", color: "bg-yellow-500" },
      approved: { label: "Aprovado", color: "bg-green-500" },
      rejected: { label: "Rejeitado", color: "bg-red-500" },
    };
    return statusMap[status] || { label: status, color: "bg-gray-500" };
  };

  const getLevelLabel = (level: string) => {
    const levelMap: Record<string, string> = {
      basico: "BÃ¡sico",
      intermediario: "IntermediÃ¡rio",
      avancado: "AvanÃ§ado",
      obrigatorio: "ObrigatÃ³rio",
    };
    return levelMap[level] || level;
  };

  if (!jobDesc) {
    return (
      <DashboardLayout>
        <div className="container mx-auto py-8">Carregando...</div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="container mx-auto py-8">
        <Button variant="ghost" onClick={() => navigate("/descricao-cargos-uisa")} className="mb-4">
          <ArrowLeft className="w-4 h-4 mr-2" />
          Voltar
        </Button>

        <div className="mb-8 flex justify-between items-start">
          <div>
            <h1 className="text-3xl font-bold mb-2">{jobDesc.positionTitle}</h1>
            <p className="text-muted-foreground">{jobDesc.departmentName}</p>
          </div>
          {jobDesc.status === 'approved' && (
            <Button 
              onClick={() => exportPDFMutation.mutate({ jobDescriptionId: jobDesc.id })}
              disabled={exportPDFMutation.isPending}
            >
              <Download className="w-4 h-4 mr-2" />
              {exportPDFMutation.isPending ? 'Gerando PDF...' : 'Exportar PDF'}
            </Button>
          )}
        </div>

        <div className="grid grid-cols-3 gap-6">
          {/* Coluna Principal */}
          <div className="col-span-2 space-y-6">
            {/* InformaÃ§Ãµes BÃ¡sicas */}
            <Card>
              <CardHeader>
                <CardTitle>InformaÃ§Ãµes BÃ¡sicas</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <span className="font-semibold">Cargo:</span> {jobDesc.positionTitle}
                  </div>
                  <div>
                    <span className="font-semibold">Departamento:</span> {jobDesc.departmentName}
                  </div>
                  <div>
                    <span className="font-semibold">CBO:</span> {jobDesc.cbo || "-"}
                  </div>
                  <div>
                    <span className="font-semibold">DivisÃ£o:</span> {jobDesc.division || "-"}
                  </div>
                  <div>
                    <span className="font-semibold">Reporta para:</span> {jobDesc.reportsTo || "-"}
                  </div>
                  <div>
                    <span className="font-semibold">RevisÃ£o:</span> {jobDesc.revision || "-"}
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Objetivo Principal */}
            <Card>
              <CardHeader>
                <CardTitle>Objetivo Principal do Cargo</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm leading-relaxed">{jobDesc.mainObjective}</p>
              </CardContent>
            </Card>

            {/* Responsabilidades */}
            <Card>
              <CardHeader>
                <CardTitle>Responsabilidades</CardTitle>
              </CardHeader>
              <CardContent>
                {jobDesc.responsibilities?.map((resp: any, index: number) => (
                  <div key={index} className="mb-4">
                    <Badge className="mb-2">{resp.category}</Badge>
                    <p className="text-sm">{resp.description}</p>
                  </div>
                ))}
              </CardContent>
            </Card>

            {/* Conhecimentos TÃ©cnicos */}
            <Card>
              <CardHeader>
                <CardTitle>Conhecimentos TÃ©cnicos</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  {jobDesc.knowledge?.map((k: any, index: number) => (
                    <div key={index} className="flex justify-between items-center border-b pb-2">
                      <span className="text-sm">{k.name}</span>
                      <Badge variant="outline">{getLevelLabel(k.level)}</Badge>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            {/* CompetÃªncias e Habilidades */}
            <Card>
              <CardHeader>
                <CardTitle>CompetÃªncias e Habilidades</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-4">
                  {jobDesc.competencies?.map((comp: any, index: number) => (
                    <div key={index} className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-500" />
                      <span className="text-sm">{comp.name}</span>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            {/* QualificaÃ§Ã£o Desejada */}
            <Card>
              <CardHeader>
                <CardTitle>QualificaÃ§Ã£o Desejada</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <div>
                  <span className="font-semibold">FormaÃ§Ã£o:</span> {jobDesc.educationLevel || "-"}
                </div>
                <div>
                  <span className="font-semibold">ExperiÃªncia:</span> {jobDesc.requiredExperience || "-"}
                </div>
              </CardContent>
            </Card>

            {/* e-Social */}
            {jobDesc.eSocialSpecs && (
              <Card>
                <CardHeader>
                  <CardTitle>e-Social</CardTitle>
                </CardHeader>
                <CardContent>
                  <p className="text-sm">{jobDesc.eSocialSpecs}</p>
                </CardContent>
              </Card>
            )}
          </div>

          {/* Coluna Lateral - Timeline de AprovaÃ§Ãµes */}
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Timeline de AprovaÃ§Ãµes</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {jobDesc.approvals?.map((approval: any, index: number) => {
                    const status = getStatusBadge(approval.status);
                    const isPending = approval.status === "pending";

                    return (
                      <div key={index} className="relative">
                        {index < jobDesc.approvals.length - 1 && (
                          <div className="absolute left-4 top-8 w-0.5 h-full bg-border" />
                        )}
                        <div className="flex gap-4">
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center ${status.color}`}>
                            {approval.status === "approved" && <CheckCircle className="w-5 h-5 text-white" />}
                            {approval.status === "rejected" && <XCircle className="w-5 h-5 text-white" />}
                            {approval.status === "pending" && <Clock className="w-5 h-5 text-white" />}
                          </div>
                          <div className="flex-1">
                            <div className="font-semibold text-sm">
                              {approval.approvalLevel === "occupant" && "Ocupante do Cargo"}
                              {approval.approvalLevel === "manager" && "Superior Imediato"}
                              {approval.approvalLevel === "hr" && "Gerente de RH"}
                            </div>
                            <div className="text-xs text-muted-foreground">{approval.approverName}</div>
                            <Badge variant="outline" className="mt-1">
                              {status.label}
                            </Badge>
                            {approval.comments && (
                              <p className="text-xs mt-2 text-muted-foreground">{approval.comments}</p>
                            )}
                            {isPending && (
                              <div className="flex gap-2 mt-2">
                                <Button
                                  size="sm"
                                  onClick={() => {
                                    setSelectedApprovalId(approval.id);
                                    setApprovalDialog(true);
                                  }}
                                >
                                  Aprovar
                                </Button>
                                <Button
                                  size="sm"
                                  variant="destructive"
                                  onClick={() => {
                                    setSelectedApprovalId(approval.id);
                                    setRejectDialog(true);
                                  }}
                                >
                                  Rejeitar
                                </Button>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </div>
        </div>

        {/* Dialog de AprovaÃ§Ã£o */}
        <Dialog open={approvalDialog} onOpenChange={setApprovalDialog}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Aprovar DescriÃ§Ã£o de Cargo</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <Label>ComentÃ¡rios (opcional)</Label>
                <Textarea
                  value={comments}
                  onChange={(e) => setComments(e.target.value)}
                  placeholder="Adicione comentÃ¡rios..."
                  rows={4}
                />
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setApprovalDialog(false)}>
                Cancelar
              </Button>
              <Button
                onClick={() => {
                  if (selectedApprovalId) {
                    approveMutation.mutate({ approvalId: selectedApprovalId, comments });
                  }
                }}
              >
                <CheckCircle className="w-4 h-4 mr-2" />
                Aprovar
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* Dialog de RejeiÃ§Ã£o */}
        <Dialog open={rejectDialog} onOpenChange={setRejectDialog}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Rejeitar DescriÃ§Ã£o de Cargo</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <Label>Motivo da RejeiÃ§Ã£o *</Label>
                <Textarea
                  value={comments}
                  onChange={(e) => setComments(e.target.value)}
                  placeholder="Descreva o motivo..."
                  rows={4}
                />
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setRejectDialog(false)}>
                Cancelar
              </Button>
              <Button
                variant="destructive"
                onClick={() => {
                  if (selectedApprovalId && comments.trim()) {
                    rejectMutation.mutate({ approvalId: selectedApprovalId, comments });
                  } else {
                    toast.error("ComentÃ¡rio obrigatÃ³rio");
                  }
                }}
              >
                <XCircle className="w-4 h-4 mr-2" />
                Rejeitar
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/DetalhesMeta.tsx
========================================
import { useState } from "react";
import { useParams, useLocation, Link } from "wouter";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Textarea } from "@/components/ui/textarea";
import { Separator } from "@/components/ui/separator";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { toast } from "sonner";
import {
  Target,
  TrendingUp,
  Calendar,
  DollarSign,
  CheckCircle2,
  XCircle,
  Clock,
  AlertCircle,
  ArrowLeft,
  Edit,
  MessageSquare,
  FileText,
  Users,
  Award,
  Download,
  Mail,
} from "lucide-react";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";
import GoalApprovalSection from "@/components/GoalApprovalSection";

/**
 * PÃ¡gina de Detalhes da Meta Individual
 * Exibe informaÃ§Ãµes completas, marcos, aprovaÃ§Ãµes e comentÃ¡rios
 */
export default function DetalhesMeta() {
  const { id } = useParams();
  const [, navigate] = useLocation();
  const [commentText, setCommentText] = useState("");
  const [showCommentDialog, setShowCommentDialog] = useState(false);

  // Enviar e-mail
  const sendEmailMutation = trpc.email.sendGoalEmail.useMutation({
    onSuccess: () => {
      toast.success("E-mail enviado com sucesso!");
    },
    onError: (error) => {
      toast.error(error.message || "Erro ao enviar e-mail");
    },
  });

  // Exportar PDF
  const exportPDFMutation = trpc.smartGoals.exportPDF.useMutation({
    onSuccess: (data) => {
      // Converter base64 para blob e fazer download
      const byteCharacters = atob(data.data);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: "application/pdf" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = data.filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      toast.success("PDF exportado com sucesso!");
    },
    onError: (error: any) => {
      toast.error("Erro ao exportar PDF", {
        description: error.message,
      });
    },
  });

  const goalId = parseInt(id || "0");

  // Buscar meta completa
  const { data: goal, isLoading, refetch } = trpc.smartGoals.getById.useQuery({ goalId });

  // Adicionar comentÃ¡rio
  const addCommentMutation = trpc.smartGoals.addComment.useMutation({
    onSuccess: () => {
      toast.success("ComentÃ¡rio adicionado com sucesso!");
      setCommentText("");
      setShowCommentDialog(false);
      refetch();
    },
    onError: (error) => {
      toast.error("Erro ao adicionar comentÃ¡rio", {
        description: error.message,
      });
    },
  });

  const handleAddComment = async () => {
    if (!commentText.trim()) {
      toast.error("Digite um comentÃ¡rio");
      return;
    }

    await addCommentMutation.mutateAsync({
      goalId,
      comment: commentText,
    });
  };

  // Mutations de evidÃªncias
  const addEvidenceMutation = trpc.smartGoals.addEvidence.useMutation({
    onSuccess: () => {
      toast.success("EvidÃªncia adicionada com sucesso!");
      refetch();
    },
    onError: (error) => {
      toast.error("Erro ao adicionar evidÃªncia", {
        description: error.message,
      });
    },
  });

  const deleteEvidenceMutation = trpc.smartGoals.deleteEvidence.useMutation({
    onSuccess: () => {
      toast.success("EvidÃªncia excluÃ­da com sucesso!");
      refetch();
    },
    onError: (error) => {
      toast.error("Erro ao excluir evidÃªncia", {
        description: error.message,
      });
    },
  });

  const uploadFileMutation = trpc.smartGoals.uploadEvidenceFile.useMutation();

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validar tamanho (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      toast.error("Arquivo muito grande", {
        description: "O tamanho mÃ¡ximo Ã© 10MB",
      });
      return;
    }

    const description = prompt("Descreva esta evidÃªncia:");
    if (!description) return;

    try {
      // Converter arquivo para base64
      const reader = new FileReader();
      reader.readAsDataURL(file);
      
      reader.onload = async () => {
        const base64Data = (reader.result as string).split(',')[1];
        
        // Upload para S3
        toast.info("Enviando arquivo...");
        const uploadResult = await uploadFileMutation.mutateAsync({
          fileName: file.name,
          fileData: base64Data,
          contentType: file.type,
        });

        // Adicionar evidÃªncia ao banco
        await addEvidenceMutation.mutateAsync({
          goalId,
          description,
          attachmentUrl: uploadResult.url,
          attachmentName: file.name,
          attachmentType: file.type,
          attachmentSize: file.size,
        });
      };

      reader.onerror = () => {
        toast.error("Erro ao ler arquivo");
      };
    } catch (error: any) {
      toast.error("Erro ao fazer upload", {
        description: error.message,
      });
    }
  };

  const handleDeleteEvidence = async (evidenceId: number) => {
    if (confirm("Tem certeza que deseja excluir esta evidÃªncia?")) {
      await deleteEvidenceMutation.mutateAsync({ evidenceId });
    }
  };

  const getStatusColor = (status: string) => {
    const colors: Record<string, string> = {
      draft: "bg-gray-500",
      pending_approval: "bg-yellow-500",
      approved: "bg-green-500",
      rejected: "bg-red-500",
      in_progress: "bg-blue-500",
      completed: "bg-emerald-500",
      cancelled: "bg-gray-400",
    };
    return colors[status] || "bg-gray-500";
  };

  const getStatusLabel = (status: string) => {
    const labels: Record<string, string> = {
      draft: "Rascunho",
      pending_approval: "Aguardando AprovaÃ§Ã£o",
      approved: "Aprovada",
      rejected: "Rejeitada",
      in_progress: "Em Andamento",
      completed: "ConcluÃ­da",
      cancelled: "Cancelada",
    };
    return labels[status] || status;
  };

  const getCategoryLabel = (category: string) => {
    const labels: Record<string, string> = {
      financial: "Financeira",
      behavioral: "Comportamental",
      corporate: "Corporativa",
      development: "Desenvolvimento",
    };
    return labels[category] || category;
  };

  const getApprovalStatusLabel = (status: string) => {
    const labels: Record<string, string> = {
      not_submitted: "NÃ£o Enviada",
      pending_manager: "Aguardando Gestor",
      pending_hr: "Aguardando RH",
      approved: "Aprovada",
      rejected: "Rejeitada",
    };
    return labels[status] || status;
  };

  const getMilestoneStatusColor = (status: string) => {
    const colors: Record<string, string> = {
      pending: "text-gray-600",
      in_progress: "text-blue-600",
      completed: "text-green-600",
      delayed: "text-red-600",
    };
    return colors[status] || "text-gray-600";
  };

  if (isLoading) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  if (!goal) {
    return (
      <div className="container mx-auto p-6">
        <Card>
          <CardContent className="text-center py-12">
            <AlertCircle className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">Meta nÃ£o encontrada</h3>
            <p className="text-gray-600 mb-4">A meta solicitada nÃ£o existe ou foi removida</p>
            <Link href="/metas">
              <Button>Voltar para Metas</Button>
            </Link>
          </CardContent>
        </Card>
      </div>
    );
  }

  const smartScore =
    [goal.isSpecific, goal.isMeasurable, goal.isAchievable, goal.isRelevant, goal.isTimeBound].filter(
      Boolean
    ).length * 20;

  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-start">
        <div className="flex-1">
          <Button variant="ghost" onClick={() => navigate("/metas")} className="mb-4">
            <ArrowLeft className="w-4 h-4 mr-2" />
            Voltar
          </Button>
          <div className="flex items-center gap-3 mb-2">
            <h1 className="text-3xl font-bold text-gray-900">{goal.title}</h1>
            <Badge className={getStatusColor(goal.status)}>{getStatusLabel(goal.status)}</Badge>
            {goal.bonusEligible && (
              <Badge variant="outline" className="bg-green-50 text-green-700">
                <DollarSign className="w-3 h-3 mr-1" />
                BÃ´nus
              </Badge>
            )}
          </div>
          <p className="text-gray-600">{getCategoryLabel(goal.category)}</p>
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={() => toast.info("Funcionalidade de e-mail em desenvolvimento")}
            disabled={sendEmailMutation.isPending}
          >
            <Mail className="w-4 h-4 mr-2" />
            {sendEmailMutation.isPending ? "Enviando..." : "Enviar por E-mail"}
          </Button>
          <Button
            variant="outline"
            onClick={() => exportPDFMutation.mutate({ goalId })}
            disabled={exportPDFMutation.isPending}
          >
            <Download className="w-4 h-4 mr-2" />
            {exportPDFMutation.isPending ? "Exportando..." : "Exportar PDF"}
          </Button>
          {goal.status === "draft" && (
            <Link href={`/metas/${goalId}/editar`}>
              <Button variant="outline">
                <Edit className="w-4 h-4 mr-2" />
                Editar
              </Button>
            </Link>
          )}
          {["approved", "in_progress"].includes(goal.status) && (
            <Link href={`/metas/${goalId}/progresso`}>
              <Button className="bg-[#F39200] hover:bg-[#d67e00]">
                <TrendingUp className="w-4 h-4 mr-2" />
                Atualizar Progresso
              </Button>
            </Link>
          )}
        </div>
      </div>

      {/* InformaÃ§Ãµes Principais */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Progresso</CardTitle>
            <Target className="h-4 w-4 text-blue-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{goal.progress || 0}%</div>
            <Progress value={goal.progress || 0} className="h-2 mt-2" />
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ValidaÃ§Ã£o SMART</CardTitle>
            <Award className="h-4 w-4 text-purple-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{smartScore}/100</div>
            <p className="text-xs text-gray-500 mt-1">{smartScore / 20} de 5 critÃ©rios</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Status de AprovaÃ§Ã£o</CardTitle>
            <CheckCircle2 className="h-4 w-4 text-green-600" />
          </CardHeader>
          <CardContent>
            <div className="text-sm font-semibold">{getApprovalStatusLabel(goal.approvalStatus)}</div>
            <p className="text-xs text-gray-500 mt-1">
              {goal.approvals?.length || 0} aprovaÃ§Ãµes registradas
            </p>
          </CardContent>
        </Card>
      </div>

      {/* DescriÃ§Ã£o e Detalhes */}
      <Card>
        <CardHeader>
          <CardTitle>DescriÃ§Ã£o da Meta</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <p className="text-gray-700 whitespace-pre-wrap">{goal.description}</p>

          <Separator />

          {/* MÃ©tricas */}
          {goal.measurementUnit && goal.targetValue && (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <p className="text-sm text-gray-600">Unidade de Medida</p>
                <p className="font-semibold">{goal.measurementUnit}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600">Valor Alvo</p>
                <p className="font-semibold">{goal.targetValue}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600">Valor Atual</p>
                <p className="font-semibold">{goal.currentValue || "0"}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600">Peso</p>
                <p className="font-semibold">{goal.weight}%</p>
              </div>
            </div>
          )}

          <Separator />

          {/* Datas */}
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div>
              <p className="text-sm text-gray-600 flex items-center gap-2">
                <Calendar className="w-4 h-4" />
                Data de InÃ­cio
              </p>
              <p className="font-semibold">
                {format(new Date(goal.startDate), "dd/MM/yyyy", { locale: ptBR })}
              </p>
            </div>
            <div>
              <p className="text-sm text-gray-600 flex items-center gap-2">
                <Calendar className="w-4 h-4" />
                Data de TÃ©rmino
              </p>
              <p className="font-semibold">
                {format(new Date(goal.endDate), "dd/MM/yyyy", { locale: ptBR })}
              </p>
            </div>
            {goal.completedAt && (
              <div>
                <p className="text-sm text-gray-600 flex items-center gap-2">
                  <CheckCircle2 className="w-4 h-4" />
                  ConcluÃ­da em
                </p>
                <p className="font-semibold">
                  {format(new Date(goal.completedAt), "dd/MM/yyyy", { locale: ptBR })}
                </p>
              </div>
            )}
          </div>

          {/* BÃ´nus */}
          {goal.bonusEligible && (
            <>
              <Separator />
              <div className="bg-green-50 p-4 rounded-lg">
                <h4 className="font-semibold text-green-900 mb-2 flex items-center gap-2">
                  <DollarSign className="w-5 h-5" />
                  InformaÃ§Ãµes de BÃ´nus
                </h4>
                <div className="grid grid-cols-2 gap-4">
                  {goal.bonusPercentage && (
                    <div>
                      <p className="text-sm text-green-700">BÃ´nus Percentual</p>
                      <p className="font-semibold text-green-900">{goal.bonusPercentage}%</p>
                    </div>
                  )}
                  {goal.bonusAmount && (
                    <div>
                      <p className="text-sm text-green-700">BÃ´nus Fixo</p>
                      <p className="font-semibold text-green-900">R$ {goal.bonusAmount}</p>
                    </div>
                  )}
                </div>
              </div>
            </>
          )}
        </CardContent>
      </Card>

      {/* CritÃ©rios SMART */}
      <Card>
        <CardHeader>
          <CardTitle>CritÃ©rios SMART</CardTitle>
          <CardDescription>ValidaÃ§Ã£o dos 5 critÃ©rios para metas efetivas</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div className={`p-4 border rounded-lg ${goal.isSpecific ? "bg-green-50 border-green-200" : "bg-gray-50"}`}>
              <div className="flex items-center justify-between mb-2">
                <span className="font-semibold">S - EspecÃ­fica</span>
                {goal.isSpecific ? (
                  <CheckCircle2 className="w-5 h-5 text-green-600" />
                ) : (
                  <XCircle className="w-5 h-5 text-gray-400" />
                )}
              </div>
              <p className="text-xs text-gray-600">Clara e bem definida</p>
            </div>

            <div className={`p-4 border rounded-lg ${goal.isMeasurable ? "bg-green-50 border-green-200" : "bg-gray-50"}`}>
              <div className="flex items-center justify-between mb-2">
                <span className="font-semibold">M - MensurÃ¡vel</span>
                {goal.isMeasurable ? (
                  <CheckCircle2 className="w-5 h-5 text-green-600" />
                ) : (
                  <XCircle className="w-5 h-5 text-gray-400" />
                )}
              </div>
              <p className="text-xs text-gray-600">Possui mÃ©tricas</p>
            </div>

            <div className={`p-4 border rounded-lg ${goal.isAchievable ? "bg-green-50 border-green-200" : "bg-gray-50"}`}>
              <div className="flex items-center justify-between mb-2">
                <span className="font-semibold">A - AtingÃ­vel</span>
                {goal.isAchievable ? (
                  <CheckCircle2 className="w-5 h-5 text-green-600" />
                ) : (
                  <XCircle className="w-5 h-5 text-gray-400" />
                )}
              </div>
              <p className="text-xs text-gray-600">Valor realista</p>
            </div>

            <div className={`p-4 border rounded-lg ${goal.isRelevant ? "bg-green-50 border-green-200" : "bg-gray-50"}`}>
              <div className="flex items-center justify-between mb-2">
                <span className="font-semibold">R - Relevante</span>
                {goal.isRelevant ? (
                  <CheckCircle2 className="w-5 h-5 text-green-600" />
                ) : (
                  <XCircle className="w-5 h-5 text-gray-400" />
                )}
              </div>
              <p className="text-xs text-gray-600">Alinhada estrategicamente</p>
            </div>

            <div className={`p-4 border rounded-lg ${goal.isTimeBound ? "bg-green-50 border-green-200" : "bg-gray-50"}`}>
              <div className="flex items-center justify-between mb-2">
                <span className="font-semibold">T - Temporal</span>
                {goal.isTimeBound ? (
                  <CheckCircle2 className="w-5 h-5 text-green-600" />
                ) : (
                  <XCircle className="w-5 h-5 text-gray-400" />
                )}
              </div>
              <p className="text-xs text-gray-600">Prazo definido</p>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Marcos */}
      {goal.milestones && goal.milestones.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Clock className="w-5 h-5" />
              Marcos IntermediÃ¡rios ({goal.milestones.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {goal.milestones.map((milestone: any) => (
                <div key={milestone.id} className="flex items-start gap-4 p-4 border rounded-lg">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <h4 className="font-semibold">{milestone.title}</h4>
                      <span className={`text-sm font-medium ${getMilestoneStatusColor(milestone.status)}`}>
                        {milestone.status === "completed" && "âœ“ ConcluÃ­do"}
                        {milestone.status === "in_progress" && "â³ Em Andamento"}
                        {milestone.status === "pending" && "â¸ Pendente"}
                        {milestone.status === "delayed" && "âš  Atrasado"}
                      </span>
                    </div>
                    {milestone.description && (
                      <p className="text-sm text-gray-600 mb-2">{milestone.description}</p>
                    )}
                    <div className="flex items-center gap-4 text-xs text-gray-500">
                      <span className="flex items-center gap-1">
                        <Calendar className="w-3 h-3" />
                        Prazo: {format(new Date(milestone.dueDate), "dd/MM/yyyy", { locale: ptBR })}
                      </span>
                      <span>Progresso: {milestone.progress || 0}%</span>
                    </div>
                  </div>
                  <Progress value={milestone.progress || 0} className="w-24 h-2" />
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* AprovaÃ§Ãµes */}
      <GoalApprovalSection
        goalId={goalId}
        currentStatus={goal.status}
        approvalStatus={goal.approvalStatus}
      />

      {/* EvidÃªncias */}
      <Card>
        <CardHeader>
          <div className="flex justify-between items-center">
            <CardTitle className="flex items-center gap-2">
              <FileText className="w-5 h-5" />
              EvidÃªncias de Cumprimento ({goal.evidences?.length || 0})
            </CardTitle>
            <Button
              variant="outline"
              size="sm"
              onClick={() => document.getElementById('evidence-file-input')?.click()}
            >
              <FileText className="w-4 h-4 mr-2" />
              Adicionar EvidÃªncia
            </Button>
            <input
              id="evidence-file-input"
              type="file"
              className="hidden"
              onChange={handleFileUpload}
              accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip"
            />
          </div>
        </CardHeader>
        <CardContent>
          {goal.evidences && goal.evidences.length > 0 ? (
            <div className="space-y-3">
              {goal.evidences.map((evidence: any) => (
                <div key={evidence.id} className="p-4 border rounded-lg">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <FileText className="w-4 h-4 text-blue-600" />
                        <span className="font-semibold">{evidence.attachmentName || "EvidÃªncia"}</span>
                        {evidence.isVerified && (
                          <Badge className="bg-green-500">
                            <CheckCircle2 className="w-3 h-3 mr-1" />
                            Verificado
                          </Badge>
                        )}
                      </div>
                      <p className="text-sm text-gray-700 mb-2">{evidence.description}</p>
                      <div className="flex items-center gap-4 text-xs text-gray-500">
                        <span>
                          Enviado em {format(new Date(evidence.uploadedAt), "dd/MM/yyyy 'Ã s' HH:mm", { locale: ptBR })}
                        </span>
                        {evidence.attachmentSize && (
                          <span>{(evidence.attachmentSize / 1024).toFixed(2)} KB</span>
                        )}
                      </div>
                    </div>
                    <div className="flex gap-2">
                      {evidence.attachmentUrl && (
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => window.open(evidence.attachmentUrl, '_blank')}
                        >
                          <Download className="w-4 h-4" />
                        </Button>
                      )}
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleDeleteEvidence(evidence.id)}
                        disabled={deleteEvidenceMutation.isPending}
                      >
                        <XCircle className="w-4 h-4 text-red-600" />
                      </Button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8 text-gray-500">
              <FileText className="w-12 h-12 mx-auto mb-2 text-gray-300" />
              <p>Nenhuma evidÃªncia adicionada ainda</p>
              <p className="text-xs mt-1">Adicione documentos, relatÃ³rios ou imagens que comprovem o cumprimento da meta</p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* ComentÃ¡rios */}
      <Card>
        <CardHeader>
          <div className="flex justify-between items-center">
            <CardTitle className="flex items-center gap-2">
              <MessageSquare className="w-5 h-5" />
              ComentÃ¡rios ({goal.comments?.length || 0})
            </CardTitle>
            <Dialog open={showCommentDialog} onOpenChange={setShowCommentDialog}>
              <DialogTrigger asChild>
                <Button variant="outline" size="sm">
                  <MessageSquare className="w-4 h-4 mr-2" />
                  Adicionar ComentÃ¡rio
                </Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>Adicionar ComentÃ¡rio</DialogTitle>
                  <DialogDescription>
                    Registre observaÃ§Ãµes, atualizaÃ§Ãµes ou feedback sobre esta meta
                  </DialogDescription>
                </DialogHeader>
                <div className="space-y-4">
                  <Textarea
                    placeholder="Digite seu comentÃ¡rio..."
                    value={commentText}
                    onChange={(e) => setCommentText(e.target.value)}
                    rows={4}
                  />
                  <div className="flex justify-end gap-2">
                    <Button variant="outline" onClick={() => setShowCommentDialog(false)}>
                      Cancelar
                    </Button>
                    <Button
                      onClick={handleAddComment}
                      disabled={addCommentMutation.isPending}
                      className="bg-[#F39200] hover:bg-[#d67e00]"
                    >
                      {addCommentMutation.isPending ? "Salvando..." : "Salvar"}
                    </Button>
                  </div>
                </div>
              </DialogContent>
            </Dialog>
          </div>
        </CardHeader>
        <CardContent>
          {goal.comments && goal.comments.length > 0 ? (
            <div className="space-y-3">
              {goal.comments.map((comment: any) => (
                <div key={comment.id} className="p-4 border rounded-lg">
                  <div className="flex items-center gap-2 mb-2">
                    <span className="font-semibold">{comment.authorName || "UsuÃ¡rio"}</span>
                    <span className="text-xs text-gray-500">
                      {format(new Date(comment.createdAt), "dd/MM/yyyy 'Ã s' HH:mm", { locale: ptBR })}
                    </span>
                  </div>
                  <p className="text-sm text-gray-700 whitespace-pre-wrap">{comment.comment}</p>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8 text-gray-500">
              <MessageSquare className="w-12 h-12 mx-auto mb-2 text-gray-300" />
              <p>Nenhum comentÃ¡rio ainda</p>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/EditarMeta.tsx
========================================
import { useState, useEffect } from "react";
import { useParams, useLocation } from "wouter";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { toast } from "sonner";
import { ArrowLeft, Save, AlertCircle } from "lucide-react";

/**
 * PÃ¡gina de EdiÃ§Ã£o de Meta em Rascunho
 * Permite editar metas que ainda nÃ£o foram enviadas para aprovaÃ§Ã£o
 */
export default function EditarMeta() {
  const { id } = useParams();
  const [, navigate] = useLocation();
  const goalId = parseInt(id || "0");

  // Buscar meta
  const { data: goal, isLoading } = trpc.smartGoals.getById.useQuery({ goalId });

  // Form state
  const [formData, setFormData] = useState({
    title: "",
    description: "",
    type: "individual" as "individual" | "team" | "organizational",
    category: "development" as "financial" | "behavioral" | "corporate" | "development",
    measurementUnit: "",
    targetValue: "",
    weight: "10",
    startDate: "",
    endDate: "",
    bonusEligible: false,
    bonusPercentage: "",
    bonusAmount: "",
  });

  // Atualizar meta
  const updateMutation = trpc.smartGoals.update.useMutation({
    onSuccess: () => {
      toast.success("Meta atualizada com sucesso!");
      navigate(`/metas/${goalId}`);
    },
    onError: (error: any) => {
      toast.error("Erro ao atualizar meta", {
        description: error.message,
      });
    },
  });

  // Preencher formulÃ¡rio quando meta carregar
  useEffect(() => {
    if (goal) {
      setFormData({
        title: goal.title,
        description: goal.description,
        type: goal.type,
        category: goal.category,
        measurementUnit: goal.measurementUnit || "",
        targetValue: goal.targetValue?.toString() || "",
        weight: goal.weight.toString(),
        startDate: goal.startDate instanceof Date ? goal.startDate.toISOString().split("T")[0] : goal.startDate,
        endDate: goal.endDate instanceof Date ? goal.endDate.toISOString().split("T")[0] : goal.endDate,
        bonusEligible: goal.bonusEligible,
        bonusPercentage: goal.bonusPercentage?.toString() || "",
        bonusAmount: goal.bonusAmount?.toString() || "",
      });
    }
  }, [goal]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!formData.title || !formData.description) {
      toast.error("Preencha os campos obrigatÃ³rios");
      return;
    }

    await updateMutation.mutateAsync({
      goalId,
      title: formData.title,
      description: formData.description,
      type: formData.type,
      category: formData.category,
      measurementUnit: formData.measurementUnit || undefined,
      targetValue: formData.targetValue ? parseFloat(formData.targetValue) : undefined,
      weight: parseInt(formData.weight),
      startDate: formData.startDate,
      endDate: formData.endDate,
      bonusEligible: formData.bonusEligible,
      bonusPercentage: formData.bonusPercentage ? parseFloat(formData.bonusPercentage) : undefined,
      bonusAmount: formData.bonusAmount ? parseFloat(formData.bonusAmount) : undefined,
    });
  };

  if (isLoading) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  if (!goal) {
    return (
      <div className="container mx-auto p-6">
        <Card>
          <CardContent className="text-center py-12">
            <AlertCircle className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">Meta nÃ£o encontrada</h3>
            <Button onClick={() => navigate("/metas")}>Voltar para Metas</Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (goal.status !== "draft") {
    return (
      <div className="container mx-auto p-6">
        <Card>
          <CardContent className="text-center py-12">
            <AlertCircle className="w-16 h-16 text-yellow-300 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">Meta nÃ£o editÃ¡vel</h3>
            <p className="text-gray-600 mb-4">
              Apenas metas em rascunho podem ser editadas
            </p>
            <Button onClick={() => navigate(`/metas/${goalId}`)}>Ver Detalhes</Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-6 max-w-4xl">
      {/* Header */}
      <div className="mb-6">
        <Button variant="ghost" onClick={() => navigate(`/metas/${goalId}`)} className="mb-4">
          <ArrowLeft className="w-4 h-4 mr-2" />
          Voltar
        </Button>
        <h1 className="text-3xl font-bold text-gray-900">Editar Meta</h1>
        <p className="text-gray-600 mt-1">Atualize as informaÃ§Ãµes da meta em rascunho</p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* InformaÃ§Ãµes BÃ¡sicas */}
        <Card>
          <CardHeader>
            <CardTitle>InformaÃ§Ãµes BÃ¡sicas</CardTitle>
            <CardDescription>TÃ­tulo, descriÃ§Ã£o e categoria da meta</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="title">TÃ­tulo da Meta *</Label>
              <Input
                id="title"
                value={formData.title}
                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                className="mt-1"
                required
              />
            </div>

            <div>
              <Label htmlFor="description">DescriÃ§Ã£o Detalhada *</Label>
              <Textarea
                id="description"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                rows={5}
                className="mt-1"
                required
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="type">Tipo de Meta</Label>
                <Select
                  value={formData.type}
                  onValueChange={(v: any) => setFormData({ ...formData, type: v })}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="individual">Individual</SelectItem>
                    <SelectItem value="team">Equipe</SelectItem>
                    <SelectItem value="organizational">Organizacional</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="category">Categoria</Label>
                <Select
                  value={formData.category}
                  onValueChange={(v: any) => setFormData({ ...formData, category: v })}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="financial">Financeira</SelectItem>
                    <SelectItem value="behavioral">Comportamental</SelectItem>
                    <SelectItem value="corporate">Corporativa</SelectItem>
                    <SelectItem value="development">Desenvolvimento</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* MÃ©tricas e Datas */}
        <Card>
          <CardHeader>
            <CardTitle>MÃ©tricas e Datas</CardTitle>
            <CardDescription>Como a meta serÃ¡ medida e o prazo</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="measurementUnit">Unidade de Medida</Label>
                <Input
                  id="measurementUnit"
                  placeholder="Ex: R$, %, unidades"
                  value={formData.measurementUnit}
                  onChange={(e) => setFormData({ ...formData, measurementUnit: e.target.value })}
                  className="mt-1"
                />
              </div>

              <div>
                <Label htmlFor="targetValue">Valor Alvo</Label>
                <Input
                  id="targetValue"
                  type="number"
                  placeholder="Ex: 100"
                  value={formData.targetValue}
                  onChange={(e) => setFormData({ ...formData, targetValue: e.target.value })}
                  className="mt-1"
                />
              </div>
            </div>

            <div>
              <Label htmlFor="weight">Peso da Meta (1-100)</Label>
              <Input
                id="weight"
                type="number"
                min="1"
                max="100"
                value={formData.weight}
                onChange={(e) => setFormData({ ...formData, weight: e.target.value })}
                className="mt-1"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="startDate">Data de InÃ­cio *</Label>
                <Input
                  id="startDate"
                  type="date"
                  value={formData.startDate}
                  onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                  className="mt-1"
                  required
                />
              </div>

              <div>
                <Label htmlFor="endDate">Data de TÃ©rmino *</Label>
                <Input
                  id="endDate"
                  type="date"
                  value={formData.endDate}
                  onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                  className="mt-1"
                  required
                />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* BÃ´nus */}
        <Card>
          <CardHeader>
            <CardTitle>BÃ´nus Financeiro</CardTitle>
            <CardDescription>Configure elegibilidade para bÃ´nus</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex items-center justify-between p-4 border rounded-lg">
              <div>
                <Label htmlFor="bonusEligible" className="text-base font-medium">
                  ElegÃ­vel para BÃ´nus
                </Label>
                <p className="text-sm text-gray-600 mt-1">
                  Ativar se esta meta deve contar para cÃ¡lculo de bÃ´nus
                </p>
              </div>
              <Switch
                id="bonusEligible"
                checked={formData.bonusEligible}
                onCheckedChange={(checked) => setFormData({ ...formData, bonusEligible: checked })}
              />
            </div>

            {formData.bonusEligible && (
              <div className="grid grid-cols-2 gap-4 p-4 bg-green-50 rounded-lg">
                <div>
                  <Label htmlFor="bonusPercentage">BÃ´nus Percentual (%)</Label>
                  <Input
                    id="bonusPercentage"
                    type="number"
                    step="0.01"
                    placeholder="Ex: 5.5"
                    value={formData.bonusPercentage}
                    onChange={(e) => setFormData({ ...formData, bonusPercentage: e.target.value })}
                    className="mt-1"
                  />
                </div>

                <div>
                  <Label htmlFor="bonusAmount">BÃ´nus Fixo (R$)</Label>
                  <Input
                    id="bonusAmount"
                    type="number"
                    step="0.01"
                    placeholder="Ex: 1000.00"
                    value={formData.bonusAmount}
                    onChange={(e) => setFormData({ ...formData, bonusAmount: e.target.value })}
                    className="mt-1"
                  />
                </div>
              </div>
            )}
          </CardContent>
        </Card>

        {/* AÃ§Ãµes */}
        <div className="flex justify-end gap-2">
          <Button type="button" variant="outline" onClick={() => navigate(`/metas/${goalId}`)}>
            Cancelar
          </Button>
          <Button
            type="submit"
            disabled={updateMutation.isPending}
            className="bg-[#F39200] hover:bg-[#d67e00]"
          >
            <Save className="w-4 h-4 mr-2" />
            {updateMutation.isPending ? "Salvando..." : "Salvar AlteraÃ§Ãµes"}
          </Button>
        </div>
      </form>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/EmailMetrics.tsx
========================================
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Loader2, Mail, CheckCircle2, XCircle, TrendingUp, ShieldAlert, BarChart3 } from "lucide-react";
import { Line, Pie, Bar } from "react-chartjs-2";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler,
} from "chart.js";

// Registrar componentes do Chart.js
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler
);

/**
 * Dashboard de MÃ©tricas de E-mail
 * VisualizaÃ§Ã£o de estatÃ­sticas de envio de e-mails
 */

export default function EmailMetrics() {
  const { user } = useAuth();

  // Buscar estatÃ­sticas agregadas
  const { data: stats, isLoading } = trpc.admin.getEmailStats.useQuery();

  // Verificar se Ã© admin
  if (user?.role !== "admin") {
    return (
      <DashboardLayout>
        <Alert variant="destructive">
          <ShieldAlert className="h-4 w-4" />
          <AlertDescription>
            Acesso negado: apenas administradores podem acessar esta pÃ¡gina.
          </AlertDescription>
        </Alert>
      </DashboardLayout>
    );
  }

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  if (!stats) {
    return (
      <DashboardLayout>
        <Alert>
          <Mail className="h-4 w-4" />
          <AlertDescription>
            Nenhuma mÃ©trica de e-mail disponÃ­vel ainda.
          </AlertDescription>
        </Alert>
      </DashboardLayout>
    );
  }

  // Preparar dados para grÃ¡fico de linha (histÃ³rico mensal)
  const lineChartData = {
    labels: stats.monthlyData.map(m => {
      const [year, month] = m.month.split('-');
      const date = new Date(parseInt(year), parseInt(month) - 1);
      return date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
    }),
    datasets: [
      {
        label: 'E-mails Enviados',
        data: stats.monthlyData.map(m => m.sent),
        borderColor: 'rgb(99, 102, 241)',
        backgroundColor: 'rgba(99, 102, 241, 0.1)',
        fill: true,
        tension: 0.4,
      },
      {
        label: 'Sucesso',
        data: stats.monthlyData.map(m => m.success),
        borderColor: 'rgb(34, 197, 94)',
        backgroundColor: 'rgba(34, 197, 94, 0.1)',
        fill: true,
        tension: 0.4,
      },
      {
        label: 'Falhas',
        data: stats.monthlyData.map(m => m.failed),
        borderColor: 'rgb(239, 68, 68)',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        fill: true,
        tension: 0.4,
      },
    ],
  };

  // Preparar dados para grÃ¡fico de pizza (sucesso vs falha)
  const pieChartData = {
    labels: ['Sucesso', 'Falha'],
    datasets: [
      {
        data: [stats.successful, stats.failed],
        backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)'],
        borderColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)'],
        borderWidth: 1,
      },
    ],
  };

  // Preparar dados para grÃ¡fico de barras (tipos de e-mail)
  const typeLabels = Object.keys(stats.byType);
  const typeCounts = Object.values(stats.byType);
  
  const barChartData = {
    labels: typeLabels.map(type => {
      // Traduzir tipos de e-mail
      const translations: Record<string, string> = {
        'goal_reminder': 'Lembrete de Meta',
        'evaluation_pending': 'AvaliaÃ§Ã£o Pendente',
        'action_overdue': 'AÃ§Ã£o Vencida',
        'pdi_approved': 'PDI Aprovado',
        'welcome': 'Boas-vindas',
        'password_reset': 'RedefiniÃ§Ã£o de Senha',
      };
      return translations[type] || type;
    }),
    datasets: [
      {
        label: 'Quantidade',
        data: typeCounts,
        backgroundColor: 'rgba(99, 102, 241, 0.8)',
        borderColor: 'rgb(99, 102, 241)',
        borderWidth: 1,
      },
    ],
  };

  const lineOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top' as const,
      },
      title: {
        display: true,
        text: 'HistÃ³rico Mensal de Envios',
      },
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          precision: 0,
        },
      },
    },
  };

  const pieOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom' as const,
      },
      title: {
        display: true,
        text: 'Taxa de Sucesso vs Falha',
      },
    },
  };

  const barOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: false,
      },
      title: {
        display: true,
        text: 'E-mails por Tipo',
      },
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          precision: 0,
        },
      },
    },
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
            <BarChart3 className="h-8 w-8" />
            MÃ©tricas de E-mail
          </h1>
          <p className="text-muted-foreground mt-2">
            Acompanhe estatÃ­sticas de envio de e-mails automÃ¡ticos
          </p>
        </div>

        {/* Cards de EstatÃ­sticas */}
        <div className="grid md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Total Enviado
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="flex items-center gap-2">
                <Mail className="h-4 w-4 text-primary" />
                <div className="text-2xl font-bold">{stats.total.toLocaleString('pt-BR')}</div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Sucesso
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="flex items-center gap-2">
                <CheckCircle2 className="h-4 w-4 text-green-600" />
                <div className="text-2xl font-bold text-green-600">
                  {stats.successful.toLocaleString('pt-BR')}
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Falhas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="flex items-center gap-2">
                <XCircle className="h-4 w-4 text-red-600" />
                <div className="text-2xl font-bold text-red-600">
                  {stats.failed.toLocaleString('pt-BR')}
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Taxa de Sucesso
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="flex items-center gap-2">
                <TrendingUp className="h-4 w-4 text-primary" />
                <div className="text-2xl font-bold">{stats.successRate}%</div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* GrÃ¡fico de Linha - HistÃ³rico Mensal */}
        <Card>
          <CardHeader>
            <CardTitle>HistÃ³rico Mensal</CardTitle>
            <CardDescription>
              Envios de e-mails nos Ãºltimos 12 meses
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div style={{ height: '300px' }}>
              <Line data={lineChartData} options={lineOptions} />
            </div>
          </CardContent>
        </Card>

        {/* GrÃ¡ficos de Pizza e Barras */}
        <div className="grid md:grid-cols-2 gap-6">
          <Card>
            <CardHeader>
              <CardTitle>Taxa de Sucesso</CardTitle>
              <CardDescription>
                ProporÃ§Ã£o de e-mails entregues com sucesso
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div style={{ height: '300px' }}>
                <Pie data={pieChartData} options={pieOptions} />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Tipos de E-mail</CardTitle>
              <CardDescription>
                DistribuiÃ§Ã£o por tipo de notificaÃ§Ã£o
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div style={{ height: '300px' }}>
                <Bar data={barChartData} options={barOptions} />
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/EnviarTestes.tsx
========================================
import { useState } from "react";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Loader2, Mail, Send, Users, Building2, CheckCircle2, XCircle, Brain } from "lucide-react";
import { Checkbox } from "@/components/ui/checkbox";

/**
 * PÃ¡gina de Envio de Testes PsicomÃ©tricos
 * Permite RH enviar convites de testes para funcionÃ¡rios, equipes ou departamentos
 */

const TESTS = [
  { value: "disc", label: "DISC - AvaliaÃ§Ã£o Comportamental", time: "10-15 min", questions: 40 },
  { value: "bigfive", label: "Big Five (OCEAN) - Personalidade", time: "12-18 min", questions: 50 },
  { value: "mbti", label: "MBTI - Tipo de Personalidade", time: "8-12 min", questions: 40 },
  { value: "ie", label: "InteligÃªncia Emocional (Goleman)", time: "15-20 min", questions: 40 },
  { value: "vark", label: "VARK - Estilos de Aprendizagem", time: "8-10 min", questions: 40 },
  { value: "leadership", label: "Estilos de LideranÃ§a", time: "10-12 min", questions: 30 },
  { value: "careeranchors", label: "Ã‚ncoras de Carreira (Schein)", time: "12-15 min", questions: 40 },
];

export default function EnviarTestes() {
  const { user } = useAuth();
  const [selectedTest, setSelectedTest] = useState<string>("");
  const [selectedEmails, setSelectedEmails] = useState<string[]>([]);
  const [manualEmail, setManualEmail] = useState("");
  const [sendingIndividual, setSendingIndividual] = useState(false);
  const [sendingTeam, setSendingTeam] = useState(false);
  const [sendingDepartment, setSendingDepartment] = useState(false);
  const [results, setResults] = useState<any[]>([]);

  // Buscar funcionÃ¡rios
  const { data: employees, isLoading: loadingEmployees } = trpc.employees.list.useQuery();

  // Buscar departamentos
  const { data: departments, isLoading: loadingDepartments } = trpc.departments.list.useQuery();

  // Mutation para enviar convites
  const sendInviteMutation = trpc.psychometric.sendTestInvite.useMutation({
    onSuccess: (data) => {
      setResults(data.results);
      const successCount = data.results.filter((r: any) => r.success).length;
      toast.success(`${successCount} convite(s) enviado(s) com sucesso!`);
      setSendingIndividual(false);
      setSendingTeam(false);
      setSendingDepartment(false);
      setSelectedEmails([]);
      setManualEmail("");
    },
    onError: (error) => {
      toast.error(`Erro ao enviar convites: ${error.message}`);
      setSendingIndividual(false);
      setSendingTeam(false);
      setSendingDepartment(false);
    },
  });

  const handleSendIndividual = () => {
    if (!selectedTest) {
      toast.error("Selecione um teste");
      return;
    }
    if (!manualEmail || !manualEmail.includes('@')) {
      toast.error("Insira um email vÃ¡lido");
      return;
    }

    setSendingIndividual(true);
    sendInviteMutation.mutate({
      testType: selectedTest as any,
      emails: [manualEmail],
    });
  };

  const handleSendToSelected = () => {
    if (!selectedTest) {
      toast.error("Selecione um teste");
      return;
    }
    if (selectedEmails.length === 0) {
      toast.error("Selecione pelo menos um funcionÃ¡rio");
      return;
    }

    setSendingTeam(true);
    sendInviteMutation.mutate({
      testType: selectedTest as any,
      emails: selectedEmails,
    });
  };

  const handleSendToDepartment = (departmentId: number) => {
    if (!selectedTest) {
      toast.error("Selecione um teste");
      return;
    }

    const deptEmployees = employees?.filter(e => e.employee.departmentId === departmentId && e.employee.status === 'ativo') || [];
    const emails = deptEmployees.map(e => e.employee.email).filter(Boolean) as string[];

    if (emails.length === 0) {
      toast.error("Nenhum funcionÃ¡rio ativo com email neste departamento");
      return;
    }

    setSendingDepartment(true);
    sendInviteMutation.mutate({
      testType: selectedTest as any,
      emails,
    });
  };

  const toggleEmployeeSelection = (email: string) => {
    setSelectedEmails(prev =>
      prev.includes(email)
        ? prev.filter(e => e !== email)
        : [...prev, email]
    );
  };

  const selectAllEmployees = () => {
    const allEmails = employees?.filter(e => e.employee.status === 'ativo' && e.employee.email).map(e => e.employee.email) as string[];
    setSelectedEmails(allEmails || []);
  };

  const deselectAllEmployees = () => {
    setSelectedEmails([]);
  };

  if (user?.role !== 'admin') {
    return (
      <DashboardLayout>
        <Card>
          <CardHeader>
            <CardTitle>Acesso Negado</CardTitle>
            <CardDescription>Apenas administradores podem enviar testes</CardDescription>
          </CardHeader>
        </Card>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
            <Mail className="h-8 w-8" />
            Enviar Testes PsicomÃ©tricos
          </h1>
          <p className="text-muted-foreground mt-2">
            Envie convites de testes para funcionÃ¡rios, equipes ou departamentos
          </p>
        </div>

        {/* SeleÃ§Ã£o de Teste */}
        <Card className="border-orange-200 bg-gradient-to-r from-orange-50 to-yellow-50">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Brain className="h-5 w-5 text-orange-600" />
              Selecione o Teste
            </CardTitle>
            <CardDescription>Escolha qual teste psicomÃ©trico deseja enviar</CardDescription>
          </CardHeader>
          <CardContent>
            <Select value={selectedTest} onValueChange={setSelectedTest}>
              <SelectTrigger>
                <SelectValue placeholder="Selecione um teste..." />
              </SelectTrigger>
              <SelectContent>
                {TESTS.map(test => (
                  <SelectItem key={test.value} value={test.value}>
                    {test.label} Â· {test.questions} perguntas Â· {test.time}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </CardContent>
        </Card>

        {/* Tabs de Envio */}
        <Tabs defaultValue="individual" className="space-y-4">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="individual">Individual</TabsTrigger>
            <TabsTrigger value="team">Equipe/MÃºltiplos</TabsTrigger>
            <TabsTrigger value="department">Departamento</TabsTrigger>
          </TabsList>

          {/* Envio Individual */}
          <TabsContent value="individual">
            <Card>
              <CardHeader>
                <CardTitle>Enviar para FuncionÃ¡rio Individual</CardTitle>
                <CardDescription>Insira o email do colaborador</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="email">Email do Colaborador</Label>
                  <Input
                    id="email"
                    type="email"
                    placeholder="colaborador@empresa.com"
                    value={manualEmail}
                    onChange={(e) => setManualEmail(e.target.value)}
                  />
                </div>
                <Button
                  onClick={handleSendIndividual}
                  disabled={sendingIndividual || !selectedTest}
                  className="w-full"
                >
                  {sendingIndividual ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Enviando...
                    </>
                  ) : (
                    <>
                      <Send className="w-4 h-4 mr-2" />
                      Enviar Convite
                    </>
                  )}
                </Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Envio para Equipe/MÃºltiplos */}
          <TabsContent value="team">
            <Card>
              <CardHeader>
                <CardTitle>Enviar para MÃºltiplos FuncionÃ¡rios</CardTitle>
                <CardDescription>
                  Selecione os colaboradores que receberÃ£o o teste
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={selectAllEmployees}
                  >
                    Selecionar Todos
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={deselectAllEmployees}
                  >
                    Limpar SeleÃ§Ã£o
                  </Button>
                  <Badge variant="secondary" className="ml-auto">
                    {selectedEmails.length} selecionados
                  </Badge>
                </div>

                {loadingEmployees ? (
                  <div className="flex items-center justify-center py-8">
                    <Loader2 className="w-6 h-6 animate-spin" />
                  </div>
                ) : (
                  <div className="border rounded-lg max-h-96 overflow-y-auto">
                    <div className="divide-y">
                      {employees?.filter(e => e.employee.status === 'ativo' && e.employee.email).map(employee => (
                        <div
                          key={employee.employee.id}
                          className="flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer"
                          onClick={() => toggleEmployeeSelection(employee.employee.email!)}
                        >
                          <Checkbox
                            checked={selectedEmails.includes(employee.employee.email!)}
                            onCheckedChange={() => toggleEmployeeSelection(employee.employee.email!)}
                          />
                          <div className="flex-1">
                            <div className="font-medium">{employee.employee.name}</div>
                            <div className="text-sm text-muted-foreground">{employee.employee.email}</div>
                          </div>
                          <Badge variant="outline">{employee.position?.title}</Badge>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <Button
                  onClick={handleSendToSelected}
                  disabled={sendingTeam || !selectedTest || selectedEmails.length === 0}
                  className="w-full"
                >
                  {sendingTeam ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Enviando...
                    </>
                  ) : (
                    <>
                      <Send className="w-4 h-4 mr-2" />
                      Enviar para {selectedEmails.length} FuncionÃ¡rio(s)
                    </>
                  )}
                </Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Envio para Departamento */}
          <TabsContent value="department">
            <Card>
              <CardHeader>
                <CardTitle>Enviar para Departamento Inteiro</CardTitle>
                <CardDescription>
                  Todos os funcionÃ¡rios ativos do departamento receberÃ£o o teste
                </CardDescription>
              </CardHeader>
              <CardContent>
                {loadingDepartments ? (
                  <div className="flex items-center justify-center py-8">
                    <Loader2 className="w-6 h-6 animate-spin" />
                  </div>
                ) : (
                  <div className="space-y-3">
                    {departments?.map(dept => {
                      const deptEmployees = employees?.filter(
                        e => e.employee.departmentId === dept.id && e.employee.status === 'ativo' && e.employee.email
                      ) || [];
                      return (
                        <Card key={dept.id} className="border-gray-200">
                          <CardContent className="flex items-center justify-between p-4">
                            <div className="flex items-center gap-3">
                              <Building2 className="h-5 w-5 text-gray-500" />
                              <div>
                                <div className="font-medium">{dept.name}</div>
                                <div className="text-sm text-muted-foreground">
                                  {deptEmployees.length} funcionÃ¡rio(s) ativo(s)
                                </div>
                              </div>
                            </div>
                            <Button
                              onClick={() => handleSendToDepartment(dept.id)}
                              disabled={sendingDepartment || !selectedTest || deptEmployees.length === 0}
                              size="sm"
                            >
                              {sendingDepartment ? (
                                <Loader2 className="w-4 h-4 animate-spin" />
                              ) : (
                                <>
                                  <Send className="w-4 h-4 mr-2" />
                                  Enviar
                                </>
                              )}
                            </Button>
                          </CardContent>
                        </Card>
                      );
                    })}
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* Resultados do Envio */}
        {results.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <CheckCircle2 className="h-5 w-5 text-green-600" />
                Resultados do Envio
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                {results.map((result, index) => (
                  <div
                    key={index}
                    className={`flex items-center justify-between p-3 rounded-lg border ${
                      result.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      {result.success ? (
                        <CheckCircle2 className="h-4 w-4 text-green-600" />
                      ) : (
                        <XCircle className="h-4 w-4 text-red-600" />
                      )}
                      <span className="font-medium">{result.email}</span>
                    </div>
                    <span className="text-sm text-muted-foreground">{result.message}</span>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/ExecutiveDashboard.tsx
========================================
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { useState } from "react";
import { Users, TrendingUp, Award, Target, DollarSign, Briefcase, AlertCircle } from "lucide-react";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { CostCenterFilter } from "@/components/CostCenterFilter";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler,
} from "chart.js";
import { Line, Bar, Doughnut } from "react-chartjs-2";

// Registrar componentes do Chart.js
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler
);

/**
 * Dashboard Executivo
 * MÃ©tricas estratÃ©gicas para tomada de decisÃ£o da diretoria
 */
export default function ExecutiveDashboard() {
  const { user, loading } = useAuth();
  const [selectedDepartment, setSelectedDepartment] = useState<number | undefined>(undefined);
  const [selectedCostCenter, setSelectedCostCenter] = useState<string>("all");

  // Queries - DEVEM estar antes dos returns condicionais (regra dos React Hooks)
  const { data: kpis, isLoading: loadingKPIs } = trpc.executive.getKPIs.useQuery({
    departmentId: selectedDepartment,
    costCenter: selectedCostCenter !== 'all' ? selectedCostCenter : undefined,
  }, { enabled: !loading && user?.role === 'admin' });

  const { data: headcountByDept, isLoading: loadingHeadcount } =
    trpc.executive.getHeadcountByDepartment.useQuery({
      costCenter: selectedCostCenter !== 'all' ? selectedCostCenter : undefined,
    }, { enabled: !loading && user?.role === 'admin' });

  const { data: headcountTrend, isLoading: loadingTrend } = trpc.executive.getHeadcountTrend.useQuery({
    costCenter: selectedCostCenter !== 'all' ? selectedCostCenter : undefined,
  }, { enabled: !loading && user?.role === 'admin' });

  const { data: salaryDistribution, isLoading: loadingSalary } =
    trpc.executive.getSalaryDistribution.useQuery({
      costCenter: selectedCostCenter !== 'all' ? selectedCostCenter : undefined,
    }, { enabled: !loading && user?.role === 'admin' });

  const { data: turnoverRate, isLoading: loadingTurnover } = trpc.executive.getTurnoverRate.useQuery({
    costCenter: selectedCostCenter !== 'all' ? selectedCostCenter : undefined,
  }, { enabled: !loading && user?.role === 'admin' });

  const { data: successionPipeline, isLoading: loadingSuccession } =
    trpc.executive.getSuccessionPipeline.useQuery({
      costCenter: selectedCostCenter !== 'all' ? selectedCostCenter : undefined,
    }, { enabled: !loading && user?.role === 'admin' });

  const { data: trainingROI, isLoading: loadingROI } = trpc.executive.getTrainingROI.useQuery({
    costCenter: selectedCostCenter !== 'all' ? selectedCostCenter : undefined,
  }, { enabled: !loading && user?.role === 'admin' });

  const { data: performanceDistribution, isLoading: loadingPerformance } =
    trpc.executive.getPerformanceDistribution.useQuery({
      costCenter: selectedCostCenter !== 'all' ? selectedCostCenter : undefined,
    }, { enabled: !loading && user?.role === 'admin' });

  const { data: engagement, isLoading: loadingEngagement } = trpc.executive.getEngagementMetrics.useQuery({
    costCenter: selectedCostCenter !== 'all' ? selectedCostCenter : undefined,
  }, { enabled: !loading && user?.role === 'admin' });

  // Verificar se usuÃ¡rio Ã© admin
  if (!loading && (!user || user.role !== "admin")) {
    return (
      <DashboardLayout>
        <div className="flex flex-col items-center justify-center min-h-[60vh] space-y-4">
          <AlertCircle className="h-16 w-16 text-destructive" />
          <h2 className="text-2xl font-bold">Acesso Negado</h2>
          <p className="text-muted-foreground text-center max-w-md">
            Apenas administradores podem acessar o Dashboard Executivo.
          </p>
        </div>
      </DashboardLayout>
    );
  }

  if (loading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center min-h-[60vh]">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p className="text-muted-foreground">Carregando...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  // ConfiguraÃ§Ãµes dos grÃ¡ficos
  const headcountTrendData = {
    labels: headcountTrend?.map((d) => d.month) || [],
    datasets: [
      {
        label: "Total de Colaboradores",
        data: headcountTrend?.map((d) => d.total) || [],
        borderColor: "rgb(59, 130, 246)",
        backgroundColor: "rgba(59, 130, 246, 0.1)",
        fill: true,
        tension: 0.4,
      },
    ],
  };

  const headcountByDeptData = {
    labels: headcountByDept?.slice(0, 10).map((d) => d.department) || [],
    datasets: [
      {
        label: "Colaboradores",
        data: headcountByDept?.slice(0, 10).map((d) => d.count) || [],
        backgroundColor: [
          "rgba(59, 130, 246, 0.8)",
          "rgba(16, 185, 129, 0.8)",
          "rgba(245, 158, 11, 0.8)",
          "rgba(239, 68, 68, 0.8)",
          "rgba(139, 92, 246, 0.8)",
          "rgba(236, 72, 153, 0.8)",
          "rgba(20, 184, 166, 0.8)",
          "rgba(251, 146, 60, 0.8)",
          "rgba(168, 85, 247, 0.8)",
          "rgba(34, 197, 94, 0.8)",
        ],
      },
    ],
  };

  const salaryDistributionData = {
    labels: salaryDistribution?.map((d) => d.range) || [],
    datasets: [
      {
        label: "Colaboradores",
        data: salaryDistribution?.map((d) => d.count) || [],
        backgroundColor: "rgba(16, 185, 129, 0.8)",
      },
    ],
  };

  const turnoverRateData = {
    labels: turnoverRate?.map((d) => d.month) || [],
    datasets: [
      {
        label: "Taxa de Turnover (%)",
        data: turnoverRate?.map((d) => d.rate) || [],
        borderColor: "rgb(239, 68, 68)",
        backgroundColor: "rgba(239, 68, 68, 0.1)",
        fill: true,
        tension: 0.4,
      },
    ],
  };

  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: "top" as const,
      },
    },
  };

  return (
    <div className="container mx-auto py-8">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
          <h1 className="text-3xl font-bold">Dashboard Executivo</h1>
          <p className="text-muted-foreground">MÃ©tricas estratÃ©gicas para tomada de decisÃ£o</p>
        </div>

        {/* Filtro de Centro de Custos */}
        <CostCenterFilter
          value={selectedCostCenter}
          onChange={setSelectedCostCenter}
          showLabel={false}
        />
      </div>

      {/* KPIs Principais */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total de Colaboradores</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{kpis?.totalEmployees || 0}</div>
            <p className="text-xs text-muted-foreground">
              {kpis?.activeEmployees || 0} ativos
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Performance MÃ©dia</CardTitle>
            <TrendingUp className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {kpis?.avgPerformanceScore && typeof kpis.avgPerformanceScore === 'number' ? kpis.avgPerformanceScore.toFixed(2) : "0.00"}
            </div>
            <p className="text-xs text-muted-foreground">Escala de 1 a 5</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Alto Potencial</CardTitle>
            <Award className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{kpis?.highPotentialCount || 0}</div>
            <p className="text-xs text-muted-foreground">
              {kpis?.totalEmployees
                ? ((kpis.highPotentialCount / kpis.totalEmployees) * 100).toFixed(1)
                : 0}
              % do total
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Taxa de Turnover</CardTitle>
            <Target className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{kpis?.turnoverRate && typeof kpis.turnoverRate === 'number' ? kpis.turnoverRate.toFixed(2) : "0.00"}%</div>
            <p className="text-xs text-muted-foreground">Ãšltimos 12 meses</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ROI de Treinamentos</CardTitle>
            <DollarSign className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{trainingROI?.estimatedROI || 0}%</div>
            <p className="text-xs text-muted-foreground">
              {trainingROI?.totalTrainings || 0} treinamentos concluÃ­dos
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Cobertura de SucessÃ£o</CardTitle>
            <Briefcase className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{kpis?.successionCoverage || 0}</div>
            <p className="text-xs text-muted-foreground">PosiÃ§Ãµes crÃ­ticas cobertas</p>
          </CardContent>
        </Card>
      </div>

      {/* GrÃ¡ficos */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        {/* EvoluÃ§Ã£o de Headcount */}
        <Card>
          <CardHeader>
            <CardTitle>EvoluÃ§Ã£o de Headcount</CardTitle>
            <CardDescription>Ãšltimos 12 meses</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {loadingTrend ? (
                <div className="flex items-center justify-center h-full">Carregando...</div>
              ) : (
                <Line data={headcountTrendData} options={chartOptions} />
              )}
            </div>
          </CardContent>
        </Card>

        {/* DistribuiÃ§Ã£o por Departamento */}
        <Card>
          <CardHeader>
            <CardTitle>Top 10 Departamentos</CardTitle>
            <CardDescription>Por nÃºmero de colaboradores</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {loadingHeadcount ? (
                <div className="flex items-center justify-center h-full">Carregando...</div>
              ) : (
                <Bar
                  data={headcountByDeptData}
                  options={{
                    ...chartOptions,
                    indexAxis: "y" as const,
                  }}
                />
              )}
            </div>
          </CardContent>
        </Card>

        {/* Taxa de Turnover */}
        <Card>
          <CardHeader>
            <CardTitle>Taxa de Turnover Mensal</CardTitle>
            <CardDescription>Ãšltimos 12 meses</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {loadingTurnover ? (
                <div className="flex items-center justify-center h-full">Carregando...</div>
              ) : (
                <Line data={turnoverRateData} options={chartOptions} />
              )}
            </div>
          </CardContent>
        </Card>

        {/* DistribuiÃ§Ã£o Salarial */}
        <Card>
          <CardHeader>
            <CardTitle>DistribuiÃ§Ã£o Salarial</CardTitle>
            <CardDescription>Por faixa de remuneraÃ§Ã£o</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {loadingSalary ? (
                <div className="flex items-center justify-center h-full">Carregando...</div>
              ) : (
                <Bar data={salaryDistributionData} options={chartOptions} />
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Pipeline de SucessÃ£o e Engajamento */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Pipeline de SucessÃ£o CrÃ­tica */}
        <Card>
          <CardHeader>
            <CardTitle>Pipeline de SucessÃ£o CrÃ­tica</CardTitle>
            <CardDescription>PosiÃ§Ãµes crÃ­ticas e nÃ­vel de risco</CardDescription>
          </CardHeader>
          <CardContent>
            {loadingSuccession ? (
              <div className="text-center py-8">Carregando...</div>
            ) : successionPipeline && successionPipeline.length > 0 ? (
              <div className="space-y-4">
                {successionPipeline.slice(0, 5).map((item, index) => (
                  <div key={index} className="flex items-center justify-between p-3 bg-muted rounded-lg">
                    <div>
                      <p className="font-medium">{item.position}</p>
                      <p className="text-sm text-muted-foreground">Status: {item.status}</p>
                    </div>
                    <div
                      className={`px-3 py-1 rounded-full text-xs font-medium ${
                        item.riskLevel === "critico"
                          ? "bg-red-100 text-red-800"
                          : item.riskLevel === "alto"
                          ? "bg-orange-100 text-orange-800"
                          : item.riskLevel === "medio"
                          ? "bg-yellow-100 text-yellow-800"
                          : "bg-green-100 text-green-800"
                      }`}
                    >
                      {item.riskLevel.toUpperCase()}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-muted-foreground">
                Nenhum plano de sucessÃ£o crÃ­tico encontrado
              </div>
            )}
          </CardContent>
        </Card>

        {/* MÃ©tricas de Engajamento */}
        <Card>
          <CardHeader>
            <CardTitle>MÃ©tricas de Engajamento</CardTitle>
            <CardDescription>ParticipaÃ§Ã£o em metas e PDI</CardDescription>
          </CardHeader>
          <CardContent>
            {loadingEngagement ? (
              <div className="text-center py-8">Carregando...</div>
            ) : (
              <div className="space-y-6">
                <div>
                  <div className="flex justify-between mb-2">
                    <span className="text-sm font-medium">Colaboradores com Metas</span>
                    <span className="text-sm font-bold">{engagement?.goalsEngagement || 0}%</span>
                  </div>
                  <div className="w-full bg-muted rounded-full h-2">
                    <div
                      className="bg-blue-600 h-2 rounded-full"
                      style={{ width: `${engagement?.goalsEngagement || 0}%` }}
                    />
                  </div>
                </div>

                <div>
                  <div className="flex justify-between mb-2">
                    <span className="text-sm font-medium">Colaboradores com PDI</span>
                    <span className="text-sm font-bold">{engagement?.pdiEngagement || 0}%</span>
                  </div>
                  <div className="w-full bg-muted rounded-full h-2">
                    <div
                      className="bg-green-600 h-2 rounded-full"
                      style={{ width: `${engagement?.pdiEngagement || 0}%` }}
                    />
                  </div>
                </div>

                <div className="mt-6 p-4 bg-muted rounded-lg">
                  <p className="text-sm text-muted-foreground">Total de Colaboradores Ativos</p>
                  <p className="text-2xl font-bold">{engagement?.totalActive || 0}</p>
                </div>

                {trainingROI && (
                  <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                    <p className="text-sm font-medium mb-2">Impacto de Treinamentos</p>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <p className="text-muted-foreground">Performance Antes</p>
                        <p className="font-bold">{typeof trainingROI.avgPerformanceBefore === 'number' ? trainingROI.avgPerformanceBefore.toFixed(2) : '0.00'}</p>
                      </div>
                      <div>
                        <p className="text-muted-foreground">Performance Depois</p>
                        <p className="font-bold">{typeof trainingROI.avgPerformanceAfter === 'number' ? trainingROI.avgPerformanceAfter.toFixed(2) : '0.00'}</p>
                      </div>
                    </div>
                    <p className="text-xs text-green-600 mt-2">
                      +{typeof trainingROI.improvementPercent === 'number' ? trainingROI.improvementPercent.toFixed(1) : '0.0'}% de melhoria
                    </p>
                  </div>
                )}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/Feedbacks.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { trpc } from "@/lib/trpc";
import { MessageSquare, ThumbsUp, AlertCircle, TrendingUp, Plus } from "lucide-react";
import { toast } from "sonner";
import { useAuth } from "@/_core/hooks/useAuth";

export default function Feedbacks() {
  const { user } = useAuth();
  const [selectedEmployee, setSelectedEmployee] = useState<number | undefined>();
  const [filterType, setFilterType] = useState<"positivo" | "construtivo" | "desenvolvimento" | undefined>();
  const [isDialogOpen, setIsDialogOpen] = useState(false);

  // Form state
  const [formData, setFormData] = useState({
    employeeId: "",
    type: "positivo" as "positivo" | "construtivo" | "desenvolvimento",
    category: "",
    content: "",
    context: "",
    actionItems: "",
    isPrivate: false,
  });

  const { data: employees } = trpc.employees.list.useQuery();
  const { data: feedbacks, refetch } = trpc.feedback.list.useQuery({
    employeeId: selectedEmployee,
    type: filterType,
  });
  const { data: stats } = trpc.feedback.getStats.useQuery({
    employeeId: selectedEmployee,
  });

  const createMutation = trpc.feedback.create.useMutation({
    onSuccess: () => {
      toast.success("Feedback registrado com sucesso!");
      setIsDialogOpen(false);
      refetch();
      // Reset form
      setFormData({
        employeeId: "",
        type: "positivo",
        category: "",
        content: "",
        context: "",
        actionItems: "",
        isPrivate: false,
      });
    },
    onError: (error) => {
      toast.error(`Erro ao registrar feedback: ${error.message}`);
    },
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.employeeId || !formData.content) {
      toast.error("Preencha os campos obrigatÃ³rios");
      return;
    }

    createMutation.mutate({
      employeeId: parseInt(formData.employeeId),
      type: formData.type,
      category: formData.category || undefined,
      content: formData.content,
      context: formData.context || undefined,
      actionItems: formData.actionItems || undefined,
      isPrivate: formData.isPrivate,
    });
  };

  const getTypeIcon = (type: string) => {
    switch (type) {
      case "positivo":
        return <ThumbsUp className="h-4 w-4" />;
      case "construtivo":
        return <AlertCircle className="h-4 w-4" />;
      case "desenvolvimento":
        return <TrendingUp className="h-4 w-4" />;
      default:
        return <MessageSquare className="h-4 w-4" />;
    }
  };

  const getTypeBadge = (type: string) => {
    const variants: Record<string, "default" | "secondary" | "destructive"> = {
      positivo: "default",
      construtivo: "secondary",
      desenvolvimento: "destructive",
    };
    return variants[type] || "default";
  };

  return (
    <div className="container py-6 space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold">Feedback ContÃ­nuo</h1>
          <p className="text-muted-foreground">
            Registre e acompanhe feedbacks 1-on-1 com colaboradores
          </p>
        </div>
        {user?.role !== "colaborador" && (
          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
            <DialogTrigger asChild>
              <Button>
                <Plus className="h-4 w-4 mr-2" />
                Novo Feedback
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-2xl">
              <DialogHeader>
                <DialogTitle>Registrar Novo Feedback</DialogTitle>
                <DialogDescription>
                  Registre um feedback para um colaborador
                </DialogDescription>
              </DialogHeader>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <Label htmlFor="employeeId">Colaborador *</Label>
                  <Select
                    value={formData.employeeId}
                    onValueChange={(value) => setFormData({ ...formData, employeeId: value })}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Selecione um colaborador" />
                    </SelectTrigger>
                    <SelectContent>
                      {employees?.map((item) => (
                        <SelectItem key={item.employee.id} value={item.employee.id.toString()}>
                          {item.employee.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="type">Tipo *</Label>
                    <Select
                      value={formData.type}
                      onValueChange={(value: any) => setFormData({ ...formData, type: value })}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="positivo">Positivo</SelectItem>
                        <SelectItem value="construtivo">Construtivo</SelectItem>
                        <SelectItem value="desenvolvimento">Desenvolvimento</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="category">Categoria</Label>
                    <Input
                      id="category"
                      placeholder="Ex: ComunicaÃ§Ã£o, LideranÃ§a"
                      value={formData.category}
                      onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                    />
                  </div>
                </div>

                <div>
                  <Label htmlFor="content">ConteÃºdo do Feedback *</Label>
                  <Textarea
                    id="content"
                    placeholder="Descreva o feedback de forma clara e objetiva"
                    rows={4}
                    value={formData.content}
                    onChange={(e) => setFormData({ ...formData, content: e.target.value })}
                  />
                </div>

                <div>
                  <Label htmlFor="context">Contexto/SituaÃ§Ã£o</Label>
                  <Textarea
                    id="context"
                    placeholder="Descreva o contexto ou situaÃ§Ã£o especÃ­fica"
                    rows={3}
                    value={formData.context}
                    onChange={(e) => setFormData({ ...formData, context: e.target.value })}
                  />
                </div>

                <div>
                  <Label htmlFor="actionItems">AÃ§Ãµes Recomendadas</Label>
                  <Textarea
                    id="actionItems"
                    placeholder="Liste aÃ§Ãµes ou prÃ³ximos passos recomendados"
                    rows={3}
                    value={formData.actionItems}
                    onChange={(e) => setFormData({ ...formData, actionItems: e.target.value })}
                  />
                </div>

                <div className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="isPrivate"
                    checked={formData.isPrivate}
                    onChange={(e) => setFormData({ ...formData, isPrivate: e.target.checked })}
                    className="rounded"
                  />
                  <Label htmlFor="isPrivate" className="cursor-pointer">
                    Feedback privado (visÃ­vel apenas para gestor e colaborador)
                  </Label>
                </div>

                <div className="flex justify-end space-x-2">
                  <Button type="button" variant="outline" onClick={() => setIsDialogOpen(false)}>
                    Cancelar
                  </Button>
                  <Button type="submit" disabled={createMutation.isPending}>
                    {createMutation.isPending ? "Salvando..." : "Salvar Feedback"}
                  </Button>
                </div>
              </form>
            </DialogContent>
          </Dialog>
        )}
      </div>

      {/* EstatÃ­sticas */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total de Feedbacks</CardTitle>
            <MessageSquare className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats?.total || 0}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Positivos</CardTitle>
            <ThumbsUp className="h-4 w-4 text-green-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">{stats?.positivo || 0}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Construtivos</CardTitle>
            <AlertCircle className="h-4 w-4 text-yellow-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-yellow-600">{stats?.construtivo || 0}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Desenvolvimento</CardTitle>
            <TrendingUp className="h-4 w-4 text-blue-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-blue-600">{stats?.desenvolvimento || 0}</div>
          </CardContent>
        </Card>
      </div>

      {/* Filtros */}
      <Card>
        <CardHeader>
          <CardTitle>Filtros</CardTitle>
        </CardHeader>
        <CardContent className="flex gap-4">
          <div className="flex-1">
            <Label>Colaborador</Label>
            <Select
              value={selectedEmployee?.toString()}
              onValueChange={(value) => setSelectedEmployee(value ? parseInt(value) : undefined)}
            >
              <SelectTrigger>
                <SelectValue placeholder="Todos os colaboradores" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todos</SelectItem>
                {employees?.map((item) => (
                  <SelectItem key={item.employee.id} value={item.employee.id.toString()}>
                    {item.employee.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="flex-1">
            <Label>Tipo</Label>
            <Select
              value={filterType}
              onValueChange={(value: any) => setFilterType(value === "all" ? undefined : value)}
            >
              <SelectTrigger>
                <SelectValue placeholder="Todos os tipos" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todos</SelectItem>
                <SelectItem value="positivo">Positivo</SelectItem>
                <SelectItem value="construtivo">Construtivo</SelectItem>
                <SelectItem value="desenvolvimento">Desenvolvimento</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardContent>
      </Card>

      {/* Lista de Feedbacks */}
      <Card>
        <CardHeader>
          <CardTitle>HistÃ³rico de Feedbacks</CardTitle>
          <CardDescription>
            {feedbacks?.length || 0} feedback(s) encontrado(s)
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {feedbacks && feedbacks.length > 0 ? (
            feedbacks.map((item) => (
              <Card key={item.feedback.id}>
                <CardHeader>
                  <div className="flex justify-between items-start">
                    <div className="flex items-center gap-2">
                      {getTypeIcon(item.feedback.type)}
                      <div>
                        <CardTitle className="text-base">{item.employee?.name}</CardTitle>
                        <CardDescription>
                          {new Date(item.feedback.createdAt).toLocaleDateString("pt-BR")}
                          {item.feedback.category && ` â€¢ ${item.feedback.category}`}
                        </CardDescription>
                      </div>
                    </div>
                    <Badge variant={getTypeBadge(item.feedback.type)}>
                      {item.feedback.type}
                    </Badge>
                  </div>
                </CardHeader>
                <CardContent className="space-y-2">
                  <div>
                    <p className="text-sm font-medium">Feedback:</p>
                    <p className="text-sm text-muted-foreground">{item.feedback.content}</p>
                  </div>
                  {item.feedback.context && (
                    <div>
                      <p className="text-sm font-medium">Contexto:</p>
                      <p className="text-sm text-muted-foreground">{item.feedback.context}</p>
                    </div>
                  )}
                  {item.feedback.actionItems && (
                    <div>
                      <p className="text-sm font-medium">AÃ§Ãµes Recomendadas:</p>
                      <p className="text-sm text-muted-foreground">{item.feedback.actionItems}</p>
                    </div>
                  )}
                </CardContent>
              </Card>
            ))
          ) : (
            <div className="text-center py-8 text-muted-foreground">
              Nenhum feedback encontrado
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/Funcionarios.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Loader2, Plus, Search, Pencil, Trash2, Download, Upload, Users } from "lucide-react";

/**
 * PÃ¡gina de GestÃ£o de FuncionÃ¡rios
 * CRUD completo com importaÃ§Ã£o/exportaÃ§Ã£o
 */

export default function Funcionarios() {
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedDepartment, setSelectedDepartment] = useState<string>("all");
  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
  const [selectedEmployee, setSelectedEmployee] = useState<any>(null);
  const [formData, setFormData] = useState({
    employeeCode: "",
    name: "",
    email: "",
    cpf: "",
    birthDate: "",
    hireDate: "",
    departmentId: "",
    positionTitle: "",
    salary: "",
  });

  // Buscar funcionÃ¡rios
  const { data: employees, isLoading, refetch } = trpc.employees.list.useQuery();

  // Buscar departamentos
  const { data: departments } = trpc.departments.list.useQuery();

  // Mutation para criar funcionÃ¡rio
  const createMutation = trpc.employees.create.useMutation({
    onSuccess: () => {
      toast.success("FuncionÃ¡rio criado com sucesso!");
      setIsCreateDialogOpen(false);
      setFormData({
        employeeCode: "",
        name: "",
        email: "",
        cpf: "",
        birthDate: "",
        hireDate: "",
        departmentId: "",
        positionTitle: "",
        salary: "",
      });
      refetch();
    },
    onError: (error: any) => {
      toast.error(`Erro ao criar funcionÃ¡rio: ${error.message}`);
    },
  });

  const handleSubmit = () => {
    if (!formData.name || !formData.email || !formData.employeeCode) {
      toast.error("Preencha os campos obrigatÃ³rios (Nome, E-mail, MatrÃ­cula)");
      return;
    }

    createMutation.mutate({
      employeeCode: formData.employeeCode,
      name: formData.name,
      email: formData.email,
      cpf: formData.cpf || undefined,
      birthDate: formData.birthDate ? new Date(formData.birthDate) : undefined,
      hireDate: formData.hireDate ? new Date(formData.hireDate) : undefined,
      departmentId: formData.departmentId ? parseInt(formData.departmentId) : undefined,
      positionTitle: formData.positionTitle || undefined,
      salary: formData.salary ? parseFloat(formData.salary) : undefined,
    });
  };

  // Filtrar funcionÃ¡rios
  const filteredEmployees = employees?.filter((emp) => {
    const matchesSearch = emp.employee.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      emp.employee.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
      emp.employee.employeeCode.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesDepartment = selectedDepartment === "all" || emp.employee.departmentId === parseInt(selectedDepartment);
    return matchesSearch && matchesDepartment;
  });

  const handleEdit = (employee: any) => {
    setSelectedEmployee(employee);
    setIsEditDialogOpen(true);
  };

  const handleExport = () => {
    // TODO: Implementar exportaÃ§Ã£o para Excel
    toast.success("ExportaÃ§Ã£o iniciada!");
  };

  const handleImport = () => {
    // TODO: Implementar importaÃ§Ã£o de Excel
    toast.info("Funcionalidade de importaÃ§Ã£o em desenvolvimento");
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <Users className="h-8 w-8" />
              FuncionÃ¡rios
            </h1>
            <p className="text-muted-foreground mt-2">
              Gerencie todos os colaboradores da organizaÃ§Ã£o
            </p>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" onClick={handleImport}>
              <Upload className="h-4 w-4 mr-2" />
              Importar
            </Button>
            <Button variant="outline" onClick={handleExport}>
              <Download className="h-4 w-4 mr-2" />
              Exportar
            </Button>
            <Button onClick={() => setIsCreateDialogOpen(true)}>
              <Plus className="h-4 w-4 mr-2" />
              Novo FuncionÃ¡rio
            </Button>
          </div>
        </div>

        {/* Filtros */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex gap-4">
              <div className="flex-1">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                  <Input
                    placeholder="Buscar por nome, e-mail ou matrÃ­cula..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10"
                  />
                </div>
              </div>
              <Select value={selectedDepartment} onValueChange={setSelectedDepartment}>
                <SelectTrigger className="w-[250px]">
                  <SelectValue placeholder="Filtrar por departamento" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os departamentos</SelectItem>
                  {departments?.map((dept) => (
                    <SelectItem key={dept.id} value={dept.id.toString()}>
                      {dept.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </CardContent>
        </Card>

        {/* Tabela de FuncionÃ¡rios */}
        <Card>
          <CardHeader>
            <CardTitle>Lista de FuncionÃ¡rios</CardTitle>
            <CardDescription>
              {filteredEmployees?.length || 0} funcionÃ¡rio(s) encontrado(s)
            </CardDescription>
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <div className="flex items-center justify-center h-64">
                <Loader2 className="w-8 h-8 animate-spin text-primary" />
              </div>
            ) : (
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>MatrÃ­cula</TableHead>
                    <TableHead>Nome</TableHead>
                    <TableHead>E-mail</TableHead>
                    <TableHead>Cargo</TableHead>
                    <TableHead>Departamento</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead className="text-right">AÃ§Ãµes</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredEmployees?.map((emp) => (
                    <TableRow key={emp.employee.id}>
                      <TableCell className="font-mono text-sm">{emp.employee.employeeCode}</TableCell>
                      <TableCell className="font-medium">{emp.employee.name}</TableCell>
                      <TableCell>{emp.employee.email}</TableCell>
                      <TableCell>{emp.position?.title || "-"}</TableCell>
                      <TableCell>{emp.department?.name || "-"}</TableCell>
                      <TableCell>
                        <Badge variant="default">
                          Ativo
                        </Badge>
                      </TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2">
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => handleEdit(emp)}
                          >
                            <Pencil className="h-4 w-4" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            className="text-destructive hover:text-destructive"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            )}
          </CardContent>
        </Card>

        {/* Dialog de Criar/Editar */}
        <Dialog open={isCreateDialogOpen || isEditDialogOpen} onOpenChange={(open) => {
          if (!open) {
            setIsCreateDialogOpen(false);
            setIsEditDialogOpen(false);
            setSelectedEmployee(null);
          }
        }}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>
                {isEditDialogOpen ? "Editar FuncionÃ¡rio" : "Novo FuncionÃ¡rio"}
              </DialogTitle>
              <DialogDescription>
                Preencha os dados do funcionÃ¡rio
              </DialogDescription>
            </DialogHeader>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>MatrÃ­cula *</Label>
                <Input 
                  placeholder="Ex: 12345" 
                  value={formData.employeeCode}
                  onChange={(e) => setFormData({...formData, employeeCode: e.target.value})}
                />
              </div>
              <div>
                <Label>Nome Completo *</Label>
                <Input 
                  placeholder="Ex: JoÃ£o Silva" 
                  value={formData.name}
                  onChange={(e) => setFormData({...formData, name: e.target.value})}
                />
              </div>
              <div>
                <Label>E-mail *</Label>
                <Input 
                  type="email" 
                  placeholder="Ex: joao@uisa.com.br" 
                  value={formData.email}
                  onChange={(e) => setFormData({...formData, email: e.target.value})}
                />
              </div>
              <div>
                <Label>CPF</Label>
                <Input 
                  placeholder="Ex: 123.456.789-00" 
                  value={formData.cpf}
                  onChange={(e) => setFormData({...formData, cpf: e.target.value})}
                />
              </div>
              <div>
                <Label>Data de Nascimento</Label>
                <Input 
                  type="date" 
                  value={formData.birthDate}
                  onChange={(e) => setFormData({...formData, birthDate: e.target.value})}
                />
              </div>
              <div>
                <Label>Data de AdmissÃ£o</Label>
                <Input 
                  type="date" 
                  value={formData.hireDate}
                  onChange={(e) => setFormData({...formData, hireDate: e.target.value})}
                />
              </div>
              <div>
                <Label>Departamento</Label>
                <Select value={formData.departmentId} onValueChange={(value) => setFormData({...formData, departmentId: value})}>
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione" />
                  </SelectTrigger>
                  <SelectContent>
                    {departments?.map((dept) => (
                      <SelectItem key={dept.id} value={dept.id.toString()}>
                        {dept.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Cargo</Label>
                <Input 
                  placeholder="Ex: Analista" 
                  value={formData.positionTitle}
                  onChange={(e) => setFormData({...formData, positionTitle: e.target.value})}
                />
              </div>
              <div>
                <Label>SalÃ¡rio</Label>
                <Input 
                  type="number" 
                  placeholder="Ex: 5000" 
                  value={formData.salary}
                  onChange={(e) => setFormData({...formData, salary: e.target.value})}
                />
              </div>
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={() => {
                setIsCreateDialogOpen(false);
                setIsEditDialogOpen(false);
              }}>
                Cancelar
              </Button>
              <Button onClick={handleSubmit} disabled={createMutation.isPending}>
                {createMutation.isPending ? "Criando..." : isEditDialogOpen ? "Salvar AlteraÃ§Ãµes" : "Criar FuncionÃ¡rio"}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/FuncionariosAtivos.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Loader2, Plus, Search, Pencil, Trash2, Download, Upload, Users } from "lucide-react";

/**
 * PÃ¡gina de GestÃ£o de FuncionÃ¡rios Ativos UISA
 * FormulÃ¡rio completo com todos os campos necessÃ¡rios
 */

export default function FuncionariosAtivos() {
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedDepartment, setSelectedDepartment] = useState<string>("all");
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
  const [selectedEmployee, setSelectedEmployee] = useState<any>(null);

  // Form state
  const [formData, setFormData] = useState({
    employeeCode: "",
    name: "",
    email: "",
    cpf: "",
    birthDate: "",
    hireDate: "",
    departmentId: "",
    positionId: "",
    managerId: "",
    salary: "",
    hierarchyLevel: "",
    phone: "",
    address: "",
  });

  // Queries
  const utils = trpc.useUtils();
  const { data: employees, isLoading } = trpc.employees.list.useQuery();
  const { data: departments } = trpc.departments.list.useQuery();
  const { data: positions } = trpc.positions.list.useQuery();

  // Mutations
  const updateEmployeeMutation = trpc.employees.update.useMutation({
    onSuccess: () => {
      toast.success("FuncionÃ¡rio atualizado com sucesso!");
      utils.employees.list.invalidate();
      setIsEditDialogOpen(false);
      resetForm();
    },
    onError: (error: any) => {
      toast.error(`Erro ao atualizar: ${error.message}`);
    },
  });

  // Filtrar funcionÃ¡rios
  const filteredEmployees = employees?.filter((emp) => {
    const matchesSearch =
      emp.employee.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      emp.employee.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
      emp.employee.employeeCode.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesDepartment =
      selectedDepartment === "all" || emp.employee.departmentId === parseInt(selectedDepartment);
    return matchesSearch && matchesDepartment && emp.employee.status === "ativo";
  });

  const resetForm = () => {
    setFormData({
      employeeCode: "",
      name: "",
      email: "",
      cpf: "",
      birthDate: "",
      hireDate: "",
      departmentId: "",
      positionId: "",
      managerId: "",
      salary: "",
      hierarchyLevel: "",
      phone: "",
      address: "",
    });
    setSelectedEmployee(null);
  };

  const handleEdit = (employee: any) => {
    setSelectedEmployee(employee);
    setFormData({
      employeeCode: employee.employee.employeeCode || "",
      name: employee.employee.name || "",
      email: employee.employee.email || "",
      cpf: employee.employee.cpf || "",
      birthDate: employee.employee.birthDate ? employee.employee.birthDate.toString().split("T")[0] : "",
      hireDate: employee.employee.hireDate ? employee.employee.hireDate.toString().split("T")[0] : "",
      departmentId: employee.employee.departmentId?.toString() || "",
      positionId: employee.employee.positionId?.toString() || "",
      managerId: employee.employee.managerId?.toString() || "",
      salary: employee.employee.salary ? (employee.employee.salary / 100).toFixed(2) : "",
      hierarchyLevel: employee.employee.hierarchyLevel || "",
      phone: employee.employee.phone || "",
      address: employee.employee.address || "",
    });
    setIsEditDialogOpen(true);
  };

  const handleSave = () => {
    if (!selectedEmployee) return;

    updateEmployeeMutation.mutate({
      id: selectedEmployee.employee.id,
      employeeCode: formData.employeeCode,
      name: formData.name,
      email: formData.email,
      cpf: formData.cpf || undefined,
      birthDate: formData.birthDate || undefined,
      hireDate: formData.hireDate,
      departmentId: parseInt(formData.departmentId),
      positionId: parseInt(formData.positionId),
      managerId: formData.managerId ? parseInt(formData.managerId) : undefined,
      salary: formData.salary ? Math.round(parseFloat(formData.salary) * 100) : undefined,
      hierarchyLevel: (formData.hierarchyLevel as "diretoria" | "gerencia" | "coordenacao" | "supervisao" | "operacional" | undefined) || undefined,
      phone: formData.phone || undefined,
      address: formData.address || undefined,
    });
  };

  const getHierarchyBadge = (level: string | null) => {
    const badges: Record<string, { label: string; variant: "default" | "secondary" | "outline" }> = {
      diretoria: { label: "Diretoria", variant: "default" },
      gerencia: { label: "GerÃªncia", variant: "default" },
      coordenacao: { label: "CoordenaÃ§Ã£o", variant: "secondary" },
      supervisao: { label: "SupervisÃ£o", variant: "secondary" },
      operacional: { label: "Operacional", variant: "outline" },
    };
    const config = level ? badges[level] : null;
    return config ? <Badge variant={config.variant}>{config.label}</Badge> : <span className="text-muted-foreground">N/A</span>;
  };

  const formatSalary = (salary: number | null) => {
    if (!salary) return "N/A";
    return new Intl.NumberFormat("pt-BR", {
      style: "currency",
      currency: "BRL",
    }).format(salary / 100);
  };

  const formatDate = (date: string | Date | null) => {
    if (!date) return "N/A";
    return new Date(date).toLocaleDateString("pt-BR");
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <Users className="h-8 w-8" />
              FuncionÃ¡rios Ativos UISA
            </h1>
            <p className="text-muted-foreground mt-2">Base completa de colaboradores ativos do Grupo UISA</p>
          </div>
          <div className="flex gap-2">
            <Button variant="outline">
              <Upload className="h-4 w-4 mr-2" />
              Importar
            </Button>
            <Button variant="outline">
              <Download className="h-4 w-4 mr-2" />
              Exportar
            </Button>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Total de FuncionÃ¡rios</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{filteredEmployees?.length || 0}</div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Idade MÃ©dia</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-orange-600">0 anos</div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Tempo MÃ©dio de Casa</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-blue-600">0 anos</div>
            </CardContent>
          </Card>
        </div>

        {/* Filtros */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex gap-4">
              <div className="flex-1">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                  <Input
                    placeholder="Buscar por Nome ou Chapa..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10"
                  />
                </div>
              </div>
              <div className="w-64">
                <Select value={selectedDepartment} onValueChange={setSelectedDepartment}>
                  <SelectTrigger>
                    <SelectValue placeholder="Todos os departamentos" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos os departamentos</SelectItem>
                    {departments?.map((dept) => (
                      <SelectItem key={dept.id} value={dept.id.toString()}>
                        {dept.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="w-48">
                <Select defaultValue="nome">
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="nome">Nome (A-Z)</SelectItem>
                    <SelectItem value="admissao">Data de AdmissÃ£o</SelectItem>
                    <SelectItem value="departamento">Departamento</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Tabela */}
        <Card>
          <CardHeader>
            <CardTitle>Lista de FuncionÃ¡rios</CardTitle>
            <CardDescription>
              {filteredEmployees?.length || 0} funcionÃ¡rios encontrados
            </CardDescription>
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <div className="flex justify-center py-8">
                <Loader2 className="h-8 w-8 animate-spin text-primary" />
              </div>
            ) : (
              <div className="overflow-x-auto">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Chapa</TableHead>
                      <TableHead>Nome</TableHead>
                      <TableHead>Cargo</TableHead>
                      <TableHead>Departamento</TableHead>
                      <TableHead>NÃ­vel</TableHead>
                      <TableHead>SalÃ¡rio</TableHead>
                      <TableHead>AdmissÃ£o</TableHead>
                      <TableHead>Status</TableHead>
                      <TableHead className="text-right">AÃ§Ãµes</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredEmployees?.map((emp) => (
                      <TableRow key={emp.employee.id}>
                        <TableCell className="font-medium">{emp.employee.employeeCode || "N/A"}</TableCell>
                        <TableCell>{emp.employee.name}</TableCell>
                        <TableCell>{emp.position?.title || "N/A"}</TableCell>
                        <TableCell>{emp.department?.name || "N/A"}</TableCell>
                        <TableCell>{getHierarchyBadge(emp.employee.hierarchyLevel)}</TableCell>
                        <TableCell>{formatSalary(emp.employee.salary)}</TableCell>
                        <TableCell>{formatDate(emp.employee.hireDate)}</TableCell>
                        <TableCell>
                          <Badge variant="outline" className="bg-green-50 text-green-700 border-green-200">
                            Ativo
                          </Badge>
                        </TableCell>
                        <TableCell className="text-right">
                          <div className="flex justify-end gap-2">
                            <Button variant="ghost" size="icon" onClick={() => handleEdit(emp)}>
                              <Pencil className="h-4 w-4 text-blue-600" />
                            </Button>
                            <Button variant="ghost" size="icon">
                              <Trash2 className="h-4 w-4 text-red-600" />
                            </Button>
                          </div>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Dialog de EdiÃ§Ã£o */}
        <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>
          <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle>âœï¸ Editar FuncionÃ¡rio</DialogTitle>
              <DialogDescription>Atualize as informaÃ§Ãµes do colaborador</DialogDescription>
            </DialogHeader>

            <div className="grid grid-cols-2 gap-4 py-4">
              {/* Nome Completo */}
              <div className="col-span-2">
                <Label htmlFor="name">Nome Completo *</Label>
                <Input
                  id="name"
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  placeholder="ABNER PEREIRA DE CARVALHO NETO"
                />
              </div>

              {/* Email */}
              <div>
                <Label htmlFor="email">Email *</Label>
                <Input
                  id="email"
                  type="email"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                  placeholder="abner.neto@uisa.com.br"
                />
              </div>

              {/* Chapa */}
              <div>
                <Label htmlFor="employeeCode">Chapa</Label>
                <Input
                  id="employeeCode"
                  value={formData.employeeCode}
                  onChange={(e) => setFormData({ ...formData, employeeCode: e.target.value })}
                  placeholder="Ex: 12345"
                />
              </div>

              {/* Cargo */}
              <div>
                <Label htmlFor="positionId">Cargo *</Label>
                <Select value={formData.positionId} onValueChange={(value) => setFormData({ ...formData, positionId: value })}>
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione o cargo" />
                  </SelectTrigger>
                  <SelectContent>
                    {positions?.map((pos) => (
                      <SelectItem key={pos.id} value={pos.id.toString()}>
                        {pos.title}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Departamento */}
              <div>
                <Label htmlFor="departmentId">Departamento *</Label>
                <Select value={formData.departmentId} onValueChange={(value) => setFormData({ ...formData, departmentId: value })}>
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione o departamento" />
                  </SelectTrigger>
                  <SelectContent>
                    {departments?.map((dept) => (
                      <SelectItem key={dept.id} value={dept.id.toString()}>
                        {dept.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Data de AdmissÃ£o */}
              <div>
                <Label htmlFor="hireDate">Data de AdmissÃ£o *</Label>
                <Input
                  id="hireDate"
                  type="date"
                  value={formData.hireDate}
                  onChange={(e) => setFormData({ ...formData, hireDate: e.target.value })}
                />
              </div>

              {/* SalÃ¡rio */}
              <div>
                <Label htmlFor="salary">SalÃ¡rio (R$)</Label>
                <Input
                  id="salary"
                  type="number"
                  step="0.01"
                  value={formData.salary}
                  onChange={(e) => setFormData({ ...formData, salary: e.target.value })}
                  placeholder="5000.00"
                />
              </div>

              {/* NÃ­vel HierÃ¡rquico */}
              <div>
                <Label htmlFor="hierarchyLevel">NÃ­vel</Label>
                <Select value={formData.hierarchyLevel} onValueChange={(value) => setFormData({ ...formData, hierarchyLevel: value })}>
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione o nÃ­vel" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="diretoria">Diretoria</SelectItem>
                    <SelectItem value="gerencia">GerÃªncia</SelectItem>
                    <SelectItem value="coordenacao">CoordenaÃ§Ã£o</SelectItem>
                    <SelectItem value="supervisao">SupervisÃ£o</SelectItem>
                    <SelectItem value="operacional">Operacional</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={() => setIsEditDialogOpen(false)}>
                Cancelar
              </Button>
              <Button onClick={handleSave} disabled={updateEmployeeMutation.isPending}>
                {updateEmployeeMutation.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                ðŸ’¾ Salvar AlteraÃ§Ãµes
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/HierarquiaImport.tsx
========================================
import { useState } from "react";
import { useLocation } from "wouter";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Upload, Download, CheckCircle2, XCircle, AlertCircle, ArrowLeft } from "lucide-react";
import { toast } from "sonner";
import DashboardLayout from "@/components/DashboardLayout";

interface ImportRow {
  employeeId: number;
  name: string;
  newManagerId?: number;
  newCostCenter?: string;
  status: 'pending' | 'success' | 'error';
  error?: string;
}

export default function HierarquiaImport() {
  const [, setLocation] = useLocation();
  const [file, setFile] = useState<File | null>(null);
  const [previewData, setPreviewData] = useState<ImportRow[]>([]);
  const [isProcessing, setIsProcessing] = useState(false);

  const updateEmployeeMutation = trpc.employees.updateEmployee.useMutation();

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0];
    if (selectedFile) {
      setFile(selectedFile);
      processFile(selectedFile);
    }
  };

  const processFile = async (file: File) => {
    try {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim());
      
      if (lines.length < 2) {
        toast.error("Arquivo vazio ou invÃ¡lido");
        return;
      }

      // Assumindo CSV com cabeÃ§alho: employeeId,name,newManagerId,newCostCenter
      const headers = lines[0].split(',').map(h => h.trim());
      const data: ImportRow[] = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        if (values.length >= 2) {
          data.push({
            employeeId: parseInt(values[0]),
            name: values[1],
            newManagerId: values[2] ? parseInt(values[2]) : undefined,
            newCostCenter: values[3] || undefined,
            status: 'pending',
          });
        }
      }

      setPreviewData(data);
      toast.success(`${data.length} registros carregados para preview`);
    } catch (error) {
      toast.error("Erro ao processar arquivo");
      console.error(error);
    }
  };

  const handleImport = async () => {
    setIsProcessing(true);
    const updatedData = [...previewData];

    for (let i = 0; i < updatedData.length; i++) {
      const row = updatedData[i];
      try {
        const updateData: any = { id: row.employeeId };
        if (row.newManagerId) updateData.managerId = row.newManagerId;
        if (row.newCostCenter) updateData.costCenter = row.newCostCenter;

        await updateEmployeeMutation.mutateAsync(updateData);
        updatedData[i].status = 'success';
      } catch (error: any) {
        updatedData[i].status = 'error';
        updatedData[i].error = error.message || 'Erro desconhecido';
      }
      setPreviewData([...updatedData]);
    }

    setIsProcessing(false);
    const successCount = updatedData.filter(r => r.status === 'success').length;
    const errorCount = updatedData.filter(r => r.status === 'error').length;
    
    if (errorCount === 0) {
      toast.success(`âœ… ImportaÃ§Ã£o concluÃ­da! ${successCount} registros atualizados.`);
    } else {
      toast.warning(`âš ï¸ ImportaÃ§Ã£o concluÃ­da com erros: ${successCount} sucessos, ${errorCount} falhas.`);
    }
  };

  const downloadTemplate = () => {
    const template = "employeeId,name,newManagerId,newCostCenter\n1,JoÃ£o Silva,2,CC-001-TI\n3,Maria Santos,2,CC-002-RH";
    const blob = new Blob([template], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'template_importacao_hierarquia.csv';
    a.click();
    URL.revokeObjectURL(url);
    toast.success("Template baixado com sucesso!");
  };

  return (
    <DashboardLayout>
      <div className="container mx-auto py-8">
        <div className="mb-6 flex items-center justify-between">
          <div>
            <Button
              variant="ghost"
              onClick={() => setLocation("/admin/hierarquia")}
              className="mb-4"
            >
              <ArrowLeft className="mr-2 h-4 w-4" />
              Voltar para Hierarquia
            </Button>
            <h1 className="text-3xl font-bold">ImportaÃ§Ã£o em Massa de Hierarquia</h1>
            <p className="text-muted-foreground">
              Atualize gestores e centros de custos de mÃºltiplos colaboradores via CSV
            </p>
          </div>
        </div>

        <div className="grid gap-6">
          {/* Card de Upload */}
          <Card>
            <CardHeader>
              <CardTitle>1. Upload do Arquivo CSV</CardTitle>
              <CardDescription>
                FaÃ§a upload de um arquivo CSV com os dados de atualizaÃ§Ã£o
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex gap-4">
                <Button onClick={downloadTemplate} variant="outline">
                  <Download className="mr-2 h-4 w-4" />
                  Baixar Template CSV
                </Button>
                
                <div className="flex-1">
                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleFileChange}
                    className="hidden"
                    id="file-upload"
                  />
                  <label htmlFor="file-upload">
                    <Button asChild variant="default">
                      <span>
                        <Upload className="mr-2 h-4 w-4" />
                        {file ? file.name : "Selecionar Arquivo CSV"}
                      </span>
                    </Button>
                  </label>
                </div>
              </div>

              <Alert>
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>
                  <strong>Formato do CSV:</strong> employeeId, name, newManagerId, newCostCenter
                  <br />
                  Exemplo: 1,JoÃ£o Silva,2,CC-001-TI
                </AlertDescription>
              </Alert>
            </CardContent>
          </Card>

          {/* Card de Preview */}
          {previewData.length > 0 && (
            <Card>
              <CardHeader>
                <CardTitle>2. Preview das AlteraÃ§Ãµes</CardTitle>
                <CardDescription>
                  Revise os dados antes de importar ({previewData.length} registros)
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="mb-4 flex justify-end">
                  <Button
                    onClick={handleImport}
                    disabled={isProcessing}
                    size="lg"
                  >
                    {isProcessing ? "Importando..." : "Confirmar ImportaÃ§Ã£o"}
                  </Button>
                </div>

                <div className="max-h-[500px] overflow-auto rounded-md border">
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Status</TableHead>
                        <TableHead>ID</TableHead>
                        <TableHead>Nome</TableHead>
                        <TableHead>Novo Gestor ID</TableHead>
                        <TableHead>Novo Centro de Custos</TableHead>
                        <TableHead>Erro</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {previewData.map((row, index) => (
                        <TableRow key={index}>
                          <TableCell>
                            {row.status === 'pending' && (
                              <AlertCircle className="h-4 w-4 text-gray-400" />
                            )}
                            {row.status === 'success' && (
                              <CheckCircle2 className="h-4 w-4 text-green-600" />
                            )}
                            {row.status === 'error' && (
                              <XCircle className="h-4 w-4 text-red-600" />
                            )}
                          </TableCell>
                          <TableCell>{row.employeeId}</TableCell>
                          <TableCell>{row.name}</TableCell>
                          <TableCell>{row.newManagerId || '-'}</TableCell>
                          <TableCell>{row.newCostCenter || '-'}</TableCell>
                          <TableCell className="text-red-600 text-sm">
                            {row.error || ''}
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/HierarquiaOrganizacional.tsx
========================================
import { useState } from "react";
import { useLocation } from "wouter";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { toast } from "sonner";
import { Users, Building2, Search, Edit, ChevronRight, ChevronDown, User, Upload, Download } from "lucide-react";

interface TreeNode {
  employee: any;
  subordinates: TreeNode[];
  isExpanded: boolean;
}

export default function HierarquiaOrganizacional() {
  const [, setLocation] = useLocation();
  const { user, loading: authLoading } = useAuth();
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedDepartment, setSelectedDepartment] = useState<string>("all");
  const [editingEmployee, setEditingEmployee] = useState<any>(null);
  const [newManagerId, setNewManagerId] = useState<string>("");
  const [newCostCenter, setNewCostCenter] = useState<string>("");
  const [expandedNodes, setExpandedNodes] = useState<Set<number>>(new Set());

  // Queries
  const { data: hierarchy, isLoading: loadingHierarchy, refetch } = trpc.employees.getHierarchy.useQuery();
  const { data: departments } = trpc.employees.getDepartments.useQuery();
  const { data: managers } = trpc.employees.getManagers.useQuery();

  // Queries para relatÃ³rio
  const { data: reportData, refetch: refetchReport } = trpc.employees.exportHierarchyReport.useQuery(undefined, {
    enabled: false,
  });

  const handleDownloadReport = async () => {
    try {
      const result = await refetchReport();
      if (!result.data) {
        toast.error("Erro ao gerar relatÃ³rio");
        return;
      }

      // Gerar relatÃ³rio em formato texto
      const report = result.data;
      let content = `RELATÃ“RIO DE HIERARQUIA ORGANIZACIONAL\n`;
      content += `Data: ${new Date().toLocaleDateString('pt-BR')}\n\n`;
      content += `=== ESTATÃSTICAS GERAIS ===\n`;
      content += `Total de Colaboradores: ${report.totalEmployees}\n`;
      content += `Colaboradores com Gestor: ${report.employeesWithManager}\n`;
      content += `Colaboradores sem Gestor: ${report.employeesWithoutManager}\n`;
      content += `Total de Gestores: ${report.uniqueManagers}\n`;
      content += `Span of Control MÃ©dio: ${report.avgSpanOfControl}\n\n`;
      
      content += `=== DISTRIBUIÃ‡ÃƒO POR DEPARTAMENTO ===\n`;
      report.departmentStats.forEach((dept: any) => {
        content += `${dept.departmentName}: ${dept.count} colaboradores\n`;
      });
      
      content += `\n=== COLABORADORES SEM GESTOR DEFINIDO ===\n`;
      if (report.employeesWithoutManagerList.length === 0) {
        content += `Nenhum colaborador sem gestor.\n`;
      } else {
        report.employeesWithoutManagerList.forEach((emp: any) => {
          content += `- ${emp.name} (${emp.email})\n`;
          content += `  Departamento: ${emp.department} | Cargo: ${emp.position} | CC: ${emp.costCenter}\n`;
        });
      }

      // Download do arquivo
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `relatorio-hierarquia-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      toast.success("RelatÃ³rio gerado com sucesso!");
    } catch (error) {
      toast.error("Erro ao gerar relatÃ³rio");
    }
  };

  // Mutations
  const updateEmployeeMutation = trpc.employees.updateEmployee.useMutation({
    onSuccess: () => {
      toast.success("Hierarquia atualizada com sucesso!");
      setEditingEmployee(null);
      refetch();
    },
    onError: (error) => {
      toast.error(`Erro ao atualizar: ${error.message}`);
    },
  });

  const handleEdit = (employee: any) => {
    setEditingEmployee(employee);
    setNewManagerId(employee.managerId?.toString() || "");
    setNewCostCenter(employee.costCenter || "");
  };

  const handleSave = () => {
    if (!editingEmployee) return;

    updateEmployeeMutation.mutate({
      id: editingEmployee.id,
      managerId: newManagerId ? parseInt(newManagerId) : undefined,
      costCenter: newCostCenter || undefined,
    });
  };

  const toggleNode = (employeeId: number) => {
    const newExpanded = new Set(expandedNodes);
    if (newExpanded.has(employeeId)) {
      newExpanded.delete(employeeId);
    } else {
      newExpanded.add(employeeId);
    }
    setExpandedNodes(newExpanded);
  };

  const buildTree = (employees: any[]): TreeNode[] => {
    const employeeMap = new Map<number, TreeNode>();
    const roots: TreeNode[] = [];

    // Criar nÃ³s
    employees.forEach(emp => {
      employeeMap.set(emp.id, {
        employee: emp,
        subordinates: [],
        isExpanded: expandedNodes.has(emp.id),
      });
    });

    // Construir Ã¡rvore
    employees.forEach(emp => {
      const node = employeeMap.get(emp.id)!;
      if (emp.managerId && employeeMap.has(emp.managerId)) {
        employeeMap.get(emp.managerId)!.subordinates.push(node);
      } else {
        roots.push(node);
      }
    });

    return roots;
  };

  const renderTree = (nodes: TreeNode[], level: number = 0) => {
    return nodes.map(node => {
      const hasSubordinates = node.subordinates.length > 0;
      const isExpanded = expandedNodes.has(node.employee.id);

      return (
        <div key={node.employee.id} style={{ marginLeft: `${level * 24}px` }}>
          <div className="flex items-center gap-2 py-2 px-3 hover:bg-gray-50 rounded-lg group">
            {hasSubordinates ? (
              <button
                onClick={() => toggleNode(node.employee.id)}
                className="p-1 hover:bg-gray-200 rounded"
              >
                {isExpanded ? (
                  <ChevronDown className="h-4 w-4 text-gray-600" />
                ) : (
                  <ChevronRight className="h-4 w-4 text-gray-600" />
                )}
              </button>
            ) : (
              <div className="w-6" />
            )}

            <div className="flex items-center gap-2 flex-1">
              <div className="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center">
                <User className="h-4 w-4 text-orange-600" />
              </div>
              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <span className="font-medium text-sm">{node.employee.name}</span>
                  {hasSubordinates && (
                    <Badge variant="secondary" className="text-xs">
                      {node.subordinates.length} subordinado{node.subordinates.length !== 1 ? 's' : ''}
                    </Badge>
                  )}
                </div>
                <div className="flex items-center gap-3 text-xs text-gray-500">
                  <span>{node.employee.position || "Sem cargo"}</span>
                  <span>â€¢</span>
                  <span>{node.employee.department || "Sem departamento"}</span>
                  {node.employee.costCenter && (
                    <>
                      <span>â€¢</span>
                      <Badge variant="outline" className="text-xs">
                        {node.employee.costCenter}
                      </Badge>
                    </>
                  )}
                </div>
              </div>

              <Button
                size="sm"
                variant="ghost"
                onClick={() => handleEdit(node.employee)}
                className="opacity-0 group-hover:opacity-100 transition-opacity"
              >
                <Edit className="h-4 w-4" />
              </Button>
            </div>
          </div>

          {isExpanded && hasSubordinates && (
            <div className="border-l-2 border-gray-200 ml-3">
              {renderTree(node.subordinates, level + 1)}
            </div>
          )}
        </div>
      );
    });
  };

  if (authLoading || !user) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-64">
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mx-auto"></div>
            <p className="mt-4 text-gray-600">Carregando...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  if (user.role !== "admin") {
    return (
      <DashboardLayout>
        <div className="text-center py-12">
          <h2 className="text-2xl font-bold text-gray-900">Acesso Negado</h2>
          <p className="mt-2 text-gray-600">Apenas administradores podem acessar esta pÃ¡gina.</p>
        </div>
      </DashboardLayout>
    );
  }

  const filteredEmployees = hierarchy?.filter((emp: any) => {
    const matchesSearch = emp.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         emp.position?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         emp.costCenter?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesDepartment = selectedDepartment === "all" || emp.department === selectedDepartment;
    return matchesSearch && matchesDepartment;
  }) || [];

  const tree = buildTree(filteredEmployees);
  const totalEmployees = hierarchy?.length || 0;
  const totalManagers = hierarchy?.filter((e: any) => e.subordinateCount > 0).length || 0;
  const totalDepartments = new Set(hierarchy?.map((e: any) => e.department).filter(Boolean)).size;

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-start justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">Hierarquia Organizacional</h1>
            <p className="mt-2 text-gray-600">
              Visualize e gerencie a estrutura hierÃ¡rquica da organizaÃ§Ã£o
            </p>
          </div>
          <div className="flex gap-2">
            <Button onClick={handleDownloadReport} variant="outline" size="lg">
              <Download className="mr-2 h-4 w-4" />
              Baixar RelatÃ³rio
            </Button>
            <Button onClick={() => setLocation("/admin/hierarquia/importar")} size="lg">
              <Upload className="mr-2 h-4 w-4" />
              Importar em Massa
            </Button>
          </div>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Total de Colaboradores</CardTitle>
              <Users className="h-4 w-4 text-gray-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{totalEmployees}</div>
              <p className="text-xs text-gray-600 mt-1">Ativos no sistema</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Gestores</CardTitle>
              <User className="h-4 w-4 text-gray-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{totalManagers}</div>
              <p className="text-xs text-gray-600 mt-1">Com subordinados diretos</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Departamentos</CardTitle>
              <Building2 className="h-4 w-4 text-gray-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{totalDepartments}</div>
              <p className="text-xs text-gray-600 mt-1">Ãreas ativas</p>
            </CardContent>
          </Card>
        </div>

        {/* Filtros */}
        <Card>
          <CardHeader>
            <CardTitle>Filtros</CardTitle>
            <CardDescription>Refine a visualizaÃ§Ã£o da hierarquia</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                <Input
                  placeholder="Buscar por nome, cargo ou centro de custos..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10"
                />
              </div>

              <Select value={selectedDepartment} onValueChange={setSelectedDepartment}>
                <SelectTrigger>
                  <SelectValue placeholder="Filtrar por departamento" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os departamentos</SelectItem>
                  {departments?.map((dept: string) => (
                    <SelectItem key={dept} value={dept}>
                      {dept}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </CardContent>
        </Card>

        {/* Ãrvore HierÃ¡rquica */}
        <Card>
          <CardHeader>
            <CardTitle>Estrutura Organizacional</CardTitle>
            <CardDescription>
              {filteredEmployees.length} colaborador(es) â€¢ Clique nas setas para expandir/recolher
            </CardDescription>
          </CardHeader>
          <CardContent>
            {loadingHierarchy ? (
              <div className="text-center py-8">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mx-auto"></div>
                <p className="mt-4 text-gray-600">Carregando hierarquia...</p>
              </div>
            ) : tree.length > 0 ? (
              <div className="space-y-1">
                {renderTree(tree)}
              </div>
            ) : (
              <div className="text-center py-8 text-gray-500">
                Nenhum colaborador encontrado com os filtros aplicados
              </div>
            )}
          </CardContent>
        </Card>

        {/* Dialog de EdiÃ§Ã£o */}
        <Dialog open={!!editingEmployee} onOpenChange={() => setEditingEmployee(null)}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Editar Hierarquia</DialogTitle>
              <DialogDescription>
                Atualize o gestor direto e centro de custos de {editingEmployee?.name}
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4 py-4">
              <div className="space-y-2">
                <Label htmlFor="manager">Gestor Direto</Label>
                <Select value={newManagerId} onValueChange={setNewManagerId}>
                  <SelectTrigger id="manager">
                    <SelectValue placeholder="Selecione o gestor" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="none">Nenhum (NÃ­vel mais alto)</SelectItem>
                    {managers?.filter((m: any) => m.id !== editingEmployee?.id).map((manager: any) => (
                      <SelectItem key={manager.id} value={manager.id.toString()}>
                        {manager.name} - {manager.position || "Sem cargo"}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="costCenter">Centro de Custos</Label>
                <Input
                  id="costCenter"
                  placeholder="Ex: CC-001-TI"
                  value={newCostCenter}
                  onChange={(e) => setNewCostCenter(e.target.value)}
                />
                <p className="text-xs text-gray-500">
                  Formato sugerido: CC-XXX-DEPARTAMENTO
                </p>
              </div>
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={() => setEditingEmployee(null)}>
                Cancelar
              </Button>
              <Button onClick={handleSave} disabled={updateEmployeeMutation.isPending}>
                {updateEmployeeMutation.isPending ? "Salvando..." : "Salvar"}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/History.tsx
========================================
import { useAuth } from "@/_core/hooks/useAuth";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Badge } from "@/components/ui/badge";
import { Calendar, TrendingUp, Award, Target, BarChart3 } from "lucide-react";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

export default function History() {
  const { user } = useAuth();
  
  const { data: employee } = trpc.employees.getByUserId.useQuery(
    { userId: user?.id || 0 },
    { enabled: !!user }
  );

  const { data: evaluations = [], isLoading: loadingEvaluations } = trpc.history.evaluations.useQuery(
    { employeeId: employee?.id || 0 },
    { enabled: !!employee }
  );

  const { data: pdis = [], isLoading: loadingPdis } = trpc.history.pdis.useQuery(
    { employeeId: employee?.id || 0 },
    { enabled: !!employee }
  );

  const { data: nineBoxHistory = [], isLoading: loadingNineBox } = trpc.history.nineBox.useQuery(
    { employeeId: employee?.id || 0 },
    { enabled: !!employee }
  );

  const { data: competencies = [], isLoading: loadingCompetencies } = trpc.history.competenciesEvolution.useQuery(
    { employeeId: employee?.id || 0 },
    { enabled: !!employee }
  );

  const getStatusBadge = (status: string) => {
    const variants: Record<string, "default" | "secondary" | "destructive" | "outline"> = {
      concluida: "default",
      em_andamento: "secondary",
      pendente: "outline",
      cancelada: "destructive",
    };
    
    const labels: Record<string, string> = {
      concluida: "ConcluÃ­da",
      em_andamento: "Em Andamento",
      pendente: "Pendente",
      cancelada: "Cancelada",
    };

    return (
      <Badge variant={variants[status] || "outline"}>
        {labels[status] || status}
      </Badge>
    );
  };

  const getBoxLabel = (box: string) => {
    const labels: Record<string, { label: string; color: string }> = {
      alto_alto: { label: "Alto Desempenho Ã— Alto Potencial", color: "text-green-600" },
      alto_medio: { label: "Alto Desempenho Ã— MÃ©dio Potencial", color: "text-blue-600" },
      alto_baixo: { label: "Alto Desempenho Ã— Baixo Potencial", color: "text-yellow-600" },
      medio_alto: { label: "MÃ©dio Desempenho Ã— Alto Potencial", color: "text-purple-600" },
      medio_medio: { label: "MÃ©dio Desempenho Ã— MÃ©dio Potencial", color: "text-gray-600" },
      medio_baixo: { label: "MÃ©dio Desempenho Ã— Baixo Potencial", color: "text-orange-600" },
      baixo_alto: { label: "Baixo Desempenho Ã— Alto Potencial", color: "text-indigo-600" },
      baixo_medio: { label: "Baixo Desempenho Ã— MÃ©dio Potencial", color: "text-red-400" },
      baixo_baixo: { label: "Baixo Desempenho Ã— Baixo Potencial", color: "text-red-600" },
    };

    return labels[box] || { label: box, color: "text-gray-600" };
  };

  if (!employee) {
    return (
      <div className="container py-8">
        <Card>
          <CardContent className="py-12 text-center">
            <p className="text-muted-foreground">
              VocÃª precisa estar vinculado a um colaborador para visualizar o histÃ³rico.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="container py-8">
      <div className="mb-8">
        <h1 className="text-3xl font-bold flex items-center gap-2">
          <BarChart3 className="h-8 w-8" />
          Meu HistÃ³rico
        </h1>
        <p className="text-muted-foreground mt-2">
          Acompanhe sua evoluÃ§Ã£o profissional ao longo do tempo
        </p>
      </div>

      <Tabs defaultValue="evaluations" className="space-y-6">
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="evaluations" className="flex items-center gap-2">
            <Award className="h-4 w-4" />
            AvaliaÃ§Ãµes 360Â°
          </TabsTrigger>
          <TabsTrigger value="pdis" className="flex items-center gap-2">
            <Target className="h-4 w-4" />
            PDIs
          </TabsTrigger>
          <TabsTrigger value="ninebox" className="flex items-center gap-2">
            <TrendingUp className="h-4 w-4" />
            Matriz 9-Box
          </TabsTrigger>
          <TabsTrigger value="competencies" className="flex items-center gap-2">
            <BarChart3 className="h-4 w-4" />
            CompetÃªncias
          </TabsTrigger>
        </TabsList>

        {/* AVALIAÃ‡Ã•ES 360Â° */}
        <TabsContent value="evaluations" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>HistÃ³rico de AvaliaÃ§Ãµes 360Â°</CardTitle>
              <CardDescription>
                Todas as suas avaliaÃ§Ãµes de desempenho anteriores
              </CardDescription>
            </CardHeader>
            <CardContent>
              {loadingEvaluations ? (
                <p className="text-center text-muted-foreground py-8">Carregando...</p>
              ) : evaluations.length === 0 ? (
                <p className="text-center text-muted-foreground py-8">
                  Nenhuma avaliaÃ§Ã£o encontrada
                </p>
              ) : (
                <div className="space-y-4">
                  {evaluations.map((evaluation) => (
                    <Card key={evaluation.id}>
                      <CardContent className="pt-6">
                        <div className="flex items-start justify-between">
                          <div className="space-y-2">
                            <div className="flex items-center gap-3">
                              <Badge variant="outline">{evaluation.type}</Badge>
                              {getStatusBadge(evaluation.status)}
                            </div>
                            <div className="flex items-center gap-2 text-sm text-muted-foreground">
                              <Calendar className="h-4 w-4" />
                              {evaluation.createdAt && format(new Date(evaluation.createdAt), "dd 'de' MMMM 'de' yyyy", { locale: ptBR })}
                            </div>
                            {evaluation.completedAt && (
                              <p className="text-sm text-muted-foreground">
                                ConcluÃ­da em: {format(new Date(evaluation.completedAt), "dd/MM/yyyy")}
                              </p>
                            )}
                          </div>
                          {evaluation.finalScore !== null && (
                            <div className="text-right">
                              <p className="text-3xl font-bold text-primary">
                                {evaluation.finalScore}
                              </p>
                              <p className="text-sm text-muted-foreground">Nota Final</p>
                            </div>
                          )}
                        </div>
                        <div className="mt-4 grid grid-cols-4 gap-4 text-sm">
                          <div>
                            <p className="text-muted-foreground">AutoavaliaÃ§Ã£o</p>
                            <p className="font-medium">
                              {evaluation.selfEvaluationCompleted ? "âœ“ ConcluÃ­da" : "Pendente"}
                            </p>
                          </div>
                          <div>
                            <p className="text-muted-foreground">Gestor</p>
                            <p className="font-medium">
                              {evaluation.managerEvaluationCompleted ? "âœ“ ConcluÃ­da" : "Pendente"}
                            </p>
                          </div>
                          <div>
                            <p className="text-muted-foreground">Pares</p>
                            <p className="font-medium">
                              {evaluation.peersEvaluationCompleted ? "âœ“ ConcluÃ­da" : "Pendente"}
                            </p>
                          </div>
                          <div>
                            <p className="text-muted-foreground">Subordinados</p>
                            <p className="font-medium">
                              {evaluation.subordinatesEvaluationCompleted ? "âœ“ ConcluÃ­da" : "Pendente"}
                            </p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* PDIs */}
        <TabsContent value="pdis" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>HistÃ³rico de PDIs</CardTitle>
              <CardDescription>
                Todos os seus Planos de Desenvolvimento Individual
              </CardDescription>
            </CardHeader>
            <CardContent>
              {loadingPdis ? (
                <p className="text-center text-muted-foreground py-8">Carregando...</p>
              ) : pdis.length === 0 ? (
                <p className="text-center text-muted-foreground py-8">
                  Nenhum PDI encontrado
                </p>
              ) : (
                <div className="space-y-4">
                  {pdis.map((pdi) => (
                    <Card key={pdi.id}>
                      <CardContent className="pt-6">
                        <div className="flex items-start justify-between">
                          <div className="space-y-2">
                            <div className="flex items-center gap-3">
                              <h3 className="font-semibold">
                                PDI {pdi.startDate && format(new Date(pdi.startDate), "yyyy")}
                              </h3>
                              {getStatusBadge(pdi.status)}
                            </div>
                            <div className="flex items-center gap-2 text-sm text-muted-foreground">
                              <Calendar className="h-4 w-4" />
                              {pdi.startDate && pdi.endDate && (
                                <>
                                  {format(new Date(pdi.startDate), "dd/MM/yyyy")} atÃ© {format(new Date(pdi.endDate), "dd/MM/yyyy")}
                                </>
                              )}
                            </div>

                          </div>
                          <div className="text-right">
                            <p className="text-3xl font-bold text-primary">
                              {pdi.overallProgress}%
                            </p>
                            <p className="text-sm text-muted-foreground">Progresso</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* MATRIZ 9-BOX */}
        <TabsContent value="ninebox" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>HistÃ³rico de Posicionamento 9-Box</CardTitle>
              <CardDescription>
                Sua evoluÃ§Ã£o na Matriz de Desempenho Ã— Potencial
              </CardDescription>
            </CardHeader>
            <CardContent>
              {loadingNineBox ? (
                <p className="text-center text-muted-foreground py-8">Carregando...</p>
              ) : nineBoxHistory.length === 0 ? (
                <p className="text-center text-muted-foreground py-8">
                  Nenhum posicionamento encontrado
                </p>
              ) : (
                <div className="space-y-4">
                  {nineBoxHistory.map((position) => {
                    const boxInfo = getBoxLabel(position.box);
                    return (
                      <Card key={position.id}>
                        <CardContent className="pt-6">
                          <div className="flex items-start justify-between">
                            <div className="space-y-2">
                              <h3 className={`font-semibold text-lg ${boxInfo.color}`}>
                                {boxInfo.label}
                              </h3>
                              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                                <Calendar className="h-4 w-4" />
                                {position.createdAt && format(new Date(position.createdAt), "dd 'de' MMMM 'de' yyyy", { locale: ptBR })}
                              </div>
                              {position.calibrated && (
                                <Badge variant="outline">Calibrado</Badge>
                              )}
                              {position.notes && (
                                <p className="text-sm text-muted-foreground mt-2">{position.notes}</p>
                              )}
                            </div>
                            <div className="text-right space-y-2">
                              <div>
                                <p className="text-2xl font-bold text-primary">
                                  {position.performance}
                                </p>
                                <p className="text-xs text-muted-foreground">Desempenho</p>
                              </div>
                              <div>
                                <p className="text-2xl font-bold text-purple-600">
                                  {position.potential}
                                </p>
                                <p className="text-xs text-muted-foreground">Potencial</p>
                              </div>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    );
                  })}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* COMPETÃŠNCIAS */}
        <TabsContent value="competencies" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>EvoluÃ§Ã£o de CompetÃªncias</CardTitle>
              <CardDescription>
                Suas competÃªncias avaliadas e nÃ­veis atuais
              </CardDescription>
            </CardHeader>
            <CardContent>
              {loadingCompetencies ? (
                <p className="text-center text-muted-foreground py-8">Carregando...</p>
              ) : competencies.length === 0 ? (
                <p className="text-center text-muted-foreground py-8">
                  Nenhuma competÃªncia avaliada
                </p>
              ) : (
                <div className="space-y-3">
                  {competencies.map((comp: any) => (
                    <div key={comp.id} className="flex items-center justify-between p-4 border rounded-lg">
                      <div>
                        <p className="font-medium">{comp.competency?.name || "CompetÃªncia"}</p>
                        <p className="text-sm text-muted-foreground">
                          {comp.competency?.category || ""}
                        </p>
                      </div>
                      <div className="text-right">
                        <p className="text-2xl font-bold text-primary">
                          NÃ­vel {comp.currentLevel}
                        </p>
                        <p className="text-xs text-muted-foreground">
                          {comp.evaluatedAt && format(new Date(comp.evaluatedAt), "dd/MM/yyyy")}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/Home.tsx
========================================
import { trpc } from "@/lib/trpc";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { BarChart3, Goal, Target, TrendingUp, Users, AlertCircle } from "lucide-react";
import { Link } from "wouter";

export default function Home() {
  const { data: employee } = trpc.employees.getCurrent.useQuery();
  const { data: stats } = trpc.dashboard.getStats.useQuery({});
  const { data: goals } = trpc.goals.list.useQuery({});
  const { data: pdis } = trpc.pdi.list.useQuery({});

  const activeGoals = goals?.filter(g => g.status === "em_andamento") || [];
  const activePDIs = pdis?.filter(p => p.status === "em_andamento" || p.status === "aprovado") || [];

  return (
    <DashboardLayout>
      <div className="space-y-8">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold tracking-tight">
            OlÃ¡, {employee?.name || "Colaborador"}! ðŸ‘‹
          </h1>
          <p className="text-muted-foreground mt-2">
            Acompanhe seu desempenho e desenvolvimento profissional
          </p>
        </div>

        {/* Stats Cards */}
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Metas Ativas</CardTitle>
              <Target className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{stats?.goalsCount || 0}</div>
              <p className="text-xs text-muted-foreground">
                {activeGoals.length} em andamento
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">AvaliaÃ§Ãµes</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{stats?.evaluationsCount || 0}</div>
              <p className="text-xs text-muted-foreground">
                Ciclo {stats?.cycle?.year || new Date().getFullYear()}
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">PDI Ativos</CardTitle>
              <TrendingUp className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{stats?.pdisCount || 0}</div>
              <p className="text-xs text-muted-foreground">
                {activePDIs.length} em desenvolvimento
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Ciclo Atual</CardTitle>
              <BarChart3 className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{stats?.cycle?.year ?? "-"}</div>
              <p className="text-xs text-muted-foreground">
                {stats?.cycle?.name ?? "Nenhum ciclo ativo"}
              </p>
            </CardContent>
          </Card>
        </div>

        {/* Main Content Grid */}
        <div className="grid gap-6 lg:grid-cols-2">
          {/* Metas em Andamento */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Goal className="h-5 w-5" />
                Metas em Andamento
              </CardTitle>
              <CardDescription>
                Acompanhe o progresso das suas metas
              </CardDescription>
            </CardHeader>
            <CardContent>
              {activeGoals.length === 0 ? (
                <div className="text-center py-8 text-muted-foreground">
                  <AlertCircle className="h-12 w-12 mx-auto mb-3 opacity-50" />
                  <p>Nenhuma meta em andamento</p>
                  <Button variant="link" asChild className="mt-2">
                    <Link href="/metas">Ver todas as metas</Link>
                  </Button>
                </div>
              ) : (
                <div className="space-y-4">
                  {activeGoals.slice(0, 3).map((goal) => (
                    <div key={goal.id} className="space-y-2">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <p className="font-medium">{goal.title}</p>
                          <div className="flex items-center gap-2 mt-1">
                            <Badge variant={goal.linkedToPLR ? "default" : "secondary"} className="text-xs">
                              {goal.linkedToPLR ? "PLR" : goal.linkedToBonus ? "BÃ´nus" : "Regular"}
                            </Badge>
                            <span className="text-xs text-muted-foreground">
                              {new Date(goal.endDate).toLocaleDateString("pt-BR")}
                            </span>
                          </div>
                        </div>
                        <span className="text-sm font-semibold">{goal.progress}%</span>
                      </div>
                      <Progress value={goal.progress} className="h-2" />
                    </div>
                  ))}
                  {activeGoals.length > 3 && (
                    <Button variant="link" asChild className="w-full">
                      <Link href="/metas">Ver todas ({activeGoals.length})</Link>
                    </Button>
                  )}
                </div>
              )}
            </CardContent>
          </Card>

          {/* PDI em Desenvolvimento */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingUp className="h-5 w-5" />
                Plano de Desenvolvimento
              </CardTitle>
              <CardDescription>
                Seu progresso no desenvolvimento profissional
              </CardDescription>
            </CardHeader>
            <CardContent>
              {activePDIs.length === 0 ? (
                <div className="text-center py-8 text-muted-foreground">
                  <AlertCircle className="h-12 w-12 mx-auto mb-3 opacity-50" />
                  <p>Nenhum PDI ativo</p>
                  <Button variant="link" asChild className="mt-2">
                    <Link href="/pdi">Criar PDI</Link>
                  </Button>
                </div>
              ) : (
                <div className="space-y-4">
                  {activePDIs.slice(0, 2).map((pdi) => (
                    <div key={pdi.id} className="space-y-2 p-4 border rounded-lg">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <p className="font-medium">
                            PDI {new Date(pdi.startDate).getFullYear()}
                          </p>
                          <p className="text-sm text-muted-foreground mt-1">
                            {new Date(pdi.startDate).toLocaleDateString("pt-BR")} atÃ©{" "}
                            {new Date(pdi.endDate).toLocaleDateString("pt-BR")}
                          </p>
                        </div>
                        <Badge variant={pdi.status === "aprovado" ? "default" : "secondary"}>
                          {pdi.status === "aprovado" ? "Aprovado" : "Em andamento"}
                        </Badge>
                      </div>
                      <div className="space-y-1">
                        <div className="flex justify-between text-sm">
                          <span className="text-muted-foreground">Progresso geral</span>
                          <span className="font-semibold">{pdi.overallProgress}%</span>
                        </div>
                        <Progress value={pdi.overallProgress} className="h-2" />
                      </div>
                    </div>
                  ))}
                  <Button variant="link" asChild className="w-full">
                    <Link href="/pdi">Ver detalhes</Link>
                  </Button>
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        {/* Quick Actions */}
        <Card>
          <CardHeader>
            <CardTitle>AÃ§Ãµes RÃ¡pidas</CardTitle>
            <CardDescription>
              Acesse rapidamente as principais funcionalidades
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
              <Button variant="outline" asChild className="justify-start h-auto py-4">
                <Link href="/metas">
                  <div className="flex flex-col items-start gap-1 w-full">
                    <div className="flex items-center gap-2">
                      <Target className="h-4 w-4" />
                      <span className="font-semibold">Metas</span>
                    </div>
                    <span className="text-xs text-muted-foreground">
                      Gerenciar metas
                    </span>
                  </div>
                </Link>
              </Button>

              <Button variant="outline" asChild className="justify-start h-auto py-4">
                <Link href="/avaliacoes">
                  <div className="flex flex-col items-start gap-1 w-full">
                    <div className="flex items-center gap-2">
                      <Users className="h-4 w-4" />
                      <span className="font-semibold">AvaliaÃ§Ãµes</span>
                    </div>
                    <span className="text-xs text-muted-foreground">
                      AvaliaÃ§Ã£o 360Â°
                    </span>
                  </div>
                </Link>
              </Button>

              <Button variant="outline" asChild className="justify-start h-auto py-4">
                <Link href="/pdi">
                  <div className="flex flex-col items-start gap-1 w-full">
                    <div className="flex items-center gap-2">
                      <TrendingUp className="h-4 w-4" />
                      <span className="font-semibold">PDI</span>
                    </div>
                    <span className="text-xs text-muted-foreground">
                      Desenvolvimento
                    </span>
                  </div>
                </Link>
              </Button>

              <Button variant="outline" asChild className="justify-start h-auto py-4">
                <Link href="/nine-box">
                  <div className="flex flex-col items-start gap-1 w-full">
                    <div className="flex items-center gap-2">
                      <BarChart3 className="h-4 w-4" />
                      <span className="font-semibold">9-Box</span>
                    </div>
                    <span className="text-xs text-muted-foreground">
                      Matriz de talentos
                    </span>
                  </div>
                </Link>
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/MapaSucessaoCompleto.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Loader2, Users, TrendingUp, AlertTriangle, Plus, Download, Info } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { toast } from "sonner";

/**
 * Mapa de SucessÃ£o Completo
 * ImplementaÃ§Ã£o conforme imagens fornecidas pelo usuÃ¡rio
 * 
 * Features:
 * - EstatÃ­sticas no topo (PosiÃ§Ãµes CrÃ­ticas, Sucessores Prontos, Sem Sucessor, % Cobertura)
 * - Cards de posiÃ§Ã£o com badges de risco/impacto
 * - FormulÃ¡rio completo de adicionar sucessor com todos os campos
 * - Filtros por departamento, nÃ­vel de risco, impacto e cobertura
 */

export default function MapaSucessaoCompleto() {
  const [selectedPlanId, setSelectedPlanId] = useState<number | null>(null);
  const [isAddSuccessorOpen, setIsAddSuccessorOpen] = useState(false);
  const [departmentFilter, setDepartmentFilter] = useState("todos");
  const [riskFilter, setRiskFilter] = useState("todos");
  const [impactFilter, setImpactFilter] = useState("todos");
  const [coverageFilter, setCoverageFilter] = useState("todos");

  // Form state para adicionar sucessor
  const [formData, setFormData] = useState({
    employeeId: "",
    readinessLevel: "1_ano" as "imediato" | "1_ano" | "2_3_anos" | "mais_3_anos",
    priority: 1,
    performanceRating: "medio" as "baixo" | "medio" | "alto" | "excepcional",
    potentialRating: "medio" as "baixo" | "medio" | "alto" | "excepcional",
    nineBoxPosition: "",
    gapAnalysis: "",
    developmentActions: "",
    notes: "",
  });

  // Queries
  const { data: plansRaw, isLoading, refetch } = trpc.succession.list.useQuery();
  const { data: employees } = trpc.employees.list.useQuery();
  
  // Mutation para adicionar sucessor
  const addSuccessorMutation = trpc.succession.addSuccessor.useMutation({
    onSuccess: () => {
      toast.success("Sucessor adicionado com sucesso!");
      setIsAddSuccessorOpen(false);
      refetch();
      resetForm();
    },
    onError: (error: any) => {
      toast.error(`Erro ao adicionar sucessor: ${error.message}`);
    },
  });

  const resetForm = () => {
    setFormData({
      employeeId: "",
      readinessLevel: "1_ano",
      priority: 1,
      performanceRating: "medio",
      potentialRating: "medio",
      nineBoxPosition: "",
      gapAnalysis: "",
      developmentActions: "",
      notes: "",
    });
  };

  const handleSubmit = () => {
    if (!selectedPlanId) {
      toast.error("Selecione uma posiÃ§Ã£o primeiro");
      return;
    }
    if (!formData.employeeId) {
      toast.error("Selecione um candidato");
      return;
    }

    addSuccessorMutation.mutate({
      planId: selectedPlanId,
      employeeId: parseInt(formData.employeeId),
      readinessLevel: formData.readinessLevel,
      priority: formData.priority,
      performanceRating: formData.performanceRating,
      potentialRating: formData.potentialRating,
      nineBoxPosition: formData.nineBoxPosition || undefined,
      gapAnalysis: formData.gapAnalysis || undefined,
      developmentActions: formData.developmentActions || undefined,
      notes: formData.notes || undefined,
    });
  };

  // Processar dados e calcular estatÃ­sticas
  const plans = plansRaw || [];
  const critical = plans.filter((p: any) => p.isCritical).length;
  const ready = plans.filter((p: any) => p.successors?.some((s: any) => s.readinessLevel === "imediato")).length;
  const noSuccessor = plans.filter((p: any) => !p.successors || p.successors.length === 0).length;
  const coverage = plans.length > 0 ? Math.round(((plans.length - noSuccessor) / plans.length) * 100) : 0;
  const stats = { critical, ready, noSuccessor, coverage };

  // Filtrar planos
  const filteredPlans = plans.filter((p: any) => {
    if (riskFilter !== "todos" && p.riskLevel !== riskFilter) return false;
    if (coverageFilter === "sem-sucessor" && p.successors && p.successors.length > 0) return false;
    if (coverageFilter === "com-sucessor" && (!p.successors || p.successors.length === 0)) return false;
    return true;
  });

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <div className="flex items-center gap-2">
              <Users className="h-6 w-6 text-primary" />
              <h1 className="text-2xl font-bold">Mapa de SucessÃ£o</h1>
            </div>
            <p className="text-sm text-muted-foreground">
              Planejamento estratÃ©gico de sucessÃ£o - UISA
            </p>
          </div>
          <div className="flex items-center gap-3">
            <Button variant="outline">
              <Download className="h-4 w-4 mr-2" />
              Exportar
            </Button>
            <Button>
              <Plus className="h-4 w-4 mr-2" />
              Nova PosiÃ§Ã£o
            </Button>
          </div>
        </div>

        {/* EstatÃ­sticas */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                PosiÃ§Ãµes CrÃ­ticas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{stats.critical}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Sucessores Prontos
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-green-600">{stats.ready}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Sem Sucessor
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-red-600">{stats.noSuccessor}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                % Cobertura
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-blue-600">{stats.coverage}%</div>
            </CardContent>
          </Card>
        </div>

        {/* Filtros */}
        <Card>
          <CardContent className="pt-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <Label>Departamento</Label>
                <Select value={departmentFilter} onValueChange={setDepartmentFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="todos">Todos</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label>NÃ­vel de Risco</Label>
                <Select value={riskFilter} onValueChange={setRiskFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="todos">Todos</SelectItem>
                    <SelectItem value="baixo">Baixo</SelectItem>
                    <SelectItem value="medio">MÃ©dio</SelectItem>
                    <SelectItem value="alto">Alto</SelectItem>
                    <SelectItem value="critico">CrÃ­tico</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label>Impacto</Label>
                <Select value={impactFilter} onValueChange={setImpactFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="todos">Todos</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label>Cobertura</Label>
                <Select value={coverageFilter} onValueChange={setCoverageFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="todos">Todos</SelectItem>
                    <SelectItem value="sem-sucessor">Sem Sucessor</SelectItem>
                    <SelectItem value="com-sucessor">Com Sucessor</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Grid de PosiÃ§Ãµes */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {filteredPlans.map((plan: any) => {
            const successors = plan.successors || [];

            return (
              <Card key={plan.id} className="hover:shadow-lg transition-shadow">
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <CardTitle className="text-lg">{plan.positionTitle || "PosiÃ§Ã£o"}</CardTitle>
                      <p className="text-sm text-muted-foreground mt-1">
                        {plan.currentHolderName || "Sem ocupante"}
                      </p>
                    </div>
                    {successors.length === 0 && (
                      <Badge variant="destructive" className="ml-2">
                        Sem Sucessor
                      </Badge>
                    )}
                  </div>
                  <div className="flex items-center gap-2 mt-3">
                    <AlertTriangle className="h-4 w-4" />
                    <span className="text-xs">Risco: {plan.riskLevel || "undefined"}</span>
                    <span className="text-xs ml-auto">Impacto: {plan.exitRisk || "undefined"}</span>
                  </div>
                </CardHeader>

                <CardContent>
                  <div className="space-y-3">
                    <div>
                      <p className="text-sm font-medium mb-2">
                        Sucessores ({successors.length})
                      </p>
                      {successors.length === 0 ? (
                        <p className="text-sm text-muted-foreground italic">
                          Nenhum sucessor identificado
                        </p>
                      ) : (
                        <div className="space-y-1">
                          {successors.slice(0, 2).map((s: any) => (
                            <div key={s.id} className="text-sm">
                              â€¢ {s.employeeName || "Desconhecido"}
                            </div>
                          ))}
                          {successors.length > 2 && (
                            <p className="text-xs text-muted-foreground">
                              +{successors.length - 2} mais
                            </p>
                          )}
                        </div>
                      )}
                    </div>

                    <div className="flex items-center gap-2 pt-3 border-t">
                      <Button
                        variant="ghost"
                        size="sm"
                        className="flex-1"
                        onClick={() => {
                          // TODO: Ver detalhes
                        }}
                      >
                        <Info className="h-4 w-4 mr-1" />
                        Ver Detalhes
                      </Button>
                      <Dialog
                        open={isAddSuccessorOpen && selectedPlanId === plan.id}
                        onOpenChange={(open) => {
                          setIsAddSuccessorOpen(open);
                          if (open) {
                            setSelectedPlanId(plan.id);
                          } else {
                            setSelectedPlanId(null);
                            resetForm();
                          }
                        }}
                      >
                        <DialogTrigger asChild>
                          <Button
                            variant="default"
                            size="sm"
                            className="flex-1"
                            onClick={() => setSelectedPlanId(plan.id)}
                          >
                            <Plus className="h-4 w-4 mr-1" />
                            Adicionar
                          </Button>
                        </DialogTrigger>
                        <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
                          <DialogHeader>
                            <DialogTitle>Adicionar Sucessor</DialogTitle>
                            <div className="flex items-center gap-2 mt-2 p-3 bg-blue-50 rounded-md">
                              <Info className="h-5 w-5 text-blue-600" />
                              <p className="text-sm text-blue-900">
                                <strong>PosiÃ§Ã£o:</strong> {plan.positionTitle || "Gerente"}
                              </p>
                            </div>
                          </DialogHeader>

                          <div className="space-y-4 mt-4">
                            {/* Candidato/Sucessor */}
                            <div>
                              <Label>Candidato/Sucessor *</Label>
                              <Select
                                value={formData.employeeId}
                                onValueChange={(value) =>
                                  setFormData({ ...formData, employeeId: value })
                                }
                              >
                                <SelectTrigger>
                                  <SelectValue placeholder="Selecione o candidato..." />
                                </SelectTrigger>
                                <SelectContent>
                                  {employees?.map((emp) => (
                                    <SelectItem key={emp.employee.id} value={emp.employee.id.toString()}>
                                      {emp.employee.name}
                                    </SelectItem>
                                  ))}
                                </SelectContent>
                              </Select>
                              <p className="text-xs text-muted-foreground mt-1">
                                Selecione um colaborador ativo do sistema
                              </p>
                            </div>

                            {/* NÃ­vel de ProntidÃ£o e Prioridade */}
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <Label>NÃ­vel de ProntidÃ£o *</Label>
                                <Select
                                  value={formData.readinessLevel}
                                  onValueChange={(value: any) =>
                                    setFormData({ ...formData, readinessLevel: value })
                                  }
                                >
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="imediato">Pronto agora</SelectItem>
                                    <SelectItem value="1_ano">Pronto em 1-2 anos</SelectItem>
                                    <SelectItem value="2_3_anos">Pronto em 2-3 anos</SelectItem>
                                    <SelectItem value="mais_3_anos">Pronto em 3+ anos</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>

                              <div>
                                <Label>Prioridade *</Label>
                                <Select
                                  value={formData.priority.toString()}
                                  onValueChange={(value) =>
                                    setFormData({ ...formData, priority: parseInt(value) })
                                  }
                                >
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="1">1 - Principal</SelectItem>
                                    <SelectItem value="2">2 - SecundÃ¡rio</SelectItem>
                                    <SelectItem value="3">3 - Backup</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                            </div>

                            {/* AvaliaÃ§Ã£o de Desempenho e Potencial */}
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <Label>AvaliaÃ§Ã£o de Desempenho</Label>
                                <Select
                                  value={formData.performanceRating}
                                  onValueChange={(value: any) =>
                                    setFormData({ ...formData, performanceRating: value })
                                  }
                                >
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="baixo">Baixo</SelectItem>
                                    <SelectItem value="medio">MÃ©dio</SelectItem>
                                    <SelectItem value="alto">Alto</SelectItem>
                                    <SelectItem value="excepcional">Excepcional</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>

                              <div>
                                <Label>AvaliaÃ§Ã£o de Potencial</Label>
                                <Select
                                  value={formData.potentialRating}
                                  onValueChange={(value: any) =>
                                    setFormData({ ...formData, potentialRating: value })
                                  }
                                >
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="baixo">Baixo</SelectItem>
                                    <SelectItem value="medio">MÃ©dio</SelectItem>
                                    <SelectItem value="alto">Alto</SelectItem>
                                    <SelectItem value="excepcional">Excepcional</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                            </div>

                            {/* PosiÃ§Ã£o Nine Box */}
                            <div>
                              <Label>PosiÃ§Ã£o Nine Box</Label>
                              <Select
                                value={formData.nineBoxPosition}
                                onValueChange={(value) =>
                                  setFormData({ ...formData, nineBoxPosition: value })
                                }
                              >
                                <SelectTrigger>
                                  <SelectValue placeholder="Selecione a posiÃ§Ã£o..." />
                                </SelectTrigger>
                                <SelectContent>
                                  <SelectItem value="alto-potencial">Alto Potencial</SelectItem>
                                  <SelectItem value="alto-desempenho">Alto Desempenho</SelectItem>
                                  <SelectItem value="estrela">Estrela</SelectItem>
                                  <SelectItem value="talento-chave">Talento Chave</SelectItem>
                                  <SelectItem value="solido">SÃ³lido</SelectItem>
                                  <SelectItem value="enigma">Enigma</SelectItem>
                                  <SelectItem value="baixo-desempenho">Baixo Desempenho</SelectItem>
                                </SelectContent>
                              </Select>
                            </div>

                            {/* AnÃ¡lise de Gaps */}
                            <div>
                              <Label>AnÃ¡lise de Gaps (Lacunas)</Label>
                              <Textarea
                                placeholder="Descreva as competÃªncias ou experiÃªncias que o candidato ainda precisa desenvolver..."
                                value={formData.gapAnalysis}
                                onChange={(e) =>
                                  setFormData({ ...formData, gapAnalysis: e.target.value })
                                }
                                rows={3}
                              />
                            </div>

                            {/* AÃ§Ãµes de Desenvolvimento Recomendadas */}
                            <div>
                              <Label>AÃ§Ãµes de Desenvolvimento Recomendadas</Label>
                              <Textarea
                                placeholder="Liste as aÃ§Ãµes de desenvolvimento recomendadas (treinamentos, projetos, mentoria, etc.)..."
                                value={formData.developmentActions}
                                onChange={(e) =>
                                  setFormData({ ...formData, developmentActions: e.target.value })
                                }
                                rows={3}
                              />
                            </div>

                            {/* Notas */}
                            <div>
                              <Label>Notas Adicionais</Label>
                              <Textarea
                                placeholder="ObservaÃ§Ãµes adicionais..."
                                value={formData.notes}
                                onChange={(e) =>
                                  setFormData({ ...formData, notes: e.target.value })
                                }
                                rows={2}
                              />
                            </div>

                            {/* BotÃµes */}
                            <div className="flex items-center gap-3 pt-4 border-t">
                              <Button
                                variant="outline"
                                className="flex-1"
                                onClick={() => {
                                  setIsAddSuccessorOpen(false);
                                  resetForm();
                                }}
                              >
                                Cancelar
                              </Button>
                              <Button
                                className="flex-1"
                                onClick={handleSubmit}
                                disabled={addSuccessorMutation.isPending}
                              >
                                {addSuccessorMutation.isPending && (
                                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                                )}
                                Salvar AlteraÃ§Ãµes
                              </Button>
                            </div>
                          </div>
                        </DialogContent>
                      </Dialog>
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>

        {filteredPlans.length === 0 && (
          <Card>
            <CardContent className="py-12 text-center">
              <Users className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
              <h3 className="text-lg font-semibold mb-2">Nenhuma posiÃ§Ã£o encontrada</h3>
              <p className="text-sm text-muted-foreground mb-4">
                Comece adicionando a primeira posiÃ§Ã£o crÃ­tica ao mapa de sucessÃ£o
              </p>
              <Button>
                <Plus className="h-4 w-4 mr-2" />
                Adicionar Primeira PosiÃ§Ã£o
              </Button>
            </CardContent>
          </Card>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Metas.tsx
========================================
import DashboardLayout from "@/components/DashboardLayout";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Progress } from "@/components/ui/progress";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { trpc } from "@/lib/trpc";
import { downloadICS } from "@/lib/generateICS";
import { AlertCircle, Calendar, CalendarPlus, CheckCircle2, Clock, Plus, Target, TrendingUp } from "lucide-react";
import { useState } from "react";
import { toast } from "sonner";

export default function Metas() {
  const [open, setOpen] = useState(false);
  const [editingGoal, setEditingGoal] = useState<any>(null);
  
  const { data: goals, refetch } = trpc.goals.list.useQuery({});
  const { data: employee } = trpc.employees.getCurrent.useQuery();
  const createGoal = trpc.goals.create.useMutation();
  const updateProgress = trpc.goals.updateProgress.useMutation();

  const [formData, setFormData] = useState({
    title: "",
    description: "",
    type: "individual" as "individual" | "equipe" | "organizacional",
    category: "quantitativa" as "quantitativa" | "qualitativa",
    targetValue: "",
    unit: "",
    weight: 1,
    startDate: new Date().toISOString().split('T')[0],
    endDate: "",
    linkedToPLR: false,
    linkedToBonus: false,
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!employee?.id) {
      toast.error("Colaborador nÃ£o encontrado");
      return;
    }

    try {
      await createGoal.mutateAsync({
        ...formData,
        employeeId: employee.id,
        cycleId: 1, // TODO: pegar ciclo ativo
        weight: Number(formData.weight),
        startDate: new Date(formData.startDate),
        endDate: new Date(formData.endDate),
      });

      toast.success("Meta criada com sucesso!");
      setOpen(false);
      setFormData({
        title: "",
        description: "",
        type: "individual",
        category: "quantitativa",
        targetValue: "",
        unit: "",
        weight: 1,
        startDate: new Date().toISOString().split('T')[0],
        endDate: "",
        linkedToPLR: false,
        linkedToBonus: false,
      });
      refetch();
    } catch (error) {
      toast.error("Erro ao criar meta");
      console.error(error);
    }
  };

  const handleUpdateProgress = async (goalId: number, currentValue: string, progress: number) => {
    try {
      await updateProgress.mutateAsync({
        id: goalId,
        currentValue,
        progress,
      });
      toast.success("Progresso atualizado!");
      refetch();
    } catch (error) {
      toast.error("Erro ao atualizar progresso");
    }
  };

  const getStatusBadge = (status: string) => {
    const variants: Record<string, { variant: any; label: string; icon: any }> = {
      rascunho: { variant: "secondary", label: "Rascunho", icon: Clock },
      pendente_aprovacao: { variant: "outline", label: "Pendente", icon: AlertCircle },
      em_andamento: { variant: "default", label: "Em Andamento", icon: TrendingUp },
      concluida: { variant: "default", label: "ConcluÃ­da", icon: CheckCircle2 },
      cancelada: { variant: "destructive", label: "Cancelada", icon: AlertCircle },
    };

    const config = variants[status] || variants.rascunho;
    const Icon = config.icon;

    return (
      <Badge variant={config.variant} className="gap-1">
        <Icon className="h-3 w-3" />
        {config.label}
      </Badge>
    );
  };

  const activeGoals = goals?.filter(g => g.status === "em_andamento") || [];
  const draftGoals = goals?.filter(g => g.status === "rascunho") || [];
  const completedGoals = goals?.filter(g => g.status === "concluida") || [];

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <Target className="h-8 w-8" />
              Minhas Metas
            </h1>
            <p className="text-muted-foreground mt-2">
              Gerencie e acompanhe suas metas de desempenho
            </p>
          </div>
          <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
              <Button size="lg">
                <Plus className="h-4 w-4 mr-2" />
                Nova Meta
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
              <DialogHeader>
                <DialogTitle>Criar Nova Meta</DialogTitle>
                <DialogDescription>
                  Defina uma nova meta de desempenho para acompanhar seu progresso
                </DialogDescription>
              </DialogHeader>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="title">TÃ­tulo da Meta *</Label>
                  <Input
                    id="title"
                    required
                    value={formData.title}
                    onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                    placeholder="Ex: Aumentar vendas em 20%"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="description">DescriÃ§Ã£o</Label>
                  <Textarea
                    id="description"
                    value={formData.description}
                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    placeholder="Descreva os detalhes da meta..."
                    rows={3}
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="type">Tipo</Label>
                    <Select
                      value={formData.type}
                      onValueChange={(value) => setFormData({ ...formData, type: value as "individual" | "equipe" | "organizacional" })}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="individual">Individual</SelectItem>
                        <SelectItem value="equipe">Equipe</SelectItem>
                        <SelectItem value="departamento">Departamento</SelectItem>
                        <SelectItem value="empresa">Empresa</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="category">Categoria</Label>
                    <Select
                      value={formData.category}
                      onValueChange={(value) => setFormData({ ...formData, category: value as "quantitativa" | "qualitativa" })}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="quantitativa">Quantitativa</SelectItem>
                        <SelectItem value="qualitativa">Qualitativa</SelectItem>
                        <SelectItem value="projeto">Projeto</SelectItem>
                        <SelectItem value="comportamental">Comportamental</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="targetValue">Valor Alvo *</Label>
                    <Input
                      id="targetValue"
                      required
                      value={formData.targetValue}
                      onChange={(e) => setFormData({ ...formData, targetValue: e.target.value })}
                      placeholder="100"
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="unit">Unidade *</Label>
                    <Input
                      id="unit"
                      required
                      value={formData.unit}
                      onChange={(e) => setFormData({ ...formData, unit: e.target.value })}
                      placeholder="vendas, %, projetos..."
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="weight">Peso (1-5)</Label>
                    <Input
                      id="weight"
                      type="number"
                      min="1"
                      max="5"
                      value={formData.weight}
                      onChange={(e) => setFormData({ ...formData, weight: Number(e.target.value) })}
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="startDate">Data InÃ­cio *</Label>
                    <Input
                      id="startDate"
                      type="date"
                      required
                      value={formData.startDate}
                      onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="endDate">Data Fim *</Label>
                    <Input
                      id="endDate"
                      type="date"
                      required
                      value={formData.endDate}
                      onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                    />
                  </div>
                </div>

                <div className="space-y-3">
                  <Label>VinculaÃ§Ãµes</Label>
                  <div className="flex gap-4">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={formData.linkedToPLR}
                        onChange={(e) => setFormData({ ...formData, linkedToPLR: e.target.checked })}
                        className="rounded"
                      />
                      <span className="text-sm">Vinculada a PLR</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={formData.linkedToBonus}
                        onChange={(e) => setFormData({ ...formData, linkedToBonus: e.target.checked })}
                        className="rounded"
                      />
                      <span className="text-sm">Vinculada a BÃ´nus</span>
                    </label>
                  </div>
                </div>

                <DialogFooter>
                  <Button type="button" variant="outline" onClick={() => setOpen(false)}>
                    Cancelar
                  </Button>
                  <Button type="submit" disabled={createGoal.isPending}>
                    {createGoal.isPending ? "Criando..." : "Criar Meta"}
                  </Button>
                </DialogFooter>
              </form>
            </DialogContent>
          </Dialog>
        </div>

        {/* Stats */}
        <div className="grid gap-4 md:grid-cols-3">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Em Andamento
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{activeGoals.length}</div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Rascunhos
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{draftGoals.length}</div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                ConcluÃ­das
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{completedGoals.length}</div>
            </CardContent>
          </Card>
        </div>

        {/* Goals List */}
        <div className="space-y-4">
          {goals?.length === 0 ? (
            <Card>
              <CardContent className="flex flex-col items-center justify-center py-12">
                <Target className="h-12 w-12 text-muted-foreground mb-4" />
                <h3 className="font-semibold text-lg mb-2">Nenhuma meta cadastrada</h3>
                <p className="text-muted-foreground text-center mb-4">
                  Comece criando sua primeira meta de desempenho
                </p>
                <Button onClick={() => setOpen(true)}>
                  <Plus className="h-4 w-4 mr-2" />
                  Criar Primeira Meta
                </Button>
              </CardContent>
            </Card>
          ) : (
            goals?.map((goal) => (
              <Card key={goal.id}>
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <CardTitle className="flex items-center gap-2">
                        {goal.title}
                        {getStatusBadge(goal.status)}
                      </CardTitle>
                      <CardDescription className="mt-2">
                        {goal.description}
                      </CardDescription>
                    </div>
                    <div className="flex gap-2">
                      {goal.linkedToPLR && (
                        <Badge variant="default">PLR</Badge>
                      )}
                      {goal.linkedToBonus && (
                        <Badge variant="secondary">BÃ´nus</Badge>
                      )}
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <p className="text-muted-foreground">Tipo</p>
                      <p className="font-medium capitalize">{goal.type}</p>
                    </div>
                    <div>
                      <p className="text-muted-foreground">Categoria</p>
                      <p className="font-medium capitalize">{goal.category}</p>
                    </div>
                    <div>
                      <p className="text-muted-foreground">Meta</p>
                      <p className="font-medium">
                        {goal.targetValue} {goal.unit}
                      </p>
                    </div>
                    <div>
                      <p className="text-muted-foreground">Atual</p>
                      <p className="font-medium">
                        {goal.currentValue || "0"} {goal.unit}
                      </p>
                    </div>
                  </div>

                  <div className="space-y-2">
                    <div className="flex items-center justify-between text-sm">
                      <span className="text-muted-foreground">Progresso</span>
                      <span className="font-semibold">{goal.progress}%</span>
                    </div>
                    <Progress value={goal.progress} className="h-2" />
                  </div>

                  <div className="flex items-center gap-4 text-sm text-muted-foreground">
                    <div className="flex items-center gap-1">
                      <Calendar className="h-4 w-4" />
                      {new Date(goal.startDate).toLocaleDateString("pt-BR")}
                    </div>
                    <span>â†’</span>
                    <div className="flex items-center gap-1">
                      <Calendar className="h-4 w-4" />
                      {new Date(goal.endDate).toLocaleDateString("pt-BR")}
                    </div>
                    <div className="ml-auto">
                      Peso: <span className="font-semibold">{goal.weight}</span>
                    </div>
                  </div>

                  <div className="flex gap-2 pt-2 border-t mt-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => {
                        downloadICS(
                          {
                            title: `Meta: ${goal.title}`,
                            description: `Tipo: ${goal.type}\nValor Alvo: ${goal.targetValue} ${goal.unit}\nPeso: ${goal.weight}`,
                            startDate: new Date(goal.startDate),
                            endDate: new Date(goal.endDate),
                          },
                          `meta-${goal.id}-${goal.title.replace(/\s+/g, "-").toLowerCase()}`
                        );
                        toast.success("Evento adicionado ao calendÃ¡rio!");
                      }}
                    >
                      <CalendarPlus className="h-4 w-4 mr-2" />
                      Adicionar ao CalendÃ¡rio
                    </Button>
                  </div>

                  {goal.status === "em_andamento" && (
                    <div className="flex gap-2 pt-2">
                      <Input
                        type="text"
                        placeholder="Valor atual"
                        className="max-w-xs"
                        onKeyDown={(e) => {
                          if (e.key === "Enter") {
                            const value = (e.target as HTMLInputElement).value;
                            if (value) {
                              const newProgress = Math.round((Number(value) / Number(goal.targetValue)) * 100);
                              handleUpdateProgress(goal.id, value, newProgress);
                              (e.target as HTMLInputElement).value = "";
                            }
                          }
                        }}
                      />
                      <Button variant="outline" size="sm">
                        Atualizar Progresso
                      </Button>
                    </div>
                  )}
                </CardContent>
              </Card>
            ))
          )}
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/MetasCascata.tsx
========================================
import { useState } from "react";
import { useLocation } from "wouter";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Loader2, ArrowLeft, Plus, Target, TrendingUp, Users, User, Building2, ChevronDown, ChevronRight } from "lucide-react";
import { trpc } from "@/lib/trpc";

/**
 * Metas em Cascata HierÃ¡rquico
 * 
 * VisualizaÃ§Ã£o em Ã¡rvore mostrando propagaÃ§Ã£o de metas:
 * Organizacional â†’ Departamental â†’ Individual
 */

interface GoalNode {
  id: number;
  title: string;
  type: "individual" | "equipe" | "organizacional";
  status: string;
  progress: number;
  alignmentPercentage: number;
  employeeId: number;
  departmentId: number | null;
  children: GoalNode[];
}

function GoalTreeNode({ node, level = 0 }: { node: GoalNode; level?: number }) {
  const [isExpanded, setIsExpanded] = useState(true);
  const hasChildren = node.children && node.children.length > 0;

  const getTypeIcon = (type: string) => {
    switch (type) {
      case "organizacional":
        return <Building2 className="h-4 w-4" />;
      case "equipe":
        return <Users className="h-4 w-4" />;
      case "individual":
        return <User className="h-4 w-4" />;
      default:
        return <Target className="h-4 w-4" />;
    }
  };

  const getTypeColor = (type: string) => {
    switch (type) {
      case "organizacional":
        return "bg-purple-100 text-purple-800 border-purple-300";
      case "equipe":
        return "bg-blue-100 text-blue-800 border-blue-300";
      case "individual":
        return "bg-green-100 text-green-800 border-green-300";
      default:
        return "bg-gray-100 text-gray-800 border-gray-300";
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case "concluida":
        return "bg-green-500";
      case "em_andamento":
        return "bg-blue-500";
      case "aprovada":
        return "bg-yellow-500";
      case "rascunho":
        return "bg-gray-400";
      default:
        return "bg-gray-300";
    }
  };

  const getAlignmentColor = (percentage: number) => {
    if (percentage >= 80) return "text-green-600";
    if (percentage >= 50) return "text-yellow-600";
    return "text-red-600";
  };

  return (
    <div className="relative">
      {/* Linha vertical conectando ao pai */}
      {level > 0 && (
        <div className="absolute left-0 top-0 w-px h-6 bg-gray-300" style={{ marginLeft: `${(level - 1) * 40 + 20}px` }} />
      )}

      {/* Card da meta */}
      <div className="flex items-start gap-2 mb-4" style={{ marginLeft: `${level * 40}px` }}>
        {/* BotÃ£o de expandir/colapsar */}
        {hasChildren && (
          <button
            onClick={() => setIsExpanded(!isExpanded)}
            className="flex-shrink-0 mt-3 p-1 hover:bg-gray-100 rounded"
          >
            {isExpanded ? (
              <ChevronDown className="h-4 w-4 text-gray-600" />
            ) : (
              <ChevronRight className="h-4 w-4 text-gray-600" />
            )}
          </button>
        )}
        {!hasChildren && <div className="w-6" />}

        {/* Card */}
        <Card className="flex-1 hover:shadow-md transition-shadow">
          <CardContent className="p-4">
            <div className="flex items-start justify-between gap-4">
              {/* InformaÃ§Ãµes principais */}
              <div className="flex-1 space-y-2">
                <div className="flex items-center gap-2">
                  <Badge className={`${getTypeColor(node.type)} border`}>
                    <span className="flex items-center gap-1">
                      {getTypeIcon(node.type)}
                      {node.type === "organizacional" ? "Organizacional" : node.type === "equipe" ? "Departamental" : "Individual"}
                    </span>
                  </Badge>
                  <span className="text-sm text-gray-500">#{node.id}</span>
                </div>

                <h4 className="font-semibold text-sm">{node.title}</h4>

                {/* Barra de progresso */}
                <div className="space-y-1">
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-gray-600">Progresso</span>
                    <span className="font-medium">{node.progress}%</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div
                      className={`${getStatusColor(node.status)} h-2 rounded-full transition-all`}
                      style={{ width: `${node.progress}%` }}
                    />
                  </div>
                </div>

                {/* Alinhamento com meta pai */}
                {level > 0 && (
                  <div className="flex items-center gap-2 text-xs">
                    <TrendingUp className="h-3 w-3 text-gray-500" />
                    <span className="text-gray-600">Alinhamento:</span>
                    <span className={`font-semibold ${getAlignmentColor(node.alignmentPercentage || 0)}`}>
                      {node.alignmentPercentage || 0}%
                    </span>
                  </div>
                )}
              </div>

              {/* Indicador de filhos */}
              {hasChildren && (
                <div className="flex-shrink-0 text-center">
                  <div className="text-2xl font-bold text-gray-700">{node.children.length}</div>
                  <div className="text-xs text-gray-500">
                    {node.children.length === 1 ? "meta filha" : "metas filhas"}
                  </div>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Renderizar filhos */}
      {hasChildren && isExpanded && (
        <div className="relative">
          {node.children.map((child) => (
            <GoalTreeNode key={child.id} node={child} level={level + 1} />
          ))}
        </div>
      )}
    </div>
  );
}

export default function MetasCascata() {
  const [, navigate] = useLocation();
  const [selectedCycleId] = useState(1); // TODO: Implementar seletor de ciclo

  // Query para buscar Ã¡rvore de metas
  const { data: tree, isLoading } = trpc.goalsCascade.getTree.useQuery({
    cycleId: selectedCycleId,
  });

  // Query para buscar estatÃ­sticas
  const { data: stats } = trpc.goalsCascade.getStats.useQuery({
    cycleId: selectedCycleId,
  });

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6 max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={() => navigate("/metas")}>
            <ArrowLeft className="h-5 w-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-2xl font-bold">Metas em Cascata HierÃ¡rquico</h1>
            <p className="text-sm text-muted-foreground">
              VisualizaÃ§Ã£o em Ã¡rvore da propagaÃ§Ã£o de metas organizacionais â†’ departamentais â†’ individuais
            </p>
          </div>
          <Button>
            <Plus className="h-4 w-4 mr-2" />
            Nova Meta
          </Button>
        </div>

        {/* EstatÃ­sticas */}
        {stats && (
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="text-sm font-medium text-gray-600">Total de Metas</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold">{stats.total}</div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="text-sm font-medium text-gray-600">Organizacionais</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-purple-600">{stats.organizacional}</div>
                <div className="text-xs text-gray-500 mt-1">
                  Alinhamento: {stats.avgAlignmentOrganizacional}%
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="text-sm font-medium text-gray-600">Departamentais</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-blue-600">{stats.departamental}</div>
                <div className="text-xs text-gray-500 mt-1">
                  Alinhamento: {stats.avgAlignmentDepartamental}%
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="text-sm font-medium text-gray-600">Individuais</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-green-600">{stats.individual}</div>
                <div className="text-xs text-gray-500 mt-1">
                  Alinhamento: {stats.avgAlignmentIndividual}%
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {/* Alinhamento Geral */}
        {stats && (
          <Card className="bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-semibold text-gray-900">Alinhamento Geral da Cascata</h3>
                  <p className="text-sm text-gray-600 mt-1">
                    MÃ©dia de alinhamento entre todos os nÃ­veis hierÃ¡rquicos
                  </p>
                </div>
                <div className="text-right">
                  <div className="text-5xl font-bold text-blue-600">{stats.avgAlignmentGeral}%</div>
                  <div className="text-sm text-gray-600 mt-1">
                    {stats.avgAlignmentGeral >= 80 ? "Excelente" : stats.avgAlignmentGeral >= 60 ? "Bom" : "Precisa melhorar"}
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Ãrvore de Metas */}
        <Card>
          <CardHeader>
            <CardTitle>VisualizaÃ§Ã£o HierÃ¡rquica</CardTitle>
          </CardHeader>
          <CardContent>
            {tree && tree.length > 0 ? (
              <div className="space-y-4">
                {tree.map((rootNode: GoalNode) => (
                  <GoalTreeNode key={rootNode.id} node={rootNode} level={0} />
                ))}
              </div>
            ) : (
              <div className="text-center py-12 text-gray-500">
                <Target className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                <p className="text-lg font-medium">Nenhuma meta encontrada</p>
                <p className="text-sm mt-2">Crie uma meta organizacional para comeÃ§ar a cascata</p>
                <Button className="mt-4">
                  <Plus className="h-4 w-4 mr-2" />
                  Criar Meta Organizacional
                </Button>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Legenda */}
        <Card className="bg-gray-50">
          <CardHeader>
            <CardTitle className="text-sm">Legenda</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div>
                <h4 className="font-semibold mb-2">Tipos de Meta</h4>
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    <Building2 className="h-4 w-4 text-purple-600" />
                    <span>Organizacional (raiz)</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <Users className="h-4 w-4 text-blue-600" />
                    <span>Departamental (equipe)</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <User className="h-4 w-4 text-green-600" />
                    <span>Individual (colaborador)</span>
                  </div>
                </div>
              </div>

              <div>
                <h4 className="font-semibold mb-2">Status</h4>
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-green-500" />
                    <span>ConcluÃ­da</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-blue-500" />
                    <span>Em andamento</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-yellow-500" />
                    <span>Aprovada</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-gray-400" />
                    <span>Rascunho</span>
                  </div>
                </div>
              </div>

              <div>
                <h4 className="font-semibold mb-2">Alinhamento</h4>
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    <span className="text-green-600 font-semibold">â‰¥80%</span>
                    <span>Excelente alinhamento</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-yellow-600 font-semibold">50-79%</span>
                    <span>Alinhamento moderado</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-red-600 font-semibold">&lt;50%</span>
                    <span>Baixo alinhamento</span>
                  </div>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/MetasSMART.tsx
========================================
import { useState } from "react";
import { Link } from "wouter";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Target,
  TrendingUp,
  DollarSign,
  CheckCircle2,
  Clock,
  AlertCircle,
  Plus,
  Filter,
  Calendar,
  Download,
} from "lucide-react";
import { toast } from "sonner";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

/**
 * Dashboard de Metas SMART
 * Exibe KPIs, grÃ¡ficos e lista de metas do colaborador
 */
export default function MetasSMART() {
  const [cycleFilter, setCycleFilter] = useState<number | undefined>(undefined);
  const [statusFilter, setStatusFilter] = useState<string | undefined>(undefined);
  const [categoryFilter, setCategoryFilter] = useState<string | undefined>(undefined);

  // Exportar PDF consolidado
  const exportConsolidatedPDFMutation = trpc.smartGoals.exportConsolidatedPDF.useMutation({
    onSuccess: (data) => {
      const byteCharacters = atob(data.data);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: "application/pdf" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = data.filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      toast.success("RelatÃ³rio PDF exportado com sucesso!");
    },
    onError: (error: any) => {
      toast.error("Erro ao exportar PDF", {
        description: error.message,
      });
    },
  });

  // Buscar dashboard com KPIs
  const { data: dashboard, isLoading: loadingDashboard } = trpc.smartGoals.getDashboard.useQuery({
    cycleId: cycleFilter,
  });

  // Buscar lista de metas
  const { data: goals = [], isLoading: loadingGoals } = trpc.smartGoals.list.useQuery({
    cycleId: cycleFilter,
    status: statusFilter as any,
    category: categoryFilter as any,
  });

  // Buscar ciclos disponÃ­veis
  const { data: cycles = [] } = trpc.cyclesLegacy.list.useQuery();

  const getStatusColor = (status: string) => {
    const colors: Record<string, string> = {
      draft: "bg-gray-500",
      pending_approval: "bg-yellow-500",
      approved: "bg-green-500",
      rejected: "bg-red-500",
      in_progress: "bg-blue-500",
      completed: "bg-emerald-500",
      cancelled: "bg-gray-400",
    };
    return colors[status] || "bg-gray-500";
  };

  const getStatusLabel = (status: string) => {
    const labels: Record<string, string> = {
      draft: "Rascunho",
      pending_approval: "Aguardando AprovaÃ§Ã£o",
      approved: "Aprovada",
      rejected: "Rejeitada",
      in_progress: "Em Andamento",
      completed: "ConcluÃ­da",
      cancelled: "Cancelada",
    };
    return labels[status] || status;
  };

  const getCategoryLabel = (category: string) => {
    const labels: Record<string, string> = {
      financial: "Financeira",
      behavioral: "Comportamental",
      corporate: "Corporativa",
      development: "Desenvolvimento",
    };
    return labels[category] || category;
  };

  const getCategoryColor = (category: string) => {
    const colors: Record<string, string> = {
      financial: "text-green-600",
      behavioral: "text-blue-600",
      corporate: "text-purple-600",
      development: "text-orange-600",
    };
    return colors[category] || "text-gray-600";
  };

  if (loadingDashboard || loadingGoals) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="h-32 bg-gray-200 rounded"></div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Metas SMART</h1>
          <p className="text-gray-600 mt-1">
            Gerencie suas metas com critÃ©rios SMART e acompanhe seu progresso
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={() =>
              exportConsolidatedPDFMutation.mutate({
                cycleId: cycleFilter,
                status: statusFilter as any,
                category: categoryFilter as any,
              })
            }
            disabled={exportConsolidatedPDFMutation.isPending || goals.length === 0}
          >
            <Download className="w-4 h-4 mr-2" />
            {exportConsolidatedPDFMutation.isPending ? "Exportando..." : "Exportar PDF"}
          </Button>
          <Link href="/metas/criar">
            <Button className="bg-[#F39200] hover:bg-[#d67e00]">
              <Plus className="w-4 h-4 mr-2" />
              Nova Meta
            </Button>
          </Link>
        </div>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Metas Ativas</CardTitle>
            <Target className="h-4 w-4 text-blue-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{dashboard?.activeGoals || 0}</div>
            <p className="text-xs text-gray-500 mt-1">
              {dashboard?.totalGoals || 0} metas no total
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Taxa de ConclusÃ£o</CardTitle>
            <TrendingUp className="h-4 w-4 text-green-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{dashboard?.completionRate || 0}%</div>
            <p className="text-xs text-gray-500 mt-1">
              {dashboard?.completedGoals || 0} metas concluÃ­das
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">BÃ´nus Potencial</CardTitle>
            <DollarSign className="h-4 w-4 text-emerald-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              R$ {dashboard?.potentialBonus?.toFixed(2) || "0.00"}
            </div>
            <p className="text-xs text-gray-500 mt-1">Baseado em metas elegÃ­veis</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">MÃ©dia de Progresso</CardTitle>
            <CheckCircle2 className="h-4 w-4 text-purple-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {goals.length > 0
                ? Math.round(
                    goals.reduce((sum, g) => sum + (g.progress || 0), 0) / goals.length
                  )
                : 0}
              %
            </div>
            <p className="text-xs text-gray-500 mt-1">Todas as metas</p>
          </CardContent>
        </Card>
      </div>

      {/* DistribuiÃ§Ã£o por Categoria */}
      {dashboard && (
        <Card>
          <CardHeader>
            <CardTitle>DistribuiÃ§Ã£o por Categoria</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-green-600">
                  {dashboard?.byCategory?.financial || 0}
                </div>
                <p className="text-sm text-gray-600">Financeiras</p>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-blue-600">
                  {dashboard?.byCategory?.behavioral || 0}
                </div>
                <p className="text-sm text-gray-600">Comportamentais</p>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-purple-600">
                  {dashboard?.byCategory?.corporate || 0}
                </div>
                <p className="text-sm text-gray-600">Corporativas</p>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-orange-600">
                  {dashboard?.byCategory?.development || 0}
                </div>
                <p className="text-sm text-gray-600">Desenvolvimento</p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Filtros */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Filter className="w-5 h-5" />
            Filtros
          </CardTitle>
        </CardHeader>
        <CardContent className="flex flex-wrap gap-4">
          <div className="w-full md:w-auto">
            <label className="text-sm font-medium mb-2 block">Ciclo</label>
            <Select
              value={cycleFilter?.toString() || "all"}
              onValueChange={(v) => setCycleFilter(v === "all" ? undefined : Number(v))}
            >
              <SelectTrigger className="w-[200px]">
                <SelectValue placeholder="Todos os ciclos" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todos os ciclos</SelectItem>
                {cycles.map((cycle: any) => (
                  <SelectItem key={cycle.id} value={cycle.id.toString()}>
                    {cycle.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="w-full md:w-auto">
            <label className="text-sm font-medium mb-2 block">Status</label>
            <Select
              value={statusFilter || "all"}
              onValueChange={(v) => setStatusFilter(v === "all" ? undefined : v)}
            >
              <SelectTrigger className="w-[200px]">
                <SelectValue placeholder="Todos os status" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todos os status</SelectItem>
                <SelectItem value="draft">Rascunho</SelectItem>
                <SelectItem value="pending_approval">Aguardando AprovaÃ§Ã£o</SelectItem>
                <SelectItem value="approved">Aprovada</SelectItem>
                <SelectItem value="in_progress">Em Andamento</SelectItem>
                <SelectItem value="completed">ConcluÃ­da</SelectItem>
                <SelectItem value="rejected">Rejeitada</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div className="w-full md:w-auto">
            <label className="text-sm font-medium mb-2 block">Categoria</label>
            <Select
              value={categoryFilter || "all"}
              onValueChange={(v) => setCategoryFilter(v === "all" ? undefined : v)}
            >
              <SelectTrigger className="w-[200px]">
                <SelectValue placeholder="Todas as categorias" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todas as categorias</SelectItem>
                <SelectItem value="financial">Financeira</SelectItem>
                <SelectItem value="behavioral">Comportamental</SelectItem>
                <SelectItem value="corporate">Corporativa</SelectItem>
                <SelectItem value="development">Desenvolvimento</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardContent>
      </Card>

      {/* Lista de Metas */}
      <div className="space-y-4">
        <h2 className="text-xl font-bold">Minhas Metas ({goals.length})</h2>

        {goals.length === 0 ? (
          <Card>
            <CardContent className="text-center py-12">
              <Target className="w-16 h-16 text-gray-300 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-gray-900 mb-2">
                Nenhuma meta encontrada
              </h3>
              <p className="text-gray-600 mb-4">
                Comece criando sua primeira meta SMART
              </p>
              <Link href="/metas/criar">
                <Button className="bg-[#F39200] hover:bg-[#d67e00]">
                  <Plus className="w-4 h-4 mr-2" />
                  Criar Meta
                </Button>
              </Link>
            </CardContent>
          </Card>
        ) : (
          goals.map((goal: any) => (
            <Card key={goal.id} className="hover:shadow-lg transition-shadow">
              <CardHeader>
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <CardTitle className="text-lg">{goal.title}</CardTitle>
                      <Badge className={getStatusColor(goal.status)}>
                        {getStatusLabel(goal.status)}
                      </Badge>
                      {goal.bonusEligible && (
                        <Badge variant="outline" className="bg-green-50 text-green-700">
                          <DollarSign className="w-3 h-3 mr-1" />
                          BÃ´nus
                        </Badge>
                      )}
                    </div>
                    <CardDescription className="line-clamp-2">
                      {goal.description}
                    </CardDescription>
                  </div>
                  <span className={`text-sm font-medium ${getCategoryColor(goal.category)}`}>
                    {getCategoryLabel(goal.category)}
                  </span>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                {/* Progresso */}
                <div>
                  <div className="flex justify-between text-sm mb-2">
                    <span className="text-gray-600">Progresso</span>
                    <span className="font-semibold">{goal.progress || 0}%</span>
                  </div>
                  <Progress value={goal.progress || 0} className="h-2" />
                </div>

                {/* MÃ©tricas */}
                {goal.measurementUnit && goal.targetValue && (
                  <div className="flex items-center gap-4 text-sm">
                    <div className="flex items-center gap-2">
                      <Target className="w-4 h-4 text-gray-400" />
                      <span className="text-gray-600">Meta:</span>
                      <span className="font-semibold">
                        {goal.targetValue} {goal.measurementUnit}
                      </span>
                    </div>
                    {goal.currentValue && (
                      <div className="flex items-center gap-2">
                        <TrendingUp className="w-4 h-4 text-gray-400" />
                        <span className="text-gray-600">Atual:</span>
                        <span className="font-semibold">
                          {goal.currentValue} {goal.measurementUnit}
                        </span>
                      </div>
                    )}
                  </div>
                )}

                {/* Datas */}
                <div className="flex items-center gap-4 text-sm text-gray-600">
                  <div className="flex items-center gap-2">
                    <Calendar className="w-4 h-4" />
                    <span>
                      {format(new Date(goal.startDate), "dd/MM/yyyy", { locale: ptBR })} -{" "}
                      {format(new Date(goal.endDate), "dd/MM/yyyy", { locale: ptBR })}
                    </span>
                  </div>
                  {new Date(goal.endDate) < new Date() && goal.status !== "completed" && (
                    <Badge variant="destructive" className="flex items-center gap-1">
                      <AlertCircle className="w-3 h-3" />
                      Vencida
                    </Badge>
                  )}
                </div>

                {/* CritÃ©rios SMART */}
                <div className="flex gap-2 flex-wrap">
                  {goal.isSpecific && (
                    <Badge variant="outline" className="bg-blue-50">
                      âœ“ EspecÃ­fica
                    </Badge>
                  )}
                  {goal.isMeasurable && (
                    <Badge variant="outline" className="bg-green-50">
                      âœ“ MensurÃ¡vel
                    </Badge>
                  )}
                  {goal.isAchievable && (
                    <Badge variant="outline" className="bg-purple-50">
                      âœ“ AtingÃ­vel
                    </Badge>
                  )}
                  {goal.isRelevant && (
                    <Badge variant="outline" className="bg-orange-50">
                      âœ“ Relevante
                    </Badge>
                  )}
                  {goal.isTimeBound && (
                    <Badge variant="outline" className="bg-pink-50">
                      âœ“ Temporal
                    </Badge>
                  )}
                </div>

                {/* AÃ§Ãµes */}
                <div className="flex gap-2 pt-2">
                  <Link href={`/metas/${goal.id}`}>
                    <Button variant="outline" size="sm">
                      Ver Detalhes
                    </Button>
                  </Link>
                  {goal.status === "draft" && (
                    <Link href={`/metas/${goal.id}/editar`}>
                      <Button variant="outline" size="sm">
                        Editar
                      </Button>
                    </Link>
                  )}
                  {["approved", "in_progress"].includes(goal.status) && (
                    <Link href={`/metas/${goal.id}/progresso`}>
                      <Button size="sm" className="bg-[#F39200] hover:bg-[#d67e00]">
                        Atualizar Progresso
                      </Button>
                    </Link>
                  )}
                </div>
              </CardContent>
            </Card>
          ))
        )}
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/MinhasAtividades.tsx
========================================
import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { trpc } from "@/lib/trpc";
import DashboardLayout from "@/components/DashboardLayout";
import { Plus, Clock, Calendar, BarChart3 } from "lucide-react";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { toast } from "sonner";
import { Badge } from "@/components/ui/badge";

export default function MinhasAtividades() {
  const [dialogOpen, setDialogOpen] = useState(false);
  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [category, setCategory] = useState<"reuniao" | "analise" | "planejamento" | "execucao" | "suporte" | "outros">("execucao");
  const [activityDate, setActivityDate] = useState(new Date().toISOString().split("T")[0]);
  const [startTime, setStartTime] = useState("09:00");
  const [endTime, setEndTime] = useState("10:00");

  // Mock employeeId - em produÃ§Ã£o viria do contexto de autenticaÃ§Ã£o
  const employeeId = 1;

  const { data: activities, refetch } = trpc.jobDescriptions.getActivities.useQuery({ employeeId });

  const addActivityMutation = trpc.jobDescriptions.addActivity.useMutation({
    onSuccess: () => {
      toast.success("Atividade registrada com sucesso!");
      setDialogOpen(false);
      resetForm();
      refetch();
    },
    onError: (error) => {
      toast.error("Erro ao registrar atividade: " + error.message);
    },
  });

  const resetForm = () => {
    setTitle("");
    setDescription("");
    setCategory("execucao");
    setActivityDate(new Date().toISOString().split("T")[0]);
    setStartTime("09:00");
    setEndTime("10:00");
  };

  const handleSubmit = () => {
    if (!title.trim()) {
      toast.error("TÃ­tulo Ã© obrigatÃ³rio");
      return;
    }

    addActivityMutation.mutate({
      employeeId,
      title,
      description,
      category,
      activityDate,
      startTime,
      endTime,
    });
  };

  const getCategoryBadge = (cat: string) => {
    const categoryMap: Record<string, { label: string; color: string }> = {
      reuniao: { label: "ReuniÃ£o", color: "bg-blue-500" },
      analise: { label: "AnÃ¡lise", color: "bg-purple-500" },
      planejamento: { label: "Planejamento", color: "bg-green-500" },
      execucao: { label: "ExecuÃ§Ã£o", color: "bg-orange-500" },
      suporte: { label: "Suporte", color: "bg-yellow-500" },
      outros: { label: "Outros", color: "bg-gray-500" },
    };
    const { label, color } = categoryMap[cat] || { label: cat, color: "bg-gray-500" };
    return <Badge className={color}>{label}</Badge>;
  };

  const calculateTotalHours = () => {
    if (!activities) return 0;
    const total = activities.reduce((sum, act) => sum + (act.durationMinutes || 0), 0);
    return (total / 60).toFixed(1);
  };

  const getCategoryDistribution = () => {
    if (!activities) return [];
    const distribution: Record<string, number> = {};
    activities.forEach((act) => {
      distribution[act.category] = (distribution[act.category] || 0) + (act.durationMinutes || 0);
    });
    return Object.entries(distribution).map(([category, minutes]) => ({
      category,
      hours: (minutes / 60).toFixed(1),
    }));
  };

  return (
    <DashboardLayout>
      <div className="container mx-auto py-8">
        <div className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold mb-2">Minhas Atividades</h1>
            <p className="text-muted-foreground">Registre suas tarefas e atividades diÃ¡rias</p>
          </div>
          <Button onClick={() => setDialogOpen(true)}>
            <Plus className="w-4 h-4 mr-2" />
            Nova Atividade
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-3 gap-4 mb-8">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <Clock className="w-4 h-4" />
                Total de Horas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{calculateTotalHours()}h</div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <Calendar className="w-4 h-4" />
                Atividades Registradas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{activities?.length || 0}</div>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <BarChart3 className="w-4 h-4" />
                Categoria Principal
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-xl font-bold">
                {getCategoryDistribution()[0]?.category || "-"}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* DistribuiÃ§Ã£o por Categoria */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>DistribuiÃ§Ã£o de Tempo por Categoria</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-3 gap-4">
              {getCategoryDistribution().map((item) => (
                <div key={item.category} className="flex justify-between items-center border p-3 rounded">
                  {getCategoryBadge(item.category)}
                  <span className="font-bold">{item.hours}h</span>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* Tabela de Atividades */}
        <Card>
          <CardHeader>
            <CardTitle>HistÃ³rico de Atividades</CardTitle>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Data</TableHead>
                  <TableHead>TÃ­tulo</TableHead>
                  <TableHead>Categoria</TableHead>
                  <TableHead>HorÃ¡rio</TableHead>
                  <TableHead>DuraÃ§Ã£o</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {activities?.map((activity) => (
                  <TableRow key={activity.id}>
                    <TableCell>{new Date(activity.activityDate).toLocaleDateString("pt-BR")}</TableCell>
                    <TableCell className="font-medium">{activity.title}</TableCell>
                    <TableCell>{getCategoryBadge(activity.category)}</TableCell>
                    <TableCell>
                      {activity.startTime} - {activity.endTime}
                    </TableCell>
                    <TableCell>{((activity.durationMinutes || 0) / 60).toFixed(1)}h</TableCell>
                  </TableRow>
                ))}
                {(!activities || activities.length === 0) && (
                  <TableRow>
                    <TableCell colSpan={5} className="text-center py-8 text-muted-foreground">
                      Nenhuma atividade registrada
                    </TableCell>
                  </TableRow>
                )}
              </TableBody>
            </Table>
          </CardContent>
        </Card>

        {/* Dialog de Nova Atividade */}
        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>Registrar Nova Atividade</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <Label>TÃ­tulo da Atividade *</Label>
                <Input
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="Ex: ReuniÃ£o de planejamento mensal"
                />
              </div>
              <div>
                <Label>DescriÃ§Ã£o</Label>
                <Textarea
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  placeholder="Descreva a atividade realizada..."
                  rows={3}
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>Categoria *</Label>
                  <Select value={category} onValueChange={(value: any) => setCategory(value)}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="reuniao">ReuniÃ£o</SelectItem>
                      <SelectItem value="analise">AnÃ¡lise</SelectItem>
                      <SelectItem value="planejamento">Planejamento</SelectItem>
                      <SelectItem value="execucao">ExecuÃ§Ã£o</SelectItem>
                      <SelectItem value="suporte">Suporte</SelectItem>
                      <SelectItem value="outros">Outros</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <Label>Data *</Label>
                  <Input
                    type="date"
                    value={activityDate}
                    onChange={(e) => setActivityDate(e.target.value)}
                  />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>Hora InÃ­cio *</Label>
                  <Input
                    type="time"
                    value={startTime}
                    onChange={(e) => setStartTime(e.target.value)}
                  />
                </div>
                <div>
                  <Label>Hora Fim *</Label>
                  <Input
                    type="time"
                    value={endTime}
                    onChange={(e) => setEndTime(e.target.value)}
                  />
                </div>
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setDialogOpen(false)}>
                Cancelar
              </Button>
              <Button onClick={handleSubmit} disabled={addActivityMutation.isPending}>
                <Plus className="w-4 h-4 mr-2" />
                Registrar Atividade
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/MovimentacaoNineBox.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { MoveRight, Users, AlertCircle } from "lucide-react";
import { toast } from "sonner";

type Performance = "baixo" | "mÃ©dio" | "alto";
type Potential = "baixo" | "mÃ©dio" | "alto";

interface EmployeePosition {
  employeeId: number;
  employeeName: string;
  currentPerformance?: Performance;
  currentPotential?: Potential;
}

/**
 * PÃ¡gina de MovimentaÃ§Ã£o de Colaboradores no Nine Box
 * Permite ao RH movimentar colaboradores com justificativa obrigatÃ³ria
 */
export default function MovimentacaoNineBox() {
  const [selectedEmployee, setSelectedEmployee] = useState<EmployeePosition | null>(null);
  const [toPerformance, setToPerformance] = useState<Performance>("mÃ©dio");
  const [toPotential, setToPotential] = useState<Potential>("mÃ©dio");
  const [justification, setJustification] = useState("");
  const [isDialogOpen, setIsDialogOpen] = useState(false);

  const utils = trpc.useUtils();

  // Queries
  const { data: employees } = trpc.employees.list.useQuery();
  // TODO: Implementar endpoint getMatrix no nineBoxRouter
  const { data: nineBoxData } = trpc.nineBox.getByCycle.useQuery({ cycleId: 1 });

  // Mutations
  const createMovement = trpc.calibrationDiretoria.createMovement.useMutation({
    onSuccess: () => {
      toast.success("MovimentaÃ§Ã£o criada e enviada para aprovaÃ§Ã£o!");
      setIsDialogOpen(false);
      setSelectedEmployee(null);
      setJustification("");
      utils.calibrationDiretoria.listPendingMovements.invalidate();
    },
    onError: (error) => {
      toast.error(`Erro: ${error.message}`);
    },
  });

  const handleOpenDialog = (employee: EmployeePosition) => {
    setSelectedEmployee(employee);
    setToPerformance(employee.currentPerformance || "mÃ©dio");
    setToPotential(employee.currentPotential || "mÃ©dio");
    setJustification("");
    setIsDialogOpen(true);
  };

  const handleSubmitMovement = () => {
    if (!selectedEmployee) return;

    if (justification.length < 10) {
      toast.error("Justificativa deve ter no mÃ­nimo 10 caracteres");
      return;
    }

    createMovement.mutate({
      employeeId: selectedEmployee.employeeId,
      fromPerformance: selectedEmployee.currentPerformance,
      fromPotential: selectedEmployee.currentPotential,
      toPerformance,
      toPotential,
      justification,
    });
  };

  // Organizar colaboradores por quadrante
  const employeesByQuadrant: Record<string, EmployeePosition[]> = {};

  employees?.forEach((emp) => {
    const position = nineBoxData?.find((item: any) => item.nineBox.employeeId === emp.employee.id)?.nineBox;
    
    const performance: Performance = position
      ? position.performance === 3
        ? "alto"
        : position.performance === 2
          ? "mÃ©dio"
          : "baixo"
      : "mÃ©dio";

    const potential: Potential = position
      ? position.potential === 3
        ? "alto"
        : position.potential === 2
          ? "mÃ©dio"
          : "baixo"
      : "mÃ©dio";

    const key = `${performance}_${potential}`;

    if (!employeesByQuadrant[key]) {
      employeesByQuadrant[key] = [];
    }

    employeesByQuadrant[key].push({
      employeeId: emp.employee.id,
      employeeName: emp.employee.name,
      currentPerformance: performance,
      currentPotential: potential,
    });
  });

  const getQuadrantColor = (performance: Performance, potential: Potential) => {
    if (performance === "alto" && potential === "alto") return "bg-green-100 border-green-500";
    if (performance === "alto" || potential === "alto") return "bg-blue-100 border-blue-500";
    if (performance === "baixo" && potential === "baixo") return "bg-red-100 border-red-500";
    return "bg-yellow-100 border-yellow-500";
  };

  return (
    <div className="container mx-auto py-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-3">
            <MoveRight className="w-8 h-8 text-[#F39200]" />
            MovimentaÃ§Ã£o de Colaboradores - Nine Box
          </h1>
          <p className="text-gray-600 mt-2">
            Clique em um colaborador para movimentÃ¡-lo no Nine Box
          </p>
        </div>
      </div>

      {/* Alerta */}
      <Card className="border-[#F39200]">
        <CardContent className="pt-6">
          <div className="flex items-start gap-3">
            <AlertCircle className="w-5 h-5 text-[#F39200] mt-0.5" />
            <div>
              <p className="font-semibold">Workflow de AprovaÃ§Ã£o</p>
              <p className="text-sm text-gray-600 mt-1">
                Todas as movimentaÃ§Ãµes passarÃ£o por aprovaÃ§Ã£o do <strong>Diretor de Gente</strong> e{" "}
                <strong>Diretor de Ãrea</strong>. O Diretor de Ãrea deverÃ¡ obrigatoriamente inserir
                evidÃªncias ao aprovar.
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Matriz Nine Box */}
      <Card>
        <CardHeader>
          <CardTitle>Matriz Nine Box - Clique para Movimentar</CardTitle>
          <CardDescription>
            Visualize a distribuiÃ§Ã£o atual e clique em um colaborador para movimentÃ¡-lo
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-3 gap-4">
            {(["alto", "mÃ©dio", "baixo"] as Potential[]).map((potential) =>
              (["baixo", "mÃ©dio", "alto"] as Performance[]).map((performance) => {
                const key = `${performance}_${potential}`;
                const employeesInQuadrant = employeesByQuadrant[key] || [];

                return (
                  <div
                    key={key}
                    className={`p-4 border-2 rounded-lg ${getQuadrantColor(performance, potential)} min-h-[200px]`}
                  >
                    <div className="text-xs font-semibold text-gray-700 mb-3 text-center">
                      {performance.toUpperCase()} Desempenho
                      <br />
                      {potential.toUpperCase()} Potencial
                    </div>

                    <div className="space-y-2">
                      {employeesInQuadrant.map((emp) => (
                        <button
                          key={emp.employeeId}
                          onClick={() => handleOpenDialog(emp)}
                          className="w-full p-2 bg-white rounded border hover:shadow-md transition-shadow text-left"
                        >
                          <div className="flex items-center gap-2">
                            <Users className="w-4 h-4 text-gray-500" />
                            <span className="text-sm font-medium truncate">{emp.employeeName}</span>
                          </div>
                        </button>
                      ))}
                    </div>

                    <div className="mt-3 text-center">
                      <Badge variant="secondary">{employeesInQuadrant.length} colaboradores</Badge>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </CardContent>
      </Card>

      {/* Dialog de MovimentaÃ§Ã£o */}
      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Movimentar Colaborador</DialogTitle>
            <DialogDescription>
              Defina a nova posiÃ§Ã£o no Nine Box e justifique a movimentaÃ§Ã£o
            </DialogDescription>
          </DialogHeader>

          {selectedEmployee && (
            <div className="space-y-6 py-4">
              {/* Colaborador */}
              <div>
                <label className="text-sm font-medium">Colaborador</label>
                <div className="mt-2 p-3 bg-gray-50 rounded-lg">
                  <p className="font-semibold">{selectedEmployee.employeeName}</p>
                  <p className="text-sm text-gray-600 mt-1">
                    PosiÃ§Ã£o atual: {selectedEmployee.currentPerformance?.toUpperCase() || "NÃ£o definido"}{" "}
                    Desempenho â€¢ {selectedEmployee.currentPotential?.toUpperCase() || "NÃ£o definido"}{" "}
                    Potencial
                  </p>
                </div>
              </div>

              {/* Nova PosiÃ§Ã£o */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-sm font-medium mb-2 block">
                    Novo Desempenho <span className="text-red-500">*</span>
                  </label>
                  <Select
                    value={toPerformance}
                    onValueChange={(value) => setToPerformance(value as Performance)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="baixo">Baixo</SelectItem>
                      <SelectItem value="mÃ©dio">MÃ©dio</SelectItem>
                      <SelectItem value="alto">Alto</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm font-medium mb-2 block">
                    Novo Potencial <span className="text-red-500">*</span>
                  </label>
                  <Select
                    value={toPotential}
                    onValueChange={(value) => setToPotential(value as Potential)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="baixo">Baixo</SelectItem>
                      <SelectItem value="mÃ©dio">MÃ©dio</SelectItem>
                      <SelectItem value="alto">Alto</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Justificativa */}
              <div>
                <label className="text-sm font-medium mb-2 block">
                  Justificativa da MovimentaÃ§Ã£o <span className="text-red-500">*</span>
                </label>
                <Textarea
                  placeholder="Descreva os motivos da movimentaÃ§Ã£o (mÃ­nimo 10 caracteres)..."
                  value={justification}
                  onChange={(e) => setJustification(e.target.value)}
                  rows={4}
                  className="resize-none"
                />
                <p className="text-xs text-gray-500 mt-1">{justification.length} caracteres</p>
              </div>

              {/* Alerta de Workflow */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p className="text-sm text-blue-900">
                  <strong>Workflow de AprovaÃ§Ã£o:</strong> Esta movimentaÃ§Ã£o serÃ¡ enviada para aprovaÃ§Ã£o
                  do Diretor de Gente e depois para o Diretor de Ãrea, que deverÃ¡ inserir evidÃªncias
                  obrigatoriamente.
                </p>
              </div>
            </div>
          )}

          <DialogFooter>
            <Button variant="outline" onClick={() => setIsDialogOpen(false)}>
              Cancelar
            </Button>
            <Button
              onClick={handleSubmitMovement}
              disabled={createMovement.isPending || justification.length < 10}
              className="bg-[#F39200] hover:bg-[#d67f00]"
            >
              {createMovement.isPending ? "Enviando..." : "Enviar para AprovaÃ§Ã£o"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/NineBox.tsx
========================================
import { useState } from "react";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Loader2, Users, TrendingUp, Star, AlertCircle, Target, Zap, Clock, Award, Grid3x3 } from "lucide-react";

/**
 * PÃ¡gina de Matriz 9-Box
 * VisualizaÃ§Ã£o grÃ¡fica com calibraÃ§Ã£o e ajustes manuais
 */

type Employee9Box = {
  id: number;
  name: string;
  position: string;
  department: string;
  performance: number;
  potential: number;
  category: string;
  lastCalibration?: string;
};

const QUADRANT_LABELS = {
  "3-3": { label: "Estrelas", icon: Star, color: "bg-green-500", desc: "Alto desempenho e alto potencial" },
  "3-2": { label: "Talentos", icon: TrendingUp, color: "bg-green-400", desc: "Alto desempenho, potencial mÃ©dio" },
  "3-1": { label: "Especialistas", icon: Target, color: "bg-yellow-400", desc: "Alto desempenho, baixo potencial" },
  "2-3": { label: "Promessas", icon: Zap, color: "bg-blue-400", desc: "Desempenho mÃ©dio, alto potencial" },
  "2-2": { label: "SÃ³lidos", icon: Users, color: "bg-gray-400", desc: "Desempenho e potencial mÃ©dios" },
  "2-1": { label: "Eficazes", icon: Clock, color: "bg-gray-300", desc: "Desempenho mÃ©dio, baixo potencial" },
  "1-3": { label: "Enigmas", icon: AlertCircle, color: "bg-orange-400", desc: "Baixo desempenho, alto potencial" },
  "1-2": { label: "Dilemmas", icon: AlertCircle, color: "bg-orange-300", desc: "Baixo desempenho, potencial mÃ©dio" },
  "1-1": { label: "CrÃ­ticos", icon: AlertCircle, color: "bg-red-500", desc: "Baixo desempenho e baixo potencial" },
};

export default function NineBox() {
  const { user } = useAuth();
  const [selectedCycle, setSelectedCycle] = useState<number | null>(null);
  const [selectedEmployee, setSelectedEmployee] = useState<Employee9Box | null>(null);
  const [adjustmentReason, setAdjustmentReason] = useState("");
  const [newPerformance, setNewPerformance] = useState(2);
  const [newPotential, setNewPotential] = useState(2);
  const [isAdjustDialogOpen, setIsAdjustDialogOpen] = useState(false);

  // Buscar ciclos de avaliaÃ§Ã£o (mock - TODO: criar endpoint)
  const cycles = [{ id: 1, name: 'Ciclo 2025', year: 2025 }];
  const loadingCycles = false;

  // Buscar posiÃ§Ãµes da matriz 9-box
  const { data: positions, isLoading: loadingPositions, refetch } = trpc.nineBox.list.useQuery(
    { cycleId: selectedCycle! },
    { enabled: !!selectedCycle }
  );

  // Mutation para ajustar posiÃ§Ã£o
  const adjustMutation = trpc.nineBox.adjust.useMutation({
    onSuccess: () => {
      toast.success("PosiÃ§Ã£o ajustada com sucesso!");
      refetch();
      setIsAdjustDialogOpen(false);
      setSelectedEmployee(null);
      setAdjustmentReason("");
    },
    onError: (error) => {
      toast.error(`Erro ao ajustar posiÃ§Ã£o: ${error.message}`);
    },
  });

  const handleEmployeeClick = (emp: Employee9Box) => {
    setSelectedEmployee(emp);
    setNewPerformance(emp.performance);
    setNewPotential(emp.potential);
    setIsAdjustDialogOpen(true);
  };

  const handleAdjust = () => {
    if (!selectedEmployee || !selectedCycle) return;

    adjustMutation.mutate({
      cycleId: selectedCycle,
      employeeId: selectedEmployee.id,
      performance: newPerformance,
      potential: newPotential,
      reason: adjustmentReason,
    });
  };

  // Agrupar colaboradores por quadrante
  const groupedEmployees: Record<string, Employee9Box[]> = {};
  positions?.forEach((pos) => {
    const key = `${pos.performance}-${pos.potential}`;
    if (!groupedEmployees[key]) groupedEmployees[key] = [];
    groupedEmployees[key].push({
      id: pos.employeeId,
      name: pos.employeeName || "Sem nome",
      position: pos.positionName || "Sem cargo",
      department: pos.departmentName || "Sem departamento",
      performance: pos.performance,
      potential: pos.potential,
      category: QUADRANT_LABELS[key as keyof typeof QUADRANT_LABELS]?.label || "Indefinido",
      lastCalibration: pos.calibratedAt?.toLocaleDateString("pt-BR"),
    });
  });

  if (loadingCycles) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <Grid3x3 className="h-8 w-8" />
              Matriz 9-Box
            </h1>
            <p className="text-muted-foreground mt-2">
              VisualizaÃ§Ã£o grÃ¡fica de desempenho Ã— potencial
            </p>
          </div>
        </div>

        {/* SeleÃ§Ã£o de Ciclo */}
        <Card>
          <CardHeader>
            <CardTitle>Selecionar Ciclo de AvaliaÃ§Ã£o</CardTitle>
            <CardDescription>Escolha o ciclo para visualizar a matriz</CardDescription>
          </CardHeader>
          <CardContent>
            <Select
              value={selectedCycle?.toString()}
              onValueChange={(value) => setSelectedCycle(parseInt(value))}
            >
              <SelectTrigger className="w-full max-w-md">
                <SelectValue placeholder="Selecione um ciclo" />
              </SelectTrigger>
              <SelectContent>
                {cycles?.map((cycle: any) => (
                  <SelectItem key={cycle.id} value={cycle.id.toString()}>
                    {cycle.name} ({cycle.year})
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </CardContent>
        </Card>

        {/* Matriz 9-Box */}
        {selectedCycle && (
          <Card>
            <CardHeader>
              <CardTitle>Matriz 9-Box - Desempenho Ã— Potencial</CardTitle>
              <CardDescription>
                Clique em um colaborador para ajustar sua posiÃ§Ã£o (apenas RH e Diretoria)
              </CardDescription>
            </CardHeader>
            <CardContent>
              {loadingPositions ? (
                <div className="flex items-center justify-center h-96">
                  <Loader2 className="w-8 h-8 animate-spin text-primary" />
                </div>
              ) : (
                <div className="space-y-4">
                  {/* Legenda */}
                  <div className="flex items-center gap-2 text-sm text-muted-foreground">
                    <span className="font-semibold">Eixo Y:</span> Potencial (1=Baixo, 2=MÃ©dio, 3=Alto)
                    <span className="mx-4">|</span>
                    <span className="font-semibold">Eixo X:</span> Desempenho (1=Baixo, 2=MÃ©dio, 3=Alto)
                  </div>

                  {/* Grid 3x3 */}
                  <div className="grid grid-cols-3 gap-2 border rounded-lg p-4 bg-muted/20">
                    {/* Linha 3 (Alto Potencial) */}
                    {[1, 2, 3].map((perf) => {
                      const key = `${perf}-3`;
                      const quadrant = QUADRANT_LABELS[key as keyof typeof QUADRANT_LABELS];
                      const employees = groupedEmployees[key] || [];
                      const Icon = quadrant?.icon || Users;

                      return (
                        <div
                          key={key}
                          className={`${quadrant?.color} bg-opacity-10 border-2 border-opacity-30 rounded-lg p-4 min-h-[180px] hover:bg-opacity-20 transition-all`}
                        >
                          <div className="flex items-center gap-2 mb-3">
                            <Icon className="w-5 h-5" />
                            <div>
                              <h3 className="font-bold text-sm">{quadrant?.label}</h3>
                              <p className="text-xs text-muted-foreground">{quadrant?.desc}</p>
                            </div>
                          </div>
                          <div className="space-y-2">
                            {employees.map((emp, idx) => (
                              <button
                                key={`${key}-emp-${emp.id}-${idx}`}
                                onClick={() => handleEmployeeClick(emp)}
                                className="w-full text-left p-2 bg-background rounded border hover:border-primary hover:shadow-sm transition-all text-xs"
                              >
                                <div className="font-semibold truncate">{emp.name}</div>
                                <div className="text-muted-foreground truncate">{emp.position}</div>
                              </button>
                            ))}
                          </div>
                        </div>
                      );
                    })}

                    {/* Linha 2 (MÃ©dio Potencial) */}
                    {[1, 2, 3].map((perf) => {
                      const key = `${perf}-2`;
                      const quadrant = QUADRANT_LABELS[key as keyof typeof QUADRANT_LABELS];
                      const employees = groupedEmployees[key] || [];
                      const Icon = quadrant?.icon || Users;

                      return (
                        <div
                          key={key}
                          className={`${quadrant?.color} bg-opacity-10 border-2 border-opacity-30 rounded-lg p-4 min-h-[180px] hover:bg-opacity-20 transition-all`}
                        >
                          <div className="flex items-center gap-2 mb-3">
                            <Icon className="w-5 h-5" />
                            <div>
                              <h3 className="font-bold text-sm">{quadrant?.label}</h3>
                              <p className="text-xs text-muted-foreground">{quadrant?.desc}</p>
                            </div>
                          </div>
                          <div className="space-y-2">
                            {employees.map((emp, idx) => (
                              <button
                                key={`${key}-emp-${emp.id}-${idx}`}
                                onClick={() => handleEmployeeClick(emp)}
                                className="w-full text-left p-2 bg-background rounded border hover:border-primary hover:shadow-sm transition-all text-xs"
                              >
                                <div className="font-semibold truncate">{emp.name}</div>
                                <div className="text-muted-foreground truncate">{emp.position}</div>
                              </button>
                            ))}
                          </div>
                        </div>
                      );
                    })}

                    {/* Linha 1 (Baixo Potencial) */}
                    {[1, 2, 3].map((perf) => {
                      const key = `${perf}-1`;
                      const quadrant = QUADRANT_LABELS[key as keyof typeof QUADRANT_LABELS];
                      const employees = groupedEmployees[key] || [];
                      const Icon = quadrant?.icon || Users;

                      return (
                        <div
                          key={key}
                          className={`${quadrant?.color} bg-opacity-10 border-2 border-opacity-30 rounded-lg p-4 min-h-[180px] hover:bg-opacity-20 transition-all`}
                        >
                          <div className="flex items-center gap-2 mb-3">
                            <Icon className="w-5 h-5" />
                            <div>
                              <h3 className="font-bold text-sm">{quadrant?.label}</h3>
                              <p className="text-xs text-muted-foreground">{quadrant?.desc}</p>
                            </div>
                          </div>
                          <div className="space-y-2">
                            {employees.map((emp, idx) => (
                              <button
                                key={`${key}-emp-${emp.id}-${idx}`}
                                onClick={() => handleEmployeeClick(emp)}
                                className="w-full text-left p-2 bg-background rounded border hover:border-primary hover:shadow-sm transition-all text-xs"
                              >
                                <div className="font-semibold truncate">{emp.name}</div>
                                <div className="text-muted-foreground truncate">{emp.position}</div>
                              </button>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  {/* EstatÃ­sticas */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <Card>
                      <CardContent className="pt-6">
                        <div className="flex items-center gap-2">
                          <Star className="w-5 h-5 text-green-500" />
                          <div>
                            <p className="text-2xl font-bold">{groupedEmployees["3-3"]?.length || 0}</p>
                            <p className="text-xs text-muted-foreground">Estrelas</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="pt-6">
                        <div className="flex items-center gap-2">
                          <Zap className="w-5 h-5 text-blue-500" />
                          <div>
                            <p className="text-2xl font-bold">{groupedEmployees["2-3"]?.length || 0}</p>
                            <p className="text-xs text-muted-foreground">Promessas</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="pt-6">
                        <div className="flex items-center gap-2">
                          <AlertCircle className="w-5 h-5 text-orange-500" />
                          <div>
                            <p className="text-2xl font-bold">{groupedEmployees["1-3"]?.length || 0}</p>
                            <p className="text-xs text-muted-foreground">Enigmas</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="pt-6">
                        <div className="flex items-center gap-2">
                          <Users className="w-5 h-5 text-gray-500" />
                          <div>
                            <p className="text-2xl font-bold">{positions?.length || 0}</p>
                            <p className="text-xs text-muted-foreground">Total</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {/* Dialog de Ajuste */}
        <Dialog open={isAdjustDialogOpen} onOpenChange={setIsAdjustDialogOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Ajustar PosiÃ§Ã£o na Matriz 9-Box</DialogTitle>
              <DialogDescription>
                Colaborador: {selectedEmployee?.name}
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4">
              <div>
                <Label>Desempenho</Label>
                <Select
                  value={newPerformance.toString()}
                  onValueChange={(value) => setNewPerformance(parseInt(value))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="1">1 - Baixo</SelectItem>
                    <SelectItem value="2">2 - MÃ©dio</SelectItem>
                    <SelectItem value="3">3 - Alto</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label>Potencial</Label>
                <Select
                  value={newPotential.toString()}
                  onValueChange={(value) => setNewPotential(parseInt(value))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="1">1 - Baixo</SelectItem>
                    <SelectItem value="2">2 - MÃ©dio</SelectItem>
                    <SelectItem value="3">3 - Alto</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label>Justificativa do Ajuste</Label>
                <Textarea
                  value={adjustmentReason}
                  onChange={(e) => setAdjustmentReason(e.target.value)}
                  placeholder="Explique o motivo do ajuste..."
                  rows={4}
                />
              </div>
            </div>

            <DialogFooter>
              <Button variant="outline" onClick={() => setIsAdjustDialogOpen(false)}>
                Cancelar
              </Button>
              <Button
                onClick={handleAdjust}
                disabled={!adjustmentReason.trim() || adjustMutation.isPending}
              >
                {adjustMutation.isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                Salvar Ajuste
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/NineBoxComparativo.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Loader2, TrendingUp, Users, Award, Download, Filter } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { Bar, Radar } from "react-chartjs-2";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend,
  RadialLinearScale,
  PointElement,
  LineElement,
  Filler,
} from "chart.js";

ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend,
  RadialLinearScale,
  PointElement,
  LineElement,
  Filler
);

/**
 * PÃ¡gina de Nine Box Comparativo por FunÃ§Ã£o/Cargo
 * Permite comparar distribuiÃ§Ã£o Nine Box entre diferentes cargos
 */

export default function NineBoxComparativo() {
  const [selectedPositions, setSelectedPositions] = useState<number[]>([]);
  const [hierarchyLevel, setHierarchyLevel] = useState<string>("all");
  const [selectedLeaderId, setSelectedLeaderId] = useState<number | null>(null);

  // Queries
  const { data: positions, isLoading: loadingPositions } = trpc.nineBoxComparative.getAvailablePositions.useQuery();
  const { data: leaders } = trpc.nineBoxComparative.getLeaders.useQuery();
  const { data: comparative, isLoading: loadingComparative } = trpc.nineBoxComparative.getComparative.useQuery(
    { 
      positionIds: selectedPositions.length > 0 ? selectedPositions : undefined,
      leaderId: selectedLeaderId || undefined,
      hierarchyLevel: hierarchyLevel as "all" | "diretoria" | "gerencia" | "coordenacao" | "supervisao" | "outros",
    },
    { enabled: true }
  );

  const togglePosition = (positionId: number) => {
    setSelectedPositions((prev) =>
      prev.includes(positionId)
        ? prev.filter((id) => id !== positionId)
        : [...prev, positionId]
    );
  };

  const selectAll = () => {
    if (positions) {
      setSelectedPositions(positions.map((p) => p.id));
    }
  };

  const clearAll = () => {
    setSelectedPositions([]);
  };

  // Preparar dados para grÃ¡fico de barras (Performance e Potencial mÃ©dios)
  const barChartData = {
    labels: comparative?.map((c) => c.positionTitle) || [],
    datasets: [
      {
        label: "Performance MÃ©dia",
        data: comparative?.map((c) => c.avgPerformance) || [],
        backgroundColor: "rgba(59, 130, 246, 0.8)",
        borderColor: "rgb(59, 130, 246)",
        borderWidth: 1,
      },
      {
        label: "Potencial MÃ©dio",
        data: comparative?.map((c) => c.avgPotential) || [],
        backgroundColor: "rgba(16, 185, 129, 0.8)",
        borderColor: "rgb(16, 185, 129)",
        borderWidth: 1,
      },
    ],
  };

  const barChartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: "top" as const,
      },
      title: {
        display: true,
        text: "Performance e Potencial MÃ©dios por Cargo",
      },
    },
    scales: {
      y: {
        beginAtZero: true,
        max: 3,
        ticks: {
          stepSize: 1,
        },
      },
    },
  };

  // Preparar dados para grÃ¡fico radar (% Alto Desempenho, % Alto Potencial, % Stars)
  const radarChartData = {
    labels: comparative?.map((c) => c.positionTitle) || [],
    datasets: [
      {
        label: "% Alto Desempenho",
        data: comparative?.map((c) => c.highPerformersPercent) || [],
        backgroundColor: "rgba(59, 130, 246, 0.2)",
        borderColor: "rgb(59, 130, 246)",
        borderWidth: 2,
      },
      {
        label: "% Alto Potencial",
        data: comparative?.map((c) => c.highPotentialPercent) || [],
        backgroundColor: "rgba(16, 185, 129, 0.2)",
        borderColor: "rgb(16, 185, 129)",
        borderWidth: 2,
      },
      {
        label: "% Stars (Alto/Alto)",
        data: comparative?.map((c) => c.starsPercent) || [],
        backgroundColor: "rgba(245, 158, 11, 0.2)",
        borderColor: "rgb(245, 158, 11)",
        borderWidth: 2,
      },
    ],
  };

  const radarChartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: "top" as const,
      },
      title: {
        display: true,
        text: "ComparaÃ§Ã£o de Talentos por Cargo (%)",
      },
    },
    scales: {
      r: {
        beginAtZero: true,
        max: 100,
        ticks: {
          stepSize: 20,
        },
      },
    },
  };

  if (loadingPositions) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">Nine Box Comparativo</h1>
            <p className="text-muted-foreground mt-1">
              Compare distribuiÃ§Ã£o de talentos entre diferentes funÃ§Ãµes e cargos
            </p>
          </div>
          
          <Button variant="outline">
            <Download className="h-4 w-4 mr-2" />
            Exportar RelatÃ³rio
          </Button>
        </div>

        {/* Filtros HierÃ¡rquicos */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Filter className="h-5 w-5" />
              Filtros HierÃ¡rquicos
            </CardTitle>
            <CardDescription>
              Filtre a anÃ¡lise por nÃ­vel hierÃ¡rquico ou lÃ­der especÃ­fico
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Filtro por NÃ­vel HierÃ¡rquico */}
              <div className="space-y-2">
                <Label>NÃ­vel HierÃ¡rquico</Label>
                <Select value={hierarchyLevel} onValueChange={setHierarchyLevel}>
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione o nÃ­vel" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos os nÃ­veis</SelectItem>
                    <SelectItem value="diretoria">Diretoria</SelectItem>
                    <SelectItem value="gerencia">GerÃªncia</SelectItem>
                    <SelectItem value="coordenacao">CoordenaÃ§Ã£o</SelectItem>
                    <SelectItem value="supervisao">SupervisÃ£o</SelectItem>
                    <SelectItem value="outros">Outros (sem subordinados)</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Filtro por LÃ­der */}
              <div className="space-y-2">
                <Label>Filtrar por LÃ­der</Label>
                <Select 
                  value={selectedLeaderId?.toString() || "todos"} 
                  onValueChange={(value) => setSelectedLeaderId(value === "todos" ? null : parseInt(value))}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione um lÃ­der" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="todos">Todos os colaboradores</SelectItem>
                    {leaders?.map((leader) => (
                      <SelectItem key={leader.id} value={leader.id.toString()}>
                        {leader.name} - {leader.positionTitle} ({leader.subordinatesCount} subordinados)
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Seletor de Cargos */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div>
                <CardTitle>Selecione os Cargos para Comparar</CardTitle>
                <CardDescription>
                  Escolha um ou mais cargos para visualizar a anÃ¡lise comparativa
                </CardDescription>
              </div>
              <div className="flex gap-2">
                <Button variant="outline" size="sm" onClick={selectAll}>
                  Selecionar Todos
                </Button>
                <Button variant="outline" size="sm" onClick={clearAll}>
                  Limpar
                </Button>
              </div>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              {positions?.map((position) => (
                <div
                  key={position.id}
                  className={`p-3 rounded-lg border cursor-pointer transition-colors ${
                    selectedPositions.includes(position.id)
                      ? "border-primary bg-primary/10"
                      : "border-border hover:border-primary/50"
                  }`}
                  onClick={() => togglePosition(position.id)}
                >
                  <p className="font-medium text-sm">{position.title}</p>
                  <p className="text-xs text-muted-foreground mt-1">
                    {position.employeeCount} colaboradores
                  </p>
                </div>
              ))}
            </div>

            {(!positions || positions.length === 0) && (
              <div className="text-center py-8 text-muted-foreground">
                <Users className="h-12 w-12 mx-auto mb-2 opacity-50" />
                <p className="text-sm">Nenhum cargo com colaboradores encontrado</p>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Resultados da ComparaÃ§Ã£o */}
        {loadingComparative ? (
          <div className="flex items-center justify-center h-64">
            <Loader2 className="h-8 w-8 animate-spin text-primary" />
          </div>
        ) : comparative && comparative.length > 0 ? (
          <>
            {/* KPIs Resumidos */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm font-medium text-muted-foreground">
                    Total de Colaboradores
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">
                    {comparative.reduce((sum, c) => sum + c.totalEmployees, 0)}
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm font-medium text-muted-foreground">
                    MÃ©dia de Performance
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">
                    {(
                      comparative.reduce((sum, c) => sum + c.avgPerformance * c.totalEmployees, 0) /
                      comparative.reduce((sum, c) => sum + c.totalEmployees, 0)
                    ).toFixed(2)}
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm font-medium text-muted-foreground">
                    MÃ©dia de Potencial
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">
                    {(
                      comparative.reduce((sum, c) => sum + c.avgPotential * c.totalEmployees, 0) /
                      comparative.reduce((sum, c) => sum + c.totalEmployees, 0)
                    ).toFixed(2)}
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm font-medium text-muted-foreground">
                    Total de Stars
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold text-amber-600">
                    {comparative.reduce((sum, c) => sum + c.starsCount, 0)}
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* GrÃ¡ficos */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card>
                <CardHeader>
                  <CardTitle>Performance e Potencial por Cargo</CardTitle>
                  <CardDescription>Valores mÃ©dios em escala de 1 a 3</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="h-[400px]">
                    <Bar data={barChartData} options={barChartOptions} />
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>DistribuiÃ§Ã£o de Talentos</CardTitle>
                  <CardDescription>Percentual de colaboradores em cada categoria</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="h-[400px]">
                    <Radar data={radarChartData} options={radarChartOptions} />
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Tabela Detalhada */}
            <Card>
              <CardHeader>
                <CardTitle>AnÃ¡lise Detalhada por Cargo</CardTitle>
                <CardDescription>MÃ©tricas completas de cada funÃ§Ã£o</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b">
                        <th className="text-left py-3 px-4 font-medium">Cargo</th>
                        <th className="text-center py-3 px-4 font-medium">Total</th>
                        <th className="text-center py-3 px-4 font-medium">Perf MÃ©dia</th>
                        <th className="text-center py-3 px-4 font-medium">Pot MÃ©dio</th>
                        <th className="text-center py-3 px-4 font-medium">Alto Desemp.</th>
                        <th className="text-center py-3 px-4 font-medium">Alto Potencial</th>
                        <th className="text-center py-3 px-4 font-medium">Stars</th>
                      </tr>
                    </thead>
                    <tbody>
                      {comparative.map((item) => (
                        <tr key={item.positionTitle} className="border-b hover:bg-muted/50">
                          <td className="py-3 px-4 font-medium">{item.positionTitle}</td>
                          <td className="text-center py-3 px-4">{item.totalEmployees}</td>
                          <td className="text-center py-3 px-4">
                            <Badge variant="outline">{item.avgPerformance}</Badge>
                          </td>
                          <td className="text-center py-3 px-4">
                            <Badge variant="outline">{item.avgPotential}</Badge>
                          </td>
                          <td className="text-center py-3 px-4">
                            <div className="flex flex-col items-center gap-1">
                              <span className="font-semibold">{item.highPerformersCount}</span>
                              <Badge variant="secondary" className="text-xs">
                                {item.highPerformersPercent}%
                              </Badge>
                            </div>
                          </td>
                          <td className="text-center py-3 px-4">
                            <div className="flex flex-col items-center gap-1">
                              <span className="font-semibold">{item.highPotentialCount}</span>
                              <Badge variant="secondary" className="text-xs">
                                {item.highPotentialPercent}%
                              </Badge>
                            </div>
                          </td>
                          <td className="text-center py-3 px-4">
                            <div className="flex flex-col items-center gap-1">
                              <Award className="h-4 w-4 text-amber-600" />
                              <span className="font-semibold text-amber-600">{item.starsCount}</span>
                              <Badge variant="outline" className="text-xs border-amber-600 text-amber-600">
                                {item.starsPercent}%
                              </Badge>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </CardContent>
            </Card>
          </>
        ) : (
          <Card>
            <CardContent className="py-24">
              <div className="text-center text-muted-foreground">
                <TrendingUp className="h-16 w-16 mx-auto mb-4 opacity-50" />
                <p>Selecione cargos acima para visualizar a anÃ¡lise comparativa</p>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/NotFound.tsx
========================================
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { AlertCircle, Home } from "lucide-react";
import { useLocation } from "wouter";

export default function NotFound() {
  const [, setLocation] = useLocation();

  const handleGoHome = () => {
    setLocation("/");
  };

  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100">
      <Card className="w-full max-w-lg mx-4 shadow-lg border-0 bg-white/80 backdrop-blur-sm">
        <CardContent className="pt-8 pb-8 text-center">
          <div className="flex justify-center mb-6">
            <div className="relative">
              <div className="absolute inset-0 bg-red-100 rounded-full animate-pulse" />
              <AlertCircle className="relative h-16 w-16 text-red-500" />
            </div>
          </div>

          <h1 className="text-4xl font-bold text-slate-900 mb-2">404</h1>

          <h2 className="text-xl font-semibold text-slate-700 mb-4">
            Page Not Found
          </h2>

          <p className="text-slate-600 mb-8 leading-relaxed">
            Sorry, the page you are looking for doesn't exist.
            <br />
            It may have been moved or deleted.
          </p>

          <div
            id="not-found-button-group"
            className="flex flex-col sm:flex-row gap-3 justify-center"
          >
            <Button
              onClick={handleGoHome}
              className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg"
            >
              <Home className="w-4 h-4 mr-2" />
              Go Home
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/Notificacoes.tsx
========================================
import { useState } from "react";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Bell,
  Search,
  Filter,
  CheckCheck,
  Trash2,
  Brain,
  Target,
  Trophy,
  AlertCircle,
  CheckCircle,
  Info,
} from "lucide-react";
import { useLocation } from "wouter";
import { toast } from "sonner";
import { cn } from "@/lib/utils";

/**
 * PÃ¡gina de HistÃ³rico de NotificaÃ§Ãµes
 * Lista completa com filtros avanÃ§ados
 */

export default function Notificacoes() {
  const { user } = useAuth();
  const [, setLocation] = useLocation();
  const [searchQuery, setSearchQuery] = useState("");
  const [typeFilter, setTypeFilter] = useState<string>("all");
  const [statusFilter, setStatusFilter] = useState<string>("all");
  const [periodFilter, setPeriodFilter] = useState<string>("all");

  // Buscar todas as notificaÃ§Ãµes
  const { data: notifications, refetch } = trpc.notifications.list.useQuery({
    limit: 100,
    onlyUnread: statusFilter === "unread",
  });

  // Mutation para marcar como lida
  const markAsReadMutation = trpc.notifications.markAsRead.useMutation({
    onSuccess: () => {
      refetch();
    },
  });

  // Mutation para marcar todas como lidas
  const markAllAsReadMutation = trpc.notifications.markAllAsRead.useMutation({
    onSuccess: () => {
      refetch();
      toast.success("Todas as notificaÃ§Ãµes marcadas como lidas");
    },
  });

  const handleNotificationClick = (notification: any) => {
    // Marcar como lida
    if (!notification.read) {
      markAsReadMutation.mutate({ id: notification.id });
    }

    // Navegar para o link se existir
    if (notification.link) {
      setLocation(notification.link);
    }
  };

  const handleMarkAllAsRead = () => {
    markAllAsReadMutation.mutate();
  };

  const getIcon = (type: string) => {
    switch (type) {
      case "test_completed":
        return <Brain className="h-5 w-5 text-blue-500" />;
      case "pdi_milestone":
        return <Target className="h-5 w-5 text-green-500" />;
      case "insight_critical":
        return <AlertCircle className="h-5 w-5 text-orange-500" />;
      case "evaluation_completed":
        return <CheckCircle className="h-5 w-5 text-purple-500" />;
      case "goal_achieved":
        return <Trophy className="h-5 w-5 text-yellow-500" />;
      default:
        return <Info className="h-5 w-5 text-gray-500" />;
    }
  };

  const formatTimeAgo = (date: Date | string) => {
    const now = new Date();
    const notifDate = new Date(date);
    const diffMs = now.getTime() - notifDate.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return "agora";
    if (diffMins < 60) return `${diffMins}m atrÃ¡s`;
    if (diffHours < 24) return `${diffHours}h atrÃ¡s`;
    if (diffDays === 1) return "ontem";
    if (diffDays < 7) return `${diffDays} dias atrÃ¡s`;
    return notifDate.toLocaleDateString("pt-BR");
  };

  const getTypeLabel = (type: string) => {
    const labels: Record<string, string> = {
      test_completed: "Teste ConcluÃ­do",
      pdi_milestone: "Marco de PDI",
      goal_achieved: "Meta Atingida",
      evaluation_completed: "AvaliaÃ§Ã£o ConcluÃ­da",
      insight_critical: "Insight CrÃ­tico",
    };
    return labels[type] || type;
  };

  // Filtrar notificaÃ§Ãµes
  const filteredNotifications = notifications?.filter((notif) => {
    // Filtro de busca
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      if (
        !notif.title.toLowerCase().includes(query) &&
        !notif.message?.toLowerCase().includes(query)
      ) {
        return false;
      }
    }

    // Filtro de tipo
    if (typeFilter !== "all" && notif.type !== typeFilter) {
      return false;
    }

    // Filtro de perÃ­odo
    if (periodFilter !== "all") {
      const notifDate = new Date(notif.createdAt);
      const now = new Date();
      const diffDays = Math.floor(
        (now.getTime() - notifDate.getTime()) / 86400000
      );

      if (periodFilter === "today" && diffDays > 0) return false;
      if (periodFilter === "week" && diffDays > 7) return false;
      if (periodFilter === "month" && diffDays > 30) return false;
      if (periodFilter === "year" && diffDays > 365) return false;
    }

    return true;
  });

  const unreadCount = notifications?.filter((n) => !n.read).length || 0;

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <Bell className="h-8 w-8" />
              NotificaÃ§Ãµes
            </h1>
            <p className="text-muted-foreground mt-2">
              HistÃ³rico completo de notificaÃ§Ãµes do sistema
            </p>
          </div>
          {unreadCount > 0 && (
            <Button onClick={handleMarkAllAsRead} className="gap-2">
              <CheckCheck className="h-4 w-4" />
              Marcar todas como lidas ({unreadCount})
            </Button>
          )}
        </div>

        {/* Filtros */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Filter className="h-5 w-5" />
              Filtros
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              {/* Busca */}
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="Buscar notificaÃ§Ãµes..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="pl-9"
                />
              </div>

              {/* Filtro de Tipo */}
              <Select value={typeFilter} onValueChange={setTypeFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Tipo" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os tipos</SelectItem>
                  <SelectItem value="test_completed">Testes ConcluÃ­dos</SelectItem>
                  <SelectItem value="pdi_milestone">Marcos de PDI</SelectItem>
                  <SelectItem value="goal_achieved">Metas Atingidas</SelectItem>
                  <SelectItem value="evaluation_completed">AvaliaÃ§Ãµes</SelectItem>
                  <SelectItem value="insight_critical">Insights CrÃ­ticos</SelectItem>
                </SelectContent>
              </Select>

              {/* Filtro de Status */}
              <Select value={statusFilter} onValueChange={setStatusFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Status" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todas</SelectItem>
                  <SelectItem value="unread">NÃ£o lidas</SelectItem>
                  <SelectItem value="read">Lidas</SelectItem>
                </SelectContent>
              </Select>

              {/* Filtro de PerÃ­odo */}
              <Select value={periodFilter} onValueChange={setPeriodFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="PerÃ­odo" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todo o perÃ­odo</SelectItem>
                  <SelectItem value="today">Hoje</SelectItem>
                  <SelectItem value="week">Ãšltima semana</SelectItem>
                  <SelectItem value="month">Ãšltimo mÃªs</SelectItem>
                  <SelectItem value="year">Ãšltimo ano</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </CardContent>
        </Card>

        {/* Lista de NotificaÃ§Ãµes */}
        <Card>
          <CardHeader>
            <CardTitle>
              {filteredNotifications?.length || 0} notificaÃ§Ãµes
            </CardTitle>
            <CardDescription>
              {unreadCount > 0
                ? `${unreadCount} nÃ£o ${unreadCount === 1 ? "lida" : "lidas"}`
                : "Todas as notificaÃ§Ãµes estÃ£o lidas"}
            </CardDescription>
          </CardHeader>
          <CardContent>
            {!filteredNotifications || filteredNotifications.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-12 text-center">
                <Bell className="h-16 w-16 text-muted-foreground/50 mb-4" />
                <p className="text-lg font-medium">Nenhuma notificaÃ§Ã£o encontrada</p>
                <p className="text-sm text-muted-foreground mt-1">
                  Tente ajustar os filtros ou aguarde novas notificaÃ§Ãµes
                </p>
              </div>
            ) : (
              <div className="space-y-3">
                {filteredNotifications.map((notification) => (
                  <div
                    key={notification.id}
                    className={cn(
                      "p-4 rounded-lg border hover:bg-accent transition-colors cursor-pointer",
                      !notification.read && "bg-blue-50/50 border-blue-200"
                    )}
                    onClick={() => handleNotificationClick(notification)}
                  >
                    <div className="flex items-start gap-4">
                      <div className="flex-shrink-0 mt-1">
                        {getIcon(notification.type)}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-start justify-between gap-2">
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <h3 className="font-semibold">
                                {notification.title}
                              </h3>
                              {!notification.read && (
                                <div className="w-2 h-2 bg-blue-500 rounded-full" />
                              )}
                            </div>
                            <Badge variant="secondary" className="mt-1">
                              {getTypeLabel(notification.type)}
                            </Badge>
                          </div>
                          <span className="text-sm text-muted-foreground flex-shrink-0">
                            {formatTimeAgo(notification.createdAt)}
                          </span>
                        </div>
                        <p className="text-sm text-muted-foreground mt-2">
                          {notification.message}
                        </p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/PDI.tsx
========================================
import DashboardLayout from "@/components/DashboardLayout";
import PDIWizard from "@/components/PDIWizard";
import { useState } from "react";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { trpc } from "@/lib/trpc";
import { downloadICS } from "@/lib/generateICS";
import { toast } from "sonner";
import { AlertCircle, BookOpen, Calendar, CalendarPlus, CheckCircle2, Clock, Plus, TrendingUp, Users2, Lightbulb, Brain } from "lucide-react";
import { useLocation } from "wouter";

export default function PDI() {
  const [showWizard, setShowWizard] = useState(false);
  const [, setLocation] = useLocation();
  const { data: pdis } = trpc.pdi.list.useQuery({});
  const { data: employee } = trpc.employees.getCurrent.useQuery();

  const activePDI = pdis?.find(p => p.status === "aprovado" || p.status === "em_andamento");
  const { data: pdiItems } = trpc.pdi.getItems.useQuery(
    { planId: activePDI?.id || 0 },
    { enabled: !!activePDI }
  );

  const getStatusBadge = (status: string) => {
    const variants: Record<string, { variant: any; label: string; icon: any }> = {
      rascunho: { variant: "secondary", label: "Rascunho", icon: Clock },
      pendente_aprovacao: { variant: "outline", label: "Pendente", icon: AlertCircle },
      aprovado: { variant: "default", label: "Aprovado", icon: CheckCircle2 },
      em_andamento: { variant: "default", label: "Em Andamento", icon: TrendingUp },
      concluido: { variant: "default", label: "ConcluÃ­do", icon: CheckCircle2 },
      cancelado: { variant: "destructive", label: "Cancelado", icon: AlertCircle },
    };

    const config = variants[status] || variants.rascunho;
    const Icon = config.icon;

    return (
      <Badge variant={config.variant} className="gap-1">
        <Icon className="h-3 w-3" />
        {config.label}
      </Badge>
    );
  };

  const getCategoryBadge = (category: string) => {
    const config: Record<string, { label: string; icon: any; color: string }> = {
      "70_pratica": { label: "70% PrÃ¡tica", icon: TrendingUp, color: "bg-blue-500" },
      "20_mentoria": { label: "20% Mentoria", icon: Users2, color: "bg-purple-500" },
      "10_curso": { label: "10% Curso", icon: BookOpen, color: "bg-green-500" },
    };

    const item = config[category] || config["70_pratica"];
    const Icon = item.icon;

    return (
      <div className="flex items-center gap-2">
        <div className={`w-2 h-2 rounded-full ${item.color}`} />
        <span className="text-xs font-medium">{item.label}</span>
      </div>
    );
  };

  const items70 = pdiItems?.filter(i => i.category === "70_pratica") || [];
  const items20 = pdiItems?.filter(i => i.category === "20_mentoria") || [];
  const items10 = pdiItems?.filter(i => i.category === "10_curso") || [];

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <TrendingUp className="h-8 w-8" />
              Plano de Desenvolvimento Individual
            </h1>
            <p className="text-muted-foreground mt-2">
              Acompanhe seu desenvolvimento profissional com o modelo 70-20-10
            </p>
          </div>
          <div className="flex items-center gap-3">
            <Button
              size="lg"
              variant="outline"
              onClick={() => setLocation("/pdi-inteligente/novo")}
            >
              <Brain className="h-4 w-4 mr-2" />
              PDI Inteligente
            </Button>
            {!activePDI && (
              <Button size="lg" onClick={() => setShowWizard(true)}>
                <Plus className="h-4 w-4 mr-2" />
                Criar PDI 70-20-10
              </Button>
            )}
          </div>
        </div>

        {showWizard ? (
          <PDIWizard 
            onComplete={() => setShowWizard(false)} 
            onCancel={() => setShowWizard(false)} 
          />
        ) : !activePDI ? (
          <Card>
            <CardContent className="flex flex-col items-center justify-center py-12">
              <TrendingUp className="h-12 w-12 text-muted-foreground mb-4" />
              <h3 className="font-semibold text-lg mb-2">Nenhum PDI ativo</h3>
              <p className="text-muted-foreground text-center mb-4 max-w-md">
                Crie seu Plano de Desenvolvimento Individual para estruturar seu crescimento profissional
              </p>
              <Button>
                <Plus className="h-4 w-4 mr-2" />
                Criar Primeiro PDI
              </Button>
            </CardContent>
          </Card>
        ) : (
          <>
            {/* PDI Overview */}
            <Card>
              <CardHeader>
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <CardTitle className="flex items-center gap-2">
                      PDI {new Date(activePDI.startDate).getFullYear()}
                      {getStatusBadge(activePDI.status)}
                    </CardTitle>
                    <CardDescription className="mt-2">
                      {new Date(activePDI.startDate).toLocaleDateString("pt-BR")} atÃ©{" "}
                      {new Date(activePDI.endDate).toLocaleDateString("pt-BR")}
                    </CardDescription>
                  </div>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      downloadICS(
                        {
                          title: `PDI ${new Date(activePDI.startDate).getFullYear()}`,
                          description: `Plano de Desenvolvimento Individual\nProgresso: ${activePDI.overallProgress}%`,
                          startDate: new Date(activePDI.startDate),
                          endDate: new Date(activePDI.endDate),
                        },
                        `pdi-${activePDI.id}-${new Date(activePDI.startDate).getFullYear()}`
                      );
                      toast.success("PDI adicionado ao calendÃ¡rio!");
                    }}
                  >
                    <CalendarPlus className="h-4 w-4 mr-2" />
                    Adicionar ao CalendÃ¡rio
                  </Button>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-muted-foreground">Progresso geral</span>
                    <span className="font-semibold">{activePDI.overallProgress}%</span>
                  </div>
                  <Progress value={activePDI.overallProgress} className="h-3" />
                </div>

                <div className="grid grid-cols-3 gap-4 pt-2">
                  <div className="text-center p-4 bg-blue-50 dark:bg-blue-950 rounded-lg">
                    <div className="text-2xl font-bold text-blue-600 dark:text-blue-400">
                      {items70.length}
                    </div>
                    <p className="text-xs text-muted-foreground mt-1">AÃ§Ãµes PrÃ¡ticas (70%)</p>
                  </div>
                  <div className="text-center p-4 bg-purple-50 dark:bg-purple-950 rounded-lg">
                    <div className="text-2xl font-bold text-purple-600 dark:text-purple-400">
                      {items20.length}
                    </div>
                    <p className="text-xs text-muted-foreground mt-1">Mentorias (20%)</p>
                  </div>
                  <div className="text-center p-4 bg-green-50 dark:bg-green-950 rounded-lg">
                    <div className="text-2xl font-bold text-green-600 dark:text-green-400">
                      {items10.length}
                    </div>
                    <p className="text-xs text-muted-foreground mt-1">Cursos (10%)</p>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* PDI Items */}
            <Tabs defaultValue="all" className="space-y-4">
              <TabsList>
                <TabsTrigger value="all">Todas ({pdiItems?.length || 0})</TabsTrigger>
                <TabsTrigger value="70">70% PrÃ¡tica ({items70.length})</TabsTrigger>
                <TabsTrigger value="20">20% Mentoria ({items20.length})</TabsTrigger>
                <TabsTrigger value="10">10% Curso ({items10.length})</TabsTrigger>
              </TabsList>

              <TabsContent value="all" className="space-y-4">
                {pdiItems?.length === 0 ? (
                  <Card>
                    <CardContent className="flex flex-col items-center justify-center py-8">
                      <AlertCircle className="h-10 w-10 text-muted-foreground mb-3" />
                      <p className="text-muted-foreground">Nenhuma aÃ§Ã£o de desenvolvimento cadastrada</p>
                      <Button variant="link" className="mt-2">
                        <Plus className="h-4 w-4 mr-2" />
                        Adicionar AÃ§Ã£o
                      </Button>
                    </CardContent>
                  </Card>
                ) : (
                  pdiItems?.map((item) => (
                    <Card key={item.id}>
                      <CardHeader>
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <CardTitle className="text-base flex items-center gap-2">
                              {item.title}
                              {getStatusBadge(item.status)}
                            </CardTitle>
                            <CardDescription className="mt-2">
                              {item.description}
                            </CardDescription>
                          </div>
                          {getCategoryBadge(item.category)}
                        </div>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                          <div>
                            <p className="text-muted-foreground">Tipo</p>
                            <p className="font-medium capitalize">{item.type}</p>
                          </div>
                          <div>
                            <p className="text-muted-foreground">InÃ­cio</p>
                            <p className="font-medium">
                              {new Date(item.startDate).toLocaleDateString("pt-BR")}
                            </p>
                          </div>
                          <div>
                            <p className="text-muted-foreground">TÃ©rmino</p>
                            <p className="font-medium">
                              {new Date(item.endDate).toLocaleDateString("pt-BR")}
                            </p>
                          </div>
                          <div>
                            <p className="text-muted-foreground">Status</p>
                            <p className="font-medium capitalize">{item.status}</p>
                          </div>
                        </div>

                        <div className="space-y-2">
                          <div className="flex items-center justify-between text-sm">
                            <span className="text-muted-foreground">Progresso</span>
                            <span className="font-semibold">{item.progress}%</span>
                          </div>
                          <Progress value={item.progress} className="h-2" />
                        </div>

                        {item.status === "em_andamento" && (
                          <div className="flex gap-2 pt-2">
                            <Button variant="outline" size="sm">
                              Atualizar Progresso
                            </Button>
                            <Button variant="outline" size="sm">
                              Marcar como ConcluÃ­da
                            </Button>
                          </div>
                        )}

                        {item.completedAt && (
                          <div className="bg-green-50 dark:bg-green-950 p-3 rounded-lg flex items-center gap-2">
                            <CheckCircle2 className="h-5 w-5 text-green-600 dark:text-green-400" />
                            <p className="text-sm">
                              ConcluÃ­da em {new Date(item.completedAt).toLocaleDateString("pt-BR")}
                            </p>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  ))
                )}
              </TabsContent>

              <TabsContent value="70" className="space-y-4">
                {items70.length === 0 ? (
                  <Card>
                    <CardContent className="flex flex-col items-center justify-center py-8">
                      <TrendingUp className="h-10 w-10 text-muted-foreground mb-3" />
                      <p className="text-muted-foreground">Nenhuma aÃ§Ã£o prÃ¡tica cadastrada</p>
                    </CardContent>
                  </Card>
                ) : (
                  items70.map((item) => (
                    <Card key={item.id}>
                      <CardHeader>
                        <CardTitle className="text-base">{item.title}</CardTitle>
                        <CardDescription>{item.description}</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-2">
                          <div className="flex justify-between text-sm">
                            <span className="text-muted-foreground">Progresso</span>
                            <span className="font-semibold">{item.progress}%</span>
                          </div>
                          <Progress value={item.progress} className="h-2" />
                        </div>
                      </CardContent>
                    </Card>
                  ))
                )}
              </TabsContent>

              <TabsContent value="20" className="space-y-4">
                {items20.length === 0 ? (
                  <Card>
                    <CardContent className="flex flex-col items-center justify-center py-8">
                      <Users2 className="h-10 w-10 text-muted-foreground mb-3" />
                      <p className="text-muted-foreground">Nenhuma mentoria cadastrada</p>
                    </CardContent>
                  </Card>
                ) : (
                  items20.map((item) => (
                    <Card key={item.id}>
                      <CardHeader>
                        <CardTitle className="text-base">{item.title}</CardTitle>
                        <CardDescription>{item.description}</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-2">
                          <div className="flex justify-between text-sm">
                            <span className="text-muted-foreground">Progresso</span>
                            <span className="font-semibold">{item.progress}%</span>
                          </div>
                          <Progress value={item.progress} className="h-2" />
                        </div>
                      </CardContent>
                    </Card>
                  ))
                )}
              </TabsContent>

              <TabsContent value="10" className="space-y-4">
                {items10.length === 0 ? (
                  <Card>
                    <CardContent className="flex flex-col items-center justify-center py-8">
                      <BookOpen className="h-10 w-10 text-muted-foreground mb-3" />
                      <p className="text-muted-foreground">Nenhum curso cadastrado</p>
                    </CardContent>
                  </Card>
                ) : (
                  items10.map((item) => (
                    <Card key={item.id}>
                      <CardHeader>
                        <CardTitle className="text-base">{item.title}</CardTitle>
                        <CardDescription>{item.description}</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-2">
                          <div className="flex justify-between text-sm">
                            <span className="text-muted-foreground">Progresso</span>
                            <span className="font-semibold">{item.progress}%</span>
                          </div>
                          <Progress value={item.progress} className="h-2" />
                        </div>
                      </CardContent>
                    </Card>
                  ))
                )}
              </TabsContent>
            </Tabs>

            {/* Info Card */}
            <Card className="bg-muted/50">
              <CardHeader>
                <CardTitle className="text-base">Modelo 70-20-10</CardTitle>
              </CardHeader>
              <CardContent className="text-sm text-muted-foreground space-y-2">
                <p>
                  O modelo 70-20-10 Ã© uma abordagem cientÃ­fica para o desenvolvimento profissional:
                </p>
                <ul className="list-disc list-inside space-y-1 ml-2">
                  <li><strong>70% PrÃ¡tica:</strong> Aprendizado atravÃ©s de experiÃªncias e desafios reais no trabalho</li>
                  <li><strong>20% Mentoria:</strong> Desenvolvimento atravÃ©s de relacionamentos e feedback de outros</li>
                  <li><strong>10% Cursos:</strong> EducaÃ§Ã£o formal atravÃ©s de treinamentos e cursos estruturados</li>
                </ul>
              </CardContent>
            </Card>
          </>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/PDIInteligente.tsx
========================================
import { useState } from "react";
import { useRoute } from "wouter";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Progress } from "@/components/ui/progress";
import { Loader2, Target, Users, Calendar, TrendingUp, Download, ArrowLeft, Award } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { Link } from "wouter";
import { exportPDIInteligente } from "@/lib/exportPDF";
import { toast } from "sonner";
import {
  Chart as ChartJS,
  RadialLinearScale,
  PointElement,
  LineElement,
  Filler,
  Tooltip,
  Legend,
} from "chart.js";
import { Radar } from "react-chartjs-2";

ChartJS.register(RadialLinearScale, PointElement, LineElement, Filler, Tooltip, Legend);

/**
 * PDI Inteligente - Modelo Nadia
 * 
 * Estrutura:
 * 1. Desafio EstratÃ©gico (contexto, objetivos, 24 meses, 4 envolvidos)
 * 2. Pacto de Desenvolvimento (Sucessor, Gestor, Sponsors, DGC)
 * 3. DiagnÃ³stico de CompetÃªncias (grÃ¡fico radar: atual vs. alvo)
 * 4. Matriz de Gaps (competÃªncias + responsabilidades)
 * 5. Plano de AÃ§Ã£o 70-20-10 (tabela com status, mÃ©tricas, responsÃ¡veis)
 * 6. ProgressÃ£o EstratÃ©gica (marcos 12 e 24 meses)
 */

export default function PDIInteligente() {
  const [, params] = useRoute("/pdi-inteligente/:id");
  const pdiId = params?.id ? parseInt(params.id) : null;

  // Queries
  const { data: pdi, isLoading } = trpc.pdiIntelligent.getById.useQuery(
    { id: pdiId! },
    { enabled: !!pdiId }
  );

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  if (!pdi) {
    return (
      <DashboardLayout>
        <div className="text-center py-16">
          <h2 className="text-2xl font-bold mb-4">PDI nÃ£o encontrado</h2>
          <Link href="/pdi">
            <Button>Voltar para PDIs</Button>
          </Link>
        </div>
      </DashboardLayout>
    );
  }

  // Dados do grÃ¡fico radar
  const radarData = {
    labels: pdi.gaps.map((g) => g.competencyName || `CompetÃªncia ${g.competencyId}`),
    datasets: [
      {
        label: "Perfil Atual",
        data: pdi.gaps.map((g) => g.currentLevel),
        backgroundColor: "rgba(59, 130, 246, 0.2)",
        borderColor: "rgba(59, 130, 246, 1)",
        borderWidth: 2,
      },
      {
        label: "Perfil Alvo",
        data: pdi.gaps.map((g) => g.targetLevel),
        backgroundColor: "rgba(34, 197, 94, 0.2)",
        borderColor: "rgba(34, 197, 94, 1)",
        borderWidth: 2,
      },
    ],
  };

  const radarOptions = {
    scales: {
      r: {
        beginAtZero: true,
        max: 5,
        ticks: {
          stepSize: 1,
        },
      },
    },
    plugins: {
      legend: {
        position: "bottom" as const,
      },
    },
  };

  // Calcular progresso geral
  const totalActions = 0; // TODO: implementar quando actions estiver disponÃ­vel
  const completedActions = 0;
  const progressPercent = 0;

  return (
    <DashboardLayout>
      <div className="space-y-6" id="pdi-inteligente-content">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/pdi">
              <Button variant="ghost" size="icon">
                <ArrowLeft className="h-5 w-5" />
              </Button>
            </Link>
            <div>
              <div className="flex items-center gap-2">
                <Target className="h-6 w-6 text-primary" />
                <h1 className="text-2xl font-bold">PDI Inteligente</h1>
              </div>
              <p className="text-sm text-muted-foreground">
                PDI Inteligente - Desenvolvimento EstratÃ©gico
              </p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <Badge variant={pdi.pdiPlans?.status === "concluido" ? "default" : "secondary"} className="text-sm">
              {pdi.pdiPlans?.status === "em_andamento"
                ? "Em Andamento"
                : pdi.pdiPlans?.status === "concluido"
                ? "ConcluÃ­do"
                : "Rascunho"}
            </Badge>
            <Button 
              variant="outline"
              onClick={async () => {
                try {
                  toast.info("Gerando PDF...");
                  await exportPDIInteligente(pdiId!);
                  toast.success("PDF exportado com sucesso!");
                } catch (error) {
                  toast.error("Erro ao exportar PDF");
                }
              }}
            >
              <Download className="h-4 w-4 mr-2" />
              Exportar PDF
            </Button>
          </div>
        </div>

        {/* KPIs RÃ¡pidos */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">DuraÃ§Ã£o</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">24 meses</div>
              <p className="text-xs text-muted-foreground mt-1">Planejamento estratÃ©gico</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Envolvidos</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">4</div>
              <p className="text-xs text-muted-foreground mt-1">Sucessor, Gestor, Sponsors, DGC</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Gaps Identificados</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{pdi.gaps.length}</div>
              <p className="text-xs text-muted-foreground mt-1">CompetÃªncias a desenvolver</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground">Progresso</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{progressPercent.toFixed(0)}%</div>
              <Progress value={progressPercent} className="mt-2" />
            </CardContent>
          </Card>
        </div>

        {/* Tabs Principais */}
        <Tabs defaultValue="diagnostico" className="space-y-6">
          <TabsList className="grid w-full grid-cols-5">
            <TabsTrigger value="diagnostico">DiagnÃ³stico</TabsTrigger>
            <TabsTrigger value="gaps">Matriz de Gaps</TabsTrigger>
            <TabsTrigger value="plano">Plano 70-20-10</TabsTrigger>
            <TabsTrigger value="progressao">ProgressÃ£o</TabsTrigger>
            <TabsTrigger value="riscos">Riscos</TabsTrigger>
          </TabsList>

          {/* Tab: DiagnÃ³stico de CompetÃªncias */}
          <TabsContent value="diagnostico" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>DiagnÃ³stico de CompetÃªncias</CardTitle>
                <p className="text-sm text-muted-foreground">
                  ComparaÃ§Ã£o entre perfil atual e perfil alvo da posiÃ§Ã£o
                </p>
              </CardHeader>
              <CardContent>
                <div className="max-w-2xl mx-auto">
                  <Radar data={radarData} options={radarOptions} />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Desafio EstratÃ©gico</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <h4 className="font-semibold mb-2">Contexto</h4>
                  <p className="text-sm text-muted-foreground">
                    {pdi.details?.strategicContext || "PreparaÃ§Ã£o para assumir posiÃ§Ã£o estratÃ©gica na organizaÃ§Ã£o"}
                  </p>
                </div>
                <div>
                  <h4 className="font-semibold mb-2">Objetivos</h4>
                  <p className="text-sm text-muted-foreground">
                    {pdi.details?.strategicContext ||
                      "Desenvolver competÃªncias tÃ©cnicas e comportamentais necessÃ¡rias para a posiÃ§Ã£o-alvo"}
                  </p>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Pacto de Desenvolvimento</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="flex items-start gap-3 p-4 rounded-lg border">
                    <div className="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                      <Users className="h-5 w-5 text-blue-600" />
                    </div>
                    <div>
                      <h4 className="font-semibold">Sucessor</h4>
                      <p className="text-sm text-muted-foreground">{pdi.pdiPlans?.employeeId ? `Colaborador ID: ${pdi.pdiPlans.employeeId}` : "Colaborador"}</p>
                      <p className="text-xs text-muted-foreground mt-1">
                        ResponsÃ¡vel por executar o plano
                      </p>
                    </div>
                  </div>

                  <div className="flex items-start gap-3 p-4 rounded-lg border">
                    <div className="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                      <Award className="h-5 w-5 text-green-600" />
                    </div>
                    <div>
                      <h4 className="font-semibold">Gestor Direto</h4>
                      <p className="text-sm text-muted-foreground">{pdi.details?.mentorId ? `Mentor ID: ${pdi.details.mentorId}` : "A definir"}</p>
                      <p className="text-xs text-muted-foreground mt-1">
                        Acompanhamento e feedback contÃ­nuo
                      </p>
                    </div>
                  </div>

                  <div className="flex items-start gap-3 p-4 rounded-lg border">
                    <div className="h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                      <Target className="h-5 w-5 text-purple-600" />
                    </div>
                    <div>
                      <h4 className="font-semibold">Sponsors</h4>
                      <p className="text-sm text-muted-foreground">
                        {pdi.details?.sponsorId1 || pdi.details?.sponsorId2 ? "Sponsors definidos" : "LideranÃ§a executiva"}
                      </p>
                      <p className="text-xs text-muted-foreground mt-1">Apoio estratÃ©gico e recursos</p>
                    </div>
                  </div>

                  <div className="flex items-start gap-3 p-4 rounded-lg border">
                    <div className="h-10 w-10 rounded-full bg-orange-100 flex items-center justify-center">
                      <Users className="h-5 w-5 text-orange-600" />
                    </div>
                    <div>
                      <h4 className="font-semibold">DGC (RH)</h4>
                      <p className="text-sm text-muted-foreground">Equipe de Desenvolvimento</p>
                      <p className="text-xs text-muted-foreground mt-1">
                        CoordenaÃ§Ã£o e monitoramento
                      </p>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Tab: Matriz de Gaps */}
          <TabsContent value="gaps" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Matriz de Gaps de CompetÃªncias</CardTitle>
                <p className="text-sm text-muted-foreground">
                  AnÃ¡lise detalhada das competÃªncias a desenvolver
                </p>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {pdi.gaps.map((gap, idx) => (
                    <div key={idx} className="p-4 rounded-lg border">
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <h4 className="font-semibold">{gap.competencyName || `CompetÃªncia ${gap.competencyId}`}</h4>
                          <p className="text-sm text-muted-foreground mt-1">
                            Gap: {gap.gap} pontos | Status: {gap.status}
                          </p>
                        </div>
                        <Badge
                          variant={
                            gap.priority === "alta"
                              ? "destructive"
                              : gap.priority === "media"
                              ? "default"
                              : "secondary"
                          }
                        >
                          {gap.priority === "alta"
                            ? "Alta"
                            : gap.priority === "media"
                            ? "MÃ©dia"
                            : "Baixa"}
                        </Badge>
                      </div>

                      <div className="grid grid-cols-3 gap-4 mb-3">
                        <div>
                          <p className="text-xs text-muted-foreground">NÃ­vel Atual</p>
                          <div className="flex items-center gap-2 mt-1">
                            <Progress value={gap.currentLevel * 20} className="flex-1" />
                            <span className="text-sm font-semibold">{gap.currentLevel}/5</span>
                          </div>
                        </div>
                        <div>
                          <p className="text-xs text-muted-foreground">NÃ­vel Alvo</p>
                          <div className="flex items-center gap-2 mt-1">
                            <Progress value={gap.targetLevel * 20} className="flex-1" />
                            <span className="text-sm font-semibold">{gap.targetLevel}/5</span>
                          </div>
                        </div>
                        <div>
                          <p className="text-xs text-muted-foreground">Gap</p>
                          <div className="flex items-center gap-2 mt-1">
                            <Progress
                              value={(gap.targetLevel - gap.currentLevel) * 20}
                              className="flex-1"
                            />
                            <span className="text-sm font-semibold text-orange-600">
                              {gap.targetLevel - gap.currentLevel}
                            </span>
                          </div>
                        </div>
                      </div>

                      <div className="flex items-center gap-2 text-xs text-muted-foreground">
                        <span>AÃ§Ãµes:</span>
                        {gap.employeeActions && (
                          <Badge variant="outline" className="text-xs">
                            Colaborador
                          </Badge>
                        )}
                        {gap.managerActions && (
                          <Badge variant="outline" className="text-xs">
                            Gestor
                          </Badge>
                        )}
                        {gap.sponsorActions && (
                          <Badge variant="outline" className="text-xs">
                            Sponsor
                          </Badge>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Tab: Plano de AÃ§Ã£o 70-20-10 */}
          <TabsContent value="plano" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Plano de AÃ§Ã£o 70-20-10</CardTitle>
                <p className="text-sm text-muted-foreground">
                  70% experiÃªncia prÃ¡tica, 20% relacionamentos, 10% treinamentos formais
                </p>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {/* TODO: Implementar actions quando disponÃ­vel no schema */}
                  {[].map((action: any, idx: number) => (
                    <div key={idx} className="flex items-center gap-4 p-4 rounded-lg border">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <h4 className="font-semibold">{action.description}</h4>
                          <Badge
                            variant={
                              action.type === "70"
                                ? "default"
                                : action.type === "20"
                                ? "secondary"
                                : "outline"
                            }
                            className="text-xs"
                          >
                            {action.type}%
                          </Badge>
                        </div>
                        <p className="text-sm text-muted-foreground">
                          ResponsÃ¡vel: {action.responsible || "A definir"}
                        </p>
                      </div>

                      <div className="text-center">
                        <p className="text-xs text-muted-foreground">Status</p>
                        <Badge
                          variant={
                            action.status === "concluido"
                              ? "default"
                              : action.status === "em_andamento"
                              ? "secondary"
                              : "outline"
                          }
                          className="mt-1"
                        >
                          {action.status === "concluido"
                            ? "ConcluÃ­do"
                            : action.status === "em_andamento"
                            ? "Em Andamento"
                            : "Pendente"}
                        </Badge>
                      </div>

                      <div className="text-center">
                        <p className="text-xs text-muted-foreground">Prazo</p>
                        <p className="text-sm font-semibold mt-1">
                          {action.deadline
                            ? new Date(action.deadline).toLocaleDateString("pt-BR")
                            : "â€”"}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Tab: ProgressÃ£o EstratÃ©gica */}
          <TabsContent value="progressao" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>ProgressÃ£o EstratÃ©gica</CardTitle>
                <p className="text-sm text-muted-foreground">Marcos de 12 e 24 meses</p>
              </CardHeader>
              <CardContent>
                <div className="space-y-6">
                  <div className="relative pl-8 pb-8 border-l-2 border-primary">
                    <div className="absolute -left-3 top-0 h-6 w-6 rounded-full bg-primary flex items-center justify-center text-white text-xs font-bold">
                      12
                    </div>
                    <div className="ml-4">
                      <h4 className="font-semibold mb-2">Marco de 12 Meses</h4>
                      <ul className="space-y-2 text-sm text-muted-foreground">
                        <li>â€¢ DomÃ­nio de 60% das competÃªncias-alvo</li>
                        <li>â€¢ ConclusÃ£o de projetos prÃ¡ticos (70%)</li>
                        <li>â€¢ ParticipaÃ§Ã£o em comitÃªs estratÃ©gicos</li>
                        <li>â€¢ AvaliaÃ§Ã£o intermediÃ¡ria com feedback 360Â°</li>
                      </ul>
                    </div>
                  </div>

                  <div className="relative pl-8 border-l-2 border-green-500">
                    <div className="absolute -left-3 top-0 h-6 w-6 rounded-full bg-green-500 flex items-center justify-center text-white text-xs font-bold">
                      24
                    </div>
                    <div className="ml-4">
                      <h4 className="font-semibold mb-2">Marco de 24 Meses</h4>
                      <ul className="space-y-2 text-sm text-muted-foreground">
                        <li>â€¢ DomÃ­nio de 100% das competÃªncias-alvo</li>
                        <li>â€¢ ProntidÃ£o para assumir a posiÃ§Ã£o</li>
                        <li>â€¢ Reconhecimento formal pela lideranÃ§a</li>
                        <li>â€¢ TransiÃ§Ã£o planejada para a nova funÃ§Ã£o</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Tab: Riscos */}
          <TabsContent value="riscos" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>GestÃ£o de Riscos</CardTitle>
                <p className="text-sm text-muted-foreground">
                  IdentificaÃ§Ã£o e mitigaÃ§Ã£o de riscos ao desenvolvimento
                </p>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {pdi.risks?.map((risk, idx) => (
                    <div key={idx} className="p-4 rounded-lg border">
                      <div className="flex items-start justify-between mb-2">
                        <h4 className="font-semibold">{risk.description}</h4>
                        <Badge
                          variant={
                            risk.impact === "critico" || risk.impact === "alto"
                              ? "destructive"
                              : risk.impact === "medio"
                              ? "default"
                              : "secondary"
                          }
                        >
                          {risk.impact === "critico"
                            ? "CrÃ­tico"
                            : risk.impact === "alto"
                            ? "Alto"
                            : risk.impact === "medio"
                            ? "MÃ©dio"
                            : "Baixo"}
                        </Badge>
                      </div>
                      <p className="text-sm text-muted-foreground mb-3">
                        <strong>MitigaÃ§Ã£o:</strong> {risk.mitigation}
                      </p>
                      <div className="flex items-center gap-2">
                        <Badge variant="outline" className="text-xs">
                          Status: {risk.status === "mitigado" ? "Mitigado" : "Em Monitoramento"}
                        </Badge>
                      </div>
                    </div>
                  ))}

                  {(!pdi.risks || pdi.risks.length === 0) && (
                    <div className="text-center py-8 text-muted-foreground">
                      <p>Nenhum risco identificado no momento</p>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/PDIInteligenteDetalhes.tsx
========================================
import { useState } from "react";
import { useRoute } from "wouter";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Loader2, Plus, Save, Download, ArrowLeft, TrendingUp, Calendar, Target } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { Link } from "wouter";
import { toast } from "sonner";
import { Line } from "react-chartjs-2";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend,
} from "chart.js";

ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend);

/**
 * PDI Inteligente - Detalhes com AÃ§Ãµes e Acompanhamento
 * Modelo Nadia: Tabela de aÃ§Ãµes 70-20-10 + Feedbacks DGC + GrÃ¡fico IPS
 */

export default function PDIInteligenteDetalhes() {
  const [, params] = useRoute("/pdi-inteligente/:id/detalhes");
  const pdiId = params?.id ? parseInt(params.id) : null;

  const [showAddAction, setShowAddAction] = useState(false);
  const [showAddReview, setShowAddReview] = useState(false);

  // Form states
  const [actionForm, setActionForm] = useState({
    title: "",
    description: "",
    axis: "70_pratica" as "70_pratica" | "20_experiencia" | "10_educacao",
    developmentArea: "",
    successMetric: "",
    evidenceRequired: "",
    responsible: "",
    dueDate: "",
  });

  const [reviewForm, setReviewForm] = useState({
    reviewDate: new Date().toISOString().split("T")[0],
    readinessIndex: 3,
    keyPoints: "",
    strengths: "",
    improvements: "",
    nextSteps: "",
  });

  // Queries
  const utils = trpc.useUtils();
  const { data: pdi, isLoading: loadingPDI } = trpc.pdiIntelligent.getById.useQuery(
    { id: pdiId! },
    { enabled: !!pdiId }
  );
  const { data: actions, isLoading: loadingActions } = trpc.pdiIntelligent.getActions.useQuery(
    { planId: pdiId! },
    { enabled: !!pdiId }
  );
  const { data: reviews, isLoading: loadingReviews } = trpc.pdiIntelligent.getGovernanceReviews.useQuery(
    { planId: pdiId! },
    { enabled: !!pdiId }
  );
  const { data: ipsEvolution } = trpc.pdiIntelligent.getIPSEvolution.useQuery(
    { planId: pdiId! },
    { enabled: !!pdiId }
  );

  // Mutations
  const addActionMutation = trpc.pdiIntelligent.addAction.useMutation({
    onSuccess: () => {
      toast.success("AÃ§Ã£o adicionada com sucesso!");
      utils.pdiIntelligent.getActions.invalidate({ planId: pdiId! });
      setShowAddAction(false);
      setActionForm({
        title: "",
        description: "",
        axis: "70_pratica",
        developmentArea: "",
        successMetric: "",
        evidenceRequired: "",
        responsible: "",
        dueDate: "",
      });
    },
    onError: (error) => {
      toast.error(`Erro ao adicionar aÃ§Ã£o: ${error.message}`);
    },
  });

  const updateActionStatusMutation = trpc.pdiIntelligent.updateActionStatus.useMutation({
    onSuccess: () => {
      toast.success("Status atualizado!");
      utils.pdiIntelligent.getActions.invalidate({ planId: pdiId! });
    },
    onError: (error) => {
      toast.error(`Erro: ${error.message}`);
    },
  });

  const addReviewMutation = trpc.pdiIntelligent.addGovernanceReview.useMutation({
    onSuccess: () => {
      toast.success("Feedback adicionado com sucesso!");
      utils.pdiIntelligent.getGovernanceReviews.invalidate({ planId: pdiId! });
      utils.pdiIntelligent.getIPSEvolution.invalidate({ planId: pdiId! });
      setShowAddReview(false);
      setReviewForm({
        reviewDate: new Date().toISOString().split("T")[0],
        readinessIndex: 3,
        keyPoints: "",
        strengths: "",
        improvements: "",
        nextSteps: "",
      });
    },
    onError: (error) => {
      toast.error(`Erro ao adicionar feedback: ${error.message}`);
    },
  });

  const handleAddAction = () => {
    if (!pdiId) return;
    addActionMutation.mutate({
      planId: pdiId,
      ...actionForm,
    });
  };

  const handleUpdateStatus = (actionId: number, status: "nao_iniciado" | "em_andamento" | "concluido") => {
    updateActionStatusMutation.mutate({ id: actionId, status });
  };

  const handleAddReview = () => {
    if (!pdiId) return;
    addReviewMutation.mutate({
      planId: pdiId,
      reviewerId: 1, // TODO: pegar do contexto do usuÃ¡rio
      reviewerRole: "dgc",
      ...reviewForm,
    });
  };

  // Dados do grÃ¡fico de evoluÃ§Ã£o do IPS
  const ipsChartData = {
    labels: ipsEvolution?.map((e) => new Date(e.reviewDate).toLocaleDateString("pt-BR")) || [],
    datasets: [
      {
        label: "Ãndice de ProntidÃ£o para SucessÃ£o (IPS)",
        data: ipsEvolution?.map((e) => parseFloat(e.readinessIndex)) || [],
        borderColor: "rgb(124, 58, 237)",
        backgroundColor: "rgba(124, 58, 237, 0.1)",
        tension: 0.4,
        fill: true,
      },
    ],
  };

  const ipsChartOptions = {
    responsive: true,
    plugins: {
      legend: {
        display: true,
        position: "top" as const,
      },
      title: {
        display: false,
      },
    },
    scales: {
      y: {
        beginAtZero: true,
        max: 5,
        ticks: {
          stepSize: 0.5,
        },
      },
    },
  };

  if (loadingPDI) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  if (!pdi) {
    return (
      <DashboardLayout>
        <div className="text-center py-16">
          <h2 className="text-2xl font-bold mb-4">PDI nÃ£o encontrado</h2>
          <Link href="/pdi-inteligente">
            <Button>Voltar</Button>
          </Link>
        </div>
      </DashboardLayout>
    );
  }

  const getStatusBadge = (status: string) => {
    const variants: Record<string, { label: string; variant: "default" | "secondary" | "destructive" | "outline" }> = {
      nao_iniciado: { label: "NÃ£o Iniciado", variant: "secondary" },
      em_andamento: { label: "Em Andamento", variant: "default" },
      concluido: { label: "ConcluÃ­do", variant: "outline" },
    };
    const config = variants[status] || variants.nao_iniciado;
    return <Badge variant={config.variant}>{config.label}</Badge>;
  };

  const getAxisBadge = (axis: string) => {
    const labels: Record<string, string> = {
      "70_pratica": "70% PrÃ¡tica",
      "20_experiencia": "20% ExperiÃªncia",
      "10_educacao": "10% EducaÃ§Ã£o",
    };
    return <Badge variant="outline">{labels[axis] || axis}</Badge>;
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/pdi-inteligente">
              <Button variant="ghost" size="icon">
                <ArrowLeft className="h-5 w-5" />
              </Button>
            </Link>
            <div>
              <h1 className="text-3xl font-bold">PDI Inteligente - {pdi.employees?.name || "Colaborador"}</h1>
              <p className="text-muted-foreground">
                Cargo Alvo: {pdi.positions?.title || "N/A"} | PerÃ­odo: {new Date(pdi.pdiPlans.startDate).toLocaleDateString("pt-BR")} - {new Date(pdi.pdiPlans.endDate).toLocaleDateString("pt-BR")}
              </p>
            </div>
          </div>
          <div className="flex gap-2">
            <Button variant="outline">
              <Download className="h-4 w-4 mr-2" />
              Exportar PDF
            </Button>
          </div>
        </div>

        {/* SeÃ§Ã£o 1: Plano de AÃ§Ã£o Detalhado (70-20-10) */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div>
                <CardTitle className="flex items-center gap-2">
                  <Target className="h-5 w-5" />
                  Plano de AÃ§Ã£o Detalhado (70-20-10)
                </CardTitle>
                <CardDescription>
                  AÃ§Ãµes especÃ­ficas com mÃ©tricas de sucesso, responsÃ¡veis e status
                </CardDescription>
              </div>
              <Dialog open={showAddAction} onOpenChange={setShowAddAction}>
                <DialogTrigger asChild>
                  <Button>
                    <Plus className="h-4 w-4 mr-2" />
                    Adicionar AÃ§Ã£o
                  </Button>
                </DialogTrigger>
                <DialogContent className="max-w-2xl">
                  <DialogHeader>
                    <DialogTitle>Nova AÃ§Ã£o do PDI</DialogTitle>
                    <DialogDescription>
                      Adicione uma nova aÃ§Ã£o ao plano de desenvolvimento
                    </DialogDescription>
                  </DialogHeader>
                  <div className="grid gap-4 py-4">
                    <div className="grid gap-2">
                      <Label htmlFor="title">TÃ­tulo da AÃ§Ã£o</Label>
                      <Input
                        id="title"
                        value={actionForm.title}
                        onChange={(e) => setActionForm({ ...actionForm, title: e.target.value })}
                        placeholder="Ex: Liderar Projeto Almox 5.0"
                      />
                    </div>
                    <div className="grid gap-2">
                      <Label htmlFor="description">DescriÃ§Ã£o</Label>
                      <Textarea
                        id="description"
                        value={actionForm.description}
                        onChange={(e) => setActionForm({ ...actionForm, description: e.target.value })}
                        placeholder="Descreva a aÃ§Ã£o em detalhes..."
                        rows={3}
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="grid gap-2">
                        <Label htmlFor="axis">Eixo (70-20-10)</Label>
                        <Select value={actionForm.axis} onValueChange={(value: any) => setActionForm({ ...actionForm, axis: value })}>
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="70_pratica">70% PrÃ¡tica</SelectItem>
                            <SelectItem value="20_experiencia">20% ExperiÃªncia</SelectItem>
                            <SelectItem value="10_educacao">10% EducaÃ§Ã£o</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                      <div className="grid gap-2">
                        <Label htmlFor="developmentArea">Eixo de Desenvolvimento</Label>
                        <Input
                          id="developmentArea"
                          value={actionForm.developmentArea}
                          onChange={(e) => setActionForm({ ...actionForm, developmentArea: e.target.value })}
                          placeholder="Ex: VisÃ£o HolÃ­stica"
                        />
                      </div>
                    </div>
                    <div className="grid gap-2">
                      <Label htmlFor="successMetric">MÃ©trica de Sucesso / EvidÃªncia</Label>
                      <Textarea
                        id="successMetric"
                        value={actionForm.successMetric}
                        onChange={(e) => setActionForm({ ...actionForm, successMetric: e.target.value })}
                        placeholder="Como medir o sucesso desta aÃ§Ã£o?"
                        rows={2}
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="grid gap-2">
                        <Label htmlFor="responsible">ResponsÃ¡veis</Label>
                        <Input
                          id="responsible"
                          value={actionForm.responsible}
                          onChange={(e) => setActionForm({ ...actionForm, responsible: e.target.value })}
                          placeholder="Ex: Nadia C. (LÃ­der), Carlos M. (Sponsor)"
                        />
                      </div>
                      <div className="grid gap-2">
                        <Label htmlFor="dueDate">Prazo</Label>
                        <Input
                          id="dueDate"
                          type="date"
                          value={actionForm.dueDate}
                          onChange={(e) => setActionForm({ ...actionForm, dueDate: e.target.value })}
                        />
                      </div>
                    </div>
                  </div>
                  <DialogFooter>
                    <Button variant="outline" onClick={() => setShowAddAction(false)}>
                      Cancelar
                    </Button>
                    <Button onClick={handleAddAction} disabled={addActionMutation.isPending}>
                      {addActionMutation.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                      Adicionar
                    </Button>
                  </DialogFooter>
                </DialogContent>
              </Dialog>
            </div>
          </CardHeader>
          <CardContent>
            {loadingActions ? (
              <div className="flex justify-center py-8">
                <Loader2 className="h-6 w-6 animate-spin" />
              </div>
            ) : actions && actions.length > 0 ? (
              <div className="overflow-x-auto">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>AÃ§Ã£o EspecÃ­fica (e % de Foco)</TableHead>
                      <TableHead>Eixo de Desenvolvimento</TableHead>
                      <TableHead>MÃ©trica de Sucesso</TableHead>
                      <TableHead>ResponsÃ¡veis</TableHead>
                      <TableHead>Prazo</TableHead>
                      <TableHead>Status</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {actions.map((action) => (
                      <TableRow key={action.id}>
                        <TableCell>
                          <div>
                            <div className="font-medium">{getAxisBadge(action.axis)} {action.title}</div>
                            <div className="text-sm text-muted-foreground mt-1">{action.description}</div>
                          </div>
                        </TableCell>
                        <TableCell>
                          <Badge variant="outline">{action.developmentArea}</Badge>
                        </TableCell>
                        <TableCell className="text-sm">{action.successMetric}</TableCell>
                        <TableCell className="text-sm">{action.responsible}</TableCell>
                        <TableCell className="text-sm whitespace-nowrap">
                          {new Date(action.dueDate).toLocaleDateString("pt-BR")}
                        </TableCell>
                        <TableCell>
                          <Select
                            value={action.status}
                            onValueChange={(value: any) => handleUpdateStatus(action.id, value)}
                          >
                            <SelectTrigger className="w-[150px]">
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="nao_iniciado">NÃ£o Iniciado</SelectItem>
                              <SelectItem value="em_andamento">Em Andamento</SelectItem>
                              <SelectItem value="concluido">ConcluÃ­do</SelectItem>
                            </SelectContent>
                          </Select>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            ) : (
              <div className="text-center py-8 text-muted-foreground">
                Nenhuma aÃ§Ã£o cadastrada. Clique em "Adicionar AÃ§Ã£o" para comeÃ§ar.
              </div>
            )}
          </CardContent>
        </Card>

        {/* SeÃ§Ã£o 2: Acompanhamento e MediÃ§Ã£o (DGC) */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div>
                <CardTitle className="flex items-center gap-2">
                  <TrendingUp className="h-5 w-5" />
                  Acompanhamento e MediÃ§Ã£o (DGC)
                </CardTitle>
                <CardDescription>
                  Monitoramento do progresso atravÃ©s de mÃ©tricas claras e reuniÃµes de governanÃ§a
                </CardDescription>
              </div>
              <Dialog open={showAddReview} onOpenChange={setShowAddReview}>
                <DialogTrigger asChild>
                  <Button>
                    <Plus className="h-4 w-4 mr-2" />
                    Adicionar Feedback
                  </Button>
                </DialogTrigger>
                <DialogContent className="max-w-2xl">
                  <DialogHeader>
                    <DialogTitle>Novo Registro de Acompanhamento</DialogTitle>
                    <DialogDescription>
                      Adicione um feedback de reuniÃ£o de governanÃ§a
                    </DialogDescription>
                  </DialogHeader>
                  <div className="grid gap-4 py-4">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="grid gap-2">
                        <Label htmlFor="reviewDate">Data da ReuniÃ£o</Label>
                        <Input
                          id="reviewDate"
                          type="date"
                          value={reviewForm.reviewDate}
                          onChange={(e) => setReviewForm({ ...reviewForm, reviewDate: e.target.value })}
                        />
                      </div>
                      <div className="grid gap-2">
                        <Label htmlFor="readinessIndex">Ãndice de ProntidÃ£o (IPS - 1 a 5)</Label>
                        <Input
                          id="readinessIndex"
                          type="number"
                          min="1"
                          max="5"
                          step="0.1"
                          value={reviewForm.readinessIndex}
                          onChange={(e) => setReviewForm({ ...reviewForm, readinessIndex: parseFloat(e.target.value) })}
                        />
                      </div>
                    </div>
                    <div className="grid gap-2">
                      <Label htmlFor="keyPoints">Pontos-Chave e Feedback</Label>
                      <Textarea
                        id="keyPoints"
                        value={reviewForm.keyPoints}
                        onChange={(e) => setReviewForm({ ...reviewForm, keyPoints: e.target.value })}
                        placeholder="Principais pontos discutidos na reuniÃ£o..."
                        rows={3}
                      />
                    </div>
                    <div className="grid gap-2">
                      <Label htmlFor="strengths">Pontos Fortes Observados</Label>
                      <Textarea
                        id="strengths"
                        value={reviewForm.strengths}
                        onChange={(e) => setReviewForm({ ...reviewForm, strengths: e.target.value })}
                        placeholder="ForÃ§as identificadas..."
                        rows={2}
                      />
                    </div>
                    <div className="grid gap-2">
                      <Label htmlFor="improvements">Pontos de Melhoria</Label>
                      <Textarea
                        id="improvements"
                        value={reviewForm.improvements}
                        onChange={(e) => setReviewForm({ ...reviewForm, improvements: e.target.value })}
                        placeholder="Ãreas que precisam de atenÃ§Ã£o..."
                        rows={2}
                      />
                    </div>
                    <div className="grid gap-2">
                      <Label htmlFor="nextSteps">PrÃ³ximos Passos</Label>
                      <Textarea
                        id="nextSteps"
                        value={reviewForm.nextSteps}
                        onChange={(e) => setReviewForm({ ...reviewForm, nextSteps: e.target.value })}
                        placeholder="AÃ§Ãµes para o prÃ³ximo perÃ­odo..."
                        rows={2}
                      />
                    </div>
                  </div>
                  <DialogFooter>
                    <Button variant="outline" onClick={() => setShowAddReview(false)}>
                      Cancelar
                    </Button>
                    <Button onClick={handleAddReview} disabled={addReviewMutation.isPending}>
                      {addReviewMutation.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                      Adicionar
                    </Button>
                  </DialogFooter>
                </DialogContent>
              </Dialog>
            </div>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* GrÃ¡fico de EvoluÃ§Ã£o do IPS */}
            {ipsEvolution && ipsEvolution.length > 0 && (
              <div>
                <h3 className="text-lg font-semibold mb-4">EvoluÃ§Ã£o do Ãndice de ProntidÃ£o (IPS)</h3>
                <div className="h-[300px]">
                  <Line data={ipsChartData} options={ipsChartOptions} />
                </div>
              </div>
            )}

            {/* HistÃ³rico de ReuniÃµes */}
            <div>
              <h3 className="text-lg font-semibold mb-4">HistÃ³rico de ReuniÃµes de GovernanÃ§a</h3>
              {loadingReviews ? (
                <div className="flex justify-center py-8">
                  <Loader2 className="h-6 w-6 animate-spin" />
                </div>
              ) : reviews && reviews.length > 0 ? (
                <div className="space-y-4">
                  {reviews.map((review) => (
                    <Card key={review.id}>
                      <CardHeader>
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <Calendar className="h-5 w-5 text-muted-foreground" />
                            <div>
                              <CardTitle className="text-base">
                                {new Date(review.reviewDate).toLocaleDateString("pt-BR", {
                                  day: "2-digit",
                                  month: "long",
                                  year: "numeric",
                                })}
                              </CardTitle>
                              <CardDescription>
                                {review.reviewerName} - {review.reviewerRole.toUpperCase()}
                              </CardDescription>
                            </div>
                          </div>
                          <Badge variant="default" className="text-lg px-4 py-2">
                            IPS: {review.readinessIndex}
                          </Badge>
                        </div>
                      </CardHeader>
                      <CardContent className="space-y-3">
                        <div>
                          <p className="font-medium text-sm text-muted-foreground mb-1">Pontos-Chave:</p>
                          <p className="text-sm">{review.keyPoints}</p>
                        </div>
                        {review.strengths && (
                          <div>
                            <p className="font-medium text-sm text-muted-foreground mb-1">Pontos Fortes:</p>
                            <p className="text-sm">{review.strengths}</p>
                          </div>
                        )}
                        {review.improvements && (
                          <div>
                            <p className="font-medium text-sm text-muted-foreground mb-1">Pontos de Melhoria:</p>
                            <p className="text-sm">{review.improvements}</p>
                          </div>
                        )}
                        {review.nextSteps && (
                          <div>
                            <p className="font-medium text-sm text-muted-foreground mb-1">PrÃ³ximos Passos:</p>
                            <p className="text-sm">{review.nextSteps}</p>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-muted-foreground">
                  Nenhum feedback registrado. Clique em "Adicionar Feedback" para comeÃ§ar.
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/PDIInteligenteNovo.tsx
========================================
import { useState } from "react";
import { useLocation } from "wouter";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
} from "@/components/ui/command";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";
import { trpc } from "@/lib/trpc";
import { Brain, Check, ChevronsUpDown, ArrowLeft, Loader2 } from "lucide-react";
import { Link } from "wouter";
import { toast } from "sonner";
import { cn } from "@/lib/utils";
import RecommendationsSection from "@/components/RecommendationsSection";

/**
 * PÃ¡gina de CriaÃ§Ã£o de PDI Inteligente
 * 
 * Wizard completo para criar novo PDI Inteligente com:
 * - SeleÃ§Ã£o de colaborador (Combobox com 2.889 funcionÃ¡rios)
 * - SeleÃ§Ã£o de posiÃ§Ã£o-alvo
 * - Contexto estratÃ©gico e objetivos
 * - DuraÃ§Ã£o (12, 18, 24, 36 meses)
 * - AnÃ¡lise automÃ¡tica de gaps apÃ³s criaÃ§Ã£o
 */

export default function PDIInteligenteNovo() {
  const [, setLocation] = useLocation();

  // Form state
  const [employeeOpen, setEmployeeOpen] = useState(false);
  const [selectedEmployeeId, setSelectedEmployeeId] = useState<number | null>(null);
  const [targetPositionOpen, setTargetPositionOpen] = useState(false);
  const [selectedTargetPosition, setSelectedTargetPosition] = useState("");
  const [context, setContext] = useState("");
  const [objectives, setObjectives] = useState("");
  const [duration, setDuration] = useState("24");

  // Queries
  const { data: employees, isLoading: employeesLoading } = trpc.employees.list.useQuery();
  const { data: positions, isLoading: positionsLoading } = trpc.positions.list.useQuery();

  // Mutations
  const createPDI = trpc.pdiIntelligent.create.useMutation({
    onSuccess: (data) => {
      toast.success("PDI Inteligente criado com sucesso!");
      setLocation(`/pdi-inteligente/${data.planId}`);
    },
    onError: (error) => {
      toast.error(`Erro ao criar PDI: ${error.message}`);
    },
  });

  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    if (!selectedEmployeeId) {
      toast.error("Selecione um colaborador");
      return;
    }
    if (!selectedTargetPosition) {
      toast.error("Selecione uma posiÃ§Ã£o-alvo");
      return;
    }
    if (!context.trim()) {
      toast.error("Descreva o contexto estratÃ©gico");
      return;
    }
    if (!objectives.trim()) {
      toast.error("Descreva os objetivos de desenvolvimento");
      return;
    }

    // Buscar targetPositionId pelo tÃ­tulo
    const targetPos = positions?.find((p: any) => p.title === selectedTargetPosition);
    if (!targetPos) {
      toast.error("PosiÃ§Ã£o-alvo nÃ£o encontrada");
      return;
    }

    createPDI.mutate({
      employeeId: selectedEmployeeId,
      cycleId: 1, // TODO: Pegar ciclo atual
      targetPositionId: targetPos.id,
      startDate: new Date().toISOString(),
      endDate: new Date(Date.now() + parseInt(duration) * 30 * 24 * 60 * 60 * 1000).toISOString(),
      strategicContext: context.trim(),
      durationMonths: parseInt(duration),
    });
  };

  const selectedEmployee = employees?.find((e: any) => e.employee.id === selectedEmployeeId)?.employee;

  return (
    <DashboardLayout>
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Link href="/pdi">
            <Button variant="ghost" size="icon">
              <ArrowLeft className="h-5 w-5" />
            </Button>
          </Link>
          <div>
            <div className="flex items-center gap-2">
              <Brain className="h-6 w-6 text-primary" />
              <h1 className="text-2xl font-bold">Criar PDI Inteligente</h1>
            </div>
            <p className="text-sm text-muted-foreground">
              O sistema analisarÃ¡ automaticamente os gaps de competÃªncias e sugerirÃ¡ aÃ§Ãµes de desenvolvimento
            </p>
          </div>
        </div>

        {/* FormulÃ¡rio */}
        <form onSubmit={handleSubmit}>
          <Card>
            <CardHeader>
              <CardTitle>InformaÃ§Ãµes do PDI</CardTitle>
              <CardDescription>
                Preencha os dados para criar um novo Plano de Desenvolvimento Individual Inteligente
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Seletor de Colaborador */}
              <div className="space-y-2">
                <Label>Colaborador *</Label>
                <Popover open={employeeOpen} onOpenChange={setEmployeeOpen}>
                  <PopoverTrigger asChild>
                    <Button
                      variant="outline"
                      role="combobox"
                      aria-expanded={employeeOpen}
                      className="w-full justify-between"
                      disabled={employeesLoading}
                    >
                      {employeesLoading ? (
                        <>
                          <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                          Carregando funcionÃ¡rios...
                        </>
                      ) : selectedEmployee ? (
                        <div className="flex items-center gap-2 flex-1 text-left">
                          <div>
                            <p className="font-medium">{selectedEmployee.name}</p>
                            <p className="text-xs text-muted-foreground">
                              Colaborador selecionado
                            </p>
                          </div>
                        </div>
                      ) : (
                        "Selecione um colaborador..."
                      )}
                      <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-full p-0">
                    <Command>
                      <CommandInput placeholder="Buscar colaborador..." />
                      <CommandEmpty>Nenhum colaborador encontrado.</CommandEmpty>
                      <CommandGroup className="max-h-64 overflow-auto">
                        {employees?.map((item: any) => {
                          const employee = item.employee;
                          return (
                          <CommandItem
                            key={employee.id}
                            value={`${employee.name} ${item.position?.title || ''} ${item.department?.name || ''}`}
                            onSelect={() => {
                              setSelectedEmployeeId(employee.id);
                              setEmployeeOpen(false);
                            }}
                          >
                            <Check
                              className={cn(
                                "mr-2 h-4 w-4",
                                selectedEmployeeId === employee.id ? "opacity-100" : "opacity-0"
                              )}
                            />
                            <div>
                              <p className="font-medium">{employee.name}</p>
                              <p className="text-xs text-muted-foreground">
                                {item.position?.title || "Sem cargo"} - {item.department?.name || "Sem departamento"}
                              </p>
                            </div>
                          </CommandItem>
                        );})}
                      </CommandGroup>
                    </Command>
                  </PopoverContent>
                </Popover>
                <p className="text-xs text-muted-foreground">
                  Selecione o colaborador que receberÃ¡ o PDI Inteligente
                </p>
              </div>

              {/* RecomendaÃ§Ãµes Inteligentes */}
              {selectedEmployeeId && (
                <RecommendationsSection employeeId={selectedEmployeeId} />
              )}

              {/* PosiÃ§Ã£o-Alvo */}
              <div className="space-y-2">
                <Label>PosiÃ§Ã£o-Alvo *</Label>
                <Popover open={targetPositionOpen} onOpenChange={setTargetPositionOpen}>
                  <PopoverTrigger asChild>
                    <Button
                      variant="outline"
                      role="combobox"
                      aria-expanded={targetPositionOpen}
                      className="w-full justify-between"
                      disabled={positionsLoading}
                    >
                      {positionsLoading ? (
                        <>
                          <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                          Carregando posiÃ§Ãµes...
                        </>
                      ) : selectedTargetPosition ? (
                        selectedTargetPosition
                      ) : (
                        "Selecione uma posiÃ§Ã£o-alvo..."
                      )}
                      <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-full p-0">
                    <Command>
                      <CommandInput placeholder="Buscar posiÃ§Ã£o..." />
                      <CommandEmpty>Nenhuma posiÃ§Ã£o encontrada.</CommandEmpty>
                      <CommandGroup className="max-h-64 overflow-auto">
                        {positions?.map((position: any) => (
                          <CommandItem
                            key={position.id}
                            value={position.title}
                            onSelect={() => {
                              setSelectedTargetPosition(position.title);
                              setTargetPositionOpen(false);
                            }}
                          >
                            <Check
                              className={cn(
                                "mr-2 h-4 w-4",
                                selectedTargetPosition === position.title ? "opacity-100" : "opacity-0"
                              )}
                            />
                            {position.title}
                          </CommandItem>
                        ))}
                      </CommandGroup>
                    </Command>
                  </PopoverContent>
                </Popover>
                <p className="text-xs text-muted-foreground">
                  PosiÃ§Ã£o estratÃ©gica que o colaborador estÃ¡ sendo preparado para assumir
                </p>
              </div>

              {/* Contexto EstratÃ©gico */}
              <div className="space-y-2">
                <Label>Contexto e Desafio EstratÃ©gico *</Label>
                <Textarea
                  placeholder="Descreva o contexto estratÃ©gico, desafios e importÃ¢ncia deste desenvolvimento para a organizaÃ§Ã£o..."
                  value={context}
                  onChange={(e) => setContext(e.target.value)}
                  rows={4}
                  required
                />
                <p className="text-xs text-muted-foreground">
                  Exemplo: "PreparaÃ§Ã£o para sucessÃ£o do Diretor Comercial em funÃ§Ã£o de aposentadoria prevista para 2026. PosiÃ§Ã£o crÃ­tica para expansÃ£o regional."
                </p>
              </div>

              {/* Objetivos de Desenvolvimento */}
              <div className="space-y-2">
                <Label>Objetivos de Desenvolvimento *</Label>
                <Textarea
                  placeholder="Descreva os principais objetivos e metas de desenvolvimento para este PDI..."
                  value={objectives}
                  onChange={(e) => setObjectives(e.target.value)}
                  rows={4}
                  required
                />
                <p className="text-xs text-muted-foreground">
                  Exemplo: "Desenvolver competÃªncias de lideranÃ§a estratÃ©gica, gestÃ£o de equipes regionais e visÃ£o de negÃ³cios."
                </p>
              </div>

              {/* DuraÃ§Ã£o */}
              <div className="space-y-2">
                <Label>DuraÃ§Ã£o do PDI *</Label>
                <Select value={duration} onValueChange={setDuration}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="12">12 meses (1 ano)</SelectItem>
                    <SelectItem value="18">18 meses (1,5 anos)</SelectItem>
                    <SelectItem value="24">24 meses (2 anos) - Recomendado</SelectItem>
                    <SelectItem value="36">36 meses (3 anos)</SelectItem>
                  </SelectContent>
                </Select>
                <p className="text-xs text-muted-foreground">
                  Tempo estimado para completar o desenvolvimento (modelo Nadia recomenda 24 meses)
                </p>
              </div>

              {/* InformaÃ§Ãµes Adicionais */}
              <div className="p-4 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800">
                <h4 className="font-semibold mb-2 flex items-center gap-2">
                  <Brain className="h-4 w-4 text-blue-600" />
                  AnÃ¡lise Inteligente AutomÃ¡tica
                </h4>
                <p className="text-sm text-muted-foreground">
                  ApÃ³s a criaÃ§Ã£o, o sistema irÃ¡:
                </p>
                <ul className="text-sm text-muted-foreground mt-2 space-y-1 list-disc list-inside">
                  <li>Comparar o perfil atual do colaborador com a posiÃ§Ã£o-alvo</li>
                  <li>Analisar testes psicomÃ©tricos (DISC, Big Five, MBTI, IE)</li>
                  <li>Identificar gaps de competÃªncias automaticamente</li>
                  <li>Sugerir aÃ§Ãµes de desenvolvimento baseadas no modelo 70-20-10</li>
                  <li>Calcular prontidÃ£o e riscos do plano de sucessÃ£o</li>
                </ul>
              </div>
            </CardContent>
          </Card>

          {/* BotÃµes de AÃ§Ã£o */}
          <div className="flex items-center justify-end gap-3 mt-6">
            <Link href="/pdi">
              <Button variant="outline" type="button">
                Cancelar
              </Button>
            </Link>
            <Button type="submit" disabled={createPDI.isPending}>
              {createPDI.isPending ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Criando PDI...
                </>
              ) : (
                <>
                  <Brain className="h-4 w-4 mr-2" />
                  Criar PDI Inteligente
                </>
              )}
            </Button>
          </div>
        </form>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Perfil.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { toast } from "sonner";
import { User, Bell, Camera, History, Upload } from "lucide-react";
import { useAuth } from "@/_core/hooks/useAuth";
import FaceRegistration from "@/components/FaceRegistration";

export default function Perfil() {
  const { user } = useAuth();
  const [emailNotifications, setEmailNotifications] = useState(true);
  const [pushNotifications, setPushNotifications] = useState(true);
  const [weeklyDigest, setWeeklyDigest] = useState(false);

  const handleSaveProfile = () => {
    toast.success("Perfil atualizado com sucesso!");
  };

  const handleSaveNotifications = () => {
    toast.success("PreferÃªncias de notificaÃ§Ã£o salvas!");
  };

  const handleUploadPhoto = () => {
    toast.info("Funcionalidade de upload em desenvolvimento");
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold">Meu Perfil</h1>
          <p className="text-muted-foreground">
            Gerencie suas informaÃ§Ãµes pessoais e preferÃªncias
          </p>
        </div>

        <Tabs defaultValue="dados" className="space-y-4">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="dados">
              <User className="h-4 w-4 mr-2" />
              Dados Pessoais
            </TabsTrigger>
            <TabsTrigger value="foto">
              <Camera className="h-4 w-4 mr-2" />
              Foto e Facial
            </TabsTrigger>
            <TabsTrigger value="notificacoes">
              <Bell className="h-4 w-4 mr-2" />
              NotificaÃ§Ãµes
            </TabsTrigger>
            <TabsTrigger value="historico">
              <History className="h-4 w-4 mr-2" />
              HistÃ³rico
            </TabsTrigger>
          </TabsList>

          {/* Dados Pessoais */}
          <TabsContent value="dados" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>InformaÃ§Ãµes Pessoais</CardTitle>
                <CardDescription>
                  Atualize seus dados pessoais
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="name">Nome Completo</Label>
                  <Input id="name" defaultValue={user?.name || ""} />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="email">E-mail</Label>
                  <Input id="email" type="email" defaultValue={user?.email || ""} />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="phone">Telefone</Label>
                    <Input id="phone" placeholder="(00) 00000-0000" />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="birthdate">Data de Nascimento</Label>
                    <Input id="birthdate" type="date" />
                  </div>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="department">Departamento</Label>
                  <Input id="department" defaultValue="Recursos Humanos" disabled />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="position">Cargo</Label>
                  <Input id="position" defaultValue="Analista de RH" disabled />
                </div>
                <Button onClick={handleSaveProfile}>Salvar AlteraÃ§Ãµes</Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Foto e Reconhecimento Facial */}
          <TabsContent value="foto" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Foto de Perfil</CardTitle>
                <CardDescription>
                  Atualize sua foto de perfil
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center gap-6">
                  <Avatar className="h-24 w-24">
                    <AvatarImage src={user?.email ? `https://api.dicebear.com/7.x/initials/svg?seed=${user.name}` : undefined} />
                    <AvatarFallback className="text-2xl">
                      {user?.name?.charAt(0).toUpperCase()}
                    </AvatarFallback>
                  </Avatar>
                  <div className="space-y-2">
                    <Button onClick={handleUploadPhoto}>
                      <Upload className="h-4 w-4 mr-2" />
                      Fazer Upload
                    </Button>
                    <p className="text-sm text-muted-foreground">
                      Formatos aceitos: JPG, PNG (mÃ¡x. 2MB)
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Reconhecimento Facial</CardTitle>
                <CardDescription>
                  Configure o login por reconhecimento facial
                </CardDescription>
              </CardHeader>
              <CardContent>
                <FaceRegistration />
              </CardContent>
            </Card>
          </TabsContent>

          {/* PreferÃªncias de NotificaÃ§Ã£o */}
          <TabsContent value="notificacoes" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>PreferÃªncias de NotificaÃ§Ã£o</CardTitle>
                <CardDescription>
                  Configure como deseja receber notificaÃ§Ãµes
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label>NotificaÃ§Ãµes por E-mail</Label>
                    <p className="text-sm text-muted-foreground">
                      Receber alertas importantes por e-mail
                    </p>
                  </div>
                  <Switch checked={emailNotifications} onCheckedChange={setEmailNotifications} />
                </div>

                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label>NotificaÃ§Ãµes Push</Label>
                    <p className="text-sm text-muted-foreground">
                      Receber notificaÃ§Ãµes em tempo real no sistema
                    </p>
                  </div>
                  <Switch checked={pushNotifications} onCheckedChange={setPushNotifications} />
                </div>

                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label>Resumo Semanal</Label>
                    <p className="text-sm text-muted-foreground">
                      Receber resumo semanal de atividades
                    </p>
                  </div>
                  <Switch checked={weeklyDigest} onCheckedChange={setWeeklyDigest} />
                </div>

                <div className="pt-4 border-t">
                  <h4 className="font-medium mb-4">Tipos de NotificaÃ§Ã£o</h4>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <Label className="font-normal">Novas metas atribuÃ­das</Label>
                      <Switch defaultChecked />
                    </div>
                    <div className="flex items-center justify-between">
                      <Label className="font-normal">AvaliaÃ§Ãµes pendentes</Label>
                      <Switch defaultChecked />
                    </div>
                    <div className="flex items-center justify-between">
                      <Label className="font-normal">PDI aprovado/rejeitado</Label>
                      <Switch defaultChecked />
                    </div>
                    <div className="flex items-center justify-between">
                      <Label className="font-normal">Prazos prÃ³ximos</Label>
                      <Switch defaultChecked />
                    </div>
                    <div className="flex items-center justify-between">
                      <Label className="font-normal">Feedback recebido</Label>
                      <Switch defaultChecked />
                    </div>
                  </div>
                </div>

                <Button onClick={handleSaveNotifications}>Salvar PreferÃªncias</Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* HistÃ³rico de Atividades */}
          <TabsContent value="historico" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>HistÃ³rico de Atividades</CardTitle>
                <CardDescription>
                  Suas atividades recentes no sistema
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {[
                    { action: "Login no sistema", date: "Hoje Ã s 14:30", type: "login" },
                    { action: "AtualizaÃ§Ã£o de meta", date: "Ontem Ã s 16:45", type: "meta" },
                    { action: "AvaliaÃ§Ã£o 360Â° concluÃ­da", date: "2 dias atrÃ¡s", type: "avaliacao" },
                    { action: "PDI criado", date: "3 dias atrÃ¡s", type: "pdi" },
                    { action: "Perfil atualizado", date: "1 semana atrÃ¡s", type: "perfil" },
                  ].map((item, index) => (
                    <div key={index} className="flex items-center justify-between py-3 border-b last:border-0">
                      <div>
                        <p className="font-medium">{item.action}</p>
                        <p className="text-sm text-muted-foreground">{item.date}</p>
                      </div>
                      <div className={`h-2 w-2 rounded-full ${
                        item.type === 'login' ? 'bg-blue-500' :
                        item.type === 'meta' ? 'bg-green-500' :
                        item.type === 'avaliacao' ? 'bg-purple-500' :
                        item.type === 'pdi' ? 'bg-orange-500' :
                        'bg-gray-500'
                      }`} />
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/PerformanceIntegrada.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from "@/components/ui/select";
import { Progress } from "@/components/ui/progress";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Target, Download, ArrowLeft, Lightbulb } from "lucide-react";
import { CostCenterFilter } from "@/components/CostCenterFilter";
import { Link } from "wouter";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";

/**
 * Performance Integrada 40-30-30
 * 
 * Estrutura:
 * - Header com score total e breakdown ponderado
 * - Financial Goals (peso 40%)
 * - Behavioral Goals (peso 30%)
 * - Corporate Goals (peso 30%)
 * - GrÃ¡fico Breakdown Ponderado
 * - Performance Multi-Dimensional
 * - EvoluÃ§Ã£o HistÃ³rica
 * - RecomendaÃ§Ãµes de Desenvolvimento
 */

export default function PerformanceIntegrada() {
  const [selectedEmployee, setSelectedEmployee] = useState("1");
  const [selectedCycle, setSelectedCycle] = useState("2025");
  const [selectedCostCenter, setSelectedCostCenter] = useState<string>("all");

  // Mock data - TODO: integrar com backend
  const performanceData = {
    employee: {
      id: 1,
      name: "Maria Silva",
      position: "Gerente de Vendas",
      department: "Comercial",
    },
    cycle: "Safra 2024/2025",
    totalScore: 0, // SerÃ¡ calculado
    breakdown: {
      financial: { score: 0, weight: 40, goals: [] as any[] },
      behavioral: { score: 0, weight: 30, goals: [] as any[] },
      corporate: { score: 0, weight: 30, goals: [] as any[] },
    },
    financialGoals: [
      { name: "Receita Anual", target: 1000000, achieved: 0, weight: 50 },
      { name: "Margem de Lucro", target: 25, achieved: 0, weight: 30 },
      { name: "Novos Clientes", target: 50, achieved: 0, weight: 20 },
    ],
    behavioralGoals: [
      { name: "LideranÃ§a", score: 0, weight: 40 },
      { name: "Trabalho em Equipe", score: 0, weight: 30 },
      { name: "ComunicaÃ§Ã£o", score: 0, weight: 30 },
    ],
    corporateGoals: [
      { name: "TransformaÃ§Ã£o Digital", score: 0, weight: 50 },
      { name: "Sustentabilidade", score: 0, weight: 30 },
      { name: "Diversidade e InclusÃ£o", score: 0, weight: 20 },
    ],
  };

  // Dados para grÃ¡fico de evoluÃ§Ã£o histÃ³rica
  const historicalData = [
    { month: "Jul", score: 82 },
    { month: "Ago", score: 84 },
    { month: "Set", score: 86 },
    { month: "Out", score: 88 },
    { month: "Nov", score: 0 },
    { month: "Dez", score: 0 },
  ];

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/performance">
              <Button variant="ghost" size="icon">
                <ArrowLeft className="h-5 w-5" />
              </Button>
            </Link>
            <div>
              <div className="flex items-center gap-2">
                <Target className="h-6 w-6 text-primary" />
                <h1 className="text-2xl font-bold">Performance Integrada 40-30-30</h1>
              </div>
              <p className="text-sm text-muted-foreground">
                AvaliaÃ§Ã£o multi-dimensional de performance - UISA
              </p>
            </div>
          </div>
          <Button variant="outline">
            <Download className="h-4 w-4 mr-2" />
            Exportar
          </Button>
        </div>

        {/* Seletores */}
        <div className="flex items-center gap-4">
          <CostCenterFilter
            value={selectedCostCenter}
            onChange={setSelectedCostCenter}
          />
          
          <Select value={selectedEmployee} onValueChange={setSelectedEmployee}>
            <SelectTrigger className="w-64">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="1">Maria Silva - Gerente de Vendas</SelectItem>
              <SelectItem value="2">JoÃ£o Santos - Analista Financeiro</SelectItem>
              <SelectItem value="3">Ana Costa - Coordenadora de RH</SelectItem>
            </SelectContent>
          </Select>

          <Select value={selectedCycle} onValueChange={setSelectedCycle}>
            <SelectTrigger className="w-48">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="2025">Safra 2024/2025</SelectItem>
              <SelectItem value="2024">Safra 2023/2024</SelectItem>
              <SelectItem value="2023">Safra 2022/2023</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* Score Total */}
        <Card className="bg-gradient-to-r from-blue-500 to-blue-600 text-white">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm opacity-90 mb-2">Score Total de Performance</p>
                <div className="flex items-baseline gap-2">
                  <span className="text-6xl font-bold">{performanceData.totalScore}</span>
                  <span className="text-2xl opacity-90">/ 100 pontos possÃ­veis</span>
                </div>
                <p className="text-sm opacity-90 mt-2">{performanceData.totalScore}% Total</p>
              </div>
              <div className="text-right">
                <p className="text-sm opacity-90 mb-2">{performanceData.cycle}</p>
                <Badge className="bg-white text-blue-600">
                  {performanceData.employee.department}
                </Badge>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Breakdown Ponderado */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Target className="h-5 w-5" />
              Breakdown Ponderado
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-6">
              <div>
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <div className="h-3 w-3 rounded-full bg-green-500" />
                    <span className="font-semibold">Financial Goals</span>
                    <Badge variant="outline">Peso: 40%</Badge>
                  </div>
                  <span className="text-2xl font-bold">
                    {performanceData.breakdown.financial.score} pontos
                  </span>
                </div>
                <Progress value={performanceData.breakdown.financial.score} className="h-3" />
                <p className="text-xs text-muted-foreground mt-1">de 100 pontos</p>
              </div>

              <div>
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <div className="h-3 w-3 rounded-full bg-purple-500" />
                    <span className="font-semibold">Behavioral Goals</span>
                    <Badge variant="outline">Peso: 30%</Badge>
                  </div>
                  <span className="text-2xl font-bold">
                    {performanceData.breakdown.behavioral.score} pontos
                  </span>
                </div>
                <Progress value={performanceData.breakdown.behavioral.score} className="h-3" />
                <p className="text-xs text-muted-foreground mt-1">de 100 pontos</p>
              </div>

              <div>
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <div className="h-3 w-3 rounded-full bg-blue-500" />
                    <span className="font-semibold">Corporate Goals</span>
                    <Badge variant="outline">Peso: 30%</Badge>
                  </div>
                  <span className="text-2xl font-bold">
                    {performanceData.breakdown.corporate.score} pontos
                  </span>
                </div>
                <Progress value={performanceData.breakdown.corporate.score} className="h-3" />
                <p className="text-xs text-muted-foreground mt-1">de 100 pontos</p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Tabs: Metas Detalhadas */}
        <Tabs defaultValue="financial" className="space-y-6">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="financial">Financial (40%)</TabsTrigger>
            <TabsTrigger value="behavioral">Behavioral (30%)</TabsTrigger>
            <TabsTrigger value="corporate">Corporate (30%)</TabsTrigger>
          </TabsList>

          {/* Financial Goals */}
          <TabsContent value="financial">
            <Card>
              <CardHeader>
                <CardTitle>Financial Goals - Peso 40%</CardTitle>
                <p className="text-sm text-muted-foreground">
                  Metas financeiras e de resultados quantitativos
                </p>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {performanceData.financialGoals.map((goal, idx) => (
                    <div key={idx} className="p-4 rounded-lg border">
                      <div className="flex items-center justify-between mb-3">
                        <div>
                          <h4 className="font-semibold">{goal.name}</h4>
                          <p className="text-sm text-muted-foreground">Peso: {goal.weight}%</p>
                        </div>
                        <Badge variant="outline">0 metas Harvest</Badge>
                      </div>
                      <div className="grid grid-cols-2 gap-4 mb-3">
                        <div>
                          <p className="text-xs text-muted-foreground">Meta</p>
                          <p className="text-lg font-semibold">
                            {goal.target.toLocaleString("pt-BR")}
                          </p>
                        </div>
                        <div>
                          <p className="text-xs text-muted-foreground">AlcanÃ§ado</p>
                          <p className="text-lg font-semibold">
                            {goal.achieved.toLocaleString("pt-BR")}
                          </p>
                        </div>
                      </div>
                      <Progress value={0} className="h-2" />
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Behavioral Goals */}
          <TabsContent value="behavioral">
            <Card>
              <CardHeader>
                <CardTitle>Behavioral Goals - Peso 30%</CardTitle>
                <p className="text-sm text-muted-foreground">
                  CompetÃªncias comportamentais e soft skills
                </p>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {performanceData.behavioralGoals.map((goal, idx) => (
                    <div key={idx} className="p-4 rounded-lg border">
                      <div className="flex items-center justify-between mb-3">
                        <div>
                          <h4 className="font-semibold">{goal.name}</h4>
                          <p className="text-sm text-muted-foreground">Peso: {goal.weight}%</p>
                        </div>
                        <Badge variant="outline">0 competÃªncias</Badge>
                      </div>
                      <div className="mb-3">
                        <p className="text-xs text-muted-foreground">Score</p>
                        <p className="text-2xl font-bold">{goal.score}/100</p>
                      </div>
                      <Progress value={goal.score} className="h-2" />
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Corporate Goals */}
          <TabsContent value="corporate">
            <Card>
              <CardHeader>
                <CardTitle>Corporate Goals - Peso 30%</CardTitle>
                <p className="text-sm text-muted-foreground">
                  Metas estratÃ©gicas corporativas
                </p>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {performanceData.corporateGoals.map((goal, idx) => (
                    <div key={idx} className="p-4 rounded-lg border">
                      <div className="flex items-center justify-between mb-3">
                        <div>
                          <h4 className="font-semibold">{goal.name}</h4>
                          <p className="text-sm text-muted-foreground">Peso: {goal.weight}%</p>
                        </div>
                        <Badge variant="outline">0 metas estratÃ©gicas</Badge>
                      </div>
                      <div className="mb-3">
                        <p className="text-xs text-muted-foreground">Score</p>
                        <p className="text-2xl font-bold">{goal.score}/100</p>
                      </div>
                      <Progress value={goal.score} className="h-2" />
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* EvoluÃ§Ã£o HistÃ³rica */}
        <Card>
          <CardHeader>
            <CardTitle>EvoluÃ§Ã£o HistÃ³rica</CardTitle>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={historicalData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="month" />
                <YAxis domain={[0, 100]} />
                <Tooltip />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="score"
                  stroke="hsl(var(--primary))"
                  strokeWidth={2}
                  name="Performance MÃ©dia (%)"
                />
              </LineChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* RecomendaÃ§Ãµes de Desenvolvimento */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Lightbulb className="h-5 w-5 text-yellow-500" />
              RecomendaÃ§Ãµes de Desenvolvimento
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              <div className="p-4 rounded-lg border-l-4 border-l-blue-500 bg-blue-50">
                <p className="font-semibold mb-1">Aguardando avaliaÃ§Ã£o</p>
                <p className="text-sm text-muted-foreground">
                  Complete as metas para receber recomendaÃ§Ãµes personalizadas de desenvolvimento
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/PesquisasPulse.tsx
========================================
import { useState } from "react";
import { Link } from "wouter";
import { trpc } from "@/lib/trpc";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Plus, Send, BarChart3, Users, TrendingUp, MessageSquare } from "lucide-react";
import { toast } from "sonner";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";

interface PulseSurvey {
  id: number;
  title: string;
  question: string;
  status: "draft" | "active" | "closed";
  responses: number;
  totalEmployees: number;
  avgScore: number;
  createdAt: string;
}

export default function PesquisasPulse() {
  const { data: surveys = [], isLoading } = trpc.pulse.list.useQuery();
  const createSurveyMutation = trpc.pulse.create.useMutation({
    onSuccess: () => {
      toast.success("Pesquisa criada e enviada com sucesso!");
      setShowForm(false);
    },
    onError: (error) => {
      toast.error(error.message);
    },
  });

  const [surveys_mock] = useState<PulseSurvey[]>([
    {
      id: 1,
      title: "SatisfaÃ§Ã£o com Ambiente de Trabalho",
      question: "Como vocÃª avalia o ambiente de trabalho da empresa?",
      status: "active",
      responses: 45,
      totalEmployees: 50,
      avgScore: 8.5,
      createdAt: "2025-11-15",
    },
    {
      id: 2,
      title: "ComunicaÃ§Ã£o Interna",
      question: "A comunicaÃ§Ã£o entre as Ã¡reas Ã© eficiente?",
      status: "active",
      responses: 38,
      totalEmployees: 50,
      avgScore: 7.2,
      createdAt: "2025-11-10",
    },
    {
      id: 3,
      title: "Reconhecimento e ValorizaÃ§Ã£o",
      question: "VocÃª se sente reconhecido pelo seu trabalho?",
      status: "closed",
      responses: 50,
      totalEmployees: 50,
      avgScore: 6.8,
      createdAt: "2025-11-01",
    },
  ]);

  const [showForm, setShowForm] = useState(false);

  const handleCreateSurvey = () => {
    setShowForm(true);
  };

  const handleSaveSurvey = () => {
    // TODO: Implementar formulÃ¡rio completo com tÃ­tulo e pergunta
    createSurveyMutation.mutate({
      title: "Nova Pesquisa",
      question: "Como vocÃª avalia?",
    });
  };

  const getStatusBadge = (status: string) => {
    const colors: Record<string, string> = {
      draft: "bg-gray-500",
      active: "bg-green-500",
      closed: "bg-blue-500",
    };
    const labels: Record<string, string> = {
      draft: "Rascunho",
      active: "Ativa",
      closed: "Encerrada",
    };
    return <Badge className={colors[status]}>{labels[status]}</Badge>;
  };

  // Dados para o grÃ¡fico de tendÃªncia
  const trendData = [
    { month: "Jul", score: 7.5 },
    { month: "Ago", score: 7.8 },
    { month: "Set", score: 7.2 },
    { month: "Out", score: 7.9 },
    { month: "Nov", score: 8.1 },
  ];

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">Pesquisas de Pulse</h1>
            <p className="text-muted-foreground">
              MeÃ§a o engajamento e satisfaÃ§Ã£o da equipe em tempo real
            </p>
          </div>
          <Button onClick={handleCreateSurvey}>
            <Plus className="mr-2 h-4 w-4" />
            Nova Pesquisa
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid gap-4 md:grid-cols-4">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Pesquisas Ativas</CardTitle>
              <MessageSquare className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {surveys.filter((s) => s.status === "active").length}
              </div>
              <p className="text-xs text-muted-foreground">
                {surveys.length} total
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Taxa de Resposta</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {Math.round(
                  (surveys.reduce((acc, s) => acc + s.responses, 0) /
                    surveys.reduce((acc, s) => acc + s.totalEmployees, 0)) *
                    100
                )}
                %
              </div>
              <p className="text-xs text-muted-foreground">MÃ©dia geral</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">SatisfaÃ§Ã£o MÃ©dia</CardTitle>
              <BarChart3 className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {(surveys.reduce((acc, s) => acc + s.avgScore, 0) / surveys.length).toFixed(1)}
              </div>
              <p className="text-xs text-muted-foreground">Escala de 0 a 10</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">TendÃªncia</CardTitle>
              <TrendingUp className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-green-600">+0.6</div>
              <p className="text-xs text-muted-foreground">vs mÃªs anterior</p>
            </CardContent>
          </Card>
        </div>

        {/* GrÃ¡fico de TendÃªncia */}
        <Card>
          <CardHeader>
            <CardTitle>TendÃªncia de SatisfaÃ§Ã£o</CardTitle>
            <CardDescription>EvoluÃ§Ã£o da satisfaÃ§Ã£o nos Ãºltimos 5 meses</CardDescription>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={trendData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="month" />
                <YAxis domain={[0, 10]} />
                <Tooltip />
                <Legend />
                <Bar dataKey="score" fill="#f97316" name="SatisfaÃ§Ã£o MÃ©dia" />
              </BarChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* FormulÃ¡rio de Nova Pesquisa */}
        {showForm && (
          <Card>
            <CardHeader>
              <CardTitle>Nova Pesquisa de Pulse</CardTitle>
              <CardDescription>Crie uma pergunta rÃ¡pida para medir o clima organizacional</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="title">TÃ­tulo da Pesquisa</Label>
                <Input id="title" placeholder="Ex: SatisfaÃ§Ã£o com Ambiente de Trabalho" />
              </div>

              <div className="space-y-2">
                <Label htmlFor="question">Pergunta</Label>
                <Textarea
                  id="question"
                  placeholder="Ex: Como vocÃª avalia o ambiente de trabalho da empresa?"
                  rows={3}
                />
              </div>

              <div className="flex justify-end gap-2">
                <Button variant="outline" onClick={() => setShowForm(false)}>
                  Cancelar
                </Button>
                <Button onClick={handleSaveSurvey}>
                  <Send className="mr-2 h-4 w-4" />
                  Criar e Enviar
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Tabela de Pesquisas */}
        <Card>
          <CardHeader>
            <CardTitle>Pesquisas Recentes</CardTitle>
            <CardDescription>Acompanhe o status e resultados das pesquisas</CardDescription>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>TÃ­tulo</TableHead>
                  <TableHead>Pergunta</TableHead>
                  <TableHead>Status</TableHead>
                  <TableHead>Respostas</TableHead>
                  <TableHead>Nota MÃ©dia</TableHead>
                  <TableHead>Data</TableHead>
                  <TableHead>AÃ§Ãµes</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {surveys.map((survey) => (
                  <TableRow key={survey.id}>
                    <TableCell className="font-medium">{survey.title}</TableCell>
                    <TableCell className="max-w-xs truncate">{survey.question}</TableCell>
                    <TableCell>{getStatusBadge(survey.status)}</TableCell>
                    <TableCell>
                      <div className="space-y-1">
                        <div className="text-sm">
                          {survey.responses}/{survey.totalEmployees}
                        </div>
                        <Progress
                          value={(survey.responses / survey.totalEmployees) * 100}
                          className="h-2"
                        />
                      </div>
                    </TableCell>
                    <TableCell>
                      <div className="flex items-center gap-2">
                        <span className="text-lg font-bold">{survey.avgScore.toFixed(1)}</span>
                        <span className="text-sm text-muted-foreground">/10</span>
                      </div>
                    </TableCell>
                    <TableCell>{new Date(survey.createdAt).toLocaleDateString("pt-BR")}</TableCell>
                    <TableCell>
                      <Link href={`/pesquisas-pulse/resultados/${survey.id}`}>
                        <Button variant="outline" size="sm">
                          Ver Resultados
                        </Button>
                      </Link>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/PsychometricTests.tsx
========================================
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Loader2, Brain, TrendingUp, Users, Target, Zap } from "lucide-react";
import { useLocation } from "wouter";
import { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer } from "recharts";

/**
 * PÃ¡gina de Testes PsicomÃ©tricos
 * Exibe testes disponÃ­veis e resultados anteriores
 */

const DISC_LABELS: Record<string, { name: string; color: string; description: string }> = {
  D: { name: "DominÃ¢ncia", color: "bg-red-500", description: "Direto, orientado a resultados, decisivo" },
  I: { name: "InfluÃªncia", color: "bg-yellow-500", description: "SociÃ¡vel, entusiasta, persuasivo" },
  S: { name: "Estabilidade", color: "bg-green-500", description: "Paciente, leal, colaborativo" },
  C: { name: "Conformidade", color: "bg-blue-500", description: "AnalÃ­tico, preciso, sistemÃ¡tico" },
};

const BIG_FIVE_LABELS: Record<string, { name: string; description: string }> = {
  O: { name: "Abertura", description: "Criatividade e curiosidade intelectual" },
  C: { name: "Conscienciosidade", description: "OrganizaÃ§Ã£o e responsabilidade" },
  E: { name: "ExtroversÃ£o", description: "Sociabilidade e energia" },
  A: { name: "Amabilidade", description: "Empatia e cooperaÃ§Ã£o" },
  N: { name: "Neuroticismo", description: "Estabilidade emocional" },
};

export default function PsychometricTests() {
  const { user } = useAuth();
  const [, setLocation] = useLocation();

  // Buscar testes realizados
  const { data: tests, isLoading } = trpc.psychometric.getTests.useQuery();

  const discTests = tests?.filter(t => t.testType === "disc") || [];
  const bigFiveTests = tests?.filter(t => t.testType === "bigfive") || [];
  const mbtiTests = tests?.filter(t => t.testType === "mbti") || [];
  const ieTests = tests?.filter(t => t.testType === "ie") || [];
  const varkTests = tests?.filter(t => t.testType === "vark") || [];

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
            <Brain className="h-8 w-8" />
            Testes PsicomÃ©tricos
          </h1>
          <p className="text-muted-foreground mt-2">
            ConheÃ§a seu perfil comportamental e de personalidade
          </p>
        </div>

        {/* Testes DisponÃ­veis */}
        <div className="grid md:grid-cols-2 gap-6">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Target className="h-5 w-5" />
                Teste DISC
              </CardTitle>
              <CardDescription>
                Avalia seu estilo comportamental em 4 dimensÃµes: DominÃ¢ncia, InfluÃªncia, Estabilidade e Conformidade
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">40 perguntas Â· 10 minutos</span>
                {discTests.length > 0 && (
                  <Badge variant="secondary">Realizado {discTests.length}x</Badge>
                )}
              </div>
              <Button
                className="w-full"
                onClick={() => setLocation("/teste-disc")}
              >
                {discTests.length > 0 ? "Refazer Teste" : "Iniciar Teste"}
              </Button>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Zap className="h-5 w-5" />
                Teste Big Five (OCEAN)
              </CardTitle>
              <CardDescription>
                Avalia sua personalidade em 5 dimensÃµes: Abertura, Conscienciosidade, ExtroversÃ£o, Amabilidade e Neuroticismo
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">50 perguntas Â· 12 minutos</span>
                {bigFiveTests.length > 0 && (
                  <Badge variant="secondary">Realizado {bigFiveTests.length}x</Badge>
                )}
              </div>
              <Button
                className="w-full"
                onClick={() => setLocation("/teste-bigfive")}
              >
                {bigFiveTests.length > 0 ? "Refazer Teste" : "Iniciar Teste"}
              </Button>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Users className="h-5 w-5" />
                Teste MBTI
              </CardTitle>
              <CardDescription>
                Identifica seu tipo de personalidade entre os 16 tipos do Myers-Briggs Type Indicator
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">20 perguntas Â· 8 minutos</span>
                {mbtiTests.length > 0 && (
                  <Badge variant="secondary">Realizado {mbtiTests.length}x</Badge>
                )}
              </div>
              <Button
                className="w-full"
                onClick={() => setLocation("/teste-mbti")}
              >
                {mbtiTests.length > 0 ? "Refazer Teste" : "Iniciar Teste"}
              </Button>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Brain className="h-5 w-5" />
                InteligÃªncia Emocional
              </CardTitle>
              <CardDescription>
                Avalia suas competÃªncias emocionais baseadas no modelo de Daniel Goleman
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">25 perguntas Â· 10 minutos</span>
                {ieTests.length > 0 && (
                  <Badge variant="secondary">Realizado {ieTests.length}x</Badge>
                )}
              </div>
              <Button
                className="w-full"
                onClick={() => setLocation("/teste-ie")}
              >
                {ieTests.length > 0 ? "Refazer Teste" : "Iniciar Teste"}
              </Button>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingUp className="h-5 w-5" />
                Estilos de Aprendizagem (VARK)
              </CardTitle>
              <CardDescription>
                Identifica seu estilo preferido: Visual, Auditivo, Leitura/Escrita ou CinestÃ©sico
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">20 perguntas Â· 8 minutos</span>
                {varkTests.length > 0 && (
                  <Badge variant="secondary">Realizado {varkTests.length}x</Badge>
                )}
              </div>
              <Button
                className="w-full"
                onClick={() => setLocation("/teste-vark")}
              >
                {varkTests.length > 0 ? "Refazer Teste" : "Iniciar Teste"}
              </Button>
            </CardContent>
          </Card>

          <Card className="border-purple-200 bg-gradient-to-br from-purple-50 to-blue-50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Users className="h-5 w-5 text-purple-600" />
                Estilos de LideranÃ§a
              </CardTitle>
              <CardDescription>
                Identifica seus estilos de lideranÃ§a predominantes baseado em Lewin, Bass e Goleman
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">30 perguntas Â· 10 minutos</span>
                <Badge variant="secondary" className="bg-purple-100 text-purple-700">Novo</Badge>
              </div>
              <Button
                className="w-full bg-purple-600 hover:bg-purple-700"
                onClick={() => setLocation("/teste-lideranca")}
              >
                Iniciar Teste
              </Button>
            </CardContent>
          </Card>

          <Card className="border-teal-200 bg-gradient-to-br from-teal-50 to-cyan-50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Target className="h-5 w-5 text-teal-600" />
                Ã‚ncoras de Carreira
              </CardTitle>
              <CardDescription>
                Identifica suas motivaÃ§Ãµes profissionais segundo Edgar Schein
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">40 perguntas Â· 12 minutos</span>
                <Badge variant="secondary" className="bg-teal-100 text-teal-700">Novo</Badge>
              </div>
              <Button
                className="w-full bg-teal-600 hover:bg-teal-700"
                onClick={() => setLocation("/teste-ancoras-carreira")}
              >
                Iniciar Teste
              </Button>
            </CardContent>
          </Card>
        </div>

        {/* Resultados DISC */}
        {discTests.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle>Resultado DISC Mais Recente</CardTitle>
              <CardDescription>
                Realizado em {new Date(discTests[0].completedAt).toLocaleDateString("pt-BR")}
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="grid md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <div>
                    <h3 className="font-semibold mb-2">Perfil Dominante</h3>
                    {discTests[0].discProfile && (
                      <div className="flex items-center gap-2">
                        <Badge className={DISC_LABELS[discTests[0].discProfile]?.color}>
                          {DISC_LABELS[discTests[0].discProfile]?.name}
                        </Badge>
                        <span className="text-sm text-muted-foreground">
                          {DISC_LABELS[discTests[0].discProfile]?.description}
                        </span>
                      </div>
                    )}
                  </div>

                  <div className="space-y-3">
                    <h3 className="font-semibold">Scores por DimensÃ£o</h3>
                    {discTests[0].profile && Object.entries(discTests[0].profile).map(([key, value]) => {
                      if (key === "dominantProfile") return null;
                      const label = DISC_LABELS[key];
                      if (!label) return null;
                      
                      return (
                        <div key={key} className="space-y-1">
                          <div className="flex justify-between text-sm">
                            <span>{label.name}</span>
                            <span className="font-semibold">{((value as number) * 20).toFixed(0)}%</span>
                          </div>
                          <div className="h-2 bg-muted rounded-full overflow-hidden">
                            <div
                              className={`h-full ${label.color}`}
                              style={{ width: `${(value as number) * 20}%` }}
                            />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                <div>
                  <h3 className="font-semibold mb-4">GrÃ¡fico Radar</h3>
                  <ResponsiveContainer width="100%" height={250}>
                    <RadarChart data={[
                      { dimension: "D", value: discTests[0].discDominance || 0 },
                      { dimension: "I", value: discTests[0].discInfluence || 0 },
                      { dimension: "S", value: discTests[0].discSteadiness || 0 },
                      { dimension: "C", value: discTests[0].discCompliance || 0 },
                    ]}>
                      <PolarGrid />
                      <PolarAngleAxis dataKey="dimension" />
                      <PolarRadiusAxis domain={[0, 100]} />
                      <Radar
                        name="DISC"
                        dataKey="value"
                        stroke="hsl(var(--primary))"
                        fill="hsl(var(--primary))"
                        fillOpacity={0.6}
                      />
                    </RadarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Resultados Big Five */}
        {bigFiveTests.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle>Resultado Big Five Mais Recente</CardTitle>
              <CardDescription>
                Realizado em {new Date(bigFiveTests[0].completedAt).toLocaleDateString("pt-BR")}
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="grid md:grid-cols-2 gap-6">
                <div className="space-y-3">
                  <h3 className="font-semibold">Scores por DimensÃ£o (OCEAN)</h3>
                  {bigFiveTests[0].profile && Object.entries(bigFiveTests[0].profile).map(([key, value]) => {
                    const label = BIG_FIVE_LABELS[key];
                    if (!label) return null;
                    
                    return (
                      <div key={key} className="space-y-1">
                        <div className="flex justify-between text-sm">
                          <span>{label.name}</span>
                          <span className="font-semibold">{((value as number) * 20).toFixed(0)}%</span>
                        </div>
                        <div className="h-2 bg-muted rounded-full overflow-hidden">
                          <div
                            className="h-full bg-primary"
                            style={{ width: `${(value as number) * 20}%` }}
                          />
                        </div>
                        <p className="text-xs text-muted-foreground">{label.description}</p>
                      </div>
                    );
                  })}
                </div>

                <div>
                  <h3 className="font-semibold mb-4">GrÃ¡fico Radar</h3>
                  <ResponsiveContainer width="100%" height={300}>
                    <RadarChart data={[
                      { dimension: "Abertura", value: bigFiveTests[0].bigFiveOpenness || 0 },
                      { dimension: "Conscienciosidade", value: bigFiveTests[0].bigFiveConscientiousness || 0 },
                      { dimension: "ExtroversÃ£o", value: bigFiveTests[0].bigFiveExtraversion || 0 },
                      { dimension: "Amabilidade", value: bigFiveTests[0].bigFiveAgreeableness || 0 },
                      { dimension: "Neuroticismo", value: bigFiveTests[0].bigFiveNeuroticism || 0 },
                    ]}>
                      <PolarGrid />
                      <PolarAngleAxis dataKey="dimension" />
                      <PolarRadiusAxis domain={[0, 100]} />
                      <Radar
                        name="Big Five"
                        dataKey="value"
                        stroke="hsl(var(--primary))"
                        fill="hsl(var(--primary))"
                        fillOpacity={0.6}
                      />
                    </RadarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Mensagem se nÃ£o houver testes */}
        {tests && tests.length === 0 && (
          <Card>
            <CardContent className="py-12 text-center">
              <Brain className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
              <h3 className="text-lg font-semibold mb-2">Nenhum teste realizado</h3>
              <p className="text-muted-foreground mb-4">
                Comece realizando um dos testes acima para conhecer seu perfil
              </p>
            </CardContent>
          </Card>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/RankingGamificacao.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Trophy, Medal, Award, TrendingUp, Star } from "lucide-react";
import { useAuth } from "@/_core/hooks/useAuth";

/**
 * PÃ¡gina de Ranking de GamificaÃ§Ã£o
 * Exibe rankings gerais, mensais e por departamento
 */
export default function RankingGamificacao() {
  const { user } = useAuth();
  const [selectedDepartment, setSelectedDepartment] = useState<number | undefined>();
  const [rankingType, setRankingType] = useState<"geral" | "mensal">("geral");

  // Queries
  const { data: ranking, isLoading } = trpc.gamification.getRanking.useQuery({
    limit: 50,
    departmentId: selectedDepartment,
  });

  const { data: monthlyRanking } = trpc.gamification.getMonthlyRanking.useQuery({
    limit: 10,
  });

  const { data: departments } = trpc.departments.list.useQuery();
  const { data: levels } = trpc.gamification.getLevels.useQuery();
  const { data: myStats } = trpc.gamification.getEmployeeStats.useQuery(
    { employeeId: user?.id || 0 },
    { enabled: !!user?.id }
  );

  const getMedalIcon = (rank: number) => {
    switch (rank) {
      case 1:
        return <Trophy className="w-6 h-6 text-yellow-500" />;
      case 2:
        return <Medal className="w-6 h-6 text-gray-400" />;
      case 3:
        return <Medal className="w-6 h-6 text-amber-600" />;
      default:
        return <span className="w-6 h-6 flex items-center justify-center font-bold text-gray-500">{rank}</span>;
    }
  };

  const getLevelColor = (level: string) => {
    switch (level) {
      case "Platina":
        return "bg-gradient-to-r from-cyan-500 to-blue-500 text-white";
      case "Ouro":
        return "bg-gradient-to-r from-yellow-400 to-yellow-600 text-white";
      case "Prata":
        return "bg-gradient-to-r from-gray-300 to-gray-500 text-white";
      default:
        return "bg-gradient-to-r from-amber-700 to-amber-900 text-white";
    }
  };

  const displayRanking = rankingType === "geral" ? ranking : monthlyRanking;

  return (
    <div className="container mx-auto py-6 space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold flex items-center gap-3">
          <Trophy className="w-8 h-8 text-[#F39200]" />
          Ranking de GamificaÃ§Ã£o
        </h1>
        <p className="text-gray-600 mt-2">
          Acompanhe os melhores colaboradores e sua posiÃ§Ã£o no ranking
        </p>
      </div>

      {/* Minhas EstatÃ­sticas */}
      {myStats && (
        <Card className="border-[#F39200] border-2">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Star className="w-5 h-5 text-[#F39200]" />
              Minhas EstatÃ­sticas
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <p className="text-sm text-gray-600 mb-1">Pontos Totais</p>
                <p className="text-2xl font-bold text-[#F39200]">{myStats.points}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600 mb-1">NÃ­vel Atual</p>
                <Badge className={getLevelColor(myStats.level)}>{myStats.level}</Badge>
              </div>
              <div>
                <p className="text-sm text-gray-600 mb-1">Badges Conquistados</p>
                <p className="text-2xl font-bold">{myStats.badges}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600 mb-1">Progresso para PrÃ³ximo NÃ­vel</p>
                <div className="flex items-center gap-2">
                  <div className="flex-1 bg-gray-200 rounded-full h-2">
                    <div
                      className="bg-[#F39200] h-2 rounded-full transition-all"
                      style={{ width: `${myStats.progressToNextLevel}%` }}
                    />
                  </div>
                  <span className="text-sm font-medium">{Math.round(myStats.progressToNextLevel)}%</span>
                </div>
                <p className="text-xs text-gray-500 mt-1">
                  Faltam {myStats.pointsToNextLevel} pontos
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Filtros */}
      <div className="flex flex-wrap gap-4">
        <Select value={rankingType} onValueChange={(v: any) => setRankingType(v)}>
          <SelectTrigger className="w-[200px]">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="geral">Ranking Geral</SelectItem>
            <SelectItem value="mensal">Ranking Mensal</SelectItem>
          </SelectContent>
        </Select>

        {rankingType === "geral" && (
          <Select
            value={selectedDepartment?.toString() || "all"}
            onValueChange={(v) => setSelectedDepartment(v === "all" ? undefined : Number(v))}
          >
            <SelectTrigger className="w-[250px]">
              <SelectValue placeholder="Todos os departamentos" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todos os departamentos</SelectItem>
              {departments?.map((dept) => (
                <SelectItem key={dept.id} value={dept.id.toString()}>
                  {dept.name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        )}
      </div>

      {/* Tabela de NÃ­veis */}
      <Card>
        <CardHeader>
          <CardTitle>NÃ­veis de GamificaÃ§Ã£o</CardTitle>
          <CardDescription>Conquiste pontos e suba de nÃ­vel</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {levels?.map((level) => (
              <div
                key={level.name}
                className={`p-4 rounded-lg ${getLevelColor(level.name)}`}
              >
                <h3 className="font-bold text-lg mb-2">{level.name}</h3>
                <p className="text-sm opacity-90">
                  {level.minPoints} - {level.maxPoints === Infinity ? "âˆž" : level.maxPoints} pontos
                </p>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Ranking */}
      <Card>
        <CardHeader>
          <CardTitle>
            {rankingType === "geral" ? "Ranking Geral" : "Ranking do MÃªs"}
          </CardTitle>
          <CardDescription>
            {rankingType === "geral"
              ? "Top 50 colaboradores com mais pontos"
              : "Top 10 colaboradores do mÃªs atual"}
          </CardDescription>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="text-center py-12 text-gray-500">Carregando...</div>
          ) : displayRanking && displayRanking.length > 0 ? (
            <div className="space-y-3">
              {displayRanking.map((item) => (
                <div
                  key={item.employee.id}
                  className={`flex items-center gap-4 p-4 rounded-lg border transition-all hover:shadow-md ${
                    item.rank <= 3 ? "bg-gradient-to-r from-yellow-50 to-orange-50 border-[#F39200]" : "bg-gray-50"
                  }`}
                >
                  {/* PosiÃ§Ã£o */}
                  <div className="flex-shrink-0 w-12 flex justify-center">
                    {getMedalIcon(item.rank)}
                  </div>

                  {/* InformaÃ§Ãµes do Colaborador */}
                  <div className="flex-1">
                    <h3 className="font-semibold text-lg">{item.employee.name}</h3>
                    <p className="text-sm text-gray-600">
                      {item.position?.title || "Cargo nÃ£o definido"} â€¢{" "}
                      {item.department?.name || "Departamento nÃ£o definido"}
                    </p>
                  </div>

                  {/* NÃ­vel */}
                  <div className="flex-shrink-0">
                    <Badge className={getLevelColor(item.employee.gamificationLevel || "Bronze")}>
                      {item.employee.gamificationLevel || "Bronze"}
                    </Badge>
                  </div>

                  {/* Pontos */}
                  <div className="flex-shrink-0 text-right">
                    <p className="text-2xl font-bold text-[#F39200]">
                      {item.employee.gamificationPoints || 0}
                    </p>
                    <p className="text-xs text-gray-500">pontos</p>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-12 text-gray-500">
              Nenhum colaborador no ranking ainda
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/Relatorios.tsx
========================================
import DashboardLayout from "@/components/DashboardLayout";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { trpc } from "@/lib/trpc";
import { exportDashboardPDF } from "@/utils/pdfExport";
import { BarChart3, Download, FileText, TrendingUp, Users } from "lucide-react";
import { useState } from "react";

export default function Relatorios() {
  const [selectedPeriod, setSelectedPeriod] = useState("2025");
  const [selectedDepartment, setSelectedDepartment] = useState("all");

  const { data: goals } = trpc.goals.list.useQuery({});
  const { data: evaluations } = trpc.evaluations.list.useQuery({});
  const { data: pdis } = trpc.pdi.list.useQuery({});
  const { data: employeesData } = trpc.employees.list.useQuery();

  // Calculate statistics
  const totalGoals = goals?.length || 0;
  const completedGoals = goals?.filter(g => g.status === "concluida").length || 0;
  const avgGoalProgress = goals?.length 
    ? Math.round(goals.reduce((sum, g) => sum + g.progress, 0) / goals.length)
    : 0;

  const totalEvaluations = evaluations?.length || 0;
  const completedEvaluations = evaluations?.filter(e => e.status === "concluida").length || 0;

  const totalPDIs = pdis?.length || 0;
  const activePDIs = pdis?.filter(p => p.status === "aprovado" || p.status === "em_andamento").length || 0;

  const totalEmployees = employeesData?.length || 0;

  // Mock data for charts (in production, this would come from API)
  const monthlyGoalsData = [
    { month: "Jan", completed: 12, total: 15 },
    { month: "Fev", completed: 18, total: 20 },
    { month: "Mar", completed: 22, total: 25 },
    { month: "Abr", completed: 28, total: 30 },
    { month: "Mai", completed: 25, total: 28 },
    { month: "Jun", completed: 30, total: 32 },
  ];

  const departmentPerformance = [
    { name: "Vendas", score: 8.5, employees: 25 },
    { name: "Marketing", score: 7.8, employees: 15 },
    { name: "TI", score: 9.2, employees: 30 },
    { name: "RH", score: 8.1, employees: 12 },
    { name: "Financeiro", score: 8.7, employees: 18 },
  ];

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <BarChart3 className="h-8 w-8" />
              RelatÃ³rios e AnÃ¡lises
            </h1>
            <p className="text-muted-foreground mt-2">
              Acompanhe indicadores e tendÃªncias de desempenho
            </p>
          </div>
          <div className="flex gap-2">
            <Select value={selectedPeriod} onValueChange={setSelectedPeriod}>
              <SelectTrigger className="w-[150px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="2025">2025</SelectItem>
                <SelectItem value="2024">2024</SelectItem>
                <SelectItem value="2023">2023</SelectItem>
              </SelectContent>
            </Select>
            <Select value={selectedDepartment} onValueChange={setSelectedDepartment}>
              <SelectTrigger className="w-[200px]">
                <SelectValue placeholder="Todos os departamentos" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todos os departamentos</SelectItem>
                <SelectItem value="vendas">Vendas</SelectItem>
                <SelectItem value="marketing">Marketing</SelectItem>
                <SelectItem value="ti">TI</SelectItem>
                <SelectItem value="rh">RH</SelectItem>
              </SelectContent>
            </Select>
            <Button
              variant="outline"
              onClick={() => exportDashboardPDF({
                userName: "Sistema AVD",
                activeGoals: totalGoals,
                evaluations: totalEvaluations,
                activePDIs: activePDIs,
                currentCycle: selectedPeriod
              })}
            >
              <Download className="h-4 w-4 mr-2" />
              Exportar PDF
            </Button>
          </div>
        </div>

        {/* KPIs */}
        <div className="grid gap-4 md:grid-cols-4">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <Users className="h-4 w-4" />
                Colaboradores
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{totalEmployees}</div>
              <p className="text-xs text-muted-foreground mt-1">Total ativo</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <TrendingUp className="h-4 w-4" />
                Metas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{completedGoals}/{totalGoals}</div>
              <p className="text-xs text-muted-foreground mt-1">
                {totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0}% concluÃ­das
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <Users className="h-4 w-4" />
                AvaliaÃ§Ãµes 360Â°
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{completedEvaluations}/{totalEvaluations}</div>
              <p className="text-xs text-muted-foreground mt-1">
                {totalEvaluations > 0 ? Math.round((completedEvaluations / totalEvaluations) * 100) : 0}% completas
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <FileText className="h-4 w-4" />
                PDIs Ativos
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{activePDIs}</div>
              <p className="text-xs text-muted-foreground mt-1">
                {totalPDIs} no total
              </p>
            </CardContent>
          </Card>
        </div>

        {/* Tabs */}
        <Tabs defaultValue="metas" className="space-y-4">
          <TabsList>
            <TabsTrigger value="metas">Metas</TabsTrigger>
            <TabsTrigger value="avaliacoes">AvaliaÃ§Ãµes</TabsTrigger>
            <TabsTrigger value="pdi">PDI</TabsTrigger>
            <TabsTrigger value="departamentos">Departamentos</TabsTrigger>
          </TabsList>

          {/* Metas Tab */}
          <TabsContent value="metas" className="space-y-4">
            <div className="grid gap-4 md:grid-cols-2">
              <Card>
                <CardHeader>
                  <CardTitle>EvoluÃ§Ã£o Mensal de Metas</CardTitle>
                  <CardDescription>Metas concluÃ­das vs. total por mÃªs</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    {monthlyGoalsData.map((item) => (
                      <div key={item.month} className="space-y-1">
                        <div className="flex items-center justify-between text-sm">
                          <span className="font-medium">{item.month}</span>
                          <span className="text-muted-foreground">
                            {item.completed}/{item.total} ({Math.round((item.completed / item.total) * 100)}%)
                          </span>
                        </div>
                        <div className="h-2 bg-muted rounded-full overflow-hidden">
                          <div
                            className="h-full bg-primary"
                            style={{ width: `${(item.completed / item.total) * 100}%` }}
                          />
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Metas por Status</CardTitle>
                  <CardDescription>DistribuiÃ§Ã£o atual</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 rounded-full bg-green-500" />
                        <span className="text-sm">ConcluÃ­das</span>
                      </div>
                      <span className="font-semibold">{completedGoals}</span>
                    </div>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 rounded-full bg-blue-500" />
                        <span className="text-sm">Em Andamento</span>
                      </div>
                      <span className="font-semibold">
                        {goals?.filter(g => g.status === "em_andamento").length || 0}
                      </span>
                    </div>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 rounded-full bg-yellow-500" />
                        <span className="text-sm">Pendente AprovaÃ§Ã£o</span>
                      </div>
                      <span className="font-semibold">
                        {goals?.filter(g => g.status === "pendente_aprovacao").length || 0}
                      </span>
                    </div>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 rounded-full bg-gray-500" />
                        <span className="text-sm">Rascunho</span>
                      </div>
                      <span className="font-semibold">
                        {goals?.filter(g => g.status === "rascunho").length || 0}
                      </span>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            <Card>
              <CardHeader>
                <CardTitle>Progresso MÃ©dio por Categoria</CardTitle>
                <CardDescription>Desempenho por tipo de meta</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {["quantitativa", "qualitativa", "projeto", "comportamental"].map((category) => {
                    const categoryGoals = goals?.filter(g => g.category === category) || [];
                    const avgProgress = categoryGoals.length
                      ? Math.round(categoryGoals.reduce((sum, g) => sum + g.progress, 0) / categoryGoals.length)
                      : 0;

                    return (
                      <div key={category} className="space-y-2">
                        <div className="flex items-center justify-between text-sm">
                          <span className="font-medium capitalize">{category}</span>
                          <span className="text-muted-foreground">
                            {avgProgress}% ({categoryGoals.length} metas)
                          </span>
                        </div>
                        <div className="h-2 bg-muted rounded-full overflow-hidden">
                          <div
                            className="h-full bg-primary"
                            style={{ width: `${avgProgress}%` }}
                          />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* AvaliaÃ§Ãµes Tab */}
          <TabsContent value="avaliacoes" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Status das AvaliaÃ§Ãµes 360Â°</CardTitle>
                <CardDescription>Progresso do ciclo atual</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="grid grid-cols-3 gap-4 text-center">
                    <div className="p-4 bg-muted rounded-lg">
                      <div className="text-2xl font-bold text-yellow-600">
                        {evaluations?.filter(e => e.status === "pendente").length || 0}
                      </div>
                      <p className="text-xs text-muted-foreground mt-1">Pendentes</p>
                    </div>
                    <div className="p-4 bg-muted rounded-lg">
                      <div className="text-2xl font-bold text-blue-600">
                        {evaluations?.filter(e => e.status === "em_andamento").length || 0}
                      </div>
                      <p className="text-xs text-muted-foreground mt-1">Em Andamento</p>
                    </div>
                    <div className="p-4 bg-muted rounded-lg">
                      <div className="text-2xl font-bold text-green-600">
                        {completedEvaluations}
                      </div>
                      <p className="text-xs text-muted-foreground mt-1">ConcluÃ­das</p>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* PDI Tab */}
          <TabsContent value="pdi" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>PDIs por Status</CardTitle>
                <CardDescription>DistribuiÃ§Ã£o de planos de desenvolvimento</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {["rascunho", "pendente_aprovacao", "aprovado", "em_andamento", "concluido"].map((status) => {
                    const count = pdis?.filter(p => p.status === status).length || 0;
                    const percentage = totalPDIs > 0 ? Math.round((count / totalPDIs) * 100) : 0;

                    return (
                      <div key={status} className="space-y-2">
                        <div className="flex items-center justify-between text-sm">
                          <span className="font-medium capitalize">{status.replace("_", " ")}</span>
                          <span className="text-muted-foreground">
                            {count} ({percentage}%)
                          </span>
                        </div>
                        <div className="h-2 bg-muted rounded-full overflow-hidden">
                          <div
                            className="h-full bg-primary"
                            style={{ width: `${percentage}%` }}
                          />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Departamentos Tab */}
          <TabsContent value="departamentos" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Desempenho por Departamento</CardTitle>
                <CardDescription>MÃ©dia de avaliaÃ§Ãµes e nÃºmero de colaboradores</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {departmentPerformance.map((dept) => (
                    <div key={dept.name} className="space-y-2">
                      <div className="flex items-center justify-between text-sm">
                        <div>
                          <span className="font-medium">{dept.name}</span>
                          <span className="text-muted-foreground ml-2">
                            ({dept.employees} colaboradores)
                          </span>
                        </div>
                        <span className="font-semibold">{dept.score}/10</span>
                      </div>
                      <div className="h-2 bg-muted rounded-full overflow-hidden">
                        <div
                          className="h-full bg-primary"
                          style={{ width: `${(dept.score / 10) * 100}%` }}
                        />
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/RelatoriosExecutivos.tsx
========================================
import { useState } from "react";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  FileText, 
  TrendingUp, 
  Users, 
  AlertCircle, 
  Download,
  BarChart3,
  PieChart,
  Target,
  Lightbulb
} from "lucide-react";
import { PieChart as RePieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip, BarChart, Bar, XAxis, YAxis, CartesianGrid } from "recharts";
import { exportRelatorioExecutivoPDF } from "@/utils/pdfExport";
import { toast } from "sonner";

/**
 * PÃ¡gina de RelatÃ³rios Executivos de RH
 * Dashboard estratÃ©gico com insights organizacionais sobre perfis psicomÃ©tricos
 */

const COLORS = {
  disc: {
    D: "#ef4444", // red
    I: "#eab308", // yellow
    S: "#22c55e", // green
    C: "#3b82f6", // blue
  },
  priority: {
    high: "#f97316", // orange
    medium: "#eab308", // yellow
    low: "#22c55e", // green
  }
};

export default function RelatoriosExecutivos() {
  const { user } = useAuth();
  const [selectedDepartment, setSelectedDepartment] = useState<number | null>(null);

  // Buscar dados agregados
  const { data: discByDept } = trpc.psychometric.getAggregatedResults.useQuery({
    groupBy: "department",
    testType: "disc",
  });

  const { data: bigFiveByDept } = trpc.psychometric.getAggregatedResults.useQuery({
    groupBy: "department",
    testType: "bigfive",
  });

  const { data: discByPosition } = trpc.psychometric.getAggregatedResults.useQuery({
    groupBy: "position",
    testType: "disc",
  });

  // Preparar dados para grÃ¡fico de pizza - DistribuiÃ§Ã£o DISC
  const prepareDISCDistribution = () => {
    if (!discByDept) return [];
    
    const totals = { D: 0, I: 0, S: 0, C: 0 };
    let count = 0;

    for (const dept of discByDept) {
      if (dept.averages?.disc) {
        totals.D += dept.averages.disc.D;
        totals.I += dept.averages.disc.I;
        totals.S += dept.averages.disc.S;
        totals.C += dept.averages.disc.C;
        count++;
      }
    }

    if (count === 0) return [];

    return [
      { name: "DominÃ¢ncia", value: totals.D / count, color: COLORS.disc.D },
      { name: "InfluÃªncia", value: totals.I / count, color: COLORS.disc.I },
      { name: "Estabilidade", value: totals.S / count, color: COLORS.disc.S },
      { name: "Conformidade", value: totals.C / count, color: COLORS.disc.C },
    ];
  };

  // Preparar dados para grÃ¡fico de barras - Perfis por Departamento
  const prepareProfilesByDepartment = () => {
    if (!discByDept) return [];

    return discByDept.map(dept => {
      const disc = dept.averages?.disc;
      if (!disc) return null;

      const dominant = Math.max(disc.D, disc.I, disc.S, disc.C);
      const profile = 
        dominant === disc.D ? "D" :
        dominant === disc.I ? "I" :
        dominant === disc.S ? "S" : "C";

      return {
        name: dept.groupName.length > 15 ? dept.groupName.substring(0, 15) + "..." : dept.groupName,
        fullName: dept.groupName,
        profile,
        D: disc.D,
        I: disc.I,
        S: disc.S,
        C: disc.C,
        count: dept.count,
      };
    }).filter((item): item is NonNullable<typeof item> => item !== null);
  };

  // Gerar insights automÃ¡ticos
  const generateInsights = () => {
    const insights = [];

    // Insight 1: Perfil DISC predominante
    const discDist = prepareDISCDistribution();
    if (discDist.length > 0) {
      const dominant = discDist.reduce((max, item) => item.value > max.value ? item : max);
      insights.push({
        type: "profile",
        title: "Perfil Organizacional Predominante",
        description: `A organizaÃ§Ã£o possui perfil predominante de ${dominant.name} (${dominant.value.toFixed(1)} pontos em mÃ©dia)`,
        recommendation: dominant.name === "DominÃ¢ncia" 
          ? "OrganizaÃ§Ã£o orientada a resultados. Recomenda-se desenvolver empatia e colaboraÃ§Ã£o."
          : dominant.name === "InfluÃªncia"
          ? "OrganizaÃ§Ã£o comunicativa e engajada. Recomenda-se estruturar processos e foco."
          : dominant.name === "Estabilidade"
          ? "OrganizaÃ§Ã£o colaborativa e estÃ¡vel. Recomenda-se desenvolver adaptabilidade e inovaÃ§Ã£o."
          : "OrganizaÃ§Ã£o analÃ­tica e detalhista. Recomenda-se desenvolver agilidade e comunicaÃ§Ã£o.",
        priority: "high" as const,
      });
    }

    // Insight 2: Departamentos com perfis extremos
    const deptProfiles = prepareProfilesByDepartment();
    if (deptProfiles.length > 0) {
      const highD = deptProfiles.filter(d => d.profile === "D");
      const highS = deptProfiles.filter(d => d.profile === "S");

      if (highD.length > 0 && highS.length > 0) {
        insights.push({
          type: "diversity",
          title: "Diversidade de Perfis por Departamento",
          description: `${highD.length} departamento(s) com perfil D (orientado a resultados) e ${highS.length} com perfil S (orientado a pessoas)`,
          recommendation: "Considere criar equipes multidisciplinares combinando perfis D e S para equilibrar foco em resultados e colaboraÃ§Ã£o.",
          priority: "medium" as const,
        });
      }
    }

    // Insight 3: Cobertura de testes
    const totalDepts = discByDept?.length || 0;
    const deptsWithTests = discByDept?.filter(d => d.count > 0).length || 0;
    const coverage = totalDepts > 0 ? (deptsWithTests / totalDepts) * 100 : 0;

    if (coverage < 50) {
      insights.push({
        type: "coverage",
        title: "Baixa Cobertura de Testes PsicomÃ©tricos",
        description: `Apenas ${coverage.toFixed(0)}% dos departamentos possuem colaboradores com testes realizados`,
        recommendation: "Recomenda-se expandir a aplicaÃ§Ã£o de testes psicomÃ©tricos para obter insights mais abrangentes.",
        priority: "high" as const,
      });
    } else if (coverage < 80) {
      insights.push({
        type: "coverage",
        title: "Cobertura Moderada de Testes",
        description: `${coverage.toFixed(0)}% dos departamentos possuem colaboradores com testes realizados`,
        recommendation: "Continue expandindo a aplicaÃ§Ã£o de testes para alcanÃ§ar cobertura completa.",
        priority: "medium" as const,
      });
    } else {
      insights.push({
        type: "coverage",
        title: "Excelente Cobertura de Testes",
        description: `${coverage.toFixed(0)}% dos departamentos possuem colaboradores com testes realizados`,
        recommendation: "Mantenha a cultura de avaliaÃ§Ã£o contÃ­nua e utilize os dados para decisÃµes estratÃ©gicas.",
        priority: "low" as const,
      });
    }

    // Insight 4: SugestÃµes de formaÃ§Ã£o de equipes
    if (deptProfiles.length >= 2) {
      const complementary = [];
      for (let i = 0; i < deptProfiles.length; i++) {
        for (let j = i + 1; j < deptProfiles.length; j++) {
          const dept1 = deptProfiles[i];
          const dept2 = deptProfiles[j];
          
          // Perfis complementares: D+S, I+C
          if ((dept1.profile === "D" && dept2.profile === "S") ||
              (dept1.profile === "S" && dept2.profile === "D") ||
              (dept1.profile === "I" && dept2.profile === "C") ||
              (dept1.profile === "C" && dept2.profile === "I")) {
            complementary.push({ dept1: dept1.fullName, dept2: dept2.fullName });
          }
        }
      }

      if (complementary.length > 0) {
        const example = complementary[0];
        insights.push({
          type: "teams",
          title: "Oportunidades de Equipes Complementares",
          description: `Identificadas ${complementary.length} combinaÃ§Ã£o(Ãµes) de departamentos com perfis complementares`,
          recommendation: `Exemplo: Criar projetos colaborativos entre ${example.dept1} e ${example.dept2} para equilibrar competÃªncias.`,
          priority: "medium" as const,
        });
      }
    }

    return insights;
  };

  const insights = generateInsights();
  const discDistribution = prepareDISCDistribution();
  const profilesByDept = prepareProfilesByDepartment();

  // Handler para exportar PDF
  const handleExportPDF = () => {
    try {
      exportRelatorioExecutivoPDF({
        discDistribution,
        profilesByDept,
        totalDepartments: discByDept?.length || 0,
        totalTests: discByDept?.reduce((sum, d) => sum + d.count, 0) || 0,
        totalPositions: discByPosition?.length || 0,
        coverage: discByDept && discByDept.length > 0
          ? (discByDept.filter(d => d.count > 0).length / discByDept.length) * 100
          : 0,
        insights,
      });
      toast.success("RelatÃ³rio exportado com sucesso!");
    } catch (error) {
      console.error("Erro ao exportar PDF:", error);
      toast.error("Erro ao exportar relatÃ³rio. Tente novamente.");
    }
  };

  if (user?.role !== 'admin') {
    return (
      <DashboardLayout>
        <Card>
          <CardHeader>
            <CardTitle>Acesso Negado</CardTitle>
            <CardDescription>Apenas administradores podem acessar relatÃ³rios executivos</CardDescription>
          </CardHeader>
        </Card>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <FileText className="h-8 w-8" />
              RelatÃ³rios Executivos de RH
            </h1>
            <p className="text-muted-foreground mt-2">
              Insights estratÃ©gicos sobre perfis psicomÃ©tricos organizacionais
            </p>
          </div>
          <Button variant="outline" className="gap-2" onClick={handleExportPDF}>
            <Download className="h-4 w-4" />
            Exportar PDF
          </Button>
        </div>

        {/* Tabs */}
        <Tabs defaultValue="overview" className="space-y-6">
          <TabsList>
            <TabsTrigger value="overview">VisÃ£o Geral</TabsTrigger>
            <TabsTrigger value="insights">Insights EstratÃ©gicos</TabsTrigger>
            <TabsTrigger value="recommendations">RecomendaÃ§Ãµes</TabsTrigger>
          </TabsList>

          {/* VisÃ£o Geral */}
          <TabsContent value="overview" className="space-y-6">
            <div className="grid md:grid-cols-2 gap-6">
              {/* DistribuiÃ§Ã£o DISC Organizacional */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <PieChart className="h-5 w-5" />
                    DistribuiÃ§Ã£o DISC Organizacional
                  </CardTitle>
                  <CardDescription>Perfil mÃ©dio de todos os departamentos</CardDescription>
                </CardHeader>
                <CardContent>
                  {discDistribution.length > 0 ? (
                    <ResponsiveContainer width="100%" height={300}>
                      <RePieChart>
                        <Pie
                          data={discDistribution}
                          cx="50%"
                          cy="50%"
                          labelLine={false}
                          label={({ name, value }) => `${name}: ${value.toFixed(1)}`}
                          outerRadius={80}
                          fill="#8884d8"
                          dataKey="value"
                        >
                          {discDistribution.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={entry.color} />
                          ))}
                        </Pie>
                        <Tooltip formatter={(value: any) => value.toFixed(1)} />
                        <Legend />
                      </RePieChart>
                    </ResponsiveContainer>
                  ) : (
                    <div className="py-12 text-center text-muted-foreground">
                      Dados insuficientes
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Perfis por Departamento */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <BarChart3 className="h-5 w-5" />
                    Perfis Predominantes por Departamento
                  </CardTitle>
                  <CardDescription>Perfil DISC dominante em cada Ã¡rea</CardDescription>
                </CardHeader>
                <CardContent>
                  {profilesByDept.length > 0 ? (
                    <div className="space-y-3">
                      {profilesByDept.slice(0, 5).map((dept, index) => (
                        <div key={index} className="flex items-center justify-between">
                          <div className="flex-1">
                            <div className="font-medium text-sm">{dept.name}</div>
                            <div className="text-xs text-muted-foreground">{dept.count} teste(s)</div>
                          </div>
                          <Badge
                            style={{
                              backgroundColor: COLORS.disc[dept.profile as keyof typeof COLORS.disc],
                              color: "white"
                            }}
                          >
                            Perfil {dept.profile}
                          </Badge>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="py-12 text-center text-muted-foreground">
                      Dados insuficientes
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>

            {/* MÃ©tricas RÃ¡pidas */}
            <div className="grid md:grid-cols-4 gap-4">
              <Card>
                <CardContent className="pt-6">
                  <div className="text-2xl font-bold">{discByDept?.length || 0}</div>
                  <p className="text-xs text-muted-foreground">Departamentos Analisados</p>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <div className="text-2xl font-bold">
                    {discByDept?.reduce((sum, d) => sum + d.count, 0) || 0}
                  </div>
                  <p className="text-xs text-muted-foreground">Testes Realizados</p>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <div className="text-2xl font-bold">{discByPosition?.length || 0}</div>
                  <p className="text-xs text-muted-foreground">Cargos Mapeados</p>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <div className="text-2xl font-bold">
                    {discByDept && discByDept.length > 0
                      ? ((discByDept.filter(d => d.count > 0).length / discByDept.length) * 100).toFixed(0)
                      : 0}%
                  </div>
                  <p className="text-xs text-muted-foreground">Cobertura de Testes</p>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* Insights EstratÃ©gicos */}
          <TabsContent value="insights" className="space-y-4">
            {insights.map((insight, index) => (
              <Card key={index} className={
                insight.priority === "high" ? "border-orange-200 bg-orange-50" :
                insight.priority === "medium" ? "border-yellow-200 bg-yellow-50" :
                "border-green-200 bg-green-50"
              }>
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <CardTitle className="text-lg flex items-center gap-2">
                        {insight.type === "profile" && <Users className="h-5 w-5" />}
                        {insight.type === "diversity" && <TrendingUp className="h-5 w-5" />}
                        {insight.type === "coverage" && <Target className="h-5 w-5" />}
                        {insight.type === "teams" && <Lightbulb className="h-5 w-5" />}
                        {insight.title}
                      </CardTitle>
                      <CardDescription className="mt-2">{insight.description}</CardDescription>
                    </div>
                    <Badge
                      variant={insight.priority === "high" ? "default" : "secondary"}
                      className={insight.priority === "high" ? "bg-orange-500" : ""}
                    >
                      {insight.priority === "high" ? "Alta" : insight.priority === "medium" ? "MÃ©dia" : "Baixa"}
                    </Badge>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="flex items-start gap-2 p-3 bg-white rounded-lg border">
                    <AlertCircle className="h-5 w-5 text-blue-600 mt-0.5" />
                    <div>
                      <p className="text-sm font-medium text-gray-900">RecomendaÃ§Ã£o:</p>
                      <p className="text-sm text-gray-600 mt-1">{insight.recommendation}</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </TabsContent>

          {/* RecomendaÃ§Ãµes */}
          <TabsContent value="recommendations" className="space-y-4">
            <Card className="border-blue-200 bg-gradient-to-r from-blue-50 to-cyan-50">
              <CardHeader>
                <CardTitle>AÃ§Ãµes EstratÃ©gicas Recomendadas</CardTitle>
                <CardDescription>PrÃ³ximos passos para otimizaÃ§Ã£o organizacional</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-3">
                  <div className="bg-white p-4 rounded-lg border">
                    <h4 className="font-semibold mb-2">1. Expandir Cobertura de Testes</h4>
                    <p className="text-sm text-gray-600">
                      Priorizar departamentos sem dados psicomÃ©tricos para obter visÃ£o completa da organizaÃ§Ã£o.
                    </p>
                  </div>

                  <div className="bg-white p-4 rounded-lg border">
                    <h4 className="font-semibold mb-2">2. Criar Equipes Multidisciplinares</h4>
                    <p className="text-sm text-gray-600">
                      Formar projetos com perfis complementares (D+S, I+C) para maximizar sinergia.
                    </p>
                  </div>

                  <div className="bg-white p-4 rounded-lg border">
                    <h4 className="font-semibold mb-2">3. Programas de Desenvolvimento Direcionados</h4>
                    <p className="text-sm text-gray-600">
                      Criar trilhas de capacitaÃ§Ã£o baseadas nos gaps identificados por departamento.
                    </p>
                  </div>

                  <div className="bg-white p-4 rounded-lg border">
                    <h4 className="font-semibold mb-2">4. Monitoramento ContÃ­nuo</h4>
                    <p className="text-sm text-gray-600">
                      Reaplicar testes anualmente para acompanhar evoluÃ§Ã£o dos perfis e eficÃ¡cia das aÃ§Ãµes.
                    </p>
                  </div>

                  <div className="bg-white p-4 rounded-lg border">
                    <h4 className="font-semibold mb-2">5. IntegraÃ§Ã£o com SucessÃ£o e Recrutamento</h4>
                    <p className="text-sm text-gray-600">
                      Utilizar perfis psicomÃ©tricos para identificar sucessores e definir perfis ideais para vagas.
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/RelatoriosProdutividade.tsx
========================================
import { useState } from "react";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { trpc } from "@/lib/trpc";
import DashboardLayout from "@/components/DashboardLayout";
import { BarChart3, TrendingUp, Users, Clock, Download, Calendar } from "lucide-react";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";

export default function RelatoriosProdutividade() {
  const [period, setPeriod] = useState("30");
  const [departmentFilter, setDepartmentFilter] = useState<string>("all");
  const [employeeSearch, setEmployeeSearch] = useState("");
  const [productivityFilter, setProductivityFilter] = useState("all");

  const { data: productivityData } = trpc.productivity.getReport.useQuery({
    days: parseInt(period),
    departmentId: departmentFilter === "all" ? undefined : parseInt(departmentFilter),
  });

  const { data: departments } = trpc.departments.list.useQuery();

  const getCategoryColor = (category: string) => {
    const colors: Record<string, string> = {
      reuniao: "bg-blue-500",
      analise: "bg-purple-500",
      planejamento: "bg-green-500",
      execucao: "bg-orange-500",
      suporte: "bg-yellow-500",
      outros: "bg-gray-500",
    };
    return colors[category] || "bg-gray-500";
  };

  const exportToExcel = () => {
    // TODO: Implementar exportaÃ§Ã£o Excel
    console.log("Exportar para Excel");
  };

  return (
    <DashboardLayout>
      <div className="container mx-auto py-8">
        <div className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold mb-2">RelatÃ³rios de Produtividade</h1>
            <p className="text-muted-foreground">AnÃ¡lise comparativa de atividades e responsabilidades</p>
          </div>
          <Button onClick={exportToExcel}>
            <Download className="w-4 h-4 mr-2" />
            Exportar Excel
          </Button>
        </div>

        {/* Filtros */}
        <Card className="mb-8">
          <CardContent className="pt-6">
            <div className="grid grid-cols-4 gap-4">
              <div>
                <label className="text-sm font-medium mb-2 block">PerÃ­odo</label>
                <Select value={period} onValueChange={setPeriod}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="7">Ãšltimos 7 dias</SelectItem>
                    <SelectItem value="30">Ãšltimos 30 dias</SelectItem>
                    <SelectItem value="90">Ãšltimos 90 dias</SelectItem>
                    <SelectItem value="365">Ãšltimo ano</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div>
                <label className="text-sm font-medium mb-2 block">Departamento</label>
                <Select value={departmentFilter} onValueChange={setDepartmentFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos</SelectItem>
                    {departments?.map((dept) => (
                      <SelectItem key={dept.id} value={dept.id.toString()}>
                        {dept.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <label className="text-sm font-medium mb-2 block">Buscar FuncionÃ¡rio</label>
                <Input
                  placeholder="Digite nome ou chapa..."
                  value={employeeSearch}
                  onChange={(e) => setEmployeeSearch(e.target.value)}
                />
              </div>
              <div>
                <label className="text-sm font-medium mb-2 block">Produtividade</label>
                <Select value={productivityFilter} onValueChange={setProductivityFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todas</SelectItem>
                    <SelectItem value="high">Alta (&gt;80%)</SelectItem>
                    <SelectItem value="medium">MÃ©dia (60-80%)</SelectItem>
                    <SelectItem value="low">Baixa (&lt;60%)</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* KPIs Principais */}
        <div className="grid grid-cols-4 gap-4 mb-8">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <Clock className="w-4 h-4" />
                Total de Horas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{productivityData?.totalHours || 0}h</div>
              <p className="text-xs text-muted-foreground mt-1">
                Ãšltimos {period} dias
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <Users className="w-4 h-4" />
                FuncionÃ¡rios Ativos
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{productivityData?.activeEmployees || 0}</div>
              <p className="text-xs text-muted-foreground mt-1">
                Com atividades registradas
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <BarChart3 className="w-4 h-4" />
                Taxa de AderÃªncia
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-green-600">
                {productivityData?.adherenceRate || 0}%
              </div>
              <p className="text-xs text-muted-foreground mt-1">
                Atividades vs Responsabilidades
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <TrendingUp className="w-4 h-4" />
                MÃ©dia por FuncionÃ¡rio
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{productivityData?.avgHoursPerEmployee || 0}h</div>
              <p className="text-xs text-muted-foreground mt-1">
                Horas/funcionÃ¡rio
              </p>
            </CardContent>
          </Card>
        </div>

        {/* GrÃ¡fico de DistribuiÃ§Ã£o por Categoria */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>DistribuiÃ§Ã£o de Tempo por Categoria</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {productivityData?.categoryDistribution?.map((item: any) => (
                <div key={item.category} className="space-y-2">
                  <div className="flex justify-between items-center">
                    <div className="flex items-center gap-2">
                      <div className={`w-3 h-3 rounded ${getCategoryColor(item.category)}`} />
                      <span className="font-medium capitalize">{item.category}</span>
                    </div>
                    <span className="text-sm text-muted-foreground">
                      {item.hours}h ({item.percentage}%)
                    </span>
                  </div>
                  <div className="w-full bg-muted rounded-full h-2">
                    <div
                      className={`h-2 rounded-full ${getCategoryColor(item.category)}`}
                      style={{ width: `${item.percentage}%` }}
                    />
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* Top 10 FuncionÃ¡rios Mais Produtivos */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>Top 10 FuncionÃ¡rios Mais Produtivos</CardTitle>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>PosiÃ§Ã£o</TableHead>
                  <TableHead>FuncionÃ¡rio</TableHead>
                  <TableHead>Departamento</TableHead>
                  <TableHead>Cargo</TableHead>
                  <TableHead>Horas Registradas</TableHead>
                  <TableHead>Atividades</TableHead>
                  <TableHead>Taxa de AderÃªncia</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {productivityData?.topEmployees?.map((emp: any, index: number) => (
                  <TableRow key={emp.id}>
                    <TableCell>
                      <div className="flex items-center gap-2">
                        {index < 3 && (
                          <span className="text-2xl">
                            {index === 0 ? "ðŸ¥‡" : index === 1 ? "ðŸ¥ˆ" : "ðŸ¥‰"}
                          </span>
                        )}
                        {index >= 3 && <span className="font-bold">#{index + 1}</span>}
                      </div>
                    </TableCell>
                    <TableCell className="font-medium">{emp.name}</TableCell>
                    <TableCell>{emp.department}</TableCell>
                    <TableCell>{emp.position}</TableCell>
                    <TableCell>{emp.totalHours}h</TableCell>
                    <TableCell>{emp.activityCount}</TableCell>
                    <TableCell>
                      <Badge variant={emp.adherenceRate >= 80 ? "default" : "secondary"}>
                        {emp.adherenceRate}%
                      </Badge>
                    </TableCell>
                  </TableRow>
                ))}
                {(!productivityData?.topEmployees || productivityData.topEmployees.length === 0) && (
                  <TableRow>
                    <TableCell colSpan={7} className="text-center py-8 text-muted-foreground">
                      Nenhum dado disponÃ­vel para o perÃ­odo selecionado
                    </TableCell>
                  </TableRow>
                )}
              </TableBody>
            </Table>
          </CardContent>
        </Card>

        {/* MÃ©tricas AvanÃ§adas */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>MÃ©tricas AvanÃ§adas de Produtividade</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-4 gap-6">
              <div className="text-center">
                <div className="text-4xl font-bold text-blue-600 mb-2">
                  {productivityData?.efficiency || 0}%
                </div>
                <div className="text-sm font-medium mb-1">EficiÃªncia</div>
                <div className="text-xs text-muted-foreground">
                  Horas trabalhadas / esperadas
                </div>
              </div>
              <div className="text-center">
                <div className="text-4xl font-bold text-green-600 mb-2">
                  {productivityData?.consistency || 0}%
                </div>
                <div className="text-sm font-medium mb-1">ConsistÃªncia</div>
                <div className="text-xs text-muted-foreground">
                  Regularidade dia a dia
                </div>
              </div>
              <div className="text-center">
                <div className="text-4xl font-bold text-purple-600 mb-2">
                  {productivityData?.diversity || 0}
                </div>
                <div className="text-sm font-medium mb-1">Diversidade</div>
                <div className="text-xs text-muted-foreground">
                  Categorias diferentes
                </div>
              </div>
              <div className="text-center">
                <div className="text-4xl font-bold text-orange-600 mb-2">
                  {productivityData?.fillRate || 0}%
                </div>
                <div className="text-sm font-medium mb-1">Taxa de Preenchimento</div>
                <div className="text-xs text-muted-foreground">
                  Dias com atividades
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Ranking Geral */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>Ranking Geral de Produtividade</CardTitle>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>PosiÃ§Ã£o</TableHead>
                  <TableHead>FuncionÃ¡rio</TableHead>
                  <TableHead>Score</TableHead>
                  <TableHead>EficiÃªncia</TableHead>
                  <TableHead>ConsistÃªncia</TableHead>
                  <TableHead>Diversidade</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {productivityData?.ranking?.map((item: any) => (
                  <TableRow key={item.position}>
                    <TableCell>
                      <div className="flex items-center gap-2">
                        {item.position <= 3 && (
                          <span className="text-2xl">
                            {item.position === 1 ? "ðŸ¥‡" : item.position === 2 ? "ðŸ¥ˆ" : "ðŸ¥‰"}
                          </span>
                        )}
                        {item.position > 3 && <span className="font-bold">#{item.position}</span>}
                      </div>
                    </TableCell>
                    <TableCell className="font-medium">{item.employee}</TableCell>
                    <TableCell>
                      <Badge variant="default">{item.score}</Badge>
                    </TableCell>
                    <TableCell>{item.efficiency}%</TableCell>
                    <TableCell>{item.consistency}%</TableCell>
                    <TableCell>{item.diversity}</TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </CardContent>
        </Card>

        {/* Alertas de Baixa Produtividade */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <span className="text-orange-600">âš ï¸</span>
              Alertas de Produtividade
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {productivityData?.alerts?.map((alert: any, index: number) => (
                <div
                  key={index}
                  className={`p-4 border-l-4 rounded ${
                    alert.severity === 'high'
                      ? 'border-red-500 bg-red-50 dark:bg-red-950'
                      : alert.severity === 'medium'
                      ? 'border-orange-500 bg-orange-50 dark:bg-orange-950'
                      : 'border-yellow-500 bg-yellow-50 dark:bg-yellow-950'
                  }`}
                >
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="font-medium">{alert.employee}</div>
                      <div className="text-sm text-muted-foreground mt-1">{alert.message}</div>
                    </div>
                    <Badge
                      variant={
                        alert.severity === 'high'
                          ? 'destructive'
                          : alert.severity === 'medium'
                          ? 'default'
                          : 'secondary'
                      }
                    >
                      {alert.severity === 'high' ? 'Alta' : alert.severity === 'medium' ? 'MÃ©dia' : 'Baixa'}
                    </Badge>
                  </div>
                </div>
              ))}
              {(!productivityData?.alerts || productivityData.alerts.length === 0) && (
                <div className="text-center py-8 text-green-600">
                  <span className="text-4xl">âœ“</span>
                  <p className="mt-2 font-medium">Nenhum alerta de produtividade</p>
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* ComparaÃ§Ã£o: Atividades Manuais vs AutomÃ¡ticas */}
        <Card>
          <CardHeader>
            <CardTitle>Atividades Manuais vs AutomÃ¡ticas</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 gap-8">
              <div>
                <h3 className="font-semibold mb-4">Atividades Manuais</h3>
                <div className="text-4xl font-bold text-blue-600 mb-2">
                  {productivityData?.manualActivities || 0}
                </div>
                <p className="text-sm text-muted-foreground">
                  Registradas pelos funcionÃ¡rios
                </p>
              </div>
              <div>
                <h3 className="font-semibold mb-4">Atividades AutomÃ¡ticas</h3>
                <div className="text-4xl font-bold text-green-600 mb-2">
                  {productivityData?.automaticActivities || 0}
                </div>
                <p className="text-sm text-muted-foreground">
                  Monitoradas pelo sistema
                </p>
              </div>
            </div>
            <div className="mt-6 p-4 bg-muted rounded-lg">
              <p className="text-sm">
                <strong>Taxa de Cruzamento:</strong> {productivityData?.crossMatchRate || 0}% das
                atividades manuais foram confirmadas por aÃ§Ãµes automÃ¡ticas no sistema
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/ReportAnalytics.tsx
========================================
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { trpc } from "@/lib/trpc";
import { BarChart3, FileText, Download, TrendingUp } from "lucide-react";
import { Bar, Line } from "react-chartjs-2";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend,
} from "chart.js";

// Registrar componentes do Chart.js
ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend
);

export default function ReportAnalytics() {
  const { data: stats, isLoading: statsLoading } = trpc.reportAnalytics.getUsageStats.useQuery();
  const { data: mostUsedMetrics, isLoading: metricsLoading } = trpc.reportAnalytics.getMostUsedMetrics.useQuery();
  const { data: exportHistory, isLoading: historyLoading } = trpc.reportAnalytics.getExportHistory.useQuery({ limit: 20 });
  const { data: trends, isLoading: trendsLoading } = trpc.reportAnalytics.getTrends.useQuery();

  // Dados para grÃ¡fico de mÃ©tricas mais usadas
  const metricsChartData = {
    labels: mostUsedMetrics?.map((m) => m.metric) || [],
    datasets: [
      {
        label: "NÃºmero de Usos",
        data: mostUsedMetrics?.map((m) => m.count) || [],
        backgroundColor: "rgba(59, 130, 246, 0.5)",
        borderColor: "rgb(59, 130, 246)",
        borderWidth: 1,
      },
    ],
  };

  // Dados para grÃ¡fico de tendÃªncias
  const trendsChartData = {
    labels: trends?.map((t) => new Date(t.date).toLocaleDateString("pt-BR")) || [],
    datasets: [
      {
        label: "RelatÃ³rios Gerados",
        data: trends?.map((t) => t.count) || [],
        borderColor: "rgb(34, 197, 94)",
        backgroundColor: "rgba(34, 197, 94, 0.1)",
        tension: 0.4,
        fill: true,
      },
    ],
  };

  return (
    <div className="container mx-auto p-6 space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Analytics do Report Builder</h1>
        <p className="text-muted-foreground">
          EstatÃ­sticas de uso e insights sobre relatÃ³rios customizados
        </p>
      </div>

      {/* Cards de EstatÃ­sticas */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total de RelatÃ³rios</CardTitle>
            <FileText className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {statsLoading ? "..." : stats?.totalReports || 0}
            </div>
            <p className="text-xs text-muted-foreground">RelatÃ³rios gerados</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total de ExportaÃ§Ãµes</CardTitle>
            <Download className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {statsLoading ? "..." : stats?.totalExports || 0}
            </div>
            <p className="text-xs text-muted-foreground">
              {stats?.exportsPdf || 0} PDF â€¢ {stats?.exportsExcel || 0} Excel
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Tempo MÃ©dio</CardTitle>
            <TrendingUp className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {statsLoading ? "..." : Math.round(stats?.avgExecutionTimeMs || 0)}ms
            </div>
            <p className="text-xs text-muted-foreground">Tempo de execuÃ§Ã£o</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">MÃ©tricas Ãšnicas</CardTitle>
            <BarChart3 className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {metricsLoading ? "..." : mostUsedMetrics?.length || 0}
            </div>
            <p className="text-xs text-muted-foreground">MÃ©tricas diferentes usadas</p>
          </CardContent>
        </Card>
      </div>

      {/* GrÃ¡ficos */}
      <div className="grid gap-6 md:grid-cols-2">
        {/* GrÃ¡fico de MÃ©tricas Mais Usadas */}
        <Card>
          <CardHeader>
            <CardTitle>MÃ©tricas Mais Consultadas</CardTitle>
            <CardDescription>Top 10 mÃ©tricas por nÃºmero de usos</CardDescription>
          </CardHeader>
          <CardContent>
            {metricsLoading ? (
              <div className="h-64 flex items-center justify-center text-muted-foreground">
                Carregando...
              </div>
            ) : mostUsedMetrics && mostUsedMetrics.length > 0 ? (
              <div className="h-64">
                <Bar
                  data={metricsChartData}
                  options={{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: false,
                      },
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        ticks: {
                          stepSize: 1,
                        },
                      },
                    },
                  }}
                />
              </div>
            ) : (
              <div className="h-64 flex items-center justify-center text-muted-foreground">
                Nenhum dado disponÃ­vel
              </div>
            )}
          </CardContent>
        </Card>

        {/* GrÃ¡fico de TendÃªncias */}
        <Card>
          <CardHeader>
            <CardTitle>TendÃªncia de Uso (30 dias)</CardTitle>
            <CardDescription>RelatÃ³rios gerados ao longo do tempo</CardDescription>
          </CardHeader>
          <CardContent>
            {trendsLoading ? (
              <div className="h-64 flex items-center justify-center text-muted-foreground">
                Carregando...
              </div>
            ) : trends && trends.length > 0 ? (
              <div className="h-64">
                <Line
                  data={trendsChartData}
                  options={{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: false,
                      },
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        ticks: {
                          stepSize: 1,
                        },
                      },
                    },
                  }}
                />
              </div>
            ) : (
              <div className="h-64 flex items-center justify-center text-muted-foreground">
                Nenhum dado disponÃ­vel
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* HistÃ³rico de ExportaÃ§Ãµes */}
      <Card>
        <CardHeader>
          <CardTitle>HistÃ³rico de ExportaÃ§Ãµes</CardTitle>
          <CardDescription>Ãšltimas 20 exportaÃ§Ãµes de relatÃ³rios</CardDescription>
        </CardHeader>
        <CardContent>
          {historyLoading ? (
            <div className="text-center text-muted-foreground py-8">Carregando...</div>
          ) : exportHistory && exportHistory.length > 0 ? (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left p-2 font-medium">RelatÃ³rio</th>
                    <th className="text-left p-2 font-medium">Tipo</th>
                    <th className="text-left p-2 font-medium">Data</th>
                    <th className="text-left p-2 font-medium">Tempo (ms)</th>
                  </tr>
                </thead>
                <tbody>
                  {exportHistory.map((item) => (
                    <tr key={item.id} className="border-b hover:bg-muted/50">
                      <td className="p-2">{item.reportName}</td>
                      <td className="p-2">
                        <span
                          className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${
                            item.action === "export_pdf"
                              ? "bg-red-100 text-red-700"
                              : "bg-green-100 text-green-700"
                          }`}
                        >
                          {item.action === "export_pdf" ? "PDF" : "Excel"}
                        </span>
                      </td>
                      <td className="p-2 text-sm text-muted-foreground">
                        {new Date(item.createdAt).toLocaleString("pt-BR")}
                      </td>
                      <td className="p-2 text-sm">{item.executionTimeMs || "-"}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            <div className="text-center text-muted-foreground py-8">
              Nenhuma exportaÃ§Ã£o registrada
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/ReportBuilder.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { toast } from "sonner";
import { BarChart3, Download, Save, Play } from "lucide-react";
import { generatePDF, generateExcel } from "@/lib/reportGenerators";

export default function ReportBuilder() {
  const [reportName, setReportName] = useState("");
  const [reportDescription, setReportDescription] = useState("");
  const [selectedMetrics, setSelectedMetrics] = useState<string[]>([]);
  const [chartType, setChartType] = useState("bar");
  const [filters, setFilters] = useState<any>({});
  const [filterDepartment, setFilterDepartment] = useState<string>("");
  const [filterPosition, setFilterPosition] = useState<string>("");
  const [filterStartDate, setFilterStartDate] = useState<string>("");
  const [filterEndDate, setFilterEndDate] = useState<string>("");
  const [previewData, setPreviewData] = useState<any>(null);

  const { data: availableMetrics, isLoading: metricsLoading, error: metricsError } = trpc.reportBuilder.getAvailableMetrics.useQuery();
  const { data: savedReports } = trpc.reportBuilder.list.useQuery();
  const { data: departments } = trpc.reportBuilder.getDepartments.useQuery();
  const { data: positions } = trpc.reportBuilder.getPositions.useQuery();
  
  const executeReport = trpc.reportBuilder.execute.useQuery(
    { metrics: selectedMetrics, filters },
    { enabled: false }
  );

  const trackAction = trpc.reportAnalytics.track.useMutation();

  const createReport = trpc.reportBuilder.create.useMutation({
    onSuccess: () => {
      toast.success("RelatÃ³rio salvo com sucesso!");
      setReportName("");
      setReportDescription("");
    },
    onError: () => {
      toast.error("Erro ao salvar relatÃ³rio");
    },
  });

  const handleMetricToggle = (metricId: string) => {
    setSelectedMetrics((prev) =>
      prev.includes(metricId)
        ? prev.filter((m) => m !== metricId)
        : [...prev, metricId]
    );
  };

  const handlePreview = async () => {
    if (selectedMetrics.length === 0) {
      toast.error("Selecione pelo menos uma mÃ©trica");
      return;
    }

    const startTime = Date.now();
    const result = await executeReport.refetch();
    const executionTime = Date.now() - startTime;

    if (result.data) {
      setPreviewData(result.data);
      toast.success("Preview gerado!");

      // Registrar tracking
      trackAction.mutate({
        reportName: reportName || "RelatÃ³rio sem nome",
        action: "view",
        metrics: selectedMetrics,
        filters,
        executionTimeMs: executionTime,
      });
    }
  };

  const handleSave = () => {
    if (!reportName) {
      toast.error("Digite um nome para o relatÃ³rio");
      return;
    }

    if (selectedMetrics.length === 0) {
      toast.error("Selecione pelo menos uma mÃ©trica");
      return;
    }

    createReport.mutate({
      name: reportName,
      description: reportDescription,
      metrics: selectedMetrics,
      filters,
      chartType,
      isTemplate: false,
      isPublic: false,
    });
  };

  const handleExport = async (format: "pdf" | "excel") => {
    if (!previewData) {
      toast.error("Gere um preview antes de exportar");
      return;
    }

    // Construir objeto de filtros
    const appliedFilters: any = {};
    if (filterDepartment && filterDepartment !== "all") appliedFilters.departmentId = parseInt(filterDepartment);
    if (filterPosition && filterPosition !== "all") appliedFilters.positionId = parseInt(filterPosition);
    if (filterStartDate) appliedFilters.startDate = filterStartDate;
    if (filterEndDate) appliedFilters.endDate = filterEndDate;
    setFilters(appliedFilters);

    try {
      const reportData = {
        name: reportName || "RelatÃ³rio Customizado",
        description: reportDescription,
        metrics: selectedMetrics,
        data: previewData.data,
        generatedAt: previewData.summary.generatedAt,
        chartType: chartType,
      };

      const startTime = Date.now();
      
      if (format === "pdf") {
        await generatePDF(reportData, availableMetrics || []);
        toast.success("PDF gerado com sucesso!");
        
        // Registrar tracking
        trackAction.mutate({
          reportName: reportName || "RelatÃ³rio Customizado",
          action: "export_pdf",
          metrics: selectedMetrics,
          filters: appliedFilters,
          executionTimeMs: Date.now() - startTime,
        });
      } else {
        await generateExcel(reportData, availableMetrics || []);
        toast.success("Excel gerado com sucesso!");
        
        // Registrar tracking
        trackAction.mutate({
          reportName: reportName || "RelatÃ³rio Customizado",
          action: "export_excel",
          metrics: selectedMetrics,
          filters: appliedFilters,
          executionTimeMs: Date.now() - startTime,
        });
      }
    } catch (error) {
      console.error("Erro ao exportar:", error);
      toast.error(`Erro ao gerar ${format.toUpperCase()}`);
    }
  };

  // Agrupar mÃ©tricas por categoria
  const metricsByCategory = availableMetrics?.reduce((acc: any, metric: any) => {
    if (!acc[metric.category]) {
      acc[metric.category] = [];
    }
    acc[metric.category].push(metric);
    return acc;
  }, {});

  return (
    <DashboardLayout>
      <div className="container mx-auto py-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">Report Builder</h1>
            <p className="text-muted-foreground">
              Crie relatÃ³rios customizados selecionando mÃ©tricas e filtros
            </p>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" onClick={() => handleExport("pdf")}>
              <Download className="w-4 h-4 mr-2" />
              Exportar PDF
            </Button>
            <Button variant="outline" onClick={() => handleExport("excel")}>
              <Download className="w-4 h-4 mr-2" />
              Exportar Excel
            </Button>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Painel de ConfiguraÃ§Ã£o */}
          <div className="lg:col-span-1 space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>ConfiguraÃ§Ã£o do RelatÃ³rio</CardTitle>
                <CardDescription>
                  Defina nome, mÃ©tricas e filtros
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <Label htmlFor="reportName">Nome do RelatÃ³rio</Label>
                  <Input
                    id="reportName"
                    value={reportName}
                    onChange={(e) => setReportName(e.target.value)}
                    placeholder="Ex: RelatÃ³rio Mensal de Performance"
                  />
                </div>

                <div>
                  <Label htmlFor="reportDescription">DescriÃ§Ã£o</Label>
                  <Input
                    id="reportDescription"
                    value={reportDescription}
                    onChange={(e) => setReportDescription(e.target.value)}
                    placeholder="DescriÃ§Ã£o opcional"
                  />
                </div>

                <div>
                  <Label htmlFor="chartType">Tipo de GrÃ¡fico</Label>
                  <Select value={chartType} onValueChange={setChartType}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="bar">Barras</SelectItem>
                      <SelectItem value="line">Linhas</SelectItem>
                      <SelectItem value="pie">Pizza</SelectItem>
                      <SelectItem value="table">Tabela</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                {/* Filtros DinÃ¢micos */}
                <div className="border-t pt-4 space-y-3">
                  <h3 className="font-semibold text-sm">Filtros</h3>
                  
                  <div>
                    <Label htmlFor="filterDepartment">Departamento</Label>
                    <Select value={filterDepartment} onValueChange={setFilterDepartment}>
                      <SelectTrigger id="filterDepartment">
                        <SelectValue placeholder="Todos os departamentos" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">Todos</SelectItem>
                        {departments?.map((dept) => (
                          <SelectItem key={dept.id} value={dept.id.toString()}>
                            {dept.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="filterPosition">Cargo</Label>
                    <Select value={filterPosition} onValueChange={setFilterPosition}>
                      <SelectTrigger id="filterPosition">
                        <SelectValue placeholder="Todos os cargos" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">Todos</SelectItem>
                        {positions?.map((pos) => (
                          <SelectItem key={pos.id} value={pos.id.toString()}>
                            {pos.title}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label htmlFor="filterStartDate">Data InÃ­cio</Label>
                      <Input
                        id="filterStartDate"
                        type="date"
                        value={filterStartDate}
                        onChange={(e) => setFilterStartDate(e.target.value)}
                      />
                    </div>
                    <div>
                      <Label htmlFor="filterEndDate">Data Fim</Label>
                      <Input
                        id="filterEndDate"
                        type="date"
                        value={filterEndDate}
                        onChange={(e) => setFilterEndDate(e.target.value)}
                      />
                    </div>
                  </div>
                </div>

                <div className="pt-4 space-y-2">
                  <Button onClick={handlePreview} className="w-full" variant="outline">
                    <Play className="w-4 h-4 mr-2" />
                    Visualizar Preview
                  </Button>
                  <Button onClick={handleSave} className="w-full">
                    <Save className="w-4 h-4 mr-2" />
                    Salvar RelatÃ³rio
                  </Button>
                </div>
              </CardContent>
            </Card>

            {/* MÃ©tricas DisponÃ­veis */}
            <Card>
              <CardHeader>
                <CardTitle>MÃ©tricas DisponÃ­veis</CardTitle>
                <CardDescription>
                  Selecione as mÃ©tricas para incluir
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {metricsLoading && <p className="text-sm text-muted-foreground">Carregando mÃ©tricas...</p>}
                {metricsError && <p className="text-sm text-destructive">Erro ao carregar mÃ©tricas</p>}
                {!metricsLoading && !availableMetrics && <p className="text-sm text-muted-foreground">Nenhuma mÃ©trica disponÃ­vel</p>}
                {metricsByCategory &&
                  Object.entries(metricsByCategory).map(([category, metrics]: [string, any]) => (
                    <div key={category} className="space-y-2">
                      <h4 className="font-semibold text-sm capitalize">{category}</h4>
                      {metrics.map((metric: any) => (
                        <div key={metric.id} className="flex items-center space-x-2">
                          <input
                            type="checkbox"
                            id={metric.id}
                            checked={selectedMetrics.includes(metric.id)}
                            onChange={() => handleMetricToggle(metric.id)}
                            className="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary cursor-pointer"
                          />
                          <Label
                            htmlFor={metric.id}
                            className="text-sm font-normal cursor-pointer"
                          >
                            {metric.name}
                          </Label>
                        </div>
                      ))}
                    </div>
                  ))}
              </CardContent>
            </Card>
          </div>

          {/* Painel de Preview */}
          <div className="lg:col-span-2">
            <Card className="h-full">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <BarChart3 className="w-5 h-5" />
                  Preview do RelatÃ³rio
                </CardTitle>
                <CardDescription>
                  VisualizaÃ§Ã£o em tempo real dos dados selecionados
                </CardDescription>
              </CardHeader>
              <CardContent>
                {!previewData ? (
                  <div className="flex items-center justify-center h-96 text-muted-foreground">
                    <div className="text-center">
                      <BarChart3 className="w-16 h-16 mx-auto mb-4 opacity-20" />
                      <p>Selecione mÃ©tricas e clique em "Visualizar Preview"</p>
                    </div>
                  </div>
                ) : (
                  <div className="space-y-6">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      {Object.entries(previewData.data).map(([key, value]: [string, any]) => {
                        if (Array.isArray(value)) return null; // Skip arrays for now
                        return (
                          <Card key={key}>
                            <CardHeader className="pb-2">
                              <CardDescription className="text-xs capitalize">
                                {key.replace(/([A-Z])/g, " $1").trim()}
                              </CardDescription>
                            </CardHeader>
                            <CardContent>
                              <p className="text-2xl font-bold">
                                {typeof value === "number" ? value.toFixed(2) : value}
                              </p>
                            </CardContent>
                          </Card>
                        );
                      })}
                    </div>

                    {previewData.data.departmentBreakdown && (
                      <Card>
                        <CardHeader>
                          <CardTitle className="text-lg">DistribuiÃ§Ã£o por Departamento</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="space-y-2">
                            {previewData.data.departmentBreakdown.map((dept: any) => (
                              <div key={dept.departmentName} className="flex justify-between items-center">
                                <span className="text-sm">{dept.departmentName}</span>
                                <span className="font-semibold">{dept.count}</span>
                              </div>
                            ))}
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    <div className="text-xs text-muted-foreground">
                      Gerado em: {new Date(previewData.summary.generatedAt).toLocaleString("pt-BR")}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        </div>

        {/* RelatÃ³rios Salvos */}
        {savedReports && savedReports.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle>RelatÃ³rios Salvos</CardTitle>
              <CardDescription>
                Seus relatÃ³rios customizados salvos
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {savedReports.map((report: any) => (
                  <Card key={report.id} className="cursor-pointer hover:border-primary">
                    <CardHeader>
                      <CardTitle className="text-base">{report.name}</CardTitle>
                      {report.description && (
                        <CardDescription className="text-xs">{report.description}</CardDescription>
                      )}
                    </CardHeader>
                    <CardContent>
                      <div className="text-xs text-muted-foreground">
                        {report.metrics.length} mÃ©tricas
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/ResponderPesquisaPulse.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { toast } from "sonner";
import { CheckCircle2, MessageSquare } from "lucide-react";
import { APP_LOGO, APP_TITLE } from "@/const";

export default function ResponderPesquisaPulse() {
  const [rating, setRating] = useState<string>("");
  const [comment, setComment] = useState("");
  const [submitted, setSubmitted] = useState(false);

  // Dados mock da pesquisa (em produÃ§Ã£o viriam da URL)
  const survey = {
    id: 1,
    title: "SatisfaÃ§Ã£o com Ambiente de Trabalho",
    question: "Como vocÃª avalia o ambiente de trabalho da empresa?",
    description: "Sua opiniÃ£o Ã© muito importante para melhorarmos continuamente nosso ambiente de trabalho.",
  };

  const handleSubmit = () => {
    if (!rating) {
      toast.error("Por favor, selecione uma nota antes de enviar");
      return;
    }

    // Aqui seria feita a chamada tRPC para salvar a resposta
    console.log({
      surveyId: survey.id,
      rating: parseInt(rating),
      comment,
    });

    toast.success("Resposta enviada com sucesso! Obrigado pela participaÃ§Ã£o.");
    setSubmitted(true);
  };

  if (submitted) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-orange-50 to-orange-100 p-4">
        <Card className="w-full max-w-2xl">
          <CardContent className="pt-12 pb-12 text-center">
            <CheckCircle2 className="h-16 w-16 text-green-500 mx-auto mb-4" />
            <h2 className="text-2xl font-bold mb-2">Resposta Enviada!</h2>
            <p className="text-muted-foreground mb-6">
              Obrigado por participar da nossa pesquisa de pulse. Sua opiniÃ£o Ã© muito importante para nÃ³s.
            </p>
            <p className="text-sm text-muted-foreground">
              VocÃª pode fechar esta janela agora.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-orange-50 to-orange-100 p-4">
      <Card className="w-full max-w-2xl">
        <CardHeader className="text-center">
          <div className="flex justify-center mb-4">
            <img src={APP_LOGO} alt={APP_TITLE} className="h-12" />
          </div>
          <CardTitle className="text-2xl">{survey.title}</CardTitle>
          <CardDescription className="text-base">{survey.description}</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="space-y-4">
            <div className="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
              <p className="font-medium text-lg">{survey.question}</p>
            </div>

            <div className="space-y-3">
              <Label className="text-base font-medium">
                Selecione uma nota de 0 a 10:
              </Label>
              <RadioGroup value={rating} onValueChange={setRating} className="grid grid-cols-11 gap-2">
                {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((value) => (
                  <div key={value} className="flex flex-col items-center">
                    <RadioGroupItem
                      value={value.toString()}
                      id={`rating-${value}`}
                      className="peer sr-only"
                    />
                    <Label
                      htmlFor={`rating-${value}`}
                      className="flex h-12 w-12 cursor-pointer items-center justify-center rounded-lg border-2 border-muted bg-background hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-orange-500 peer-data-[state=checked]:bg-orange-500 peer-data-[state=checked]:text-white transition-all"
                    >
                      {value}
                    </Label>
                  </div>
                ))}
              </RadioGroup>
              <div className="flex justify-between text-xs text-muted-foreground px-1">
                <span>Muito insatisfeito</span>
                <span>Muito satisfeito</span>
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="comment" className="text-base font-medium flex items-center gap-2">
                <MessageSquare className="h-4 w-4" />
                ComentÃ¡rio (opcional)
              </Label>
              <Textarea
                id="comment"
                placeholder="Compartilhe mais detalhes sobre sua avaliaÃ§Ã£o..."
                value={comment}
                onChange={(e) => setComment(e.target.value)}
                rows={4}
                className="resize-none"
              />
            </div>
          </div>

          <div className="flex gap-3">
            <Button
              onClick={handleSubmit}
              className="flex-1 h-12 text-base"
              disabled={!rating}
            >
              Enviar Resposta
            </Button>
          </div>

          <p className="text-xs text-center text-muted-foreground">
            Suas respostas sÃ£o confidenciais e serÃ£o usadas apenas para melhorar nosso ambiente de trabalho.
          </p>
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/ResultadosPesquisaPulse.tsx
========================================
import { useParams, Link } from "wouter";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { ArrowLeft, Download, TrendingUp, Users, MessageSquare } from "lucide-react";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } from "recharts";
import DashboardLayout from "@/components/DashboardLayout";

export default function ResultadosPesquisaPulse() {
  const params = useParams();
  const surveyId = parseInt(params.id || "0");

  const { data: survey } = trpc.pulse.getById.useQuery({ id: surveyId });
  const { data: results } = trpc.pulse.getResults.useQuery({ surveyId });

  if (!survey || !results) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <div className="text-center">
            <h2 className="text-2xl font-bold mb-2">Carregando resultados...</h2>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  // Preparar dados para o grÃ¡fico
  const chartData = Object.entries(results.distribution).map(([rating, count]) => ({
    rating: parseInt(rating),
    count: count as number,
    label: rating,
  }));

  // Cores do grÃ¡fico (vermelho para notas baixas, verde para altas)
  const getBarColor = (rating: number) => {
    if (rating <= 3) return "#ef4444"; // vermelho
    if (rating <= 6) return "#f59e0b"; // laranja
    if (rating <= 8) return "#3b82f6"; // azul
    return "#10b981"; // verde
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/pesquisas-pulse">
              <Button variant="outline" size="icon">
                <ArrowLeft className="h-4 w-4" />
              </Button>
            </Link>
            <div>
              <h1 className="text-3xl font-bold">{survey.title}</h1>
              <p className="text-muted-foreground">{survey.question}</p>
            </div>
          </div>
          <div className="flex gap-2">
            <Button variant="outline">
              <Download className="h-4 w-4 mr-2" />
              Exportar PDF
            </Button>
            <Button variant="outline">
              <Download className="h-4 w-4 mr-2" />
              Exportar Excel
            </Button>
          </div>
        </div>

        {/* KPIs */}
        <div className="grid gap-4 md:grid-cols-3">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Total de Respostas</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{results.totalResponses}</div>
              <p className="text-xs text-muted-foreground">
                Taxa de resposta: {results.totalResponses > 0 ? "89%" : "0%"}
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Nota MÃ©dia</CardTitle>
              <TrendingUp className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{results.avgScore.toFixed(1)}</div>
              <p className="text-xs text-muted-foreground">
                Escala de 0 a 10
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">ComentÃ¡rios</CardTitle>
              <MessageSquare className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{results.comments.length}</div>
              <p className="text-xs text-muted-foreground">
                {results.totalResponses > 0 
                  ? `${Math.round((results.comments.length / results.totalResponses) * 100)}% com comentÃ¡rios`
                  : "Nenhum comentÃ¡rio"}
              </p>
            </CardContent>
          </Card>
        </div>

        {/* GrÃ¡fico de DistribuiÃ§Ã£o */}
        <Card>
          <CardHeader>
            <CardTitle>DistribuiÃ§Ã£o de Notas</CardTitle>
            <CardDescription>
              Quantidade de respostas por nota (0 = Muito insatisfeito, 10 = Muito satisfeito)
            </CardDescription>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis 
                  dataKey="label" 
                  label={{ value: 'Nota', position: 'insideBottom', offset: -5 }}
                />
                <YAxis 
                  label={{ value: 'Quantidade', angle: -90, position: 'insideLeft' }}
                />
                <Tooltip 
                  formatter={(value) => [`${value} respostas`, 'Quantidade']}
                  labelFormatter={(label) => `Nota ${label}`}
                />
                <Bar dataKey="count" radius={[8, 8, 0, 0]}>
                  {chartData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={getBarColor(entry.rating)} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* Lista de ComentÃ¡rios */}
        {results.comments.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle>ComentÃ¡rios dos Colaboradores</CardTitle>
              <CardDescription>
                Feedback qualitativo dos respondentes
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {results.comments.map((comment) => (
                  <div
                    key={comment.id}
                    className="border-l-4 pl-4 py-2"
                    style={{
                      borderColor: getBarColor(comment.rating),
                    }}
                  >
                    <div className="flex items-center justify-between mb-1">
                      <span className="font-semibold">Nota: {comment.rating}/10</span>
                      <span className="text-sm text-muted-foreground">{comment.createdAt}</span>
                    </div>
                    <p className="text-sm">{comment.comment}</p>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/ScheduledReports.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Calendar, Clock, FileText, Mail, Play, Trash2, Plus, Download, AlertCircle } from "lucide-react";
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

/**
 * PÃ¡gina de RelatÃ³rios Agendados
 * Permite configurar envio automÃ¡tico de relatÃ³rios por e-mail
 */
export default function ScheduledReports() {
  const { user, loading } = useAuth();
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [selectedReport, setSelectedReport] = useState<any>(null);

  // Queries - DEVEM estar antes dos returns condicionais
  const { data: reports, isLoading, refetch } = trpc.scheduledReports.list.useQuery(undefined, { enabled: !loading && user?.role === 'admin' });

  // Mutations
  const createMutation = trpc.scheduledReports.create.useMutation({
    onSuccess: () => {
      toast.success("RelatÃ³rio agendado criado com sucesso!");
      setIsDialogOpen(false);
      refetch();
    },
    onError: (error) => {
      toast.error(`Erro ao criar relatÃ³rio: ${error.message}`);
    },
  });

  const deleteMutation = trpc.scheduledReports.delete.useMutation({
    onSuccess: () => {
      toast.success("RelatÃ³rio agendado excluÃ­do!");
      refetch();
    },
    onError: (error) => {
      toast.error(`Erro ao excluir: ${error.message}`);
    },
  });

  const executeNowMutation = trpc.scheduledReports.executeNow.useMutation({
    onSuccess: (data) => {
      toast.success(data.message);
      refetch();
    },
    onError: (error) => {
      toast.error(`Erro ao executar: ${error.message}`);
    },
  });

  // Form state - DEVE estar antes dos returns
  const [formData, setFormData] = useState({
    reportType: "nine_box",
    reportName: "",
    frequency: "monthly",
    dayOfWeek: 1,
    dayOfMonth: 1,
    hour: 9,
    recipients: "",
    format: "pdf",
    includeCharts: true,
    active: true,
  });

  // Verificar se usuÃ¡rio Ã© admin
  if (!loading && (!user || user.role !== "admin")) {
    return (
      <DashboardLayout>
        <div className="flex flex-col items-center justify-center min-h-[60vh] space-y-4">
          <AlertCircle className="h-16 w-16 text-destructive" />
          <h2 className="text-2xl font-bold">Acesso Negado</h2>
          <p className="text-muted-foreground text-center max-w-md">
            Apenas administradores podem gerenciar relatÃ³rios agendados.
          </p>
        </div>
      </DashboardLayout>
    );
  }

  if (loading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center min-h-[60vh]">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p className="text-muted-foreground">Carregando...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    // Validar recipients
    const recipientsArray = formData.recipients
      .split(",")
      .map((email) => email.trim())
      .filter((email) => email.length > 0);

    if (recipientsArray.length === 0) {
      toast.error("Adicione pelo menos um destinatÃ¡rio");
      return;
    }

    createMutation.mutate({
      reportType: formData.reportType as any,
      reportName: formData.reportName,
      frequency: formData.frequency as any,
      dayOfWeek: formData.frequency === "weekly" ? formData.dayOfWeek : undefined,
      dayOfMonth: formData.frequency === "monthly" || formData.frequency === "quarterly" ? formData.dayOfMonth : undefined,
      hour: formData.hour,
      recipients: recipientsArray,
      format: formData.format as any,
      includeCharts: formData.includeCharts,
      active: formData.active,
    });
  };

  const handleDelete = (id: number) => {
    if (confirm("Tem certeza que deseja excluir este relatÃ³rio agendado?")) {
      deleteMutation.mutate({ id });
    }
  };

  const handleExecuteNow = (id: number) => {
    if (confirm("Deseja executar este relatÃ³rio agora?")) {
      executeNowMutation.mutate({ id });
    }
  };

  const reportTypeLabels: Record<string, string> = {
    nine_box: "Matriz 9-Box",
    performance: "Performance Geral",
    pdi: "PDI (Planos de Desenvolvimento)",
    evaluations: "AvaliaÃ§Ãµes 360Â°",
    goals: "Metas",
    competencies: "CompetÃªncias",
    succession: "Planos de SucessÃ£o",
    turnover: "Turnover",
    headcount: "Headcount",
  };

  const frequencyLabels: Record<string, string> = {
    daily: "DiÃ¡rio",
    weekly: "Semanal",
    monthly: "Mensal",
    quarterly: "Trimestral",
  };

  const formatLabels: Record<string, string> = {
    pdf: "PDF",
    excel: "Excel",
    csv: "CSV",
  };

  const dayOfWeekLabels = ["Domingo", "Segunda", "TerÃ§a", "Quarta", "Quinta", "Sexta", "SÃ¡bado"];

  return (
    <div className="container mx-auto py-8">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-3xl font-bold">RelatÃ³rios Agendados</h1>
          <p className="text-muted-foreground">Configure envio automÃ¡tico de relatÃ³rios por e-mail</p>
        </div>

        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogTrigger asChild>
            <Button>
              <Plus className="mr-2 h-4 w-4" />
              Novo RelatÃ³rio
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle>Criar RelatÃ³rio Agendado</DialogTitle>
              <DialogDescription>
                Configure um relatÃ³rio para ser enviado automaticamente por e-mail
              </DialogDescription>
            </DialogHeader>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="reportType">Tipo de RelatÃ³rio</Label>
                  <Select
                    value={formData.reportType}
                    onValueChange={(value) => setFormData({ ...formData, reportType: value })}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {Object.entries(reportTypeLabels).map(([key, label]) => (
                        <SelectItem key={key} value={key}>
                          {label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="reportName">Nome do RelatÃ³rio</Label>
                  <Input
                    id="reportName"
                    value={formData.reportName}
                    onChange={(e) => setFormData({ ...formData, reportName: e.target.value })}
                    placeholder="Ex: RelatÃ³rio Mensal de Performance"
                    required
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="frequency">FrequÃªncia</Label>
                  <Select
                    value={formData.frequency}
                    onValueChange={(value) => setFormData({ ...formData, frequency: value })}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {Object.entries(frequencyLabels).map(([key, label]) => (
                        <SelectItem key={key} value={key}>
                          {label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="hour">HorÃ¡rio de Envio</Label>
                  <Select
                    value={formData.hour.toString()}
                    onValueChange={(value) => setFormData({ ...formData, hour: parseInt(value) })}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {Array.from({ length: 24 }, (_, i) => (
                        <SelectItem key={i} value={i.toString()}>
                          {i.toString().padStart(2, "0")}:00
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {formData.frequency === "weekly" && (
                <div className="space-y-2">
                  <Label htmlFor="dayOfWeek">Dia da Semana</Label>
                  <Select
                    value={formData.dayOfWeek.toString()}
                    onValueChange={(value) => setFormData({ ...formData, dayOfWeek: parseInt(value) })}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {dayOfWeekLabels.map((day, index) => (
                        <SelectItem key={index} value={index.toString()}>
                          {day}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              )}

              {(formData.frequency === "monthly" || formData.frequency === "quarterly") && (
                <div className="space-y-2">
                  <Label htmlFor="dayOfMonth">Dia do MÃªs</Label>
                  <Select
                    value={formData.dayOfMonth.toString()}
                    onValueChange={(value) => setFormData({ ...formData, dayOfMonth: parseInt(value) })}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {Array.from({ length: 31 }, (_, i) => (
                        <SelectItem key={i + 1} value={(i + 1).toString()}>
                          Dia {i + 1}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              )}

              <div className="space-y-2">
                <Label htmlFor="recipients">DestinatÃ¡rios (separados por vÃ­rgula)</Label>
                <Input
                  id="recipients"
                  value={formData.recipients}
                  onChange={(e) => setFormData({ ...formData, recipients: e.target.value })}
                  placeholder="email1@example.com, email2@example.com"
                  required
                />
                <p className="text-xs text-muted-foreground">
                  Adicione mÃºltiplos e-mails separados por vÃ­rgula
                </p>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="format">Formato do Arquivo</Label>
                  <Select
                    value={formData.format}
                    onValueChange={(value) => setFormData({ ...formData, format: value })}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {Object.entries(formatLabels).map(([key, label]) => (
                        <SelectItem key={key} value={key}>
                          {label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="flex items-center justify-between pt-8">
                  <Label htmlFor="includeCharts">Incluir GrÃ¡ficos</Label>
                  <Switch
                    id="includeCharts"
                    checked={formData.includeCharts}
                    onCheckedChange={(checked) => setFormData({ ...formData, includeCharts: checked })}
                  />
                </div>
              </div>

              <div className="flex items-center justify-between">
                <Label htmlFor="active">Ativo</Label>
                <Switch
                  id="active"
                  checked={formData.active}
                  onCheckedChange={(checked) => setFormData({ ...formData, active: checked })}
                />
              </div>

              <div className="flex justify-end gap-2 pt-4">
                <Button type="button" variant="outline" onClick={() => setIsDialogOpen(false)}>
                  Cancelar
                </Button>
                <Button type="submit" disabled={createMutation.isPending}>
                  {createMutation.isPending ? "Criando..." : "Criar RelatÃ³rio"}
                </Button>
              </div>
            </form>
          </DialogContent>
        </Dialog>
      </div>

      {isLoading ? (
        <div className="text-center py-12">Carregando relatÃ³rios...</div>
      ) : reports && reports.length > 0 ? (
        <div className="grid gap-4">
          {reports.map((report) => {
            const recipients = JSON.parse(report.recipients);
            
            return (
              <Card key={report.id}>
                <CardHeader>
                  <div className="flex justify-between items-start">
                    <div>
                      <CardTitle className="flex items-center gap-2">
                        <FileText className="h-5 w-5" />
                        {report.reportName}
                        {report.active ? (
                          <Badge variant="default">Ativo</Badge>
                        ) : (
                          <Badge variant="secondary">Inativo</Badge>
                        )}
                      </CardTitle>
                      <CardDescription>
                        {reportTypeLabels[report.reportType]} â€¢ {formatLabels[report.format]}
                      </CardDescription>
                    </div>
                    <div className="flex gap-2">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => handleExecuteNow(report.id)}
                        disabled={executeNowMutation.isPending}
                      >
                        <Play className="h-4 w-4 mr-1" />
                        Executar Agora
                      </Button>
                      <Button
                        size="sm"
                        variant="destructive"
                        onClick={() => handleDelete(report.id)}
                        disabled={deleteMutation.isPending}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div className="flex items-center gap-2">
                      <Calendar className="h-4 w-4 text-muted-foreground" />
                      <div>
                        <p className="font-medium">FrequÃªncia</p>
                        <p className="text-muted-foreground">{frequencyLabels[report.frequency]}</p>
                      </div>
                    </div>

                    <div className="flex items-center gap-2">
                      <Clock className="h-4 w-4 text-muted-foreground" />
                      <div>
                        <p className="font-medium">HorÃ¡rio</p>
                        <p className="text-muted-foreground">
                          {report.hour.toString().padStart(2, "0")}:00
                        </p>
                      </div>
                    </div>

                    <div className="flex items-center gap-2">
                      <Mail className="h-4 w-4 text-muted-foreground" />
                      <div>
                        <p className="font-medium">DestinatÃ¡rios</p>
                        <p className="text-muted-foreground">{recipients.length} e-mail(s)</p>
                      </div>
                    </div>

                    <div className="flex items-center gap-2">
                      <Download className="h-4 w-4 text-muted-foreground" />
                      <div>
                        <p className="font-medium">Ãšltima ExecuÃ§Ã£o</p>
                        <p className="text-muted-foreground">
                          {report.lastExecutedAt
                            ? format(new Date(report.lastExecutedAt), "dd/MM/yyyy HH:mm", { locale: ptBR })
                            : "Nunca"}
                        </p>
                      </div>
                    </div>
                  </div>

                  {report.nextExecutionAt && (
                    <div className="mt-4 p-3 bg-muted rounded-lg">
                      <p className="text-sm">
                        <strong>PrÃ³xima execuÃ§Ã£o:</strong>{" "}
                        {format(new Date(report.nextExecutionAt), "dd/MM/yyyy 'Ã s' HH:mm", { locale: ptBR })}
                      </p>
                    </div>
                  )}
                </CardContent>
              </Card>
            );
          })}
        </div>
      ) : (
        <Card>
          <CardContent className="py-12 text-center">
            <FileText className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
            <h3 className="text-lg font-semibold mb-2">Nenhum relatÃ³rio agendado</h3>
            <p className="text-muted-foreground mb-4">
              Crie seu primeiro relatÃ³rio automÃ¡tico para receber atualizaÃ§Ãµes por e-mail
            </p>
            <Button onClick={() => setIsDialogOpen(true)}>
              <Plus className="mr-2 h-4 w-4" />
              Criar Primeiro RelatÃ³rio
            </Button>
          </CardContent>
        </Card>
      )}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/SuccessionImport.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { Upload, FileJson, CheckCircle2, XCircle, AlertCircle } from "lucide-react";

export default function SuccessionImport() {
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [jsonData, setJsonData] = useState<any>(null);
  const [importResult, setImportResult] = useState<any>(null);

  const importMutation = trpc.succession.importSuccessionData.useMutation();
  const importUIPlans = trpc.succession.importUIPlans.useMutation();

  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    if (!file.name.endsWith(".json")) {
      toast.error("Por favor, selecione um arquivo JSON");
      return;
    }

    setSelectedFile(file);
    setImportResult(null);

    // Ler conteÃºdo do arquivo
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target?.result as string);
        setJsonData(data);
        toast.success("Arquivo carregado com sucesso!");
      } catch (error) {
        toast.error("Erro ao ler arquivo JSON");
        setSelectedFile(null);
      }
    };
    reader.readAsText(file);
  };

  const handleImport = async () => {
    if (!jsonData) {
      toast.error("Nenhum arquivo selecionado");
      return;
    }

    try {
      // Detectar formato do JSON
      const isSimplifiedFormat = Array.isArray(jsonData);
      
      const result = isSimplifiedFormat
        ? await importUIPlans.mutateAsync(jsonData)
        : await importMutation.mutateAsync(jsonData);
        
      setImportResult(result);

      if (result.errors.length === 0) {
        toast.success(`${result.success} planos importados com sucesso!`);
      } else {
        toast.warning(
          `${result.success} planos importados, ${result.errors.length} erros encontrados`
        );
      }
    } catch (error: any) {
      toast.error(`Erro ao importar: ${error.message}`);
    }
  };

  const handleClear = () => {
    setSelectedFile(null);
    setJsonData(null);
    setImportResult(null);
  };

  return (
    <div className="container py-8">
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold">ImportaÃ§Ã£o de Dados UISA</h1>
          <p className="text-muted-foreground mt-2">
            Importe planos de sucessÃ£o a partir de arquivo JSON
          </p>
        </div>

        {/* Upload Card */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Upload className="w-5 h-5" />
              Upload de Arquivo
            </CardTitle>
            <CardDescription>
              Selecione um arquivo JSON com os dados dos planos de sucessÃ£o
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* File Input */}
            <div className="flex items-center gap-4">
              <input
                type="file"
                accept=".json"
                onChange={handleFileSelect}
                className="hidden"
                id="file-upload"
              />
              <label htmlFor="file-upload">
                <Button variant="outline" className="cursor-pointer" asChild>
                  <span>
                    <FileJson className="w-4 h-4 mr-2" />
                    Selecionar Arquivo JSON
                  </span>
                </Button>
              </label>

              <Button
                variant="secondary"
                onClick={() => {
                  // Dados de exemplo dos 5 planos UISA
                  const exampleData = {
                    plans: [
                      {
                        positionTitle: "Gerente JurÃ­dico",
                        positionCode: "GER-JUR-001",
                        currentHolderName: "JoÃ£o Silva",
                        isCritical: true,
                        riskLevel: "alto" as const,
                        exitRisk: "medio" as const,
                        competencyGap: "GestÃ£o de equipes, NegociaÃ§Ã£o avanÃ§ada",
                        preparationTime: 12,
                        notes: "PosiÃ§Ã£o estratÃ©gica",
                        successors: [
                          {
                            employeeName: "Maria Santos",
                            employeeCode: "EMP-JUR-001",
                            readinessLevel: "1_ano" as const,
                            priority: 1,
                          },
                        ],
                      },
                    ],
                  };
                  setJsonData(exampleData);
                  setSelectedFile(new File([JSON.stringify(exampleData)], "exemplo.json"));
                  toast.success("Dados de exemplo carregados!");
                }}
              >
                Carregar Exemplo
              </Button>

              <Button
                variant="default"
                onClick={async () => {
                  try {
                    const response = await fetch("/uisa-all-succession-plans.json");
                    if (!response.ok) throw new Error("Erro ao carregar arquivo");
                    const data = await response.json();
                    setJsonData(data);
                    setSelectedFile(new File([JSON.stringify(data)], "uisa-5-planos.json"));
                    toast.success("ðŸŽ¯ 5 Planos UISA carregados!");
                  } catch (error) {
                    toast.error("Erro ao carregar planos UISA");
                  }
                }}
              >
                ðŸŽ¯ Importar 5 Planos UISA
              </Button>

              {selectedFile && (
                <div className="flex items-center gap-2 text-sm">
                  <CheckCircle2 className="w-4 h-4 text-green-600" />
                  <span className="font-medium">{selectedFile.name}</span>
                  <Button variant="ghost" size="sm" onClick={handleClear}>
                    Limpar
                  </Button>
                </div>
              )}
            </div>

            {/* Preview */}
            {jsonData && (
              <div className="space-y-2">
                <h3 className="font-semibold text-sm">Preview dos Dados:</h3>
                <div className="bg-muted p-4 rounded-lg">
                  <p className="text-sm">
                    <strong>Total de Planos:</strong> {Array.isArray(jsonData) ? jsonData.length : (jsonData.plans?.length || 0)}
                  </p>
                  {((Array.isArray(jsonData) && jsonData.length > 0) || (jsonData.plans && jsonData.plans.length > 0)) && (
                    <ul className="mt-2 space-y-1 text-sm text-muted-foreground">
                      {(Array.isArray(jsonData) ? jsonData : jsonData.plans).slice(0, 5).map((plan: any, idx: number) => (
                        <li key={idx}>
                          â€¢ {plan.positionName || plan.positionTitle} ({plan.successors?.length || 0} sucessores)
                        </li>
                      ))}
                      {(Array.isArray(jsonData) ? jsonData.length : jsonData.plans.length) > 5 && (
                        <li>... e mais {(Array.isArray(jsonData) ? jsonData.length : jsonData.plans.length) - 5} planos</li>
                      )}
                    </ul>
                  )}
                </div>
              </div>
            )}

            {/* Import Button */}
            <div className="flex gap-2">
              <Button
                onClick={handleImport}
                disabled={!jsonData || importMutation.isPending}
                className="w-full"
              >
                {importMutation.isPending ? (
                  <>Importando...</>
                ) : (
                  <>
                    <Upload className="w-4 h-4 mr-2" />
                    Importar Dados
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Results Card */}
        {importResult && (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                {importResult.errors.length === 0 ? (
                  <>
                    <CheckCircle2 className="w-5 h-5 text-green-600" />
                    ImportaÃ§Ã£o ConcluÃ­da
                  </>
                ) : (
                  <>
                    <AlertCircle className="w-5 h-5 text-yellow-600" />
                    ImportaÃ§Ã£o ConcluÃ­da com Avisos
                  </>
                )}
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* Success Summary */}
              <div className="bg-green-50 dark:bg-green-950 p-4 rounded-lg">
                <div className="flex items-center gap-2 text-green-700 dark:text-green-300">
                  <CheckCircle2 className="w-5 h-5" />
                  <span className="font-semibold">
                    {importResult.success} planos importados com sucesso
                  </span>
                </div>
              </div>

              {/* Errors */}
              {importResult.errors.length > 0 && (
                <div className="bg-red-50 dark:bg-red-950 p-4 rounded-lg space-y-2">
                  <div className="flex items-center gap-2 text-red-700 dark:text-red-300 font-semibold">
                    <XCircle className="w-5 h-5" />
                    <span>{importResult.errors.length} erros encontrados:</span>
                  </div>
                  <ul className="space-y-1 text-sm text-red-600 dark:text-red-400 ml-7">
                    {importResult.errors.map((error: string, idx: number) => (
                      <li key={idx}>â€¢ {error}</li>
                    ))}
                  </ul>
                </div>
              )}

              {/* Action Buttons */}
              <div className="flex gap-2">
                <Button variant="outline" onClick={handleClear} className="flex-1">
                  Importar Outro Arquivo
                </Button>
                <Button
                  variant="default"
                  onClick={() => (window.location.href = "/sucessao")}
                  className="flex-1"
                >
                  Ver Planos de SucessÃ£o
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Instructions Card */}
        <Card>
          <CardHeader>
            <CardTitle>Formato do Arquivo JSON</CardTitle>
            <CardDescription>Estrutura esperada para importaÃ§Ã£o</CardDescription>
          </CardHeader>
          <CardContent>
            <pre className="bg-muted p-4 rounded-lg text-xs overflow-x-auto">
{`{
  "plans": [
    {
      "positionTitle": "Gerente JurÃ­dico",
      "positionCode": "GER-JUR-001",
      "currentHolderName": "JoÃ£o Silva",
      "isCritical": true,
      "riskLevel": "alto",
      "exitRisk": "medio",
      "competencyGap": "GestÃ£o de equipes, NegociaÃ§Ã£o",
      "preparationTime": 12,
      "notes": "PosiÃ§Ã£o estratÃ©gica",
      "successors": [
        {
          "employeeName": "Maria Santos",
          "employeeCode": "EMP-001",
          "readinessLevel": "1_ano",
          "priority": 1
        }
      ]
    }
  ]
}`}
            </pre>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/Sucessao.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { cn } from "@/lib/utils";
import { Loader2, Users, TrendingUp, AlertCircle, Plus, UserPlus, Award, Calendar, Target, Search, Check, ChevronsUpDown, Pencil, Trash2 } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { toast } from "sonner";

/**
 * PÃ¡gina de Mapa de SucessÃ£o
 * Metodologia: 9-Box Succession Planning
 * 
 * Funcionalidades:
 * - Criar novo mapa de sucessÃ£o
 * - Incluir sucessores em mapa existente
 * - Abas: Planos de Acompanhamento, Riscos, Timeline, Desenvolvimento
 */

export default function Sucessao() {
  const [selectedPlanId, setSelectedPlanId] = useState<number | null>(null);
  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
  const [isAddSuccessorDialogOpen, setIsAddSuccessorDialogOpen] = useState(false);
  const [openEmployeeCombobox, setOpenEmployeeCombobox] = useState(false);
  const [selectedEmployeeId, setSelectedEmployeeId] = useState<number | null>(null);

  // Queries
  const { data: plans, isLoading, refetch } = trpc.succession.list.useQuery();
  const { data: selectedPlan } = trpc.succession.getById.useQuery(
    { id: selectedPlanId! },
    { enabled: !!selectedPlanId }
  );
  const { data: positions } = trpc.positions.list.useQuery();
  const { data: employees } = trpc.employees.list.useQuery();
  const { data: suggestions } = trpc.succession.suggestSuccessors.useQuery(
    { positionId: selectedPlan?.positionId || 0 },
    { enabled: !!selectedPlan?.positionId }
  );

  // Mutations
  const createPlan = trpc.succession.create.useMutation({
    onSuccess: () => {
      toast.success("Plano de sucessÃ£o criado com sucesso!");
      setIsCreateDialogOpen(false);
      refetch();
    },
    onError: (error) => toast.error(`Erro: ${error.message}`),
  });

  const addSuccessor = trpc.succession.addSuccessor.useMutation({
    onSuccess: () => {
      toast.success("Sucessor adicionado com sucesso!");
      setIsAddSuccessorDialogOpen(false);
      refetch();
    },
    onError: (error) => toast.error(`Erro: ${error.message}`),
  });

  const updatePlan = trpc.succession.update.useMutation({
    onSuccess: () => {
      toast.success("Plano atualizado com sucesso!");
      refetch();
    },
    onError: (error) => toast.error(`Erro: ${error.message}`),
  });

  // Handlers
  const handleCreatePlan = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);
    
    createPlan.mutate({
      positionId: Number(formData.get("positionId")),
      currentHolderId: formData.get("currentHolderId") ? Number(formData.get("currentHolderId")) : undefined,
      isCritical: formData.get("isCritical") === "true",
      riskLevel: formData.get("riskLevel") as "baixo" | "medio" | "alto" | "critico",
      exitRisk: formData.get("exitRisk") as "baixo" | "medio" | "alto",
      competencyGap: formData.get("competencyGap") as string,
      preparationTime: formData.get("preparationTime") ? Number(formData.get("preparationTime")) : undefined,
      notes: formData.get("notes") as string,
    });
  };

  const handleAddSuccessor = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    
    if (!selectedEmployeeId) {
      toast.error("Selecione um colaborador");
      return;
    }
    
    const formData = new FormData(e.currentTarget);
    
    addSuccessor.mutate({
      planId: selectedPlanId!,
      employeeId: selectedEmployeeId,
      readinessLevel: formData.get("readinessLevel") as "imediato" | "1_ano" | "2_3_anos" | "mais_3_anos",
      priority: Number(formData.get("priority")),
      notes: formData.get("notes") as string,
    });
  };

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">Mapa de SucessÃ£o</h1>
            <p className="text-muted-foreground mt-1">
              Metodologia: <Badge variant="outline">9-Box Succession Planning</Badge>
            </p>
          </div>
          
          <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>
            <DialogTrigger asChild>
              <Button>
                <Plus className="h-4 w-4 mr-2" />
                Criar Plano de SucessÃ£o
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
              <DialogHeader>
                <DialogTitle>Criar Novo Plano de SucessÃ£o</DialogTitle>
                <DialogDescription>
                  Identifique posiÃ§Ãµes crÃ­ticas e planeje a sucessÃ£o com base na metodologia 9-Box
                </DialogDescription>
              </DialogHeader>
              
              <form onSubmit={handleCreatePlan} className="space-y-4">
                <div>
                  <Label htmlFor="positionId">PosiÃ§Ã£o *</Label>
                  <Select name="positionId" required>
                    <SelectTrigger>
                      <SelectValue placeholder="Selecione a posiÃ§Ã£o" />
                    </SelectTrigger>
                    <SelectContent>
                      {positions?.map((pos) => (
                        <SelectItem key={pos.id} value={pos.id.toString()}>
                          {pos.title}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label htmlFor="currentHolderId">Titular Atual</Label>
                  <Select name="currentHolderId">
                    <SelectTrigger>
                      <SelectValue placeholder="Selecione o titular" />
                    </SelectTrigger>
                    <SelectContent>
                      {employees?.map((emp) => (
                        <SelectItem key={emp.employee.id} value={emp.employee.id.toString()}>
                          {emp.employee.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="isCritical">PosiÃ§Ã£o CrÃ­tica?</Label>
                    <Select name="isCritical" defaultValue="false">
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="true">Sim</SelectItem>
                        <SelectItem value="false">NÃ£o</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="riskLevel">NÃ­vel de Risco</Label>
                    <Select name="riskLevel" defaultValue="medio">
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="baixo">Baixo</SelectItem>
                        <SelectItem value="medio">MÃ©dio</SelectItem>
                        <SelectItem value="alto">Alto</SelectItem>
                        <SelectItem value="critico">CrÃ­tico</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="exitRisk">Risco de SaÃ­da</Label>
                    <Select name="exitRisk" defaultValue="medio">
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="baixo">Baixo</SelectItem>
                        <SelectItem value="medio">MÃ©dio</SelectItem>
                        <SelectItem value="alto">Alto</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="preparationTime">Tempo de Preparo (meses)</Label>
                    <Input
                      type="number"
                      name="preparationTime"
                      placeholder="Ex: 12"
                      min="0"
                    />
                  </div>
                </div>

                <div>
                  <Label htmlFor="competencyGap">Gaps de CompetÃªncias</Label>
                  <Textarea
                    name="competencyGap"
                    placeholder="Descreva as competÃªncias que precisam ser desenvolvidas..."
                    rows={3}
                  />
                </div>

                <div>
                  <Label htmlFor="notes">ObservaÃ§Ãµes</Label>
                  <Textarea
                    name="notes"
                    placeholder="InformaÃ§Ãµes adicionais sobre o plano..."
                    rows={3}
                  />
                </div>

                <div className="flex justify-end gap-2">
                  <Button type="button" variant="outline" onClick={() => setIsCreateDialogOpen(false)}>
                    Cancelar
                  </Button>
                  <Button type="submit" disabled={createPlan.isPending}>
                    {createPlan.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                    Criar Plano
                  </Button>
                </div>
              </form>
            </DialogContent>
          </Dialog>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Total de Planos
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{plans?.length || 0}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                PosiÃ§Ãµes CrÃ­ticas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {plans?.filter(p => p.isCritical).length || 0}
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Sucessores Identificados
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {plans?.reduce((acc, p) => acc + (p.successors?.length || 0), 0) || 0}
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-muted-foreground">
                Risco Alto/CrÃ­tico
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-destructive">
                {plans?.filter(p => p.riskLevel === "alto" || p.riskLevel === "critico").length || 0}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de Planos */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Sidebar com lista de planos */}
          <Card className="lg:col-span-1">
            <CardHeader>
              <CardTitle>Planos de SucessÃ£o</CardTitle>
              <CardDescription>Selecione um plano para ver detalhes</CardDescription>
            </CardHeader>
            <CardContent className="space-y-2">
              {plans?.map((plan) => (
                <div
                  key={plan.id}
                  className={`p-3 rounded-lg border cursor-pointer transition-colors ${
                    selectedPlanId === plan.id
                      ? "border-primary bg-primary/5"
                      : "border-border hover:border-primary/50"
                  }`}
                  onClick={() => setSelectedPlanId(plan.id)}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <p className="font-medium text-sm">{plan.positionTitle}</p>
                      <p className="text-xs text-muted-foreground mt-1">
                        {plan.currentHolderName || "Sem titular"}
                      </p>
                    </div>
                    {plan.isCritical && (
                      <Badge variant="destructive" className="text-xs">
                        CrÃ­tica
                      </Badge>
                    )}
                  </div>
                  
                  <div className="flex items-center gap-2 mt-2">
                    <Badge variant="outline" className="text-xs">
                      {plan.successors?.length || 0} sucessores
                    </Badge>
                    <Badge
                      variant={
                        plan.riskLevel === "critico" || plan.riskLevel === "alto"
                          ? "destructive"
                          : "secondary"
                      }
                      className="text-xs"
                    >
                      Risco: {plan.riskLevel}
                    </Badge>
                  </div>
                </div>
              ))}

              {(!plans || plans.length === 0) && (
                <div className="text-center py-8 text-muted-foreground">
                  <Users className="h-12 w-12 mx-auto mb-2 opacity-50" />
                  <p className="text-sm">Nenhum plano criado ainda</p>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Detalhes do plano selecionado */}
          <Card className="lg:col-span-2">
            {selectedPlan ? (
              <>
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div>
                      <CardTitle>{selectedPlan.position?.title}</CardTitle>
                      <CardDescription>
                        Titular: {selectedPlan.currentHolder?.name || "NÃ£o definido"}
                      </CardDescription>
                    </div>
                    
                    <Dialog open={isAddSuccessorDialogOpen} onOpenChange={setIsAddSuccessorDialogOpen}>
                      <DialogTrigger asChild>
                        <Button size="sm">
                          <UserPlus className="h-4 w-4 mr-2" />
                          Adicionar Sucessor
                        </Button>
                      </DialogTrigger>
                      <DialogContent>
                        <DialogHeader>
                          <DialogTitle>Adicionar Sucessor</DialogTitle>
                          <DialogDescription>
                            Inclua um novo sucessor ao plano de sucessÃ£o
                          </DialogDescription>
                        </DialogHeader>
                        
                        <form onSubmit={handleAddSuccessor} className="space-y-4">
                          {/* Combobox de Colaborador com Busca */}
                          <div>
                            <Label>Colaborador *</Label>
                            <Popover open={openEmployeeCombobox} onOpenChange={setOpenEmployeeCombobox}>
                              <PopoverTrigger asChild>
                                <Button
                                  variant="outline"
                                  role="combobox"
                                  aria-expanded={openEmployeeCombobox}
                                  className="w-full justify-between"
                                >
                                  {selectedEmployeeId
                                    ? employees?.find((emp) => emp.employee.id === selectedEmployeeId)?.employee.name
                                    : "Buscar colaborador..."}
                                  <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                                </Button>
                              </PopoverTrigger>
                              <PopoverContent className="w-[400px] p-0">
                                <Command>
                                  <CommandInput placeholder="Digite o nome do colaborador..." />
                                  <CommandList>
                                    <CommandEmpty>Nenhum colaborador encontrado.</CommandEmpty>
                                    <CommandGroup>
                                      {employees?.slice(0, 100).map((emp) => (
                                        <CommandItem
                                          key={emp.employee.id}
                                          value={emp.employee.name}
                                          onSelect={() => {
                                            setSelectedEmployeeId(emp.employee.id);
                                            setOpenEmployeeCombobox(false);
                                          }}
                                        >
                                          <Check
                                            className={cn(
                                              "mr-2 h-4 w-4",
                                              selectedEmployeeId === emp.employee.id ? "opacity-100" : "opacity-0"
                                            )}
                                          />
                                          <div className="flex flex-col">
                                            <span>{emp.employee.name}</span>
                                            <span className="text-xs text-muted-foreground">
                                              {emp.position?.title || "Sem cargo"} â€¢ {emp.department?.name || "Sem depto"}
                                            </span>
                                          </div>
                                        </CommandItem>
                                      ))}
                                    </CommandGroup>
                                  </CommandList>
                                </Command>
                              </PopoverContent>
                            </Popover>
                            {selectedEmployeeId && (
                              <p className="text-xs text-muted-foreground mt-1">
                                âœ“ {employees?.find((emp) => emp.employee.id === selectedEmployeeId)?.employee.name} selecionado
                              </p>
                            )}
                          </div>

                          {/* NÃ­vel (PrimÃ¡rio, SecundÃ¡rio, Backup) */}
                          <div>
                            <Label htmlFor="level">NÃ­vel *</Label>
                            <Select name="level" defaultValue="primario" required>
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="primario">ðŸ¥‡ PrimÃ¡rio (1Âª opÃ§Ã£o)</SelectItem>
                                <SelectItem value="secundario">ðŸ¥ˆ SecundÃ¡rio (2Âª opÃ§Ã£o)</SelectItem>
                                <SelectItem value="backup">ðŸ¥‰ Backup (reserva)</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          {/* NÃ­vel de ProntidÃ£o com Indicadores Visuais */}
                          <div>
                            <Label htmlFor="readinessLevel">NÃ­vel de ProntidÃ£o *</Label>
                            <Select name="readinessLevel" required>
                              <SelectTrigger>
                                <SelectValue placeholder="Selecione" />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="imediato">ðŸŸ¢ Imediato (pronto agora)</SelectItem>
                                <SelectItem value="1_ano">ðŸŸ¡ 1 ano</SelectItem>
                                <SelectItem value="2_3_anos">ðŸŸ  2-3 anos</SelectItem>
                                <SelectItem value="mais_3_anos">ðŸ”´ Mais de 3 anos</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          {/* Prioridade */}
                          <div>
                            <Label htmlFor="priority">Prioridade (ordem de sucessÃ£o)</Label>
                            <Input
                              type="number"
                              name="priority"
                              defaultValue="1"
                              min="1"
                              max="10"
                              required
                            />
                            <p className="text-xs text-muted-foreground mt-1">
                              1 = maior prioridade, 10 = menor prioridade
                            </p>
                          </div>

                          <div>
                            <Label htmlFor="notes">ObservaÃ§Ãµes</Label>
                            <Textarea
                              name="notes"
                              placeholder="InformaÃ§Ãµes sobre o sucessor..."
                              rows={3}
                            />
                          </div>

                          <div className="flex justify-end gap-2">
                            <Button
                              type="button"
                              variant="outline"
                              onClick={() => setIsAddSuccessorDialogOpen(false)}
                            >
                              Cancelar
                            </Button>
                            <Button type="submit" disabled={addSuccessor.isPending}>
                              {addSuccessor.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                              Adicionar
                            </Button>
                          </div>
                        </form>
                      </DialogContent>
                    </Dialog>
                  </div>
                </CardHeader>

                <CardContent>
                  <Tabs defaultValue="successors" className="w-full">
                    <TabsList className="grid w-full grid-cols-4">
                      <TabsTrigger value="successors">
                        <Users className="h-4 w-4 mr-2" />
                        Sucessores
                      </TabsTrigger>
                      <TabsTrigger value="risks">
                        <AlertCircle className="h-4 w-4 mr-2" />
                        Riscos
                      </TabsTrigger>
                      <TabsTrigger value="timeline">
                        <Calendar className="h-4 w-4 mr-2" />
                        Timeline
                      </TabsTrigger>
                      <TabsTrigger value="development">
                        <Target className="h-4 w-4 mr-2" />
                        Desenvolvimento
                      </TabsTrigger>
                    </TabsList>

                    {/* Aba Sucessores */}
                    <TabsContent value="successors" className="space-y-4">
                      {selectedPlan.successors && selectedPlan.successors.length > 0 ? (
                        selectedPlan.successors.map((successor) => (
                          <Card key={successor.id}>
                            <CardContent className="pt-6">
                              <div className="flex items-start justify-between">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2">
                                    <h4 className="font-semibold">{successor.employeeName}</h4>
                                    <Badge variant="outline">Prioridade {successor.priority}</Badge>
                                  </div>
                                  <p className="text-sm text-muted-foreground mt-1">
                                    {successor.employeeEmail}
                                  </p>
                                  
                                  <div className="mt-3 flex items-center gap-2">
                                    <Badge>
                                      ProntidÃ£o: {successor.readinessLevel.replace("_", " ")}
                                    </Badge>
                                    
                                    {successor.nineBox && (
                                      <Badge variant="secondary">
                                        Nine Box: Perf {successor.nineBox.performance} | Pot {successor.nineBox.potential}
                                      </Badge>
                                    )}
                                  </div>

                                  {successor.notes && (
                                    <p className="text-sm mt-3 text-muted-foreground">
                                      {successor.notes}
                                    </p>
                                  )}
                                </div>
                                
                                {/* BotÃµes de AÃ§Ã£o */}
                                <div className="flex items-center gap-2">
                                  <Button
                                    size="sm"
                                    variant="ghost"
                                    onClick={() => {
                                      toast.info("Funcionalidade de ediÃ§Ã£o em desenvolvimento");
                                    }}
                                  >
                                    <Pencil className="h-4 w-4" />
                                  </Button>
                                  <Button
                                    size="sm"
                                    variant="ghost"
                                    className="text-destructive hover:text-destructive"
                                    onClick={() => {
                                      if (confirm(`Remover ${successor.employeeName} como sucessor?`)) {
                                        toast.info("Funcionalidade de remoÃ§Ã£o em desenvolvimento");
                                      }
                                    }}
                                  >
                                    <Trash2 className="h-4 w-4" />
                                  </Button>
                                </div>
                              </div>
                            </CardContent>
                          </Card>
                        ))
                      ) : (
                        <div className="text-center py-12 text-muted-foreground">
                          <UserPlus className="h-12 w-12 mx-auto mb-2 opacity-50" />
                          <p>Nenhum sucessor identificado ainda</p>
                          <p className="text-sm mt-1">Clique em "Adicionar Sucessor" para comeÃ§ar</p>
                        </div>
                      )}

                      {/* SugestÃµes automÃ¡ticas */}
                      {suggestions && suggestions.length > 0 && (
                        <div className="mt-6">
                          <h4 className="font-semibold mb-3 flex items-center gap-2">
                            <Award className="h-4 w-4 text-primary" />
                            SugestÃµes AutomÃ¡ticas (Alto Potencial via Nine Box)
                          </h4>
                          <div className="space-y-2">
                            {suggestions.slice(0, 5).map((suggestion) => (
                              <div
                                key={suggestion.employeeId}
                                className="p-3 rounded-lg border border-dashed border-primary/50 bg-primary/5"
                              >
                                <div className="flex items-center justify-between">
                                  <div>
                                    <p className="font-medium text-sm">{suggestion.employeeName}</p>
                                    <p className="text-xs text-muted-foreground">
                                      {suggestion.positionTitle}
                                    </p>
                                    <div className="flex items-center gap-2 mt-1">
                                      <Badge variant="outline" className="text-xs">
                                        Performance: {suggestion.performance}
                                      </Badge>
                                      <Badge variant="outline" className="text-xs">
                                        Potencial: {suggestion.potential}
                                      </Badge>
                                    </div>
                                  </div>
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    onClick={() => {
                                      // TODO: Auto-preencher formulÃ¡rio com sugestÃ£o
                                      setIsAddSuccessorDialogOpen(true);
                                    }}
                                  >
                                    Adicionar
                                  </Button>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </TabsContent>

                    {/* Aba Riscos */}
                    <TabsContent value="risks" className="space-y-4">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <Card>
                          <CardHeader className="pb-2">
                            <CardTitle className="text-sm">Risco de SaÃ­da</CardTitle>
                          </CardHeader>
                          <CardContent>
                            <Badge
                              variant={
                                selectedPlan.exitRisk === "alto" ? "destructive" : "secondary"
                              }
                              className="text-lg"
                            >
                              {selectedPlan.exitRisk || "NÃ£o definido"}
                            </Badge>
                          </CardContent>
                        </Card>

                        <Card>
                          <CardHeader className="pb-2">
                            <CardTitle className="text-sm">NÃ­vel de Risco Geral</CardTitle>
                          </CardHeader>
                          <CardContent>
                            <Badge
                              variant={
                                selectedPlan.riskLevel === "critico" || selectedPlan.riskLevel === "alto"
                                  ? "destructive"
                                  : "secondary"
                              }
                              className="text-lg"
                            >
                              {selectedPlan.riskLevel}
                            </Badge>
                          </CardContent>
                        </Card>

                        <Card>
                          <CardHeader className="pb-2">
                            <CardTitle className="text-sm">Tempo de Preparo</CardTitle>
                          </CardHeader>
                          <CardContent>
                            <p className="text-2xl font-bold">
                              {selectedPlan.preparationTime || "N/A"} meses
                            </p>
                          </CardContent>
                        </Card>
                      </div>

                      {selectedPlan.competencyGap && (
                        <Card>
                          <CardHeader>
                            <CardTitle className="text-sm">Gaps de CompetÃªncias</CardTitle>
                          </CardHeader>
                          <CardContent>
                            <p className="text-sm text-muted-foreground whitespace-pre-wrap">
                              {selectedPlan.competencyGap}
                            </p>
                          </CardContent>
                        </Card>
                      )}
                    </TabsContent>

                    {/* Aba Timeline */}
                    <TabsContent value="timeline" className="space-y-4">
                      <div className="space-y-4">
                        {["imediato", "1_ano", "2_3_anos", "mais_3_anos"].map((level) => {
                          const successorsInLevel = selectedPlan.successors?.filter(
                            (s) => s.readinessLevel === level
                          );
                          
                          const levelLabels: Record<string, string> = {
                            imediato: "Curto Prazo (Imediato)",
                            "1_ano": "MÃ©dio Prazo (1 ano)",
                            "2_3_anos": "Longo Prazo (2-3 anos)",
                            "mais_3_anos": "Muito Longo Prazo (3+ anos)",
                          };

                          return (
                            <Card key={level}>
                              <CardHeader>
                                <CardTitle className="text-sm">{levelLabels[level]}</CardTitle>
                              </CardHeader>
                              <CardContent>
                                {successorsInLevel && successorsInLevel.length > 0 ? (
                                  <div className="space-y-2">
                                    {successorsInLevel.map((successor) => (
                                      <div
                                        key={successor.id}
                                        className="flex items-center justify-between p-2 rounded-lg bg-muted/50"
                                      >
                                        <span className="font-medium text-sm">
                                          {successor.employeeName}
                                        </span>
                                        <Badge variant="outline">Prioridade {successor.priority}</Badge>
                                      </div>
                                    ))}
                                  </div>
                                ) : (
                                  <p className="text-sm text-muted-foreground">
                                    Nenhum sucessor neste prazo
                                  </p>
                                )}
                              </CardContent>
                            </Card>
                          );
                        })}
                      </div>
                    </TabsContent>

                    {/* Aba Desenvolvimento */}
                    <TabsContent value="development" className="space-y-4">
                      <Card>
                        <CardHeader>
                          <CardTitle className="text-sm">Plano de Acompanhamento</CardTitle>
                          <CardDescription>
                            Marcos e aÃ§Ãµes de desenvolvimento para os sucessores
                          </CardDescription>
                        </CardHeader>
                        <CardContent>
                          {selectedPlan.trackingPlan ? (
                            <div className="prose prose-sm max-w-none">
                              <pre className="whitespace-pre-wrap text-sm">
                                {selectedPlan.trackingPlan}
                              </pre>
                            </div>
                          ) : (
                            <div className="text-center py-8 text-muted-foreground">
                              <Target className="h-12 w-12 mx-auto mb-2 opacity-50" />
                              <p className="text-sm">Nenhum plano de acompanhamento definido</p>
                            </div>
                          )}
                        </CardContent>
                      </Card>

                      {selectedPlan.nextReviewDate && (
                        <Card>
                          <CardHeader>
                            <CardTitle className="text-sm">PrÃ³xima RevisÃ£o</CardTitle>
                          </CardHeader>
                          <CardContent>
                            <p className="text-sm">
                              {new Date(selectedPlan.nextReviewDate).toLocaleDateString("pt-BR")}
                            </p>
                          </CardContent>
                        </Card>
                      )}
                    </TabsContent>
                  </Tabs>
                </CardContent>
              </>
            ) : (
              <CardContent className="py-24">
                <div className="text-center text-muted-foreground">
                  <TrendingUp className="h-16 w-16 mx-auto mb-4 opacity-50" />
                  <p>Selecione um plano de sucessÃ£o para ver os detalhes</p>
                </div>
              </CardContent>
            )}
          </Card>
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/SucessaoMelhorado.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Loader2, Users, TrendingUp, AlertCircle, Plus, Download, Search, ArrowLeft } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { Link } from "wouter";
import { exportMapaSucessao } from "@/lib/exportPDF";
import { toast } from "sonner";

/**
 * Mapa de SucessÃ£o - VersÃ£o Melhorada
 * Baseado nas telas de referÃªncia UISA
 * 
 * Features:
 * - KPIs no topo (PosiÃ§Ãµes CrÃ­ticas, Sucessores Prontos, Alto Risco, Cobertura MÃ©dia)
 * - Filtros avanÃ§ados (Departamento, NÃ­vel de Risco, Impacto, Cobertura)
 * - VisualizaÃ§Ã£o em tabela com indicadores visuais
 * - BotÃ£o "Adicionar Primeira PosiÃ§Ã£o" quando vazio
 * - BotÃ£o "Exportar" relatÃ³rio
 */

export default function SucessaoMelhorado() {
  const [departmentFilter, setDepartmentFilter] = useState<string>("todos");
  const [riskFilter, setRiskFilter] = useState<string>("todos");
  const [impactFilter, setImpactFilter] = useState<string>("todos");
  const [coverageFilter, setCoverageFilter] = useState<string>("todos");
  const [searchQuery, setSearchQuery] = useState("");

  // Queries
  const { data: plans, isLoading } = trpc.succession.list.useQuery();
  const { data: kpis } = trpc.executive.getKPIs.useQuery({});

  // Calcular KPIs especÃ­ficos de sucessÃ£o
  const posicoescriticas = plans?.filter((p) => p.isCritical).length || 0;
  const sucessoresProntos = 0; // TODO: calcular baseado em readinessLevel
  const altoRisco = plans?.filter((p) => p.riskLevel === "alto" || p.riskLevel === "critico").length || 0;
  const coberturaMedia = plans?.length ? ((sucessoresProntos / plans.length) * 100).toFixed(0) : "0";

  // Filtrar planos
  const filteredPlans = plans?.filter((plan) => {
    if (departmentFilter !== "todos") {
      // TODO: adicionar filtro de departamento quando disponÃ­vel
    }
    if (riskFilter !== "todos" && plan.riskLevel !== riskFilter) return false;
    if (searchQuery && !plan.positionTitle?.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="space-y-6" id="mapa-sucessao-content">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/">
              <Button variant="ghost" size="icon">
                <ArrowLeft className="h-5 w-5" />
              </Button>
            </Link>
            <div>
              <div className="flex items-center gap-2">
                <Users className="h-6 w-6 text-primary" />
                <h1 className="text-2xl font-bold">Mapa de SucessÃ£o</h1>
              </div>
              <p className="text-sm text-muted-foreground">
                Planejamento estratÃ©gico de sucessÃ£o - UISA
              </p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <Button 
              variant="outline"
              onClick={async () => {
                try {
                  toast.info("Gerando PDF...");
                  await exportMapaSucessao();
                  toast.success("PDF exportado com sucesso!");
                } catch (error) {
                  toast.error("Erro ao exportar PDF");
                }
              }}
            >
              <Download className="h-4 w-4 mr-2" />
              Exportar PDF
            </Button>
            <Link href="/sucessao">
              <Button>
                <Plus className="h-4 w-4 mr-2" />
                Nova PosiÃ§Ã£o
              </Button>
            </Link>
          </div>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  PosiÃ§Ãµes CrÃ­ticas
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-red-100 flex items-center justify-center">
                  <AlertCircle className="h-5 w-5 text-red-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{posicoescriticas}</div>
              <p className="text-xs text-muted-foreground mt-1">
                {plans?.length || 0} posiÃ§Ãµes totais
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Sucessores Prontos
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                  <Users className="h-5 w-5 text-green-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{sucessoresProntos}</div>
              <p className="text-xs text-muted-foreground mt-1">ProntidÃ£o imediata</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Alto Risco
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-orange-100 flex items-center justify-center">
                  <AlertCircle className="h-5 w-5 text-orange-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{altoRisco}</div>
              <p className="text-xs text-red-600 mt-1">Requer atenÃ§Ã£o</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Cobertura MÃ©dia
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                  <TrendingUp className="h-5 w-5 text-blue-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{coberturaMedia}%</div>
              <p className="text-xs text-muted-foreground mt-1">Ãndice de cobertura</p>
            </CardContent>
          </Card>
        </div>

        {/* Filtros */}
        <Card>
          <CardContent className="pt-6">
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="Buscar posiÃ§Ã£o..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="pl-9"
                />
              </div>

              <Select value={departmentFilter} onValueChange={setDepartmentFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Departamento" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos</SelectItem>
                  <SelectItem value="comercial">Comercial</SelectItem>
                  <SelectItem value="ti">TI</SelectItem>
                  <SelectItem value="financeiro">Financeiro</SelectItem>
                  <SelectItem value="rh">RH</SelectItem>
                  <SelectItem value="operacoes">OperaÃ§Ãµes</SelectItem>
                </SelectContent>
              </Select>

              <Select value={riskFilter} onValueChange={setRiskFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="NÃ­vel de Risco" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos</SelectItem>
                  <SelectItem value="baixo">Baixo</SelectItem>
                  <SelectItem value="medio">MÃ©dio</SelectItem>
                  <SelectItem value="alto">Alto</SelectItem>
                  <SelectItem value="critico">CrÃ­tico</SelectItem>
                </SelectContent>
              </Select>

              <Select value={impactFilter} onValueChange={setImpactFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Impacto" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos</SelectItem>
                  <SelectItem value="baixo">Baixo</SelectItem>
                  <SelectItem value="medio">MÃ©dio</SelectItem>
                  <SelectItem value="alto">Alto</SelectItem>
                </SelectContent>
              </Select>

              <Select value={coverageFilter} onValueChange={setCoverageFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Cobertura" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos</SelectItem>
                  <SelectItem value="sem">Sem Cobertura</SelectItem>
                  <SelectItem value="minima">MÃ­nima</SelectItem>
                  <SelectItem value="adequada">Adequada</SelectItem>
                  <SelectItem value="excelente">Excelente</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </CardContent>
        </Card>

        {/* Lista de Planos ou Empty State */}
        {!filteredPlans || filteredPlans.length === 0 ? (
          <Card>
            <CardContent className="py-16">
              <div className="flex flex-col items-center justify-center text-center">
                <div className="h-20 w-20 rounded-full bg-muted flex items-center justify-center mb-4">
                  <Users className="h-10 w-10 text-muted-foreground" />
                </div>
                <h3 className="text-lg font-semibold mb-2">Nenhuma posiÃ§Ã£o cadastrada</h3>
                <p className="text-sm text-muted-foreground mb-6 max-w-md">
                  Comece adicionando posiÃ§Ãµes crÃ­ticas para o plano de sucessÃ£o
                </p>
                <Link href="/sucessao">
                  <Button>
                    <Plus className="h-4 w-4 mr-2" />
                    Adicionar Primeira PosiÃ§Ã£o
                  </Button>
                </Link>
              </div>
            </CardContent>
          </Card>
        ) : (
          <Card>
            <CardHeader>
              <CardTitle>PosiÃ§Ãµes Mapeadas ({filteredPlans.length})</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {filteredPlans.map((plan) => (
                  <Link key={plan.id} href={`/sucessao?id=${plan.id}`}>
                    <div className="flex items-center gap-4 p-4 rounded-lg border hover:bg-accent transition-colors cursor-pointer">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <h4 className="font-semibold truncate">{plan.positionTitle || "PosiÃ§Ã£o"}</h4>
                          {plan.isCritical && (
                            <Badge variant="destructive" className="text-xs">
                              CrÃ­tica
                            </Badge>
                          )}
                        </div>
                        <p className="text-sm text-muted-foreground truncate">
                          Titular: {plan.currentHolderName || "NÃ£o definido"}
                        </p>
                      </div>

                      <div className="flex items-center gap-6">
                        <div className="text-center">
                          <p className="text-xs text-muted-foreground">Risco</p>
                          <Badge
                            variant={
                              plan.riskLevel === "critico" || plan.riskLevel === "alto"
                                ? "destructive"
                                : plan.riskLevel === "medio"
                                ? "default"
                                : "secondary"
                            }
                            className="mt-1"
                          >
                            {plan.riskLevel === "critico"
                              ? "CrÃ­tico"
                              : plan.riskLevel === "alto"
                              ? "Alto"
                              : plan.riskLevel === "medio"
                              ? "MÃ©dio"
                              : "Baixo"}
                          </Badge>
                        </div>

                        <div className="text-center">
                          <p className="text-xs text-muted-foreground">Sucessores</p>
                          <p className="text-lg font-bold mt-1">{plan.successors?.length || 0}</p>
                        </div>

                        <div className="text-center">
                          <p className="text-xs text-muted-foreground">Status</p>
                          <Badge variant="outline" className="mt-1">
                            {plan.status === "ativo" ? "Ativo" : "Inativo"}
                          </Badge>
                        </div>
                      </div>
                    </div>
                  </Link>
                ))}
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/TestBigFive.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { toast } from "sonner";
import { Loader2, Brain, CheckCircle2, Mail, ArrowLeft } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { APP_LOGO, APP_TITLE } from "@/const";

/**
 * PÃ¡gina de Teste Big Five (VersÃ£o PÃºblica - sem necessidade de login)
 * QuestionÃ¡rio interativo com 50 perguntas
 */

export default function TestBigFive() {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [responses, setResponses] = useState<Record<number, number>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showEmailForm, setShowEmailForm] = useState(false);
  const [email, setEmail] = useState("");
  const [testCompleted, setTestCompleted] = useState(false);
  const [result, setResult] = useState<any>(null);

  // Buscar perguntas DISC (endpoint pÃºblico)
  const { data: questions, isLoading } = trpc.psychometric.getQuestionsPublic.useQuery({ testType: "bigfive" });

  // Mutation para submeter teste (endpoint pÃºblico)
  const submitMutation = trpc.psychometric.submitTestPublic.useMutation({
    onSuccess: (data) => {
      setResult(data);
      setTestCompleted(true);
      setIsSubmitting(false);
      toast.success(`ParabÃ©ns, ${data.employeeName}! Teste Big Five concluÃ­do com sucesso!`);
    },
    onError: (error) => {
      toast.error(`Erro ao submeter teste: ${error.message}`);
      setIsSubmitting(false);
    },
  });

  const handleResponseChange = (questionId: number, score: number) => {
    setResponses({ ...responses, [questionId]: score });
  };

  const handleNext = () => {
    if (!questions) return;
    
    const currentQuestionId = questions[currentQuestion].id;
    if (!responses[currentQuestionId]) {
      toast.error("Por favor, selecione uma resposta antes de continuar");
      return;
    }

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
    }
  };

  const handleFinish = () => {
    if (!questions) return;

    // Verificar se todas as perguntas foram respondidas
    const unanswered = questions.filter(q => !responses[q.id]);
    if (unanswered.length > 0) {
      toast.error(`Ainda faltam ${unanswered.length} pergunta(s) para responder`);
      return;
    }

    // Mostrar formulÃ¡rio de email
    setShowEmailForm(true);
  };

  const handleSubmit = () => {
    if (!email || !email.includes('@')) {
      toast.error("Por favor, insira um email vÃ¡lido");
      return;
    }

    setIsSubmitting(true);
    const formattedResponses = Object.entries(responses).map(([questionId, score]) => ({
      questionId: parseInt(questionId),
      score,
    }));

    submitMutation.mutate({
      testType: "bigfive",
      email: email,
      responses: formattedResponses,
    });
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 animate-spin text-primary mx-auto mb-4" />
          <p className="text-muted-foreground">Carregando teste...</p>
        </div>
      </div>
    );
  }

  if (!questions || questions.length === 0) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md">
          <CardHeader>
            <CardTitle>Teste Big Five</CardTitle>
            <CardDescription>Nenhuma pergunta encontrada</CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  // Tela de resultado
  if (testCompleted && result) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-2xl w-full">
          <CardHeader className="text-center">
            <div className="mx-auto mb-4 w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
              <CheckCircle2 className="w-10 h-10 text-green-600" />
            </div>
            <CardTitle className="text-2xl">Teste ConcluÃ­do com Sucesso!</CardTitle>
            <CardDescription className="text-base mt-2">
              Obrigado por completar o Teste Big Five, {result.employeeName}!
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <h3 className="font-semibold text-lg mb-2">Seu Perfil Big Five</h3>
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Abertura (O)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.O?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Conscienciosidade (C)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.A?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">ExtroversÃ£o (E)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.E?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Amabilidade (A)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.A?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Neuroticismo (N)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.N?.toFixed(1) || '0.0'}</div>
                </div>
              </div>
            </div>
            <p className="text-sm text-center text-muted-foreground">
              Seus resultados foram salvos e estÃ£o disponÃ­veis para anÃ¡lise pela equipe de RH.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  // FormulÃ¡rio de email
  if (showEmailForm) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader>
            <div className="mx-auto mb-4 w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center">
              <Mail className="w-10 h-10 text-orange-600" />
            </div>
            <CardTitle className="text-center">Quase lÃ¡!</CardTitle>
            <CardDescription className="text-center">
              Para finalizar, precisamos do seu email para associar os resultados
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="email">Email Corporativo</Label>
              <Input
                id="email"
                type="email"
                placeholder="seu.email@uisa.com.br"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="mt-2"
              />
              <p className="text-xs text-muted-foreground mt-2">
                Use o mesmo email que recebeu o convite para este teste
              </p>
            </div>
            <div className="flex gap-3">
              <Button
                variant="outline"
                onClick={() => setShowEmailForm(false)}
                className="flex-1"
              >
                <ArrowLeft className="w-4 h-4 mr-2" />
                Voltar
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="flex-1"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Enviando...
                  </>
                ) : (
                  <>
                    <CheckCircle2 className="w-4 h-4 mr-2" />
                    Finalizar
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const progress = (Object.keys(responses).length / questions.length) * 100;
  const currentQ = questions[currentQuestion];

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white">
      <div className="max-w-3xl mx-auto p-4 py-8 space-y-6">
        {/* Header */}
        <div className="text-center">
          <div className="flex items-center justify-center gap-3 mb-4">
            <Brain className="h-10 w-10 text-orange-600" />
            <h1 className="text-3xl font-bold tracking-tight">Teste Big Five</h1>
          </div>
          <p className="text-muted-foreground">
            Avalie cada afirmaÃ§Ã£o de acordo com o quanto vocÃª concorda
          </p>
        </div>

        {/* Barra de Progresso */}
        <Card>
          <CardContent className="pt-6">
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span>Progresso</span>
                <span>{Object.keys(responses).length} de {questions.length} perguntas</span>
              </div>
              <Progress value={progress} className="h-2" />
            </div>
          </CardContent>
        </Card>

        {/* Pergunta Atual */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">
              Pergunta {currentQuestion + 1} de {questions.length}
            </CardTitle>
            <CardDescription className="text-base mt-4">
              {currentQ.questionText}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <RadioGroup
              value={responses[currentQ.id]?.toString()}
              onValueChange={(value) => handleResponseChange(currentQ.id, parseInt(value))}
            >
              <div className="space-y-3">
                {[
                  { value: 1, label: "1 - Discordo totalmente" },
                  { value: 2, label: "2 - Discordo parcialmente" },
                  { value: 3, label: "3 - Neutro" },
                  { value: 4, label: "4 - Concordo parcialmente" },
                  { value: 5, label: "5 - Concordo totalmente" },
                ].map((option) => (
                  <div key={option.value} className="flex items-center space-x-3 p-3 rounded-lg border hover:bg-accent transition-colors">
                    <RadioGroupItem value={option.value.toString()} id={`q${currentQ.id}-${option.value}`} />
                    <Label htmlFor={`q${currentQ.id}-${option.value}`} className="flex-1 cursor-pointer">
                      {option.label}
                    </Label>
                  </div>
                ))}
              </div>
            </RadioGroup>
          </CardContent>
        </Card>

        {/* NavegaÃ§Ã£o */}
        <div className="flex justify-between">
          <Button
            variant="outline"
            onClick={handlePrevious}
            disabled={currentQuestion === 0}
          >
            <ArrowLeft className="w-4 h-4 mr-2" />
            Anterior
          </Button>

          {currentQuestion < questions.length - 1 ? (
            <Button onClick={handleNext}>
              PrÃ³xima
            </Button>
          ) : (
            <Button
              onClick={handleFinish}
              disabled={Object.keys(responses).length < questions.length}
            >
              <CheckCircle2 className="w-4 h-4 mr-2" />
              Concluir Teste
            </Button>
          )}
        </div>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/TestCareerAnchors.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { toast } from "sonner";
import { Loader2, Anchor, CheckCircle2, ArrowLeft, ArrowRight, TrendingUp } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { APP_LOGO } from "@/const";

/**
 * PÃ¡gina de Teste de Ã‚ncoras de Carreira (Edgar Schein)
 * 40 perguntas avaliando 8 Ã¢ncoras de motivaÃ§Ã£o profissional
 */

export default function TestCareerAnchors() {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [responses, setResponses] = useState<Record<number, number>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showEmailForm, setShowEmailForm] = useState(false);
  const [email, setEmail] = useState("");
  const [testCompleted, setTestCompleted] = useState(false);
  const [result, setResult] = useState<any>(null);

  // Buscar perguntas de Ã‚ncoras de Carreira
  const { data: questions, isLoading } = trpc.psychometric.getQuestionsPublic.useQuery({ testType: "careeranchors" });

  // Mutation para submeter teste
  const submitMutation = trpc.psychometric.submitTestPublic.useMutation({
    onSuccess: (data) => {
      setResult(data);
      setTestCompleted(true);
      setIsSubmitting(false);
      toast.success(`ParabÃ©ns! Teste de Ã‚ncoras de Carreira concluÃ­do!`);
    },
    onError: (error) => {
      toast.error(`Erro ao submeter teste: ${error.message}`);
      setIsSubmitting(false);
    },
  });

  const handleResponseChange = (questionId: number, score: number) => {
    setResponses({ ...responses, [questionId]: score });
  };

  const handleNext = () => {
    if (!questions) return;
    
    const currentQuestionId = questions[currentQuestion].id;
    if (!responses[currentQuestionId]) {
      toast.error("Por favor, selecione uma resposta antes de continuar");
      return;
    }

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
    }
  };

  const handleFinish = () => {
    if (!questions) return;

    const unanswered = questions.filter(q => !responses[q.id]);
    if (unanswered.length > 0) {
      toast.error(`Ainda faltam ${unanswered.length} pergunta(s) para responder`);
      return;
    }

    setShowEmailForm(true);
  };

  const handleSubmit = () => {
    if (!email || !email.includes('@')) {
      toast.error("Por favor, insira um email vÃ¡lido");
      return;
    }

    setIsSubmitting(true);
    const formattedResponses = Object.entries(responses).map(([questionId, score]) => ({
      questionId: parseInt(questionId),
      score,
    }));

    submitMutation.mutate({
      testType: "careeranchors",
      email: email,
      responses: formattedResponses,
    });
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-teal-50 via-cyan-50 to-white flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 animate-spin text-teal-600 mx-auto mb-4" />
          <p className="text-muted-foreground">Carregando teste...</p>
        </div>
      </div>
    );
  }

  if (!questions || questions.length === 0) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-teal-50 via-cyan-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md">
          <CardHeader>
            <CardTitle>Teste de Ã‚ncoras de Carreira</CardTitle>
            <CardDescription>Nenhuma pergunta encontrada</CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  // Tela de resultado
  if (testCompleted && result) {
    const careerAnchors = [
      { key: 'competencia_tecnica', label: 'CompetÃªncia TÃ©cnica', color: 'text-blue-600', bg: 'bg-blue-50', icon: 'ðŸ”§' },
      { key: 'competencia_gerencial', label: 'CompetÃªncia Gerencial', color: 'text-purple-600', bg: 'bg-purple-50', icon: 'ðŸ‘”' },
      { key: 'autonomia', label: 'Autonomia/IndependÃªncia', color: 'text-green-600', bg: 'bg-green-50', icon: 'ðŸ¦…' },
      { key: 'seguranca', label: 'SeguranÃ§a/Estabilidade', color: 'text-gray-600', bg: 'bg-gray-50', icon: 'ðŸ›¡ï¸' },
      { key: 'criatividade_empreendedora', label: 'Criatividade Empreendedora', color: 'text-orange-600', bg: 'bg-orange-50', icon: 'ðŸ’¡' },
      { key: 'servico', label: 'ServiÃ§o/DedicaÃ§Ã£o', color: 'text-pink-600', bg: 'bg-pink-50', icon: 'â¤ï¸' },
      { key: 'desafio', label: 'Desafio Puro', color: 'text-red-600', bg: 'bg-red-50', icon: 'ðŸŽ¯' },
      { key: 'estilo_vida', label: 'Estilo de Vida', color: 'text-teal-600', bg: 'bg-teal-50', icon: 'âš–ï¸' },
    ];

    // Ordenar Ã¢ncoras por pontuaÃ§Ã£o
    const sortedAnchors = careerAnchors
      .map(anchor => ({
        ...anchor,
        score: result.profile?.[anchor.key] || 0
      }))
      .sort((a, b) => b.score - a.score);

    const topAnchor = sortedAnchors[0];

    return (
      <div className="min-h-screen bg-gradient-to-br from-teal-50 via-cyan-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-4xl w-full">
          <CardHeader className="text-center">
            <div className="mx-auto mb-4 w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center">
              <CheckCircle2 className="w-10 h-10 text-teal-600" />
            </div>
            <CardTitle className="text-2xl">Teste ConcluÃ­do com Sucesso!</CardTitle>
            <CardDescription className="text-base mt-2">
              Obrigado por completar o Teste de Ã‚ncoras de Carreira (Edgar Schein)!
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* Ã‚ncora Principal */}
            <div className={`${topAnchor.bg} border-2 border-teal-300 rounded-lg p-6`}>
              <div className="flex items-center gap-3 mb-3">
                <div className="text-4xl">{topAnchor.icon}</div>
                <div>
                  <h3 className="font-semibold text-xl">Sua Ã‚ncora Principal</h3>
                  <p className="text-sm text-muted-foreground">A motivaÃ§Ã£o que mais guia sua carreira</p>
                </div>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-lg font-medium">{topAnchor.label}</span>
                <span className={`text-3xl font-bold ${topAnchor.color}`}>{topAnchor.score.toFixed(1)}</span>
              </div>
              <Progress value={topAnchor.score} className="h-3 mt-2" />
            </div>

            {/* Todas as Ã‚ncoras */}
            <div className="bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-lg p-6">
              <h3 className="font-semibold text-xl mb-4 flex items-center gap-2">
                <Anchor className="w-6 h-6 text-teal-600" />
                Seu Perfil Completo de Ã‚ncoras
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {sortedAnchors.map((anchor, index) => (
                  <div key={anchor.key} className={`${anchor.bg} p-4 rounded-lg border ${index === 0 ? 'ring-2 ring-teal-400' : ''}`}>
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-2xl">{anchor.icon}</span>
                      <div className="flex-1">
                        <div className="font-medium text-sm">{anchor.label}</div>
                        {index === 0 && <div className="text-xs text-teal-600 font-semibold">â­ Principal</div>}
                      </div>
                      <span className={`text-xl font-bold ${anchor.color}`}>{anchor.score.toFixed(1)}</span>
                    </div>
                    <Progress value={anchor.score} className="h-2" />
                  </div>
                ))}
              </div>
            </div>

            {/* InterpretaÃ§Ã£o */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 className="font-semibold mb-2 flex items-center gap-2">
                <TrendingUp className="w-5 h-5" />
                InterpretaÃ§Ã£o dos Resultados
              </h4>
              <p className="text-sm text-muted-foreground mb-2">
                As <strong>Ã‚ncoras de Carreira de Edgar Schein</strong> representam os valores e motivaÃ§Ãµes 
                que guiam suas decisÃµes profissionais. Sua Ã¢ncora principal Ã© <strong>{topAnchor.label}</strong>, 
                o que significa que esta Ã© a necessidade mais importante para sua satisfaÃ§Ã£o profissional.
              </p>
              <p className="text-sm text-muted-foreground">
                Ã‰ normal ter pontuaÃ§Ãµes altas em mÃºltiplas Ã¢ncoras, mas geralmente uma ou duas se destacam 
                como as mais importantes para vocÃª.
              </p>
            </div>

            {/* DescriÃ§Ãµes das Ã‚ncoras */}
            <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <h4 className="font-semibold mb-3">ðŸ“– O que cada Ã¢ncora significa:</h4>
              <div className="space-y-2 text-sm">
                <p><strong>ðŸ”§ CompetÃªncia TÃ©cnica:</strong> Valoriza expertise e especializaÃ§Ã£o em sua Ã¡rea</p>
                <p><strong>ðŸ‘” CompetÃªncia Gerencial:</strong> Aspira a posiÃ§Ãµes de lideranÃ§a e gestÃ£o</p>
                <p><strong>ðŸ¦… Autonomia:</strong> Necessita de liberdade e independÃªncia no trabalho</p>
                <p><strong>ðŸ›¡ï¸ SeguranÃ§a:</strong> Valoriza estabilidade e previsibilidade</p>
                <p><strong>ðŸ’¡ Criatividade Empreendedora:</strong> Motivado por inovaÃ§Ã£o e criaÃ§Ã£o</p>
                <p><strong>â¤ï¸ ServiÃ§o:</strong> Quer fazer diferenÃ§a positiva no mundo</p>
                <p><strong>ðŸŽ¯ Desafio:</strong> Busca problemas complexos e obstÃ¡culos para superar</p>
                <p><strong>âš–ï¸ Estilo de Vida:</strong> Prioriza equilÃ­brio entre vida pessoal e profissional</p>
              </div>
            </div>

            {/* PrÃ³ximos Passos */}
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <h4 className="font-semibold mb-2">âœ‰ï¸ PrÃ³ximos Passos</h4>
              <p className="text-sm text-muted-foreground">
                Os resultados foram enviados para <strong>{email}</strong>. 
                O RH da sua empresa terÃ¡ acesso aos resultados para apoiar seu planejamento de carreira 
                e desenvolvimento profissional alinhado com suas motivaÃ§Ãµes.
              </p>
            </div>

            <Button 
              onClick={() => window.location.href = '/'} 
              className="w-full"
              size="lg"
            >
              Voltar ao InÃ­cio
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // FormulÃ¡rio de email
  if (showEmailForm) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-teal-50 via-cyan-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader className="text-center">
            <Anchor className="w-12 h-12 text-teal-600 mx-auto mb-2" />
            <CardTitle>Quase lÃ¡!</CardTitle>
            <CardDescription>
              Insira seu email para receber os resultados
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                placeholder="seu.email@empresa.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSubmit()}
              />
            </div>
            <div className="flex gap-2">
              <Button
                variant="outline"
                onClick={() => setShowEmailForm(false)}
                className="flex-1"
              >
                Voltar
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="flex-1"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Enviando...
                  </>
                ) : (
                  'Enviar Teste'
                )}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // QuestionÃ¡rio
  const currentQ = questions[currentQuestion];
  const progress = ((currentQuestion + 1) / questions.length) * 100;
  const answeredCount = Object.keys(responses).length;

  return (
    <div className="min-h-screen bg-gradient-to-br from-teal-50 via-cyan-50 to-white">
      {/* Header */}
      <div className="bg-white border-b shadow-sm">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {APP_LOGO && <img src={APP_LOGO} alt="Logo" className="h-8 w-8" />}
              <div>
                <h1 className="text-xl font-bold">Teste de Ã‚ncoras de Carreira</h1>
                <p className="text-sm text-muted-foreground">Modelo de Edgar Schein</p>
              </div>
            </div>
            <div className="text-right">
              <div className="text-sm font-medium">
                Pergunta {currentQuestion + 1} de {questions.length}
              </div>
              <div className="text-xs text-muted-foreground">
                {answeredCount} respondidas
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Progress Bar */}
      <div className="bg-white border-b">
        <div className="container mx-auto px-4 py-3">
          <Progress value={progress} className="h-2" />
        </div>
      </div>

      {/* Question Card */}
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-3xl mx-auto">
          <CardHeader>
            <div className="flex items-start gap-4">
              <div className="w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center flex-shrink-0">
                <span className="text-teal-600 font-bold">{currentQuestion + 1}</span>
              </div>
              <div className="flex-1">
                <CardTitle className="text-xl mb-2">{currentQ.questionText}</CardTitle>
                <CardDescription>
                  Selecione o quanto vocÃª concorda com a afirmaÃ§Ã£o
                </CardDescription>
              </div>
            </div>
          </CardHeader>
          <CardContent className="space-y-6">
            <RadioGroup
              value={responses[currentQ.id]?.toString()}
              onValueChange={(value) => handleResponseChange(currentQ.id, parseInt(value))}
            >
              <div className="space-y-3">
                {[
                  { value: 1, label: "Discordo Totalmente", color: "border-red-200 hover:bg-red-50" },
                  { value: 2, label: "Discordo", color: "border-orange-200 hover:bg-orange-50" },
                  { value: 3, label: "Neutro", color: "border-gray-200 hover:bg-gray-50" },
                  { value: 4, label: "Concordo", color: "border-blue-200 hover:bg-blue-50" },
                  { value: 5, label: "Concordo Totalmente", color: "border-green-200 hover:bg-green-50" },
                ].map((option) => (
                  <div key={option.value} className={`flex items-center space-x-3 border-2 rounded-lg p-4 cursor-pointer transition-all ${option.color} ${responses[currentQ.id] === option.value ? 'ring-2 ring-teal-500 bg-teal-50' : ''}`}>
                    <RadioGroupItem value={option.value.toString()} id={`option-${option.value}`} />
                    <Label htmlFor={`option-${option.value}`} className="flex-1 cursor-pointer font-medium">
                      {option.label}
                    </Label>
                  </div>
                ))}
              </div>
            </RadioGroup>

            {/* Navigation Buttons */}
            <div className="flex gap-3 pt-4">
              <Button
                variant="outline"
                onClick={handlePrevious}
                disabled={currentQuestion === 0}
                className="flex-1"
              >
                <ArrowLeft className="w-4 h-4 mr-2" />
                Anterior
              </Button>
              {currentQuestion < questions.length - 1 ? (
                <Button
                  onClick={handleNext}
                  className="flex-1"
                >
                  PrÃ³xima
                  <ArrowRight className="w-4 h-4 ml-2" />
                </Button>
              ) : (
                <Button
                  onClick={handleFinish}
                  className="flex-1 bg-green-600 hover:bg-green-700"
                >
                  <CheckCircle2 className="w-4 h-4 mr-2" />
                  Finalizar Teste
                </Button>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/TestDISC.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { toast } from "sonner";
import { Loader2, Brain, CheckCircle2, Mail, ArrowLeft } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { APP_LOGO, APP_TITLE } from "@/const";

/**
 * PÃ¡gina de Teste DISC (VersÃ£o PÃºblica - sem necessidade de login)
 * QuestionÃ¡rio interativo com 40 perguntas
 */

export default function TestDISC() {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [responses, setResponses] = useState<Record<number, number>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showEmailForm, setShowEmailForm] = useState(false);
  const [email, setEmail] = useState("");
  const [testCompleted, setTestCompleted] = useState(false);
  const [result, setResult] = useState<any>(null);

  // Buscar perguntas DISC (endpoint pÃºblico)
  const { data: questions, isLoading } = trpc.psychometric.getQuestionsPublic.useQuery({ testType: "disc" });

  // Mutation para submeter teste (endpoint pÃºblico)
  const submitMutation = trpc.psychometric.submitTestPublic.useMutation({
    onSuccess: (data) => {
      setResult(data);
      setTestCompleted(true);
      setIsSubmitting(false);
      toast.success(`ParabÃ©ns, ${data.employeeName}! Teste DISC concluÃ­do com sucesso!`);
    },
    onError: (error) => {
      toast.error(`Erro ao submeter teste: ${error.message}`);
      setIsSubmitting(false);
    },
  });

  const handleResponseChange = (questionId: number, score: number) => {
    setResponses({ ...responses, [questionId]: score });
  };

  const handleNext = () => {
    if (!questions) return;
    
    const currentQuestionId = questions[currentQuestion].id;
    if (!responses[currentQuestionId]) {
      toast.error("Por favor, selecione uma resposta antes de continuar");
      return;
    }

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
    }
  };

  const handleFinish = () => {
    if (!questions) return;

    // Verificar se todas as perguntas foram respondidas
    const unanswered = questions.filter(q => !responses[q.id]);
    if (unanswered.length > 0) {
      toast.error(`Ainda faltam ${unanswered.length} pergunta(s) para responder`);
      return;
    }

    // Mostrar formulÃ¡rio de email
    setShowEmailForm(true);
  };

  const handleSubmit = () => {
    if (!email || !email.includes('@')) {
      toast.error("Por favor, insira um email vÃ¡lido");
      return;
    }

    setIsSubmitting(true);
    const formattedResponses = Object.entries(responses).map(([questionId, score]) => ({
      questionId: parseInt(questionId),
      score,
    }));

    submitMutation.mutate({
      testType: "disc",
      email: email,
      responses: formattedResponses,
    });
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 animate-spin text-primary mx-auto mb-4" />
          <p className="text-muted-foreground">Carregando teste...</p>
        </div>
      </div>
    );
  }

  if (!questions || questions.length === 0) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md">
          <CardHeader>
            <CardTitle>Teste DISC</CardTitle>
            <CardDescription>Nenhuma pergunta encontrada</CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  // Tela de resultado
  if (testCompleted && result) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-2xl w-full">
          <CardHeader className="text-center">
            <div className="mx-auto mb-4 w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
              <CheckCircle2 className="w-10 h-10 text-green-600" />
            </div>
            <CardTitle className="text-2xl">Teste ConcluÃ­do com Sucesso!</CardTitle>
            <CardDescription className="text-base mt-2">
              Obrigado por completar o Teste DISC, {result.employeeName}!
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <h3 className="font-semibold text-lg mb-2">Seu Perfil DISC</h3>
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">DominÃ¢ncia (D)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.D?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">InfluÃªncia (I)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.I?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Estabilidade (S)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.S?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Conformidade (C)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.C?.toFixed(1) || '0.0'}</div>
                </div>
              </div>
              {result.profile.dominantProfile && (
                <div className="mt-4 p-3 bg-white rounded border">
                  <div className="text-sm text-muted-foreground">Perfil Dominante</div>
                  <div className="text-xl font-bold text-orange-600">{result.profile.dominantProfile}</div>
                </div>
              )}
            </div>
            <p className="text-sm text-center text-muted-foreground">
              Seus resultados foram salvos e estÃ£o disponÃ­veis para anÃ¡lise pela equipe de RH.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  // FormulÃ¡rio de email
  if (showEmailForm) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader>
            <div className="mx-auto mb-4 w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center">
              <Mail className="w-10 h-10 text-orange-600" />
            </div>
            <CardTitle className="text-center">Quase lÃ¡!</CardTitle>
            <CardDescription className="text-center">
              Para finalizar, precisamos do seu email para associar os resultados
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="email">Email Corporativo</Label>
              <Input
                id="email"
                type="email"
                placeholder="seu.email@uisa.com.br"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="mt-2"
              />
              <p className="text-xs text-muted-foreground mt-2">
                Use o mesmo email que recebeu o convite para este teste
              </p>
            </div>
            <div className="flex gap-3">
              <Button
                variant="outline"
                onClick={() => setShowEmailForm(false)}
                className="flex-1"
              >
                <ArrowLeft className="w-4 h-4 mr-2" />
                Voltar
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="flex-1"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Enviando...
                  </>
                ) : (
                  <>
                    <CheckCircle2 className="w-4 h-4 mr-2" />
                    Finalizar
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const progress = (Object.keys(responses).length / questions.length) * 100;
  const currentQ = questions[currentQuestion];

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white">
      <div className="max-w-3xl mx-auto p-4 py-8 space-y-6">
        {/* Header */}
        <div className="text-center">
          <div className="flex items-center justify-center gap-3 mb-4">
            <Brain className="h-10 w-10 text-orange-600" />
            <h1 className="text-3xl font-bold tracking-tight">Teste DISC</h1>
          </div>
          <p className="text-muted-foreground">
            Avalie cada afirmaÃ§Ã£o de acordo com o quanto vocÃª concorda
          </p>
        </div>

        {/* Barra de Progresso */}
        <Card>
          <CardContent className="pt-6">
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span>Progresso</span>
                <span>{Object.keys(responses).length} de {questions.length} perguntas</span>
              </div>
              <Progress value={progress} className="h-2" />
            </div>
          </CardContent>
        </Card>

        {/* Pergunta Atual */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">
              Pergunta {currentQuestion + 1} de {questions.length}
            </CardTitle>
            <CardDescription className="text-base mt-4">
              {currentQ.questionText}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <RadioGroup
              value={responses[currentQ.id]?.toString()}
              onValueChange={(value) => handleResponseChange(currentQ.id, parseInt(value))}
            >
              <div className="space-y-3">
                {[
                  { value: 1, label: "1 - Discordo totalmente" },
                  { value: 2, label: "2 - Discordo parcialmente" },
                  { value: 3, label: "3 - Neutro" },
                  { value: 4, label: "4 - Concordo parcialmente" },
                  { value: 5, label: "5 - Concordo totalmente" },
                ].map((option) => (
                  <div key={option.value} className="flex items-center space-x-3 p-3 rounded-lg border hover:bg-accent transition-colors">
                    <RadioGroupItem value={option.value.toString()} id={`q${currentQ.id}-${option.value}`} />
                    <Label htmlFor={`q${currentQ.id}-${option.value}`} className="flex-1 cursor-pointer">
                      {option.label}
                    </Label>
                  </div>
                ))}
              </div>
            </RadioGroup>
          </CardContent>
        </Card>

        {/* NavegaÃ§Ã£o */}
        <div className="flex justify-between">
          <Button
            variant="outline"
            onClick={handlePrevious}
            disabled={currentQuestion === 0}
          >
            <ArrowLeft className="w-4 h-4 mr-2" />
            Anterior
          </Button>

          {currentQuestion < questions.length - 1 ? (
            <Button onClick={handleNext}>
              PrÃ³xima
            </Button>
          ) : (
            <Button
              onClick={handleFinish}
              disabled={Object.keys(responses).length < questions.length}
            >
              <CheckCircle2 className="w-4 h-4 mr-2" />
              Concluir Teste
            </Button>
          )}
        </div>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/TestIE.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { toast } from "sonner";
import { Loader2, Brain, CheckCircle2, Mail, ArrowLeft } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { APP_LOGO, APP_TITLE } from "@/const";

/**
 * PÃ¡gina de Teste de InteligÃªncia Emocional (VersÃ£o PÃºblica - sem necessidade de login)
 * QuestionÃ¡rio interativo com 25 perguntas
 */

export default function TestIE() {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [responses, setResponses] = useState<Record<number, number>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showEmailForm, setShowEmailForm] = useState(false);
  const [email, setEmail] = useState("");
  const [testCompleted, setTestCompleted] = useState(false);
  const [result, setResult] = useState<any>(null);

  // Buscar perguntas DISC (endpoint pÃºblico)
  const { data: questions, isLoading } = trpc.psychometric.getQuestionsPublic.useQuery({ testType: "ie" });

  // Mutation para submeter teste (endpoint pÃºblico)
  const submitMutation = trpc.psychometric.submitTestPublic.useMutation({
    onSuccess: (data) => {
      setResult(data);
      setTestCompleted(true);
      setIsSubmitting(false);
      toast.success(`ParabÃ©ns, ${data.employeeName}! Teste de InteligÃªncia Emocional concluÃ­do com sucesso!`);
    },
    onError: (error) => {
      toast.error(`Erro ao submeter teste: ${error.message}`);
      setIsSubmitting(false);
    },
  });

  const handleResponseChange = (questionId: number, score: number) => {
    setResponses({ ...responses, [questionId]: score });
  };

  const handleNext = () => {
    if (!questions) return;
    
    const currentQuestionId = questions[currentQuestion].id;
    if (!responses[currentQuestionId]) {
      toast.error("Por favor, selecione uma resposta antes de continuar");
      return;
    }

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
    }
  };

  const handleFinish = () => {
    if (!questions) return;

    // Verificar se todas as perguntas foram respondidas
    const unanswered = questions.filter(q => !responses[q.id]);
    if (unanswered.length > 0) {
      toast.error(`Ainda faltam ${unanswered.length} pergunta(s) para responder`);
      return;
    }

    // Mostrar formulÃ¡rio de email
    setShowEmailForm(true);
  };

  const handleSubmit = () => {
    if (!email || !email.includes('@')) {
      toast.error("Por favor, insira um email vÃ¡lido");
      return;
    }

    setIsSubmitting(true);
    const formattedResponses = Object.entries(responses).map(([questionId, score]) => ({
      questionId: parseInt(questionId),
      score,
    }));

    submitMutation.mutate({
      testType: "ie",
      email: email,
      responses: formattedResponses,
    });
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 animate-spin text-primary mx-auto mb-4" />
          <p className="text-muted-foreground">Carregando teste...</p>
        </div>
      </div>
    );
  }

  if (!questions || questions.length === 0) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md">
          <CardHeader>
            <CardTitle>Teste de InteligÃªncia Emocional</CardTitle>
            <CardDescription>Nenhuma pergunta encontrada</CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  // Tela de resultado
  if (testCompleted && result) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-2xl w-full">
          <CardHeader className="text-center">
            <div className="mx-auto mb-4 w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
              <CheckCircle2 className="w-10 h-10 text-green-600" />
            </div>
            <CardTitle className="text-2xl">Teste ConcluÃ­do com Sucesso!</CardTitle>
            <CardDescription className="text-base mt-2">
              Obrigado por completar o Teste de InteligÃªncia Emocional, {result.employeeName}!
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <h3 className="font-semibold text-lg mb-2">Seu Perfil de InteligÃªncia Emocional</h3>
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">DominÃ¢ncia (D)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.D?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">InfluÃªncia (I)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.I?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Estabilidade (S)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.S?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Conformidade (C)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.C?.toFixed(1) || '0.0'}</div>
                </div>
              </div>
              {result.profile.dominantProfile && (
                <div className="mt-4 p-3 bg-white rounded border">
                  <div className="text-sm text-muted-foreground">Perfil Dominante</div>
                  <div className="text-xl font-bold text-orange-600">{result.profile.dominantProfile}</div>
                </div>
              )}
            </div>
            <p className="text-sm text-center text-muted-foreground">
              Seus resultados foram salvos e estÃ£o disponÃ­veis para anÃ¡lise pela equipe de RH.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  // FormulÃ¡rio de email
  if (showEmailForm) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader>
            <div className="mx-auto mb-4 w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center">
              <Mail className="w-10 h-10 text-orange-600" />
            </div>
            <CardTitle className="text-center">Quase lÃ¡!</CardTitle>
            <CardDescription className="text-center">
              Para finalizar, precisamos do seu email para associar os resultados
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="email">Email Corporativo</Label>
              <Input
                id="email"
                type="email"
                placeholder="seu.email@uisa.com.br"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="mt-2"
              />
              <p className="text-xs text-muted-foreground mt-2">
                Use o mesmo email que recebeu o convite para este teste
              </p>
            </div>
            <div className="flex gap-3">
              <Button
                variant="outline"
                onClick={() => setShowEmailForm(false)}
                className="flex-1"
              >
                <ArrowLeft className="w-4 h-4 mr-2" />
                Voltar
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="flex-1"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Enviando...
                  </>
                ) : (
                  <>
                    <CheckCircle2 className="w-4 h-4 mr-2" />
                    Finalizar
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const progress = (Object.keys(responses).length / questions.length) * 100;
  const currentQ = questions[currentQuestion];

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white">
      <div className="max-w-3xl mx-auto p-4 py-8 space-y-6">
        {/* Header */}
        <div className="text-center">
          <div className="flex items-center justify-center gap-3 mb-4">
            <Brain className="h-10 w-10 text-orange-600" />
            <h1 className="text-3xl font-bold tracking-tight">Teste de InteligÃªncia Emocional</h1>
          </div>
          <p className="text-muted-foreground">
            Avalie cada afirmaÃ§Ã£o de acordo com o quanto vocÃª concorda
          </p>
        </div>

        {/* Barra de Progresso */}
        <Card>
          <CardContent className="pt-6">
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span>Progresso</span>
                <span>{Object.keys(responses).length} de {questions.length} perguntas</span>
              </div>
              <Progress value={progress} className="h-2" />
            </div>
          </CardContent>
        </Card>

        {/* Pergunta Atual */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">
              Pergunta {currentQuestion + 1} de {questions.length}
            </CardTitle>
            <CardDescription className="text-base mt-4">
              {currentQ.questionText}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <RadioGroup
              value={responses[currentQ.id]?.toString()}
              onValueChange={(value) => handleResponseChange(currentQ.id, parseInt(value))}
            >
              <div className="space-y-3">
                {[
                  { value: 1, label: "1 - Discordo totalmente" },
                  { value: 2, label: "2 - Discordo parcialmente" },
                  { value: 3, label: "3 - Neutro" },
                  { value: 4, label: "4 - Concordo parcialmente" },
                  { value: 5, label: "5 - Concordo totalmente" },
                ].map((option) => (
                  <div key={option.value} className="flex items-center space-x-3 p-3 rounded-lg border hover:bg-accent transition-colors">
                    <RadioGroupItem value={option.value.toString()} id={`q${currentQ.id}-${option.value}`} />
                    <Label htmlFor={`q${currentQ.id}-${option.value}`} className="flex-1 cursor-pointer">
                      {option.label}
                    </Label>
                  </div>
                ))}
              </div>
            </RadioGroup>
          </CardContent>
        </Card>

        {/* NavegaÃ§Ã£o */}
        <div className="flex justify-between">
          <Button
            variant="outline"
            onClick={handlePrevious}
            disabled={currentQuestion === 0}
          >
            <ArrowLeft className="w-4 h-4 mr-2" />
            Anterior
          </Button>

          {currentQuestion < questions.length - 1 ? (
            <Button onClick={handleNext}>
              PrÃ³xima
            </Button>
          ) : (
            <Button
              onClick={handleFinish}
              disabled={Object.keys(responses).length < questions.length}
            >
              <CheckCircle2 className="w-4 h-4 mr-2" />
              Concluir Teste
            </Button>
          )}
        </div>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/TestLeadership.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { toast } from "sonner";
import { Loader2, Users, CheckCircle2, ArrowLeft, ArrowRight } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { APP_LOGO } from "@/const";

/**
 * PÃ¡gina de Teste de Estilos de LideranÃ§a
 * Baseado em teorias de Lewin, Bass e Goleman
 * 30 perguntas avaliando 6 estilos: AutocrÃ¡tico, DemocrÃ¡tico, Transformacional, Transacional, Coaching, Laissez-faire
 */

export default function TestLeadership() {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [responses, setResponses] = useState<Record<number, number>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showEmailForm, setShowEmailForm] = useState(false);
  const [email, setEmail] = useState("");
  const [testCompleted, setTestCompleted] = useState(false);
  const [result, setResult] = useState<any>(null);

  // Buscar perguntas de LideranÃ§a
  const { data: questions, isLoading } = trpc.psychometric.getQuestionsPublic.useQuery({ testType: "leadership" });

  // Mutation para submeter teste
  const submitMutation = trpc.psychometric.submitTestPublic.useMutation({
    onSuccess: (data) => {
      setResult(data);
      setTestCompleted(true);
      setIsSubmitting(false);
      toast.success(`ParabÃ©ns! Teste de Estilos de LideranÃ§a concluÃ­do!`);
    },
    onError: (error) => {
      toast.error(`Erro ao submeter teste: ${error.message}`);
      setIsSubmitting(false);
    },
  });

  const handleResponseChange = (questionId: number, score: number) => {
    setResponses({ ...responses, [questionId]: score });
  };

  const handleNext = () => {
    if (!questions) return;
    
    const currentQuestionId = questions[currentQuestion].id;
    if (!responses[currentQuestionId]) {
      toast.error("Por favor, selecione uma resposta antes de continuar");
      return;
    }

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
    }
  };

  const handleFinish = () => {
    if (!questions) return;

    const unanswered = questions.filter(q => !responses[q.id]);
    if (unanswered.length > 0) {
      toast.error(`Ainda faltam ${unanswered.length} pergunta(s) para responder`);
      return;
    }

    setShowEmailForm(true);
  };

  const handleSubmit = () => {
    if (!email || !email.includes('@')) {
      toast.error("Por favor, insira um email vÃ¡lido");
      return;
    }

    setIsSubmitting(true);
    const formattedResponses = Object.entries(responses).map(([questionId, score]) => ({
      questionId: parseInt(questionId),
      score,
    }));

    submitMutation.mutate({
      testType: "leadership",
      email: email,
      responses: formattedResponses,
    });
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-white flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 animate-spin text-purple-600 mx-auto mb-4" />
          <p className="text-muted-foreground">Carregando teste...</p>
        </div>
      </div>
    );
  }

  if (!questions || questions.length === 0) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md">
          <CardHeader>
            <CardTitle>Teste de Estilos de LideranÃ§a</CardTitle>
            <CardDescription>Nenhuma pergunta encontrada</CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  // Tela de resultado
  if (testCompleted && result) {
    const leadershipStyles = [
      { key: 'autocratico', label: 'AutocrÃ¡tico', color: 'text-red-600', bg: 'bg-red-50' },
      { key: 'democratico', label: 'DemocrÃ¡tico', color: 'text-blue-600', bg: 'bg-blue-50' },
      { key: 'transformacional', label: 'Transformacional', color: 'text-purple-600', bg: 'bg-purple-50' },
      { key: 'transacional', label: 'Transacional', color: 'text-orange-600', bg: 'bg-orange-50' },
      { key: 'coaching', label: 'Coaching', color: 'text-green-600', bg: 'bg-green-50' },
      { key: 'laissez_faire', label: 'Laissez-faire', color: 'text-gray-600', bg: 'bg-gray-50' },
    ];

    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-3xl w-full">
          <CardHeader className="text-center">
            <div className="mx-auto mb-4 w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center">
              <CheckCircle2 className="w-10 h-10 text-purple-600" />
            </div>
            <CardTitle className="text-2xl">Teste ConcluÃ­do com Sucesso!</CardTitle>
            <CardDescription className="text-base mt-2">
              Obrigado por completar o Teste de Estilos de LideranÃ§a!
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6">
              <h3 className="font-semibold text-xl mb-4 flex items-center gap-2">
                <Users className="w-6 h-6 text-purple-600" />
                Seu Perfil de LideranÃ§a
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {leadershipStyles.map((style) => {
                  const score = result.profile?.[style.key] || 0;
                  return (
                    <div key={style.key} className={`${style.bg} p-4 rounded-lg border`}>
                      <div className="flex items-center justify-between mb-2">
                        <span className="font-medium">{style.label}</span>
                        <span className={`text-2xl font-bold ${style.color}`}>{score.toFixed(1)}</span>
                      </div>
                      <Progress value={score} className="h-2" />
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 className="font-semibold mb-2">ðŸ“Š InterpretaÃ§Ã£o dos Resultados</h4>
              <p className="text-sm text-muted-foreground">
                Seu perfil de lideranÃ§a foi calculado com base em teorias consolidadas (Lewin, Bass, Goleman). 
                PontuaÃ§Ãµes mais altas indicam maior tendÃªncia para aquele estilo. A maioria dos lÃ­deres eficazes 
                combina mÃºltiplos estilos conforme a situaÃ§Ã£o.
              </p>
            </div>

            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <h4 className="font-semibold mb-2">âœ‰ï¸ PrÃ³ximos Passos</h4>
              <p className="text-sm text-muted-foreground">
                Os resultados foram enviados para <strong>{email}</strong>. 
                O RH da sua empresa terÃ¡ acesso aos resultados para apoiar seu desenvolvimento de lideranÃ§a.
              </p>
            </div>

            <Button 
              onClick={() => window.location.href = '/'} 
              className="w-full"
              size="lg"
            >
              Voltar ao InÃ­cio
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // FormulÃ¡rio de email
  if (showEmailForm) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader className="text-center">
            <Users className="w-12 h-12 text-purple-600 mx-auto mb-2" />
            <CardTitle>Quase lÃ¡!</CardTitle>
            <CardDescription>
              Insira seu email para receber os resultados
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                placeholder="seu.email@empresa.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSubmit()}
              />
            </div>
            <div className="flex gap-2">
              <Button
                variant="outline"
                onClick={() => setShowEmailForm(false)}
                className="flex-1"
              >
                Voltar
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="flex-1"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Enviando...
                  </>
                ) : (
                  'Enviar Teste'
                )}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // QuestionÃ¡rio
  const currentQ = questions[currentQuestion];
  const progress = ((currentQuestion + 1) / questions.length) * 100;
  const answeredCount = Object.keys(responses).length;

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-white">
      {/* Header */}
      <div className="bg-white border-b shadow-sm">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {APP_LOGO && <img src={APP_LOGO} alt="Logo" className="h-8 w-8" />}
              <div>
                <h1 className="text-xl font-bold">Teste de Estilos de LideranÃ§a</h1>
                <p className="text-sm text-muted-foreground">Baseado em Lewin, Bass e Goleman</p>
              </div>
            </div>
            <div className="text-right">
              <div className="text-sm font-medium">
                Pergunta {currentQuestion + 1} de {questions.length}
              </div>
              <div className="text-xs text-muted-foreground">
                {answeredCount} respondidas
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Progress Bar */}
      <div className="bg-white border-b">
        <div className="container mx-auto px-4 py-3">
          <Progress value={progress} className="h-2" />
        </div>
      </div>

      {/* Question Card */}
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-3xl mx-auto">
          <CardHeader>
            <div className="flex items-start gap-4">
              <div className="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0">
                <span className="text-purple-600 font-bold">{currentQuestion + 1}</span>
              </div>
              <div className="flex-1">
                <CardTitle className="text-xl mb-2">{currentQ.questionText}</CardTitle>
                <CardDescription>
                  Selecione o quanto vocÃª concorda com a afirmaÃ§Ã£o
                </CardDescription>
              </div>
            </div>
          </CardHeader>
          <CardContent className="space-y-6">
            <RadioGroup
              value={responses[currentQ.id]?.toString()}
              onValueChange={(value) => handleResponseChange(currentQ.id, parseInt(value))}
            >
              <div className="space-y-3">
                {[
                  { value: 1, label: "Discordo Totalmente", color: "border-red-200 hover:bg-red-50" },
                  { value: 2, label: "Discordo", color: "border-orange-200 hover:bg-orange-50" },
                  { value: 3, label: "Neutro", color: "border-gray-200 hover:bg-gray-50" },
                  { value: 4, label: "Concordo", color: "border-blue-200 hover:bg-blue-50" },
                  { value: 5, label: "Concordo Totalmente", color: "border-green-200 hover:bg-green-50" },
                ].map((option) => (
                  <div key={option.value} className={`flex items-center space-x-3 border-2 rounded-lg p-4 cursor-pointer transition-all ${option.color} ${responses[currentQ.id] === option.value ? 'ring-2 ring-purple-500 bg-purple-50' : ''}`}>
                    <RadioGroupItem value={option.value.toString()} id={`option-${option.value}`} />
                    <Label htmlFor={`option-${option.value}`} className="flex-1 cursor-pointer font-medium">
                      {option.label}
                    </Label>
                  </div>
                ))}
              </div>
            </RadioGroup>

            {/* Navigation Buttons */}
            <div className="flex gap-3 pt-4">
              <Button
                variant="outline"
                onClick={handlePrevious}
                disabled={currentQuestion === 0}
                className="flex-1"
              >
                <ArrowLeft className="w-4 h-4 mr-2" />
                Anterior
              </Button>
              {currentQuestion < questions.length - 1 ? (
                <Button
                  onClick={handleNext}
                  className="flex-1"
                >
                  PrÃ³xima
                  <ArrowRight className="w-4 h-4 ml-2" />
                </Button>
              ) : (
                <Button
                  onClick={handleFinish}
                  className="flex-1 bg-green-600 hover:bg-green-700"
                >
                  <CheckCircle2 className="w-4 h-4 mr-2" />
                  Finalizar Teste
                </Button>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/TestMBTI.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { toast } from "sonner";
import { Loader2, Brain, CheckCircle2, Mail, ArrowLeft } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { APP_LOGO, APP_TITLE } from "@/const";

/**
 * PÃ¡gina de Teste MBTI (VersÃ£o PÃºblica - sem necessidade de login)
 * QuestionÃ¡rio interativo com 60 perguntas
 */

export default function TestMBTI() {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [responses, setResponses] = useState<Record<number, number>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showEmailForm, setShowEmailForm] = useState(false);
  const [email, setEmail] = useState("");
  const [testCompleted, setTestCompleted] = useState(false);
  const [result, setResult] = useState<any>(null);

  // Buscar perguntas DISC (endpoint pÃºblico)
  const { data: questions, isLoading } = trpc.psychometric.getQuestionsPublic.useQuery({ testType: "mbti" });

  // Mutation para submeter teste (endpoint pÃºblico)
  const submitMutation = trpc.psychometric.submitTestPublic.useMutation({
    onSuccess: (data) => {
      setResult(data);
      setTestCompleted(true);
      setIsSubmitting(false);
      toast.success(`ParabÃ©ns, ${data.employeeName}! Teste MBTI concluÃ­do com sucesso!`);
    },
    onError: (error) => {
      toast.error(`Erro ao submeter teste: ${error.message}`);
      setIsSubmitting(false);
    },
  });

  const handleResponseChange = (questionId: number, score: number) => {
    setResponses({ ...responses, [questionId]: score });
  };

  const handleNext = () => {
    if (!questions) return;
    
    const currentQuestionId = questions[currentQuestion].id;
    if (!responses[currentQuestionId]) {
      toast.error("Por favor, selecione uma resposta antes de continuar");
      return;
    }

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
    }
  };

  const handleFinish = () => {
    if (!questions) return;

    // Verificar se todas as perguntas foram respondidas
    const unanswered = questions.filter(q => !responses[q.id]);
    if (unanswered.length > 0) {
      toast.error(`Ainda faltam ${unanswered.length} pergunta(s) para responder`);
      return;
    }

    // Mostrar formulÃ¡rio de email
    setShowEmailForm(true);
  };

  const handleSubmit = () => {
    if (!email || !email.includes('@')) {
      toast.error("Por favor, insira um email vÃ¡lido");
      return;
    }

    setIsSubmitting(true);
    const formattedResponses = Object.entries(responses).map(([questionId, score]) => ({
      questionId: parseInt(questionId),
      score,
    }));

    submitMutation.mutate({
      testType: "mbti",
      email: email,
      responses: formattedResponses,
    });
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 animate-spin text-primary mx-auto mb-4" />
          <p className="text-muted-foreground">Carregando teste...</p>
        </div>
      </div>
    );
  }

  if (!questions || questions.length === 0) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md">
          <CardHeader>
            <CardTitle>Teste MBTI</CardTitle>
            <CardDescription>Nenhuma pergunta encontrada</CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  // Tela de resultado
  if (testCompleted && result) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-2xl w-full">
          <CardHeader className="text-center">
            <div className="mx-auto mb-4 w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
              <CheckCircle2 className="w-10 h-10 text-green-600" />
            </div>
            <CardTitle className="text-2xl">Teste ConcluÃ­do com Sucesso!</CardTitle>
            <CardDescription className="text-base mt-2">
              Obrigado por completar o Teste MBTI, {result.employeeName}!
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <h3 className="font-semibold text-lg mb-2">Seu Perfil MBTI</h3>
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">DominÃ¢ncia (D)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.D?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">InfluÃªncia (I)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.I?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Estabilidade (S)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.S?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Conformidade (C)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.C?.toFixed(1) || '0.0'}</div>
                </div>
              </div>
              {result.profile.dominantProfile && (
                <div className="mt-4 p-3 bg-white rounded border">
                  <div className="text-sm text-muted-foreground">Perfil Dominante</div>
                  <div className="text-xl font-bold text-orange-600">{result.profile.dominantProfile}</div>
                </div>
              )}
            </div>
            <p className="text-sm text-center text-muted-foreground">
              Seus resultados foram salvos e estÃ£o disponÃ­veis para anÃ¡lise pela equipe de RH.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  // FormulÃ¡rio de email
  if (showEmailForm) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader>
            <div className="mx-auto mb-4 w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center">
              <Mail className="w-10 h-10 text-orange-600" />
            </div>
            <CardTitle className="text-center">Quase lÃ¡!</CardTitle>
            <CardDescription className="text-center">
              Para finalizar, precisamos do seu email para associar os resultados
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="email">Email Corporativo</Label>
              <Input
                id="email"
                type="email"
                placeholder="seu.email@uisa.com.br"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="mt-2"
              />
              <p className="text-xs text-muted-foreground mt-2">
                Use o mesmo email que recebeu o convite para este teste
              </p>
            </div>
            <div className="flex gap-3">
              <Button
                variant="outline"
                onClick={() => setShowEmailForm(false)}
                className="flex-1"
              >
                <ArrowLeft className="w-4 h-4 mr-2" />
                Voltar
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="flex-1"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Enviando...
                  </>
                ) : (
                  <>
                    <CheckCircle2 className="w-4 h-4 mr-2" />
                    Finalizar
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const progress = (Object.keys(responses).length / questions.length) * 100;
  const currentQ = questions[currentQuestion];

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white">
      <div className="max-w-3xl mx-auto p-4 py-8 space-y-6">
        {/* Header */}
        <div className="text-center">
          <div className="flex items-center justify-center gap-3 mb-4">
            <Brain className="h-10 w-10 text-orange-600" />
            <h1 className="text-3xl font-bold tracking-tight">Teste MBTI</h1>
          </div>
          <p className="text-muted-foreground">
            Avalie cada afirmaÃ§Ã£o de acordo com o quanto vocÃª concorda
          </p>
        </div>

        {/* Barra de Progresso */}
        <Card>
          <CardContent className="pt-6">
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span>Progresso</span>
                <span>{Object.keys(responses).length} de {questions.length} perguntas</span>
              </div>
              <Progress value={progress} className="h-2" />
            </div>
          </CardContent>
        </Card>

        {/* Pergunta Atual */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">
              Pergunta {currentQuestion + 1} de {questions.length}
            </CardTitle>
            <CardDescription className="text-base mt-4">
              {currentQ.questionText}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <RadioGroup
              value={responses[currentQ.id]?.toString()}
              onValueChange={(value) => handleResponseChange(currentQ.id, parseInt(value))}
            >
              <div className="space-y-3">
                {[
                  { value: 1, label: "1 - Discordo totalmente" },
                  { value: 2, label: "2 - Discordo parcialmente" },
                  { value: 3, label: "3 - Neutro" },
                  { value: 4, label: "4 - Concordo parcialmente" },
                  { value: 5, label: "5 - Concordo totalmente" },
                ].map((option) => (
                  <div key={option.value} className="flex items-center space-x-3 p-3 rounded-lg border hover:bg-accent transition-colors">
                    <RadioGroupItem value={option.value.toString()} id={`q${currentQ.id}-${option.value}`} />
                    <Label htmlFor={`q${currentQ.id}-${option.value}`} className="flex-1 cursor-pointer">
                      {option.label}
                    </Label>
                  </div>
                ))}
              </div>
            </RadioGroup>
          </CardContent>
        </Card>

        {/* NavegaÃ§Ã£o */}
        <div className="flex justify-between">
          <Button
            variant="outline"
            onClick={handlePrevious}
            disabled={currentQuestion === 0}
          >
            <ArrowLeft className="w-4 h-4 mr-2" />
            Anterior
          </Button>

          {currentQuestion < questions.length - 1 ? (
            <Button onClick={handleNext}>
              PrÃ³xima
            </Button>
          ) : (
            <Button
              onClick={handleFinish}
              disabled={Object.keys(responses).length < questions.length}
            >
              <CheckCircle2 className="w-4 h-4 mr-2" />
              Concluir Teste
            </Button>
          )}
        </div>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/TestVARK.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { toast } from "sonner";
import { Loader2, Brain, CheckCircle2, Mail, ArrowLeft } from "lucide-react";
import { trpc } from "@/lib/trpc";
import { APP_LOGO, APP_TITLE } from "@/const";

/**
 * PÃ¡gina de Teste VARK (VersÃ£o PÃºblica - sem necessidade de login)
 * QuestionÃ¡rio interativo com 20 perguntas
 */

export default function TestVARK() {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [responses, setResponses] = useState<Record<number, number>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showEmailForm, setShowEmailForm] = useState(false);
  const [email, setEmail] = useState("");
  const [testCompleted, setTestCompleted] = useState(false);
  const [result, setResult] = useState<any>(null);

  // Buscar perguntas DISC (endpoint pÃºblico)
  const { data: questions, isLoading } = trpc.psychometric.getQuestionsPublic.useQuery({ testType: "vark" });

  // Mutation para submeter teste (endpoint pÃºblico)
  const submitMutation = trpc.psychometric.submitTestPublic.useMutation({
    onSuccess: (data) => {
      setResult(data);
      setTestCompleted(true);
      setIsSubmitting(false);
      toast.success(`ParabÃ©ns, ${data.employeeName}! Teste VARK concluÃ­do com sucesso!`);
    },
    onError: (error) => {
      toast.error(`Erro ao submeter teste: ${error.message}`);
      setIsSubmitting(false);
    },
  });

  const handleResponseChange = (questionId: number, score: number) => {
    setResponses({ ...responses, [questionId]: score });
  };

  const handleNext = () => {
    if (!questions) return;
    
    const currentQuestionId = questions[currentQuestion].id;
    if (!responses[currentQuestionId]) {
      toast.error("Por favor, selecione uma resposta antes de continuar");
      return;
    }

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
    }
  };

  const handleFinish = () => {
    if (!questions) return;

    // Verificar se todas as perguntas foram respondidas
    const unanswered = questions.filter(q => !responses[q.id]);
    if (unanswered.length > 0) {
      toast.error(`Ainda faltam ${unanswered.length} pergunta(s) para responder`);
      return;
    }

    // Mostrar formulÃ¡rio de email
    setShowEmailForm(true);
  };

  const handleSubmit = () => {
    if (!email || !email.includes('@')) {
      toast.error("Por favor, insira um email vÃ¡lido");
      return;
    }

    setIsSubmitting(true);
    const formattedResponses = Object.entries(responses).map(([questionId, score]) => ({
      questionId: parseInt(questionId),
      score,
    }));

    submitMutation.mutate({
      testType: "vark",
      email: email,
      responses: formattedResponses,
    });
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 animate-spin text-primary mx-auto mb-4" />
          <p className="text-muted-foreground">Carregando teste...</p>
        </div>
      </div>
    );
  }

  if (!questions || questions.length === 0) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md">
          <CardHeader>
            <CardTitle>Teste VARK</CardTitle>
            <CardDescription>Nenhuma pergunta encontrada</CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  // Tela de resultado
  if (testCompleted && result) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-2xl w-full">
          <CardHeader className="text-center">
            <div className="mx-auto mb-4 w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
              <CheckCircle2 className="w-10 h-10 text-green-600" />
            </div>
            <CardTitle className="text-2xl">Teste ConcluÃ­do com Sucesso!</CardTitle>
            <CardDescription className="text-base mt-2">
              Obrigado por completar o Teste VARK, {result.employeeName}!
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <h3 className="font-semibold text-lg mb-2">Seu Perfil VARK</h3>
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">DominÃ¢ncia (D)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.D?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">InfluÃªncia (I)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.I?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Estabilidade (S)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.S?.toFixed(1) || '0.0'}</div>
                </div>
                <div className="bg-white p-3 rounded border">
                  <div className="text-sm text-muted-foreground">Conformidade (C)</div>
                  <div className="text-2xl font-bold text-orange-600">{result.profile.C?.toFixed(1) || '0.0'}</div>
                </div>
              </div>
              {result.profile.dominantProfile && (
                <div className="mt-4 p-3 bg-white rounded border">
                  <div className="text-sm text-muted-foreground">Perfil Dominante</div>
                  <div className="text-xl font-bold text-orange-600">{result.profile.dominantProfile}</div>
                </div>
              )}
            </div>
            <p className="text-sm text-center text-muted-foreground">
              Seus resultados foram salvos e estÃ£o disponÃ­veis para anÃ¡lise pela equipe de RH.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  // FormulÃ¡rio de email
  if (showEmailForm) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader>
            <div className="mx-auto mb-4 w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center">
              <Mail className="w-10 h-10 text-orange-600" />
            </div>
            <CardTitle className="text-center">Quase lÃ¡!</CardTitle>
            <CardDescription className="text-center">
              Para finalizar, precisamos do seu email para associar os resultados
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="email">Email Corporativo</Label>
              <Input
                id="email"
                type="email"
                placeholder="seu.email@uisa.com.br"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="mt-2"
              />
              <p className="text-xs text-muted-foreground mt-2">
                Use o mesmo email que recebeu o convite para este teste
              </p>
            </div>
            <div className="flex gap-3">
              <Button
                variant="outline"
                onClick={() => setShowEmailForm(false)}
                className="flex-1"
              >
                <ArrowLeft className="w-4 h-4 mr-2" />
                Voltar
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="flex-1"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Enviando...
                  </>
                ) : (
                  <>
                    <CheckCircle2 className="w-4 h-4 mr-2" />
                    Finalizar
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const progress = (Object.keys(responses).length / questions.length) * 100;
  const currentQ = questions[currentQuestion];

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-white">
      <div className="max-w-3xl mx-auto p-4 py-8 space-y-6">
        {/* Header */}
        <div className="text-center">
          <div className="flex items-center justify-center gap-3 mb-4">
            <Brain className="h-10 w-10 text-orange-600" />
            <h1 className="text-3xl font-bold tracking-tight">Teste VARK</h1>
          </div>
          <p className="text-muted-foreground">
            Avalie cada afirmaÃ§Ã£o de acordo com o quanto vocÃª concorda
          </p>
        </div>

        {/* Barra de Progresso */}
        <Card>
          <CardContent className="pt-6">
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span>Progresso</span>
                <span>{Object.keys(responses).length} de {questions.length} perguntas</span>
              </div>
              <Progress value={progress} className="h-2" />
            </div>
          </CardContent>
        </Card>

        {/* Pergunta Atual */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">
              Pergunta {currentQuestion + 1} de {questions.length}
            </CardTitle>
            <CardDescription className="text-base mt-4">
              {currentQ.questionText}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <RadioGroup
              value={responses[currentQ.id]?.toString()}
              onValueChange={(value) => handleResponseChange(currentQ.id, parseInt(value))}
            >
              <div className="space-y-3">
                {[
                  { value: 1, label: "1 - Discordo totalmente" },
                  { value: 2, label: "2 - Discordo parcialmente" },
                  { value: 3, label: "3 - Neutro" },
                  { value: 4, label: "4 - Concordo parcialmente" },
                  { value: 5, label: "5 - Concordo totalmente" },
                ].map((option) => (
                  <div key={option.value} className="flex items-center space-x-3 p-3 rounded-lg border hover:bg-accent transition-colors">
                    <RadioGroupItem value={option.value.toString()} id={`q${currentQ.id}-${option.value}`} />
                    <Label htmlFor={`q${currentQ.id}-${option.value}`} className="flex-1 cursor-pointer">
                      {option.label}
                    </Label>
                  </div>
                ))}
              </div>
            </RadioGroup>
          </CardContent>
        </Card>

        {/* NavegaÃ§Ã£o */}
        <div className="flex justify-between">
          <Button
            variant="outline"
            onClick={handlePrevious}
            disabled={currentQuestion === 0}
          >
            <ArrowLeft className="w-4 h-4 mr-2" />
            Anterior
          </Button>

          {currentQuestion < questions.length - 1 ? (
            <Button onClick={handleNext}>
              PrÃ³xima
            </Button>
          ) : (
            <Button
              onClick={handleFinish}
              disabled={Object.keys(responses).length < questions.length}
            >
              <CheckCircle2 className="w-4 h-4 mr-2" />
              Concluir Teste
            </Button>
          )}
        </div>
      </div>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/TestesResultadosRH.tsx
========================================
import { useAuth } from "@/_core/hooks/useAuth";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Loader2, Brain, Download, Filter, Users, BarChart3, TrendingUp } from "lucide-react";
import { useState } from "react";
import { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip } from "recharts";

/**
 * PÃ¡gina de VisualizaÃ§Ã£o de Resultados de Testes PsicomÃ©tricos (RH)
 * Permite visualizar, comparar e exportar resultados de todos os colaboradores
 */

const DISC_COLORS = {
  D: "#ef4444", // red
  I: "#eab308", // yellow
  S: "#22c55e", // green
  C: "#3b82f6", // blue
};

const BIG_FIVE_LABELS: Record<string, string> = {
  O: "Abertura",
  C: "Conscienciosidade",
  E: "ExtroversÃ£o",
  A: "Amabilidade",
  N: "Neuroticismo",
};

export default function TestesResultadosRH() {
  const { user } = useAuth();
  const [selectedTest, setSelectedTest] = useState<string>("all");
  const [selectedDepartment, setSelectedDepartment] = useState<string>("all");
  const [searchQuery, setSearchQuery] = useState("");

  // Buscar todos os testes (apenas RH/Admin)
  const { data: allTests, isLoading } = trpc.psychometric.getAllTests.useQuery();
  const { data: departments } = trpc.employees.getDepartments.useQuery();

  if (isLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <Loader2 className="w-8 h-8 animate-spin text-primary" />
        </div>
      </DashboardLayout>
    );
  }

  // Filtrar testes
  const filteredTests = allTests?.filter(test => {
    const matchesTest = selectedTest === "all" || test.testType === selectedTest;
    const matchesDepartment = selectedDepartment === "all" || 
      (test.employeeDepartmentId != null && test.employeeDepartmentId.toString() === selectedDepartment);
    const matchesSearch = searchQuery === "" || 
      test.employeeName?.toLowerCase().includes(searchQuery.toLowerCase());
    
    return matchesTest && matchesDepartment && matchesSearch;
  }) || [];

  // EstatÃ­sticas gerais
  const totalTests = filteredTests.length;
  const uniqueEmployees = new Set(filteredTests.map(t => t.employeeId)).size;
  const testsByType = filteredTests.reduce((acc, test) => {
    const type = test.testType || 'unknown';
    acc[type] = (acc[type] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  // Dados para grÃ¡fico de distribuiÃ§Ã£o
  const distributionData = Object.entries(testsByType).map(([type, count]) => ({
    name: type.toUpperCase(),
    value: count,
  }));

  // Exportar relatÃ³rio
  const handleExport = () => {
    const csv = [
      ["Colaborador", "Departamento", "Tipo de Teste", "Data", "Perfil DISC"].join(","),
      ...filteredTests.map(test => [
        test.employeeName || "",
        test.employeeDepartmentName || "",
        test.testType.toUpperCase(),
        new Date(test.completedAt || "").toLocaleDateString("pt-BR"),
        test.discProfile || "",
      ].join(","))
    ].join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `resultados-testes-${new Date().toISOString().split("T")[0]}.csv`;
    link.click();
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
              <Brain className="h-8 w-8" />
              Resultados de Testes PsicomÃ©tricos
            </h1>
            <p className="text-muted-foreground mt-2">
              Visualize e compare os resultados de todos os colaboradores
            </p>
          </div>
          <Button onClick={handleExport} variant="outline">
            <Download className="h-4 w-4 mr-2" />
            Exportar RelatÃ³rio
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid md:grid-cols-3 gap-6">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Total de Testes</CardTitle>
              <BarChart3 className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{totalTests}</div>
              <p className="text-xs text-muted-foreground">
                Testes realizados no sistema
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Colaboradores Avaliados</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{uniqueEmployees}</div>
              <p className="text-xs text-muted-foreground">
                Colaboradores Ãºnicos
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Tipos de Teste</CardTitle>
              <TrendingUp className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{Object.keys(testsByType).length}</div>
              <p className="text-xs text-muted-foreground">
                Diferentes avaliaÃ§Ãµes
              </p>
            </CardContent>
          </Card>
        </div>

        {/* Filtros */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Filter className="h-5 w-5" />
              Filtros
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid md:grid-cols-3 gap-4">
              <div className="space-y-2">
                <label className="text-sm font-medium">Buscar Colaborador</label>
                <Input
                  placeholder="Nome do colaborador..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>

              <div className="space-y-2">
                <label className="text-sm font-medium">Tipo de Teste</label>
                <Select value={selectedTest} onValueChange={setSelectedTest}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos os Testes</SelectItem>
                    <SelectItem value="disc">DISC</SelectItem>
                    <SelectItem value="bigfive">Big Five</SelectItem>
                    <SelectItem value="mbti">MBTI</SelectItem>
                    <SelectItem value="ie">InteligÃªncia Emocional</SelectItem>
                    <SelectItem value="vark">VARK</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <label className="text-sm font-medium">Departamento</label>
                <Select value={selectedDepartment} onValueChange={setSelectedDepartment}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos os Departamentos</SelectItem>
                    {departments && Array.isArray(departments) && departments
                      .filter((dept: any) => dept?.id != null)
                      .map((dept: any) => (
                        <SelectItem key={dept.id} value={dept.id.toString()}>
                          {dept.name || 'Sem nome'}
                        </SelectItem>
                      ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* GrÃ¡fico de DistribuiÃ§Ã£o - Desabilitado temporariamente */}

        {/* Lista de Resultados */}
        <Card>
          <CardHeader>
            <CardTitle>Resultados Individuais</CardTitle>
            <CardDescription>
              {filteredTests.length} {filteredTests.length === 1 ? "resultado encontrado" : "resultados encontrados"}
            </CardDescription>
          </CardHeader>
          <CardContent>
            {filteredTests.length === 0 ? (
              <div className="text-center py-12 text-muted-foreground">
                <Brain className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>Nenhum resultado encontrado com os filtros selecionados</p>
              </div>
            ) : (
              <div className="space-y-4">
                {filteredTests.map(test => (
                  <Card key={test.id}>
                    <CardContent className="pt-6">
                      <div className="flex items-start justify-between">
                        <div className="space-y-1">
                          <div className="flex items-center gap-2">
                            <h3 className="font-semibold">{test.employeeName}</h3>
                            <Badge variant="secondary">{test.testType.toUpperCase()}</Badge>
                          </div>
                          <p className="text-sm text-muted-foreground">
                            {test.employeeDepartmentName || "Sem departamento"}
                          </p>
                          <p className="text-xs text-muted-foreground">
                            Realizado em {test.completedAt ? new Date(test.completedAt).toLocaleDateString("pt-BR") : "N/A"}
                          </p>
                        </div>
                        <div className="text-right">
                          {test.discProfile && (
                            <Badge className="mb-2">
                              Perfil DISC: {test.discProfile}
                            </Badge>
                          )}
                          {test.testType === 'disc' && test.discDominance && (
                            <p className="text-sm font-medium">
                              D:{test.discDominance} I:{test.discInfluence} S:{test.discSteadiness} C:{test.discCompliance}
                            </p>
                          )}
                        </div>
                      </div>

                      {/* VisualizaÃ§Ã£o do perfil Big Five */}
                      {test.testType === 'bigfive' && test.bigFiveOpenness && (
                        <div className="mt-4 pt-4 border-t">
                          <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div className="text-center">
                              <p className="text-xs text-muted-foreground mb-1">Abertura</p>
                              <p className="text-lg font-bold">{test.bigFiveOpenness}</p>
                            </div>
                            <div className="text-center">
                              <p className="text-xs text-muted-foreground mb-1">Conscienciosidade</p>
                              <p className="text-lg font-bold">{test.bigFiveConscientiousness}</p>
                            </div>
                            <div className="text-center">
                              <p className="text-xs text-muted-foreground mb-1">ExtroversÃ£o</p>
                              <p className="text-lg font-bold">{test.bigFiveExtraversion}</p>
                            </div>
                            <div className="text-center">
                              <p className="text-xs text-muted-foreground mb-1">Amabilidade</p>
                              <p className="text-lg font-bold">{test.bigFiveAgreeableness}</p>
                            </div>
                            <div className="text-center">
                              <p className="text-xs text-muted-foreground mb-1">Neuroticismo</p>
                              <p className="text-lg font-bold">{test.bigFiveNeuroticism}</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/aprovacoes/Bonus.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { DollarSign, TrendingUp, Users, CheckCircle } from "lucide-react";
import { toast } from "sonner";

/**
 * BÃ´nus
 * 
 * Features:
 * - FormulÃ¡rio de solicitaÃ§Ã£o de bÃ´nus
 * - KPIs: OrÃ§amento disponÃ­vel, SolicitaÃ§Ãµes aprovadas
 * - Lista de solicitaÃ§Ãµes de bÃ´nus pendentes
 * - AprovaÃ§Ã£o/RejeiÃ§Ã£o rÃ¡pida
 */

export default function Bonus() {
  const [employee, setEmployee] = useState("");
  const [amount, setAmount] = useState("");
  const [reason, setReason] = useState("");
  const [type, setType] = useState("");

  // Mock data - TODO: integrar com backend
  const kpis = {
    orcamentoDisponivel: 150000,
    solicitacoesAprovadas: 25,
    totalDistribuido: 85000,
  };

  const bonusRequests = [
    {
      id: 1,
      employee: "Maria Silva",
      amount: 5000,
      type: "Performance",
      reason: "Superou metas do Q4 em 150%",
      requestDate: "2025-01-10",
      status: "pendente",
    },
    {
      id: 2,
      employee: "JoÃ£o Santos",
      amount: 3000,
      type: "Projeto",
      reason: "ConclusÃ£o antecipada do Projeto Alpha",
      requestDate: "2025-01-08",
      status: "pendente",
    },
    {
      id: 3,
      employee: "Ana Costa",
      amount: 4000,
      type: "Performance",
      reason: "Excelente avaliaÃ§Ã£o 360Â°",
      requestDate: "2025-01-05",
      status: "pendente",
    },
  ];

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    toast.success("SolicitaÃ§Ã£o de bÃ´nus enviada com sucesso!");
    // Reset form
    setEmployee("");
    setAmount("");
    setReason("");
    setType("");
  };

  const handleApprove = (id: number) => {
    toast.success("BÃ´nus aprovado!");
  };

  const handleReject = (id: number) => {
    toast.error("BÃ´nus rejeitado");
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold">GestÃ£o de BÃ´nus</h1>
          <p className="text-muted-foreground">SolicitaÃ§Ã£o e aprovaÃ§Ã£o de bÃ´nus</p>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  OrÃ§amento DisponÃ­vel
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                  <DollarSign className="h-5 w-5 text-green-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">
                R$ {kpis.orcamentoDisponivel.toLocaleString("pt-BR")}
              </div>
              <p className="text-xs text-muted-foreground mt-1">Ciclo 2025</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Total DistribuÃ­do
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                  <TrendingUp className="h-5 w-5 text-blue-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">
                R$ {kpis.totalDistribuido.toLocaleString("pt-BR")}
              </div>
              <p className="text-xs text-muted-foreground mt-1">
                {((kpis.totalDistribuido / kpis.orcamentoDisponivel) * 100).toFixed(0)}% do
                orÃ§amento
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  SolicitaÃ§Ãµes Aprovadas
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                  <CheckCircle className="h-5 w-5 text-purple-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{kpis.solicitacoesAprovadas}</div>
              <p className="text-xs text-muted-foreground mt-1">Este ano</p>
            </CardContent>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* FormulÃ¡rio de SolicitaÃ§Ã£o */}
          <Card>
            <CardHeader>
              <CardTitle>Nova SolicitaÃ§Ã£o de BÃ´nus</CardTitle>
            </CardHeader>
            <CardContent>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <Label htmlFor="employee">Colaborador</Label>
                  <Input
                    id="employee"
                    placeholder="Nome do colaborador"
                    value={employee}
                    onChange={(e) => setEmployee(e.target.value)}
                    required
                  />
                </div>

                <div>
                  <Label htmlFor="type">Tipo de BÃ´nus</Label>
                  <Select value={type} onValueChange={setType} required>
                    <SelectTrigger>
                      <SelectValue placeholder="Selecione o tipo" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="performance">Performance</SelectItem>
                      <SelectItem value="projeto">ConclusÃ£o de Projeto</SelectItem>
                      <SelectItem value="retencao">RetenÃ§Ã£o de Talento</SelectItem>
                      <SelectItem value="anual">BÃ´nus Anual</SelectItem>
                      <SelectItem value="outro">Outro</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label htmlFor="amount">Valor (R$)</Label>
                  <Input
                    id="amount"
                    type="number"
                    placeholder="0,00"
                    value={amount}
                    onChange={(e) => setAmount(e.target.value)}
                    required
                  />
                </div>

                <div>
                  <Label htmlFor="reason">Justificativa</Label>
                  <Textarea
                    id="reason"
                    placeholder="Descreva o motivo da solicitaÃ§Ã£o..."
                    value={reason}
                    onChange={(e) => setReason(e.target.value)}
                    rows={4}
                    required
                  />
                </div>

                <Button type="submit" className="w-full">
                  Enviar SolicitaÃ§Ã£o
                </Button>
              </form>
            </CardContent>
          </Card>

          {/* SolicitaÃ§Ãµes Pendentes */}
          <Card>
            <CardHeader>
              <CardTitle>SolicitaÃ§Ãµes Pendentes ({bonusRequests.length})</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {bonusRequests.map((request) => (
                  <div key={request.id} className="p-4 rounded-lg border">
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <p className="font-semibold">{request.employee}</p>
                        <p className="text-2xl font-bold text-primary mt-1">
                          R$ {request.amount.toLocaleString("pt-BR")}
                        </p>
                      </div>
                      <Badge variant="outline">{request.type}</Badge>
                    </div>

                    <p className="text-sm text-muted-foreground mb-3">{request.reason}</p>

                    <div className="flex items-center gap-2 text-xs text-muted-foreground mb-3">
                      <span>Solicitado em: {new Date(request.requestDate).toLocaleDateString("pt-BR")}</span>
                    </div>

                    <div className="flex items-center gap-2">
                      <Button
                        size="sm"
                        className="flex-1"
                        onClick={() => handleApprove(request.id)}
                      >
                        <CheckCircle className="h-4 w-4 mr-1" />
                        Aprovar
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        className="flex-1"
                        onClick={() => handleReject(request.id)}
                      >
                        Rejeitar
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/aprovacoes/Dashboard.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import {
  CheckCircle,
  Clock,
  XCircle,
  TrendingUp,
  Users,
  FileText,
  AlertCircle,
} from "lucide-react";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from "recharts";

/**
 * Dashboard de AprovaÃ§Ãµes
 * 
 * Features:
 * - KPIs: Pendentes, Aprovadas, Rejeitadas, Tempo MÃ©dio
 * - GrÃ¡fico: SolicitaÃ§Ãµes por Tipo
 * - GrÃ¡fico: Status de AprovaÃ§Ãµes (Pizza)
 * - Lista: SolicitaÃ§Ãµes Pendentes (aÃ§Ã£o rÃ¡pida)
 * - Filtro por perÃ­odo
 */

export default function Dashboard() {
  const [period, setPeriod] = useState("30");

  // Mock data - TODO: integrar com backend
  const kpis = {
    pendentes: 12,
    aprovadas: 45,
    rejeitadas: 3,
    tempoMedio: 2.5, // dias
  };

  // Dados para grÃ¡fico de barras
  const requestsByType = [
    { type: "FÃ©rias", count: 15 },
    { type: "BÃ´nus", count: 12 },
    { type: "PromoÃ§Ã£o", count: 8 },
    { type: "Treinamento", count: 10 },
    { type: "Outros", count: 15 },
  ];

  // Dados para grÃ¡fico de pizza
  const statusData = [
    { name: "Aprovadas", value: 45, color: "#10b981" },
    { name: "Pendentes", value: 12, color: "#f59e0b" },
    { name: "Rejeitadas", value: 3, color: "#ef4444" },
  ];

  // SolicitaÃ§Ãµes pendentes
  const pendingRequests = [
    {
      id: 1,
      type: "BÃ´nus",
      employee: "Maria Silva",
      date: "2025-01-15",
      amount: "R$ 5.000",
      priority: "alta",
    },
    {
      id: 2,
      type: "PromoÃ§Ã£o",
      employee: "JoÃ£o Santos",
      date: "2025-01-14",
      position: "Gerente",
      priority: "media",
    },
    {
      id: 3,
      type: "FÃ©rias",
      employee: "Ana Costa",
      date: "2025-01-13",
      days: "15 dias",
      priority: "baixa",
    },
  ];

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">Dashboard de AprovaÃ§Ãµes</h1>
            <p className="text-muted-foreground">VisÃ£o consolidada de solicitaÃ§Ãµes e aprovaÃ§Ãµes</p>
          </div>
          <Select value={period} onValueChange={setPeriod}>
            <SelectTrigger className="w-40">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="7">Ãšltimos 7 dias</SelectItem>
              <SelectItem value="30">Ãšltimos 30 dias</SelectItem>
              <SelectItem value="90">Ãšltimos 90 dias</SelectItem>
              <SelectItem value="365">Ãšltimo ano</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Pendentes
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-orange-100 flex items-center justify-center">
                  <Clock className="h-5 w-5 text-orange-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{kpis.pendentes}</div>
              <p className="text-xs text-orange-600 mt-1">Requer atenÃ§Ã£o</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Aprovadas
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                  <CheckCircle className="h-5 w-5 text-green-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{kpis.aprovadas}</div>
              <p className="text-xs text-green-600 mt-1">+12% vs. mÃªs anterior</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Rejeitadas
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-red-100 flex items-center justify-center">
                  <XCircle className="h-5 w-5 text-red-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{kpis.rejeitadas}</div>
              <p className="text-xs text-muted-foreground mt-1">5% do total</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                  Tempo MÃ©dio
                </CardTitle>
                <div className="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                  <TrendingUp className="h-5 w-5 text-blue-600" />
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{kpis.tempoMedio}d</div>
              <p className="text-xs text-muted-foreground mt-1">Para aprovaÃ§Ã£o</p>
            </CardContent>
          </Card>
        </div>

        {/* GrÃ¡ficos */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* GrÃ¡fico de Barras */}
          <Card>
            <CardHeader>
              <CardTitle>SolicitaÃ§Ãµes por Tipo</CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={requestsByType}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="type" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="count" fill="hsl(var(--primary))" />
                </BarChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          {/* GrÃ¡fico de Pizza */}
          <Card>
            <CardHeader>
              <CardTitle>Status de AprovaÃ§Ãµes</CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={statusData}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
                    outerRadius={80}
                    fill="#8884d8"
                    dataKey="value"
                  >
                    {statusData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>

        {/* SolicitaÃ§Ãµes Pendentes */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle>SolicitaÃ§Ãµes Pendentes</CardTitle>
              <Button variant="outline" size="sm">
                Ver todas
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {pendingRequests.map((request) => (
                <div
                  key={request.id}
                  className="flex items-center gap-4 p-4 rounded-lg border hover:bg-accent transition-colors"
                >
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <Badge variant="outline">{request.type}</Badge>
                      <Badge
                        variant={
                          request.priority === "alta"
                            ? "destructive"
                            : request.priority === "media"
                            ? "default"
                            : "secondary"
                        }
                        className="text-xs"
                      >
                        {request.priority === "alta"
                          ? "Alta"
                          : request.priority === "media"
                          ? "MÃ©dia"
                          : "Baixa"}
                      </Badge>
                    </div>
                    <p className="font-semibold">{request.employee}</p>
                    <p className="text-sm text-muted-foreground">
                      {request.amount || request.position || request.days} â€¢{" "}
                      {new Date(request.date).toLocaleDateString("pt-BR")}
                    </p>
                  </div>

                  <div className="flex items-center gap-2">
                    <Button size="sm" variant="default">
                      <CheckCircle className="h-4 w-4 mr-1" />
                      Aprovar
                    </Button>
                    <Button size="sm" variant="outline">
                      <XCircle className="h-4 w-4 mr-1" />
                      Rejeitar
                    </Button>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/aprovacoes/MinhasSolicitacoes.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { FileText, Search, Plus, Eye } from "lucide-react";

/**
 * Minhas SolicitaÃ§Ãµes
 * 
 * Features:
 * - Tabela interativa com histÃ³rico completo
 * - Filtros: Status, Tipo, PerÃ­odo
 * - Busca por texto
 * - BotÃ£o "Nova SolicitaÃ§Ã£o"
 * - VisualizaÃ§Ã£o de detalhes
 */

export default function MinhasSolicitacoes() {
  const [statusFilter, setStatusFilter] = useState("todos");
  const [typeFilter, setTypeFilter] = useState("todos");
  const [searchQuery, setSearchQuery] = useState("");

  // Mock data - TODO: integrar com backend
  const requests = [
    {
      id: 1,
      type: "FÃ©rias",
      description: "FÃ©rias de 15 dias - Janeiro/2025",
      status: "aprovada",
      requestDate: "2024-12-10",
      responseDate: "2024-12-12",
      approver: "Carlos Mendes",
    },
    {
      id: 2,
      type: "BÃ´nus",
      description: "BÃ´nus por performance Q4/2024",
      status: "pendente",
      requestDate: "2025-01-05",
      responseDate: null,
      approver: "Ana Paula",
    },
    {
      id: 3,
      type: "Treinamento",
      description: "Curso de LideranÃ§a EstratÃ©gica",
      status: "aprovada",
      requestDate: "2024-11-20",
      responseDate: "2024-11-22",
      approver: "Roberto Silva",
    },
    {
      id: 4,
      type: "PromoÃ§Ã£o",
      description: "PromoÃ§Ã£o para Gerente SÃªnior",
      status: "em_analise",
      requestDate: "2024-12-15",
      responseDate: null,
      approver: "Diretoria",
    },
    {
      id: 5,
      type: "Ajuste Salarial",
      description: "Reajuste salarial anual",
      status: "rejeitada",
      requestDate: "2024-10-10",
      responseDate: "2024-10-15",
      approver: "RH",
    },
  ];

  // Filtrar solicitaÃ§Ãµes
  const filteredRequests = requests.filter((req) => {
    if (statusFilter !== "todos" && req.status !== statusFilter) return false;
    if (typeFilter !== "todos" && req.type !== typeFilter) return false;
    if (searchQuery && !req.description.toLowerCase().includes(searchQuery.toLowerCase()))
      return false;
    return true;
  });

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "aprovada":
        return <Badge className="bg-green-500">Aprovada</Badge>;
      case "rejeitada":
        return <Badge variant="destructive">Rejeitada</Badge>;
      case "pendente":
        return <Badge className="bg-orange-500">Pendente</Badge>;
      case "em_analise":
        return <Badge className="bg-blue-500">Em AnÃ¡lise</Badge>;
      default:
        return <Badge variant="outline">{status}</Badge>;
    }
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">Minhas SolicitaÃ§Ãµes</h1>
            <p className="text-muted-foreground">HistÃ³rico completo de solicitaÃ§Ãµes</p>
          </div>
          <Button>
            <Plus className="h-4 w-4 mr-2" />
            Nova SolicitaÃ§Ã£o
          </Button>
        </div>

        {/* Filtros */}
        <Card>
          <CardContent className="pt-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="Buscar solicitaÃ§Ã£o..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="pl-9"
                />
              </div>

              <Select value={statusFilter} onValueChange={setStatusFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Status" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos os Status</SelectItem>
                  <SelectItem value="pendente">Pendente</SelectItem>
                  <SelectItem value="em_analise">Em AnÃ¡lise</SelectItem>
                  <SelectItem value="aprovada">Aprovada</SelectItem>
                  <SelectItem value="rejeitada">Rejeitada</SelectItem>
                </SelectContent>
              </Select>

              <Select value={typeFilter} onValueChange={setTypeFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Tipo" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos os Tipos</SelectItem>
                  <SelectItem value="FÃ©rias">FÃ©rias</SelectItem>
                  <SelectItem value="BÃ´nus">BÃ´nus</SelectItem>
                  <SelectItem value="Treinamento">Treinamento</SelectItem>
                  <SelectItem value="PromoÃ§Ã£o">PromoÃ§Ã£o</SelectItem>
                  <SelectItem value="Ajuste Salarial">Ajuste Salarial</SelectItem>
                </SelectContent>
              </Select>

              <Button variant="outline" onClick={() => {
                setStatusFilter("todos");
                setTypeFilter("todos");
                setSearchQuery("");
              }}>
                Limpar Filtros
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Tabela de SolicitaÃ§Ãµes */}
        <Card>
          <CardHeader>
            <CardTitle>HistÃ³rico ({filteredRequests.length} solicitaÃ§Ãµes)</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {filteredRequests.map((request) => (
                <div
                  key={request.id}
                  className="flex items-center gap-4 p-4 rounded-lg border hover:bg-accent transition-colors"
                >
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <Badge variant="outline">{request.type}</Badge>
                      {getStatusBadge(request.status)}
                    </div>
                    <p className="font-semibold mb-1">{request.description}</p>
                    <div className="flex items-center gap-4 text-sm text-muted-foreground">
                      <span>Solicitado em: {new Date(request.requestDate).toLocaleDateString("pt-BR")}</span>
                      {request.responseDate && (
                        <span>
                          Respondido em: {new Date(request.responseDate).toLocaleDateString("pt-BR")}
                        </span>
                      )}
                      <span>Aprovador: {request.approver}</span>
                    </div>
                  </div>

                  <Button variant="outline" size="sm">
                    <Eye className="h-4 w-4 mr-1" />
                    Detalhes
                  </Button>
                </div>
              ))}

              {filteredRequests.length === 0 && (
                <div className="text-center py-12 text-muted-foreground">
                  <FileText className="h-12 w-12 mx-auto mb-4 opacity-50" />
                  <p>Nenhuma solicitaÃ§Ã£o encontrada</p>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/aprovacoes/Workflows.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { GitBranch, Clock, CheckCircle, XCircle, ArrowRight, Plus } from "lucide-react";
import { toast } from "sonner";
import { trpc } from "@/lib/trpc";

/**
 * Workflows
 * 
 * Features:
 * - VisualizaÃ§Ã£o de processos de aprovaÃ§Ã£o
 * - Status de cada etapa do workflow
 * - Tempo mÃ©dio por etapa
 * - Fluxos configurÃ¡veis
 */

export default function Workflows() {
  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
  const [newWorkflow, setNewWorkflow] = useState({
    name: "",
    description: "",
    type: "",
  });

  // Buscar workflows do backend
  const { data: backendWorkflows, refetch } = trpc.workflows.list.useQuery();

  // Mutation para criar workflow
  const createWorkflowMutation = trpc.workflows.create.useMutation({
    onSuccess: () => {
      toast.success(`Workflow "${newWorkflow.name}" criado com sucesso!`);
      setIsCreateDialogOpen(false);
      setNewWorkflow({ name: "", description: "", type: "" });
      refetch(); // Atualizar listagem
    },
    onError: (error) => {
      toast.error(`Erro ao criar workflow: ${error.message}`);
    },
  });

  // Mock data para demonstraÃ§Ã£o
  const mockWorkflows = [
    {
      id: 1,
      name: "AprovaÃ§Ã£o de BÃ´nus",
      description: "Fluxo de aprovaÃ§Ã£o para solicitaÃ§Ãµes de bÃ´nus",
      steps: [
        { name: "SolicitaÃ§Ã£o", status: "completed", avgTime: "0.5h" },
        { name: "Gestor Direto", status: "completed", avgTime: "1d" },
        { name: "RH", status: "in_progress", avgTime: "2d" },
        { name: "Diretoria", status: "pending", avgTime: "3d" },
        { name: "Finalizado", status: "pending", avgTime: "-" },
      ],
      activeRequests: 8,
      avgTotalTime: "6.5 dias",
    },
    {
      id: 2,
      name: "AprovaÃ§Ã£o de FÃ©rias",
      description: "Fluxo de aprovaÃ§Ã£o para solicitaÃ§Ãµes de fÃ©rias",
      steps: [
        { name: "SolicitaÃ§Ã£o", status: "completed", avgTime: "0.5h" },
        { name: "Gestor Direto", status: "completed", avgTime: "0.5d" },
        { name: "RH", status: "completed", avgTime: "1d" },
        { name: "Finalizado", status: "completed", avgTime: "-" },
      ],
      activeRequests: 15,
      avgTotalTime: "2 dias",
    },
    {
      id: 3,
      name: "AprovaÃ§Ã£o de PromoÃ§Ã£o",
      description: "Fluxo de aprovaÃ§Ã£o para promoÃ§Ãµes e mudanÃ§as de cargo",
      steps: [
        { name: "SolicitaÃ§Ã£o", status: "completed", avgTime: "0.5h" },
        { name: "Gestor Direto", status: "completed", avgTime: "2d" },
        { name: "GerÃªncia", status: "in_progress", avgTime: "3d" },
        { name: "Diretoria", status: "pending", avgTime: "5d" },
        { name: "RH", status: "pending", avgTime: "2d" },
        { name: "Finalizado", status: "pending", avgTime: "-" },
      ],
      activeRequests: 3,
      avgTotalTime: "12 dias",
    },
  ];

  // Usar workflows do backend se disponÃ­veis, senÃ£o usar mock
  const workflows = backendWorkflows && backendWorkflows.length > 0 
    ? backendWorkflows.map(w => ({
        id: w.id,
        name: w.name,
        description: w.description || "Workflow customizado",
        steps: w.steps ? JSON.parse(w.steps as string) : [],
        activeRequests: 0,
        avgTotalTime: "-",
      }))
    : mockWorkflows;

  const getStatusIcon = (status: string) => {
    switch (status) {
      case "completed":
        return <CheckCircle className="h-5 w-5 text-green-500" />;
      case "in_progress":
        return <Clock className="h-5 w-5 text-orange-500" />;
      case "pending":
        return <Clock className="h-5 w-5 text-gray-400" />;
      default:
        return <XCircle className="h-5 w-5 text-red-500" />;
    }
  };

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "completed":
        return <Badge className="bg-green-500">ConcluÃ­do</Badge>;
      case "in_progress":
        return <Badge className="bg-orange-500">Em Andamento</Badge>;
      case "pending":
        return <Badge variant="outline">Pendente</Badge>;
      default:
        return <Badge variant="destructive">Erro</Badge>;
    }
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-start justify-between">
          <div>
            <h1 className="text-3xl font-bold">Workflows de AprovaÃ§Ã£o</h1>
            <p className="text-muted-foreground">
              VisualizaÃ§Ã£o e gerenciamento de fluxos de aprovaÃ§Ã£o
            </p>
          </div>
          <Button onClick={() => setIsCreateDialogOpen(true)}>
            <Plus className="h-4 w-4 mr-2" />
            Criar Novo Workflow
          </Button>
        </div>

        {/* Workflows */}
        <div className="space-y-6">
          {workflows.map((workflow) => (
            <Card key={workflow.id}>
              <CardHeader>
                <div className="flex items-start justify-between">
                  <div>
                    <div className="flex items-center gap-2 mb-2">
                      <GitBranch className="h-5 w-5 text-primary" />
                      <CardTitle>{workflow.name}</CardTitle>
                    </div>
                    <p className="text-sm text-muted-foreground">{workflow.description}</p>
                  </div>
                  <div className="text-right">
                    <p className="text-sm text-muted-foreground">SolicitaÃ§Ãµes Ativas</p>
                    <p className="text-2xl font-bold">{workflow.activeRequests}</p>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                {/* Steps */}
                <div className="flex items-center gap-2 mb-6 overflow-x-auto pb-4">
                  {workflow.steps.map((step: any, idx: number) => (
                    <div key={idx} className="flex items-center">
                      <div className="flex flex-col items-center min-w-[120px]">
                        <div className="flex items-center justify-center mb-2">
                          {getStatusIcon(step.status)}
                        </div>
                        <p className="text-sm font-semibold text-center mb-1">{step.name}</p>
                        <p className="text-xs text-muted-foreground text-center mb-2">
                          MÃ©dia: {step.avgTime}
                        </p>
                        {getStatusBadge(step.status)}
                      </div>
                      {idx < workflow.steps.length - 1 && (
                        <ArrowRight className="h-5 w-5 text-muted-foreground mx-2 flex-shrink-0" />
                      )}
                    </div>
                  ))}
                </div>

                {/* Info */}
                <div className="flex items-center justify-between pt-4 border-t">
                  <div className="flex items-center gap-4 text-sm text-muted-foreground">
                    <span>
                      <strong>Tempo MÃ©dio Total:</strong> {workflow.avgTotalTime}
                    </span>
                    <span>
                      <strong>Etapas:</strong> {workflow.steps.length}
                    </span>
                  </div>
                  <Button variant="outline" size="sm">
                    Configurar Workflow
                  </Button>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        {/* Dialog de CriaÃ§Ã£o de Workflow */}
        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>Criar Novo Workflow</DialogTitle>
              <DialogDescription>
                Configure um novo fluxo de aprovaÃ§Ã£o customizado para sua organizaÃ§Ã£o
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4 py-4">
              {/* Nome do Workflow */}
              <div className="space-y-2">
                <Label htmlFor="workflow-name">Nome do Workflow *</Label>
                <Input
                  id="workflow-name"
                  placeholder="Ex: AprovaÃ§Ã£o de Horas Extras"
                  value={newWorkflow.name}
                  onChange={(e) => setNewWorkflow({ ...newWorkflow, name: e.target.value })}
                />
              </div>

              {/* DescriÃ§Ã£o */}
              <div className="space-y-2">
                <Label htmlFor="workflow-description">DescriÃ§Ã£o</Label>
                <Textarea
                  id="workflow-description"
                  placeholder="Descreva o propÃ³sito deste workflow..."
                  value={newWorkflow.description}
                  onChange={(e) => setNewWorkflow({ ...newWorkflow, description: e.target.value })}
                  rows={3}
                />
              </div>

              {/* Tipo de Workflow */}
              <div className="space-y-2">
                <Label htmlFor="workflow-type">Tipo de Workflow *</Label>
                <Select
                  value={newWorkflow.type}
                  onValueChange={(value) => setNewWorkflow({ ...newWorkflow, type: value })}
                >
                  <SelectTrigger id="workflow-type">
                    <SelectValue placeholder="Selecione o tipo" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="metas">AprovaÃ§Ã£o de Metas</SelectItem>
                    <SelectItem value="pdi">AprovaÃ§Ã£o de PDI</SelectItem>
                    <SelectItem value="avaliacao">AprovaÃ§Ã£o de AvaliaÃ§Ã£o</SelectItem>
                    <SelectItem value="bonus">AprovaÃ§Ã£o de BÃ´nus</SelectItem>
                    <SelectItem value="ferias">AprovaÃ§Ã£o de FÃ©rias</SelectItem>
                    <SelectItem value="promocao">AprovaÃ§Ã£o de PromoÃ§Ã£o</SelectItem>
                    <SelectItem value="horas_extras">AprovaÃ§Ã£o de Horas Extras</SelectItem>
                    <SelectItem value="despesas">AprovaÃ§Ã£o de Despesas</SelectItem>
                    <SelectItem value="outro">Outro</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* InformaÃ§Ã£o sobre Etapas */}
              <div className="rounded-lg border p-4 bg-muted/50">
                <p className="text-sm text-muted-foreground">
                  <strong>PrÃ³ximo passo:</strong> ApÃ³s criar o workflow, vocÃª poderÃ¡ configurar as etapas de aprovaÃ§Ã£o,
                  definir aprovadores, ordem e condiÃ§Ãµes para cada etapa.
                </p>
              </div>
            </div>

            <DialogFooter>
              <Button
                variant="outline"
                onClick={() => {
                  setIsCreateDialogOpen(false);
                  setNewWorkflow({ name: "", description: "", type: "" });
                }}
              >
                Cancelar
              </Button>
              <Button
                onClick={() => {
                  if (!newWorkflow.name || !newWorkflow.type) {
                    toast.error("Preencha todos os campos obrigatÃ³rios");
                    return;
                  }

                  // Criar workflow no backend
                  createWorkflowMutation.mutate({
                    name: newWorkflow.name,
                    description: newWorkflow.description || undefined,
                    type: newWorkflow.type as any, // Type assertion para aceitar valores do select
                    steps: JSON.stringify([]), // Etapas vazias inicialmente
                  });
                }}
                disabled={!newWorkflow.name || !newWorkflow.type || createWorkflowMutation.isPending}
              >
                Criar Workflow
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/AnaliseGaps.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { trpc } from "@/lib/trpc";
import DashboardLayout from "@/components/DashboardLayout";
import { AlertTriangle, TrendingUp, CheckCircle } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";

export default function AnaliseGaps() {
  const [period, setPeriod] = useState("30");

  // Mock data enquanto backend nÃ£o estÃ¡ pronto
  const mockData = {
    overallScore: 75,
    comparison: [
      { responsibility: "AnÃ¡lise de KPIs", category: "AnÃ¡lise", executedHours: 20, expectedHours: 25, adherenceRate: 80 },
      { responsibility: "Planejamento EstratÃ©gico", category: "Planejamento", executedHours: 15, expectedHours: 20, adherenceRate: 75 },
      { responsibility: "ReuniÃµes de Alinhamento", category: "ReuniÃ£o", executedHours: 8, expectedHours: 10, adherenceRate: 80 },
      { responsibility: "ExecuÃ§Ã£o de Processos", category: "ExecuÃ§Ã£o", executedHours: 25, expectedHours: 30, adherenceRate: 83 },
      { responsibility: "Suporte TÃ©cnico", category: "Suporte", executedHours: 5, expectedHours: 15, adherenceRate: 33 },
    ],
    gaps: [
      {
        title: "Baixa execuÃ§Ã£o de Suporte TÃ©cnico",
        description: "Apenas 33% do tempo esperado foi dedicado a suporte tÃ©cnico",
        severity: "Alta",
        suggestion: "Alocar mais tempo para atividades de suporte ou revisar se esta responsabilidade ainda Ã© aplicÃ¡vel ao cargo"
      },
      {
        title: "Planejamento abaixo do esperado",
        description: "Atividades de planejamento estratÃ©gico estÃ£o 25% abaixo do esperado",
        severity: "MÃ©dia",
        suggestion: "Aumentar dedicaÃ§Ã£o a atividades de planejamento ou redistribuir responsabilidades"
      }
    ],
    suggestions: [
      {
        type: "adjust",
        title: "Reduzir carga de Suporte TÃ©cnico",
        description: "Considerar reduzir a expectativa de horas em suporte tÃ©cnico de 15h para 8h mensais",
        impact: "Melhoraria o score de aderÃªncia em aproximadamente 10 pontos"
      },
      {
        type: "add",
        title: "Adicionar responsabilidade de Treinamento",
        description: "FuncionÃ¡rio demonstra capacidade para conduzir treinamentos internos",
        impact: "Aproveitaria melhor as competÃªncias do funcionÃ¡rio"
      }
    ]
  };

  const getScoreColor = (score: number) => {
    if (score >= 80) return "text-green-600";
    if (score >= 60) return "text-yellow-600";
    return "text-red-600";
  };

  const getScoreBadge = (score: number) => {
    if (score >= 80) return { label: "Excelente", variant: "default" as const };
    if (score >= 60) return { label: "Bom", variant: "secondary" as const };
    return { label: "AtenÃ§Ã£o", variant: "destructive" as const };
  };

  return (
    <DashboardLayout>
      <div className="container mx-auto py-8">
        <div className="mb-8">
          <h1 className="text-3xl font-bold mb-2">AnÃ¡lise de Gaps de Produtividade</h1>
          <p className="text-muted-foreground">
            ComparaÃ§Ã£o entre responsabilidades do cargo e atividades realmente executadas
          </p>
        </div>

        {/* Filtros */}
        <Card className="mb-8">
          <CardContent className="pt-6">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-sm font-medium mb-2 block">PerÃ­odo</label>
                <Select value={period} onValueChange={setPeriod}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="7">Ãšltimos 7 dias</SelectItem>
                    <SelectItem value="30">Ãšltimos 30 dias</SelectItem>
                    <SelectItem value="90">Ãšltimos 90 dias</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Score Geral */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>Score Geral de AderÃªncia</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-center py-8">
              <div className="text-center">
                <div className={`text-6xl font-bold mb-2 ${getScoreColor(mockData.overallScore)}`}>
                  {mockData.overallScore}
                </div>
                <div className="text-sm text-muted-foreground mb-4">de 100 pontos</div>
                <Badge variant={getScoreBadge(mockData.overallScore).variant}>
                  {getScoreBadge(mockData.overallScore).label}
                </Badge>
              </div>
            </div>
            <Progress value={mockData.overallScore} className="h-3" />
          </CardContent>
        </Card>

        {/* ComparaÃ§Ã£o */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>Responsabilidades vs Atividades Executadas</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-6">
              {mockData.comparison.map((item, index) => (
                <div key={index} className="space-y-2">
                  <div className="flex justify-between items-center">
                    <div className="flex-1">
                      <h4 className="font-medium">{item.responsibility}</h4>
                      <p className="text-sm text-muted-foreground">{item.category}</p>
                    </div>
                    <div className="text-right">
                      <div className="text-sm font-medium">
                        {item.executedHours}h / {item.expectedHours}h
                      </div>
                      <div className="text-xs text-muted-foreground">
                        {item.adherenceRate}% de aderÃªncia
                      </div>
                    </div>
                  </div>
                  <Progress value={item.adherenceRate} className="h-2" />
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* Gaps */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <AlertTriangle className="w-5 h-5 text-orange-600" />
              Gaps Identificados
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {mockData.gaps.map((gap, index) => (
                <div key={index} className="border-l-4 border-orange-500 pl-4 py-2">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <h4 className="font-medium text-orange-900 dark:text-orange-100">
                        {gap.title}
                      </h4>
                      <p className="text-sm text-muted-foreground mt-1">{gap.description}</p>
                    </div>
                    <Badge variant="secondary">{gap.severity}</Badge>
                  </div>
                  <div className="mt-2 p-3 bg-muted rounded-md">
                    <p className="text-sm">
                      <strong>SugestÃ£o:</strong> {gap.suggestion}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* SugestÃµes */}
        <Card>
          <CardHeader>
            <CardTitle>SugestÃµes de Ajustes na DescriÃ§Ã£o de Cargo</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {mockData.suggestions.map((suggestion, index) => (
                <div key={index} className="p-4 border rounded-lg">
                  <div className="flex items-start gap-3">
                    <div className="mt-1">
                      {suggestion.type === "add" && <TrendingUp className="w-5 h-5 text-green-600" />}
                      {suggestion.type === "adjust" && <AlertTriangle className="w-5 h-5 text-yellow-600" />}
                    </div>
                    <div className="flex-1">
                      <h4 className="font-medium mb-1">{suggestion.title}</h4>
                      <p className="text-sm text-muted-foreground">{suggestion.description}</p>
                      <div className="mt-2 text-xs text-muted-foreground">
                        <strong>Impacto esperado:</strong> {suggestion.impact}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/ValidacaoLider.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { trpc } from "@/lib/trpc";
import DashboardLayout from "@/components/DashboardLayout";
import { CheckCircle, XCircle, Clock, Search, FileText } from "lucide-react";
import { toast } from "sonner";
import { Textarea } from "@/components/ui/textarea";
import { useLocation } from "wouter";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";

export default function ValidacaoLider() {
  const [, setLocation] = useLocation();
  const navigate = (path: string) => setLocation(path);

  const [statusFilter, setStatusFilter] = useState<string>("all");
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedIds, setSelectedIds] = useState<number[]>([]);
  const [approvalDialog, setApprovalDialog] = useState(false);
  const [rejectDialog, setRejectDialog] = useState(false);
  const [comments, setComments] = useState("");

  const { data: jobDescriptions, refetch } = trpc.jobDescriptions.list.useQuery({
    status: statusFilter === "all" ? undefined : statusFilter as any,
  });

  const filteredDescriptions = jobDescriptions?.filter((desc) => {
    const matchesSearch = desc.positionTitle.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         desc.departmentName.toLowerCase().includes(searchTerm.toLowerCase());
    return matchesSearch;
  });

  const getStatusBadge = (status: string) => {
    const variants: Record<string, { label: string; variant: any; icon: any }> = {
      draft: { label: "Rascunho", variant: "secondary", icon: FileText },
      pending_occupant: { label: "Pendente Ocupante", variant: "default", icon: Clock },
      pending_manager: { label: "Pendente Superior", variant: "default", icon: Clock },
      pending_hr: { label: "Pendente RH", variant: "default", icon: Clock },
      approved: { label: "Aprovado", variant: "default", icon: CheckCircle },
      rejected: { label: "Rejeitado", variant: "destructive", icon: XCircle },
    };
    const config = variants[status] || variants.draft;
    const Icon = config.icon;
    return (
      <Badge variant={config.variant} className="flex items-center gap-1">
        <Icon className="w-3 h-3" />
        {config.label}
      </Badge>
    );
  };

  const handleBulkApprove = () => {
    if (selectedIds.length === 0) {
      toast.error("Selecione pelo menos uma descriÃ§Ã£o");
      return;
    }
    setApprovalDialog(true);
  };

  const handleBulkReject = () => {
    if (selectedIds.length === 0) {
      toast.error("Selecione pelo menos uma descriÃ§Ã£o");
      return;
    }
    setRejectDialog(true);
  };

  const confirmApprove = () => {
    toast.success(`${selectedIds.length} descriÃ§Ã£o(Ãµes) aprovada(s)!`);
    setSelectedIds([]);
    setApprovalDialog(false);
    refetch();
  };

  const confirmReject = () => {
    if (!comments.trim()) {
      toast.error("ComentÃ¡rio Ã© obrigatÃ³rio para rejeiÃ§Ã£o");
      return;
    }
    toast.success(`${selectedIds.length} descriÃ§Ã£o(Ãµes) rejeitada(s)!`);
    setSelectedIds([]);
    setRejectDialog(false);
    setComments("");
    refetch();
  };

  const toggleSelection = (id: number) => {
    setSelectedIds(prev =>
      prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
    );
  };

  const totalDescriptions = filteredDescriptions?.length || 0;
  const pendingCount = filteredDescriptions?.filter(d => d.status.includes('pending')).length || 0;
  const approvedCount = filteredDescriptions?.filter(d => d.status === 'approved').length || 0;
  const rejectedCount = filteredDescriptions?.filter(d => d.status === 'rejected').length || 0;

  return (
    <DashboardLayout>
      <div className="container mx-auto py-8">
        <div className="mb-8">
          <h1 className="text-3xl font-bold mb-2">ValidaÃ§Ã£o de DescriÃ§Ãµes de Cargo</h1>
          <p className="text-muted-foreground">Aprove ou rejeite descriÃ§Ãµes de cargo de sua equipe</p>
        </div>

        {/* MÃ©tricas */}
        <div className="grid grid-cols-4 gap-4 mb-8">
          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <FileText className="w-4 h-4" />
                Total
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{totalDescriptions}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <Clock className="w-4 h-4" />
                Pendentes
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-orange-600">{pendingCount}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <CheckCircle className="w-4 h-4" />
                Aprovadas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-green-600">{approvedCount}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-medium text-muted-foreground flex items-center gap-2">
                <XCircle className="w-4 h-4" />
                Rejeitadas
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-red-600">{rejectedCount}</div>
            </CardContent>
          </Card>
        </div>

        {/* Filtros */}
        <Card className="mb-6">
          <CardContent className="pt-6">
            <div className="flex gap-4 items-end">
              <div className="flex-1">
                <label className="text-sm font-medium mb-2 block">Buscar</label>
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                  <Input
                    placeholder="Buscar por cargo ou departamento..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10"
                  />
                </div>
              </div>

              <div className="w-64">
                <label className="text-sm font-medium mb-2 block">Status</label>
                <Select value={statusFilter} onValueChange={setStatusFilter}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos</SelectItem>
                    <SelectItem value="pending_occupant">Pendente Ocupante</SelectItem>
                    <SelectItem value="pending_manager">Pendente Superior</SelectItem>
                    <SelectItem value="pending_hr">Pendente RH</SelectItem>
                    <SelectItem value="approved">Aprovado</SelectItem>
                    <SelectItem value="rejected">Rejeitado</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="flex gap-2">
                <Button
                  onClick={handleBulkApprove}
                  disabled={selectedIds.length === 0}
                >
                  <CheckCircle className="w-4 h-4 mr-2" />
                  Aprovar ({selectedIds.length})
                </Button>
                <Button
                  onClick={handleBulkReject}
                  disabled={selectedIds.length === 0}
                  variant="destructive"
                >
                  <XCircle className="w-4 h-4 mr-2" />
                  Rejeitar ({selectedIds.length})
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Lista */}
        <div className="grid grid-cols-1 gap-4">
          {filteredDescriptions?.map((desc) => (
            <Card key={desc.id} className={selectedIds.includes(desc.id) ? "border-primary" : ""}>
              <CardContent className="pt-6">
                <div className="flex items-start gap-4">
                  <input
                    type="checkbox"
                    checked={selectedIds.includes(desc.id)}
                    onChange={() => toggleSelection(desc.id)}
                    className="mt-1 w-4 h-4"
                  />
                  <div className="flex-1">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <h3 className="text-lg font-semibold">{desc.positionTitle}</h3>
                        <p className="text-sm text-muted-foreground">{desc.departmentName}</p>
                      </div>
                      {getStatusBadge(desc.status)}
                    </div>
                    <p className="text-sm text-muted-foreground mb-3">
                      {desc.mainObjective?.substring(0, 150)}...
                    </p>
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => navigate(`/descricao-cargos-uisa/${desc.id}`)}
                    >
                      Ver Detalhes
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}

          {(!filteredDescriptions || filteredDescriptions.length === 0) && (
            <Card>
              <CardContent className="py-12 text-center text-muted-foreground">
                Nenhuma descriÃ§Ã£o de cargo encontrada
              </CardContent>
            </Card>
          )}
        </div>

        {/* Dialogs */}
        <Dialog open={approvalDialog} onOpenChange={setApprovalDialog}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Aprovar DescriÃ§Ãµes Selecionadas</DialogTitle>
            </DialogHeader>
            <div className="py-4">
              <p>VocÃª estÃ¡ prestes a aprovar {selectedIds.length} descriÃ§Ã£o(Ãµes) de cargo.</p>
              <Textarea
                placeholder="ComentÃ¡rios (opcional)"
                value={comments}
                onChange={(e) => setComments(e.target.value)}
                className="mt-4"
                rows={3}
              />
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setApprovalDialog(false)}>
                Cancelar
              </Button>
              <Button onClick={confirmApprove}>
                Confirmar AprovaÃ§Ã£o
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        <Dialog open={rejectDialog} onOpenChange={setRejectDialog}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Rejeitar DescriÃ§Ãµes Selecionadas</DialogTitle>
            </DialogHeader>
            <div className="py-4">
              <p className="mb-4">VocÃª estÃ¡ prestes a rejeitar {selectedIds.length} descriÃ§Ã£o(Ãµes) de cargo.</p>
              <label className="text-sm font-medium mb-2 block">Motivo da RejeiÃ§Ã£o *</label>
              <Textarea
                placeholder="Descreva o motivo da rejeiÃ§Ã£o..."
                value={comments}
                onChange={(e) => setComments(e.target.value)}
                rows={4}
                required
              />
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setRejectDialog(false)}>
                Cancelar
              </Button>
              <Button variant="destructive" onClick={confirmReject}>
                Confirmar RejeiÃ§Ã£o
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/ImportacaoDescricoes.tsx
========================================
import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { trpc } from "@/lib/trpc";
import DashboardLayout from "@/components/DashboardLayout";
import { Upload, FileText, CheckCircle, XCircle, AlertCircle, Loader2 } from "lucide-react";
import { toast } from "sonner";
import { Progress } from "@/components/ui/progress";

export default function ImportacaoDescricoes() {
  const [importing, setImporting] = useState(false);
  const [progress, setProgress] = useState(0);
  const [results, setResults] = useState<any>(null);

  const importMutation = trpc.import.importBulk.useMutation({
    onSuccess: (data: any) => {
      setResults(data);
      setImporting(false);
      toast.success(`ImportaÃ§Ã£o concluÃ­da! ${data.success} descriÃ§Ãµes importadas.`);
    },
    onError: (error: any) => {
      setImporting(false);
      toast.error("Erro na importaÃ§Ã£o: " + error.message);
    },
  });

  const handleImport = async () => {
    setImporting(true);
    setProgress(0);
    setResults(null);

    // Simular progresso
    const interval = setInterval(() => {
      setProgress((prev) => {
        if (prev >= 90) {
          clearInterval(interval);
          return 90;
        }
        return prev + 10;
      });
    }, 500);

    try {
      await importMutation.mutateAsync({});
      setProgress(100);
      clearInterval(interval);
    } catch (err) {
      clearInterval(interval);
    }
  };

  return (
    <DashboardLayout>
      <div className="container mx-auto py-8 max-w-4xl">
        <div className="mb-8">
          <h1 className="text-3xl font-bold mb-2">ImportaÃ§Ã£o em Massa de DescriÃ§Ãµes de Cargo</h1>
          <p className="text-muted-foreground">
            Importe automaticamente todas as descriÃ§Ãµes de cargo dos arquivos .docx
          </p>
        </div>

        {/* Status da ImportaÃ§Ã£o */}
        <Card className="mb-6">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Upload className="w-5 h-5" />
              Status da ImportaÃ§Ã£o
            </CardTitle>
          </CardHeader>
          <CardContent>
            {!importing && !results && (
              <div className="text-center py-8">
                <FileText className="w-16 h-16 mx-auto mb-4 text-muted-foreground" />
                <p className="text-muted-foreground mb-4">
                  Pronto para importar 100+ descriÃ§Ãµes de cargo
                </p>
                <Button onClick={handleImport} size="lg">
                  <Upload className="w-4 h-4 mr-2" />
                  Iniciar ImportaÃ§Ã£o
                </Button>
              </div>
            )}

            {importing && (
              <div className="py-8">
                <div className="flex items-center justify-center mb-4">
                  <Loader2 className="w-8 h-8 animate-spin text-primary" />
                </div>
                <p className="text-center text-muted-foreground mb-4">
                  Importando descriÃ§Ãµes de cargo...
                </p>
                <Progress value={progress} className="h-3" />
                <p className="text-center text-sm text-muted-foreground mt-2">
                  {progress}% concluÃ­do
                </p>
              </div>
            )}

            {results && (
              <div className="space-y-4">
                <div className="grid grid-cols-3 gap-4">
                  <div className="text-center p-4 bg-green-50 dark:bg-green-950 rounded-lg">
                    <CheckCircle className="w-8 h-8 mx-auto mb-2 text-green-600" />
                    <div className="text-2xl font-bold text-green-600">{results.success}</div>
                    <div className="text-sm text-muted-foreground">Sucesso</div>
                  </div>
                  <div className="text-center p-4 bg-red-50 dark:bg-red-950 rounded-lg">
                    <XCircle className="w-8 h-8 mx-auto mb-2 text-red-600" />
                    <div className="text-2xl font-bold text-red-600">{results.failed}</div>
                    <div className="text-sm text-muted-foreground">Falhas</div>
                  </div>
                  <div className="text-center p-4 bg-blue-50 dark:bg-blue-950 rounded-lg">
                    <FileText className="w-8 h-8 mx-auto mb-2 text-blue-600" />
                    <div className="text-2xl font-bold text-blue-600">{results.total}</div>
                    <div className="text-sm text-muted-foreground">Total</div>
                  </div>
                </div>

                {results.errors && results.errors.length > 0 && (
                  <div className="mt-6">
                    <h3 className="font-semibold mb-3 flex items-center gap-2">
                      <AlertCircle className="w-5 h-5 text-orange-600" />
                      Erros Encontrados
                    </h3>
                    <div className="space-y-2 max-h-64 overflow-y-auto">
                      {results.errors.map((error: any, index: number) => (
                        <div key={index} className="p-3 bg-muted rounded-md text-sm">
                          <strong>{error.file}:</strong> {error.message}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <div className="flex gap-2 mt-6">
                  <Button onClick={() => setResults(null)} variant="outline">
                    Limpar Resultados
                  </Button>
                  <Button onClick={handleImport}>
                    Importar Novamente
                  </Button>
                </div>
              </div>
            )}
          </CardContent>
        </Card>

        {/* InformaÃ§Ãµes */}
        <Card>
          <CardHeader>
            <CardTitle>Como Funciona</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3 text-sm text-muted-foreground">
              <p>
                <strong>1. ExtraÃ§Ã£o AutomÃ¡tica:</strong> O sistema lÃª todos os arquivos .docx de descriÃ§Ãµes de cargo
                e extrai automaticamente as seÃ§Ãµes: Objetivo Principal, Responsabilidades, Conhecimentos TÃ©cnicos,
                Treinamentos, CompetÃªncias, QualificaÃ§Ã£o e e-Social.
              </p>
              <p>
                <strong>2. ValidaÃ§Ã£o:</strong> Cada descriÃ§Ã£o Ã© validada antes de ser inserida no banco de dados.
                Campos obrigatÃ³rios sÃ£o verificados e dados inconsistentes sÃ£o reportados.
              </p>
              <p>
                <strong>3. PopulaÃ§Ã£o do Banco:</strong> DescriÃ§Ãµes vÃ¡lidas sÃ£o inseridas no banco com todas as
                relaÃ§Ãµes (responsabilidades, conhecimentos, competÃªncias) jÃ¡ vinculadas.
              </p>
              <p>
                <strong>4. RelatÃ³rio:</strong> Ao final, vocÃª recebe um relatÃ³rio completo com sucessos, falhas
                e detalhes de cada erro encontrado.
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Alertas.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Checkbox } from "@/components/ui/checkbox";
import { AlertTriangle, CheckCircle2, XCircle, Mail, Calendar, FileWarning, Clock, TrendingDown, Activity } from "lucide-react";
import { toast } from "sonner";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

type AlertSeverity = "critical" | "high" | "medium" | "low";
type AlertStatus = "active" | "resolved" | "dismissed";

const severityConfig = {
  critical: { label: "CrÃ­tico", color: "bg-red-500", icon: AlertTriangle },
  high: { label: "Alto", color: "bg-orange-500", icon: FileWarning },
  medium: { label: "MÃ©dio", color: "bg-yellow-500", icon: Clock },
  low: { label: "Baixo", color: "bg-blue-500", icon: Activity },
};

export default function Alertas() {
  const [selectedStatus, setSelectedStatus] = useState<AlertStatus>("active");
  const [selectedSeverity, setSelectedSeverity] = useState<AlertSeverity | "all">("all");
  const [selectedAlerts, setSelectedAlerts] = useState<number[]>([]);
  const [resolveDialogOpen, setResolveDialogOpen] = useState(false);
  const [dismissDialogOpen, setDismissDialogOpen] = useState(false);
  const [emailDialogOpen, setEmailDialogOpen] = useState(false);
  const [currentAlertId, setCurrentAlertId] = useState<number | null>(null);
  const [resolutionNotes, setResolutionNotes] = useState("");
  const [actionTaken, setActionTaken] = useState<"email_sent" | "meeting_scheduled" | "warning_issued" | "training_assigned" | "none">("none");
  const [emailRecipient, setEmailRecipient] = useState("");
  const [emailMessage, setEmailMessage] = useState("");

  const utils = trpc.useUtils();

  // Queries
  const { data: stats } = trpc.alerts.getStats.useQuery();
  const { data: alerts = [], isLoading } = trpc.alerts.list.useQuery({
    status: selectedStatus,
    severity: selectedSeverity === "all" ? undefined : selectedSeverity,
  });

  // Mutations
  const resolveMutation = trpc.alerts.resolve.useMutation({
    onSuccess: () => {
      toast.success("Alerta resolvido com sucesso!");
      utils.alerts.list.invalidate();
      utils.alerts.getStats.invalidate();
      setResolveDialogOpen(false);
      setResolutionNotes("");
      setActionTaken("none");
    },
    onError: (error) => {
      toast.error(`Erro ao resolver alerta: ${error.message}`);
    },
  });

  const dismissMutation = trpc.alerts.dismiss.useMutation({
    onSuccess: () => {
      toast.success("Alerta dispensado com sucesso!");
      utils.alerts.list.invalidate();
      utils.alerts.getStats.invalidate();
      setDismissDialogOpen(false);
      setResolutionNotes("");
    },
    onError: (error) => {
      toast.error(`Erro ao dispensar alerta: ${error.message}`);
    },
  });

  const sendEmailMutation = trpc.alerts.sendAlertEmail.useMutation({
    onSuccess: () => {
      toast.success("E-mail enviado com sucesso!");
      utils.alerts.list.invalidate();
      setEmailDialogOpen(false);
      setEmailRecipient("");
      setEmailMessage("");
    },
    onError: (error) => {
      toast.error(`Erro ao enviar e-mail: ${error.message}`);
    },
  });

  const bulkActionMutation = trpc.alerts.bulkAction.useMutation({
    onSuccess: (data) => {
      toast.success(`${data.processed} de ${data.total} alertas processados com sucesso!`);
      utils.alerts.list.invalidate();
      utils.alerts.getStats.invalidate();
      setSelectedAlerts([]);
    },
    onError: (error) => {
      toast.error(`Erro ao processar alertas: ${error.message}`);
    },
  });

  const handleResolve = (alertId: number) => {
    setCurrentAlertId(alertId);
    setResolveDialogOpen(true);
  };

  const handleDismiss = (alertId: number) => {
    setCurrentAlertId(alertId);
    setDismissDialogOpen(true);
  };

  const handleSendEmail = (alertId: number) => {
    setCurrentAlertId(alertId);
    setEmailDialogOpen(true);
  };

  const confirmResolve = () => {
    if (!currentAlertId) return;
    resolveMutation.mutate({
      alertId: currentAlertId,
      resolutionNotes,
      actionTaken,
    });
  };

  const confirmDismiss = () => {
    if (!currentAlertId) return;
    dismissMutation.mutate({
      alertId: currentAlertId,
      reason: resolutionNotes,
    });
  };

  const confirmSendEmail = () => {
    if (!currentAlertId) return;
    sendEmailMutation.mutate({
      alertId: currentAlertId,
      recipientEmail: emailRecipient,
      message: emailMessage,
    });
  };

  const handleBulkResolve = () => {
    if (selectedAlerts.length === 0) {
      toast.error("Selecione pelo menos um alerta");
      return;
    }
    bulkActionMutation.mutate({
      alertIds: selectedAlerts,
      action: "resolve",
      notes: "Resolvido em lote",
    });
  };

  const handleBulkDismiss = () => {
    if (selectedAlerts.length === 0) {
      toast.error("Selecione pelo menos um alerta");
      return;
    }
    bulkActionMutation.mutate({
      alertIds: selectedAlerts,
      action: "dismiss",
      notes: "Dispensado em lote",
    });
  };

  const toggleAlertSelection = (alertId: number) => {
    setSelectedAlerts(prev =>
      prev.includes(alertId)
        ? prev.filter(id => id !== alertId)
        : [...prev, alertId]
    );
  };

  const toggleSelectAll = () => {
    if (selectedAlerts.length === alerts.length) {
      setSelectedAlerts([]);
    } else {
      setSelectedAlerts(alerts.map(a => a.id));
    }
  };

  return (
    <div className="container py-8">
      <div className="mb-8">
        <h1 className="text-3xl font-bold mb-2">Dashboard de Alertas</h1>
        <p className="text-muted-foreground">
          Central de gestÃ£o de alertas de produtividade e desempenho
        </p>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Total de Alertas</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats?.total || 0}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Alertas Ativos</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-orange-600">{stats?.active || 0}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Alertas CrÃ­ticos</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">{stats?.critical || 0}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Alertas Resolvidos</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">{stats?.resolved || 0}</div>
          </CardContent>
        </Card>
      </div>

      {/* Filtros */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle>Filtros</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-4">
            <div className="flex-1 min-w-[200px]">
              <label className="text-sm font-medium mb-2 block">Status</label>
              <Tabs value={selectedStatus} onValueChange={(v) => setSelectedStatus(v as AlertStatus)}>
                <TabsList>
                  <TabsTrigger value="active">Ativos</TabsTrigger>
                  <TabsTrigger value="resolved">Resolvidos</TabsTrigger>
                  <TabsTrigger value="dismissed">Dispensados</TabsTrigger>
                </TabsList>
              </Tabs>
            </div>
            <div className="flex-1 min-w-[200px]">
              <label className="text-sm font-medium mb-2 block">Severidade</label>
              <Select value={selectedSeverity} onValueChange={(v) => setSelectedSeverity(v as AlertSeverity | "all")}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todas</SelectItem>
                  <SelectItem value="critical">CrÃ­tico</SelectItem>
                  <SelectItem value="high">Alto</SelectItem>
                  <SelectItem value="medium">MÃ©dio</SelectItem>
                  <SelectItem value="low">Baixo</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* AÃ§Ãµes em Lote */}
      {selectedAlerts.length > 0 && (
        <Card className="mb-6 border-blue-200 bg-blue-50">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <span className="font-medium">{selectedAlerts.length} alerta(s) selecionado(s)</span>
              <div className="flex gap-2">
                <Button onClick={handleBulkResolve} size="sm" variant="default">
                  <CheckCircle2 className="mr-2 h-4 w-4" />
                  Resolver Selecionados
                </Button>
                <Button onClick={handleBulkDismiss} size="sm" variant="outline">
                  <XCircle className="mr-2 h-4 w-4" />
                  Dispensar Selecionados
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Lista de Alertas */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle>Alertas</CardTitle>
            <Checkbox
              checked={selectedAlerts.length === alerts.length && alerts.length > 0}
              onCheckedChange={toggleSelectAll}
            />
          </div>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="text-center py-8 text-muted-foreground">Carregando...</div>
          ) : alerts.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">Nenhum alerta encontrado</div>
          ) : (
            <div className="space-y-4">
              {alerts.map((alert) => {
                const SeverityIcon = severityConfig[alert.severity as AlertSeverity].icon;
                return (
                  <div
                    key={alert.id}
                    className="border rounded-lg p-4 hover:bg-accent/50 transition-colors"
                  >
                    <div className="flex items-start gap-4">
                      <Checkbox
                        checked={selectedAlerts.includes(alert.id)}
                        onCheckedChange={() => toggleAlertSelection(alert.id)}
                      />
                      <div className={`p-2 rounded-full ${severityConfig[alert.severity as AlertSeverity].color} text-white`}>
                        <SeverityIcon className="h-5 w-5" />
                      </div>
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <h3 className="font-semibold">{alert.title}</h3>
                          <Badge variant="outline">{severityConfig[alert.severity as AlertSeverity].label}</Badge>
                          {alert.actionTaken && alert.actionTaken !== "none" && (
                            <Badge variant="secondary">{alert.actionTaken.replace("_", " ")}</Badge>
                          )}
                        </div>
                        <p className="text-sm text-muted-foreground mb-2">{alert.description}</p>
                        <div className="flex items-center gap-4 text-xs text-muted-foreground">
                          <span>
                            <strong>Colaborador:</strong> {alert.employeeName} ({alert.employeeCode})
                          </span>
                          <span>
                            <strong>Data:</strong> {format(new Date(alert.createdAt), "dd/MM/yyyy HH:mm", { locale: ptBR })}
                          </span>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        {selectedStatus === "active" && (
                          <>
                            <Button onClick={() => handleSendEmail(alert.id)} size="sm" variant="outline">
                              <Mail className="mr-2 h-4 w-4" />
                              E-mail
                            </Button>
                            <Button onClick={() => handleResolve(alert.id)} size="sm" variant="default">
                              <CheckCircle2 className="mr-2 h-4 w-4" />
                              Resolver
                            </Button>
                            <Button onClick={() => handleDismiss(alert.id)} size="sm" variant="ghost">
                              <XCircle className="mr-2 h-4 w-4" />
                              Dispensar
                            </Button>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Dialog de Resolver */}
      <Dialog open={resolveDialogOpen} onOpenChange={setResolveDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Resolver Alerta</DialogTitle>
            <DialogDescription>
              Registre as aÃ§Ãµes tomadas para resolver este alerta
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div>
              <label className="text-sm font-medium mb-2 block">AÃ§Ã£o Tomada</label>
              <Select value={actionTaken} onValueChange={(v: any) => setActionTaken(v)}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">Nenhuma</SelectItem>
                  <SelectItem value="email_sent">E-mail Enviado</SelectItem>
                  <SelectItem value="meeting_scheduled">ReuniÃ£o Agendada</SelectItem>
                  <SelectItem value="warning_issued">AdvertÃªncia Emitida</SelectItem>
                  <SelectItem value="training_assigned">Treinamento AtribuÃ­do</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <label className="text-sm font-medium mb-2 block">Notas de ResoluÃ§Ã£o</label>
              <Textarea
                value={resolutionNotes}
                onChange={(e) => setResolutionNotes(e.target.value)}
                placeholder="Descreva as aÃ§Ãµes tomadas..."
                rows={4}
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setResolveDialogOpen(false)}>
              Cancelar
            </Button>
            <Button onClick={confirmResolve} disabled={resolveMutation.isPending}>
              {resolveMutation.isPending ? "Resolvendo..." : "Resolver"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog de Dispensar */}
      <Dialog open={dismissDialogOpen} onOpenChange={setDismissDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Dispensar Alerta</DialogTitle>
            <DialogDescription>
              Informe o motivo para dispensar este alerta
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <Textarea
              value={resolutionNotes}
              onChange={(e) => setResolutionNotes(e.target.value)}
              placeholder="Motivo da dispensa..."
              rows={4}
            />
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setDismissDialogOpen(false)}>
              Cancelar
            </Button>
            <Button onClick={confirmDismiss} disabled={dismissMutation.isPending}>
              {dismissMutation.isPending ? "Dispensando..." : "Dispensar"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog de Enviar E-mail */}
      <Dialog open={emailDialogOpen} onOpenChange={setEmailDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Enviar E-mail sobre Alerta</DialogTitle>
            <DialogDescription>
              Envie um e-mail para o gestor ou RH sobre este alerta
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div>
              <label className="text-sm font-medium mb-2 block">E-mail do DestinatÃ¡rio</label>
              <Input
                type="email"
                value={emailRecipient}
                onChange={(e) => setEmailRecipient(e.target.value)}
                placeholder="exemplo@empresa.com"
              />
            </div>
            <div>
              <label className="text-sm font-medium mb-2 block">Mensagem</label>
              <Textarea
                value={emailMessage}
                onChange={(e) => setEmailMessage(e.target.value)}
                placeholder="Mensagem adicional..."
                rows={4}
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setEmailDialogOpen(false)}>
              Cancelar
            </Button>
            <Button onClick={confirmSendEmail} disabled={sendEmailMutation.isPending}>
              {sendEmailMutation.isPending ? "Enviando..." : "Enviar E-mail"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/Discrepancias.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";
import { AlertTriangle, TrendingUp, TrendingDown, Users, Calendar } from "lucide-react";
import { toast } from "sonner";
import { format, subDays } from "date-fns";
import { ptBR } from "date-fns/locale";

export default function Discrepancias() {
  const [startDate, setStartDate] = useState(format(subDays(new Date(), 30), "yyyy-MM-dd"));
  const [endDate, setEndDate] = useState(format(new Date(), "yyyy-MM-dd"));
  const [selectedStatus, setSelectedStatus] = useState<"pending" | "reviewed" | "justified" | "flagged" | "all">("all");
  const [minPercentage, setMinPercentage] = useState<number>(0);
  const [justifyDialogOpen, setJustifyDialogOpen] = useState(false);
  const [currentDiscrepancyId, setCurrentDiscrepancyId] = useState<number | null>(null);
  const [justification, setJustification] = useState("");

  const utils = trpc.useUtils();

  // Queries
  const { data: stats } = trpc.timeClock.getStats.useQuery({
    startDate,
    endDate,
  });

  const { data: discrepancies = [], isLoading } = trpc.timeClock.listDiscrepancies.useQuery({
    status: selectedStatus === "all" ? undefined : selectedStatus,
    minPercentage: minPercentage > 0 ? minPercentage : undefined,
    limit: 100,
  });

  // Mutation
  const justifyMutation = trpc.timeClock.justifyDiscrepancy.useMutation({
    onSuccess: () => {
      toast.success("DiscrepÃ¢ncia justificada com sucesso!");
      utils.timeClock.listDiscrepancies.invalidate();
      setJustifyDialogOpen(false);
      setJustification("");
    },
    onError: (error) => {
      toast.error(`Erro ao justificar: ${error.message}`);
    },
  });

  // Processar dados para grÃ¡ficos
  const trendData = discrepancies
    .reduce((acc, d) => {
      const dateKey = format(new Date(d.date), "dd/MM");
      const existing = acc.find(item => item.date === dateKey);
      if (existing) {
        existing.count += 1;
        existing.avgPercentage = (existing.avgPercentage + parseFloat(d.differencePercentage || "0")) / 2;
      } else {
        acc.push({
          date: dateKey,
          count: 1,
          avgPercentage: parseFloat(d.differencePercentage || "0"),
        });
      }
      return acc;
    }, [] as Array<{ date: string; count: number; avgPercentage: number }>)
    .sort((a, b) => {
      const [dayA, monthA] = a.date.split("/").map(Number);
      const [dayB, monthB] = b.date.split("/").map(Number);
      return monthA === monthB ? dayA - dayB : monthA - monthB;
    });

  // Ranking de colaboradores
  const employeeRanking = discrepancies
    .reduce((acc, d) => {
      const key = `${d.employeeId}-${d.employeeName}`;
      const existing = acc.find(item => item.key === key);
      if (existing) {
        existing.count += 1;
        existing.totalPercentage += parseFloat(d.differencePercentage || "0");
        existing.avgPercentage = existing.totalPercentage / existing.count;
      } else {
        acc.push({
          key,
          employeeId: d.employeeId,
          employeeName: d.employeeName || "Desconhecido",
          employeeCode: d.employeeCode || "",
          count: 1,
          totalPercentage: parseFloat(d.differencePercentage || "0"),
          avgPercentage: parseFloat(d.differencePercentage || "0"),
        });
      }
      return acc;
    }, [] as Array<{ key: string; employeeId: number; employeeName: string; employeeCode: string; count: number; totalPercentage: number; avgPercentage: number }>)
    .sort((a, b) => b.avgPercentage - a.avgPercentage)
    .slice(0, 10);

  const handleJustify = (discrepancyId: number) => {
    setCurrentDiscrepancyId(discrepancyId);
    setJustifyDialogOpen(true);
  };

  const confirmJustify = () => {
    if (!currentDiscrepancyId) return;
    justifyMutation.mutate({
      discrepancyId: currentDiscrepancyId,
      justification,
    });
  };

  const getDiscrepancyColor = (percentage: string) => {
    const pct = parseFloat(percentage);
    if (pct > 50) return "text-red-600";
    if (pct > 30) return "text-orange-600";
    if (pct > 20) return "text-yellow-600";
    return "text-green-600";
  };

  const getDiscrepancyBadge = (type: string) => {
    switch (type) {
      case "over_reported":
        return <Badge variant="destructive">Excesso de Atividades</Badge>;
      case "under_reported":
        return <Badge variant="secondary">Falta de Atividades</Badge>;
      case "acceptable":
        return <Badge variant="outline">AceitÃ¡vel</Badge>;
      default:
        return <Badge>{type}</Badge>;
    }
  };

  return (
    <div className="container py-8">
      <div className="mb-8">
        <h1 className="text-3xl font-bold mb-2">DiscrepÃ¢ncias de Ponto vs Atividades</h1>
        <p className="text-muted-foreground">
          AnÃ¡lise de inconsistÃªncias entre horas registradas no ponto eletrÃ´nico e atividades manuais
        </p>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium flex items-center gap-2">
              <Calendar className="h-4 w-4" />
              Total de Registros de Ponto
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats?.totalRecords || 0}</div>
            <p className="text-xs text-muted-foreground mt-1">No perÃ­odo selecionado</p>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium flex items-center gap-2">
              <AlertTriangle className="h-4 w-4" />
              Total de DiscrepÃ¢ncias
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-orange-600">{stats?.totalDiscrepancies || 0}</div>
            <p className="text-xs text-muted-foreground mt-1">
              {stats?.totalRecords ? ((stats.totalDiscrepancies / stats.totalRecords) * 100).toFixed(1) : 0}% dos registros
            </p>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium flex items-center gap-2">
              <TrendingUp className="h-4 w-4" />
              DiscrepÃ¢ncias CrÃ­ticas
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">{stats?.criticalDiscrepancies || 0}</div>
            <p className="text-xs text-muted-foreground mt-1">&gt; 50% de diferenÃ§a</p>
          </CardContent>
        </Card>
      </div>

      {/* Filtros */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle>Filtros</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label className="text-sm font-medium mb-2 block">Data InÃ­cio</label>
              <Input
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
              />
            </div>
            <div>
              <label className="text-sm font-medium mb-2 block">Data Fim</label>
              <Input
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
              />
            </div>
            <div>
              <label className="text-sm font-medium mb-2 block">Status</label>
              <Select value={selectedStatus} onValueChange={(v: any) => setSelectedStatus(v)}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos</SelectItem>
                  <SelectItem value="pending">Pendente</SelectItem>
                  <SelectItem value="reviewed">Revisado</SelectItem>
                  <SelectItem value="justified">Justificado</SelectItem>
                  <SelectItem value="flagged">Sinalizado</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <label className="text-sm font-medium mb-2 block">DiferenÃ§a MÃ­nima (%)</label>
              <Input
                type="number"
                min="0"
                max="100"
                value={minPercentage}
                onChange={(e) => setMinPercentage(parseInt(e.target.value) || 0)}
                placeholder="0"
              />
            </div>
          </div>
        </CardContent>
      </Card>

      {/* GrÃ¡fico de TendÃªncias */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle>TendÃªncia de DiscrepÃ¢ncias</CardTitle>
          <CardDescription>EvoluÃ§Ã£o temporal das inconsistÃªncias</CardDescription>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={trendData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="date" />
              <YAxis yAxisId="left" />
              <YAxis yAxisId="right" orientation="right" />
              <Tooltip />
              <Legend />
              <Line
                yAxisId="left"
                type="monotone"
                dataKey="count"
                stroke="#8884d8"
                name="Quantidade"
                strokeWidth={2}
              />
              <Line
                yAxisId="right"
                type="monotone"
                dataKey="avgPercentage"
                stroke="#82ca9d"
                name="% MÃ©dia"
                strokeWidth={2}
              />
            </LineChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>

      {/* Ranking de Colaboradores */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle>Top 10 Colaboradores com Maiores InconsistÃªncias</CardTitle>
          <CardDescription>Ranking por mÃ©dia de discrepÃ¢ncia</CardDescription>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={400}>
            <BarChart data={employeeRanking} layout="vertical">
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis type="number" />
              <YAxis dataKey="employeeName" type="category" width={150} />
              <Tooltip />
              <Legend />
              <Bar dataKey="avgPercentage" fill="#f59e0b" name="% MÃ©dia de DiscrepÃ¢ncia" />
            </BarChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>

      {/* Tabela de DiscrepÃ¢ncias */}
      <Card>
        <CardHeader>
          <CardTitle>DiscrepÃ¢ncias Detalhadas</CardTitle>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="text-center py-8 text-muted-foreground">Carregando...</div>
          ) : discrepancies.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">Nenhuma discrepÃ¢ncia encontrada</div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4">Colaborador</th>
                    <th className="text-left py-3 px-4">Data</th>
                    <th className="text-right py-3 px-4">Ponto (min)</th>
                    <th className="text-right py-3 px-4">Atividades (min)</th>
                    <th className="text-right py-3 px-4">DiferenÃ§a</th>
                    <th className="text-center py-3 px-4">Tipo</th>
                    <th className="text-center py-3 px-4">Status</th>
                    <th className="text-center py-3 px-4">AÃ§Ãµes</th>
                  </tr>
                </thead>
                <tbody>
                  {discrepancies.map((disc) => (
                    <tr key={disc.id} className="border-b hover:bg-accent/50">
                      <td className="py-3 px-4">
                        <div>
                          <div className="font-medium">{disc.employeeName}</div>
                          <div className="text-xs text-muted-foreground">{disc.employeeCode}</div>
                        </div>
                      </td>
                      <td className="py-3 px-4">
                        {format(new Date(disc.date), "dd/MM/yyyy", { locale: ptBR })}
                      </td>
                      <td className="text-right py-3 px-4">{disc.clockMinutes}</td>
                      <td className="text-right py-3 px-4">{disc.activityMinutes}</td>
                      <td className={`text-right py-3 px-4 font-bold ${getDiscrepancyColor(disc.differencePercentage || "0")}`}>
                        {disc.differenceMinutes > 0 ? "+" : ""}{disc.differenceMinutes} min
                        <div className="text-xs">({parseFloat(disc.differencePercentage || "0").toFixed(1)}%)</div>
                      </td>
                      <td className="text-center py-3 px-4">
                        {getDiscrepancyBadge(disc.discrepancyType)}
                      </td>
                      <td className="text-center py-3 px-4">
                        <Badge variant={disc.status === "justified" ? "default" : "secondary"}>
                          {disc.status === "pending" ? "Pendente" :
                           disc.status === "reviewed" ? "Revisado" :
                           disc.status === "justified" ? "Justificado" : "Sinalizado"}
                        </Badge>
                      </td>
                      <td className="text-center py-3 px-4">
                        {disc.status === "pending" && (
                          <Button
                            onClick={() => handleJustify(disc.id)}
                            size="sm"
                            variant="outline"
                          >
                            Justificar
                          </Button>
                        )}
                        {disc.status === "justified" && disc.justification && (
                          <Button
                            onClick={() => {
                              toast.info(disc.justification || "Sem justificativa");
                            }}
                            size="sm"
                            variant="ghost"
                          >
                            Ver Justificativa
                          </Button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Dialog de Justificativa */}
      <Dialog open={justifyDialogOpen} onOpenChange={setJustifyDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Justificar DiscrepÃ¢ncia</DialogTitle>
            <DialogDescription>
              ForneÃ§a uma justificativa para esta inconsistÃªncia entre ponto e atividades
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <Textarea
              value={justification}
              onChange={(e) => setJustification(e.target.value)}
              placeholder="Ex: Colaborador estava em reuniÃ£o externa sem acesso ao sistema..."
              rows={4}
            />
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setJustifyDialogOpen(false)}>
              Cancelar
            </Button>
            <Button onClick={confirmJustify} disabled={justifyMutation.isPending || !justification}>
              {justifyMutation.isPending ? "Justificando..." : "Justificar"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/ImportacaoPonto.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Upload, FileSpreadsheet, CheckCircle, XCircle, AlertTriangle, Download } from "lucide-react";
import { toast } from "sonner";

interface ParsedRecord {
  employeeId: number;
  employeeCode?: string;
  date: string;
  clockIn?: string;
  clockOut?: string;
  totalMinutes?: number;
  breakMinutes?: number;
  recordType?: "normal" | "overtime" | "absence" | "late" | "early_leave" | "holiday";
  location?: string;
  notes?: string;
}

export default function ImportacaoPonto() {
  const [file, setFile] = useState<File | null>(null);
  const [parsedData, setParsedData] = useState<ParsedRecord[]>([]);
  const [importResult, setImportResult] = useState<any>(null);
  const [isProcessing, setIsProcessing] = useState(false);

  const utils = trpc.useUtils();

  const importMutation = trpc.timeClock.importRecords.useMutation({
    onSuccess: (result) => {
      setImportResult(result);
      toast.success(`${result.success} registros importados com sucesso!`);
      utils.timeClock.listRecords.invalidate();
      setParsedData([]);
      setFile(null);
    },
    onError: (error) => {
      toast.error(`Erro na importaÃ§Ã£o: ${error.message}`);
    },
  });

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0];
    if (!selectedFile) return;

    setFile(selectedFile);
    setImportResult(null);
    setIsProcessing(true);

    try {
      const text = await selectedFile.text();
      const records = parseCSV(text);
      setParsedData(records);
      toast.success(`${records.length} registros encontrados no arquivo`);
    } catch (error) {
      toast.error("Erro ao processar arquivo");
      console.error(error);
    } finally {
      setIsProcessing(false);
    }
  };

  const parseCSV = (text: string): ParsedRecord[] => {
    const lines = text.split("\n").filter(line => line.trim());
    if (lines.length < 2) return [];

    // Assumir formato: employeeId,employeeCode,date,clockIn,clockOut,breakMinutes
    // Exemplo: 1,EMP001,2025-01-19,08:00,17:00,60
    const records: ParsedRecord[] = [];

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      const parts = line.split(",").map(p => p.trim());
      if (parts.length < 3) continue;

      const employeeId = parseInt(parts[0]);
      if (isNaN(employeeId)) continue;

      const date = parts[2];
      const clockIn = parts[3] ? `${date}T${parts[3]}:00` : undefined;
      const clockOut = parts[4] ? `${date}T${parts[4]}:00` : undefined;
      const breakMinutes = parts[5] ? parseInt(parts[5]) : 60;

      records.push({
        employeeId,
        employeeCode: parts[1] || undefined,
        date,
        clockIn,
        clockOut,
        breakMinutes,
        recordType: "normal",
      });
    }

    return records;
  };

  const handleImport = () => {
    if (parsedData.length === 0) {
      toast.error("Nenhum registro para importar");
      return;
    }

    importMutation.mutate({
      records: parsedData,
      importSource: "csv",
    });
  };

  const downloadTemplate = () => {
    const template = `employeeId,employeeCode,date,clockIn,clockOut,breakMinutes
1,EMP001,2025-01-19,08:00,17:00,60
2,EMP002,2025-01-19,09:00,18:00,60
3,EMP003,2025-01-19,08:30,17:30,60`;

    const blob = new Blob([template], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "template_ponto.csv";
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="container py-8">
      <div className="mb-8">
        <h1 className="text-3xl font-bold mb-2">ImportaÃ§Ã£o de Registros de Ponto</h1>
        <p className="text-muted-foreground">
          FaÃ§a upload de arquivos CSV com registros de ponto eletrÃ´nico
        </p>
      </div>

      {/* InstruÃ§Ãµes */}
      <Alert className="mb-6">
        <AlertTriangle className="h-4 w-4" />
        <AlertDescription>
          <strong>Formato do arquivo CSV:</strong> employeeId, employeeCode, date (YYYY-MM-DD), clockIn (HH:MM), clockOut (HH:MM), breakMinutes
          <br />
          <Button variant="link" className="p-0 h-auto" onClick={downloadTemplate}>
            <Download className="h-4 w-4 mr-1" />
            Baixar template de exemplo
          </Button>
        </AlertDescription>
      </Alert>

      {/* Upload */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle>Upload de Arquivo</CardTitle>
          <CardDescription>Selecione um arquivo CSV para importar</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex items-center gap-4">
            <Input
              type="file"
              accept=".csv,.txt"
              onChange={handleFileChange}
              disabled={isProcessing || importMutation.isPending}
            />
            {file && (
              <Badge variant="outline" className="flex items-center gap-2">
                <FileSpreadsheet className="h-4 w-4" />
                {file.name}
              </Badge>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Preview dos dados */}
      {parsedData.length > 0 && (
        <Card className="mb-6">
          <CardHeader>
            <CardTitle>Preview dos Dados ({parsedData.length} registros)</CardTitle>
            <CardDescription>Revise os dados antes de importar</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto max-h-96 overflow-y-auto">
              <table className="w-full">
                <thead className="sticky top-0 bg-background">
                  <tr className="border-b">
                    <th className="text-left py-2 px-4">ID</th>
                    <th className="text-left py-2 px-4">CÃ³digo</th>
                    <th className="text-left py-2 px-4">Data</th>
                    <th className="text-left py-2 px-4">Entrada</th>
                    <th className="text-left py-2 px-4">SaÃ­da</th>
                    <th className="text-right py-2 px-4">Intervalo (min)</th>
                  </tr>
                </thead>
                <tbody>
                  {parsedData.slice(0, 100).map((record, idx) => (
                    <tr key={idx} className="border-b hover:bg-accent/50">
                      <td className="py-2 px-4">{record.employeeId}</td>
                      <td className="py-2 px-4">{record.employeeCode || "-"}</td>
                      <td className="py-2 px-4">{record.date}</td>
                      <td className="py-2 px-4">{record.clockIn?.split("T")[1]?.slice(0, 5) || "-"}</td>
                      <td className="py-2 px-4">{record.clockOut?.split("T")[1]?.slice(0, 5) || "-"}</td>
                      <td className="text-right py-2 px-4">{record.breakMinutes || 0}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {parsedData.length > 100 && (
                <div className="text-center py-4 text-muted-foreground text-sm">
                  Mostrando 100 de {parsedData.length} registros
                </div>
              )}
            </div>
            <div className="mt-4 flex justify-end gap-2">
              <Button
                variant="outline"
                onClick={() => {
                  setParsedData([]);
                  setFile(null);
                }}
              >
                Cancelar
              </Button>
              <Button
                onClick={handleImport}
                disabled={importMutation.isPending}
              >
                <Upload className="h-4 w-4 mr-2" />
                {importMutation.isPending ? "Importando..." : `Importar ${parsedData.length} Registros`}
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Resultado da importaÃ§Ã£o */}
      {importResult && (
        <Card>
          <CardHeader>
            <CardTitle>Resultado da ImportaÃ§Ã£o</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div className="flex items-center gap-4">
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-5 w-5 text-green-600" />
                  <span className="font-medium">{importResult.success} Sucessos</span>
                </div>
                <div className="flex items-center gap-2">
                  <XCircle className="h-5 w-5 text-red-600" />
                  <span className="font-medium">{importResult.failed} Falhas</span>
                </div>
                <div className="flex items-center gap-2">
                  <FileSpreadsheet className="h-5 w-5 text-blue-600" />
                  <span className="font-medium">{importResult.total} Total</span>
                </div>
              </div>

              {importResult.errors && importResult.errors.length > 0 && (
                <div>
                  <h4 className="font-medium mb-2">Erros:</h4>
                  <div className="bg-red-50 dark:bg-red-950 p-4 rounded-md max-h-48 overflow-y-auto">
                    <ul className="list-disc list-inside space-y-1 text-sm">
                      {importResult.errors.map((error: string, idx: number) => (
                        <li key={idx} className="text-red-800 dark:text-red-200">{error}</li>
                      ))}
                    </ul>
                  </div>
                </div>
              )}

              <Button
                onClick={() => {
                  setImportResult(null);
                  setParsedData([]);
                  setFile(null);
                }}
              >
                Nova ImportaÃ§Ã£o
              </Button>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/CentrosCustos.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { DollarSign, Plus, Pencil, Trash2, Search, Filter } from "lucide-react";

interface CostCenter {
  id: number;
  code: string;
  name: string;
  description: string | null;
  departmentId: number | null;
  departmentName: string | null;
  budget: string | null;
  active: boolean;
  createdAt: Date;
  updatedAt: Date;
}

export default function CentrosCustos() {
  const [search, setSearch] = useState("");
  const [departmentFilter, setDepartmentFilter] = useState<number | undefined>(undefined);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [editingCostCenter, setEditingCostCenter] = useState<CostCenter | null>(null);
  const [formData, setFormData] = useState({
    code: "",
    name: "",
    description: "",
    departmentId: undefined as number | undefined,
    budget: "",
    active: true,
  });

  const utils = trpc.useUtils();
  const { data: costCenters, isLoading } = trpc.organization.costCenters.list.useQuery({
    search,
    departmentId: departmentFilter,
  });
  const { data: departments } = trpc.organization.departments.list.useQuery({});

  const createMutation = trpc.organization.costCenters.create.useMutation({
    onSuccess: () => {
      toast.success("Centro de custos criado com sucesso!");
      utils.organization.costCenters.list.invalidate();
      closeDialog();
    },
    onError: (error) => {
      toast.error(`Erro ao criar centro de custos: ${error.message}`);
    },
  });

  const updateMutation = trpc.organization.costCenters.update.useMutation({
    onSuccess: () => {
      toast.success("Centro de custos atualizado com sucesso!");
      utils.organization.costCenters.list.invalidate();
      closeDialog();
    },
    onError: (error) => {
      toast.error(`Erro ao atualizar centro de custos: ${error.message}`);
    },
  });

  const deleteMutation = trpc.organization.costCenters.delete.useMutation({
    onSuccess: () => {
      toast.success("Centro de custos excluÃ­do com sucesso!");
      utils.organization.costCenters.list.invalidate();
    },
    onError: (error) => {
      toast.error(`Erro ao excluir centro de custos: ${error.message}`);
    },
  });

  const openCreateDialog = () => {
    setEditingCostCenter(null);
    setFormData({
      code: "",
      name: "",
      description: "",
      departmentId: undefined,
      budget: "",
      active: true,
    });
    setIsDialogOpen(true);
  };

  const openEditDialog = (costCenter: CostCenter) => {
    setEditingCostCenter(costCenter);
    setFormData({
      code: costCenter.code,
      name: costCenter.name,
      description: costCenter.description || "",
      departmentId: costCenter.departmentId || undefined,
      budget: costCenter.budget || "",
      active: costCenter.active,
    });
    setIsDialogOpen(true);
  };

  const closeDialog = () => {
    setIsDialogOpen(false);
    setEditingCostCenter(null);
    setFormData({
      code: "",
      name: "",
      description: "",
      departmentId: undefined,
      budget: "",
      active: true,
    });
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    const budgetNumber = formData.budget ? parseFloat(formData.budget) : undefined;

    if (editingCostCenter) {
      updateMutation.mutate({
        id: editingCostCenter.id,
        ...formData,
        budget: budgetNumber,
      });
    } else {
      createMutation.mutate({
        ...formData,
        budget: budgetNumber,
      });
    }
  };

  const handleDelete = (id: number) => {
    if (confirm("Tem certeza que deseja excluir este centro de custos?")) {
      deleteMutation.mutate({ id });
    }
  };

  const formatCurrency = (value: string | null) => {
    if (!value) return "-";
    const num = parseFloat(value);
    return new Intl.NumberFormat("pt-BR", {
      style: "currency",
      currency: "BRL",
    }).format(num);
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-2">
              <DollarSign className="h-8 w-8" />
              Centros de Custos
            </h1>
            <p className="text-muted-foreground mt-1">
              Gerencie os centros de custos da organizaÃ§Ã£o
            </p>
          </div>
          <Button onClick={openCreateDialog}>
            <Plus className="h-4 w-4 mr-2" />
            Novo Centro de Custos
          </Button>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>Centros de Custos Cadastrados</CardTitle>
            <CardDescription>
              Lista de todos os centros de custos
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="mb-4 flex gap-4">
              <div className="flex-1 relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="Buscar por nome ou cÃ³digo..."
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                  className="pl-10"
                />
              </div>
              <Select
                value={departmentFilter?.toString() || "all"}
                onValueChange={(value) =>
                  setDepartmentFilter(value === "all" ? undefined : parseInt(value))
                }
              >
                <SelectTrigger className="w-[250px]">
                  <Filter className="h-4 w-4 mr-2" />
                  <SelectValue placeholder="Filtrar por departamento" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os departamentos</SelectItem>
                  {departments?.map((dept) => (
                    <SelectItem key={dept.id} value={dept.id.toString()}>
                      {dept.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {isLoading ? (
              <div className="text-center py-8 text-muted-foreground">
                Carregando centros de custos...
              </div>
            ) : !costCenters || costCenters.length === 0 ? (
              <div className="text-center py-8 text-muted-foreground">
                Nenhum centro de custos encontrado
              </div>
            ) : (
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>CÃ³digo</TableHead>
                    <TableHead>Nome</TableHead>
                    <TableHead>Departamento</TableHead>
                    <TableHead>OrÃ§amento</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead className="text-right">AÃ§Ãµes</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {costCenters.map((cc) => (
                    <TableRow key={cc.id}>
                      <TableCell className="font-mono">{cc.code}</TableCell>
                      <TableCell className="font-medium">{cc.name}</TableCell>
                      <TableCell className="text-muted-foreground">
                        {cc.departmentName || "-"}
                      </TableCell>
                      <TableCell>{formatCurrency(cc.budget)}</TableCell>
                      <TableCell>
                        {cc.active ? (
                          <Badge variant="default">Ativo</Badge>
                        ) : (
                          <Badge variant="secondary">Inativo</Badge>
                        )}
                      </TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2">
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => openEditDialog(cc)}
                          >
                            <Pencil className="h-4 w-4" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => handleDelete(cc.id)}
                          >
                            <Trash2 className="h-4 w-4 text-destructive" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            )}
          </CardContent>
        </Card>

        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>
                {editingCostCenter ? "Editar Centro de Custos" : "Novo Centro de Custos"}
              </DialogTitle>
              <DialogDescription>
                {editingCostCenter
                  ? "Atualize as informaÃ§Ãµes do centro de custos"
                  : "Preencha os dados do novo centro de custos"}
              </DialogDescription>
            </DialogHeader>

            <form onSubmit={handleSubmit}>
              <div className="space-y-4">
                <div>
                  <Label htmlFor="code">CÃ³digo *</Label>
                  <Input
                    id="code"
                    value={formData.code}
                    onChange={(e) => setFormData({ ...formData, code: e.target.value })}
                    placeholder="Ex: CC001, CC-TI-01"
                    required
                  />
                </div>

                <div>
                  <Label htmlFor="name">Nome *</Label>
                  <Input
                    id="name"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    placeholder="Ex: Infraestrutura TI"
                    required
                  />
                </div>

                <div>
                  <Label htmlFor="department">Departamento</Label>
                  <Select
                    value={formData.departmentId?.toString() || ""}
                    onValueChange={(value) =>
                      setFormData({ ...formData, departmentId: value ? parseInt(value) : undefined })
                    }
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Selecione um departamento" />
                    </SelectTrigger>
                    <SelectContent>
                      {departments?.map((dept) => (
                        <SelectItem key={dept.id} value={dept.id.toString()}>
                          {dept.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label htmlFor="budget">OrÃ§amento (R$)</Label>
                  <Input
                    id="budget"
                    type="number"
                    step="0.01"
                    value={formData.budget}
                    onChange={(e) => setFormData({ ...formData, budget: e.target.value })}
                    placeholder="0.00"
                  />
                </div>

                <div>
                  <Label htmlFor="description">DescriÃ§Ã£o</Label>
                  <Textarea
                    id="description"
                    value={formData.description}
                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    placeholder="Descreva o propÃ³sito deste centro de custos"
                    rows={3}
                  />
                </div>

                <div className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="active"
                    checked={formData.active}
                    onChange={(e) => setFormData({ ...formData, active: e.target.checked })}
                    className="h-4 w-4"
                  />
                  <Label htmlFor="active">Centro de custos ativo</Label>
                </div>
              </div>

              <DialogFooter className="mt-6">
                <Button type="button" variant="outline" onClick={closeDialog}>
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={createMutation.isPending || updateMutation.isPending}
                >
                  {editingCostCenter ? "Atualizar" : "Criar"}
                </Button>
              </DialogFooter>
            </form>
          </DialogContent>
        </Dialog>
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/SucessaoInteligente.tsx
========================================
import { useState } from "react";
import DashboardLayout from "@/components/DashboardLayout";
import { trpc } from "@/lib/trpc";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { TrendingUp, Users, Target, Award, CheckCircle2, AlertCircle } from "lucide-react";

export default function SucessaoInteligente() {
  const [selectedPosition, setSelectedPosition] = useState<number | undefined>(undefined);

  // Buscar dados reais do banco
  const { data: positions } = trpc.positionsManagement.list.useQuery();
  const { data: successorsData } = trpc.succession.listCandidates.useQuery(
    { positionId: selectedPosition },
    { enabled: !!selectedPosition }
  );
  const { data: pdiPlans } = trpc.pdiIntelligent.list.useQuery();
  const { data: nineBoxData } = trpc.nineBox.list.useQuery();
  const { data: performanceData } = trpc.evaluations.list.useQuery();

  // Processar dados de sucessores com informaÃ§Ãµes integradas
  const successors = successorsData?.map((candidate: any) => {
    // Buscar PDI do candidato
    const pdi = pdiPlans?.find((p: any) => p.employeeId === candidate.employeeId);
    const pdiItems = pdi?.items || [];
    const completedItems = pdiItems.filter((item: any) => item.status === 'completed').length;
    const totalItems = pdiItems.length;
    const pdiProgress = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;

    // Buscar Nine Box do candidato
    const nineBox = nineBoxData?.find((nb: any) => nb.employeeId === candidate.employeeId);
    const nineBoxLabel = nineBox ? `${nineBox.performance} / ${nineBox.potential}` : "NÃ£o avaliado";

    // Buscar avaliaÃ§Ã£o de performance do candidato
    const performance = performanceData?.find((p: any) => p.employeeId === candidate.employeeId);
    const performanceRating = (performance as any)?.overallRating || "atende_expectativas";

    return {
      id: candidate.id,
      name: candidate.employeeName || "Candidato",
      currentPosition: candidate.currentPosition || "NÃ£o informado",
      readinessLevel: candidate.readinessLevel || "2_3_anos",
      readinessScore: candidate.readinessScore || 0,
      pdi: {
        progress: Math.round(pdiProgress),
        completedActions: completedItems,
        totalActions: totalItems,
        keyAreas: pdiItems.slice(0, 3).map((item: any) => item.title || "N/A"),
      },
      performance: {
        rating: performanceRating,
        trend: "estavel",
      },
      nineBox: nineBoxLabel,
      competencyGaps: candidate.developmentNeeds?.split(',') || [],
    };
  }) || [];

  const getReadinessLabel = (level: string) => {
    const labels: Record<string, string> = {
      imediato: "Imediato",
      "1_ano": "1 Ano",
      "2_3_anos": "2-3 Anos",
      "mais_3_anos": "+3 Anos",
    };
    return labels[level] || level;
  };

  const getReadinessColor = (level: string) => {
    const colors: Record<string, string> = {
      imediato: "bg-green-500",
      "1_ano": "bg-blue-500",
      "2_3_anos": "bg-yellow-500",
      "mais_3_anos": "bg-orange-500",
    };
    return colors[level] || "bg-gray-500";
  };

  const getPerformanceLabel = (rating: string) => {
    const labels: Record<string, string> = {
      excepcional: "Excepcional",
      supera_expectativas: "Supera Expectativas",
      atende_expectativas: "Atende Expectativas",
      abaixo_expectativas: "Abaixo das Expectativas",
    };
    return labels[rating] || rating;
  };

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <TrendingUp className="h-8 w-8" />
            SucessÃ£o Inteligente
          </h1>
          <p className="text-muted-foreground mt-1">
            Pipeline de talentos e planejamento de sucessÃ£o baseado em dados
          </p>
        </div>

        {/* KPIs */}
        <div className="grid gap-4 md:grid-cols-4">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">PosiÃ§Ãµes CrÃ­ticas</CardTitle>
              <AlertCircle className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">12</div>
              <p className="text-xs text-muted-foreground">3 sem sucessor imediato</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Sucessores Prontos</CardTitle>
              <CheckCircle2 className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">28</div>
              <p className="text-xs text-muted-foreground">+15% vs trimestre anterior</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">PDIs Ativos</CardTitle>
              <Target className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">45</div>
              <p className="text-xs text-muted-foreground">72% de conclusÃ£o mÃ©dia</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Taxa de Cobertura</CardTitle>
              <Award className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">85%</div>
              <p className="text-xs text-muted-foreground">Meta: 90%</p>
            </CardContent>
          </Card>
        </div>

        {/* Filtro de PosiÃ§Ã£o */}
        <Card>
          <CardHeader>
            <CardTitle>Selecionar PosiÃ§Ã£o</CardTitle>
            <CardDescription>
              Escolha uma posiÃ§Ã£o para visualizar o pipeline de sucessores
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Select
              value={selectedPosition?.toString() || ""}
              onValueChange={(value) => setSelectedPosition(value ? parseInt(value) : undefined)}
            >
              <SelectTrigger>
                <SelectValue placeholder="Selecione uma posiÃ§Ã£o" />
              </SelectTrigger>
              <SelectContent>
                {positions?.map((pos: any) => (
                  <SelectItem key={pos.id} value={pos.id.toString()}>
                    {pos.title} - {pos.department}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </CardContent>
        </Card>

        {selectedPosition && (
          <Tabs defaultValue="pipeline" className="space-y-4">
            <TabsList>
              <TabsTrigger value="pipeline">Pipeline de Sucessores</TabsTrigger>
              <TabsTrigger value="matrix">Matriz 9-Box</TabsTrigger>
              <TabsTrigger value="development">Planos de Desenvolvimento</TabsTrigger>
            </TabsList>

            <TabsContent value="pipeline" className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Candidatos a SucessÃ£o</CardTitle>
                  <CardDescription>
                    Ordenados por score de prontidÃ£o (performance + potencial + PDI + metas)
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-6">
                    {successors.map((successor: any) => (
                      <div key={successor.id} className="border rounded-lg p-4 space-y-4">
                        <div className="flex items-start justify-between">
                          <div className="space-y-1">
                            <div className="flex items-center gap-2">
                              <h3 className="font-semibold text-lg">{successor.name}</h3>
                              <Badge variant="outline">{successor.currentPosition}</Badge>
                            </div>
                            <p className="text-sm text-muted-foreground">
                              Nine Box: {successor.nineBox}
                            </p>
                          </div>
                          <div className="text-right">
                            <div className="text-2xl font-bold">{successor.readinessScore}</div>
                            <p className="text-xs text-muted-foreground">Score de ProntidÃ£o</p>
                          </div>
                        </div>

                        <div className="grid gap-4 md:grid-cols-2">
                          {/* NÃ­vel de ProntidÃ£o */}
                          <div className="space-y-2">
                            <div className="flex items-center justify-between text-sm">
                              <span className="font-medium">NÃ­vel de ProntidÃ£o</span>
                              <Badge className={getReadinessColor(successor.readinessLevel)}>
                                {getReadinessLabel(successor.readinessLevel)}
                              </Badge>
                            </div>
                          </div>

                          {/* Performance */}
                          <div className="space-y-2">
                            <div className="flex items-center justify-between text-sm">
                              <span className="font-medium">Performance</span>
                              <Badge variant="secondary">
                                {getPerformanceLabel(successor.performance.rating)}
                              </Badge>
                            </div>
                          </div>
                        </div>

                        {/* PDI Progress */}
                        <div className="space-y-2">
                          <div className="flex items-center justify-between text-sm">
                            <span className="font-medium">Progresso do PDI</span>
                            <span className="text-muted-foreground">
                              {successor.pdi.completedActions}/{successor.pdi.totalActions} aÃ§Ãµes
                            </span>
                          </div>
                          <Progress value={successor.pdi.progress} className="h-2" />
                          <div className="flex flex-wrap gap-2">
                            {successor.pdi.keyAreas.map((area: any, idx: any) => (
                              <Badge key={idx} variant="outline" className="text-xs">
                                {area}
                              </Badge>
                            ))}
                          </div>
                        </div>

                        {/* Gaps de CompetÃªncias */}
                        {successor.competencyGaps.length > 0 && (
                          <div className="space-y-2">
                            <span className="text-sm font-medium">Gaps de CompetÃªncias</span>
                            <div className="flex flex-wrap gap-2">
                              {successor.competencyGaps.map((gap: any, idx: any) => (
                                <Badge key={idx} variant="destructive" className="text-xs">
                                  {gap}
                                </Badge>
                              ))}
                            </div>
                          </div>
                        )}

                        <div className="flex gap-2">
                          <Button size="sm" variant="outline">
                            Ver PDI Completo
                          </Button>
                          <Button size="sm" variant="outline">
                            HistÃ³rico de Performance
                          </Button>
                          <Button size="sm">Nomear como Sucessor</Button>
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="matrix">
              <Card>
                <CardHeader>
                  <CardTitle>Matriz 9-Box - Candidatos</CardTitle>
                  <CardDescription>
                    VisualizaÃ§Ã£o de performance vs potencial dos candidatos
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="text-center py-12 text-muted-foreground">
                    Matriz 9-Box serÃ¡ implementada com visualizaÃ§Ã£o interativa
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="development">
              <Card>
                <CardHeader>
                  <CardTitle>Planos de Desenvolvimento</CardTitle>
                  <CardDescription>
                    AÃ§Ãµes de desenvolvimento para preparar sucessores
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Candidato</TableHead>
                        <TableHead>AÃ§Ãµes Planejadas</TableHead>
                        <TableHead>Progresso</TableHead>
                        <TableHead>Prazo</TableHead>
                        <TableHead>Status</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {successors.map((successor: any) => (
                        <TableRow key={successor.id}>
                          <TableCell className="font-medium">{successor.name}</TableCell>
                          <TableCell>{successor.pdi.totalActions} aÃ§Ãµes</TableCell>
                          <TableCell>
                            <div className="flex items-center gap-2">
                              <Progress value={successor.pdi.progress} className="h-2 w-24" />
                              <span className="text-sm">{successor.pdi.progress}%</span>
                            </div>
                          </TableCell>
                          <TableCell>31/12/2025</TableCell>
                          <TableCell>
                            <Badge variant={successor.pdi.progress >= 70 ? "default" : "secondary"}>
                              {successor.pdi.progress >= 70 ? "No prazo" : "AtenÃ§Ã£o"}
                            </Badge>
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </CardContent>
              </Card>
            </TabsContent>
          </Tabs>
        )}

        {!selectedPosition && (
          <Card>
            <CardContent className="pt-6">
              <div className="text-center py-12 text-muted-foreground">
                <Users className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>Selecione uma posiÃ§Ã£o acima para visualizar o pipeline de sucessores</p>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </DashboardLayout>
  );
}


========================================
ARQUIVO: ./client/src/pages/Bonus.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";
import { Plus, Edit, Trash2, DollarSign, Calculator, TrendingUp } from "lucide-react";

export default function Bonus() {
  const [isCreateOpen, setIsCreateOpen] = useState(false);
  const [isSimulatorOpen, setIsSimulatorOpen] = useState(false);
  const [selectedPolicy, setSelectedPolicy] = useState<number | null>(null);

  // Queries
  const { data: policies, refetch } = trpc.bonus.list.useQuery();
  const { data: stats } = trpc.bonus.getStats.useQuery();
  const { data: positions } = trpc.positionsManagement.list.useQuery();

  // Mutations
  const createMutation = trpc.bonus.create.useMutation({
    onSuccess: () => {
      toast.success("PolÃ­tica de bÃ´nus criada com sucesso!");
      setIsCreateOpen(false);
      refetch();
    },
    onError: (error: any) => {
      toast.error(`Erro ao criar polÃ­tica: ${error.message}`);
    },
  });

  const deleteMutation = trpc.bonus.delete.useMutation({
    onSuccess: () => {
      toast.success("PolÃ­tica excluÃ­da com sucesso!");
      refetch();
    },
    onError: (error: any) => {
      toast.error(`Erro ao excluir polÃ­tica: ${error.message}`);
    },
  });

  // Form state
  const [formData, setFormData] = useState({
    name: "",
    description: "",
    positionId: "",
    salaryMultiplier: "1.5",
    minMultiplier: "0.5",
    maxMultiplier: "2.0",
    minTenureMonths: "6",
    minGoalCompletionRate: "70",
    requiresGoalCompletion: true,
    validFrom: new Date().toISOString().split("T")[0],
    validUntil: "",
    active: true,
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    createMutation.mutate({
      name: formData.name,
      description: formData.description || undefined,
      positionId: formData.positionId ? parseInt(formData.positionId) : undefined,
      salaryMultiplier: parseFloat(formData.salaryMultiplier),
      minMultiplier: parseFloat(formData.minMultiplier),
      maxMultiplier: parseFloat(formData.maxMultiplier),
      minTenureMonths: parseInt(formData.minTenureMonths),
      minGoalCompletionRate: parseInt(formData.minGoalCompletionRate),
      requiresGoalCompletion: formData.requiresGoalCompletion,
      validFrom: new Date(formData.validFrom),
      validUntil: formData.validUntil ? new Date(formData.validUntil) : undefined,
      active: formData.active,
    });
  };

  const handleDelete = (id: number) => {
    if (confirm("Tem certeza que deseja excluir esta polÃ­tica de bÃ´nus?")) {
      deleteMutation.mutate(id);
    }
  };

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">GestÃ£o de BÃ´nus</h1>
          <p className="text-gray-500 mt-1">
            Configure polÃ­ticas de bÃ´nus por cargo com multiplicadores de salÃ¡rio
          </p>
        </div>
        <div className="flex gap-2">
          <Dialog open={isSimulatorOpen} onOpenChange={setIsSimulatorOpen}>
            <DialogTrigger asChild>
              <Button variant="outline">
                <Calculator className="w-4 h-4 mr-2" />
                Simulador
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-2xl">
              <DialogHeader>
                <DialogTitle>Simulador de BÃ´nus</DialogTitle>
                <DialogDescription>
                  Simule o valor de bÃ´nus para um funcionÃ¡rio especÃ­fico
                </DialogDescription>
              </DialogHeader>
              <SimulatorForm />
            </DialogContent>
          </Dialog>

          <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>
            <DialogTrigger asChild>
              <Button>
                <Plus className="w-4 h-4 mr-2" />
                Nova PolÃ­tica
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
              <DialogHeader>
                <DialogTitle>Criar PolÃ­tica de BÃ´nus</DialogTitle>
                <DialogDescription>
                  Configure uma nova polÃ­tica de bÃ´nus por cargo
                </DialogDescription>
              </DialogHeader>
              <form onSubmit={handleSubmit} className="space-y-4">
                {/* Nome e DescriÃ§Ã£o */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="name">Nome da PolÃ­tica *</Label>
                    <Input
                      id="name"
                      value={formData.name}
                      onChange={(e) =>
                        setFormData({ ...formData, name: e.target.value })
                      }
                      placeholder="Ex: BÃ´nus Anual 2025"
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="positionId">Cargo (opcional)</Label>
                    <Select
                      value={formData.positionId}
                      onValueChange={(value) =>
                        setFormData({ ...formData, positionId: value })
                      }
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Todos os cargos" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="">Todos os cargos</SelectItem>
                        {positions?.map((pos) => (
                          <SelectItem key={pos.id} value={pos.id.toString()}>
                            {pos.title}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <div>
                  <Label htmlFor="description">DescriÃ§Ã£o</Label>
                  <Textarea
                    id="description"
                    value={formData.description}
                    onChange={(e) =>
                      setFormData({ ...formData, description: e.target.value })
                    }
                    placeholder="Descreva os critÃ©rios e objetivos desta polÃ­tica"
                    rows={3}
                  />
                </div>

                {/* Multiplicadores */}
                <div className="border-t pt-4">
                  <h3 className="font-semibold mb-3">Multiplicadores de SalÃ¡rio</h3>
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <Label htmlFor="minMultiplier">MÃ­nimo</Label>
                      <Input
                        id="minMultiplier"
                        type="number"
                        step="0.1"
                        min="0"
                        max="10"
                        value={formData.minMultiplier}
                        onChange={(e) =>
                          setFormData({ ...formData, minMultiplier: e.target.value })
                        }
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        Ex: 0.5 = 50% do salÃ¡rio
                      </p>
                    </div>
                    <div>
                      <Label htmlFor="salaryMultiplier">PadrÃ£o *</Label>
                      <Input
                        id="salaryMultiplier"
                        type="number"
                        step="0.1"
                        min="0"
                        max="10"
                        value={formData.salaryMultiplier}
                        onChange={(e) =>
                          setFormData({ ...formData, salaryMultiplier: e.target.value })
                        }
                        required
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        Ex: 1.5 = 150% do salÃ¡rio
                      </p>
                    </div>
                    <div>
                      <Label htmlFor="maxMultiplier">MÃ¡ximo</Label>
                      <Input
                        id="maxMultiplier"
                        type="number"
                        step="0.1"
                        min="0"
                        max="10"
                        value={formData.maxMultiplier}
                        onChange={(e) =>
                          setFormData({ ...formData, maxMultiplier: e.target.value })
                        }
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        Ex: 2.0 = 200% do salÃ¡rio
                      </p>
                    </div>
                  </div>
                </div>

                {/* CritÃ©rios de Elegibilidade */}
                <div className="border-t pt-4">
                  <h3 className="font-semibold mb-3">CritÃ©rios de Elegibilidade</h3>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="minTenureMonths">Tempo MÃ­nimo (meses)</Label>
                      <Input
                        id="minTenureMonths"
                        type="number"
                        min="0"
                        value={formData.minTenureMonths}
                        onChange={(e) =>
                          setFormData({ ...formData, minTenureMonths: e.target.value })
                        }
                      />
                    </div>
                    <div>
                      <Label htmlFor="minGoalCompletionRate">
                        % MÃ­nimo de Metas Atingidas
                      </Label>
                      <Input
                        id="minGoalCompletionRate"
                        type="number"
                        min="0"
                        max="100"
                        value={formData.minGoalCompletionRate}
                        onChange={(e) =>
                          setFormData({
                            ...formData,
                            minGoalCompletionRate: e.target.value,
                          })
                        }
                      />
                    </div>
                  </div>
                </div>

                {/* PerÃ­odo de VigÃªncia */}
                <div className="border-t pt-4">
                  <h3 className="font-semibold mb-3">PerÃ­odo de VigÃªncia</h3>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="validFrom">Data InÃ­cio *</Label>
                      <Input
                        id="validFrom"
                        type="date"
                        value={formData.validFrom}
                        onChange={(e) =>
                          setFormData({ ...formData, validFrom: e.target.value })
                        }
                        required
                      />
                    </div>
                    <div>
                      <Label htmlFor="validUntil">Data Fim (opcional)</Label>
                      <Input
                        id="validUntil"
                        type="date"
                        value={formData.validUntil}
                        onChange={(e) =>
                          setFormData({ ...formData, validUntil: e.target.value })
                        }
                      />
                    </div>
                  </div>
                </div>

                {/* BotÃµes */}
                <div className="flex justify-end gap-2 pt-4">
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => setIsCreateOpen(false)}
                  >
                    Cancelar
                  </Button>
                  <Button type="submit" disabled={createMutation.isPending}>
                    {createMutation.isPending ? "Criando..." : "Criar PolÃ­tica"}
                  </Button>
                </div>
              </form>
            </DialogContent>
          </Dialog>
        </div>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card className="p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-500">PolÃ­ticas Ativas</p>
              <p className="text-3xl font-bold text-gray-900 mt-1">
                {stats?.activePolicies || 0}
              </p>
            </div>
            <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
              <DollarSign className="w-6 h-6 text-blue-600" />
            </div>
          </div>
        </Card>

        <Card className="p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-500">Total de CÃ¡lculos</p>
              <p className="text-3xl font-bold text-gray-900 mt-1">
                {stats?.totalCalculations || 0}
              </p>
            </div>
            <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
              <Calculator className="w-6 h-6 text-green-600" />
            </div>
          </div>
        </Card>

        <Card className="p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-500">Valor Total Aprovado</p>
              <p className="text-3xl font-bold text-gray-900 mt-1">
                {new Intl.NumberFormat("pt-BR", {
                  style: "currency",
                  currency: "BRL",
                }).format(stats?.totalBonusAmount || 0)}
              </p>
            </div>
            <div className="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
              <TrendingUp className="w-6 h-6 text-orange-600" />
            </div>
          </div>
        </Card>
      </div>

      {/* Tabela de PolÃ­ticas */}
      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-4">PolÃ­ticas de BÃ´nus</h2>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b">
                <th className="text-left py-3 px-4">Nome</th>
                <th className="text-left py-3 px-4">Cargo</th>
                <th className="text-left py-3 px-4">Multiplicador</th>
                <th className="text-left py-3 px-4">Elegibilidade</th>
                <th className="text-left py-3 px-4">VigÃªncia</th>
                <th className="text-left py-3 px-4">Status</th>
                <th className="text-right py-3 px-4">AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody>
              {policies?.map((policy: any) => (
                <tr key={policy.id} className="border-b hover:bg-gray-50">
                  <td className="py-3 px-4">
                    <div>
                      <p className="font-medium">{policy.name}</p>
                      {policy.description && (
                        <p className="text-sm text-gray-500 line-clamp-1">
                          {policy.description}
                        </p>
                      )}
                    </div>
                  </td>
                  <td className="py-3 px-4">
                    {policy.positionId ? (
                      <Badge variant="outline">Cargo EspecÃ­fico</Badge>
                    ) : (
                      <Badge variant="secondary">Todos</Badge>
                    )}
                  </td>
                  <td className="py-3 px-4">
                    <div className="flex items-center gap-1">
                      <span className="font-semibold">
                        {Number(policy.salaryMultiplier).toFixed(1)}x
                      </span>
                      <span className="text-xs text-gray-500">
                        ({Number(policy.minMultiplier).toFixed(1)}x -{" "}
                        {Number(policy.maxMultiplier).toFixed(1)}x)
                      </span>
                    </div>
                  </td>
                  <td className="py-3 px-4">
                    <div className="text-sm">
                      <p>{policy.minTenureMonths || 0} meses</p>
                      <p className="text-gray-500">
                        {policy.minGoalCompletionRate || 0}% metas
                      </p>
                    </div>
                  </td>
                  <td className="py-3 px-4">
                    <div className="text-sm">
                      <p>
                        {new Date(policy.validFrom).toLocaleDateString("pt-BR")}
                      </p>
                      {policy.validUntil && (
                        <p className="text-gray-500">
                          atÃ© {new Date(policy.validUntil).toLocaleDateString("pt-BR")}
                        </p>
                      )}
                    </div>
                  </td>
                  <td className="py-3 px-4">
                    {policy.active ? (
                      <Badge className="bg-green-100 text-green-800">Ativa</Badge>
                    ) : (
                      <Badge variant="secondary">Inativa</Badge>
                    )}
                  </td>
                  <td className="py-3 px-4">
                    <div className="flex items-center justify-end gap-2">
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => {
                          // TODO: Implementar ediÃ§Ã£o
                          toast.info("EdiÃ§Ã£o em desenvolvimento");
                        }}
                      >
                        <Edit className="w-4 h-4" />
                      </Button>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handleDelete(policy.id)}
                      >
                        <Trash2 className="w-4 h-4 text-red-600" />
                      </Button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>

          {!policies || policies.length === 0 && (
            <div className="text-center py-12">
              <DollarSign className="w-12 h-12 text-gray-400 mx-auto mb-4" />
              <p className="text-gray-500">Nenhuma polÃ­tica de bÃ´nus cadastrada</p>
              <Button
                variant="outline"
                className="mt-4"
                onClick={() => setIsCreateOpen(true)}
              >
                Criar Primeira PolÃ­tica
              </Button>
            </div>
          )}
        </div>
      </Card>
    </div>
  );
}

// Componente do Simulador
function SimulatorForm() {
  const [employeeId, setEmployeeId] = useState("");
  const [policyId, setPolicyId] = useState("");
  const [result, setResult] = useState<any>(null);

  const { data: policies } = trpc.bonus.list.useQuery({ active: true });
  const calculateMutation = trpc.bonus.calculateBonus.useMutation({
    onSuccess: (data: any) => {
      setResult(data);
      toast.success("CÃ¡lculo realizado com sucesso!");
    },
    onError: (error: any) => {
      toast.error(`Erro ao calcular: ${error.message}`);
    },
  });

  const handleSimulate = () => {
    if (!employeeId || !policyId) {
      toast.error("Selecione um funcionÃ¡rio e uma polÃ­tica");
      return;
    }

    calculateMutation.mutate({
      employeeId: parseInt(employeeId),
      policyId: parseInt(policyId),
    });
  };

  return (
    <div className="space-y-4">
      <div>
        <Label htmlFor="employeeId">ID do FuncionÃ¡rio</Label>
        <Input
          id="employeeId"
          type="number"
          value={employeeId}
          onChange={(e) => setEmployeeId(e.target.value)}
          placeholder="Ex: 1"
        />
      </div>

      <div>
        <Label htmlFor="policyId">PolÃ­tica de BÃ´nus</Label>
        <Select value={policyId} onValueChange={setPolicyId}>
          <SelectTrigger>
            <SelectValue placeholder="Selecione uma polÃ­tica" />
          </SelectTrigger>
          <SelectContent>
            {policies?.map((policy: any) => (
              <SelectItem key={policy.id} value={policy.id.toString()}>
                {policy.name} ({Number(policy.salaryMultiplier).toFixed(1)}x)
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      <Button onClick={handleSimulate} disabled={calculateMutation.isPending} className="w-full">
        {calculateMutation.isPending ? "Calculando..." : "Simular BÃ´nus"}
      </Button>

      {result && (
        <Card className="p-4 bg-blue-50 border-blue-200">
          <h3 className="font-semibold mb-3">Resultado da SimulaÃ§Ã£o</h3>
          <div className="space-y-2">
            <div className="flex justify-between">
              <span className="text-gray-600">ElegÃ­vel:</span>
              <Badge className={result.isEligible ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800"}>
                {result.isEligible ? "Sim" : "NÃ£o"}
              </Badge>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">Tempo de Casa:</span>
              <span className="font-medium">{result.tenureMonths} meses</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">Taxa de ConclusÃ£o de Metas:</span>
              <span className="font-medium">{result.goalCompletionRate.toFixed(1)}%</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">Atende Requisito de Metas:</span>
              <Badge className={result.meetsGoalRequirement ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800"}>
                {result.meetsGoalRequirement ? "Sim" : "NÃ£o"}
              </Badge>
            </div>
            <div className="border-t pt-2 mt-2">
              <div className="flex justify-between items-center">
                <span className="text-lg font-semibold">Valor do BÃ´nus:</span>
                <span className="text-2xl font-bold text-green-600">
                  {new Intl.NumberFormat("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                  }).format(result.bonusAmount)}
                </span>
              </div>
            </div>
          </div>
        </Card>
      )}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/AvaliacoesPendentes.tsx
========================================
import { useState } from "react";
import { useAuth } from "@/_core/hooks/useAuth";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { ClipboardList, Calendar, User, AlertCircle, Search } from "lucide-react";
import { useLocation } from "wouter";

export default function AvaliacoesPendentes() {
  const { user } = useAuth();
  const [, setLocation] = useLocation();
  const [searchTerm, setSearchTerm] = useState("");
  const [filterType, setFilterType] = useState<string>("all");

  // Buscar avaliaÃ§Ãµes pendentes do usuÃ¡rio
  const { data: evaluations, isLoading } = trpc.evaluations.listPending.useQuery(
    { evaluatorId: user?.id },
    { enabled: !!user?.id }
  );

  // Filtrar avaliaÃ§Ãµes
  const filteredEvaluations = evaluations?.filter((evaluation: any) => {
    const matchesSearch =
      searchTerm === "" ||
      evaluation.employeeName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      evaluation.cycleName?.toLowerCase().includes(searchTerm.toLowerCase());

    const matchesType =
      filterType === "all" ||
      (filterType === "360" && evaluation.type === "360") ||
      (filterType === "performance" && evaluation.type === "performance") ||
      (filterType === "autoavaliacao" && evaluation.type === "autoavaliacao");

    return matchesSearch && matchesType;
  });

  const handleStartEvaluation = (evaluationId: number, type: string) => {
    if (type === "360") {
      setLocation(`/avaliacoes/gestor/${evaluationId}`);
    } else if (type === "autoavaliacao") {
      setLocation(`/avaliacoes/autoavaliacao/${evaluationId}`);
    } else {
      setLocation(`/avaliacoes/${evaluationId}`);
    }
  };

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">AvaliaÃ§Ãµes Pendentes</h1>
          <p className="text-gray-500 mt-1">
            Gerencie suas avaliaÃ§Ãµes pendentes de colaboradores
          </p>
        </div>
        <div className="flex items-center gap-2">
          <Badge variant="outline" className="text-lg px-4 py-2">
            <AlertCircle className="w-4 h-4 mr-2" />
            {filteredEvaluations?.length || 0} pendentes
          </Badge>
        </div>
      </div>

      {/* Filtros */}
      <Card className="p-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
            <Input
              placeholder="Buscar por colaborador ou ciclo..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-10"
            />
          </div>
          <Select value={filterType} onValueChange={setFilterType}>
            <SelectTrigger>
              <SelectValue placeholder="Filtrar por tipo" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todos os tipos</SelectItem>
              <SelectItem value="360">AvaliaÃ§Ã£o 360Â°</SelectItem>
              <SelectItem value="performance">AvaliaÃ§Ã£o de Performance</SelectItem>
              <SelectItem value="autoavaliacao">AutoavaliaÃ§Ã£o</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </Card>

      {/* Lista de AvaliaÃ§Ãµes */}
      {isLoading ? (
        <Card className="p-12">
          <div className="flex flex-col items-center justify-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p className="text-gray-500">Carregando avaliaÃ§Ãµes...</p>
          </div>
        </Card>
      ) : filteredEvaluations && filteredEvaluations.length > 0 ? (
        <div className="grid grid-cols-1 gap-4">
          {filteredEvaluations.map((evaluation: any) => (
            <Card key={evaluation.id} className="p-6 hover:shadow-lg transition-shadow">
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-3">
                    <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                      <User className="w-6 h-6 text-blue-600" />
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">
                        {evaluation.employeeName || "Colaborador"}
                      </h3>
                      <p className="text-sm text-gray-500">
                        {evaluation.positionTitle || "Cargo nÃ£o informado"}
                      </p>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div className="flex items-center gap-2 text-sm">
                      <ClipboardList className="w-4 h-4 text-gray-400" />
                      <span className="text-gray-600">Tipo:</span>
                      <Badge variant="outline">
                        {evaluation.type === "360"
                          ? "360Â°"
                          : evaluation.type === "autoavaliacao"
                          ? "AutoavaliaÃ§Ã£o"
                          : "Performance"}
                      </Badge>
                    </div>

                    <div className="flex items-center gap-2 text-sm">
                      <Calendar className="w-4 h-4 text-gray-400" />
                      <span className="text-gray-600">Ciclo:</span>
                      <span className="font-medium">
                        {evaluation.cycleName || "Ciclo 2025"}
                      </span>
                    </div>

                    <div className="flex items-center gap-2 text-sm">
                      <AlertCircle className="w-4 h-4 text-orange-500" />
                      <span className="text-gray-600">Prazo:</span>
                      <span className="font-medium text-orange-600">
                        {evaluation.deadline
                          ? new Date(evaluation.deadline).toLocaleDateString("pt-BR")
                          : "Sem prazo"}
                      </span>
                    </div>
                  </div>

                  {evaluation.description && (
                    <p className="text-sm text-gray-600 mb-4">
                      {evaluation.description}
                    </p>
                  )}
                </div>

                <Button
                  onClick={() => handleStartEvaluation(evaluation.id, evaluation.type)}
                  className="ml-4"
                >
                  Iniciar AvaliaÃ§Ã£o
                </Button>
              </div>
            </Card>
          ))}
        </div>
      ) : (
        <Card className="p-12">
          <div className="flex flex-col items-center justify-center">
            <ClipboardList className="w-16 h-16 text-gray-300 mb-4" />
            <h3 className="text-lg font-semibold text-gray-700 mb-2">
              Nenhuma avaliaÃ§Ã£o pendente
            </h3>
            <p className="text-gray-500 text-center max-w-md">
              {searchTerm || filterType !== "all"
                ? "Nenhuma avaliaÃ§Ã£o encontrada com os filtros aplicados."
                : "VocÃª nÃ£o possui avaliaÃ§Ãµes pendentes no momento."}
            </p>
          </div>
        </Card>
      )}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/AprovacaoBonus.tsx
========================================
import { useState } from "react";
import { useAuth } from "@/_core/hooks/useAuth";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { CheckCircle, XCircle, DollarSign, User, Calendar, TrendingUp, AlertCircle } from "lucide-react";
import { toast } from "sonner";

export default function AprovacaoBonus() {
  const { user } = useAuth();
  const [selectedCalculation, setSelectedCalculation] = useState<any>(null);
  const [isApproveDialogOpen, setIsApproveDialogOpen] = useState(false);
  const [isRejectDialogOpen, setIsRejectDialogOpen] = useState(false);
  const [filterStatus, setFilterStatus] = useState<string>("calculado");

  // Buscar cÃ¡lculos pendentes de aprovaÃ§Ã£o
  const { data: calculations, isLoading, refetch } = trpc.bonus.listCalculations.useQuery({
    status: filterStatus as any,
  });

  // Mutation para aprovar
  const approveMutation = trpc.bonus.approveCalculation.useMutation({
    onSuccess: () => {
      toast.success("BÃ´nus aprovado com sucesso!");
      setIsApproveDialogOpen(false);
      setSelectedCalculation(null);
      refetch();
    },
    onError: (error: any) => {
      toast.error(`Erro ao aprovar: ${error.message}`);
    },
  });

  // Mutation para marcar como pago
  const markAsPaidMutation = trpc.bonus.markAsPaid.useMutation({
    onSuccess: () => {
      toast.success("BÃ´nus marcado como pago!");
      refetch();
    },
    onError: (error: any) => {
      toast.error(`Erro ao marcar como pago: ${error.message}`);
    },
  });

  const handleApprove = () => {
    if (selectedCalculation) {
      approveMutation.mutate({ calculationId: selectedCalculation.id });
    }
  };

  const handleReject = () => {
    // Implementar lÃ³gica de rejeiÃ§Ã£o se necessÃ¡rio
    toast.info("Funcionalidade de rejeiÃ§Ã£o em desenvolvimento");
    setIsRejectDialogOpen(false);
  };

  const handleMarkAsPaid = (calculationId: number) => {
    markAsPaidMutation.mutate({ calculationId });
  };

  const getStatusBadge = (status: string) => {
    const statusMap: Record<string, { label: string; variant: any }> = {
      calculado: { label: "Calculado", variant: "secondary" },
      aprovado: { label: "Aprovado", variant: "default" },
      pago: { label: "Pago", variant: "outline" },
      cancelado: { label: "Cancelado", variant: "destructive" },
    };
    const config = statusMap[status] || { label: status, variant: "secondary" };
    return <Badge variant={config.variant}>{config.label}</Badge>;
  };

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-2">
            <DollarSign className="w-8 h-8 text-green-600" />
            AprovaÃ§Ãµes de BÃ´nus
          </h1>
          <p className="text-gray-500 mt-1">
            Gerencie aprovaÃ§Ãµes e pagamentos de bÃ´nus calculados
          </p>
        </div>
        <div className="flex items-center gap-2">
          <Badge variant="outline" className="text-lg px-4 py-2">
            {calculations?.length || 0} cÃ¡lculos
          </Badge>
        </div>
      </div>

      {/* Filtros */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex items-center gap-4">
            <label className="text-sm font-medium">Status:</label>
            <Select value={filterStatus} onValueChange={setFilterStatus}>
              <SelectTrigger className="w-[200px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="calculado">Calculado</SelectItem>
                <SelectItem value="aprovado">Aprovado</SelectItem>
                <SelectItem value="pago">Pago</SelectItem>
                <SelectItem value="cancelado">Cancelado</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardContent>
      </Card>

      {/* Lista de CÃ¡lculos */}
      {isLoading ? (
        <Card>
          <CardContent className="p-12">
            <div className="flex flex-col items-center justify-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
              <p className="text-gray-500">Carregando cÃ¡lculos...</p>
            </div>
          </CardContent>
        </Card>
      ) : calculations && calculations.length > 0 ? (
        <div className="grid grid-cols-1 gap-4">
          {calculations.map((calc: any) => (
            <Card key={calc.id} className="hover:shadow-lg transition-shadow">
              <CardContent className="p-6">
                <div className="flex items-start justify-between">
                  <div className="flex-1 space-y-4">
                    {/* CabeÃ§alho */}
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <User className="w-6 h-6 text-green-600" />
                      </div>
                      <div className="flex-1">
                        <h3 className="text-lg font-semibold text-gray-900">
                          {calc.employeeName || `FuncionÃ¡rio #${calc.employeeId}`}
                        </h3>
                        <p className="text-sm text-gray-500">
                          {calc.policyName || "PolÃ­tica de BÃ´nus"}
                        </p>
                      </div>
                      {getStatusBadge(calc.status)}
                    </div>

                    {/* Detalhes do CÃ¡lculo */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg">
                      <div>
                        <p className="text-xs text-gray-500 mb-1">SalÃ¡rio Base</p>
                        <p className="text-sm font-semibold">
                          R$ {Number(calc.baseSalary || 0).toLocaleString("pt-BR", {
                            minimumFractionDigits: 2,
                          })}
                        </p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Multiplicador</p>
                        <p className="text-sm font-semibold flex items-center gap-1">
                          <TrendingUp className="w-4 h-4 text-blue-600" />
                          {Number(calc.appliedMultiplier || 0).toFixed(1)}x
                        </p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Valor do BÃ´nus</p>
                        <p className="text-lg font-bold text-green-600">
                          R$ {Number(calc.bonusAmount || 0).toLocaleString("pt-BR", {
                            minimumFractionDigits: 2,
                          })}
                        </p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Calculado em</p>
                        <p className="text-sm font-semibold flex items-center gap-1">
                          <Calendar className="w-4 h-4 text-gray-400" />
                          {calc.calculatedAt
                            ? new Date(calc.calculatedAt).toLocaleDateString("pt-BR")
                            : "N/A"}
                        </p>
                      </div>
                    </div>

                    {/* Justificativa */}
                    {calc.adjustmentReason && (
                      <div className="flex items-start gap-2 p-3 bg-blue-50 rounded-lg">
                        <AlertCircle className="w-5 h-5 text-blue-600 mt-0.5" />
                        <div>
                          <p className="text-sm font-medium text-blue-900">Justificativa</p>
                          <p className="text-sm text-blue-700">{calc.adjustmentReason}</p>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* AÃ§Ãµes */}
                  <div className="flex flex-col gap-2 ml-4">
                    {calc.status === "calculado" && (
                      <>
                        <Button
                          onClick={() => {
                            setSelectedCalculation(calc);
                            setIsApproveDialogOpen(true);
                          }}
                          className="bg-green-600 hover:bg-green-700"
                        >
                          <CheckCircle className="w-4 h-4 mr-2" />
                          Aprovar
                        </Button>
                        <Button
                          variant="outline"
                          onClick={() => {
                            setSelectedCalculation(calc);
                            setIsRejectDialogOpen(true);
                          }}
                          className="border-red-300 text-red-600 hover:bg-red-50"
                        >
                          <XCircle className="w-4 h-4 mr-2" />
                          Rejeitar
                        </Button>
                      </>
                    )}
                    {calc.status === "aprovado" && (
                      <Button
                        onClick={() => handleMarkAsPaid(calc.id)}
                        disabled={markAsPaidMutation.isPending}
                      >
                        <DollarSign className="w-4 h-4 mr-2" />
                        Marcar como Pago
                      </Button>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      ) : (
        <Card>
          <CardContent className="p-12">
            <div className="flex flex-col items-center justify-center">
              <DollarSign className="w-16 h-16 text-gray-300 mb-4" />
              <h3 className="text-lg font-semibold text-gray-700 mb-2">
                Nenhum cÃ¡lculo encontrado
              </h3>
              <p className="text-gray-500 text-center max-w-md">
                NÃ£o hÃ¡ cÃ¡lculos de bÃ´nus com o status "{filterStatus}" no momento.
              </p>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Dialog de AprovaÃ§Ã£o */}
      <Dialog open={isApproveDialogOpen} onOpenChange={setIsApproveDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Confirmar AprovaÃ§Ã£o de BÃ´nus</DialogTitle>
            <DialogDescription>
              VocÃª estÃ¡ prestes a aprovar o bÃ´nus para{" "}
              <strong>{selectedCalculation?.employeeName}</strong>.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <div className="bg-gray-50 p-4 rounded-lg space-y-2">
              <div className="flex justify-between">
                <span className="text-sm text-gray-600">Valor do BÃ´nus:</span>
                <span className="text-lg font-bold text-green-600">
                  R${" "}
                  {Number(selectedCalculation?.bonusAmount || 0).toLocaleString("pt-BR", {
                    minimumFractionDigits: 2,
                  })}
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-sm text-gray-600">Multiplicador:</span>
                <span className="text-sm font-semibold">
                  {Number(selectedCalculation?.appliedMultiplier || 0).toFixed(1)}x
                </span>
              </div>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setIsApproveDialogOpen(false)}>
              Cancelar
            </Button>
            <Button
              onClick={handleApprove}
              disabled={approveMutation.isPending}
              className="bg-green-600 hover:bg-green-700"
            >
              {approveMutation.isPending ? "Aprovando..." : "Confirmar AprovaÃ§Ã£o"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog de RejeiÃ§Ã£o */}
      <Dialog open={isRejectDialogOpen} onOpenChange={setIsRejectDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Rejeitar BÃ´nus</DialogTitle>
            <DialogDescription>
              VocÃª estÃ¡ prestes a rejeitar o bÃ´nus para{" "}
              <strong>{selectedCalculation?.employeeName}</strong>.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <p className="text-sm text-gray-600">
              Esta aÃ§Ã£o marcarÃ¡ o cÃ¡lculo como rejeitado. Deseja continuar?
            </p>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setIsRejectDialogOpen(false)}>
              Cancelar
            </Button>
            <Button
              onClick={handleReject}
              variant="destructive"
            >
              Confirmar RejeiÃ§Ã£o
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/RelatorioBonus.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Input } from "@/components/ui/input";
import { DollarSign, Download, TrendingUp, Users, Calendar, Filter, LineChart as LineChartIcon, BarChart3, FileText, PieChart, ArrowUp, ArrowDown, Minus } from "lucide-react";
import { toast } from "sonner";
import ExcelJS from "exceljs";
import jsPDF from "jspdf";
import html2canvas from "html2canvas";
import { Line, Bar, Pie } from "react-chartjs-2";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
} from "chart.js";

// Registrar componentes do Chart.js
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend
);

export default function RelatorioBonus() {
  const [filterStatus, setFilterStatus] = useState<string>("pago");
  const [filterMonth, setFilterMonth] = useState<string>("");
  const [searchTerm, setSearchTerm] = useState("");
  
  // Filtros para grÃ¡ficos
  const [chartPeriod, setChartPeriod] = useState<number>(6);
  const [selectedDepartment, setSelectedDepartment] = useState<number | null>(null);

  // Buscar dados de bÃ´nus
  const { data: calculations, isLoading } = trpc.bonus.listCalculations.useQuery({
    status: filterStatus as any,
  });

  // Buscar estatÃ­sticas
  const { data: stats } = trpc.bonus.getStats.useQuery();

  // Buscar tendÃªncias mensais (com filtro de perÃ­odo)
  const { data: monthlyTrends } = trpc.bonus.getMonthlyTrends.useQuery({ months: chartPeriod });

  // Buscar distribuiÃ§Ã£o por departamento
  const { data: deptDistribution } = trpc.bonus.getDepartmentDistribution.useQuery();
  
  // Filtrar distribuiÃ§Ã£o por departamento selecionado
  const filteredDeptDistribution = selectedDepartment
    ? deptDistribution?.filter(d => d.departmentId === selectedDepartment)
    : deptDistribution;
  
  // Buscar lista de departamentos para o filtro
  const { data: departments } = trpc.organization.departments.list.useQuery();

  // Filtrar por termo de busca
  const filteredCalculations = calculations?.filter((calc: any) => {
    const matchesSearch = searchTerm === "" || 
      calc.employeeName?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesMonth = filterMonth === "" || 
      calc.referenceMonth === filterMonth;
    return matchesSearch && matchesMonth;
  });

  const handleExportToPDF = async () => {
    try {
      if (!filteredCalculations || filteredCalculations.length === 0) {
        toast.error("Nenhum dado para exportar");
        return;
      }

      toast.info("Gerando PDF... Aguarde");

      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      let yPosition = 20;

      // CabeÃ§alho
      pdf.setFontSize(20);
      pdf.setTextColor(31, 41, 55);
      pdf.text("RelatÃ³rio de BÃ´nus", pageWidth / 2, yPosition, { align: "center" });
      yPosition += 10;

      pdf.setFontSize(10);
      pdf.setTextColor(107, 114, 128);
      pdf.text(
        `Gerado em: ${new Date().toLocaleDateString("pt-BR")} Ã s ${new Date().toLocaleTimeString("pt-BR")}`,
        pageWidth / 2,
        yPosition,
        { align: "center" }
      );
      yPosition += 15;

      // KPIs
      pdf.setFontSize(14);
      pdf.setTextColor(31, 41, 55);
      pdf.text("Indicadores Principais", 15, yPosition);
      yPosition += 10;

      const kpis = [
        { label: "Total Pago", value: `R$ ${(totalPaid / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}` },
        { label: "MÃ©dia por Colaborador", value: `R$ ${(avgBonus / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}` },
        { label: "Colaboradores Beneficiados", value: filteredCalculations.length.toString() },
        { label: "PolÃ­ticas Ativas", value: (stats?.activePolicies || 0).toString() },
      ];

      pdf.setFontSize(10);
      kpis.forEach((kpi, index) => {
        const xPos = 15 + (index % 2) * 90;
        const yPos = yPosition + Math.floor(index / 2) * 12;
        pdf.setTextColor(107, 114, 128);
        pdf.text(kpi.label, xPos, yPos);
        pdf.setTextColor(31, 41, 55);
        pdf.setFont(undefined, "bold");
        pdf.text(kpi.value, xPos, yPos + 5);
        pdf.setFont(undefined, "normal");
      });
      yPosition += 30;

      // Capturar grÃ¡ficos
      const chartElements = document.querySelectorAll("canvas");
      if (chartElements.length > 0) {
        pdf.setFontSize(14);
        pdf.setTextColor(31, 41, 55);
        pdf.text("GrÃ¡ficos de AnÃ¡lise", 15, yPosition);
        yPosition += 10;

        for (let i = 0; i < Math.min(2, chartElements.length); i++) {
          const canvas = chartElements[i] as HTMLCanvasElement;
          const imgData = canvas.toDataURL("image/png");
          const imgWidth = 180;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          if (yPosition + imgHeight > pageHeight - 20) {
            pdf.addPage();
            yPosition = 20;
          }

          pdf.addImage(imgData, "PNG", 15, yPosition, imgWidth, imgHeight);
          yPosition += imgHeight + 10;
        }
      }

      // Tabela de dados (primeiros 10 registros)
      if (yPosition + 60 > pageHeight) {
        pdf.addPage();
        yPosition = 20;
      }

      pdf.setFontSize(14);
      pdf.setTextColor(31, 41, 55);
      pdf.text("Detalhamento de BÃ´nus (Top 10)", 15, yPosition);
      yPosition += 10;

      pdf.setFontSize(8);
      pdf.setTextColor(107, 114, 128);
      pdf.text("Colaborador", 15, yPosition);
      pdf.text("PolÃ­tica", 70, yPosition);
      pdf.text("Valor", 120, yPosition, { align: "right" });
      pdf.text("Status", 150, yPosition);
      pdf.text("MÃªs Ref.", 180, yPosition);
      yPosition += 5;

      pdf.setDrawColor(229, 231, 235);
      pdf.line(15, yPosition, pageWidth - 15, yPosition);
      yPosition += 5;

      const topCalculations = filteredCalculations.slice(0, 10);
      pdf.setTextColor(31, 41, 55);
      topCalculations.forEach((calc: any) => {
        if (yPosition > pageHeight - 20) {
          pdf.addPage();
          yPosition = 20;
        }

        pdf.text(calc.employeeName || `Func. #${calc.employeeId}`, 15, yPosition);
        pdf.text((calc.policyName || "N/A").substring(0, 20), 70, yPosition);
        pdf.text(
          `R$ ${(Number(calc.bonusAmount) / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`,
          120,
          yPosition,
          { align: "right" }
        );
        pdf.text(calc.status || "N/A", 150, yPosition);
        pdf.text(calc.referenceMonth || "N/A", 180, yPosition);
        yPosition += 7;
      });

      // RodapÃ©
      const totalPages = (pdf as any).internal.pages.length - 1;
      for (let i = 1; i <= totalPages; i++) {
        pdf.setPage(i);
        pdf.setFontSize(8);
        pdf.setTextColor(156, 163, 175);
        pdf.text(
          `PÃ¡gina ${i} de ${totalPages} | Sistema AVD UISA`,
          pageWidth / 2,
          pageHeight - 10,
          { align: "center" }
        );
      }

      // Salvar PDF
      pdf.save(`relatorio-bonus-${new Date().toISOString().split("T")[0]}.pdf`);
      toast.success("PDF gerado com sucesso!");
    } catch (error) {
      console.error("Erro ao gerar PDF:", error);
      toast.error("Erro ao gerar PDF");
    }
  };

  const handleExportToExcel = async () => {
    try {
      if (!filteredCalculations || filteredCalculations.length === 0) {
        toast.error("Nenhum dado para exportar");
        return;
      }

      const workbook = new ExcelJS.Workbook();
      const worksheet = workbook.addWorksheet("RelatÃ³rio de BÃ´nus");

      // Definir colunas
      worksheet.columns = [
        { header: "ID", key: "id", width: 10 },
        { header: "Colaborador", key: "employeeName", width: 30 },
        { header: "PolÃ­tica", key: "policyName", width: 25 },
        { header: "SalÃ¡rio Base", key: "baseSalary", width: 15 },
        { header: "Multiplicador", key: "multiplier", width: 15 },
        { header: "Valor BÃ´nus", key: "bonusAmount", width: 15 },
        { header: "Status", key: "status", width: 15 },
        { header: "MÃªs ReferÃªncia", key: "referenceMonth", width: 15 },
        { header: "Data CÃ¡lculo", key: "calculatedAt", width: 20 },
        { header: "Data Pagamento", key: "paidAt", width: 20 },
      ];

      // Estilizar cabeÃ§alho
      worksheet.getRow(1).font = { bold: true, color: { argb: "FFFFFFFF" } };
      worksheet.getRow(1).fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "FF4F46E5" },
      };
      worksheet.getRow(1).alignment = { vertical: "middle", horizontal: "center" };

      // Adicionar dados
      filteredCalculations.forEach((calc: any) => {
        worksheet.addRow({
          id: calc.id,
          employeeName: calc.employeeName || "N/A",
          policyName: calc.policyName || "N/A",
          baseSalary: Number(calc.baseSalary || 0) / 100,
          multiplier: calc.multiplier || 0,
          bonusAmount: Number(calc.bonusAmount || 0) / 100,
          status: calc.status === "pago" ? "Pago" : calc.status === "aprovado" ? "Aprovado" : "Calculado",
          referenceMonth: calc.referenceMonth || "N/A",
          calculatedAt: calc.calculatedAt ? new Date(calc.calculatedAt).toLocaleDateString("pt-BR") : "N/A",
          paidAt: calc.paidAt ? new Date(calc.paidAt).toLocaleDateString("pt-BR") : "N/A",
        });
      });

      // Formatar colunas de valores monetÃ¡rios
      worksheet.getColumn("baseSalary").numFmt = 'R$ #,##0.00';
      worksheet.getColumn("bonusAmount").numFmt = 'R$ #,##0.00';

      // Adicionar bordas
      worksheet.eachRow((row, rowNumber) => {
        row.eachCell((cell) => {
          cell.border = {
            top: { style: "thin" },
            left: { style: "thin" },
            bottom: { style: "thin" },
            right: { style: "thin" },
          };
        });
      });

      // Adicionar linha de totais
      const totalRow = worksheet.addRow({
        id: "",
        employeeName: "TOTAL",
        policyName: "",
        baseSalary: "",
        multiplier: "",
        bonusAmount: totalPaid / 100,
        status: "",
        referenceMonth: "",
        calculatedAt: "",
        paidAt: "",
      });
      totalRow.font = { bold: true };
      totalRow.fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "FFE5E7EB" },
      };

      // Gerar arquivo
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `relatorio-bonus-${new Date().toISOString().split("T")[0]}.xlsx`;
      link.click();
      window.URL.revokeObjectURL(url);

      toast.success("RelatÃ³rio exportado com sucesso!");
    } catch (error) {
      console.error("Erro ao exportar:", error);
      toast.error("Erro ao exportar relatÃ³rio");
    }
  };

  const totalPaid = filteredCalculations?.reduce(
    (sum: number, calc: any) => sum + Number(calc.bonusAmount || 0),
    0
  ) || 0;

  const avgBonus = filteredCalculations && filteredCalculations.length > 0
    ? totalPaid / filteredCalculations.length
    : 0;

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-2">
            <DollarSign className="w-8 h-8 text-green-600" />
            RelatÃ³rio de BÃ´nus
          </h1>
          <p className="text-gray-500 mt-1">
            HistÃ³rico completo de bÃ´nus calculados, aprovados e pagos
          </p>
        </div>
        <div className="flex gap-2">
          <Button onClick={handleExportToPDF} variant="outline" className="gap-2">
            <FileText className="w-4 h-4" />
            Exportar PDF
          </Button>
          <Button onClick={handleExportToExcel} className="gap-2">
            <Download className="w-4 h-4" />
            Exportar Excel
          </Button>
        </div>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-500 mb-1">Total Pago</p>
                <p className="text-2xl font-bold text-green-600">
                  R$ {totalPaid.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                </p>
              </div>
              <DollarSign className="w-10 h-10 text-green-600 opacity-20" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-500 mb-1">MÃ©dia por Colaborador</p>
                <p className="text-2xl font-bold text-blue-600">
                  R$ {avgBonus.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                </p>
              </div>
              <TrendingUp className="w-10 h-10 text-blue-600 opacity-20" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-500 mb-1">Colaboradores Beneficiados</p>
                <p className="text-2xl font-bold text-purple-600">
                  {filteredCalculations?.length || 0}
                </p>
              </div>
              <Users className="w-10 h-10 text-purple-600 opacity-20" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-500 mb-1">PolÃ­ticas Ativas</p>
                <p className="text-2xl font-bold text-orange-600">
                  {stats?.activePolicies || 0}
                </p>
              </div>
              <Calendar className="w-10 h-10 text-orange-600 opacity-20" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Filtros */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Filter className="w-5 h-5" />
            Filtros
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label className="text-sm font-medium mb-2 block">Status</label>
              <Select value={filterStatus} onValueChange={setFilterStatus}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="calculado">Calculado</SelectItem>
                  <SelectItem value="aprovado">Aprovado</SelectItem>
                  <SelectItem value="pago">Pago</SelectItem>
                  <SelectItem value="cancelado">Cancelado</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">MÃªs de ReferÃªncia</label>
              <Input
                type="month"
                value={filterMonth}
                onChange={(e) => setFilterMonth(e.target.value)}
                placeholder="Selecione o mÃªs"
              />
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">Buscar Colaborador</label>
              <Input
                type="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="Nome do colaborador..."
              />
            </div>

            <div className="flex items-end">
              <Button
                variant="outline"
                onClick={() => {
                  setFilterStatus("pago");
                  setFilterMonth("");
                  setSearchTerm("");
                }}
                className="w-full"
              >
                Limpar Filtros
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Filtros dos GrÃ¡ficos */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Filter className="w-5 h-5" />
            Filtros dos GrÃ¡ficos
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label className="text-sm font-medium mb-2 block">PerÃ­odo</label>
              <Select value={chartPeriod.toString()} onValueChange={(v) => setChartPeriod(Number(v))}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="3">Ãšltimos 3 meses</SelectItem>
                  <SelectItem value="6">Ãšltimos 6 meses</SelectItem>
                  <SelectItem value="12">Ãšltimos 12 meses</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <label className="text-sm font-medium mb-2 block">Departamento</label>
              <Select 
                value={selectedDepartment?.toString() || "all"} 
                onValueChange={(v) => setSelectedDepartment(v === "all" ? null : Number(v))}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Todos os departamentos" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os departamentos</SelectItem>
                  {departments?.map((dept: any) => (
                    <SelectItem key={dept.id} value={dept.id.toString()}>
                      {dept.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="flex items-end">
              <Button
                variant="outline"
                onClick={() => {
                  setChartPeriod(6);
                  setSelectedDepartment(null);
                }}
                className="w-full"
              >
                Limpar Filtros
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* GrÃ¡ficos de EvoluÃ§Ã£o */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* GrÃ¡fico de EvoluÃ§Ã£o Mensal */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <LineChartIcon className="w-5 h-5 text-blue-600" />
              EvoluÃ§Ã£o Mensal de BÃ´nus
            </CardTitle>
            <CardDescription>
              TendÃªncia dos Ãºltimos {chartPeriod} meses
            </CardDescription>
          </CardHeader>
          <CardContent>
            {monthlyTrends && monthlyTrends.length > 0 ? (
              <Line
                data={{
                  labels: monthlyTrends.map((t) => t.month),
                  datasets: [
                    {
                      label: "Total de BÃ´nus (R$)",
                      data: monthlyTrends.map((t) => Number(t.totalAmount) / 100),
                      borderColor: "rgb(59, 130, 246)",
                      backgroundColor: "rgba(59, 130, 246, 0.1)",
                      tension: 0.4,
                    },
                    {
                      label: "BÃ´nus Pagos (R$)",
                      data: monthlyTrends.map((t) => Number(t.paidAmount) / 100),
                      borderColor: "rgb(34, 197, 94)",
                      backgroundColor: "rgba(34, 197, 94, 0.1)",
                      tension: 0.4,
                    },
                  ],
                }}
                options={{
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: "top" as const,
                    },
                    tooltip: {
                      callbacks: {
                        label: function (context) {
                          let label = context.dataset.label || "";
                          if (label) {
                            label += ": ";
                          }
                          if (context.parsed.y !== null) {
                            label += new Intl.NumberFormat("pt-BR", {
                              style: "currency",
                              currency: "BRL",
                            }).format(context.parsed.y);
                          }
                          return label;
                        },
                      },
                    },
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function (value) {
                          return new Intl.NumberFormat("pt-BR", {
                            style: "currency",
                            currency: "BRL",
                            notation: "compact",
                          }).format(value as number);
                        },
                      },
                    },
                  },
                }}
                height={300}
              />
            ) : (
              <div className="flex items-center justify-center h-[300px] text-gray-400">
                Sem dados disponÃ­veis
              </div>
            )}
          </CardContent>
        </Card>

        {/* GrÃ¡fico de DistribuiÃ§Ã£o por Departamento */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <BarChart3 className="w-5 h-5 text-purple-600" />
              DistribuiÃ§Ã£o por Departamento
            </CardTitle>
            <CardDescription>
              ComparaÃ§Ã£o de bÃ´nus entre departamentos
            </CardDescription>
          </CardHeader>
          <CardContent>
            {filteredDeptDistribution && filteredDeptDistribution.length > 0 ? (
              <Bar
                data={{
                  labels: filteredDeptDistribution.map((d) => {
                    const dept = departments?.find((dep: any) => dep.id === d.departmentId);
                    return dept?.name || `Dept. ${d.departmentId}`;
                  }),
                  datasets: [
                    {
                      label: "Total de BÃ´nus (R$)",
                      data: filteredDeptDistribution.map((d) => Number(d.totalAmount) / 100),
                      backgroundColor: "rgba(147, 51, 234, 0.7)",
                      borderColor: "rgb(147, 51, 234)",
                      borderWidth: 1,
                    },
                  ],
                }}
                options={{
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: false,
                    },
                    tooltip: {
                      callbacks: {
                        label: function (context) {
                          let label = context.dataset.label || "";
                          if (label) {
                            label += ": ";
                          }
                          if (context.parsed.y !== null) {
                            label += new Intl.NumberFormat("pt-BR", {
                              style: "currency",
                              currency: "BRL",
                            }).format(context.parsed.y);
                          }
                          return label;
                        },
                      },
                    },
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function (value) {
                          return new Intl.NumberFormat("pt-BR", {
                            style: "currency",
                            currency: "BRL",
                            notation: "compact",
                          }).format(value as number);
                        },
                      },
                    },
                  },
                }}
                height={300}
              />
            ) : (
              <div className="flex items-center justify-center h-[300px] text-gray-400">
                Sem dados disponÃ­veis
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* GrÃ¡fico de Pizza - DistribuiÃ§Ã£o por Status */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <PieChart className="w-5 h-5 text-orange-600" />
            DistribuiÃ§Ã£o por Status
          </CardTitle>
          <CardDescription>
            ProporÃ§Ã£o de bÃ´nus por status atual
          </CardDescription>
        </CardHeader>
        <CardContent>
          {calculations && calculations.length > 0 ? (
            <div className="flex items-center justify-center">
              <Pie
                data={{
                  labels: ["Pago", "Aprovado", "Calculado"],
                  datasets: [
                    {
                      data: [
                        calculations.filter((c: any) => c.status === "pago").length,
                        calculations.filter((c: any) => c.status === "aprovado").length,
                        calculations.filter((c: any) => c.status === "calculado").length,
                      ],
                      backgroundColor: [
                        "rgba(34, 197, 94, 0.8)",
                        "rgba(59, 130, 246, 0.8)",
                        "rgba(251, 191, 36, 0.8)",
                      ],
                      borderColor: [
                        "rgb(34, 197, 94)",
                        "rgb(59, 130, 246)",
                        "rgb(251, 191, 36)",
                      ],
                      borderWidth: 2,
                    },
                  ],
                }}
                options={{
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: "right" as const,
                    },
                    tooltip: {
                      callbacks: {
                        label: function (context) {
                          const label = context.label || "";
                          const value = context.parsed;
                          const total = context.dataset.data.reduce((a: number, b: number) => a + b, 0);
                          const percentage = ((value / total) * 100).toFixed(1);
                          return `${label}: ${value} (${percentage}%)`;
                        },
                      },
                    },
                  },
                }}
                height={300}
              />
            </div>
          ) : (
            <div className="flex items-center justify-center h-[300px] text-gray-400">
              Sem dados disponÃ­veis
            </div>
          )}
        </CardContent>
      </Card>

      {/* Indicadores de TendÃªncia */}
      {monthlyTrends && monthlyTrends.length >= 2 && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <TrendingUp className="w-5 h-5 text-purple-600" />
              Indicadores de TendÃªncia
            </CardTitle>
            <CardDescription>
              ComparaÃ§Ã£o com o mÃªs anterior
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {(() => {
                const lastMonth = monthlyTrends[monthlyTrends.length - 1];
                const previousMonth = monthlyTrends[monthlyTrends.length - 2];
                
                const totalChange = ((Number(lastMonth.totalAmount) - Number(previousMonth.totalAmount)) / Number(previousMonth.totalAmount)) * 100;
                const countChange = ((lastMonth.count - previousMonth.count) / previousMonth.count) * 100;
                const avgChange = ((Number(lastMonth.averageBonus) - Number(previousMonth.averageBonus)) / Number(previousMonth.averageBonus)) * 100;

                const getTrendIcon = (change: number) => {
                  if (change > 5) return <ArrowUp className="w-5 h-5 text-green-600" />;
                  if (change < -5) return <ArrowDown className="w-5 h-5 text-red-600" />;
                  return <Minus className="w-5 h-5 text-gray-600" />;
                };

                const getTrendColor = (change: number) => {
                  if (change > 5) return "text-green-600";
                  if (change < -5) return "text-red-600";
                  return "text-gray-600";
                };

                return (
                  <>
                    <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                      <CardContent className="pt-6">
                        <div className="flex items-center justify-between mb-2">
                          <p className="text-sm text-blue-700 font-medium">Total de BÃ´nus</p>
                          {getTrendIcon(totalChange)}
                        </div>
                        <p className={`text-2xl font-bold ${getTrendColor(totalChange)}`}>
                          {totalChange > 0 ? "+" : ""}{totalChange.toFixed(1)}%
                        </p>
                        <p className="text-xs text-blue-600 mt-1">
                          vs. mÃªs anterior
                        </p>
                      </CardContent>
                    </Card>

                    <Card className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
                      <CardContent className="pt-6">
                        <div className="flex items-center justify-between mb-2">
                          <p className="text-sm text-purple-700 font-medium">Quantidade</p>
                          {getTrendIcon(countChange)}
                        </div>
                        <p className={`text-2xl font-bold ${getTrendColor(countChange)}`}>
                          {countChange > 0 ? "+" : ""}{countChange.toFixed(1)}%
                        </p>
                        <p className="text-xs text-purple-600 mt-1">
                          vs. mÃªs anterior
                        </p>
                      </CardContent>
                    </Card>

                    <Card className="bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200">
                      <CardContent className="pt-6">
                        <div className="flex items-center justify-between mb-2">
                          <p className="text-sm text-orange-700 font-medium">MÃ©dia por Pessoa</p>
                          {getTrendIcon(avgChange)}
                        </div>
                        <p className={`text-2xl font-bold ${getTrendColor(avgChange)}`}>
                          {avgChange > 0 ? "+" : ""}{avgChange.toFixed(1)}%
                        </p>
                        <p className="text-xs text-orange-600 mt-1">
                          vs. mÃªs anterior
                        </p>
                      </CardContent>
                    </Card>
                  </>
                );
              })()}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Tabela de BÃ´nus */}
      <Card>
        <CardHeader>
          <CardTitle>HistÃ³rico de BÃ´nus</CardTitle>
          <CardDescription>
            {filteredCalculations?.length || 0} registros encontrados
          </CardDescription>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="flex items-center justify-center p-12">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
          ) : filteredCalculations && filteredCalculations.length > 0 ? (
            <div className="overflow-x-auto">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Colaborador</TableHead>
                    <TableHead>PolÃ­tica</TableHead>
                    <TableHead className="text-right">SalÃ¡rio Base</TableHead>
                    <TableHead className="text-center">Multiplicador</TableHead>
                    <TableHead className="text-right">Valor do BÃ´nus</TableHead>
                    <TableHead>MÃªs Ref.</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead>Calculado em</TableHead>
                    <TableHead>Aprovado em</TableHead>
                    <TableHead>Pago em</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredCalculations.map((calc: any) => (
                    <TableRow key={calc.id}>
                      <TableCell className="font-medium">
                        {calc.employeeName || `FuncionÃ¡rio #${calc.employeeId}`}
                      </TableCell>
                      <TableCell className="text-sm text-gray-600">
                        {calc.policyName || "N/A"}
                      </TableCell>
                      <TableCell className="text-right">
                        R$ {Number(calc.baseSalary || 0).toLocaleString("pt-BR", {
                          minimumFractionDigits: 2,
                        })}
                      </TableCell>
                      <TableCell className="text-center font-semibold">
                        {Number(calc.appliedMultiplier || 0).toFixed(1)}x
                      </TableCell>
                      <TableCell className="text-right font-bold text-green-600">
                        R$ {Number(calc.bonusAmount || 0).toLocaleString("pt-BR", {
                          minimumFractionDigits: 2,
                        })}
                      </TableCell>
                      <TableCell>{calc.referenceMonth || "N/A"}</TableCell>
                      <TableCell>
                        <Badge
                          variant={
                            calc.status === "pago"
                              ? "outline"
                              : calc.status === "aprovado"
                              ? "default"
                              : "secondary"
                          }
                        >
                          {calc.status}
                        </Badge>
                      </TableCell>
                      <TableCell className="text-sm text-gray-600">
                        {calc.calculatedAt
                          ? new Date(calc.calculatedAt).toLocaleDateString("pt-BR")
                          : "-"}
                      </TableCell>
                      <TableCell className="text-sm text-gray-600">
                        {calc.approvedAt
                          ? new Date(calc.approvedAt).toLocaleDateString("pt-BR")
                          : "-"}
                      </TableCell>
                      <TableCell className="text-sm text-gray-600">
                        {calc.paidAt
                          ? new Date(calc.paidAt).toLocaleDateString("pt-BR")
                          : "-"}
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </div>
          ) : (
            <div className="flex flex-col items-center justify-center p-12">
              <DollarSign className="w-16 h-16 text-gray-300 mb-4" />
              <h3 className="text-lg font-semibold text-gray-700 mb-2">
                Nenhum registro encontrado
              </h3>
              <p className="text-gray-500 text-center max-w-md">
                NÃ£o hÃ¡ bÃ´nus com os filtros selecionados. Tente ajustar os critÃ©rios de busca.
              </p>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/PrevisaoBonus.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Slider } from "@/components/ui/slider";
import { TrendingUp, Calculator, Target, DollarSign, Users, AlertCircle } from "lucide-react";
import { Line } from "react-chartjs-2";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend,
  Filler,
} from "chart.js";

ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend,
  Filler
);

export default function PrevisaoBonus() {
  const [selectedEmployee, setSelectedEmployee] = useState<number | null>(null);
  const [performanceProjection, setPerformanceProjection] = useState<number>(85);
  const [goalCompletionRate, setGoalCompletionRate] = useState<number>(75);

  // Buscar dados
  const { data: employees } = trpc.employees.list.useQuery({});
  const { data: policies } = trpc.bonus.list.useQuery({ active: true });
  const { data: monthlyTrends } = trpc.bonus.getMonthlyTrends.useQuery({ months: 6 });

  // Buscar dados do funcionÃ¡rio selecionado
  const { data: employeeData } = trpc.employees.getById.useQuery(
    selectedEmployee!,
    { enabled: !!selectedEmployee }
  );

  // Calcular previsÃ£o de bÃ´nus
  const calculateProjection = () => {
    if (!employeeData || !policies || policies.length === 0) return null;

    // Encontrar polÃ­tica aplicÃ¡vel ao cargo do funcionÃ¡rio
    const applicablePolicy = policies.find(
      (p: any) => p.positionId === employeeData.positionId
    );

    if (!applicablePolicy) return null;

    const baseSalary = Number(employeeData.salary || 0);
    
    // Calcular multiplicador baseado em performance e metas
    const performanceFactor = performanceProjection / 100;
    const goalFactor = goalCompletionRate / 100;
    const combinedFactor = (performanceFactor * 0.6 + goalFactor * 0.4);
    
    // Aplicar multiplicadores da polÃ­tica
    let multiplier = 0;
    if (combinedFactor >= 0.9) {
      multiplier = Number(applicablePolicy.multiplierExceeded || 0);
    } else if (combinedFactor >= 0.7) {
      multiplier = Number(applicablePolicy.multiplierMet || 0);
    } else {
      multiplier = Number(applicablePolicy.multiplierPartial || 0);
    }

    const projectedBonus = baseSalary * multiplier;

    return {
      baseSalary,
      multiplier,
      projectedBonus,
      performanceFactor,
      goalFactor,
      combinedFactor,
      policyName: applicablePolicy.name,
    };
  };

  const projection = calculateProjection();

  // Gerar dados de projeÃ§Ã£o futura (prÃ³ximos 6 meses)
  const generateFutureProjection = () => {
    if (!projection || !monthlyTrends) return null;

    const lastMonths = monthlyTrends.slice(-3);
    const avgGrowth = lastMonths.length > 1
      ? (Number(lastMonths[lastMonths.length - 1].totalAmount) - Number(lastMonths[0].totalAmount)) / lastMonths.length
      : 0;

    const futureMonths = [];
    const currentMonth = new Date();
    
    for (let i = 1; i <= 6; i++) {
      const futureDate = new Date(currentMonth);
      futureDate.setMonth(currentMonth.getMonth() + i);
      const monthLabel = futureDate.toLocaleDateString("pt-BR", { month: "short", year: "numeric" });
      
      // ProjeÃ§Ã£o conservadora, moderada e otimista
      const baseProjection = projection.projectedBonus;
      const conservative = baseProjection * 0.85;
      const moderate = baseProjection;
      const optimistic = baseProjection * 1.15;

      futureMonths.push({
        month: monthLabel,
        conservative,
        moderate,
        optimistic,
      });
    }

    return futureMonths;
  };

  const futureProjection = generateFutureProjection();

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-2">
          <Calculator className="w-8 h-8 text-blue-600" />
          PrevisÃ£o de BÃ´nus
        </h1>
        <p className="text-gray-500 mt-1">
          Simule cenÃ¡rios futuros baseados em metas e performance
        </p>
      </div>

      {/* Simulador */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Target className="w-5 h-5 text-purple-600" />
            Simulador Interativo
          </CardTitle>
          <CardDescription>
            Ajuste os parÃ¢metros para calcular a previsÃ£o de bÃ´nus
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {/* SeleÃ§Ã£o de FuncionÃ¡rio */}
            <div className="space-y-2">
              <label className="text-sm font-medium">Colaborador</label>
              <Select
                value={selectedEmployee?.toString() || ""}
                onValueChange={(v) => setSelectedEmployee(Number(v))}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Selecione um colaborador" />
                </SelectTrigger>
                <SelectContent>
                  {employees?.map((emp: any) => (
                    <SelectItem key={emp.id} value={emp.id.toString()}>
                      {emp.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* ProjeÃ§Ã£o de Performance */}
            <div className="space-y-2">
              <label className="text-sm font-medium">
                ProjeÃ§Ã£o de Performance: {performanceProjection}%
              </label>
              <Slider
                value={[performanceProjection]}
                onValueChange={(v) => setPerformanceProjection(v[0])}
                min={0}
                max={100}
                step={5}
                className="mt-2"
              />
              <p className="text-xs text-gray-500">
                Performance esperada no perÃ­odo
              </p>
            </div>

            {/* Taxa de ConclusÃ£o de Metas */}
            <div className="space-y-2">
              <label className="text-sm font-medium">
                ConclusÃ£o de Metas: {goalCompletionRate}%
              </label>
              <Slider
                value={[goalCompletionRate]}
                onValueChange={(v) => setGoalCompletionRate(v[0])}
                min={0}
                max={100}
                step={5}
                className="mt-2"
              />
              <p className="text-xs text-gray-500">
                Percentual de metas atingidas
              </p>
            </div>
          </div>

          {/* Resultado da SimulaÃ§Ã£o */}
          {projection && employeeData ? (
            <div className="mt-6 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">
                Resultado da SimulaÃ§Ã£o
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <p className="text-sm text-gray-600">SalÃ¡rio Base</p>
                  <p className="text-2xl font-bold text-gray-900">
                    R$ {(projection.baseSalary / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-gray-600">Multiplicador</p>
                  <p className="text-2xl font-bold text-blue-600">
                    {projection.multiplier.toFixed(2)}x
                  </p>
                </div>
                <div>
                  <p className="text-sm text-gray-600">BÃ´nus Projetado</p>
                  <p className="text-2xl font-bold text-green-600">
                    R$ {(projection.projectedBonus / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-gray-600">Fator Combinado</p>
                  <p className="text-2xl font-bold text-purple-600">
                    {(projection.combinedFactor * 100).toFixed(0)}%
                  </p>
                </div>
              </div>
              <div className="mt-4 flex items-center gap-2 text-sm text-gray-600">
                <AlertCircle className="w-4 h-4" />
                <span>PolÃ­tica aplicada: {projection.policyName}</span>
              </div>
            </div>
          ) : (
            <div className="mt-6 p-6 bg-gray-50 rounded-lg border border-gray-200 text-center">
              <Users className="w-12 h-12 text-gray-400 mx-auto mb-2" />
              <p className="text-gray-600">
                Selecione um colaborador para visualizar a previsÃ£o
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* GrÃ¡fico de ProjeÃ§Ã£o Futura */}
      {futureProjection && projection && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <TrendingUp className="w-5 h-5 text-green-600" />
              ProjeÃ§Ã£o para os PrÃ³ximos 6 Meses
            </CardTitle>
            <CardDescription>
              CenÃ¡rios: Conservador, Moderado e Otimista
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Line
              data={{
                labels: futureProjection.map((f) => f.month),
                datasets: [
                  {
                    label: "CenÃ¡rio Conservador",
                    data: futureProjection.map((f) => f.conservative / 100),
                    borderColor: "rgb(239, 68, 68)",
                    backgroundColor: "rgba(239, 68, 68, 0.1)",
                    borderDash: [5, 5],
                    tension: 0.4,
                    fill: false,
                  },
                  {
                    label: "CenÃ¡rio Moderado",
                    data: futureProjection.map((f) => f.moderate / 100),
                    borderColor: "rgb(59, 130, 246)",
                    backgroundColor: "rgba(59, 130, 246, 0.2)",
                    tension: 0.4,
                    fill: true,
                  },
                  {
                    label: "CenÃ¡rio Otimista",
                    data: futureProjection.map((f) => f.optimistic / 100),
                    borderColor: "rgb(34, 197, 94)",
                    backgroundColor: "rgba(34, 197, 94, 0.1)",
                    borderDash: [5, 5],
                    tension: 0.4,
                    fill: false,
                  },
                ],
              }}
              options={{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "top" as const,
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        let label = context.dataset.label || "";
                        if (label) {
                          label += ": ";
                        }
                        if (context.parsed.y !== null) {
                          label += new Intl.NumberFormat("pt-BR", {
                            style: "currency",
                            currency: "BRL",
                          }).format(context.parsed.y);
                        }
                        return label;
                      },
                    },
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        return new Intl.NumberFormat("pt-BR", {
                          style: "currency",
                          currency: "BRL",
                          notation: "compact",
                        }).format(value as number);
                      },
                    },
                  },
                },
              }}
              height={300}
            />
          </CardContent>
        </Card>
      )}

      {/* ComparaÃ§Ã£o com HistÃ³rico */}
      {monthlyTrends && projection && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <DollarSign className="w-5 h-5 text-orange-600" />
              ComparaÃ§Ã£o com HistÃ³rico
            </CardTitle>
            <CardDescription>
              BÃ´nus projetado vs. mÃ©dia histÃ³rica
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <Card className="bg-blue-50 border-blue-200">
                <CardContent className="pt-6">
                  <p className="text-sm text-blue-600 mb-1">MÃ©dia HistÃ³rica (6 meses)</p>
                  <p className="text-2xl font-bold text-blue-700">
                    R${" "}
                    {(
                      monthlyTrends.reduce((sum, t) => sum + Number(t.averageBonus), 0) /
                      monthlyTrends.length /
                      100
                    ).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                  </p>
                </CardContent>
              </Card>

              <Card className="bg-green-50 border-green-200">
                <CardContent className="pt-6">
                  <p className="text-sm text-green-600 mb-1">BÃ´nus Projetado</p>
                  <p className="text-2xl font-bold text-green-700">
                    R$ {(projection.projectedBonus / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                  </p>
                </CardContent>
              </Card>

              <Card className="bg-purple-50 border-purple-200">
                <CardContent className="pt-6">
                  <p className="text-sm text-purple-600 mb-1">VariaÃ§Ã£o</p>
                  <p className="text-2xl font-bold text-purple-700">
                    {(
                      ((projection.projectedBonus -
                        (monthlyTrends.reduce((sum, t) => sum + Number(t.averageBonus), 0) /
                          monthlyTrends.length)) /
                        (monthlyTrends.reduce((sum, t) => sum + Number(t.averageBonus), 0) /
                          monthlyTrends.length)) *
                      100
                    ).toFixed(1)}
                    %
                  </p>
                </CardContent>
              </Card>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/AprovacaoBonusLote.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { CheckSquare, XSquare, Filter, DollarSign, Users, TrendingUp } from "lucide-react";
import { toast } from "sonner";

export default function AprovacaoBonusLote() {
  const [selectedIds, setSelectedIds] = useState<number[]>([]);
  const [filterDepartment, setFilterDepartment] = useState<number | null>(null);
  const [filterMinValue, setFilterMinValue] = useState<string>("");
  const [filterMaxValue, setFilterMaxValue] = useState<string>("");
  const [filterMonth, setFilterMonth] = useState<string>("");
  const [showApproveDialog, setShowApproveDialog] = useState(false);
  const [showRejectDialog, setShowRejectDialog] = useState(false);
  const [comment, setComment] = useState("");
  const [rejectReason, setRejectReason] = useState("");

  // Queries
  const { data: calculations, refetch } = trpc.bonus.listCalculations.useQuery({
    status: "calculado",
  });

  const { data: departments } = trpc.organization.departments.list.useQuery();

  // Mutations
  const approveBatch = trpc.bonus.approveBatch.useMutation({
    onSuccess: () => {
      toast.success(`${selectedIds.length} bÃ´nus aprovados com sucesso!`);
      setSelectedIds([]);
      setComment("");
      setShowApproveDialog(false);
      refetch();
    },
    onError: (error) => {
      toast.error(`Erro ao aprovar: ${error.message}`);
    },
  });

  const rejectBatch = trpc.bonus.rejectBatch.useMutation({
    onSuccess: () => {
      toast.success(`${selectedIds.length} bÃ´nus rejeitados`);
      setSelectedIds([]);
      setRejectReason("");
      setShowRejectDialog(false);
      refetch();
    },
    onError: (error) => {
      toast.error(`Erro ao rejeitar: ${error.message}`);
    },
  });

  // Filtrar cÃ¡lculos
  const filteredCalculations = calculations?.filter((calc: any) => {
    const matchesDept = !filterDepartment || calc.departmentId === filterDepartment;
    const matchesMonth = !filterMonth || calc.referenceMonth === filterMonth;
    
    const bonusValue = Number(calc.bonusAmount) / 100;
    const matchesMin = !filterMinValue || bonusValue >= Number(filterMinValue);
    const matchesMax = !filterMaxValue || bonusValue <= Number(filterMaxValue);

    return matchesDept && matchesMonth && matchesMin && matchesMax;
  });

  // EstatÃ­sticas
  const totalSelected = selectedIds.length;
  const totalValue = filteredCalculations
    ?.filter((c: any) => selectedIds.includes(c.id))
    .reduce((sum: number, c: any) => sum + Number(c.bonusAmount), 0) || 0;

  const handleToggleAll = () => {
    if (selectedIds.length === filteredCalculations?.length) {
      setSelectedIds([]);
    } else {
      setSelectedIds(filteredCalculations?.map((c: any) => c.id) || []);
    }
  };

  const handleToggle = (id: number) => {
    setSelectedIds((prev) =>
      prev.includes(id) ? prev.filter((i) => i !== id) : [...prev, id]
    );
  };

  const handleApprove = () => {
    if (selectedIds.length === 0) {
      toast.error("Selecione pelo menos um bÃ´nus");
      return;
    }
    setShowApproveDialog(true);
  };

  const handleReject = () => {
    if (selectedIds.length === 0) {
      toast.error("Selecione pelo menos um bÃ´nus");
      return;
    }
    setShowRejectDialog(true);
  };

  const confirmApprove = () => {
    approveBatch.mutate({
      calculationIds: selectedIds,
      comment: comment || undefined,
    });
  };

  const confirmReject = () => {
    if (!rejectReason.trim()) {
      toast.error("Informe o motivo da rejeiÃ§Ã£o");
      return;
    }
    rejectBatch.mutate({
      calculationIds: selectedIds,
      reason: rejectReason,
    });
  };

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-2">
          <CheckSquare className="w-8 h-8 text-green-600" />
          AprovaÃ§Ã£o em Lote de BÃ´nus
        </h1>
        <p className="text-gray-500 mt-1">
          Aprove ou rejeite mÃºltiplos bÃ´nus simultaneamente
        </p>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">BÃ´nus Selecionados</p>
                <p className="text-3xl font-bold text-blue-600">{totalSelected}</p>
              </div>
              <Users className="w-10 h-10 text-blue-600 opacity-20" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Valor Total Selecionado</p>
                <p className="text-3xl font-bold text-green-600">
                  R$ {(totalValue / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}
                </p>
              </div>
              <DollarSign className="w-10 h-10 text-green-600 opacity-20" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">DisponÃ­veis para AprovaÃ§Ã£o</p>
                <p className="text-3xl font-bold text-purple-600">
                  {filteredCalculations?.length || 0}
                </p>
              </div>
              <TrendingUp className="w-10 h-10 text-purple-600 opacity-20" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Filtros */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Filter className="w-5 h-5" />
            Filtros
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label className="text-sm font-medium mb-2 block">Departamento</label>
              <Select
                value={filterDepartment?.toString() || "all"}
                onValueChange={(v) => setFilterDepartment(v === "all" ? null : Number(v))}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Todos" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os departamentos</SelectItem>
                  {departments?.map((dept: any) => (
                    <SelectItem key={dept.id} value={dept.id.toString()}>
                      {dept.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">MÃªs de ReferÃªncia</label>
              <Input
                type="month"
                value={filterMonth}
                onChange={(e) => setFilterMonth(e.target.value)}
                placeholder="YYYY-MM"
              />
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">Valor MÃ­nimo (R$)</label>
              <Input
                type="number"
                value={filterMinValue}
                onChange={(e) => setFilterMinValue(e.target.value)}
                placeholder="0.00"
              />
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">Valor MÃ¡ximo (R$)</label>
              <Input
                type="number"
                value={filterMaxValue}
                onChange={(e) => setFilterMaxValue(e.target.value)}
                placeholder="999999.00"
              />
            </div>
          </div>

          <div className="mt-4 flex gap-2">
            <Button
              variant="outline"
              onClick={() => {
                setFilterDepartment(null);
                setFilterMonth("");
                setFilterMinValue("");
                setFilterMaxValue("");
              }}
            >
              Limpar Filtros
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* AÃ§Ãµes em Lote */}
      <div className="flex gap-2">
        <Button
          onClick={handleApprove}
          disabled={selectedIds.length === 0}
          className="gap-2"
        >
          <CheckSquare className="w-4 h-4" />
          Aprovar Selecionados ({selectedIds.length})
        </Button>
        <Button
          onClick={handleReject}
          disabled={selectedIds.length === 0}
          variant="destructive"
          className="gap-2"
        >
          <XSquare className="w-4 h-4" />
          Rejeitar Selecionados ({selectedIds.length})
        </Button>
      </div>

      {/* Tabela */}
      <Card>
        <CardHeader>
          <CardTitle>BÃ´nus Pendentes de AprovaÃ§Ã£o</CardTitle>
          <CardDescription>
            {filteredCalculations?.length || 0} bÃ´nus encontrados
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-12">
                  <Checkbox
                    checked={
                      filteredCalculations?.length > 0 &&
                      selectedIds.length === filteredCalculations?.length
                    }
                    onCheckedChange={handleToggleAll}
                  />
                </TableHead>
                <TableHead>Colaborador</TableHead>
                <TableHead>PolÃ­tica</TableHead>
                <TableHead>MÃªs Ref.</TableHead>
                <TableHead className="text-right">Valor</TableHead>
                <TableHead>Multiplicador</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {filteredCalculations && filteredCalculations.length > 0 ? (
                filteredCalculations.map((calc: any) => (
                  <TableRow key={calc.id}>
                    <TableCell>
                      <Checkbox
                        checked={selectedIds.includes(calc.id)}
                        onCheckedChange={() => handleToggle(calc.id)}
                      />
                    </TableCell>
                    <TableCell className="font-medium">
                      {calc.employeeName || `Func. #${calc.employeeId}`}
                    </TableCell>
                    <TableCell>{calc.policyName || "N/A"}</TableCell>
                    <TableCell>{calc.referenceMonth}</TableCell>
                    <TableCell className="text-right font-semibold text-green-600">
                      R${" "}
                      {(Number(calc.bonusAmount) / 100).toLocaleString("pt-BR", {
                        minimumFractionDigits: 2,
                      })}
                    </TableCell>
                    <TableCell>{Number(calc.multiplier).toFixed(2)}x</TableCell>
                  </TableRow>
                ))
              ) : (
                <TableRow>
                  <TableCell colSpan={6} className="text-center text-gray-500 py-8">
                    Nenhum bÃ´nus pendente de aprovaÃ§Ã£o
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* Dialog de AprovaÃ§Ã£o */}
      <Dialog open={showApproveDialog} onOpenChange={setShowApproveDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Confirmar AprovaÃ§Ã£o em Lote</DialogTitle>
            <DialogDescription>
              VocÃª estÃ¡ prestes a aprovar {selectedIds.length} bÃ´nus totalizando R${" "}
              {(totalValue / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <label className="text-sm font-medium mb-2 block">
                ComentÃ¡rio (opcional)
              </label>
              <Textarea
                value={comment}
                onChange={(e) => setComment(e.target.value)}
                placeholder="Adicione um comentÃ¡rio sobre esta aprovaÃ§Ã£o..."
                rows={3}
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowApproveDialog(false)}>
              Cancelar
            </Button>
            <Button onClick={confirmApprove} disabled={approveBatch.isPending}>
              {approveBatch.isPending ? "Aprovando..." : "Confirmar AprovaÃ§Ã£o"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Dialog de RejeiÃ§Ã£o */}
      <Dialog open={showRejectDialog} onOpenChange={setShowRejectDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Confirmar RejeiÃ§Ã£o em Lote</DialogTitle>
            <DialogDescription>
              VocÃª estÃ¡ prestes a rejeitar {selectedIds.length} bÃ´nus. Esta aÃ§Ã£o pode ser
              revertida posteriormente.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <label className="text-sm font-medium mb-2 block">
                Motivo da RejeiÃ§Ã£o *
              </label>
              <Textarea
                value={rejectReason}
                onChange={(e) => setRejectReason(e.target.value)}
                placeholder="Explique o motivo da rejeiÃ§Ã£o..."
                rows={3}
                required
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowRejectDialog(false)}>
              Cancelar
            </Button>
            <Button
              variant="destructive"
              onClick={confirmReject}
              disabled={rejectBatch.isPending}
            >
              {rejectBatch.isPending ? "Rejeitando..." : "Confirmar RejeiÃ§Ã£o"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/pages/BonusAuditoria.tsx
========================================
import { useState } from "react";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { FileSearch, Download, Filter, Clock, User, FileText } from "lucide-react";
import { toast } from "sonner";
import ExcelJS from "exceljs";

export default function BonusAuditoria() {
  const [filterEntityType, setFilterEntityType] = useState<string>("all");
  const [filterAction, setFilterAction] = useState<string>("all");

  // Query
  const { data: auditLogs, isLoading } = trpc.bonus.getAuditLogs.useQuery({
    entityType: filterEntityType === "all" ? undefined : (filterEntityType as any),
    action: filterAction === "all" ? undefined : (filterAction as any),
    limit: 200,
  });

  const { data: metrics } = trpc.bonus.getApprovalMetrics.useQuery();

  const handleExportToExcel = async () => {
    try {
      if (!auditLogs || auditLogs.length === 0) {
        toast.error("Nenhum dado para exportar");
        return;
      }

      const workbook = new ExcelJS.Workbook();
      const worksheet = workbook.addWorksheet("HistÃ³rico de Auditoria");

      // CabeÃ§alhos
      worksheet.columns = [
        { header: "ID", key: "id", width: 10 },
        { header: "Data/Hora", key: "createdAt", width: 20 },
        { header: "Tipo", key: "entityType", width: 15 },
        { header: "ID Entidade", key: "entityId", width: 12 },
        { header: "AÃ§Ã£o", key: "action", width: 15 },
        { header: "UsuÃ¡rio", key: "userName", width: 25 },
        { header: "Campo", key: "fieldName", width: 20 },
        { header: "Valor Anterior", key: "oldValue", width: 20 },
        { header: "Valor Novo", key: "newValue", width: 20 },
        { header: "ComentÃ¡rio", key: "comment", width: 40 },
      ];

      // Estilizar cabeÃ§alho
      worksheet.getRow(1).font = { bold: true, color: { argb: "FFFFFFFF" } };
      worksheet.getRow(1).fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "FF4F46E5" },
      };

      // Adicionar dados
      auditLogs.forEach((log: any) => {
        worksheet.addRow({
          id: log.id,
          createdAt: new Date(log.createdAt).toLocaleString("pt-BR"),
          entityType: log.entityType === "policy" ? "PolÃ­tica" : "CÃ¡lculo",
          entityId: log.entityId,
          action: getActionLabel(log.action),
          userName: log.userName || "Sistema",
          fieldName: log.fieldName || "-",
          oldValue: log.oldValue || "-",
          newValue: log.newValue || "-",
          comment: log.comment || "-",
        });
      });

      // Adicionar bordas
      worksheet.eachRow((row, rowNumber) => {
        row.eachCell((cell) => {
          cell.border = {
            top: { style: "thin" },
            left: { style: "thin" },
            bottom: { style: "thin" },
            right: { style: "thin" },
          };
        });
      });

      // Gerar arquivo
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `auditoria-bonus-${new Date().toISOString().split("T")[0]}.xlsx`;
      link.click();
      window.URL.revokeObjectURL(url);

      toast.success("HistÃ³rico exportado com sucesso!");
    } catch (error) {
      console.error("Erro ao exportar:", error);
      toast.error("Erro ao exportar histÃ³rico");
    }
  };

  const getActionLabel = (action: string) => {
    const labels: Record<string, string> = {
      created: "Criado",
      updated: "Atualizado",
      deleted: "ExcluÃ­do",
      approved: "Aprovado",
      rejected: "Rejeitado",
      paid: "Pago",
    };
    return labels[action] || action;
  };

  const getActionColor = (action: string) => {
    const colors: Record<string, string> = {
      created: "bg-blue-100 text-blue-800",
      updated: "bg-yellow-100 text-yellow-800",
      deleted: "bg-red-100 text-red-800",
      approved: "bg-green-100 text-green-800",
      rejected: "bg-orange-100 text-orange-800",
      paid: "bg-purple-100 text-purple-800",
    };
    return colors[action] || "bg-gray-100 text-gray-800";
  };

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-2">
            <FileSearch className="w-8 h-8 text-indigo-600" />
            HistÃ³rico de Auditoria
          </h1>
          <p className="text-gray-500 mt-1">
            Rastreamento completo de todas as alteraÃ§Ãµes em polÃ­ticas e cÃ¡lculos de bÃ´nus
          </p>
        </div>
        <Button onClick={handleExportToExcel} className="gap-2">
          <Download className="w-4 h-4" />
          Exportar para Excel
        </Button>
      </div>

      {/* MÃ©tricas */}
      {metrics && (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Total de AprovaÃ§Ãµes</p>
                  <p className="text-3xl font-bold text-green-600">{metrics.totalApprovals}</p>
                </div>
                <FileText className="w-10 h-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Total de RejeiÃ§Ãµes</p>
                  <p className="text-3xl font-bold text-red-600">{metrics.totalRejections}</p>
                </div>
                <FileText className="w-10 h-10 text-red-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Taxa de AprovaÃ§Ã£o</p>
                  <p className="text-3xl font-bold text-blue-600">{metrics.approvalRate}%</p>
                </div>
                <FileText className="w-10 h-10 text-blue-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Tempo MÃ©dio (horas)</p>
                  <p className="text-3xl font-bold text-purple-600">
                    {metrics.avgApprovalTimeHours}h
                  </p>
                </div>
                <Clock className="w-10 h-10 text-purple-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Filtros */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Filter className="w-5 h-5" />
            Filtros
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label className="text-sm font-medium mb-2 block">Tipo de Entidade</label>
              <Select value={filterEntityType} onValueChange={setFilterEntityType}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos</SelectItem>
                  <SelectItem value="policy">PolÃ­ticas</SelectItem>
                  <SelectItem value="calculation">CÃ¡lculos</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <label className="text-sm font-medium mb-2 block">AÃ§Ã£o</label>
              <Select value={filterAction} onValueChange={setFilterAction}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todas</SelectItem>
                  <SelectItem value="created">Criado</SelectItem>
                  <SelectItem value="updated">Atualizado</SelectItem>
                  <SelectItem value="deleted">ExcluÃ­do</SelectItem>
                  <SelectItem value="approved">Aprovado</SelectItem>
                  <SelectItem value="rejected">Rejeitado</SelectItem>
                  <SelectItem value="paid">Pago</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="flex items-end">
              <Button
                variant="outline"
                onClick={() => {
                  setFilterEntityType("all");
                  setFilterAction("all");
                }}
                className="w-full"
              >
                Limpar Filtros
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Tabela de Auditoria */}
      <Card>
        <CardHeader>
          <CardTitle>Registros de Auditoria</CardTitle>
          <CardDescription>
            {auditLogs?.length || 0} registros encontrados (Ãºltimos 200)
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Data/Hora</TableHead>
                  <TableHead>Tipo</TableHead>
                  <TableHead>ID</TableHead>
                  <TableHead>AÃ§Ã£o</TableHead>
                  <TableHead>UsuÃ¡rio</TableHead>
                  <TableHead>Detalhes</TableHead>
                  <TableHead>ComentÃ¡rio</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {isLoading ? (
                  <TableRow>
                    <TableCell colSpan={7} className="text-center py-8">
                      Carregando...
                    </TableCell>
                  </TableRow>
                ) : auditLogs && auditLogs.length > 0 ? (
                  auditLogs.map((log: any) => (
                    <TableRow key={log.id}>
                      <TableCell className="text-sm">
                        {new Date(log.createdAt).toLocaleString("pt-BR")}
                      </TableCell>
                      <TableCell>
                        <Badge variant="outline">
                          {log.entityType === "policy" ? "PolÃ­tica" : "CÃ¡lculo"}
                        </Badge>
                      </TableCell>
                      <TableCell className="font-mono text-sm">#{log.entityId}</TableCell>
                      <TableCell>
                        <Badge className={getActionColor(log.action)}>
                          {getActionLabel(log.action)}
                        </Badge>
                      </TableCell>
                      <TableCell className="flex items-center gap-2">
                        <User className="w-4 h-4 text-gray-400" />
                        {log.userName || "Sistema"}
                      </TableCell>
                      <TableCell className="text-sm">
                        {log.fieldName ? (
                          <div className="space-y-1">
                            <div className="font-medium">{log.fieldName}</div>
                            {log.oldValue && (
                              <div className="text-red-600">
                                Antes: {log.oldValue.substring(0, 30)}
                                {log.oldValue.length > 30 && "..."}
                              </div>
                            )}
                            {log.newValue && (
                              <div className="text-green-600">
                                Depois: {log.newValue.substring(0, 30)}
                                {log.newValue.length > 30 && "..."}
                              </div>
                            )}
                          </div>
                        ) : (
                          <span className="text-gray-400">-</span>
                        )}
                      </TableCell>
                      <TableCell className="max-w-xs truncate text-sm">
                        {log.comment || "-"}
                      </TableCell>
                    </TableRow>
                  ))
                ) : (
                  <TableRow>
                    <TableCell colSpan={7} className="text-center text-gray-500 py-8">
                      Nenhum registro de auditoria encontrado
                    </TableCell>
                  </TableRow>
                )}
              </TableBody>
            </Table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}


========================================
ARQUIVO: ./client/src/utils/exportExcel.ts
========================================
import ExcelJS from 'exceljs';

interface GoalSummary {
  id: number;
  title: string;
  category: string;
  status: string;
  progress: number;
  targetValue: number;
  currentValue: number;
  startDate: string;
  endDate: string;
  employeeName: string;
  department: string;
}

export async function exportGoalsToExcel(goals: GoalSummary[]) {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Metas SMART');
  
  // Configurar colunas
  worksheet.columns = [
    { header: 'ID', key: 'id', width: 10 },
    { header: 'TÃ­tulo', key: 'title', width: 40 },
    { header: 'Colaborador', key: 'employeeName', width: 25 },
    { header: 'Departamento', key: 'department', width: 20 },
    { header: 'Categoria', key: 'category', width: 15 },
    { header: 'Status', key: 'status', width: 15 },
    { header: 'Progresso (%)', key: 'progress', width: 15 },
    { header: 'Valor Alvo', key: 'targetValue', width: 15 },
    { header: 'Valor Atual', key: 'currentValue', width: 15 },
    { header: 'Data InÃ­cio', key: 'startDate', width: 15 },
    { header: 'Data TÃ©rmino', key: 'endDate', width: 15 },
  ];
  
  // Estilizar cabeÃ§alho
  worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
  worksheet.getRow(1).fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FFF39200' }, // Laranja UISA
  };
  worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };
  worksheet.getRow(1).height = 25;
  
  // Adicionar dados
  goals.forEach(goal => {
    worksheet.addRow({
      id: goal.id,
      title: goal.title,
      employeeName: goal.employeeName,
      department: goal.department,
      category: goal.category,
      status: goal.status,
      progress: goal.progress,
      targetValue: goal.targetValue,
      currentValue: goal.currentValue,
      startDate: new Date(goal.startDate).toLocaleDateString('pt-BR'),
      endDate: new Date(goal.endDate).toLocaleDateString('pt-BR'),
    });
  });
  
  // Estilizar cÃ©lulas de dados
  worksheet.eachRow((row, rowNumber) => {
    if (rowNumber > 1) {
      row.eachCell((cell) => {
        cell.border = {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' },
        };
      });
      
      // Colorir progresso
      const progressCell = row.getCell('progress');
      const progress = progressCell.value as number;
      if (progress >= 80) {
        progressCell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FF90EE90' }, // Verde claro
        };
      } else if (progress >= 50) {
        progressCell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFFFD700' }, // Amarelo
        };
      } else {
        progressCell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFFFA07A' }, // Vermelho claro
        };
      }
    }
  });
  
  // Adicionar filtros
  worksheet.autoFilter = {
    from: 'A1',
    to: 'K1',
  };
  
  // Gerar arquivo
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `Relatorio_Metas_${new Date().toISOString().split('T')[0]}.xlsx`;
  link.click();
  window.URL.revokeObjectURL(url);
}

interface Evaluation360Summary {
  id: number;
  employeeName: string;
  department: string;
  cycleYear: number;
  status: string;
  selfScore?: number;
  managerScore?: number;
  peersScore?: number;
  subordinatesScore?: number;
  finalScore?: number;
  createdAt: string;
}

export async function exportEvaluations360ToExcel(evaluations: Evaluation360Summary[]) {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('AvaliaÃ§Ãµes 360Â°');
  
  // Configurar colunas
  worksheet.columns = [
    { header: 'ID', key: 'id', width: 10 },
    { header: 'Colaborador', key: 'employeeName', width: 25 },
    { header: 'Departamento', key: 'department', width: 20 },
    { header: 'Ciclo', key: 'cycleYear', width: 10 },
    { header: 'Status', key: 'status', width: 15 },
    { header: 'AutoavaliaÃ§Ã£o', key: 'selfScore', width: 15 },
    { header: 'Gestor', key: 'managerScore', width: 15 },
    { header: 'Pares', key: 'peersScore', width: 15 },
    { header: 'Subordinados', key: 'subordinatesScore', width: 15 },
    { header: 'Nota Final', key: 'finalScore', width: 15 },
    { header: 'Data CriaÃ§Ã£o', key: 'createdAt', width: 15 },
  ];
  
  // Estilizar cabeÃ§alho
  worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
  worksheet.getRow(1).fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FFF39200' },
  };
  worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };
  worksheet.getRow(1).height = 25;
  
  // Adicionar dados
  evaluations.forEach(evaluation => {
    worksheet.addRow({
      id: evaluation.id,
      employeeName: evaluation.employeeName,
      department: evaluation.department,
      cycleYear: evaluation.cycleYear,
      status: evaluation.status,
      selfScore: evaluation.selfScore?.toFixed(2) || '-',
      managerScore: evaluation.managerScore?.toFixed(2) || '-',
      peersScore: evaluation.peersScore?.toFixed(2) || '-',
      subordinatesScore: evaluation.subordinatesScore?.toFixed(2) || '-',
      finalScore: evaluation.finalScore?.toFixed(2) || '-',
      createdAt: new Date(evaluation.createdAt).toLocaleDateString('pt-BR'),
    });
  });
  
  // Estilizar cÃ©lulas
  worksheet.eachRow((row, rowNumber) => {
    if (rowNumber > 1) {
      row.eachCell((cell) => {
        cell.border = {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' },
        };
      });
    }
  });
  
  // Adicionar filtros
  worksheet.autoFilter = {
    from: 'A1',
    to: 'K1',
  };
  
  // Gerar arquivo
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `Relatorio_Avaliacoes360_${new Date().toISOString().split('T')[0]}.xlsx`;
  link.click();
  window.URL.revokeObjectURL(url);
}


========================================
ARQUIVO: ./client/src/utils/exportGoalPDF.ts
========================================
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';

interface GoalData {
  id: number;
  title: string;
  description: string;
  category: string;
  status: string;
  progress: number;
  targetValue: number;
  currentValue: number;
  unit: string;
  weight: number;
  startDate: string;
  endDate: string;
  smartScore: number;
  bonusPercentage?: number;
  bonusAmount?: number;
  milestones?: Array<{
    title: string;
    description: string;
    dueDate: string;
    status: string;
    progress: number;
  }>;
  comments?: Array<{
    employeeName: string;
    comment: string;
    createdAt: string;
  }>;
}

export function exportGoalToPDF(goal: GoalData, employeeName: string) {
  const doc = new jsPDF();
  
  // CabeÃ§alho
  doc.setFontSize(20);
  doc.setTextColor(243, 146, 0); // Laranja UISA
  doc.text('Sistema AVD UISA', 105, 15, { align: 'center' });
  
  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text('RelatÃ³rio de Meta SMART', 105, 25, { align: 'center' });
  
  // Linha separadora
  doc.setDrawColor(243, 146, 0);
  doc.setLineWidth(0.5);
  doc.line(20, 30, 190, 30);
  
  // InformaÃ§Ãµes bÃ¡sicas
  doc.setFontSize(12);
  doc.text(`Colaborador: ${employeeName}`, 20, 40);
  doc.text(`Data de GeraÃ§Ã£o: ${new Date().toLocaleDateString('pt-BR')}`, 20, 47);
  
  // TÃ­tulo da meta
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.text(goal.title, 20, 57);
  doc.setFont('helvetica', 'normal');
  
  // Categoria e Status
  doc.setFontSize(10);
  doc.text(`Categoria: ${goal.category}`, 20, 64);
  doc.text(`Status: ${goal.status}`, 20, 70);
  doc.text(`Progresso: ${goal.progress}%`, 20, 76);
  
  // DescriÃ§Ã£o
  doc.setFontSize(11);
  doc.setFont('helvetica', 'bold');
  doc.text('DescriÃ§Ã£o:', 20, 86);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  const descLines = doc.splitTextToSize(goal.description, 170);
  doc.text(descLines, 20, 92);
  
  let yPos = 92 + (descLines.length * 5) + 5;
  
  // Tabela de MÃ©tricas
  autoTable(doc, {
    startY: yPos,
    head: [['MÃ©trica', 'Valor']],
    body: [
      ['Unidade de Medida', goal.unit],
      ['Valor Alvo', goal.targetValue.toString()],
      ['Valor Atual', goal.currentValue.toString()],
      ['Peso', `${goal.weight}%`],
      ['Data de InÃ­cio', new Date(goal.startDate).toLocaleDateString('pt-BR')],
      ['Data de TÃ©rmino', new Date(goal.endDate).toLocaleDateString('pt-BR')],
      ['ValidaÃ§Ã£o SMART', `${goal.smartScore}/100`],
    ],
    theme: 'grid',
    headStyles: { fillColor: [243, 146, 0] },
  });
  
  yPos = (doc as any).lastAutoTable.finalY + 10;
  
  // InformaÃ§Ãµes de BÃ´nus
  if (goal.bonusPercentage || goal.bonusAmount) {
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('InformaÃ§Ãµes de BÃ´nus:', 20, yPos);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    yPos += 7;
    
    if (goal.bonusPercentage) {
      doc.text(`BÃ´nus Percentual: ${goal.bonusPercentage}%`, 20, yPos);
      yPos += 6;
    }
    if (goal.bonusAmount) {
      doc.text(`BÃ´nus Fixo: R$ ${(goal.bonusAmount / 100).toFixed(2)}`, 20, yPos);
      yPos += 6;
    }
    yPos += 5;
  }
  
  // Marcos IntermediÃ¡rios
  if (goal.milestones && goal.milestones.length > 0) {
    if (yPos > 250) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Marcos IntermediÃ¡rios:', 20, yPos);
    yPos += 7;
    
    const milestoneData = goal.milestones.map(m => [
      m.title,
      m.status,
      `${m.progress}%`,
      new Date(m.dueDate).toLocaleDateString('pt-BR'),
    ]);
    
    autoTable(doc, {
      startY: yPos,
      head: [['Marco', 'Status', 'Progresso', 'Prazo']],
      body: milestoneData,
      theme: 'grid',
      headStyles: { fillColor: [243, 146, 0] },
    });
    
    yPos = (doc as any).lastAutoTable.finalY + 10;
  }
  
  // ComentÃ¡rios
  if (goal.comments && goal.comments.length > 0) {
    if (yPos > 220) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('ComentÃ¡rios:', 20, yPos);
    yPos += 7;
    
    const commentData = goal.comments.map(c => [
      c.employeeName,
      c.comment,
      new Date(c.createdAt).toLocaleDateString('pt-BR'),
    ]);
    
    autoTable(doc, {
      startY: yPos,
      head: [['Colaborador', 'ComentÃ¡rio', 'Data']],
      body: commentData,
      theme: 'grid',
      headStyles: { fillColor: [243, 146, 0] },
      columnStyles: {
        1: { cellWidth: 100 },
      },
    });
  }
  
  // RodapÃ©
  const pageCount = (doc as any).internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text(
      `Sistema AVD UISA - PÃ¡gina ${i} de ${pageCount}`,
      105,
      290,
      { align: 'center' }
    );
  }
  
  // Salvar PDF
  const fileName = `Meta_${goal.id}_${goal.title.replace(/\s+/g, '_')}.pdf`;
  doc.save(fileName);
}


========================================
ARQUIVO: ./client/src/utils/pdfExport.ts
========================================
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";

/**
 * Export dashboard statistics to PDF
 */
export function exportDashboardPDF(data: {
  userName: string;
  activeGoals: number;
  evaluations: number;
  activePDIs: number;
  currentCycle: string;
}) {
  const doc = new jsPDF();

  // Header
  doc.setFontSize(20);
  doc.setTextColor(40, 40, 40);
  doc.text("Sistema AVD UISA", 20, 20);

  doc.setFontSize(16);
  doc.text("Dashboard - Resumo Executivo", 20, 30);

  // User info
  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`Colaborador: ${data.userName}`, 20, 40);
  doc.text(`Data: ${new Date().toLocaleDateString("pt-BR")}`, 20, 47);

  // Statistics
  doc.setFontSize(14);
  doc.setTextColor(40, 40, 40);
  doc.text("EstatÃ­sticas", 20, 60);

  const stats = [
    ["MÃ©trica", "Valor"],
    ["Metas Ativas", data.activeGoals.toString()],
    ["AvaliaÃ§Ãµes", data.evaluations.toString()],
    ["PDIs Ativos", data.activePDIs.toString()],
    ["Ciclo Atual", data.currentCycle || "Nenhum"],
  ];

  autoTable(doc, {
    startY: 65,
    head: [stats[0]],
    body: stats.slice(1),
    theme: "grid",
    headStyles: { fillColor: [59, 130, 246] },
  });

  // Footer
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(10);
    doc.setTextColor(150, 150, 150);
    doc.text(
      `PÃ¡gina ${i} de ${pageCount}`,
      doc.internal.pageSize.getWidth() / 2,
      doc.internal.pageSize.getHeight() - 10,
      { align: "center" }
    );
  }

  // Save
  doc.save(`dashboard-${new Date().toISOString().split("T")[0]}.pdf`);
}

/**
 * Export 9-Box matrix to PDF
 */
export function exportNineBoxPDF(data: {
  employees: Array<{
    name: string;
    performance: number;
    potential: number;
    position: string;
    department: string;
  }>;
  department?: string;
}) {
  const doc = new jsPDF("landscape");

  // Header
  doc.setFontSize(20);
  doc.text("Matriz 9-Box - GestÃ£o de Talentos", 20, 20);

  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  if (data.department) {
    doc.text(`Departamento: ${data.department}`, 20, 30);
  }
  doc.text(`Data: ${new Date().toLocaleDateString("pt-BR")}`, 20, 37);

  // Employee table
  const tableData = data.employees.map((emp) => [
    emp.name,
    emp.department,
    emp.position,
    emp.performance.toFixed(1),
    emp.potential.toFixed(1),
    getBoxPosition(emp.performance, emp.potential),
  ]);

  autoTable(doc, {
    startY: 45,
    head: [["Nome", "Departamento", "Cargo", "Desempenho", "Potencial", "PosiÃ§Ã£o"]],
    body: tableData,
    theme: "grid",
    headStyles: { fillColor: [59, 130, 246] },
    columnStyles: {
      3: { halign: "center" },
      4: { halign: "center" },
      5: { halign: "center" },
    },
  });

  // Legend
  const finalY = (doc as any).lastAutoTable.finalY || 45;
  doc.setFontSize(12);
  doc.text("Legenda:", 20, finalY + 15);

  const legend = [
    ["PosiÃ§Ã£o", "DescriÃ§Ã£o"],
    ["Alto Potencial", "Desempenho e potencial altos (>7)"],
    ["Talento Chave", "Desempenho alto, potencial mÃ©dio"],
    ["Desempenho SÃ³lido", "Desempenho mÃ©dio, potencial variÃ¡vel"],
    ["Em Desenvolvimento", "Desempenho ou potencial baixos (<5)"],
  ];

  autoTable(doc, {
    startY: finalY + 20,
    head: [legend[0]],
    body: legend.slice(1),
    theme: "plain",
    styles: { fontSize: 10 },
  });

  doc.save(`9box-${new Date().toISOString().split("T")[0]}.pdf`);
}

/**
 * Export goals report to PDF
 */
export function exportGoalsPDF(data: {
  goals: Array<{
    title: string;
    category: string;
    weight: number;
    progress: number;
    status: string;
    deadline: Date;
  }>;
  employeeName: string;
  cycle: string;
}) {
  const doc = new jsPDF();

  // Header
  doc.setFontSize(20);
  doc.text("RelatÃ³rio de Metas", 20, 20);

  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`Colaborador: ${data.employeeName}`, 20, 30);
  doc.text(`Ciclo: ${data.cycle}`, 20, 37);
  doc.text(`Data: ${new Date().toLocaleDateString("pt-BR")}`, 20, 44);

  // Goals table
  const tableData = data.goals.map((goal) => [
    goal.title,
    goal.category,
    `${goal.weight}%`,
    `${goal.progress}%`,
    goal.status,
    new Date(goal.deadline).toLocaleDateString("pt-BR"),
  ]);

  autoTable(doc, {
    startY: 50,
    head: [["Meta", "Categoria", "Peso", "Progresso", "Status", "Prazo"]],
    body: tableData,
    theme: "grid",
    headStyles: { fillColor: [59, 130, 246] },
    columnStyles: {
      2: { halign: "center" },
      3: { halign: "center" },
      4: { halign: "center" },
    },
  });

  // Summary
  const finalY = (doc as any).lastAutoTable.finalY || 50;
  const totalWeight = data.goals.reduce((sum, g) => sum + g.weight, 0);
  const avgProgress =
    data.goals.reduce((sum, g) => sum + g.progress, 0) / data.goals.length;

  doc.setFontSize(12);
  doc.text("Resumo:", 20, finalY + 15);

  const summary = [
    ["MÃ©trica", "Valor"],
    ["Total de Metas", data.goals.length.toString()],
    ["Peso Total", `${totalWeight}%`],
    ["Progresso MÃ©dio", `${avgProgress.toFixed(1)}%`],
    [
      "Metas ConcluÃ­das",
      data.goals.filter((g) => g.status === "concluida").length.toString(),
    ],
    [
      "Metas Em Andamento",
      data.goals.filter((g) => g.status === "em_andamento").length.toString(),
    ],
  ];

  autoTable(doc, {
    startY: finalY + 20,
    head: [summary[0]],
    body: summary.slice(1),
    theme: "plain",
    styles: { fontSize: 10 },
  });

  doc.save(`metas-${new Date().toISOString().split("T")[0]}.pdf`);
}

/**
 * Export evaluations report to PDF
 */
export function exportEvaluationsPDF(data: {
  evaluations: Array<{
    employeeName: string;
    type: string;
    finalScore: number;
    status: string;
    completedAt: Date | null;
  }>;
  cycle: string;
  department?: string;
}) {
  const doc = new jsPDF();

  // Header
  doc.setFontSize(20);
  doc.text("RelatÃ³rio de AvaliaÃ§Ãµes 360Â°", 20, 20);

  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`Ciclo: ${data.cycle}`, 20, 30);
  if (data.department) {
    doc.text(`Departamento: ${data.department}`, 20, 37);
  }
  doc.text(`Data: ${new Date().toLocaleDateString("pt-BR")}`, 20, 44);

  // Evaluations table
  const tableData = data.evaluations.map((ev) => [
    ev.employeeName,
    ev.type,
    ev.finalScore?.toFixed(1) || "-",
    ev.status,
    ev.completedAt ? new Date(ev.completedAt).toLocaleDateString("pt-BR") : "-",
  ]);

  autoTable(doc, {
    startY: 50,
    head: [["Colaborador", "Tipo", "Nota Final", "Status", "ConcluÃ­da em"]],
    body: tableData,
    theme: "grid",
    headStyles: { fillColor: [59, 130, 246] },
    columnStyles: {
      2: { halign: "center" },
      3: { halign: "center" },
    },
  });

  // Summary
  const finalY = (doc as any).lastAutoTable.finalY || 50;
  const completedEvals = data.evaluations.filter((e) => e.status === "concluida");
  const avgScore =
    completedEvals.reduce((sum, e) => sum + (e.finalScore || 0), 0) /
    (completedEvals.length || 1);

  doc.setFontSize(12);
  doc.text("Resumo:", 20, finalY + 15);

  const summary = [
    ["MÃ©trica", "Valor"],
    ["Total de AvaliaÃ§Ãµes", data.evaluations.length.toString()],
    ["ConcluÃ­das", completedEvals.length.toString()],
    ["Nota MÃ©dia", avgScore.toFixed(1)],
    [
      "Taxa de ConclusÃ£o",
      `${((completedEvals.length / data.evaluations.length) * 100).toFixed(1)}%`,
    ],
  ];

  autoTable(doc, {
    startY: finalY + 20,
    head: [summary[0]],
    body: summary.slice(1),
    theme: "plain",
    styles: { fontSize: 10 },
  });

  doc.save(`avaliacoes-${new Date().toISOString().split("T")[0]}.pdf`);
}

/**
 * Helper function to determine 9-box position
 */
function getBoxPosition(performance: number, potential: number): string {
  if (performance >= 7 && potential >= 7) return "Alto Potencial";
  if (performance >= 7 && potential >= 4) return "Talento Chave";
  if (performance >= 4 && potential >= 4) return "Desempenho SÃ³lido";
  return "Em Desenvolvimento";
}

/**
 * Export relatÃ³rio executivo de RH to PDF
 */
export function exportRelatorioExecutivoPDF(data: {
  discDistribution: Array<{ name: string; value: number }>;
  profilesByDept: Array<{ name: string; profile: string; count: number }>;
  totalDepartments: number;
  totalTests: number;
  totalPositions: number;
  coverage: number;
  insights: Array<{
    title: string;
    description: string;
    recommendation: string;
    priority: string;
  }>;
}) {
  const doc = new jsPDF();

  // Header
  doc.setFontSize(20);
  doc.setTextColor(40, 40, 40);
  doc.text("RelatÃ³rio Executivo de RH", 20, 20);

  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`Sistema AVD UISA - AnÃ¡lise PsicomÃ©trica Organizacional`, 20, 30);
  doc.text(`Data: ${new Date().toLocaleDateString("pt-BR")}`, 20, 37);

  // MÃ©tricas RÃ¡pidas
  doc.setFontSize(14);
  doc.setTextColor(40, 40, 40);
  doc.text("MÃ©tricas Organizacionais", 20, 50);

  const metrics = [
    ["MÃ©trica", "Valor"],
    ["Departamentos Analisados", data.totalDepartments.toString()],
    ["Testes Realizados", data.totalTests.toString()],
    ["Cargos Mapeados", data.totalPositions.toString()],
    ["Cobertura de Testes", `${data.coverage.toFixed(0)}%`],
  ];

  autoTable(doc, {
    startY: 55,
    head: [metrics[0]],
    body: metrics.slice(1),
    theme: "grid",
    headStyles: { fillColor: [59, 130, 246] },
  });

  // DistribuiÃ§Ã£o DISC
  let currentY = (doc as any).lastAutoTable.finalY + 15;
  doc.setFontSize(14);
  doc.text("DistribuiÃ§Ã£o DISC Organizacional", 20, currentY);

  const discData = data.discDistribution.map((item) => [
    item.name,
    item.value.toFixed(1),
  ]);

  autoTable(doc, {
    startY: currentY + 5,
    head: [["DimensÃ£o", "PontuaÃ§Ã£o MÃ©dia"]],
    body: discData,
    theme: "striped",
    headStyles: { fillColor: [59, 130, 246] },
    columnStyles: {
      1: { halign: "center" },
    },
  });

  // Perfis por Departamento
  currentY = (doc as any).lastAutoTable.finalY + 15;
  doc.setFontSize(14);
  doc.text("Perfis Predominantes por Departamento", 20, currentY);

  const profilesData = data.profilesByDept.slice(0, 10).map((dept) => [
    dept.name,
    `Perfil ${dept.profile}`,
    `${dept.count} teste(s)`,
  ]);

  autoTable(doc, {
    startY: currentY + 5,
    head: [["Departamento", "Perfil", "Testes"]],
    body: profilesData,
    theme: "striped",
    headStyles: { fillColor: [59, 130, 246] },
    columnStyles: {
      2: { halign: "center" },
    },
  });

  // Nova pÃ¡gina para insights
  doc.addPage();
  doc.setFontSize(16);
  doc.text("Insights EstratÃ©gicos", 20, 20);

  currentY = 30;
  data.insights.forEach((insight, index) => {
    if (currentY > 250) {
      doc.addPage();
      currentY = 20;
    }

    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text(`${index + 1}. ${insight.title}`, 20, currentY);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    
    const descLines = doc.splitTextToSize(insight.description, 170);
    doc.text(descLines, 25, currentY + 7);
    
    currentY += 7 + descLines.length * 5;

    doc.setTextColor(59, 130, 246);
    doc.text("RecomendaÃ§Ã£o:", 25, currentY + 3);
    doc.setTextColor(40, 40, 40);
    
    const recLines = doc.splitTextToSize(insight.recommendation, 165);
    doc.text(recLines, 25, currentY + 9);

    currentY += 15 + recLines.length * 5;
  });

  // RecomendaÃ§Ãµes EstratÃ©gicas
  doc.addPage();
  doc.setFontSize(16);
  doc.text("AÃ§Ãµes EstratÃ©gicas Recomendadas", 20, 20);

  const recommendations = [
    {
      title: "1. Expandir Cobertura de Testes",
      desc: "Priorizar departamentos sem dados psicomÃ©tricos para obter visÃ£o completa da organizaÃ§Ã£o.",
    },
    {
      title: "2. Criar Equipes Multidisciplinares",
      desc: "Formar projetos com perfis complementares (D+S, I+C) para maximizar sinergia.",
    },
    {
      title: "3. Programas de Desenvolvimento Direcionados",
      desc: "Criar trilhas de capacitaÃ§Ã£o baseadas nos gaps identificados por departamento.",
    },
    {
      title: "4. Monitoramento ContÃ­nuo",
      desc: "Reaplicar testes anualmente para acompanhar evoluÃ§Ã£o dos perfis e eficÃ¡cia das aÃ§Ãµes.",
    },
    {
      title: "5. IntegraÃ§Ã£o com SucessÃ£o e Recrutamento",
      desc: "Utilizar perfis psicomÃ©tricos para identificar sucessores e definir perfis ideais para vagas.",
    },
  ];

  currentY = 30;
  recommendations.forEach((rec) => {
    if (currentY > 250) {
      doc.addPage();
      currentY = 20;
    }

    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text(rec.title, 20, currentY);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    const lines = doc.splitTextToSize(rec.desc, 170);
    doc.text(lines, 25, currentY + 6);

    currentY += 12 + lines.length * 5;
  });

  // Footer em todas as pÃ¡ginas
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(128, 128, 128);
    doc.text(
      `Sistema AVD UISA - RelatÃ³rio Executivo de RH - PÃ¡gina ${i} de ${pageCount}`,
      doc.internal.pageSize.getWidth() / 2,
      doc.internal.pageSize.getHeight() - 10,
      { align: "center" }
    );
  }

  doc.save(`relatorio-executivo-rh-${new Date().toISOString().split("T")[0]}.pdf`);
}

/**
 * Export dashboard comparativo to PDF
 */
export function exportDashboardComparativoPDF(data: {
  testType: string;
  groupBy: string;
  results: Array<{
    groupName: string;
    count: number;
    averages: any;
  }>;
}) {
  const doc = new jsPDF("landscape");

  // Header
  doc.setFontSize(20);
  doc.text("Dashboard Comparativo de Testes PsicomÃ©tricos", 20, 20);

  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`Tipo de Teste: ${data.testType.toUpperCase()}`, 20, 30);
  doc.text(`Agrupamento: ${data.groupBy}`, 20, 37);
  doc.text(`Data: ${new Date().toLocaleDateString("pt-BR")}`, 20, 44);

  // Preparar dados da tabela baseado no tipo de teste
  let tableData: any[] = [];
  let headers: string[] = [];

  if (data.testType === "disc") {
    headers = ["Grupo", "Testes", "DominÃ¢ncia", "InfluÃªncia", "Estabilidade", "Conformidade"];
    tableData = data.results.map((r) => [
      r.groupName,
      r.count.toString(),
      r.averages?.disc?.D?.toFixed(1) || "-",
      r.averages?.disc?.I?.toFixed(1) || "-",
      r.averages?.disc?.S?.toFixed(1) || "-",
      r.averages?.disc?.C?.toFixed(1) || "-",
    ]);
  } else if (data.testType === "bigfive") {
    headers = ["Grupo", "Testes", "Abertura", "Conscienciosidade", "ExtroversÃ£o", "Amabilidade", "Neuroticismo"];
    tableData = data.results.map((r) => [
      r.groupName,
      r.count.toString(),
      r.averages?.bigfive?.O?.toFixed(1) || "-",
      r.averages?.bigfive?.C?.toFixed(1) || "-",
      r.averages?.bigfive?.E?.toFixed(1) || "-",
      r.averages?.bigfive?.A?.toFixed(1) || "-",
      r.averages?.bigfive?.N?.toFixed(1) || "-",
    ]);
  }

  autoTable(doc, {
    startY: 50,
    head: [headers],
    body: tableData,
    theme: "grid",
    headStyles: { fillColor: [59, 130, 246] },
    columnStyles: {
      1: { halign: "center" },
      2: { halign: "center" },
      3: { halign: "center" },
      4: { halign: "center" },
      5: { halign: "center" },
      6: { halign: "center" },
    },
  });

  // AnÃ¡lise
  const finalY = (doc as any).lastAutoTable.finalY + 15;
  doc.setFontSize(14);
  doc.text("AnÃ¡lise Comparativa", 20, finalY);

  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  const analysisText = `Este relatÃ³rio apresenta a comparaÃ§Ã£o de perfis psicomÃ©tricos ${data.testType.toUpperCase()} agrupados por ${data.groupBy}. ` +
    `Os dados permitem identificar padrÃµes comportamentais predominantes em cada grupo e orientar decisÃµes estratÃ©gicas de RH.`;
  
  const lines = doc.splitTextToSize(analysisText, 260);
  doc.text(lines, 20, finalY + 7);

  // Footer
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text(
      `Sistema AVD UISA - Dashboard Comparativo - PÃ¡gina ${i} de ${pageCount}`,
      doc.internal.pageSize.getWidth() / 2,
      doc.internal.pageSize.getHeight() - 10,
      { align: "center" }
    );
  }

  doc.save(`dashboard-comparativo-${data.testType}-${new Date().toISOString().split("T")[0]}.pdf`);
}


========================================
ARQUIVO: ./drizzle.config.ts
========================================
import { defineConfig } from "drizzle-kit";

const connectionString = process.env.DATABASE_URL;
if (!connectionString) {
  throw new Error("DATABASE_URL is required to run drizzle commands");
}

export default defineConfig({
  schema: "./drizzle/schema.ts",
  out: "./drizzle",
  dialect: "mysql",
  dbCredentials: {
    url: connectionString,
  },
});


========================================
ARQUIVO: ./drizzle/relations.ts
========================================
import {} from "./schema";


========================================
ARQUIVO: ./drizzle/schema.ts
========================================
import { relations } from "drizzle-orm";
import {
  boolean,
  date,
  datetime,
  decimal,
  int,
  json,
  mysqlEnum,
  mysqlTable,
  text,
  timestamp,
  varchar,
} from "drizzle-orm/mysql-core";
import { sql } from "drizzle-orm";

/**
 * Sistema AVD UISA - Schema Completo
 * Sistema de AvaliaÃ§Ã£o de Desempenho e GestÃ£o de Talentos
 */

// ============================================================================
// TABELAS DE AUTENTICAÃ‡ÃƒO E USUÃRIOS
// ============================================================================

export const users = mysqlTable("users", {
  id: int("id").autoincrement().primaryKey(),
  openId: varchar("openId", { length: 64 }).notNull().unique(),
  name: text("name"),
  email: varchar("email", { length: 320 }),
  loginMethod: varchar("loginMethod", { length: 64 }),
  role: mysqlEnum("role", ["admin", "rh", "gestor", "colaborador"]).default("colaborador").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
  lastSignedIn: timestamp("lastSignedIn").defaultNow().notNull(),
  // Reconhecimento facial
  faceDescriptor: text("faceDescriptor"), // JSON com descritores faciais
  facePhotoUrl: varchar("facePhotoUrl", { length: 512 }),
  faceRegisteredAt: datetime("faceRegisteredAt"),
});

export type User = typeof users.$inferSelect;
export type InsertUser = typeof users.$inferInsert;

/**
 * Admin Users - UsuÃ¡rios administrativos do sistema
 */
export const adminUsers = mysqlTable("adminUsers", {
  id: int("id").autoincrement().primaryKey(),
  username: varchar("username", { length: 100 }).notNull().unique(),
  passwordHash: varchar("passwordHash", { length: 255 }).notNull(),
  email: varchar("email", { length: 320 }).notNull().unique(),
  name: varchar("name", { length: 255 }).notNull(),
  role: mysqlEnum("role", ["super_admin", "admin", "hr_manager"]).default("admin").notNull(),
  active: boolean("active").default(true).notNull(),
  lastLoginAt: datetime("lastLoginAt"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type AdminUser = typeof adminUsers.$inferSelect;
export type InsertAdminUser = typeof adminUsers.$inferInsert;

// ============================================================================
// TABELAS DE BÃ”NUS POR CARGO
// ============================================================================

export const bonusPolicies = mysqlTable("bonusPolicies", {
  id: int("id").autoincrement().primaryKey(),
  name: varchar("name", { length: 200 }).notNull(),
  description: text("description"),
  positionId: int("positionId"), // Cargo especÃ­fico ou null para todos
  departmentId: int("departmentId"), // Departamento especÃ­fico ou null
  
  // Multiplicadores
  salaryMultiplier: decimal("salaryMultiplier", { precision: 5, scale: 2 }).notNull(), // Ex: 1.5 = 150% do salÃ¡rio
  minMultiplier: decimal("minMultiplier", { precision: 5, scale: 2 }).default("0.5"), // MÃ­nimo
  maxMultiplier: decimal("maxMultiplier", { precision: 5, scale: 2 }).default("2.0"), // MÃ¡ximo
  
  // CritÃ©rios de Elegibilidade
  minPerformanceRating: mysqlEnum("minPerformanceRating", ["abaixo_expectativas", "atende_expectativas", "supera_expectativas", "excepcional"]).default("atende_expectativas"),
  minTenureMonths: int("minTenureMonths").default(6), // MÃ­nimo de meses na empresa
  requiresGoalCompletion: boolean("requiresGoalCompletion").default(true),
  minGoalCompletionRate: int("minGoalCompletionRate").default(70), // % mÃ­nimo de metas atingidas
  
  // PerÃ­odo de VigÃªncia
  validFrom: datetime("validFrom").notNull(),
  validUntil: datetime("validUntil"),
  
  // Status
  active: boolean("active").default(true).notNull(),
  approvalStatus: mysqlEnum("approvalStatus", ["pendente", "aprovado", "rejeitado"]).default("pendente").notNull(),
  approvedBy: int("approvedBy"), // ID do aprovador
  approvedAt: datetime("approvedAt"),
  
  // Metadados
  createdBy: int("createdBy").notNull(),
  createdAt: datetime("createdAt").default(sql`CURRENT_TIMESTAMP`).notNull(),
  updatedAt: datetime("updatedAt").default(sql`CURRENT_TIMESTAMP`).notNull(),
});

export type BonusPolicy = typeof bonusPolicies.$inferSelect;
export type InsertBonusPolicy = typeof bonusPolicies.$inferInsert;

// Tabela de CÃ¡lculos de BÃ´nus
export const bonusCalculations = mysqlTable("bonusCalculations", {
  id: int("id").autoincrement().primaryKey(),
  policyId: int("policyId").notNull(),
  employeeId: int("employeeId").notNull(),
  
  // Valores Calculados
  baseSalary: decimal("baseSalary", { precision: 10, scale: 2 }).notNull(),
  appliedMultiplier: decimal("appliedMultiplier", { precision: 5, scale: 2 }).notNull(),
  bonusAmount: decimal("bonusAmount", { precision: 10, scale: 2 }).notNull(),
  
  // Justificativa
  performanceScore: int("performanceScore"), // 0-100
  goalCompletionRate: int("goalCompletionRate"), // 0-100
  adjustmentReason: text("adjustmentReason"),
  
  // Status
  status: mysqlEnum("status", ["calculado", "aprovado", "pago", "cancelado"]).default("calculado").notNull(),
  approvedBy: int("approvedBy"),
  approvedAt: datetime("approvedAt"),
  paidAt: datetime("paidAt"),
  
  // Metadados
  calculatedAt: datetime("calculatedAt").default(sql`CURRENT_TIMESTAMP`).notNull(),
  referenceMonth: varchar("referenceMonth", { length: 7 }).notNull(), // YYYY-MM
});

export type BonusCalculation = typeof bonusCalculations.$inferSelect;
export type InsertBonusCalculation = typeof bonusCalculations.$inferInsert;

// Tabela de Auditoria de BÃ´nus
export const bonusAuditLogs = mysqlTable("bonusAuditLogs", {
  id: int("id").autoincrement().primaryKey(),
  entityType: mysqlEnum("entityType", ["policy", "calculation"]).notNull(),
  entityId: int("entityId").notNull(),
  action: mysqlEnum("action", ["created", "updated", "deleted", "approved", "rejected", "paid"]).notNull(),
  userId: int("userId").notNull(),
  userName: varchar("userName", { length: 200 }),
  fieldName: varchar("fieldName", { length: 100 }),
  oldValue: text("oldValue"),
  newValue: text("newValue"),
  comment: text("comment"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type BonusAuditLog = typeof bonusAuditLogs.$inferSelect;
export type InsertBonusAuditLog = typeof bonusAuditLogs.$inferInsert;

// Tabela de ComentÃ¡rios em AprovaÃ§Ãµes de BÃ´nus
export const bonusApprovalComments = mysqlTable("bonusApprovalComments", {
  id: int("id").autoincrement().primaryKey(),
  calculationId: int("calculationId").notNull(),
  userId: int("userId").notNull(),
  userName: varchar("userName", { length: 200 }),
  comment: text("comment").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type BonusApprovalComment = typeof bonusApprovalComments.$inferSelect;
export type InsertBonusApprovalComment = typeof bonusApprovalComments.$inferInsert;

export const passwordResetTokens = mysqlTable("passwordResetTokens", {
  id: int("id").autoincrement().primaryKey(),
  userId: int("userId").notNull(),
  token: varchar("token", { length: 255 }).notNull().unique(),
  expiresAt: datetime("expiresAt").notNull(),
  used: boolean("used").default(false).notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type PasswordResetToken = typeof passwordResetTokens.$inferSelect;
export type InsertPasswordResetToken = typeof passwordResetTokens.$inferInsert;

// ============================================================================
// TABELAS DE ESTRUTURA ORGANIZACIONAL
// ============================================================================

export const departments = mysqlTable("departments", {
  id: int("id").autoincrement().primaryKey(),
  code: varchar("code", { length: 50 }).notNull().unique(),
  name: varchar("name", { length: 255 }).notNull(),
  description: text("description"),
  parentId: int("parentId"), // Departamento pai (hierarquia)
  managerId: int("managerId"), // Gestor do departamento
  active: boolean("active").default(true).notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type Department = typeof departments.$inferSelect;
export type InsertDepartment = typeof departments.$inferInsert;

/**
 * Centros de Custos
 */
export const costCenters = mysqlTable("costCenters", {
  id: int("id").autoincrement().primaryKey(),
  code: varchar("code", { length: 50 }).notNull().unique(),
  name: varchar("name", { length: 255 }).notNull(),
  description: text("description"),
  departmentId: int("departmentId"), // Departamento vinculado
  budget: decimal("budget", { precision: 15, scale: 2 }), // OrÃ§amento
  active: boolean("active").default(true).notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type CostCenter = typeof costCenters.$inferSelect;
export type InsertCostCenter = typeof costCenters.$inferInsert;

export const positions = mysqlTable("positions", {
  id: int("id").autoincrement().primaryKey(),
  code: varchar("code", { length: 50 }).notNull().unique(),
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description"),
  level: mysqlEnum("level", ["junior", "pleno", "senior", "especialista", "coordenador", "gerente", "diretor"]),
  departmentId: int("departmentId"),
  salaryMin: int("salaryMin"),
  salaryMax: int("salaryMax"),
  active: boolean("active").default(true).notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type Position = typeof positions.$inferSelect;
export type InsertPosition = typeof positions.$inferInsert;

export const employees = mysqlTable("employees", {
  id: int("id").autoincrement().primaryKey(),
  userId: int("userId").unique(), // VinculaÃ§Ã£o com usuÃ¡rio do sistema
  employeeCode: varchar("employeeCode", { length: 50 }).notNull().unique(),
  name: varchar("name", { length: 255 }).notNull(),
  email: varchar("email", { length: 320 }).notNull(),
  cpf: varchar("cpf", { length: 14 }).unique(),
  birthDate: datetime("birthDate"),
  hireDate: datetime("hireDate").notNull(),
  departmentId: int("departmentId").notNull(),
  positionId: int("positionId").notNull(),
  managerId: int("managerId"), // Gestor direto
  costCenter: varchar("costCenter", { length: 100 }), // Centro de custos
  
  // InformaÃ§Ãµes financeiras e hierÃ¡rquicas
  salary: int("salary"), // SalÃ¡rio em centavos (ex: 500000 = R$ 5.000,00)
  hierarchyLevel: mysqlEnum("hierarchyLevel", [
    "diretoria",
    "gerencia",
    "coordenacao",
    "supervisao",
    "operacional"
  ]),
  
  photoUrl: varchar("photoUrl", { length: 512 }),
  phone: varchar("phone", { length: 20 }),
  address: text("address"),
  status: mysqlEnum("status", ["ativo", "afastado", "desligado"]).default("ativo").notNull(),
  // IntegraÃ§Ã£o TOTVS RM
  rmCode: varchar("rmCode", { length: 50 }),
  rmLastSync: datetime("rmLastSync"),
  // GamificaÃ§Ã£o
  gamificationPoints: int("gamificationPoints").default(0).notNull(),
  gamificationLevel: varchar("gamificationLevel", { length: 20 }).default("Bronze").notNull(),
  lastPointsUpdate: timestamp("lastPointsUpdate").defaultNow(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type Employee = typeof employees.$inferSelect;
export type InsertEmployee = typeof employees.$inferInsert;

// ============================================================================
// TABELAS DE COMPETÃŠNCIAS
// ============================================================================

export const competencies = mysqlTable("competencies", {
  id: int("id").autoincrement().primaryKey(),
  code: varchar("code", { length: 50 }).notNull().unique(),
  name: varchar("name", { length: 255 }).notNull(),
  description: text("description"),
  category: mysqlEnum("category", ["tecnica", "comportamental", "lideranca"]).notNull(),
  active: boolean("active").default(true).notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type Competency = typeof competencies.$inferSelect;
export type InsertCompetency = typeof competencies.$inferInsert;

export const competencyLevels = mysqlTable("competencyLevels", {
  id: int("id").autoincrement().primaryKey(),
  competencyId: int("competencyId").notNull(),
  level: int("level").notNull(), // 1 a 5
  name: varchar("name", { length: 100 }).notNull(),
  description: text("description"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type CompetencyLevel = typeof competencyLevels.$inferSelect;
export type InsertCompetencyLevel = typeof competencyLevels.$inferInsert;

export const positionCompetencies = mysqlTable("positionCompetencies", {
  id: int("id").autoincrement().primaryKey(),
  positionId: int("positionId").notNull(),
  competencyId: int("competencyId").notNull(),
  requiredLevel: int("requiredLevel").notNull(), // NÃ­vel exigido (1-5)
  weight: int("weight").default(1).notNull(), // Peso da competÃªncia
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type PositionCompetency = typeof positionCompetencies.$inferSelect;
export type InsertPositionCompetency = typeof positionCompetencies.$inferInsert;

export const employeeCompetencies = mysqlTable("employeeCompetencies", {
  id: int("id").autoincrement().primaryKey(),
  employeeId: int("employeeId").notNull(),
  competencyId: int("competencyId").notNull(),
  currentLevel: int("currentLevel").notNull(), // NÃ­vel atual (1-5)
  evaluatedAt: datetime("evaluatedAt").notNull(),
  evaluatedBy: int("evaluatedBy"), // ID do avaliador
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type EmployeeCompetency = typeof employeeCompetencies.$inferSelect;
export type InsertEmployeeCompetency = typeof employeeCompetencies.$inferInsert;

// ============================================================================
// TABELAS DE CICLOS DE AVALIAÃ‡ÃƒO
// ============================================================================

export const evaluationCycles = mysqlTable("evaluationCycles", {
  id: int("id").autoincrement().primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  year: int("year").notNull(),
  type: mysqlEnum("type", ["anual", "semestral", "trimestral"]).notNull(),
  startDate: datetime("startDate").notNull(),
  endDate: datetime("endDate").notNull(),
  status: mysqlEnum("status", ["planejamento", "em_andamento", "concluido", "cancelado"]).default("planejamento").notNull(),
  description: text("description"),
  // Prazos por etapa do fluxo 360Â°
  selfEvaluationDeadline: datetime("selfEvaluationDeadline"),
  managerEvaluationDeadline: datetime("managerEvaluationDeadline"),
  consensusDeadline: datetime("consensusDeadline"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type EvaluationCycle = typeof evaluationCycles.$inferSelect;
export type InsertEvaluationCycle = typeof evaluationCycles.$inferInsert;

// ============================================================================
// TABELAS DE METAS
// ============================================================================

export const goals = mysqlTable("goals", {
  id: int("id").autoincrement().primaryKey(),
  cycleId: int("cycleId").notNull(),
  employeeId: int("employeeId").notNull(),
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description"),
  type: mysqlEnum("type", ["individual", "equipe", "organizacional"]).notNull(),
  category: mysqlEnum("category", ["quantitativa", "qualitativa"]).notNull(),
  targetValue: varchar("targetValue", { length: 100 }),
  currentValue: varchar("currentValue", { length: 100 }),
  unit: varchar("unit", { length: 50 }), // unidade de medida
  weight: int("weight").default(1).notNull(), // Peso da meta
  startDate: datetime("startDate").notNull(),
  endDate: datetime("endDate").notNull(),
  status: mysqlEnum("status", ["rascunho", "pendente_aprovacao", "aprovada", "em_andamento", "concluida", "cancelada"]).default("rascunho").notNull(),
  progress: int("progress").default(0).notNull(), // Percentual 0-100
  linkedToPLR: boolean("linkedToPLR").default(false).notNull(),
  linkedToBonus: boolean("linkedToBonus").default(false).notNull(),
  parentGoalId: int("parentGoalId"), // Meta pai (para cascata hierÃ¡rquico)
  departmentId: int("departmentId"), // Departamento responsÃ¡vel
  alignmentPercentage: int("alignmentPercentage").default(0), // % de alinhamento com meta pai
  createdBy: int("createdBy").notNull(),
  approvedBy: int("approvedBy"),
  approvedAt: datetime("approvedAt"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type Goal = typeof goals.$inferSelect;
export type InsertGoal = typeof goals.$inferInsert;

export const goalUpdates = mysqlTable("goalUpdates", {
  id: int("id").autoincrement().primaryKey(),
  goalId: int("goalId").notNull(),
  progress: int("progress").notNull(),
  currentValue: varchar("currentValue", { length: 100 }),
  notes: text("notes"),
  updatedBy: int("updatedBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type GoalUpdate = typeof goalUpdates.$inferSelect;
export type InsertGoalUpdate = typeof goalUpdates.$inferInsert;

// ============================================================================
// TABELAS DE AVALIAÃ‡ÃƒO 360Â°
// ============================================================================

export const performanceEvaluations = mysqlTable("performanceEvaluations", {
  id: int("id").autoincrement().primaryKey(),
  cycleId: int("cycleId").notNull(),
  employeeId: int("employeeId").notNull(),
  type: mysqlEnum("type", ["360", "180", "90"]).notNull(),
  status: mysqlEnum("status", ["pendente", "em_andamento", "concluida"]).default("pendente").notNull(),
  
  // Workflow de etapas sequenciais
  workflowStatus: mysqlEnum("workflowStatus", [
    "pending_self",        // Aguardando autoavaliaÃ§Ã£o
    "pending_manager",     // Aguardando avaliaÃ§Ã£o do gestor
    "pending_consensus",   // Aguardando consenso do lÃ­der
    "completed"            // ConcluÃ­do
  ]).default("pending_self").notNull(),
  
  selfEvaluationCompleted: boolean("selfEvaluationCompleted").default(false).notNull(),
  managerEvaluationCompleted: boolean("managerEvaluationCompleted").default(false).notNull(),
  peersEvaluationCompleted: boolean("peersEvaluationCompleted").default(false).notNull(),
  subordinatesEvaluationCompleted: boolean("subordinatesEvaluationCompleted").default(false).notNull(),
  
  // Datas de conclusÃ£o de cada etapa
  selfCompletedAt: datetime("selfCompletedAt"),
  managerCompletedAt: datetime("managerCompletedAt"),
  consensusCompletedAt: datetime("consensusCompletedAt"),
  
  finalScore: int("finalScore"), // Nota final (0-100)
  managerComments: text("managerComments"), // ComentÃ¡rios do gestor
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
  completedAt: datetime("completedAt"),
});

export type PerformanceEvaluation = typeof performanceEvaluations.$inferSelect;
export type InsertPerformanceEvaluation = typeof performanceEvaluations.$inferInsert;

export const evaluationQuestions = mysqlTable("evaluationQuestions", {
  id: int("id").autoincrement().primaryKey(),
  code: varchar("code", { length: 50 }).notNull().unique(),
  question: text("question").notNull(),
  category: varchar("category", { length: 100 }),
  type: mysqlEnum("type", ["escala", "texto", "multipla_escolha"]).notNull(),
  options: text("options"), // JSON com opÃ§Ãµes para mÃºltipla escolha
  weight: int("weight").default(1).notNull(),
  active: boolean("active").default(true).notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type EvaluationQuestion = typeof evaluationQuestions.$inferSelect;
export type InsertEvaluationQuestion = typeof evaluationQuestions.$inferInsert;

export const evaluationResponses = mysqlTable("evaluationResponses", {
  id: int("id").autoincrement().primaryKey(),
  evaluationId: int("evaluationId").notNull(),
  questionId: int("questionId").notNull(),
  evaluatorId: int("evaluatorId").notNull(),
  evaluatorType: mysqlEnum("evaluatorType", ["self", "manager", "peer", "subordinate"]).notNull(),
  score: int("score"), // Para questÃµes de escala (1-5)
  textResponse: text("textResponse"), // Para questÃµes abertas
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type EvaluationResponse = typeof evaluationResponses.$inferSelect;
export type InsertEvaluationResponse = typeof evaluationResponses.$inferInsert;

export const calibrationSessions = mysqlTable("calibrationSessions", {
  id: int("id").autoincrement().primaryKey(),
  cycleId: int("cycleId").notNull(),
  departmentId: int("departmentId"),
  facilitatorId: int("facilitatorId").notNull(), // Quem conduziu a sessÃ£o
  status: mysqlEnum("status", ["agendada", "em_andamento", "concluida"]).default("agendada").notNull(),
  scheduledDate: datetime("scheduledDate"),
  startedAt: datetime("startedAt"),
  completedAt: datetime("completedAt"),
  notes: text("notes"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type CalibrationSession = typeof calibrationSessions.$inferSelect;
export type InsertCalibrationSession = typeof calibrationSessions.$inferInsert;

export const calibrationReviews = mysqlTable("calibrationReviews", {
  id: int("id").autoincrement().primaryKey(),
  sessionId: int("sessionId").notNull(),
  evaluationId: int("evaluationId").notNull(),
  originalScore: int("originalScore").notNull(),
  calibratedScore: int("calibratedScore").notNull(),
  reason: text("reason").notNull(),
  reviewedBy: int("reviewedBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type CalibrationReview = typeof calibrationReviews.$inferSelect;
export type InsertCalibrationReview = typeof calibrationReviews.$inferInsert;

export const calibrationMessages = mysqlTable("calibrationMessages", {
  id: int("id").autoincrement().primaryKey(),
  sessionId: int("sessionId").notNull(),
  userId: int("userId").notNull(),
  message: text("message").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type CalibrationMessage = typeof calibrationMessages.$inferSelect;
export type InsertCalibrationMessage = typeof calibrationMessages.$inferInsert;

// ============================================================================
// TABELAS DE MATRIZ 9-BOX
// ============================================================================

export const nineBoxPositions = mysqlTable("nineBoxPositions", {
  id: int("id").autoincrement().primaryKey(),
  cycleId: int("cycleId").notNull(),
  employeeId: int("employeeId").notNull(),
  performance: int("performance").notNull(), // 1-3 (baixo, mÃ©dio, alto)
  potential: int("potential").notNull(), // 1-3 (baixo, mÃ©dio, alto)
  box: varchar("box", { length: 50 }).notNull(), // ex: "alto_desempenho_alto_potencial"
  calibrated: boolean("calibrated").default(false).notNull(),
  calibratedBy: int("calibratedBy"),
  calibratedAt: datetime("calibratedAt"),
  notes: text("notes"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type NineBoxPosition = typeof nineBoxPositions.$inferSelect;
export type InsertNineBoxPosition = typeof nineBoxPositions.$inferInsert;

// ============================================================================
// TABELAS DE PDI (Plano de Desenvolvimento Individual)
// ============================================================================

export const pdiPlans = mysqlTable("pdiPlans", {
  id: int("id").autoincrement().primaryKey(),
  cycleId: int("cycleId").notNull(),
  employeeId: int("employeeId").notNull(),
  targetPositionId: int("targetPositionId"), // Cargo almejado
  status: mysqlEnum("status", ["rascunho", "pendente_aprovacao", "aprovado", "em_andamento", "concluido", "cancelado"]).default("rascunho").notNull(),
  startDate: datetime("startDate").notNull(),
  endDate: datetime("endDate").notNull(),
  overallProgress: int("overallProgress").default(0).notNull(), // Percentual 0-100
  approvedBy: int("approvedBy"),
  approvedAt: datetime("approvedAt"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
  completedAt: datetime("completedAt"),
});

export type PdiPlan = typeof pdiPlans.$inferSelect;
export type InsertPdiPlan = typeof pdiPlans.$inferInsert;

export const developmentActions = mysqlTable("developmentActions", {
  id: int("id").autoincrement().primaryKey(),
  code: varchar("code", { length: 50 }).notNull().unique(),
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description"),
  category: mysqlEnum("category", ["70_pratica", "20_mentoria", "10_curso"]).notNull(), // Modelo 70-20-10
  type: varchar("type", { length: 100 }), // ex: "projeto", "job_rotation", "curso_online"
  competencyId: int("competencyId"), // CompetÃªncia desenvolvida
  duration: int("duration"), // DuraÃ§Ã£o em horas
  provider: varchar("provider", { length: 255 }), // Fornecedor/plataforma
  url: varchar("url", { length: 512 }),
  cost: int("cost"), // Custo em centavos
  active: boolean("active").default(true).notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type DevelopmentAction = typeof developmentActions.$inferSelect;
export type InsertDevelopmentAction = typeof developmentActions.$inferInsert;

export const pdiItems = mysqlTable("pdiItems", {
  id: int("id").autoincrement().primaryKey(),
  planId: int("planId").notNull(),
  actionId: int("actionId"), // AÃ§Ã£o do catÃ¡logo (opcional)
  competencyId: int("competencyId").notNull(),
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description"),
  category: mysqlEnum("category", ["70_pratica", "20_mentoria", "10_curso"]).notNull(),
  type: varchar("type", { length: 100 }),
  startDate: datetime("startDate").notNull(),
  endDate: datetime("endDate").notNull(),
  status: mysqlEnum("status", ["pendente", "em_andamento", "concluida", "cancelada"]).default("pendente").notNull(),
  progress: int("progress").default(0).notNull(), // Percentual 0-100
  notes: text("notes"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
  completedAt: datetime("completedAt"),
});

export type PdiItem = typeof pdiItems.$inferSelect;
export type InsertPdiItem = typeof pdiItems.$inferInsert;

export const pdiProgress = mysqlTable("pdiProgress", {
  id: int("id").autoincrement().primaryKey(),
  itemId: int("itemId").notNull(),
  progress: int("progress").notNull(),
  notes: text("notes"),
  evidenceUrl: varchar("evidenceUrl", { length: 512 }), // URL de evidÃªncia (certificado, etc)
  updatedBy: int("updatedBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type PdiProgress = typeof pdiProgress.$inferSelect;
export type InsertPdiProgress = typeof pdiProgress.$inferInsert;

// ============================================================================
// TABELAS DE SUCESSÃƒO
// ============================================================================

export const successionPlans = mysqlTable("successionPlans", {
  id: int("id").autoincrement().primaryKey(),
  positionId: int("positionId").notNull(),
  currentHolderId: int("currentHolderId"), // Ocupante atual
  isCritical: boolean("isCritical").default(false).notNull(),
  riskLevel: mysqlEnum("riskLevel", ["baixo", "medio", "alto", "critico"]).default("medio").notNull(),
  status: mysqlEnum("status", ["ativo", "inativo"]).default("ativo").notNull(),
  
  // Riscos (Metodologia 9-Box Succession Planning)
  exitRisk: mysqlEnum("exitRisk", ["baixo", "medio", "alto"]).default("medio"),
  competencyGap: text("competencyGap"), // Gaps de competÃªncias identificados
  preparationTime: int("preparationTime"), // Tempo estimado de preparo em meses
  
  // Plano de Acompanhamento
  trackingPlan: text("trackingPlan"), // JSON com marcos e progress
  nextReviewDate: timestamp("nextReviewDate"),
  
  notes: text("notes"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type SuccessionPlan = typeof successionPlans.$inferSelect;
export type InsertSuccessionPlan = typeof successionPlans.$inferInsert;

export const successionCandidates = mysqlTable("successionCandidates", {
  id: int("id").autoincrement().primaryKey(),
  planId: int("planId").notNull(),
  employeeId: int("employeeId").notNull(),
  readinessLevel: mysqlEnum("readinessLevel", ["imediato", "1_ano", "2_3_anos", "mais_3_anos"]).notNull(),
  priority: int("priority").default(1).notNull(), // Ordem de prioridade (1=Principal, 2=SecundÃ¡rio, 3=Backup)
  
  // AvaliaÃ§Ãµes
  performanceRating: mysqlEnum("performanceRating", ["baixo", "medio", "alto", "excepcional"]),
  potentialRating: mysqlEnum("potentialRating", ["baixo", "medio", "alto", "excepcional"]),
  nineBoxPosition: varchar("nineBoxPosition", { length: 100 }), // PosiÃ§Ã£o na matriz 9-box
  
  // IntegraÃ§Ã£o com PDI
  pdiPlanId: int("pdiPlanId"), // Plano de Desenvolvimento Individual vinculado
  pdiProgress: int("pdiProgress").default(0), // Progresso do PDI (0-100%)
  pdiCompletedActions: int("pdiCompletedActions").default(0), // AÃ§Ãµes concluÃ­das
  pdiTotalActions: int("pdiTotalActions").default(0), // Total de aÃ§Ãµes
  
  // Score Unificado de ProntidÃ£o
  readinessScore: int("readinessScore").default(0), // Score 0-100 calculado automaticamente
  competencyGapScore: int("competencyGapScore").default(0), // Gap de competÃªncias (0-100)
  lastScoreUpdate: datetime("lastScoreUpdate"), // Ãšltima atualizaÃ§Ã£o do score
  
  // AnÃ¡lise e Desenvolvimento
  gapAnalysis: text("gapAnalysis"), // AnÃ¡lise de gaps (lacunas)
  developmentActions: text("developmentActions"), // AÃ§Ãµes de desenvolvimento recomendadas
  
  developmentPlanId: int("developmentPlanId"), // PDI associado
  notes: text("notes"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type SuccessionCandidate = typeof successionCandidates.$inferSelect;
export type InsertSuccessionCandidate = typeof successionCandidates.$inferInsert;

// ============================================================================
// TABELAS DE NOTIFICAÃ‡Ã•ES E E-MAIL
// ============================================================================

export const emailMetrics = mysqlTable("emailMetrics", {
  id: int("id").autoincrement().primaryKey(),
  type: varchar("type", { length: 100 }).notNull(), // Tipo de e-mail
  toEmail: varchar("toEmail", { length: 320 }).notNull(),
  subject: varchar("subject", { length: 255 }),
  success: boolean("success").notNull(),
  deliveryTime: int("deliveryTime"), // Tempo em ms
  messageId: varchar("messageId", { length: 255 }),
  error: text("error"),
  attempts: int("attempts").default(1).notNull(),
  sentAt: timestamp("sentAt").defaultNow().notNull(),
});

export type EmailMetric = typeof emailMetrics.$inferSelect;
export type InsertEmailMetric = typeof emailMetrics.$inferInsert;

export const notifications = mysqlTable("notifications", {
  id: int("id").autoincrement().primaryKey(),
  userId: int("userId").notNull(),
  type: varchar("type", { length: 100 }).notNull(),
  title: varchar("title", { length: 255 }).notNull(),
  message: text("message"),
  link: varchar("link", { length: 512 }),
  read: boolean("read").default(false).notNull(),
  readAt: datetime("readAt"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type Notification = typeof notifications.$inferSelect;
export type InsertNotification = typeof notifications.$inferInsert;

// ============================================================================
// TABELAS DE AUDITORIA
// ============================================================================

export const auditLogs = mysqlTable("auditLogs", {
  id: int("id").autoincrement().primaryKey(),
  userId: int("userId"),
  action: varchar("action", { length: 100 }).notNull(),
  entity: varchar("entity", { length: 100 }).notNull(),
  entityId: int("entityId"),
  changes: text("changes"), // JSON com mudanÃ§as
  ipAddress: varchar("ipAddress", { length: 45 }),
  userAgent: text("userAgent"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type AuditLog = typeof auditLogs.$inferSelect;
export type InsertAuditLog = typeof auditLogs.$inferInsert;

// ============================================================================
// SISTEMA DE FEEDBACK CONTÃNUO
// ============================================================================

export const feedbacks = mysqlTable("feedbacks", {
  id: int("id").autoincrement().primaryKey(),
  managerId: int("managerId").notNull(), // Gestor que deu o feedback
  employeeId: int("employeeId").notNull(), // Colaborador que recebeu
  type: mysqlEnum("type", ["positivo", "construtivo", "desenvolvimento"]).notNull(),
  category: varchar("category", { length: 100 }), // Ex: ComunicaÃ§Ã£o, LideranÃ§a, etc
  content: text("content").notNull(), // ConteÃºdo do feedback
  context: text("context"), // Contexto/situaÃ§Ã£o
  actionItems: text("actionItems"), // AÃ§Ãµes recomendadas (JSON)
  linkedPDIId: int("linkedPDIId"), // PDI vinculado (opcional)
  isPrivate: boolean("isPrivate").default(false).notNull(), // VisÃ­vel apenas para gestor e colaborador
  acknowledgedAt: datetime("acknowledgedAt"), // Quando o colaborador visualizou
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type Feedback = typeof feedbacks.$inferSelect;
export type InsertFeedback = typeof feedbacks.$inferInsert;

// ============================================================================
// SISTEMA DE BADGES E GAMIFICAÃ‡ÃƒO
// ============================================================================

export const badges = mysqlTable("badges", {
  id: int("id").autoincrement().primaryKey(),
  code: varchar("code", { length: 50 }), // CÃ³digo Ãºnico do badge
  name: varchar("name", { length: 100 }).notNull(),
  description: text("description").notNull(),
  icon: varchar("icon", { length: 50 }), // Nome do Ã­cone lucide-react
  category: mysqlEnum("category", ["metas", "pdi", "avaliacao", "feedback", "geral"]).notNull(),
  points: int("points").notNull().default(0), // Pontos ganhos ao conquistar
  condition: text("condition"), // CondiÃ§Ã£o para desbloquear (JSON)
  isActive: boolean("isActive").default(true).notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type Badge = typeof badges.$inferSelect;
export type InsertBadge = typeof badges.$inferInsert;

export const employeeBadges = mysqlTable("employeeBadges", {
  id: int("id").autoincrement().primaryKey(),
  employeeId: int("employeeId").notNull(),
  badgeId: int("badgeId").notNull(),
  earnedAt: timestamp("earnedAt").defaultNow().notNull(),
  notified: boolean("notified").default(false).notNull(), // Se o colaborador foi notificado
});

export type EmployeeBadge = typeof employeeBadges.$inferSelect;
export type InsertEmployeeBadge = typeof employeeBadges.$inferInsert;

// ============================================================================
// RELAÃ‡Ã•ES (Relations)
// ============================================================================

export const employeesRelations = relations(employees, ({ one, many }) => ({
  user: one(users, {
    fields: [employees.userId],
    references: [users.id],
  }),
  department: one(departments, {
    fields: [employees.departmentId],
    references: [departments.id],
  }),
  position: one(positions, {
    fields: [employees.positionId],
    references: [positions.id],
  }),
  manager: one(employees, {
    fields: [employees.managerId],
    references: [employees.id],
  }),
  goals: many(goals),
  evaluations: many(performanceEvaluations),
  pdiPlans: many(pdiPlans),
  competencies: many(employeeCompetencies),
}));

export const goalsRelations = relations(goals, ({ one, many }) => ({
  employee: one(employees, {
    fields: [goals.employeeId],
    references: [employees.id],
  }),
  cycle: one(evaluationCycles, {
    fields: [goals.cycleId],
    references: [evaluationCycles.id],
  }),
  updates: many(goalUpdates),
}));

export const pdiPlansRelations = relations(pdiPlans, ({ one, many }) => ({
  employee: one(employees, {
    fields: [pdiPlans.employeeId],
    references: [employees.id],
  }),
  cycle: one(evaluationCycles, {
    fields: [pdiPlans.cycleId],
    references: [evaluationCycles.id],
  }),
  targetPosition: one(positions, {
    fields: [pdiPlans.targetPositionId],
    references: [positions.id],
  }),
  items: many(pdiItems),
}));

export const pdiItemsRelations = relations(pdiItems, ({ one, many }) => ({
  plan: one(pdiPlans, {
    fields: [pdiItems.planId],
    references: [pdiPlans.id],
  }),
  action: one(developmentActions, {
    fields: [pdiItems.actionId],
    references: [developmentActions.id],
  }),
  competency: one(competencies, {
    fields: [pdiItems.competencyId],
    references: [competencies.id],
  }),
  progress: many(pdiProgress),
}));


// ============================================================================
// TESTES PSICOMÃ‰TRICOS
// ============================================================================

export const psychometricTests = mysqlTable("psychometricTests", {
  id: int("id").autoincrement().primaryKey(),
  employeeId: int("employeeId").notNull(),
  testType: mysqlEnum("testType", ["disc", "bigfive", "mbti", "ie", "vark", "leadership", "careeranchors"]).notNull(),
  completedAt: datetime("completedAt").notNull(),
  // Resultados DISC (0-100 para cada dimensÃ£o)
  discDominance: int("discDominance"), // DominÃ¢ncia
  discInfluence: int("discInfluence"), // InfluÃªncia
  discSteadiness: int("discSteadiness"), // Estabilidade
  discCompliance: int("discCompliance"), // Conformidade
  discProfile: varchar("discProfile", { length: 10 }), // Ex: "D", "I", "S", "C", "DI", "SC"
  // Resultados Big Five (0-100 para cada dimensÃ£o)
  bigFiveOpenness: int("bigFiveOpenness"), // Abertura
  bigFiveConscientiousness: int("bigFiveConscientiousness"), // Conscienciosidade
  bigFiveExtraversion: int("bigFiveExtraversion"), // ExtroversÃ£o
  bigFiveAgreeableness: int("bigFiveAgreeableness"), // Amabilidade
  bigFiveNeuroticism: int("bigFiveNeuroticism"), // Neuroticismo
  // Metadados
  responses: text("responses"), // JSON com todas as respostas
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type PsychometricTest = typeof psychometricTests.$inferSelect;
export type InsertPsychometricTest = typeof psychometricTests.$inferInsert;

export const testQuestions = mysqlTable("testQuestions", {
  id: int("id").autoincrement().primaryKey(),
  testType: mysqlEnum("testType", ["disc", "bigfive", "mbti", "ie", "vark", "leadership", "careeranchors"]).notNull(),
  questionNumber: int("questionNumber").notNull(),
  questionText: text("questionText").notNull(),
  dimension: varchar("dimension", { length: 50 }).notNull(), // Ex: "dominance", "openness", "E/I", "AutoconsciÃªncia", "Visual"
  reverse: boolean("reverse").default(false).notNull(), // Se a pontuaÃ§Ã£o Ã© invertida
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type TestQuestion = typeof testQuestions.$inferSelect;
export type InsertTestQuestion = typeof testQuestions.$inferInsert;

// ============================================================================
// CONFIGURAÃ‡Ã•ES DO SISTEMA
// ============================================================================

export const systemSettings = mysqlTable("systemSettings", {
  id: int("id").autoincrement().primaryKey(),
  settingKey: varchar("settingKey", { length: 100 }).notNull().unique(),
  settingValue: text("settingValue"),
  description: text("description"),
  isEncrypted: boolean("isEncrypted").default(false).notNull(),
  updatedBy: int("updatedBy"), // ID do usuÃ¡rio que atualizou
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type SystemSetting = typeof systemSettings.$inferSelect;
export type InsertSystemSetting = typeof systemSettings.$inferInsert;


// ============================================================================
// RELATÃ“RIOS AGENDADOS
// ============================================================================

export const scheduledReports = mysqlTable("scheduledReports", {
  id: int("id").autoincrement().primaryKey(),
  reportType: mysqlEnum("reportType", [
    "nine_box",
    "performance",
    "pdi",
    "evaluations",
    "goals",
    "competencies",
    "succession",
    "turnover",
    "headcount"
  ]).notNull(),
  reportName: varchar("reportName", { length: 255 }).notNull(),
  frequency: mysqlEnum("frequency", ["daily", "weekly", "monthly", "quarterly"]).notNull(),
  dayOfWeek: int("dayOfWeek"), // 0-6 para semanal (0=domingo)
  dayOfMonth: int("dayOfMonth"), // 1-31 para mensal
  hour: int("hour").default(9).notNull(), // Hora do dia (0-23)
  recipients: text("recipients").notNull(), // JSON array de e-mails
  departments: text("departments"), // JSON array de IDs de departamentos (filtro opcional)
  format: mysqlEnum("format", ["pdf", "excel", "csv"]).default("pdf").notNull(),
  includeCharts: boolean("includeCharts").default(true).notNull(),
  active: boolean("active").default(true).notNull(),
  lastExecutedAt: datetime("lastExecutedAt"),
  nextExecutionAt: datetime("nextExecutionAt"),
  createdBy: int("createdBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type ScheduledReport = typeof scheduledReports.$inferSelect;
export type InsertScheduledReport = typeof scheduledReports.$inferInsert;

export const reportExecutionLogs = mysqlTable("reportExecutionLogs", {
  id: int("id").autoincrement().primaryKey(),
  scheduledReportId: int("scheduledReportId").notNull(),
  executedAt: datetime("executedAt").notNull(),
  status: mysqlEnum("status", ["success", "failed", "partial"]).notNull(),
  recipientCount: int("recipientCount").default(0).notNull(),
  successCount: int("successCount").default(0).notNull(),
  failedCount: int("failedCount").default(0).notNull(),
  errorMessage: text("errorMessage"),
  executionTimeMs: int("executionTimeMs"), // Tempo de execuÃ§Ã£o em milissegundos
  fileSize: int("fileSize"), // Tamanho do arquivo gerado em bytes
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type ReportExecutionLog = typeof reportExecutionLogs.$inferSelect;
export type InsertReportExecutionLog = typeof reportExecutionLogs.$inferInsert;


// ============================================================================
// TABELAS DE RELATÃ“RIOS CUSTOMIZÃVEIS
// ============================================================================

export const customReports = mysqlTable("customReports", {
  id: int("id").autoincrement().primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  description: text("description"),
  createdBy: int("createdBy").notNull(),
  metrics: json("metrics").notNull(), // Array de mÃ©tricas selecionadas
  filters: json("filters"), // Filtros aplicados (departamento, perÃ­odo, cargo)
  chartType: varchar("chartType", { length: 50 }), // bar, line, pie, table
  isTemplate: boolean("isTemplate").default(false).notNull(),
  isPublic: boolean("isPublic").default(false).notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type CustomReport = typeof customReports.$inferSelect;
export type InsertCustomReport = typeof customReports.$inferInsert;

// Tabela de analytics de relatÃ³rios
export const reportAnalytics = mysqlTable("reportAnalytics", {
  id: int("id").autoincrement().primaryKey(),
  reportId: int("reportId"), // ID do relatÃ³rio customizado (se aplicÃ¡vel)
  reportName: varchar("reportName", { length: 255 }),
  action: mysqlEnum("action", ["view", "export_pdf", "export_excel", "create", "update", "delete"]).notNull(),
  userId: int("userId").notNull(),
  metrics: json("metrics"), // MÃ©tricas utilizadas
  filters: json("filters"), // Filtros aplicados
  executionTimeMs: int("executionTimeMs"), // Tempo de execuÃ§Ã£o
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type ReportAnalytic = typeof reportAnalytics.$inferSelect;
export type InsertReportAnalytic = typeof reportAnalytics.$inferInsert;

// ============================================================================
// TABELAS DE PDI INTELIGENTE (ExtensÃ£o para SucessÃ£o EstratÃ©gica)
// ============================================================================

/**
 * Tabela de detalhes estendidos do PDI para sucessÃ£o estratÃ©gica
 * Armazena informaÃ§Ãµes de comparaÃ§Ã£o de perfis, gaps, sponsors e riscos
 */
export const pdiIntelligentDetails = mysqlTable("pdiIntelligentDetails", {
  id: int("id").autoincrement().primaryKey(),
  planId: int("planId").notNull().unique(), // Relacionamento 1:1 com pdiPlans
  
  // Contexto estratÃ©gico
  strategicContext: text("strategicContext"), // DescriÃ§Ã£o do desafio estratÃ©gico
  durationMonths: int("durationMonths").default(24).notNull(), // DuraÃ§Ã£o do plano em meses
  
  // Sponsors e responsÃ¡veis
  mentorId: int("mentorId"), // Gestor/Mentor direto
  sponsorId1: int("sponsorId1"), // Sponsor 1 (ex: Diretor Agroindustrial)
  sponsorId2: int("sponsorId2"), // Sponsor 2 (ex: Diretor de Gente e Cultura)
  guardianId: int("guardianId"), // GuardiÃ£o do PDI (DGC)
  
  // Perfil atual (JSON com dados de testes psicomÃ©tricos)
  currentProfile: json("currentProfile").$type<{
    disc?: { d: number; i: number; s: number; c: number };
    bigFive?: { o: number; c: number; e: number; a: number; n: number };
    mbti?: string;
    ie?: number;
    competencies?: { competencyId: number; level: number }[];
  }>(),
  
  // Perfil da posiÃ§Ã£o-alvo (JSON)
  targetProfile: json("targetProfile").$type<{
    disc?: { d: number; i: number; s: number; c: number };
    bigFive?: { o: number; c: number; e: number; a: number; n: number };
    mbti?: string;
    ie?: number;
    competencies?: { competencyId: number; level: number }[];
  }>(),
  
  // AnÃ¡lise de gaps (JSON)
  gapsAnalysis: json("gapsAnalysis").$type<{
    gaps: Array<{
      type: "competency" | "behavioral" | "technical" | "leadership";
      name: string;
      currentLevel: number;
      targetLevel: number;
      priority: "high" | "medium" | "low";
      actions: string[];
    }>;
  }>(),
  
  // Marcos de progressÃ£o
  milestone12Months: text("milestone12Months"), // Marco de 12 meses
  milestone24Months: text("milestone24Months"), // Marco de 24 meses
  milestone12Status: mysqlEnum("milestone12Status", ["pendente", "concluido", "atrasado"]).default("pendente"),
  milestone24Status: mysqlEnum("milestone24Status", ["pendente", "concluido", "atrasado"]).default("pendente"),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type PdiIntelligentDetail = typeof pdiIntelligentDetails.$inferSelect;
export type InsertPdiIntelligentDetail = typeof pdiIntelligentDetails.$inferInsert;

/**
 * Tabela de gaps de competÃªncias identificados no PDI
 */
export const pdiCompetencyGaps = mysqlTable("pdiCompetencyGaps", {
  id: int("id").autoincrement().primaryKey(),
  planId: int("planId").notNull(),
  competencyId: int("competencyId").notNull(),
  
  currentLevel: int("currentLevel").notNull(), // NÃ­vel atual (1-5)
  targetLevel: int("targetLevel").notNull(), // NÃ­vel desejado (1-5)
  gap: int("gap").notNull(), // DiferenÃ§a (targetLevel - currentLevel)
  priority: mysqlEnum("priority", ["alta", "media", "baixa"]).default("media").notNull(),
  
  // Responsabilidades para superar o gap
  employeeActions: text("employeeActions"), // AÃ§Ãµes do colaborador
  managerActions: text("managerActions"), // AÃ§Ãµes do gestor
  sponsorActions: text("sponsorActions"), // AÃ§Ãµes dos sponsors
  
  status: mysqlEnum("status", ["identificado", "em_desenvolvimento", "superado"]).default("identificado").notNull(),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type PdiCompetencyGap = typeof pdiCompetencyGaps.$inferSelect;
export type InsertPdiCompetencyGap = typeof pdiCompetencyGaps.$inferInsert;

/**
 * Tabela de riscos do PDI
 */
export const pdiRisks = mysqlTable("pdiRisks", {
  id: int("id").autoincrement().primaryKey(),
  planId: int("planId").notNull(),
  
  type: mysqlEnum("type", ["saida", "gap_competencia", "tempo_preparo", "mudanca_estrategica", "outro"]).notNull(),
  description: text("description").notNull(),
  impact: mysqlEnum("impact", ["baixo", "medio", "alto", "critico"]).notNull(),
  probability: mysqlEnum("probability", ["baixa", "media", "alta"]).notNull(),
  
  mitigation: text("mitigation"), // Plano de mitigaÃ§Ã£o
  responsible: int("responsible"), // ResponsÃ¡vel pela mitigaÃ§Ã£o
  
  status: mysqlEnum("status", ["identificado", "em_mitigacao", "mitigado", "materializado"]).default("identificado").notNull(),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type PdiRisk = typeof pdiRisks.$inferSelect;
export type InsertPdiRisk = typeof pdiRisks.$inferInsert;

/**
 * Tabela de acompanhamento e reviews do PDI
 */
export const pdiReviews = mysqlTable("pdiReviews", {
  id: int("id").autoincrement().primaryKey(),
  planId: int("planId").notNull(),
  reviewerId: int("reviewerId").notNull(), // Quem fez o review (gestor, sponsor, DGC)
  reviewerRole: mysqlEnum("reviewerRole", ["mentor", "sponsor", "guardiao"]).notNull(),
  
  reviewDate: datetime("reviewDate").notNull(),
  overallProgress: int("overallProgress").notNull(), // AvaliaÃ§Ã£o geral (0-100)
  
  strengths: text("strengths"), // Pontos fortes observados
  improvements: text("improvements"), // Pontos de melhoria
  nextSteps: text("nextSteps"), // PrÃ³ximos passos recomendados
  
  recommendation: mysqlEnum("recommendation", ["manter", "acelerar", "ajustar", "pausar"]).notNull(),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type PdiReview = typeof pdiReviews.$inferSelect;
export type InsertPdiReview = typeof pdiReviews.$inferInsert;

// RelaÃ§Ãµes para PDI Inteligente
export const pdiIntelligentDetailsRelations = relations(pdiIntelligentDetails, ({ one }) => ({
  plan: one(pdiPlans, {
    fields: [pdiIntelligentDetails.planId],
    references: [pdiPlans.id],
  }),
  mentor: one(employees, {
    fields: [pdiIntelligentDetails.mentorId],
    references: [employees.id],
  }),
  sponsor1: one(employees, {
    fields: [pdiIntelligentDetails.sponsorId1],
    references: [employees.id],
  }),
  sponsor2: one(employees, {
    fields: [pdiIntelligentDetails.sponsorId2],
    references: [employees.id],
  }),
  guardian: one(employees, {
    fields: [pdiIntelligentDetails.guardianId],
    references: [employees.id],
  }),
}));

export const pdiCompetencyGapsRelations = relations(pdiCompetencyGaps, ({ one }) => ({
  plan: one(pdiPlans, {
    fields: [pdiCompetencyGaps.planId],
    references: [pdiPlans.id],
  }),
  competency: one(competencies, {
    fields: [pdiCompetencyGaps.competencyId],
    references: [competencies.id],
  }),
}));

export const pdiRisksRelations = relations(pdiRisks, ({ one }) => ({
  plan: one(pdiPlans, {
    fields: [pdiRisks.planId],
    references: [pdiPlans.id],
  }),
  responsibleEmployee: one(employees, {
    fields: [pdiRisks.responsible],
    references: [employees.id],
  }),
}));

export const pdiReviewsRelations = relations(pdiReviews, ({ one }) => ({
  plan: one(pdiPlans, {
    fields: [pdiReviews.planId],
    references: [pdiPlans.id],
  }),
  reviewer: one(employees, {
    fields: [pdiReviews.reviewerId],
    references: [employees.id],
  }),
}));


/**
 * ========================================
 * METAS SMART (SMART Goals)
 * ========================================
 * Sistema completo de metas com validaÃ§Ã£o SMART,
 * aprovaÃ§Ãµes e elegibilidade para bÃ´nus financeiro
 */

export const smartGoals = mysqlTable("smartGoals", {
  id: int("id").autoincrement().primaryKey(),
  employeeId: int("employeeId").notNull(),
  cycleId: int("cycleId").notNull(),
  pdiPlanId: int("pdiPlanId"), // Opcional: vincular com PDI
  
  // InformaÃ§Ãµes bÃ¡sicas
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description").notNull(),
  type: mysqlEnum("type", ["individual", "team", "organizational"]).notNull(),
  category: mysqlEnum("category", ["financial", "behavioral", "corporate", "development"]).notNull(),
  
  // CritÃ©rios SMART
  isSpecific: boolean("isSpecific").default(false).notNull(), // S - EspecÃ­fica
  isMeasurable: boolean("isMeasurable").default(false).notNull(), // M - MensurÃ¡vel
  isAchievable: boolean("isAchievable").default(false).notNull(), // A - AtingÃ­vel
  isRelevant: boolean("isRelevant").default(false).notNull(), // R - Relevante
  isTimeBound: boolean("isTimeBound").default(false).notNull(), // T - Temporal
  
  // MÃ©tricas
  measurementUnit: varchar("measurementUnit", { length: 50 }), // Ex: "R$", "%", "unidades"
  targetValue: decimal("targetValue", { precision: 10, scale: 2 }), // Valor alvo
  currentValue: decimal("currentValue", { precision: 10, scale: 2 }).default("0"), // Valor atual
  weight: int("weight").default(10).notNull(), // Peso da meta (para cÃ¡lculo de bÃ´nus)
  
  // Datas
  startDate: date("startDate").notNull(),
  endDate: date("endDate").notNull(),
  
  // BÃ´nus financeiro
  bonusEligible: boolean("bonusEligible").default(false).notNull(), // ElegÃ­vel para bÃ´nus?
  bonusPercentage: decimal("bonusPercentage", { precision: 5, scale: 2 }), // % de bÃ´nus se atingir
  bonusAmount: decimal("bonusAmount", { precision: 10, scale: 2 }), // Valor fixo de bÃ´nus
  
  // Status e aprovaÃ§Ã£o
  status: mysqlEnum("status", ["draft", "pending_approval", "approved", "rejected", "in_progress", "completed", "cancelled"]).default("draft").notNull(),
  approvalStatus: mysqlEnum("approvalStatus", ["not_submitted", "pending_manager", "pending_hr", "approved", "rejected"]).default("not_submitted").notNull(),
  progress: int("progress").default(0).notNull(), // 0-100%
  
  // Metadados
  createdBy: int("createdBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
  completedAt: timestamp("completedAt"),
});

export const goalMilestones = mysqlTable("goalMilestones", {
  id: int("id").autoincrement().primaryKey(),
  goalId: int("goalId").notNull(),
  
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description"),
  dueDate: date("dueDate").notNull(),
  
  status: mysqlEnum("status", ["pending", "in_progress", "completed", "delayed"]).default("pending").notNull(),
  progress: int("progress").default(0).notNull(), // 0-100%
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
  completedAt: timestamp("completedAt"),
});

export const goalApprovals = mysqlTable("goalApprovals", {
  id: int("id").autoincrement().primaryKey(),
  goalId: int("goalId").notNull(),
  
  approverId: int("approverId").notNull(), // ID do aprovador (gestor ou RH)
  approverRole: mysqlEnum("approverRole", ["manager", "hr", "director"]).notNull(),
  
  status: mysqlEnum("status", ["pending", "approved", "rejected"]).default("pending").notNull(),
  comments: text("comments"),
  
  approvedAt: timestamp("approvedAt"), // Data de aprovaÃ§Ã£o/rejeiÃ§Ã£o
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export const goalComments = mysqlTable("goalComments", {
  id: int("id").autoincrement().primaryKey(),
  goalId: int("goalId").notNull(),
  
  authorId: int("authorId").notNull(),
  comment: text("comment").notNull(),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

// Relations
export const smartGoalsRelations = relations(smartGoals, ({ one, many }) => ({
  employee: one(employees, {
    fields: [smartGoals.employeeId],
    references: [employees.id],
  }),
  cycle: one(evaluationCycles, {
    fields: [smartGoals.cycleId],
    references: [evaluationCycles.id],
  }),
  pdiPlan: one(pdiPlans, {
    fields: [smartGoals.pdiPlanId],
    references: [pdiPlans.id],
  }),
  creator: one(employees, {
    fields: [smartGoals.createdBy],
    references: [employees.id],
  }),
  milestones: many(goalMilestones),
  approvals: many(goalApprovals),
  comments: many(goalComments),
}));

export const goalMilestonesRelations = relations(goalMilestones, ({ one }) => ({
  goal: one(smartGoals, {
    fields: [goalMilestones.goalId],
    references: [smartGoals.id],
  }),
}));

export const goalApprovalsRelations = relations(goalApprovals, ({ one }) => ({
  goal: one(smartGoals, {
    fields: [goalApprovals.goalId],
    references: [smartGoals.id],
  }),
  approver: one(employees, {
    fields: [goalApprovals.approverId],
    references: [employees.id],
  }),
}));

export const goalCommentsRelations = relations(goalComments, ({ one }) => ({
  goal: one(smartGoals, {
    fields: [goalComments.goalId],
    references: [smartGoals.id],
  }),
  author: one(employees, {
    fields: [goalComments.authorId],
    references: [employees.id],
  }),
}));

export type SmartGoal = typeof smartGoals.$inferSelect;
export type InsertSmartGoal = typeof smartGoals.$inferInsert;
export type GoalMilestone = typeof goalMilestones.$inferSelect;
export type InsertGoalMilestone = typeof goalMilestones.$inferInsert;
export type GoalApproval = typeof goalApprovals.$inferSelect;
export type InsertGoalApproval = typeof goalApprovals.$inferInsert;
export type GoalComment = typeof goalComments.$inferSelect;
export type InsertGoalComment = typeof goalComments.$inferInsert;

/**
 * ConfiguraÃ§Ãµes de BÃ´nus por FunÃ§Ã£o
 * Define quantos salÃ¡rios cada funÃ§Ã£o tem direito + bÃ´nus extra
 */
export const bonusConfigs = mysqlTable("bonusConfigs", {
  id: int("id").autoincrement().primaryKey(),
  positionId: int("positionId").notNull(), // ReferÃªncia para positions
  positionName: varchar("positionName", { length: 255 }).notNull(),
  
  // ConfiguraÃ§Ã£o de bÃ´nus
  baseSalaryMultiplier: decimal("baseSalaryMultiplier", { precision: 5, scale: 2 }).default("0").notNull(), // Ex: 1.5 = 1.5 salÃ¡rios
  extraBonusPercentage: decimal("extraBonusPercentage", { precision: 5, scale: 2 }).default("0").notNull(), // % adicional
  
  // Metadados
  isActive: boolean("isActive").default(true).notNull(),
  createdBy: int("createdBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

/**
 * Workflows de AprovaÃ§Ã£o de BÃ´nus
 * Define atÃ© 5 nÃ­veis de aprovadores
 */
export const bonusWorkflows = mysqlTable("bonusWorkflows", {
  id: int("id").autoincrement().primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  description: text("description"),
  
  // Aprovadores (atÃ© 5 nÃ­veis)
  approver1Id: int("approver1Id"), // RH
  approver1Role: varchar("approver1Role", { length: 100 }), // Ex: "Analista RH"
  approver2Id: int("approver2Id"), // Gerente RH
  approver2Role: varchar("approver2Role", { length: 100 }),
  approver3Id: int("approver3Id"), // Diretor de Gente
  approver3Role: varchar("approver3Role", { length: 100 }),
  approver4Id: int("approver4Id"), // Opcional
  approver4Role: varchar("approver4Role", { length: 100 }),
  approver5Id: int("approver5Id"), // Opcional
  approver5Role: varchar("approver5Role", { length: 100 }),
  
  // ConfiguraÃ§Ãµes
  requireAllApprovals: boolean("requireAllApprovals").default(true).notNull(),
  isActive: boolean("isActive").default(true).notNull(),
  
  createdBy: int("createdBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

/**
 * AprovaÃ§Ãµes de BÃ´nus
 * Registra cada etapa de aprovaÃ§Ã£o no workflow
 */
export const bonusApprovals = mysqlTable("bonusApprovals", {
  id: int("id").autoincrement().primaryKey(),
  cycleId: int("cycleId").notNull(),
  employeeId: int("employeeId").notNull(),
  workflowId: int("workflowId").notNull(),
  
  // Valores de bÃ´nus
  eligibleAmount: decimal("eligibleAmount", { precision: 10, scale: 2 }).notNull(), // Valor elegÃ­vel baseado em metas
  extraBonusPercentage: decimal("extraBonusPercentage", { precision: 5, scale: 2 }).default("0"), // BÃ´nus extra do RH
  finalAmount: decimal("finalAmount", { precision: 10, scale: 2 }).notNull(), // Valor final aprovado
  
  // Status do workflow
  currentLevel: int("currentLevel").default(1).notNull(), // NÃ­vel atual de aprovaÃ§Ã£o (1-5)
  status: mysqlEnum("status", ["pending", "approved", "rejected", "cancelled"]).default("pending").notNull(),
  
  // AprovaÃ§Ãµes por nÃ­vel
  level1Status: mysqlEnum("level1Status", ["pending", "approved", "rejected"]).default("pending"),
  level1ApproverId: int("level1ApproverId"),
  level1ApprovedAt: timestamp("level1ApprovedAt"),
  level1Comments: text("level1Comments"),
  
  level2Status: mysqlEnum("level2Status", ["pending", "approved", "rejected"]).default("pending"),
  level2ApproverId: int("level2ApproverId"),
  level2ApprovedAt: timestamp("level2ApprovedAt"),
  level2Comments: text("level2Comments"),
  
  level3Status: mysqlEnum("level3Status", ["pending", "approved", "rejected"]).default("pending"),
  level3ApproverId: int("level3ApproverId"),
  level3ApprovedAt: timestamp("level3ApprovedAt"),
  level3Comments: text("level3Comments"),
  
  level4Status: mysqlEnum("level4Status", ["pending", "approved", "rejected"]).default("pending"),
  level4ApproverId: int("level4ApproverId"),
  level4ApprovedAt: timestamp("level4ApprovedAt"),
  level4Comments: text("level4Comments"),
  
  level5Status: mysqlEnum("level5Status", ["pending", "approved", "rejected"]).default("pending"),
  level5ApproverId: int("level5ApproverId"),
  level5ApprovedAt: timestamp("level5ApprovedAt"),
  level5Comments: text("level5Comments"),
  
  // Documento final
  signedPdfUrl: varchar("signedPdfUrl", { length: 500 }), // URL do PDF assinado
  sentToFinanceAt: timestamp("sentToFinanceAt"),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

/**
 * EvidÃªncias de Cumprimento de Metas
 * Armazena descriÃ§Ãµes e anexos que comprovam a conclusÃ£o da meta
 */
export const goalEvidences = mysqlTable("goalEvidences", {
  id: int("id").autoincrement().primaryKey(),
  goalId: int("goalId").notNull(),
  
  // EvidÃªncia
  description: text("description").notNull(), // DescriÃ§Ã£o da evidÃªncia
  attachmentUrl: varchar("attachmentUrl", { length: 500 }), // URL do arquivo anexado (S3)
  attachmentName: varchar("attachmentName", { length: 255 }), // Nome original do arquivo
  attachmentType: varchar("attachmentType", { length: 100 }), // Tipo MIME
  attachmentSize: int("attachmentSize"), // Tamanho em bytes
  
  // Metadados
  uploadedBy: int("uploadedBy").notNull(),
  uploadedAt: timestamp("uploadedAt").defaultNow().notNull(),
  isVerified: boolean("isVerified").default(false).notNull(), // Verificado por auditor/gestor
  verifiedBy: int("verifiedBy"),
  verifiedAt: timestamp("verifiedAt"),
});

// Relations
export const bonusConfigsRelations = relations(bonusConfigs, ({ one }) => ({
  position: one(positions, {
    fields: [bonusConfigs.positionId],
    references: [positions.id],
  }),
  creator: one(employees, {
    fields: [bonusConfigs.createdBy],
    references: [employees.id],
  }),
}));

export const bonusWorkflowsRelations = relations(bonusWorkflows, ({ one, many }) => ({
  approver1: one(employees, {
    fields: [bonusWorkflows.approver1Id],
    references: [employees.id],
  }),
  approver2: one(employees, {
    fields: [bonusWorkflows.approver2Id],
    references: [employees.id],
  }),
  approver3: one(employees, {
    fields: [bonusWorkflows.approver3Id],
    references: [employees.id],
  }),
  approver4: one(employees, {
    fields: [bonusWorkflows.approver4Id],
    references: [employees.id],
  }),
  approver5: one(employees, {
    fields: [bonusWorkflows.approver5Id],
    references: [employees.id],
  }),
  creator: one(employees, {
    fields: [bonusWorkflows.createdBy],
    references: [employees.id],
  }),
  approvals: many(bonusApprovals),
}));

export const bonusApprovalsRelations = relations(bonusApprovals, ({ one }) => ({
  cycle: one(evaluationCycles, {
    fields: [bonusApprovals.cycleId],
    references: [evaluationCycles.id],
  }),
  employee: one(employees, {
    fields: [bonusApprovals.employeeId],
    references: [employees.id],
  }),
  workflow: one(bonusWorkflows, {
    fields: [bonusApprovals.workflowId],
    references: [bonusWorkflows.id],
  }),
}));

export const goalEvidencesRelations = relations(goalEvidences, ({ one }) => ({
  goal: one(smartGoals, {
    fields: [goalEvidences.goalId],
    references: [smartGoals.id],
  }),
  uploader: one(employees, {
    fields: [goalEvidences.uploadedBy],
    references: [employees.id],
  }),
  verifier: one(employees, {
    fields: [goalEvidences.verifiedBy],
    references: [employees.id],
  }),
}));

// Types
export type BonusConfig = typeof bonusConfigs.$inferSelect;
export type InsertBonusConfig = typeof bonusConfigs.$inferInsert;
export type BonusWorkflow = typeof bonusWorkflows.$inferSelect;
export type InsertBonusWorkflow = typeof bonusWorkflows.$inferInsert;
export type BonusApproval = typeof bonusApprovals.$inferSelect;
export type InsertBonusApproval = typeof bonusApprovals.$inferInsert;
export type GoalEvidence = typeof goalEvidences.$inferSelect;
export type InsertGoalEvidence = typeof goalEvidences.$inferInsert;

/**
 * Tabela de movimentaÃ§Ãµes de calibraÃ§Ã£o no Nine Box
 */
export const calibrationMovements = mysqlTable("calibrationMovements", {
  id: int("id").autoincrement().primaryKey(),
  employeeId: int("employeeId").notNull(),
  movedBy: int("movedBy").notNull(), // ID do usuÃ¡rio que moveu (RH)
  fromPerformance: mysqlEnum("fromPerformance", ["baixo", "mÃ©dio", "alto"]),
  fromPotential: mysqlEnum("fromPotential", ["baixo", "mÃ©dio", "alto"]),
  toPerformance: mysqlEnum("toPerformance", ["baixo", "mÃ©dio", "alto"]).notNull(),
  toPotential: mysqlEnum("toPotential", ["baixo", "mÃ©dio", "alto"]).notNull(),
  justification: text("justification").notNull(), // Justificativa obrigatÃ³ria
  status: mysqlEnum("status", ["pending", "approved_hr", "approved_people_director", "approved_area_director", "rejected"]).default("pending").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type CalibrationMovement = typeof calibrationMovements.$inferSelect;
export type InsertCalibrationMovement = typeof calibrationMovements.$inferInsert;

/**
 * Tabela de aprovaÃ§Ãµes de calibraÃ§Ã£o (workflow)
 */
export const calibrationApprovals = mysqlTable("calibrationApprovals", {
  id: int("id").autoincrement().primaryKey(),
  movementId: int("movementId").notNull(),
  approverId: int("approverId").notNull(), // ID do aprovador
  approverRole: mysqlEnum("approverRole", ["hr", "people_director", "area_director"]).notNull(),
  status: mysqlEnum("status", ["pending", "approved", "rejected"]).default("pending").notNull(),
  evidence: text("evidence"), // EvidÃªncias (obrigatÃ³rio para Diretor de Ãrea)
  comments: text("comments"),
  approvedAt: timestamp("approvedAt"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type CalibrationApproval = typeof calibrationApprovals.$inferSelect;
export type InsertCalibrationApproval = typeof calibrationApprovals.$inferInsert;

/**
 * Tabela de configuraÃ§Ã£o de workflows de calibraÃ§Ã£o
 */
export const calibrationWorkflows = mysqlTable("calibrationWorkflows", {
  id: int("id").autoincrement().primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  description: text("description"),
  steps: text("steps").notNull(), // JSON com os passos do workflow
  isActive: boolean("isActive").default(true).notNull(),
  createdBy: int("createdBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type CalibrationWorkflow = typeof calibrationWorkflows.$inferSelect;
export type InsertCalibrationWorkflow = typeof calibrationWorkflows.$inferInsert;

// ============================================================================
// TABELAS DE WORKFLOWS GENÃ‰RICOS
// ============================================================================

/**
 * Workflows GenÃ©ricos
 * Sistema flexÃ­vel de aprovaÃ§Ã£o para qualquer tipo de processo
 */
export const workflows = mysqlTable("workflows", {
  id: int("id").autoincrement().primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  description: text("description"),
  type: mysqlEnum("type", [
    "aprovacao_metas",
    "aprovacao_pdi",
    "aprovacao_avaliacao",
    "aprovacao_bonus",
    "aprovacao_ferias",
    "aprovacao_promocao",
    "aprovacao_horas_extras",
    "aprovacao_despesas",
    "outro"
  ]).notNull(),
  
  // ConfiguraÃ§Ã£o das etapas (JSON)
  steps: text("steps").notNull(), // Array de { order, name, approverType, approverIds, condition }
  
  // Status e controle
  isActive: boolean("isActive").default(true).notNull(),
  isDefault: boolean("isDefault").default(false).notNull(), // Workflow padrÃ£o para o tipo
  
  // Auditoria
  createdBy: int("createdBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type Workflow = typeof workflows.$inferSelect;
export type InsertWorkflow = typeof workflows.$inferInsert;

/**
 * InstÃ¢ncias de ExecuÃ§Ã£o de Workflows
 * Rastreia cada execuÃ§Ã£o de um workflow
 */
export const workflowInstances = mysqlTable("workflowInstances", {
  id: int("id").autoincrement().primaryKey(),
  workflowId: int("workflowId").notNull(),
  entityType: varchar("entityType", { length: 100 }).notNull(), // "goal", "pdi", "evaluation", etc
  entityId: int("entityId").notNull(), // ID da entidade sendo aprovada
  
  // Status atual
  currentStep: int("currentStep").default(1).notNull(),
  status: mysqlEnum("status", ["pending", "approved", "rejected", "cancelled"]).default("pending").notNull(),
  
  // Auditoria
  requestedBy: int("requestedBy").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
  completedAt: timestamp("completedAt"),
});

export type WorkflowInstance = typeof workflowInstances.$inferSelect;
export type InsertWorkflowInstance = typeof workflowInstances.$inferInsert;

/**
 * AprovaÃ§Ãµes de Etapas de Workflow
 * Registra cada aprovaÃ§Ã£o individual em uma etapa
 */
export const workflowStepApprovals = mysqlTable("workflowStepApprovals", {
  id: int("id").autoincrement().primaryKey(),
  instanceId: int("instanceId").notNull(),
  stepOrder: int("stepOrder").notNull(),
  approverId: int("approverId").notNull(),
  
  // DecisÃ£o
  status: mysqlEnum("status", ["pending", "approved", "rejected"]).default("pending").notNull(),
  comments: text("comments"),
  
  // Auditoria
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  approvedAt: timestamp("approvedAt"),
});

export type WorkflowStepApproval = typeof workflowStepApprovals.$inferSelect;
export type InsertWorkflowStepApproval = typeof workflowStepApprovals.$inferInsert;


/**
 * SMTP Configuration
 * Stores email server configuration for sending notifications
 */
export const smtpConfig = mysqlTable("smtp_config", {
  id: int("id").autoincrement().primaryKey(),
  host: varchar("host", { length: 255 }).notNull(),
  port: int("port").notNull().default(587),
  secure: boolean("secure").default(false), // true for 465, false for other ports
  user: varchar("user", { length: 255 }).notNull(),
  password: text("password").notNull(), // Encrypted
  fromEmail: varchar("from_email", { length: 320 }).notNull(),
  fromName: varchar("from_name", { length: 255 }).notNull(),
  isActive: boolean("is_active").default(true).notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().onUpdateNow().notNull(),
});

export type SmtpConfig = typeof smtpConfig.$inferSelect;
export type InsertSmtpConfig = typeof smtpConfig.$inferInsert;

// ============================================================================
// BENCHMARKING EXTERNO
// ============================================================================

/**
 * Dados de Benchmarking de Mercado
 * Armazena mÃ©dias de mercado por setor, cargo e regiÃ£o para comparaÃ§Ã£o
 */
export const marketBenchmarks = mysqlTable("marketBenchmarks", {
  id: int("id").autoincrement().primaryKey(),
  sector: varchar("sector", { length: 100 }).notNull(), // Setor (TI, SaÃºde, Financeiro, etc)
  position: varchar("position", { length: 100 }).notNull(), // Cargo
  region: varchar("region", { length: 100 }).default("Brasil").notNull(), // RegiÃ£o
  
  // MÃ©tricas de Performance
  avgPerformanceScore: int("avgPerformanceScore"), // MÃ©dia de performance (0-100)
  avgEngagementScore: int("avgEngagementScore"), // MÃ©dia de engajamento (0-100)
  avgTurnoverRate: int("avgTurnoverRate"), // Taxa de turnover (%)
  avgTenureYears: int("avgTenureYears"), // Tempo mÃ©dio de permanÃªncia (anos)
  
  // MÃ©tricas Salariais
  avgSalary: int("avgSalary"), // SalÃ¡rio mÃ©dio
  medianSalary: int("medianSalary"), // SalÃ¡rio mediano
  
  // Perfis PsicomÃ©tricos MÃ©dios (DISC)
  avgDiscD: int("avgDiscD"), // DominÃ¢ncia (0-100)
  avgDiscI: int("avgDiscI"), // InfluÃªncia (0-100)
  avgDiscS: int("avgDiscS"), // Estabilidade (0-100)
  avgDiscC: int("avgDiscC"), // Conformidade (0-100)
  
  // Perfis PsicomÃ©tricos MÃ©dios (Big Five)
  avgOpenness: int("avgOpenness"), // Abertura (0-100)
  avgConscientiousness: int("avgConscientiousness"), // Conscienciosidade (0-100)
  avgExtraversion: int("avgExtraversion"), // ExtroversÃ£o (0-100)
  avgAgreeableness: int("avgAgreeableness"), // Amabilidade (0-100)
  avgNeuroticism: int("avgNeuroticism"), // Neuroticismo (0-100)
  
  // Metadados
  sampleSize: int("sampleSize"), // Tamanho da amostra
  dataSource: varchar("dataSource", { length: 255 }), // Fonte dos dados
  year: int("year").notNull(), // Ano de referÃªncia
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type MarketBenchmark = typeof marketBenchmarks.$inferSelect;
export type InsertMarketBenchmark = typeof marketBenchmarks.$inferInsert;


// ============================================================================
// PDI INTELIGENTE - AÃ‡Ã•ES E ACOMPANHAMENTO (MODELO NADIA)
// ============================================================================

/**
 * AÃ§Ãµes do PDI Inteligente (Modelo 70-20-10)
 * Tabela de aÃ§Ãµes especÃ­ficas do plano de desenvolvimento com status e mÃ©tricas
 */
export const pdiActions = mysqlTable("pdiActions", {
  id: int("id").autoincrement().primaryKey(),
  planId: int("planId").notNull(), // Relacionamento com pdiPlans
  
  // InformaÃ§Ãµes da aÃ§Ã£o
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description").notNull(),
  axis: mysqlEnum("axis", ["70_pratica", "20_experiencia", "10_educacao"]).notNull(), // Eixo 70-20-10
  developmentArea: varchar("developmentArea", { length: 100 }).notNull(), // Ex: "VisÃ£o HolÃ­stica", "LideranÃ§a SÃªnior"
  
  // MÃ©trica de sucesso
  successMetric: text("successMetric").notNull(), // Como medir o sucesso
  evidenceRequired: text("evidenceRequired"), // EvidÃªncias necessÃ¡rias
  
  // ResponsÃ¡veis
  responsible: varchar("responsible", { length: 255 }).notNull(), // Ex: "Nadia C. (LÃ­der), Carlos M. (Sponsor)"
  
  // Prazo e status
  dueDate: datetime("dueDate").notNull(),
  status: mysqlEnum("status", ["nao_iniciado", "em_andamento", "concluido"]).default("nao_iniciado").notNull(),
  progress: int("progress").default(0).notNull(), // Percentual 0-100
  
  // Auditoria
  completedAt: datetime("completedAt"),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type PdiAction = typeof pdiActions.$inferSelect;
export type InsertPdiAction = typeof pdiActions.$inferInsert;

/**
 * Acompanhamento e Feedbacks do PDI (GovernanÃ§a DGC)
 * Registros de reuniÃµes de acompanhamento com Ã­ndice de prontidÃ£o
 */
export const pdiGovernanceReviews = mysqlTable("pdiGovernanceReviews", {
  id: int("id").autoincrement().primaryKey(),
  planId: int("planId").notNull(),
  
  // Data e responsÃ¡vel
  reviewDate: datetime("reviewDate").notNull(),
  reviewerId: int("reviewerId").notNull(), // Quem fez o acompanhamento (DGC, Gestor, Sponsor)
  reviewerRole: mysqlEnum("reviewerRole", ["dgc", "mentor", "sponsor"]).notNull(),
  
  // Ãndice de ProntidÃ£o para SucessÃ£o (IPS)
  readinessIndex: decimal("readinessIndex", { precision: 3, scale: 1 }).notNull(), // 1.0 a 5.0
  
  // Feedback
  keyPoints: text("keyPoints").notNull(), // Pontos-chave da reuniÃ£o
  strengths: text("strengths"), // Pontos fortes observados
  improvements: text("improvements"), // Ãreas de melhoria
  nextSteps: text("nextSteps"), // PrÃ³ximos passos
  
  // Auditoria
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type PdiGovernanceReview = typeof pdiGovernanceReviews.$inferSelect;
export type InsertPdiGovernanceReview = typeof pdiGovernanceReviews.$inferInsert;


// ============================================================================
// PESQUISAS DE PULSE (ENGAJAMENTO E CLIMA ORGANIZACIONAL)
// ============================================================================

/**
 * Pesquisas de Pulse - QuestionÃ¡rios rÃ¡pidos de clima e engajamento
 */
export const pulseSurveys = mysqlTable("pulseSurveys", {
  id: int("id").autoincrement().primaryKey(),
  
  // InformaÃ§Ãµes da pesquisa
  title: varchar("title", { length: 255 }).notNull(),
  question: text("question").notNull(),
  description: text("description"),
  
  // Status e controle
  status: mysqlEnum("status", ["draft", "active", "closed"]).default("draft").notNull(),
  
  // PÃºblico-alvo
  targetDepartmentId: int("targetDepartmentId"), // null = todos os departamentos
  targetEmployeeIds: json("targetEmployeeIds"), // Array de IDs especÃ­ficos (opcional)
  
  // CriaÃ§Ã£o e auditoria
  createdById: int("createdById").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
  
  // Datas de ativaÃ§Ã£o e encerramento
  activatedAt: datetime("activatedAt"),
  closedAt: datetime("closedAt"),
});

export type PulseSurvey = typeof pulseSurveys.$inferSelect;
export type InsertPulseSurvey = typeof pulseSurveys.$inferInsert;

/**
 * Respostas das Pesquisas de Pulse
 */
export const pulseSurveyResponses = mysqlTable("pulseSurveyResponses", {
  id: int("id").autoincrement().primaryKey(),
  
  // Relacionamentos
  surveyId: int("surveyId").notNull(),
  employeeId: int("employeeId"), // null = resposta anÃ´nima
  
  // Resposta
  rating: int("rating").notNull(), // 0-10
  comment: text("comment"),
  
  // Auditoria
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  ipAddress: varchar("ipAddress", { length: 45 }), // Para evitar duplicatas
});

export type PulseSurveyResponse = typeof pulseSurveyResponses.$inferSelect;
export type InsertPulseSurveyResponse = typeof pulseSurveyResponses.$inferInsert;

/**
 * HistÃ³rico de Envios de E-mail das Pesquisas Pulse
 */
export const pulseSurveyEmailLogs = mysqlTable("pulseSurveyEmailLogs", {
  id: int("id").autoincrement().primaryKey(),
  
  // Relacionamentos
  surveyId: int("surveyId").notNull(),
  employeeId: int("employeeId").notNull(),
  
  // Dados do envio
  email: varchar("email", { length: 320 }).notNull(),
  status: mysqlEnum("status", ["pending", "sent", "failed"]).default("pending").notNull(),
  
  // Controle de tentativas
  attemptCount: int("attemptCount").default(0).notNull(),
  lastAttemptAt: datetime("lastAttemptAt"),
  
  // Erro (se houver)
  errorMessage: text("errorMessage"),
  
  // Auditoria
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  sentAt: datetime("sentAt"),
});

export type PulseSurveyEmailLog = typeof pulseSurveyEmailLogs.$inferSelect;
export type InsertPulseSurveyEmailLog = typeof pulseSurveyEmailLogs.$inferInsert;


// ============================================================================
// DESCRIÃ‡ÃƒO DE CARGOS (JOB DESCRIPTIONS) - TEMPLATE UISA
// ============================================================================

/**
 * DescriÃ§Ãµes de Cargo - Baseado no template oficial UISA
 * Inclui: Objetivo, Responsabilidades, Conhecimentos, CompetÃªncias, QualificaÃ§Ãµes
 */
export const jobDescriptions = mysqlTable("jobDescriptions", {
  id: int("id").autoincrement().primaryKey(),
  
  // InformaÃ§Ãµes BÃ¡sicas (CabeÃ§alho)
  positionId: int("positionId").notNull(), // VinculaÃ§Ã£o com tabela positions
  positionTitle: varchar("positionTitle", { length: 255 }).notNull(), // Cargo
  departmentId: int("departmentId").notNull(),
  departmentName: varchar("departmentName", { length: 255 }).notNull(), // Depto
  cbo: varchar("cbo", { length: 50 }), // CÃ³digo Brasileiro de OcupaÃ§Ãµes
  division: varchar("division", { length: 255 }), // DivisÃ£o (ex: ADMINISTRATIVA)
  reportsTo: varchar("reportsTo", { length: 255 }), // Superior Imediato (ex: COORDENADOR PLANEJAMENTO CUSTOS)
  revision: varchar("revision", { length: 50 }), // NÃºmero da revisÃ£o
  
  // Objetivo Principal do Cargo
  mainObjective: text("mainObjective").notNull(),
  
  // Treinamento ObrigatÃ³rio
  mandatoryTraining: json("mandatoryTraining"), // Array de strings
  
  // QualificaÃ§Ã£o Desejada
  educationLevel: varchar("educationLevel", { length: 255 }), // Ex: Ensino Superior
  requiredExperience: text("requiredExperience"), // Ex: DesejÃ¡vel de 4 a 6 anos no cargo ou posiÃ§Ãµes similares
  
  // e-Social
  eSocialSpecs: text("eSocialSpecs"), // EspecificaÃ§Ãµes do Programa de Medicina e SeguranÃ§a do Trabalho
  
  // Status e Workflow
  status: mysqlEnum("status", ["draft", "pending_occupant", "pending_manager", "pending_hr", "approved", "rejected"]).default("draft").notNull(),
  
  // Auditoria
  createdById: int("createdById").notNull(),
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
  approvedAt: datetime("approvedAt"),
});

export type JobDescription = typeof jobDescriptions.$inferSelect;
export type InsertJobDescription = typeof jobDescriptions.$inferInsert;

/**
 * Responsabilidades do Cargo - Agrupadas por categoria
 */
export const jobResponsibilities = mysqlTable("jobResponsibilities", {
  id: int("id").autoincrement().primaryKey(),
  
  jobDescriptionId: int("jobDescriptionId").notNull(),
  
  // Categoria da responsabilidade
  category: varchar("category", { length: 100 }).notNull(), // Ex: Processo, AnÃ¡lise KPI, Planejamento, Budget/Capex/Forecast, Resultados
  
  // DescriÃ§Ã£o da responsabilidade
  description: text("description").notNull(),
  
  // Ordem de exibiÃ§Ã£o
  displayOrder: int("displayOrder").default(0).notNull(),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type JobResponsibility = typeof jobResponsibilities.$inferSelect;
export type InsertJobResponsibility = typeof jobResponsibilities.$inferInsert;

/**
 * Conhecimentos TÃ©cnicos - Com nÃ­veis de proficiÃªncia
 */
export const jobKnowledge = mysqlTable("jobKnowledge", {
  id: int("id").autoincrement().primaryKey(),
  
  jobDescriptionId: int("jobDescriptionId").notNull(),
  
  // Nome do conhecimento tÃ©cnico
  name: varchar("name", { length: 255 }).notNull(), // Ex: Office, AnÃ¡lise Processos, Processo Produtivo e TransformaÃ§Ã£o AÃ§Ãºcar e Ãlcool
  
  // NÃ­vel de proficiÃªncia
  level: mysqlEnum("level", ["basico", "intermediario", "avancado", "obrigatorio"]).notNull(),
  
  // Ordem de exibiÃ§Ã£o
  displayOrder: int("displayOrder").default(0).notNull(),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type JobKnowledge = typeof jobKnowledge.$inferSelect;
export type InsertJobKnowledge = typeof jobKnowledge.$inferInsert;

/**
 * CompetÃªncias e Habilidades - Grid 2 colunas
 */
export const jobCompetencies = mysqlTable("jobCompetencies", {
  id: int("id").autoincrement().primaryKey(),
  
  jobDescriptionId: int("jobDescriptionId").notNull(),
  
  // Nome da competÃªncia/habilidade
  name: varchar("name", { length: 255 }).notNull(), // Ex: Planejamento, OrganizaÃ§Ã£o e Controle, ComunicaÃ§Ã£o, AnÃ¡lise e SoluÃ§Ã£o de Problemas
  
  // Tipo (para organizar em colunas)
  type: mysqlEnum("type", ["competencia", "habilidade"]).default("competencia").notNull(),
  
  // Ordem de exibiÃ§Ã£o
  displayOrder: int("displayOrder").default(0).notNull(),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type JobCompetency = typeof jobCompetencies.$inferSelect;
export type InsertJobCompetency = typeof jobCompetencies.$inferInsert;

/**
 * AprovaÃ§Ãµes de DescriÃ§Ã£o de Cargo - Workflow 3 nÃ­veis
 */
export const jobDescriptionApprovals = mysqlTable("jobDescriptionApprovals", {
  id: int("id").autoincrement().primaryKey(),
  
  jobDescriptionId: int("jobDescriptionId").notNull(),
  
  // NÃ­vel de aprovaÃ§Ã£o
  approvalLevel: mysqlEnum("approvalLevel", ["occupant", "manager", "hr"]).notNull(), // Ocupante do Cargo, Superior Imediato, Gerente de RH
  
  // Aprovador
  approverId: int("approverId").notNull(),
  approverName: varchar("approverName", { length: 255 }).notNull(),
  
  // Status da aprovaÃ§Ã£o
  status: mysqlEnum("status", ["pending", "approved", "rejected"]).default("pending").notNull(),
  
  // ComentÃ¡rios
  comments: text("comments"),
  
  // Datas
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  decidedAt: datetime("decidedAt"),
});

export type JobDescriptionApproval = typeof jobDescriptionApprovals.$inferSelect;
export type InsertJobDescriptionApproval = typeof jobDescriptionApprovals.$inferInsert;

// ============================================================================
// REGISTRO DE ATIVIDADES E TAREFAS
// ============================================================================

/**
 * Atividades Manuais - Registradas pelo funcionÃ¡rio
 */
export const employeeActivities = mysqlTable("employeeActivities", {
  id: int("id").autoincrement().primaryKey(),
  
  // Relacionamentos
  employeeId: int("employeeId").notNull(),
  jobDescriptionId: int("jobDescriptionId"), // VinculaÃ§Ã£o com descriÃ§Ã£o de cargo (opcional)
  responsibilityId: int("responsibilityId"), // VinculaÃ§Ã£o com responsabilidade especÃ­fica (opcional)
  
  // InformaÃ§Ãµes da atividade
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description"),
  category: mysqlEnum("category", ["reuniao", "analise", "planejamento", "execucao", "suporte", "outros"]).notNull(),
  
  // Tempo
  activityDate: datetime("activityDate").notNull(),
  startTime: varchar("startTime", { length: 5 }), // HH:MM
  endTime: varchar("endTime", { length: 5 }), // HH:MM
  durationMinutes: int("durationMinutes"), // Calculado automaticamente
  
  // Auditoria
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type EmployeeActivity = typeof employeeActivities.$inferSelect;
export type InsertEmployeeActivity = typeof employeeActivities.$inferInsert;

/**
 * Logs de Atividades AutomÃ¡ticas - Coletadas pelo sistema
 */
export const activityLogs = mysqlTable("activityLogs", {
  id: int("id").autoincrement().primaryKey(),
  
  // Relacionamentos
  employeeId: int("employeeId").notNull(),
  userId: int("userId").notNull(),
  
  // Tipo de atividade
  activityType: varchar("activityType", { length: 100 }).notNull(), // Ex: login, logout, create_goal, update_pdi, submit_evaluation
  
  // Detalhes da atividade
  activityDescription: varchar("activityDescription", { length: 500 }),
  entityType: varchar("entityType", { length: 100 }), // Ex: goal, pdi, evaluation, feedback
  entityId: int("entityId"), // ID da entidade relacionada
  
  // Metadados
  metadata: json("metadata"), // Dados adicionais (ex: IP, user agent, etc)
  
  // Auditoria
  createdAt: timestamp("createdAt").defaultNow().notNull(),
});

export type ActivityLog = typeof activityLogs.$inferSelect;
export type InsertActivityLog = typeof activityLogs.$inferInsert;

// Re-export from schema-alerts.ts
export * from "./schema-alerts";


========================================
ARQUIVO: ./drizzle/schema-alerts.ts
========================================
import { int, mysqlTable, text, timestamp, varchar, mysqlEnum, decimal } from "drizzle-orm/mysql-core";
import { employees } from "./schema";

/**
 * Sistema de Alertas de Produtividade
 * Centraliza todos os alertas gerados automaticamente pelo sistema
 */
export const alerts = mysqlTable("alerts", {
  id: int("id").autoincrement().primaryKey(),
  employeeId: int("employeeId").notNull().references(() => employees.id),
  
  // Tipo e severidade do alerta
  type: mysqlEnum("type", [
    "low_productivity",
    "inconsistent_hours",
    "low_diversity",
    "missing_activities",
    "time_discrepancy",
    "goal_overdue",
    "evaluation_pending"
  ]).notNull(),
  severity: mysqlEnum("severity", ["critical", "high", "medium", "low"]).notNull(),
  
  // ConteÃºdo do alerta
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description").notNull(),
  
  // MÃ©tricas relacionadas (JSON)
  metrics: text("metrics"), // JSON: { efficiency: 0.45, consistency: 0.3, etc }
  
  // Status e aÃ§Ãµes
  status: mysqlEnum("status", ["active", "resolved", "dismissed"]).default("active").notNull(),
  resolvedBy: int("resolvedBy").references(() => employees.id),
  resolvedAt: timestamp("resolvedAt"),
  resolutionNotes: text("resolutionNotes"),
  
  // AÃ§Ãµes tomadas
  actionTaken: mysqlEnum("actionTaken", [
    "email_sent",
    "meeting_scheduled",
    "warning_issued",
    "training_assigned",
    "none"
  ]),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

/**
 * Registros de Ponto EletrÃ´nico
 * Armazena dados importados do sistema de ponto para comparaÃ§Ã£o
 */
export const timeClockRecords = mysqlTable("timeClockRecords", {
  id: int("id").autoincrement().primaryKey(),
  employeeId: int("employeeId").notNull().references(() => employees.id),
  
  // Data e horÃ¡rios
  date: timestamp("date").notNull(),
  clockIn: timestamp("clockIn"),
  clockOut: timestamp("clockOut"),
  
  // Horas calculadas (em minutos)
  totalMinutes: int("totalMinutes"), // Total de minutos trabalhados
  breakMinutes: int("breakMinutes").default(0), // Minutos de intervalo
  workedMinutes: int("workedMinutes"), // totalMinutes - breakMinutes
  
  // Tipo de registro
  recordType: mysqlEnum("recordType", [
    "normal",
    "overtime",
    "absence",
    "late",
    "early_leave",
    "holiday"
  ]).default("normal").notNull(),
  
  // LocalizaÃ§Ã£o (se disponÃ­vel)
  location: varchar("location", { length: 255 }),
  
  // ObservaÃ§Ãµes
  notes: text("notes"),
  
  // ImportaÃ§Ã£o
  importedAt: timestamp("importedAt").defaultNow().notNull(),
  importSource: varchar("importSource", { length: 100 }), // "manual", "api", "csv"
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

/**
 * DiscrepÃ¢ncias entre Atividades e Ponto
 * Identifica inconsistÃªncias entre horas registradas manualmente e ponto eletrÃ´nico
 */
export const timeDiscrepancies = mysqlTable("timeDiscrepancies", {
  id: int("id").autoincrement().primaryKey(),
  employeeId: int("employeeId").notNull().references(() => employees.id),
  
  // PerÃ­odo da discrepÃ¢ncia
  date: timestamp("date").notNull(),
  
  // Horas registradas (em minutos)
  clockMinutes: int("clockMinutes").notNull(), // Do ponto eletrÃ´nico
  activityMinutes: int("activityMinutes").notNull(), // Das atividades manuais
  
  // DiferenÃ§a
  differenceMinutes: int("differenceMinutes").notNull(), // clockMinutes - activityMinutes
  differencePercentage: decimal("differencePercentage", { precision: 5, scale: 2 }), // % de diferenÃ§a
  
  // ClassificaÃ§Ã£o
  discrepancyType: mysqlEnum("discrepancyType", [
    "over_reported", // Mais atividades que ponto
    "under_reported", // Menos atividades que ponto
    "acceptable" // DiferenÃ§a < 10%
  ]).notNull(),
  
  // Status
  status: mysqlEnum("status", ["pending", "reviewed", "justified", "flagged"]).default("pending").notNull(),
  reviewedBy: int("reviewedBy").references(() => employees.id),
  reviewedAt: timestamp("reviewedAt"),
  justification: text("justification"),
  
  // Alerta gerado
  alertId: int("alertId").references(() => alerts.id),
  
  createdAt: timestamp("createdAt").defaultNow().notNull(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow().notNull(),
});

export type Alert = typeof alerts.$inferSelect;
export type InsertAlert = typeof alerts.$inferInsert;

export type TimeClockRecord = typeof timeClockRecords.$inferSelect;
export type InsertTimeClockRecord = typeof timeClockRecords.$inferInsert;

export type TimeDiscrepancy = typeof timeDiscrepancies.$inferSelect;
export type InsertTimeDiscrepancy = typeof timeDiscrepancies.$inferInsert;


========================================
ARQUIVO: ./examples/email-service-example.ts
========================================
/**
 * Exemplos de Uso do EmailService V2
 * Sistema AVD UISA
 * 
 * Este arquivo demonstra como usar o EmailService para enviar
 * diferentes tipos de e-mails no sistema.
 */

import {
  EmailService,
  getEmailService,
  sendPDIActionOverdueEmail,
  getPDIActionOverdueTemplate,
  getWelcomeTemplate
} from '../src/utils/email-service-v2';

// ============================================
// EXEMPLO 1: Envio Simples de E-mail
// ============================================

async function exemploEnvioSimples() {
  console.log('ðŸ“§ Exemplo 1: Envio Simples de E-mail\n');

  const emailService = getEmailService();

  // Verificar se o serviÃ§o estÃ¡ funcionando
  const isWorking = await emailService.verify();
  console.log(`ServiÃ§o de e-mail: ${isWorking ? 'âœ… OK' : 'âŒ Falhou'}\n`);

  // Enviar e-mail simples
  const result = await emailService.sendEmail(
    {
      to: 'colaborador@uisa.com.br',
      subject: 'Teste de E-mail',
      html: '<h1>OlÃ¡!</h1><p>Este Ã© um e-mail de teste.</p>'
    },
    'test'
  );

  console.log('Resultado:', result);
  console.log('---\n');
}

// ============================================
// EXEMPLO 2: E-mail de AÃ§Ã£o de PDI Vencida
// ============================================

async function exemploAcaoPDIVencida() {
  console.log('ðŸ“§ Exemplo 2: E-mail de AÃ§Ã£o de PDI Vencida\n');

  const result = await sendPDIActionOverdueEmail({
    employeeEmail: 'joao.silva@uisa.com.br',
    employeeName: 'JoÃ£o Silva',
    actionTitle: 'Curso de LideranÃ§a EstratÃ©gica',
    actionDescription: 'Completar o curso online de LideranÃ§a EstratÃ©gica na plataforma Coursera',
    dueDate: '15/11/2025',
    daysOverdue: 2,
    managerName: 'Maria Santos',
    managerEmail: 'maria.santos@uisa.com.br',
    pdiUrl: 'https://avd.uisa.com.br/pdi/12345'
  });

  console.log('âœ… E-mail enviado com sucesso!');
  console.log(`   Message ID: ${result.messageId}`);
  console.log(`   Tentativas: ${result.attempts}`);
  console.log(`   Tempo de entrega: ${result.deliveryTime}ms`);
  console.log('---\n');
}

// ============================================
// EXEMPLO 3: E-mail de Boas-Vindas
// ============================================

async function exemploBemVindo() {
  console.log('ðŸ“§ Exemplo 3: E-mail de Boas-Vindas\n');

  const emailService = getEmailService();

  const html = getWelcomeTemplate({
    userName: 'Pedro Oliveira',
    email: 'pedro.oliveira@uisa.com.br',
    temporaryPassword: 'Temp@2025!abc',
    loginUrl: 'https://avd.uisa.com.br/login'
  });

  const result = await emailService.sendEmail(
    {
      to: 'pedro.oliveira@uisa.com.br',
      subject: 'ðŸŽ‰ Bem-vindo ao Sistema AVD UISA!',
      html
    },
    'welcome'
  );

  console.log('âœ… E-mail de boas-vindas enviado!');
  console.log(`   Message ID: ${result.messageId}`);
  console.log('---\n');
}

// ============================================
// EXEMPLO 4: Envio em Lote
// ============================================

async function exemploEnvioLote() {
  console.log('ðŸ“§ Exemplo 4: Envio em Lote\n');

  const emailService = getEmailService();

  const emails = [
    {
      options: {
        to: 'usuario1@uisa.com.br',
        subject: 'Lembrete de Meta',
        html: '<p>Sua meta vence em 7 dias!</p>'
      },
      type: 'goal_reminder'
    },
    {
      options: {
        to: 'usuario2@uisa.com.br',
        subject: 'Lembrete de Meta',
        html: '<p>Sua meta vence em 7 dias!</p>'
      },
      type: 'goal_reminder'
    },
    {
      options: {
        to: 'usuario3@uisa.com.br',
        subject: 'Lembrete de Meta',
        html: '<p>Sua meta vence em 7 dias!</p>'
      },
      type: 'goal_reminder'
    }
  ];

  const results = await emailService.sendBatch(emails);

  console.log(`âœ… ${results.filter(r => r.success).length}/${results.length} e-mails enviados com sucesso!`);
  console.log('---\n');
}

// ============================================
// EXEMPLO 5: EstatÃ­sticas de Envio
// ============================================

async function exemploEstatisticas() {
  console.log('ðŸ“§ Exemplo 5: EstatÃ­sticas de Envio\n');

  const emailService = getEmailService();

  // Enviar alguns e-mails primeiro
  await emailService.sendEmail(
    {
      to: 'teste1@uisa.com.br',
      subject: 'Teste 1',
      html: '<p>Teste</p>'
    },
    'test'
  );

  await emailService.sendEmail(
    {
      to: 'teste2@uisa.com.br',
      subject: 'Teste 2',
      html: '<p>Teste</p>'
    },
    'test'
  );

  // Obter estatÃ­sticas
  const stats = emailService.getStats();

  console.log('ðŸ“Š EstatÃ­sticas de Envio:');
  console.log(`   Total de e-mails: ${stats.total}`);
  console.log(`   Bem-sucedidos: ${stats.successful}`);
  console.log(`   Falhados: ${stats.failed}`);
  console.log(`   Taxa de sucesso: ${stats.successRate.toFixed(2)}%`);
  console.log(`   Tempo mÃ©dio de entrega: ${stats.avgDeliveryTime}ms`);
  console.log(`   Fila de falhas: ${stats.failedQueueSize}`);
  console.log('---\n');
}

// ============================================
// EXEMPLO 6: Retry de E-mails Falhados
// ============================================

async function exemploRetryFalhados() {
  console.log('ðŸ“§ Exemplo 6: Retry de E-mails Falhados\n');

  const emailService = getEmailService();

  // Simular envio que pode falhar
  await emailService.sendEmail(
    {
      to: 'email-invalido@dominio-inexistente.com',
      subject: 'Teste de Falha',
      html: '<p>Este e-mail pode falhar</p>'
    },
    'test'
  );

  // Tentar reenviar e-mails falhados
  console.log('ðŸ”„ Tentando reenviar e-mails falhados...');
  const results = await emailService.retryFailed();

  console.log(`   ${results.filter(r => r.success).length}/${results.length} e-mails reenviados com sucesso`);
  console.log('---\n');
}

// ============================================
// EXEMPLO 7: E-mail com Anexo
// ============================================

async function exemploComAnexo() {
  console.log('ðŸ“§ Exemplo 7: E-mail com Anexo\n');

  const emailService = getEmailService();

  const result = await emailService.sendEmail(
    {
      to: 'colaborador@uisa.com.br',
      subject: 'RelatÃ³rio de Desempenho',
      html: '<h2>RelatÃ³rio de Desempenho</h2><p>Segue em anexo seu relatÃ³rio de desempenho do Ãºltimo trimestre.</p>',
      attachments: [
        {
          filename: 'relatorio-q4-2025.pdf',
          path: '/path/to/relatorio.pdf' // ou use 'content' com Buffer
        }
      ]
    },
    'performance_report'
  );

  console.log('âœ… E-mail com anexo enviado!');
  console.log(`   Message ID: ${result.messageId}`);
  console.log('---\n');
}

// ============================================
// EXEMPLO 8: E-mail com CÃ³pia (CC e BCC)
// ============================================

async function exemploComCopia() {
  console.log('ðŸ“§ Exemplo 8: E-mail com CÃ³pia (CC e BCC)\n');

  const emailService = getEmailService();

  const result = await emailService.sendEmail(
    {
      to: 'colaborador@uisa.com.br',
      cc: 'gestor@uisa.com.br', // CÃ³pia visÃ­vel
      bcc: 'rh@uisa.com.br', // CÃ³pia oculta
      subject: 'Feedback de Desempenho',
      html: '<h2>Feedback de Desempenho</h2><p>ParabÃ©ns pelo excelente trabalho!</p>'
    },
    'feedback'
  );

  console.log('âœ… E-mail com cÃ³pias enviado!');
  console.log(`   Para: colaborador@uisa.com.br`);
  console.log(`   CC: gestor@uisa.com.br`);
  console.log(`   BCC: rh@uisa.com.br`);
  console.log('---\n');
}

// ============================================
// EXEMPLO 9: Job Agendado (Cron)
// ============================================

/**
 * Este exemplo mostra como criar um job agendado para enviar
 * lembretes de PDI diariamente Ã s 9h da manhÃ£.
 * 
 * Para usar em produÃ§Ã£o, configure no wrangler.toml:
 * 
 * [[triggers.crons]]
 * cron = "0 9 * * *"  # Todo dia Ã s 9h
 */
async function jobLembretesPDI() {
  console.log('ðŸ“§ Exemplo 9: Job Agendado - Lembretes de PDI\n');

  // Buscar aÃ§Ãµes de PDI vencidas (exemplo)
  const acoesVencidas = [
    {
      employeeEmail: 'joao.silva@uisa.com.br',
      employeeName: 'JoÃ£o Silva',
      actionTitle: 'Curso de Excel AvanÃ§ado',
      actionDescription: 'Completar curso de Excel AvanÃ§ado',
      dueDate: '10/11/2025',
      daysOverdue: 7,
      managerName: 'Maria Santos',
      managerEmail: 'maria.santos@uisa.com.br',
      pdiUrl: 'https://avd.uisa.com.br/pdi/12345'
    },
    {
      employeeEmail: 'ana.costa@uisa.com.br',
      employeeName: 'Ana Costa',
      actionTitle: 'Workshop de ComunicaÃ§Ã£o',
      actionDescription: 'Participar do workshop de comunicaÃ§Ã£o assertiva',
      dueDate: '12/11/2025',
      daysOverdue: 5,
      managerName: 'Carlos Pereira',
      managerEmail: 'carlos.pereira@uisa.com.br',
      pdiUrl: 'https://avd.uisa.com.br/pdi/67890'
    }
  ];

  console.log(`ðŸ“‹ Encontradas ${acoesVencidas.length} aÃ§Ãµes vencidas`);
  console.log('ðŸ“¤ Enviando lembretes...\n');

  for (const acao of acoesVencidas) {
    const result = await sendPDIActionOverdueEmail(acao);
    
    if (result.success) {
      console.log(`   âœ… ${acao.employeeName} - ${acao.actionTitle}`);
    } else {
      console.log(`   âŒ ${acao.employeeName} - Falhou: ${result.error}`);
    }
  }

  console.log('\nâœ… Job de lembretes concluÃ­do!');
  console.log('---\n');
}

// ============================================
// EXEMPLO 10: MÃ©tricas Detalhadas
// ============================================

async function exemploMetricasDetalhadas() {
  console.log('ðŸ“§ Exemplo 10: MÃ©tricas Detalhadas\n');

  const emailService = getEmailService();

  // Enviar alguns e-mails
  await emailService.sendEmail(
    { to: 'teste1@uisa.com.br', subject: 'Teste 1', html: '<p>Teste 1</p>' },
    'test'
  );

  await emailService.sendEmail(
    { to: 'teste2@uisa.com.br', subject: 'Teste 2', html: '<p>Teste 2</p>' },
    'welcome'
  );

  await emailService.sendEmail(
    { to: 'teste3@uisa.com.br', subject: 'Teste 3', html: '<p>Teste 3</p>' },
    'pdi_action_overdue'
  );

  // Obter mÃ©tricas detalhadas
  const metrics = emailService.getMetrics();

  console.log('ðŸ“Š MÃ©tricas Detalhadas:\n');
  
  metrics.forEach((metric, index) => {
    console.log(`${index + 1}. ${metric.type}`);
    console.log(`   Para: ${metric.to}`);
    console.log(`   Status: ${metric.success ? 'âœ… Sucesso' : 'âŒ Falhou'}`);
    console.log(`   Tempo: ${metric.deliveryTime}ms`);
    console.log(`   Enviado em: ${metric.sentAt.toLocaleString('pt-BR')}`);
    if (metric.messageId) {
      console.log(`   Message ID: ${metric.messageId}`);
    }
    if (metric.error) {
      console.log(`   Erro: ${metric.error}`);
    }
    console.log();
  });

  console.log('---\n');
}

// ============================================
// EXECUTAR TODOS OS EXEMPLOS
// ============================================

async function executarTodosExemplos() {
  console.log('='.repeat(60));
  console.log('EXEMPLOS DE USO DO EMAIL SERVICE V2');
  console.log('Sistema AVD UISA');
  console.log('='.repeat(60));
  console.log();

  try {
    await exemploEnvioSimples();
    await exemploAcaoPDIVencida();
    await exemploBemVindo();
    await exemploEnvioLote();
    await exemploEstatisticas();
    await exemploRetryFalhados();
    await exemploComAnexo();
    await exemploComCopia();
    await jobLembretesPDI();
    await exemploMetricasDetalhadas();

    console.log('='.repeat(60));
    console.log('âœ… TODOS OS EXEMPLOS EXECUTADOS COM SUCESSO!');
    console.log('='.repeat(60));

  } catch (error) {
    console.error('âŒ Erro ao executar exemplos:', error);
  }
}

// Executar se for chamado diretamente
if (require.main === module) {
  executarTodosExemplos();
}

// Exportar funÃ§Ãµes para uso em outros arquivos
export {
  exemploEnvioSimples,
  exemploAcaoPDIVencida,
  exemploBemVindo,
  exemploEnvioLote,
  exemploEstatisticas,
  exemploRetryFalhados,
  exemploComAnexo,
  exemploComCopia,
  jobLembretesPDI,
  exemploMetricasDetalhadas,
  executarTodosExemplos
};


========================================
ARQUIVO: ./scripts/check-employee-ids.ts
========================================
import { getDb } from "../server/db";
import { smartGoals, employees, users } from "../drizzle/schema";
import { eq } from "drizzle-orm";

async function checkEmployeeIds() {
  const db = await getDb();
  if (!db) {
    console.error("âŒ Banco de dados nÃ£o disponÃ­vel");
    process.exit(1);
  }

  console.log("ðŸ” Verificando relacionamento entre users, employees e smartGoals...\n");

  // Buscar usuÃ¡rio admin
  const [user] = await db.select().from(users).where(eq(users.id, 1)).limit(1);
  console.log("ðŸ‘¤ UsuÃ¡rio:", user?.name, "| ID:", user?.id);

  // Buscar employee vinculado ao usuÃ¡rio
  const [employee] = await db.select().from(employees).where(eq(employees.userId, 1)).limit(1);
  console.log("ðŸ‘” Employee:", employee?.name, "| ID:", employee?.id, "| userId:", employee?.userId);

  // Buscar metas
  console.log("\nðŸ“‹ Metas no banco de dados:");
  const goals = await db
    .select({
      id: smartGoals.id,
      title: smartGoals.title,
      employeeId: smartGoals.employeeId,
      createdBy: smartGoals.createdBy,
    })
    .from(smartGoals)
    .limit(10);

  goals.forEach((goal) => {
    console.log(`ID: ${goal.id} | employeeId: ${goal.employeeId} | createdBy: ${goal.createdBy}`);
    console.log(`   TÃ­tulo: ${goal.title}`);
  });

  console.log("\nðŸ”§ PROBLEMA IDENTIFICADO:");
  if (employee) {
    console.log(`âœ… Employee existe com ID ${employee.id}`);
    console.log(`âŒ Metas estÃ£o usando employeeId incorreto ou NULL`);
    console.log(`\nðŸ’¡ SOLUÃ‡ÃƒO: Atualizar metas para usar employeeId = ${employee.id}`);
  } else {
    console.log(`âŒ Nenhum employee vinculado ao userId = 1`);
    console.log(`\nðŸ’¡ SOLUÃ‡ÃƒO: Criar employee para o usuÃ¡rio admin`);
  }

  process.exit(0);
}

checkEmployeeIds();


========================================
ARQUIVO: ./scripts/check-goal-ids.ts
========================================
import { getDb } from "../server/db";
import { smartGoals } from "../drizzle/schema";

async function checkGoalIds() {
  const db = await getDb();
  if (!db) {
    console.error("âŒ Banco de dados nÃ£o disponÃ­vel");
    process.exit(1);
  }

  console.log("ðŸ” Buscando IDs das metas no banco de dados...\n");

  const goals = await db
    .select({
      id: smartGoals.id,
      title: smartGoals.title,
      status: smartGoals.status,
      progress: smartGoals.progress,
    })
    .from(smartGoals)
    .orderBy(smartGoals.id)
    .limit(10);

  console.log(`âœ… Encontradas ${goals.length} metas:\n`);
  
  goals.forEach((goal) => {
    console.log(`ID: ${goal.id} | Status: ${goal.status} | Progresso: ${goal.progress}%`);
    console.log(`   TÃ­tulo: ${goal.title}`);
    console.log("");
  });

  process.exit(0);
}

checkGoalIds();


========================================
ARQUIVO: ./scripts/check-goalApprovals-columns.ts
========================================
import { getDb } from "../server/db";

async function checkColumns() {
  const db = await getDb();
  if (!db) {
    console.error("âŒ Banco de dados nÃ£o disponÃ­vel");
    process.exit(1);
  }

  console.log("ðŸ” Verificando colunas da tabela goalApprovals...\n");

  const [rows] = await db.execute("DESCRIBE goalApprovals");
  
  console.log("Colunas encontradas:");
  console.table(rows);

  process.exit(0);
}

checkColumns();


========================================
ARQUIVO: ./scripts/check-goalComments-columns.ts
========================================
import { getDb } from "../server/db";

async function checkColumns() {
  const db = await getDb();
  if (!db) {
    console.error("âŒ Banco de dados nÃ£o disponÃ­vel");
    process.exit(1);
  }

  console.log("ðŸ” Verificando colunas da tabela goalComments...\n");

  const [rows] = await db.execute("DESCRIBE goalComments");
  
  console.log("Colunas encontradas:");
  console.table(rows);

  process.exit(0);
}

checkColumns();


========================================
ARQUIVO: ./scripts/import-from-excel.ts
========================================
import { drizzle } from "drizzle-orm/mysql2";
import { eq } from "drizzle-orm";
import * as schema from "../drizzle/schema";
import XLSX from "xlsx";
import * as path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Conectar ao banco
const db = drizzle(process.env.DATABASE_URL!);

async function importFromExcel() {
  console.log("ðŸš€ Iniciando importaÃ§Ã£o de dados dos arquivos Excel...\n");

  try {
    // Ler arquivo de seÃ§Ãµes
    const sectionsPath = "/home/ubuntu/upload/secoes.xlsx";
    console.log(`ðŸ“ Lendo arquivo: ${sectionsPath}`);
    const sectionsWorkbook = XLSX.readFile(sectionsPath);
    const sectionsSheet = sectionsWorkbook.Sheets[sectionsWorkbook.SheetNames[0]];
    const sectionsData = XLSX.utils.sheet_to_json(sectionsSheet);
    
    console.log(`   âœ… ${sectionsData.length} seÃ§Ãµes encontradas\n`);

    // Ler arquivo de funcionÃ¡rios
    const employeesPath = "/home/ubuntu/upload/funcionarios.xlsx";
    console.log(`ðŸ“ Lendo arquivo: ${employeesPath}`);
    const employeesWorkbook = XLSX.readFile(employeesPath);
    const employeesSheet = employeesWorkbook.Sheets[employeesWorkbook.SheetNames[0]];
    const employeesData = XLSX.utils.sheet_to_json(employeesSheet);
    
    console.log(`   âœ… ${employeesData.length} funcionÃ¡rios encontrados\n`);

    // 1. Importar departamentos
    console.log("ðŸ“ Importando departamentos...");
    let departmentCount = 0;
    const departmentMap = new Map<string, number>();

    for (const row of sectionsData as any[]) {
      const code = row['CÃ³digo'] || row['Codigo'] || row['CÃ“DIGO'] || row['CODIGO'];
      const name = row['DescriÃ§Ã£o'] || row['Descricao'] || row['DESCRIÃ‡ÃƒO'] || row['DESCRICAO'] || row['Nome'] || row['NOME'];
      
      if (!code || !name) continue;

      try {
        const result = await db.insert(schema.departments).values({
          name: String(name).trim(),
          code: String(code).trim(),
        }).onDuplicateKeyUpdate({
          set: { name: String(name).trim() },
        });
        
        // Buscar ID do departamento criado
        const [dept] = await db.select().from(schema.departments).where(
          eq(schema.departments.code, String(code).trim())
        ).limit(1);
        
        if (dept) {
          departmentMap.set(String(code).trim(), dept.id);
        }
        
        departmentCount++;
      } catch (error: any) {
        console.error(`   âŒ Erro ao importar departamento ${name}:`, error.message);
      }
    }
    console.log(`   âœ… ${departmentCount} departamentos importados\n`);

    // 2. Criar cargos Ãºnicos
    console.log("ðŸ’¼ Processando cargos...");
    const uniquePositions = new Map<string, any>();
    
    for (const row of employeesData as any[]) {
      const position = row['Cargo'] || row['CARGO'] || row['cargo'];
      if (position && !uniquePositions.has(String(position).trim())) {
        const posTitle = String(position).trim();
        uniquePositions.set(posTitle, {
          code: posTitle.substring(0, 50).replace(/[^a-zA-Z0-9]/g, '_').toUpperCase(),
          title: posTitle,
          level: "junior",
          description: null,
        });
      }
    }

    let positionCount = 0;
    const positionMap = new Map<string, number>();

    for (const [title, posData] of uniquePositions) {
      try {
        await db.insert(schema.positions).values(posData).onDuplicateKeyUpdate({
          set: { title: posData.title, code: posData.code },
        });
        
        // Buscar ID do cargo criado
        const [pos] = await db.select().from(schema.positions).where(
          eq(schema.positions.title, title)
        ).limit(1);
        
        if (pos) {
          positionMap.set(title, pos.id);
        }
        
        positionCount++;
      } catch (error: any) {
        console.error(`   âŒ Erro ao importar cargo ${title}:`, error.message);
      }
    }
    console.log(`   âœ… ${positionCount} cargos importados\n`);

    // 3. Importar funcionÃ¡rios
    console.log("ðŸ‘¥ Importando funcionÃ¡rios...");
    let employeeCount = 0;
    let errorCount = 0;

    for (const row of employeesData as any[]) {
      try {
        const chapa = row['Chapa'] || row['CHAPA'] || row['chapa'];
        const name = row['Nome'] || row['NOME'] || row['nome'];
        const position = row['Cargo'] || row['CARGO'] || row['cargo'];
        const sectionCode = row['SeÃ§Ã£o'] || row['SEÃ‡ÃƒO'] || row['secao'] || row['Secao'];
        const emailCorp = row['E-mail Corporativo'] || row['Email Corporativo'] || row['email_corporativo'];
        const emailPers = row['E-mail Pessoal'] || row['Email Pessoal'] || row['email_pessoal'];
        const phone = row['Telefone'] || row['TELEFONE'] || row['telefone'];

        if (!chapa || !name) {
          continue;
        }

        const departmentId = sectionCode ? departmentMap.get(String(sectionCode).trim()) : null;
        const positionId = position ? positionMap.get(String(position).trim()) : null;

        await db.insert(schema.employees).values({
          employeeCode: String(chapa).trim(),
          name: String(name).trim(),
          email: emailCorp ? String(emailCorp).trim() : "sem-email@uisa.com.br",
          hireDate: new Date(),
          departmentId: departmentId || 1,
          positionId: positionId || 1,
          phone: phone ? String(phone).trim() : null,
          status: "ativo",
        }).onDuplicateKeyUpdate({
          set: {
            name: String(name).trim(),
            email: emailCorp ? String(emailCorp).trim() : "sem-email@uisa.com.br",
          },
        });

        employeeCount++;

        if (employeeCount % 100 === 0) {
          console.log(`   ðŸ“ ${employeeCount} funcionÃ¡rios processados...`);
        }
      } catch (error: any) {
        errorCount++;
        if (errorCount <= 10) {
          console.error(`   âŒ Erro ao importar funcionÃ¡rio:`, error.message);
        }
      }
    }

    console.log(`\nâœ… ImportaÃ§Ã£o concluÃ­da!`);
    console.log(`   - ${departmentCount} departamentos`);
    console.log(`   - ${positionCount} cargos`);
    console.log(`   - ${employeeCount} funcionÃ¡rios`);
    if (errorCount > 0) {
      console.log(`   - ${errorCount} erros encontrados`);
    }

  } catch (error) {
    console.error("\nâŒ Erro fatal na importaÃ§Ã£o:", error);
    process.exit(1);
  }
}

importFromExcel()
  .then(() => {
    console.log("\nðŸŽ‰ Processo finalizado com sucesso!");
    process.exit(0);
  })
  .catch((error) => {
    console.error("\nðŸ’¥ Erro fatal:", error);
    process.exit(1);
  });


========================================
ARQUIVO: ./scripts/import-real-data.ts
========================================
import { drizzle } from "drizzle-orm/mysql2";
import * as schema from "../drizzle/schema";
import * as fs from "fs";
import * as path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Conectar ao banco
const db = drizzle(process.env.DATABASE_URL!);

async function importData() {
  console.log("ðŸš€ Iniciando importaÃ§Ã£o de dados reais...\n");

  try {
    // Ler arquivos JSON processados
    const departmentsData = JSON.parse(
      fs.readFileSync(path.join(__dirname, "../data/departments.json"), "utf-8")
    );
    const employeesData = JSON.parse(
      fs.readFileSync(path.join(__dirname, "../data/employees.json"), "utf-8")
    );

    console.log(`ðŸ“Š Dados carregados:`);
    console.log(`   - ${departmentsData.length} departamentos`);
    console.log(`   - ${employeesData.length} funcionÃ¡rios\n`);

    // 1. Importar departamentos
    console.log("ðŸ“ Importando departamentos...");
    let departmentCount = 0;
    for (const dept of departmentsData) {
      try {
        await db.insert(schema.departments).values({
          name: dept.name,
          code: dept.code,
        }).onDuplicateKeyUpdate({
          set: { name: dept.name },
        });
        departmentCount++;
      } catch (error: any) {
        console.error(`   âŒ Erro ao importar departamento ${dept.name}:`, error.message);
      }
    }
    console.log(`   âœ… ${departmentCount} departamentos importados\n`);

    // 2. Buscar IDs dos departamentos criados
    const departments = await db.select().from(schema.departments);
    const departmentMap = new Map(departments.map(d => [d.code, d.id]));

    // 3. Criar cargos Ãºnicos e importar
    console.log("ðŸ’¼ Importando cargos...");
    const uniquePositions = new Map<string, any>();
    
    for (const emp of employeesData) {
      if (emp.position && !uniquePositions.has(emp.position)) {
        uniquePositions.set(emp.position, {
          title: emp.position,
          level: "operacional", // Valor padrÃ£o do enum
          description: null,
        });
      }
    }

    let positionCount = 0;
    for (const [title, posData] of uniquePositions) {
      try {
        await db.insert(schema.positions).values(posData).onDuplicateKeyUpdate({
          set: { title: posData.title },
        });
        positionCount++;
      } catch (error: any) {
        console.error(`   âŒ Erro ao importar cargo ${title}:`, error.message);
      }
    }
    console.log(`   âœ… ${positionCount} cargos importados\n`);

    // 4. Buscar IDs dos cargos criados
    const positions = await db.select().from(schema.positions);
    const positionMap = new Map(positions.map(p => [p.title, p.id]));

    // 5. Importar funcionÃ¡rios
    console.log("ðŸ‘¥ Importando funcionÃ¡rios...");
    let employeeCount = 0;
    let errorCount = 0;

    for (const emp of employeesData) {
      try {
        const departmentId = emp.department_code ? departmentMap.get(emp.department_code) : null;
        const positionId = emp.position ? positionMap.get(emp.position) : null;

        await db.insert(schema.employees).values({
          chapa: emp.chapa,
          name: emp.name,
          email: emp.email_corporate || null,
          personalEmail: emp.email_personal || null,
          phone: emp.phone || null,
          departmentId: departmentId || null,
          positionId: positionId || null,
          admissionDate: null,
          status: "ativo",
        }).onDuplicateKeyUpdate({
          set: {
            name: emp.name,
            email: emp.email_corporate || null,
          },
        });

        employeeCount++;

        if (employeeCount % 100 === 0) {
          console.log(`   ðŸ“ ${employeeCount} funcionÃ¡rios processados...`);
        }
      } catch (error: any) {
        errorCount++;
        if (errorCount <= 10) {
          console.error(`   âŒ Erro ao importar funcionÃ¡rio ${emp.name}:`, error.message);
        }
      }
    }

    console.log(`\nâœ… ImportaÃ§Ã£o concluÃ­da!`);
    console.log(`   - ${departmentCount} departamentos`);
    console.log(`   - ${positionCount} cargos`);
    console.log(`   - ${employeeCount} funcionÃ¡rios`);
    if (errorCount > 0) {
      console.log(`   - ${errorCount} erros encontrados`);
    }

  } catch (error) {
    console.error("\nâŒ Erro fatal na importaÃ§Ã£o:", error);
    process.exit(1);
  }
}

importData()
  .then(() => {
    console.log("\nðŸŽ‰ Processo finalizado com sucesso!");
    process.exit(0);
  })
  .catch((error) => {
    console.error("\nðŸ’¥ Erro fatal:", error);
    process.exit(1);
  });


========================================
ARQUIVO: ./scripts/import-to-db.ts
========================================
import { drizzle } from 'drizzle-orm/mysql2';
import { departments, positions, employees } from '../drizzle/schema';
import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const DATABASE_URL = process.env.DATABASE_URL;

if (!DATABASE_URL) {
  console.error('âŒ DATABASE_URL environment variable is not set');
  process.exit(1);
}

async function importData() {
  console.log('ðŸš€ Starting data import...\n');

  const db = drizzle(DATABASE_URL);

  // Read imported JSON files
  const sectionsData = JSON.parse(
    fs.readFileSync(path.join(__dirname, 'imported_sections.json'), 'utf-8')
  );
  const employeesData = JSON.parse(
    fs.readFileSync(path.join(__dirname, 'imported_employees.json'), 'utf-8')
  );

  console.log(`ðŸ“Š Found ${sectionsData.length} sections`);
  console.log(`ðŸ‘¥ Found ${employeesData.length} employees\n`);

  // Import departments
  console.log('ðŸ“ Importing departments...');
  const departmentMap = new Map<string, number>();
  
  for (const section of sectionsData) {
    try {
      const [result] = await db.insert(departments).values({
        name: section.name,
        code: section.code,
        description: null,
        managerId: null,
        active: section.active,
      });
      
      // @ts-ignore
      const insertId = result.insertId;
      departmentMap.set(section.name, insertId);
    } catch (error) {
      console.error(`  âŒ Error inserting department ${section.name}:`, error);
    }
  }
  console.log(`âœ… Imported ${departmentMap.size} departments\n`);

  // Extract unique positions
  console.log('ðŸ’¼ Extracting unique positions...');
  const uniquePositions = new Set<string>();
  employeesData.forEach((emp: any) => {
    if (emp.position && emp.position.trim()) {
      uniquePositions.add(emp.position.trim());
    }
  });

  const positionMap = new Map<string, number>();
  for (const positionName of uniquePositions) {
    try {
      // Determinar nÃ­vel baseado no tÃ­tulo do cargo
      let level: 'junior' | 'pleno' | 'senior' | 'especialista' | 'coordenador' | 'gerente' | 'diretor' | null = null;
      const titleLower = positionName.toLowerCase();
      
      if (titleLower.includes('diretor')) level = 'diretor';
      else if (titleLower.includes('gerente')) level = 'gerente';
      else if (titleLower.includes('coordenador')) level = 'coordenador';
      else if (titleLower.includes('especialista')) level = 'especialista';
      else if (titleLower.includes('senior') || titleLower.includes('sÃªnior') || titleLower.includes('lÃ­der') || titleLower.includes('lider')) level = 'senior';
      else if (titleLower.includes('pleno') || titleLower.includes('ii') || titleLower.includes('supervisor')) level = 'pleno';
      else if (titleLower.includes('junior') || titleLower.includes('jÃºnior') || titleLower.includes('i') || titleLower.includes('auxiliar') || titleLower.includes('assistente')) level = 'junior';
      
      const [result] = await db.insert(positions).values({
        title: positionName,
        code: `POS${positionMap.size + 1}`,
        level: level,
        description: null,
        active: true,
      });
      
      // @ts-ignore
      const insertId = result.insertId;
      positionMap.set(positionName, insertId);
    } catch (error) {
      console.error(`  âŒ Error inserting position ${positionName}:`, error);
    }
  }
  console.log(`âœ… Imported ${positionMap.size} positions\n`);

  // Import employees
  console.log('ðŸ‘¥ Importing employees...');
  let successCount = 0;
  let errorCount = 0;

  for (const emp of employeesData) {
    try {
      const departmentId = departmentMap.get(emp.department);
      const positionId = positionMap.get(emp.position);

      // Use corporate email if available, otherwise personal email
      const email = emp.corporate_email || emp.personal_email || null;

      await db.insert(employees).values({
        employeeCode: emp.employee_code,
        name: emp.name,
        email: email,
        phone: emp.phone || null,
        departmentId: departmentId || null,
        positionId: positionId || null,
        managerId: null,
        hireDate: null,
        birthDate: null,
        status: emp.active ? 'ativo' : 'inativo',
      });

      successCount++;
      
      if (successCount % 100 === 0) {
        console.log(`  â³ Imported ${successCount} employees...`);
      }
    } catch (error) {
      errorCount++;
      console.error(`  âŒ Error inserting employee ${emp.name}:`, error);
    }
  }

  console.log(`\nâœ… Import completed!`);
  console.log(`  âœ“ ${successCount} employees imported successfully`);
  console.log(`  âœ— ${errorCount} errors`);
  console.log(`\nðŸ“Š Summary:`);
  console.log(`  Departments: ${departmentMap.size}`);
  console.log(`  Positions: ${positionMap.size}`);
  console.log(`  Employees: ${successCount}`);
}

importData()
  .then(() => {
    console.log('\nðŸŽ‰ Data import finished!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\nâŒ Import failed:', error);
    process.exit(1);
  });


========================================
ARQUIVO: ./scripts/seed-360-questions.ts
========================================
import { drizzle } from "drizzle-orm/mysql2";
import { evaluationQuestions } from "../drizzle/schema";

const db = drizzle(process.env.DATABASE_URL!);

const questions = [
  // Categoria: LideranÃ§a
  { code: "LID001", question: "Demonstra capacidade de inspirar e motivar a equipe", category: "LideranÃ§a", type: "escala" as const },
  { code: "LID002", question: "Toma decisÃµes de forma assertiva e no momento adequado", category: "LideranÃ§a", type: "escala" as const },
  { code: "LID003", question: "Delega tarefas de forma eficaz e acompanha resultados", category: "LideranÃ§a", type: "escala" as const },
  { code: "LID004", question: "Desenvolve e capacita membros da equipe", category: "LideranÃ§a", type: "escala" as const },
  
  // Categoria: ComunicaÃ§Ã£o
  { code: "COM001", question: "Comunica-se de forma clara e objetiva", category: "ComunicaÃ§Ã£o", type: "escala" as const },
  { code: "COM002", question: "Ouve ativamente e demonstra empatia", category: "ComunicaÃ§Ã£o", type: "escala" as const },
  { code: "COM003", question: "Fornece feedback construtivo e oportuno", category: "ComunicaÃ§Ã£o", type: "escala" as const },
  { code: "COM004", question: "MantÃ©m comunicaÃ§Ã£o transparente com a equipe", category: "ComunicaÃ§Ã£o", type: "escala" as const },
  
  // Categoria: Trabalho em Equipe
  { code: "TEQ001", question: "Colabora ativamente com colegas de trabalho", category: "Trabalho em Equipe", type: "escala" as const },
  { code: "TEQ002", question: "Compartilha conhecimento e apoia outros membros", category: "Trabalho em Equipe", type: "escala" as const },
  { code: "TEQ003", question: "Resolve conflitos de forma construtiva", category: "Trabalho em Equipe", type: "escala" as const },
  { code: "TEQ004", question: "Contribui para um ambiente de trabalho positivo", category: "Trabalho em Equipe", type: "escala" as const },
  
  // Categoria: Resultados
  { code: "RES001", question: "Entrega resultados dentro dos prazos estabelecidos", category: "Resultados", type: "escala" as const },
  { code: "RES002", question: "MantÃ©m alto padrÃ£o de qualidade no trabalho", category: "Resultados", type: "escala" as const },
  { code: "RES003", question: "Busca continuamente melhorias e inovaÃ§Ã£o", category: "Resultados", type: "escala" as const },
  { code: "RES004", question: "Assume responsabilidade pelos resultados", category: "Resultados", type: "escala" as const },
  
  // Categoria: Desenvolvimento
  { code: "DES001", question: "Busca oportunidades de aprendizado e crescimento", category: "Desenvolvimento", type: "escala" as const },
  { code: "DES002", question: "Adapta-se bem a mudanÃ§as e novos desafios", category: "Desenvolvimento", type: "escala" as const },
  { code: "DES003", question: "Demonstra iniciativa e proatividade", category: "Desenvolvimento", type: "escala" as const },
  { code: "DES004", question: "Aplica novos conhecimentos no dia a dia", category: "Desenvolvimento", type: "escala" as const },
  
  // Perguntas abertas
  { code: "OPEN001", question: "Quais sÃ£o os principais pontos fortes desta pessoa?", category: "Feedback Aberto", type: "texto" as const },
  { code: "OPEN002", question: "Quais Ã¡reas vocÃª recomenda para desenvolvimento?", category: "Feedback Aberto", type: "texto" as const },
  { code: "OPEN003", question: "ComentÃ¡rios adicionais ou sugestÃµes", category: "Feedback Aberto", type: "texto" as const },
];

async function seed() {
  console.log("Populando perguntas de avaliaÃ§Ã£o 360Â°...");
  
  for (const q of questions) {
    try {
      await db.insert(evaluationQuestions).values({
        code: q.code,
        question: q.question,
        category: q.category,
        type: q.type,
        weight: 1,
        active: true,
      });
      console.log(`âœ“ ${q.code}: ${q.question.substring(0, 50)}...`);
    } catch (error: any) {
      if (error.code === 'ER_DUP_ENTRY') {
        console.log(`âŠ˜ ${q.code} jÃ¡ existe`);
      } else {
        console.error(`âœ— Erro ao inserir ${q.code}:`, error.message);
      }
    }
  }
  
  console.log("\nâœ… Seed concluÃ­do!");
  process.exit(0);
}

seed();


========================================
ARQUIVO: ./scripts/seed-badges.ts
========================================
import { drizzle } from "drizzle-orm/mysql2";
import { badges } from "../drizzle/schema";

const db = drizzle(process.env.DATABASE_URL!);

const defaultBadges = [
  {
    name: "Primeira Meta ConcluÃ­da",
    description: "Concluiu sua primeira meta com 100% de progresso",
    icon: "Target",
    category: "metas" as const,
    points: 50,
    condition: JSON.stringify({ type: "goal_completed", count: 1 }),
  },
  {
    name: "Mestre das Metas",
    description: "Concluiu 10 metas com 100% de progresso",
    icon: "Trophy",
    category: "metas" as const,
    points: 200,
    condition: JSON.stringify({ type: "goal_completed", count: 10 }),
  },
  {
    name: "PDI Iniciado",
    description: "Criou seu primeiro Plano de Desenvolvimento Individual",
    icon: "Lightbulb",
    category: "pdi" as const,
    points: 30,
    condition: JSON.stringify({ type: "pdi_created", count: 1 }),
  },
  {
    name: "PDI ConcluÃ­do",
    description: "Finalizou um Plano de Desenvolvimento Individual completo",
    icon: "GraduationCap",
    category: "pdi" as const,
    points: 100,
    condition: JSON.stringify({ type: "pdi_completed", count: 1 }),
  },
  {
    name: "AvaliaÃ§Ã£o 360Â° Completa",
    description: "Completou uma avaliaÃ§Ã£o 360Â° com todos os avaliadores",
    icon: "Users",
    category: "avaliacao" as const,
    points: 75,
    condition: JSON.stringify({ type: "evaluation_360_completed", count: 1 }),
  },
  {
    name: "Feedback Ativo",
    description: "Recebeu 5 feedbacks de gestores",
    icon: "MessageSquare",
    category: "feedback" as const,
    points: 40,
    condition: JSON.stringify({ type: "feedback_received", count: 5 }),
  },
  {
    name: "Mentor",
    description: "Forneceu 10 feedbacks para outros colaboradores",
    icon: "Heart",
    category: "feedback" as const,
    points: 60,
    condition: JSON.stringify({ type: "feedback_given", count: 10 }),
  },
  {
    name: "Estrela em AscensÃ£o",
    description: "Atingiu pontuaÃ§Ã£o acima de 4.5 em avaliaÃ§Ã£o de performance",
    icon: "Star",
    category: "avaliacao" as const,
    points: 150,
    condition: JSON.stringify({ type: "performance_rating", min: 4.5 }),
  },
  {
    name: "Nine Box - Alto Potencial",
    description: "Classificado como Alto Potencial na matriz Nine Box",
    icon: "TrendingUp",
    category: "avaliacao" as const,
    points: 200,
    condition: JSON.stringify({ type: "ninebox_category", categories: ["high_potential", "star", "future_leader"] }),
  },
  {
    name: "Explorador do Conhecimento",
    description: "Completou todos os testes psicomÃ©tricos disponÃ­veis",
    icon: "Brain",
    category: "geral" as const,
    points: 80,
    condition: JSON.stringify({ type: "psychometric_tests_completed", count: 5 }),
  },
];

async function seed() {
  console.log("ðŸŒ± Populando badges padrÃ£o...");
  
  for (const badge of defaultBadges) {
    await db.insert(badges).values(badge);
    console.log(`âœ… Badge criado: ${badge.name}`);
  }
  
  console.log("âœ… Badges populados com sucesso!");
  process.exit(0);
}

seed().catch((error) => {
  console.error("âŒ Erro ao popular badges:", error);
  process.exit(1);
});


========================================
ARQUIVO: ./scripts/seed-bigfive.ts
========================================
import { drizzle } from "drizzle-orm/mysql2";
import { testQuestions } from "../drizzle/schema";

/**
 * Script para popular 50 perguntas do teste Big Five
 * Modelo: OCEAN (Openness, Conscientiousness, Extraversion, Agreeableness, Neuroticism)
 */

const db = drizzle(process.env.DATABASE_URL!);

const bigFiveQuestions = [
  // Openness (Abertura para experiÃªncias) - 10 perguntas
  { testType: "bigfive" as const, questionNumber: 1, dimension: "O", questionText: "Eu tenho uma imaginaÃ§Ã£o fÃ©rtil e criativa", reverse: false },
  { testType: "bigfive" as const, questionNumber: 2, dimension: "O", questionText: "Eu gosto de explorar novas ideias e conceitos", reverse: false },
  { testType: "bigfive" as const, questionNumber: 3, dimension: "O", questionText: "Eu prefiro rotinas e nÃ£o gosto de mudanÃ§as", reverse: true },
  { testType: "bigfive" as const, questionNumber: 4, dimension: "O", questionText: "Eu aprecio arte, mÃºsica e literatura", reverse: false },
  { testType: "bigfive" as const, questionNumber: 5, dimension: "O", questionText: "Eu sou curioso sobre diferentes culturas e lugares", reverse: false },
  { testType: "bigfive" as const, questionNumber: 6, dimension: "O", questionText: "Eu tenho dificuldade em entender conceitos abstratos", reverse: true },
  { testType: "bigfive" as const, questionNumber: 7, dimension: "O", questionText: "Eu gosto de experimentar coisas novas", reverse: false },
  { testType: "bigfive" as const, questionNumber: 8, dimension: "O", questionText: "Eu sou uma pessoa convencional e tradicional", reverse: true },
  { testType: "bigfive" as const, questionNumber: 9, dimension: "O", questionText: "Eu tenho uma mente aberta para novas perspectivas", reverse: false },
  { testType: "bigfive" as const, questionNumber: 10, dimension: "O", questionText: "Eu prefiro o prÃ¡tico ao teÃ³rico", reverse: true },

  // Conscientiousness (Conscienciosidade) - 10 perguntas
  { testType: "bigfive" as const, questionNumber: 11, dimension: "C", questionText: "Eu sou organizado e mantenho as coisas arrumadas", reverse: false },
  { testType: "bigfive" as const, questionNumber: 12, dimension: "C", questionText: "Eu planejo com antecedÃªncia e sigo meus planos", reverse: false },
  { testType: "bigfive" as const, questionNumber: 13, dimension: "C", questionText: "Eu frequentemente deixo tarefas inacabadas", reverse: true },
  { testType: "bigfive" as const, questionNumber: 14, dimension: "C", questionText: "Eu sou pontual e cumpro prazos", reverse: false },
  { testType: "bigfive" as const, questionNumber: 15, dimension: "C", questionText: "Eu presto atenÃ§Ã£o aos detalhes", reverse: false },
  { testType: "bigfive" as const, questionNumber: 16, dimension: "C", questionText: "Eu sou descuidado e cometo erros por falta de atenÃ§Ã£o", reverse: true },
  { testType: "bigfive" as const, questionNumber: 17, dimension: "C", questionText: "Eu me esforÃ§o para alcanÃ§ar a excelÃªncia", reverse: false },
  { testType: "bigfive" as const, questionNumber: 18, dimension: "C", questionText: "Eu procrastino e adio tarefas importantes", reverse: true },
  { testType: "bigfive" as const, questionNumber: 19, dimension: "C", questionText: "Eu sou disciplinado e autocontrolado", reverse: false },
  { testType: "bigfive" as const, questionNumber: 20, dimension: "C", questionText: "Eu sou impulsivo e ajo sem pensar", reverse: true },

  // Extraversion (ExtroversÃ£o) - 10 perguntas
  { testType: "bigfive" as const, questionNumber: 21, dimension: "E", questionText: "Eu sou o centro das atenÃ§Ãµes em festas", reverse: false },
  { testType: "bigfive" as const, questionNumber: 22, dimension: "E", questionText: "Eu me sinto energizado quando estou com outras pessoas", reverse: false },
  { testType: "bigfive" as const, questionNumber: 23, dimension: "E", questionText: "Eu prefiro ficar em casa a sair com amigos", reverse: true },
  { testType: "bigfive" as const, questionNumber: 24, dimension: "E", questionText: "Eu inicio conversas com estranhos facilmente", reverse: false },
  { testType: "bigfive" as const, questionNumber: 25, dimension: "E", questionText: "Eu gosto de estar em ambientes animados e movimentados", reverse: false },
  { testType: "bigfive" as const, questionNumber: 26, dimension: "E", questionText: "Eu sou quieto e reservado em grupos", reverse: true },
  { testType: "bigfive" as const, questionNumber: 27, dimension: "E", questionText: "Eu gosto de conhecer novas pessoas", reverse: false },
  { testType: "bigfive" as const, questionNumber: 28, dimension: "E", questionText: "Eu me sinto desconfortÃ¡vel sendo o centro das atenÃ§Ãµes", reverse: true },
  { testType: "bigfive" as const, questionNumber: 29, dimension: "E", questionText: "Eu sou assertivo e tomo a lideranÃ§a", reverse: false },
  { testType: "bigfive" as const, questionNumber: 30, dimension: "E", questionText: "Eu preciso de muito tempo sozinho para recarregar", reverse: true },

  // Agreeableness (Amabilidade) - 10 perguntas
  { testType: "bigfive" as const, questionNumber: 31, dimension: "A", questionText: "Eu sou empÃ¡tico e me preocupo com os sentimentos dos outros", reverse: false },
  { testType: "bigfive" as const, questionNumber: 32, dimension: "A", questionText: "Eu coopero e trabalho bem em equipe", reverse: false },
  { testType: "bigfive" as const, questionNumber: 33, dimension: "A", questionText: "Eu sou cÃ©tico e desconfio das intenÃ§Ãµes das pessoas", reverse: true },
  { testType: "bigfive" as const, questionNumber: 34, dimension: "A", questionText: "Eu ajudo os outros sem esperar nada em troca", reverse: false },
  { testType: "bigfive" as const, questionNumber: 35, dimension: "A", questionText: "Eu sou gentil e educado com todos", reverse: false },
  { testType: "bigfive" as const, questionNumber: 36, dimension: "A", questionText: "Eu critico e julgo os outros facilmente", reverse: true },
  { testType: "bigfive" as const, questionNumber: 37, dimension: "A", questionText: "Eu perdoo facilmente e nÃ£o guardo rancor", reverse: false },
  { testType: "bigfive" as const, questionNumber: 38, dimension: "A", questionText: "Eu coloco minhas necessidades acima das dos outros", reverse: true },
  { testType: "bigfive" as const, questionNumber: 39, dimension: "A", questionText: "Eu sou paciente e tolerante com as diferenÃ§as", reverse: false },
  { testType: "bigfive" as const, questionNumber: 40, dimension: "A", questionText: "Eu sou competitivo e gosto de vencer a qualquer custo", reverse: true },

  // Neuroticism (Neuroticismo/Estabilidade Emocional) - 10 perguntas
  { testType: "bigfive" as const, questionNumber: 41, dimension: "N", questionText: "Eu me preocupo muito com as coisas", reverse: false },
  { testType: "bigfive" as const, questionNumber: 42, dimension: "N", questionText: "Eu fico estressado facilmente", reverse: false },
  { testType: "bigfive" as const, questionNumber: 43, dimension: "N", questionText: "Eu sou calmo e raramente me sinto ansioso", reverse: true },
  { testType: "bigfive" as const, questionNumber: 44, dimension: "N", questionText: "Eu tenho mudanÃ§as de humor frequentes", reverse: false },
  { testType: "bigfive" as const, questionNumber: 45, dimension: "N", questionText: "Eu me sinto triste ou deprimido com frequÃªncia", reverse: false },
  { testType: "bigfive" as const, questionNumber: 46, dimension: "N", questionText: "Eu sou emocionalmente estÃ¡vel e equilibrado", reverse: true },
  { testType: "bigfive" as const, questionNumber: 47, dimension: "N", questionText: "Eu fico irritado facilmente", reverse: false },
  { testType: "bigfive" as const, questionNumber: 48, dimension: "N", questionText: "Eu lido bem com situaÃ§Ãµes estressantes", reverse: true },
  { testType: "bigfive" as const, questionNumber: 49, dimension: "N", questionText: "Eu me sinto inseguro e tenho baixa autoestima", reverse: false },
  { testType: "bigfive" as const, questionNumber: 50, dimension: "N", questionText: "Eu sou confiante e raramente me sinto nervoso", reverse: true },
];

async function seedBigFive() {
  console.log("ðŸŒ± Populando perguntas Big Five...");

  try {
    // Inserir todas as 50 perguntas
    await db.insert(testQuestions).values(bigFiveQuestions);

    console.log("âœ… 50 perguntas Big Five inseridas com sucesso!");
    console.log("   - Openness (O): 10 perguntas");
    console.log("   - Conscientiousness (C): 10 perguntas");
    console.log("   - Extraversion (E): 10 perguntas");
    console.log("   - Agreeableness (A): 10 perguntas");
    console.log("   - Neuroticism (N): 10 perguntas");
  } catch (error) {
    console.error("âŒ Erro ao popular Big Five:", error);
    throw error;
  }
}

seedBigFive()
  .then(() => {
    console.log("âœ… Script concluÃ­do!");
    process.exit(0);
  })
  .catch((error) => {
    console.error("âŒ Erro fatal:", error);
    process.exit(1);
  });


========================================
ARQUIVO: ./scripts/seed-ie.ts
========================================
import { drizzle } from "drizzle-orm/mysql2";
import { testQuestions } from "../drizzle/schema";

const db = drizzle(process.env.DATABASE_URL!);

const questions = [
  // DimensÃ£o: AutoconsciÃªncia
  { code: "IE_AUTO_01", question: "ReconheÃ§o facilmente minhas emoÃ§Ãµes quando elas surgem", dimension: "AutoconsciÃªncia", type: "ie" as const },
  { code: "IE_AUTO_02", question: "Entendo como minhas emoÃ§Ãµes afetam meu desempenho", dimension: "AutoconsciÃªncia", type: "ie" as const },
  { code: "IE_AUTO_03", question: "ConheÃ§o bem meus pontos fortes e limitaÃ§Ãµes", dimension: "AutoconsciÃªncia", type: "ie" as const },
  { code: "IE_AUTO_04", question: "Tenho clareza sobre meus valores e objetivos", dimension: "AutoconsciÃªncia", type: "ie" as const },
  { code: "IE_AUTO_05", question: "Sei o que me motiva e o que me desmotiva", dimension: "AutoconsciÃªncia", type: "ie" as const },
  
  // DimensÃ£o: AutorregulaÃ§Ã£o
  { code: "IE_AUTO_REG_01", question: "Consigo manter a calma em situaÃ§Ãµes estressantes", dimension: "AutorregulaÃ§Ã£o", type: "ie" as const },
  { code: "IE_AUTO_REG_02", question: "Controlo bem meus impulsos e reaÃ§Ãµes emocionais", dimension: "AutorregulaÃ§Ã£o", type: "ie" as const },
  { code: "IE_AUTO_REG_03", question: "Adapto-me facilmente a mudanÃ§as e imprevistos", dimension: "AutorregulaÃ§Ã£o", type: "ie" as const },
  { code: "IE_AUTO_REG_04", question: "Mantenho integridade e assumo responsabilidade por minhas aÃ§Ãµes", dimension: "AutorregulaÃ§Ã£o", type: "ie" as const },
  { code: "IE_AUTO_REG_05", question: "Consigo me recuperar rapidamente de contratempos", dimension: "AutorregulaÃ§Ã£o", type: "ie" as const },
  
  // DimensÃ£o: MotivaÃ§Ã£o
  { code: "IE_MOT_01", question: "Busco constantemente melhorar e atingir padrÃµes de excelÃªncia", dimension: "MotivaÃ§Ã£o", type: "ie" as const },
  { code: "IE_MOT_02", question: "Mantenho-me motivado mesmo diante de obstÃ¡culos", dimension: "MotivaÃ§Ã£o", type: "ie" as const },
  { code: "IE_MOT_03", question: "Alinhos meus objetivos pessoais com os da organizaÃ§Ã£o", dimension: "MotivaÃ§Ã£o", type: "ie" as const },
  { code: "IE_MOT_04", question: "Tomo iniciativa e aproveito oportunidades", dimension: "MotivaÃ§Ã£o", type: "ie" as const },
  { code: "IE_MOT_05", question: "Persisto em meus objetivos apesar das dificuldades", dimension: "MotivaÃ§Ã£o", type: "ie" as const },
  
  // DimensÃ£o: Empatia
  { code: "IE_EMP_01", question: "Percebo e compreendo as emoÃ§Ãµes dos outros", dimension: "Empatia", type: "ie" as const },
  { code: "IE_EMP_02", question: "Mostro interesse genuÃ­no pelas preocupaÃ§Ãµes dos outros", dimension: "Empatia", type: "ie" as const },
  { code: "IE_EMP_03", question: "Ajudo no desenvolvimento de outras pessoas", dimension: "Empatia", type: "ie" as const },
  { code: "IE_EMP_04", question: "ReconheÃ§o e valorizo a diversidade de perspectivas", dimension: "Empatia", type: "ie" as const },
  { code: "IE_EMP_05", question: "Entendo as dinÃ¢micas polÃ­ticas e sociais da organizaÃ§Ã£o", dimension: "Empatia", type: "ie" as const },
  
  // DimensÃ£o: Habilidades Sociais
  { code: "IE_SOC_01", question: "Comunico-me de forma clara e persuasiva", dimension: "Habilidades Sociais", type: "ie" as const },
  { code: "IE_SOC_02", question: "Inspiro e influencio positivamente os outros", dimension: "Habilidades Sociais", type: "ie" as const },
  { code: "IE_SOC_03", question: "Gerencio bem conflitos e negocio soluÃ§Ãµes", dimension: "Habilidades Sociais", type: "ie" as const },
  { code: "IE_SOC_04", question: "Construo e mantenho relacionamentos produtivos", dimension: "Habilidades Sociais", type: "ie" as const },
  { code: "IE_SOC_05", question: "Trabalho bem em equipe e promovo colaboraÃ§Ã£o", dimension: "Habilidades Sociais", type: "ie" as const },
];

async function seed() {
  console.log("Populando perguntas de InteligÃªncia Emocional...");
  
  for (const q of questions) {
    try {
      await db.insert(testQuestions).values({
        testType: q.type,
        questionNumber: parseInt(q.code.split('_').pop() || '0'),
        questionText: q.question,
        dimension: q.dimension,
        reverse: false,
      });
      console.log(`âœ“ ${q.code}: ${q.question.substring(0, 50)}...`);
    } catch (error: any) {
      if (error.code === 'ER_DUP_ENTRY') {
        console.log(`âŠ˜ ${q.code} jÃ¡ existe`);
      } else {
        console.error(`âœ— Erro ao inserir ${q.code}:`, error.message);
      }
    }
  }
  
  console.log("\nâœ… Seed IE concluÃ­do!");
  process.exit(0);
}

seed();


========================================
ARQUIVO: ./scripts/seed-mbti.ts
========================================
import { drizzle } from "drizzle-orm/mysql2";
import { testQuestions } from "../drizzle/schema";

const db = drizzle(process.env.DATABASE_URL!);

const questions = [
  // DimensÃ£o: ExtroversÃ£o (E) vs IntroversÃ£o (I)
  { code: "MBTI_EI_01", question: "VocÃª se sente energizado apÃ³s passar tempo com muitas pessoas", dimension: "E/I", type: "mbti" as const },
  { code: "MBTI_EI_02", question: "Prefere atividades sociais em grupo a atividades solitÃ¡rias", dimension: "E/I", type: "mbti" as const },
  { code: "MBTI_EI_03", question: "Gosta de ser o centro das atenÃ§Ãµes", dimension: "E/I", type: "mbti" as const },
  { code: "MBTI_EI_04", question: "Precisa de tempo sozinho para recarregar as energias", dimension: "E/I", type: "mbti" as const, reverse: true },
  { code: "MBTI_EI_05", question: "Prefere conversar sobre ideias com outras pessoas do que refletir sozinho", dimension: "E/I", type: "mbti" as const },
  
  // DimensÃ£o: SensaÃ§Ã£o (S) vs IntuiÃ§Ã£o (N)
  { code: "MBTI_SN_01", question: "Prefere focar em fatos e detalhes concretos", dimension: "S/N", type: "mbti" as const },
  { code: "MBTI_SN_02", question: "Gosta de explorar possibilidades e significados abstratos", dimension: "S/N", type: "mbti" as const, reverse: true },
  { code: "MBTI_SN_03", question: "Confia mais em experiÃªncias prÃ¡ticas do que em teorias", dimension: "S/N", type: "mbti" as const },
  { code: "MBTI_SN_04", question: "Prefere seguir mÃ©todos comprovados a experimentar novas abordagens", dimension: "S/N", type: "mbti" as const },
  { code: "MBTI_SN_05", question: "Gosta de imaginar futuros possÃ­veis e cenÃ¡rios hipotÃ©ticos", dimension: "S/N", type: "mbti" as const, reverse: true },
  
  // DimensÃ£o: Pensamento (T) vs Sentimento (F)
  { code: "MBTI_TF_01", question: "Toma decisÃµes baseadas principalmente em lÃ³gica e anÃ¡lise objetiva", dimension: "T/F", type: "mbti" as const },
  { code: "MBTI_TF_02", question: "Considera os sentimentos das pessoas ao tomar decisÃµes", dimension: "T/F", type: "mbti" as const, reverse: true },
  { code: "MBTI_TF_03", question: "Prefere ser direto e honesto, mesmo que possa magoar alguÃ©m", dimension: "T/F", type: "mbti" as const },
  { code: "MBTI_TF_04", question: "Valoriza harmonia e evita conflitos", dimension: "T/F", type: "mbti" as const, reverse: true },
  { code: "MBTI_TF_05", question: "Acredita que a verdade Ã© mais importante que a diplomacia", dimension: "T/F", type: "mbti" as const },
  
  // DimensÃ£o: Julgamento (J) vs PercepÃ§Ã£o (P)
  { code: "MBTI_JP_01", question: "Prefere ter planos definidos e seguir cronogramas", dimension: "J/P", type: "mbti" as const },
  { code: "MBTI_JP_02", question: "Gosta de manter opÃ§Ãµes em aberto e ser espontÃ¢neo", dimension: "J/P", type: "mbti" as const, reverse: true },
  { code: "MBTI_JP_03", question: "Sente-se confortÃ¡vel com estrutura e organizaÃ§Ã£o", dimension: "J/P", type: "mbti" as const },
  { code: "MBTI_JP_04", question: "Prefere flexibilidade e adaptaÃ§Ã£o a regras rÃ­gidas", dimension: "J/P", type: "mbti" as const, reverse: true },
  { code: "MBTI_JP_05", question: "Gosta de concluir tarefas antes dos prazos", dimension: "J/P", type: "mbti" as const },
];

async function seed() {
  console.log("Populando perguntas MBTI...");
  
  for (const q of questions) {
    try {
      await db.insert(testQuestions).values({
        testType: q.type,
        questionNumber: parseInt(q.code.split('_').pop() || '0'),
        questionText: q.question,
        dimension: q.dimension,
        reverse: q.reverse || false,
      });
      console.log(`âœ“ ${q.code}: ${q.question.substring(0, 50)}...`);
    } catch (error: any) {
      if (error.code === 'ER_DUP_ENTRY') {
        console.log(`âŠ˜ ${q.code} jÃ¡ existe`);
      } else {
        console.error(`âœ— Erro ao inserir ${q.code}:`, error.message);
      }
    }
  }
  
  console.log("\nâœ… Seed MBTI concluÃ­do!");
  process.exit(0);
}

seed();


========================================
ARQUIVO: ./scripts/seed-vark.ts
========================================
import { drizzle } from "drizzle-orm/mysql2";
import { testQuestions } from "../drizzle/schema";

const db = drizzle(process.env.DATABASE_URL!);

const questions = [
  // DimensÃ£o: Visual
  { code: "VARK_V_01", question: "Prefiro aprender atravÃ©s de diagramas, grÃ¡ficos e imagens", dimension: "Visual", type: "vark" as const },
  { code: "VARK_V_02", question: "Lembro-me melhor de informaÃ§Ãµes quando as vejo escritas ou ilustradas", dimension: "Visual", type: "vark" as const },
  { code: "VARK_V_03", question: "Gosto de usar cores e destacadores ao estudar", dimension: "Visual", type: "vark" as const },
  { code: "VARK_V_04", question: "Prefiro assistir a vÃ­deos ou demonstraÃ§Ãµes visuais", dimension: "Visual", type: "vark" as const },
  { code: "VARK_V_05", question: "Organizo informaÃ§Ãµes usando mapas mentais ou fluxogramas", dimension: "Visual", type: "vark" as const },
  
  // DimensÃ£o: Auditivo
  { code: "VARK_A_01", question: "Aprendo melhor ouvindo explicaÃ§Ãµes e discussÃµes", dimension: "Auditivo", type: "vark" as const },
  { code: "VARK_A_02", question: "Gosto de participar de debates e conversas sobre o conteÃºdo", dimension: "Auditivo", type: "vark" as const },
  { code: "VARK_A_03", question: "Prefiro ouvir podcasts ou audiolivros a ler textos", dimension: "Auditivo", type: "vark" as const },
  { code: "VARK_A_04", question: "Lembro-me melhor de informaÃ§Ãµes que ouvi", dimension: "Auditivo", type: "vark" as const },
  { code: "VARK_A_05", question: "Gosto de explicar conceitos em voz alta para fixar o aprendizado", dimension: "Auditivo", type: "vark" as const },
  
  // DimensÃ£o: Leitura/Escrita
  { code: "VARK_R_01", question: "Prefiro ler textos e fazer anotaÃ§Ãµes escritas", dimension: "Leitura/Escrita", type: "vark" as const },
  { code: "VARK_R_02", question: "Aprendo melhor lendo livros e artigos", dimension: "Leitura/Escrita", type: "vark" as const },
  { code: "VARK_R_03", question: "Gosto de fazer resumos e listas por escrito", dimension: "Leitura/Escrita", type: "vark" as const },
  { code: "VARK_R_04", question: "Prefiro instruÃ§Ãµes escritas a explicaÃ§Ãµes verbais", dimension: "Leitura/Escrita", type: "vark" as const },
  { code: "VARK_R_05", question: "Reescrever informaÃ§Ãµes me ajuda a memorizar", dimension: "Leitura/Escrita", type: "vark" as const },
  
  // DimensÃ£o: CinestÃ©sico
  { code: "VARK_K_01", question: "Aprendo melhor fazendo e praticando", dimension: "CinestÃ©sico", type: "vark" as const },
  { code: "VARK_K_02", question: "Prefiro experiÃªncias prÃ¡ticas e hands-on", dimension: "CinestÃ©sico", type: "vark" as const },
  { code: "VARK_K_03", question: "Gosto de usar exemplos da vida real ao aprender", dimension: "CinestÃ©sico", type: "vark" as const },
  { code: "VARK_K_04", question: "Preciso me movimentar ou fazer pausas ao estudar", dimension: "CinestÃ©sico", type: "vark" as const },
  { code: "VARK_K_05", question: "Aprendo melhor atravÃ©s de simulaÃ§Ãµes e role-playing", dimension: "CinestÃ©sico", type: "vark" as const },
];

async function seed() {
  console.log("Populando perguntas de Estilos de Aprendizagem (VARK)...");
  
  for (const q of questions) {
    try {
      await db.insert(testQuestions).values({
        testType: q.type,
        questionNumber: parseInt(q.code.split('_').pop() || '0'),
        questionText: q.question,
        dimension: q.dimension,
        reverse: false,
      });
      console.log(`âœ“ ${q.code}: ${q.question.substring(0, 50)}...`);
    } catch (error: any) {
      if (error.code === 'ER_DUP_ENTRY') {
        console.log(`âŠ˜ ${q.code} jÃ¡ existe`);
      } else {
        console.error(`âœ— Erro ao inserir ${q.code}:`, error.message);
      }
    }
  }
  
  console.log("\nâœ… Seed VARK concluÃ­do!");
  process.exit(0);
}

seed();


========================================
ARQUIVO: ./scripts/seed.ts
========================================
import { drizzle } from "drizzle-orm/mysql2";
import {
  users,
  employees,
  departments,
  positions,
  competencies,
  competencyLevels,
  evaluationCycles,
  goals,
  performanceEvaluations,
  pdiPlans,
  pdiItems,
  developmentActions,
  nineBoxPositions,
} from "../drizzle/schema";

/**
 * Script de Seeds - Popula o banco de dados com dados de exemplo
 * Para executar: npx tsx scripts/seed.ts
 */

async function seed() {
  console.log("ðŸŒ± Iniciando seeds do banco de dados...\n");

  if (!process.env.DATABASE_URL) {
    console.error("âŒ DATABASE_URL nÃ£o configurada");
    process.exit(1);
  }

  const db = drizzle(process.env.DATABASE_URL);

  try {
    // ========================================================================
    // 1. DEPARTAMENTOS
    // ========================================================================
    console.log("ðŸ“ Criando departamentos...");
    const [dept1] = await db.insert(departments).values({
      code: "TI",
      name: "Tecnologia da InformaÃ§Ã£o",
      description: "Departamento de TI e InovaÃ§Ã£o",
      active: true,
    });

    const [dept2] = await db.insert(departments).values({
      code: "RH",
      name: "Recursos Humanos",
      description: "Departamento de GestÃ£o de Pessoas",
      active: true,
    });

    const [dept3] = await db.insert(departments).values({
      code: "FIN",
      name: "Financeiro",
      description: "Departamento Financeiro",
      active: true,
    });

    console.log("âœ… 3 departamentos criados\n");

    // ========================================================================
    // 2. CARGOS
    // ========================================================================
    console.log("ðŸ’¼ Criando cargos...");
    const [pos1] = await db.insert(positions).values({
      code: "DEV_JR",
      title: "Desenvolvedor JÃºnior",
      description: "Desenvolvedor de software jÃºnior",
      level: "junior",
      departmentId: Number(dept1.insertId),
      active: true,
    });

    const [pos2] = await db.insert(positions).values({
      code: "DEV_PL",
      title: "Desenvolvedor Pleno",
      description: "Desenvolvedor de software pleno",
      level: "pleno",
      departmentId: Number(dept1.insertId),
      active: true,
    });

    const [pos3] = await db.insert(positions).values({
      code: "DEV_SR",
      title: "Desenvolvedor SÃªnior",
      description: "Desenvolvedor de software sÃªnior",
      level: "senior",
      departmentId: Number(dept1.insertId),
      active: true,
    });

    const [pos4] = await db.insert(positions).values({
      code: "ANALISTA_RH",
      title: "Analista de RH",
      description: "Analista de Recursos Humanos",
      level: "pleno",
      departmentId: Number(dept2.insertId),
      active: true,
    });

    console.log("âœ… 4 cargos criados\n");

    // ========================================================================
    // 3. USUÃRIOS E COLABORADORES
    // ========================================================================
    console.log("ðŸ‘¥ Criando usuÃ¡rios e colaboradores...");
    
    // UsuÃ¡rio Admin
    const [user1] = await db.insert(users).values({
      openId: "admin-001",
      name: "Administrador Sistema",
      email: "admin@uisa.com.br",
      role: "admin",
      loginMethod: "password",
    });

    const [emp1] = await db.insert(employees).values({
      userId: Number(user1.insertId),
      employeeCode: "EMP001",
      name: "Administrador Sistema",
      email: "admin@uisa.com.br",
      cpf: "000.000.000-00",
      hireDate: new Date("2020-01-01"),
      departmentId: Number(dept1.insertId),
      positionId: Number(pos3.insertId),
      status: "ativo",
    });

    // Colaborador 1
    const [user2] = await db.insert(users).values({
      openId: "user-002",
      name: "JoÃ£o Silva",
      email: "joao.silva@uisa.com.br",
      role: "colaborador",
      loginMethod: "password",
    });

    const [emp2] = await db.insert(employees).values({
      userId: Number(user2.insertId),
      employeeCode: "EMP002",
      name: "JoÃ£o Silva",
      email: "joao.silva@uisa.com.br",
      cpf: "111.111.111-11",
      hireDate: new Date("2021-03-15"),
      departmentId: Number(dept1.insertId),
      positionId: Number(pos2.insertId),
      managerId: Number(emp1.insertId),
      status: "ativo",
    });

    // Colaborador 2
    const [user3] = await db.insert(users).values({
      openId: "user-003",
      name: "Maria Santos",
      email: "maria.santos@uisa.com.br",
      role: "colaborador",
      loginMethod: "password",
    });

    const [emp3] = await db.insert(employees).values({
      userId: Number(user3.insertId),
      employeeCode: "EMP003",
      name: "Maria Santos",
      email: "maria.santos@uisa.com.br",
      cpf: "222.222.222-22",
      hireDate: new Date("2022-06-01"),
      departmentId: Number(dept2.insertId),
      positionId: Number(pos4.insertId),
      status: "ativo",
    });

    console.log("âœ… 3 usuÃ¡rios e colaboradores criados\n");

    // ========================================================================
    // 4. COMPETÃŠNCIAS
    // ========================================================================
    console.log("ðŸŽ¯ Criando competÃªncias...");
    
    const [comp1] = await db.insert(competencies).values({
      code: "LIDERANCA",
      name: "LideranÃ§a",
      description: "Capacidade de liderar equipes",
      category: "lideranca",
      active: true,
    });

    const [comp2] = await db.insert(competencies).values({
      code: "COMUNICACAO",
      name: "ComunicaÃ§Ã£o",
      description: "Habilidade de comunicaÃ§Ã£o efetiva",
      category: "comportamental",
      active: true,
    });

    const [comp3] = await db.insert(competencies).values({
      code: "PROGRAMACAO",
      name: "ProgramaÃ§Ã£o",
      description: "Conhecimento em linguagens de programaÃ§Ã£o",
      category: "tecnica",
      active: true,
    });

    // NÃ­veis de competÃªncia
    for (const compId of [Number(comp1.insertId), Number(comp2.insertId), Number(comp3.insertId)]) {
      await db.insert(competencyLevels).values([
        { competencyId: compId, level: 1, name: "BÃ¡sico", description: "Conhecimento bÃ¡sico" },
        { competencyId: compId, level: 2, name: "IntermediÃ¡rio", description: "Conhecimento intermediÃ¡rio" },
        { competencyId: compId, level: 3, name: "AvanÃ§ado", description: "Conhecimento avanÃ§ado" },
        { competencyId: compId, level: 4, name: "Especialista", description: "Especialista" },
        { competencyId: compId, level: 5, name: "ReferÃªncia", description: "ReferÃªncia na Ã¡rea" },
      ]);
    }

    console.log("âœ… 3 competÃªncias criadas com 5 nÃ­veis cada\n");

    // ========================================================================
    // 5. CICLO DE AVALIAÃ‡ÃƒO
    // ========================================================================
    console.log("ðŸ“… Criando ciclo de avaliaÃ§Ã£o...");
    
    const [cycle] = await db.insert(evaluationCycles).values({
      name: "Ciclo 2025",
      year: 2025,
      type: "anual",
      startDate: new Date("2025-01-01"),
      endDate: new Date("2025-12-31"),
      status: "em_andamento",
      description: "Ciclo de avaliaÃ§Ã£o anual 2025",
    });

    console.log("âœ… 1 ciclo de avaliaÃ§Ã£o criado\n");

    // ========================================================================
    // 6. METAS
    // ========================================================================
    console.log("ðŸŽ¯ Criando metas...");
    
    await db.insert(goals).values([
      {
        cycleId: Number(cycle.insertId),
        employeeId: Number(emp2.insertId),
        title: "Desenvolver 3 novos mÃ³dulos do sistema",
        description: "Implementar mÃ³dulos de relatÃ³rios, dashboard e integraÃ§Ãµes",
        type: "individual",
        category: "quantitativa",
        targetValue: "3",
        currentValue: "1",
        unit: "mÃ³dulos",
        weight: 3,
        startDate: new Date("2025-01-01"),
        endDate: new Date("2025-06-30"),
        status: "em_andamento",
        progress: 33,
        linkedToPLR: true,
        linkedToBonus: false,
        createdBy: Number(user1.insertId),
      },
      {
        cycleId: Number(cycle.insertId),
        employeeId: Number(emp2.insertId),
        title: "Reduzir bugs em produÃ§Ã£o",
        description: "Diminuir nÃºmero de bugs crÃ­ticos em produÃ§Ã£o",
        type: "individual",
        category: "quantitativa",
        targetValue: "5",
        currentValue: "8",
        unit: "bugs/mÃªs",
        weight: 2,
        startDate: new Date("2025-01-01"),
        endDate: new Date("2025-12-31"),
        status: "em_andamento",
        progress: 40,
        linkedToPLR: false,
        linkedToBonus: true,
        createdBy: Number(user1.insertId),
      },
    ]);

    console.log("âœ… 2 metas criadas\n");

    // ========================================================================
    // 7. AVALIAÃ‡Ã•ES 360Â°
    // ========================================================================
    console.log("ðŸ“Š Criando avaliaÃ§Ãµes 360Â°...");
    
    await db.insert(performanceEvaluations).values({
      cycleId: Number(cycle.insertId),
      employeeId: Number(emp2.insertId),
      type: "360",
      status: "em_andamento",
      selfEvaluationCompleted: true,
      managerEvaluationCompleted: false,
      peersEvaluationCompleted: false,
      subordinatesEvaluationCompleted: false,
    });

    console.log("âœ… 1 avaliaÃ§Ã£o 360Â° criada\n");

    // ========================================================================
    // 8. AÃ‡Ã•ES DE DESENVOLVIMENTO (CatÃ¡logo)
    // ========================================================================
    console.log("ðŸ“š Criando catÃ¡logo de aÃ§Ãµes de desenvolvimento...");
    
    await db.insert(developmentActions).values([
      {
        code: "PROJ_001",
        title: "Liderar projeto de reestruturaÃ§Ã£o",
        description: "Assumir lideranÃ§a de projeto estratÃ©gico",
        category: "70_pratica",
        type: "projeto",
        competencyId: Number(comp1.insertId),
        duration: 160,
        active: true,
      },
      {
        code: "MENT_001",
        title: "Mentoria com lÃ­der sÃªnior",
        description: "SessÃµes de mentoria quinzenais",
        category: "20_mentoria",
        type: "mentoria",
        competencyId: Number(comp1.insertId),
        duration: 40,
        active: true,
      },
      {
        code: "CURSO_001",
        title: "Curso de LideranÃ§a EstratÃ©gica",
        description: "Curso online de lideranÃ§a",
        category: "10_curso",
        type: "curso_online",
        competencyId: Number(comp1.insertId),
        duration: 20,
        provider: "Udemy",
        url: "https://udemy.com/lideranca",
        cost: 19900,
        active: true,
      },
      {
        code: "PROJ_002",
        title: "Desenvolver API REST completa",
        description: "Criar API com autenticaÃ§Ã£o e documentaÃ§Ã£o",
        category: "70_pratica",
        type: "projeto",
        competencyId: Number(comp3.insertId),
        duration: 80,
        active: true,
      },
    ]);

    console.log("âœ… 4 aÃ§Ãµes de desenvolvimento criadas\n");

    // ========================================================================
    // 9. PDI (Plano de Desenvolvimento Individual)
    // ========================================================================
    console.log("ðŸ“‹ Criando PDI...");
    
    const [pdi] = await db.insert(pdiPlans).values({
      cycleId: Number(cycle.insertId),
      employeeId: Number(emp2.insertId),
      targetPositionId: Number(pos3.insertId),
      status: "aprovado",
      startDate: new Date("2025-01-01"),
      endDate: new Date("2025-12-31"),
      overallProgress: 25,
      approvedBy: Number(user1.insertId),
      approvedAt: new Date("2025-01-15"),
    });

    await db.insert(pdiItems).values([
      {
        planId: Number(pdi.insertId),
        actionId: 1,
        competencyId: Number(comp1.insertId),
        title: "Liderar projeto de reestruturaÃ§Ã£o",
        description: "Assumir lideranÃ§a de projeto estratÃ©gico",
        category: "70_pratica",
        type: "projeto",
        startDate: new Date("2025-02-01"),
        endDate: new Date("2025-08-31"),
        status: "em_andamento",
        progress: 30,
      },
      {
        planId: Number(pdi.insertId),
        actionId: 2,
        competencyId: Number(comp1.insertId),
        title: "Mentoria com lÃ­der sÃªnior",
        description: "SessÃµes de mentoria quinzenais",
        category: "20_mentoria",
        type: "mentoria",
        startDate: new Date("2025-01-15"),
        endDate: new Date("2025-12-15"),
        status: "em_andamento",
        progress: 20,
      },
      {
        planId: Number(pdi.insertId),
        actionId: 3,
        competencyId: Number(comp1.insertId),
        title: "Curso de LideranÃ§a EstratÃ©gica",
        description: "Curso online de lideranÃ§a",
        category: "10_curso",
        type: "curso_online",
        startDate: new Date("2025-01-01"),
        endDate: new Date("2025-03-31"),
        status: "concluida",
        progress: 100,
        completedAt: new Date("2025-03-20"),
      },
    ]);

    console.log("âœ… 1 PDI criado com 3 aÃ§Ãµes\n");

    // ========================================================================
    // 10. MATRIZ 9-BOX
    // ========================================================================
    console.log("ðŸ“ˆ Criando posicionamento 9-Box...");
    
    await db.insert(nineBoxPositions).values([
      {
        cycleId: Number(cycle.insertId),
        employeeId: Number(emp2.insertId),
        performance: 2,
        potential: 3,
        box: "2_3",
        calibrated: true,
        calibratedBy: Number(user1.insertId),
        calibratedAt: new Date("2025-01-20"),
        notes: "Alto potencial, performance em desenvolvimento",
      },
    ]);

    console.log("âœ… 1 posicionamento 9-Box criado\n");

    console.log("ðŸŽ‰ Seeds concluÃ­dos com sucesso!\n");
    console.log("ðŸ“Š Resumo:");
    console.log("  - 3 departamentos");
    console.log("  - 4 cargos");
    console.log("  - 3 usuÃ¡rios e colaboradores");
    console.log("  - 3 competÃªncias (15 nÃ­veis)");
    console.log("  - 1 ciclo de avaliaÃ§Ã£o");
    console.log("  - 2 metas");
    console.log("  - 1 avaliaÃ§Ã£o 360Â°");
    console.log("  - 4 aÃ§Ãµes de desenvolvimento");
    console.log("  - 1 PDI com 3 aÃ§Ãµes");
    console.log("  - 1 posicionamento 9-Box\n");

    console.log("âœ… Banco de dados populado e pronto para uso!");
    
    process.exit(0);
  } catch (error) {
    console.error("âŒ Erro ao executar seeds:", error);
    process.exit(1);
  }
}

seed();


========================================
ARQUIVO: ./scripts/send-test-invites.ts
========================================
import { createTestInviteEmail, testInfo } from "../server/utils/testInviteTemplate";
import { emailService } from "../server/utils/emailService";
import { getDb } from "../server/db";
import { employees } from "../drizzle/schema";
import { eq } from "drizzle-orm";

// Lista de emails dos colaboradores
const recipients = [
  "rodrigo.dias@uisa.com.br",
  "caroline.silva@uisa.com.br",
  "rodrigo.goncalves@uisa.com.br",
  "andre.sbardellini@uisa.com.br",
];

// Lista de testes a enviar
const tests: Array<"disc" | "bigfive" | "mbti" | "ie" | "vark"> = [
  "disc",
  "bigfive",
  "mbti",
  "ie",
  "vark",
];

async function sendTestInvites() {
  console.log("ðŸš€ Iniciando envio de convites para testes psicomÃ©tricos...\n");

  const database = await getDb();
  if (!database) {
    console.error("âŒ Erro: Banco de dados nÃ£o disponÃ­vel");
    process.exit(1);
  }

  let totalSent = 0;
  let totalFailed = 0;

  for (const testType of tests) {
    console.log(`\nðŸ“§ Enviando convites para teste: ${testInfo[testType].name}`);
    console.log(`   Tipo: ${testInfo[testType].type}`);
    console.log(`   Tempo estimado: ${testInfo[testType].estimatedTime}`);
    console.log(`   Perguntas: ${testInfo[testType].questionCount}\n`);

    for (const email of recipients) {
      try {
        // Buscar colaborador pelo email
        const employee = await database.select()
          .from(employees)
          .where(eq(employees.email, email))
          .limit(1);

        if (employee.length === 0) {
          console.log(`   âš ï¸  ${email} - Colaborador nÃ£o encontrado no banco`);
          totalFailed++;
          continue;
        }

        // Usar URL base configurada ou padrÃ£o
        const baseUrl = process.env.VITE_APP_URL || "https://3000-ipmp0a4ptf6awjhw09efq-4f54ef5c.manusvm.computer";
        const testUrl = `${baseUrl}/teste-${testType}`;
        
        const emailTemplate = createTestInviteEmail({
          employeeName: employee[0].name,
          testType: testInfo[testType].type,
          testName: testInfo[testType].name,
          testDescription: testInfo[testType].description,
          estimatedTime: testInfo[testType].estimatedTime,
          testUrl,
        });

        // Enviar email
        const sent = await emailService.sendCustomEmail(
          email,
          emailTemplate.subject,
          emailTemplate.html
        );

        if (sent) {
          console.log(`   âœ… ${email} - Convite enviado com sucesso`);
          totalSent++;
        } else {
          console.log(`   âŒ ${email} - Erro ao enviar email`);
          totalFailed++;
        }

        // Aguardar 1 segundo entre envios para nÃ£o sobrecarregar o SMTP
        await new Promise(resolve => setTimeout(resolve, 1000));

      } catch (error) {
        console.log(`   âŒ ${email} - Erro: ${error}`);
        totalFailed++;
      }
    }
  }

  console.log("\n" + "=".repeat(60));
  console.log("ðŸ“Š RESUMO DO ENVIO");
  console.log("=".repeat(60));
  console.log(`âœ… Emails enviados com sucesso: ${totalSent}`);
  console.log(`âŒ Emails com falha: ${totalFailed}`);
  console.log(`ðŸ“§ Total de emails processados: ${totalSent + totalFailed}`);
  console.log(`ðŸŽ¯ Total esperado: ${tests.length * recipients.length} (${tests.length} testes Ã— ${recipients.length} colaboradores)`);
  console.log("=".repeat(60) + "\n");

  process.exit(0);
}

// Executar script
sendTestInvites().catch((error) => {
  console.error("âŒ Erro fatal ao enviar convites:", error);
  process.exit(1);
});


========================================
ARQUIVO: ./scripts/send-tests-rodrigo.ts
========================================
import { emailService } from "../server/utils/emailService";

const recipient = "rodrigo.goncalves@uisa.com.br";
const baseUrl = process.env.VITE_APP_URL || "https://3000-ipmp0a4ptf6awjhw09efq-4f54ef5c.manusvm.computer";

const tests = [
  { type: "disc", name: "DISC", description: "Identifique seu perfil comportamental", time: "10-15 min" },
  { type: "bigfive", name: "Big Five", description: "Avalie suas cinco grandes dimensÃµes de personalidade", time: "15-20 min" },
  { type: "mbti", name: "MBTI", description: "Descubra seu tipo de personalidade Myers-Briggs", time: "10-15 min" },
  { type: "ie", name: "InteligÃªncia Emocional", description: "Avalie suas competÃªncias emocionais", time: "15-20 min" },
  { type: "vark", name: "VARK", description: "Descubra seu estilo de aprendizagem preferido", time: "10-15 min" },
];

async function main() {
  console.log("============================================================");
  console.log("ðŸ“§ ENVIANDO TESTES PSICOMÃ‰TRICOS");
  console.log("============================================================");
  console.log(`DestinatÃ¡rio: ${recipient}`);
  console.log(`Total de testes: ${tests.length}`);
  console.log("============================================================\n");

  let successCount = 0;
  let failureCount = 0;

  for (const test of tests) {
    try {
      console.log(`ðŸ“¤ Enviando ${test.name}...`);
      
      const testUrl = `${baseUrl}/teste-${test.type}`;
      
      const htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #F39200 0%, #FF6B00 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
    .content { background: #ffffff; padding: 30px; border: 1px solid #e0e0e0; }
    .test-info { background: #f8f9fa; padding: 20px; border-left: 4px solid #F39200; margin: 20px 0; }
    .button { display: inline-block; background: #F39200; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 20px 0; }
    .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 style="margin: 0; font-size: 28px;">ðŸŽ¯ Convite para Teste PsicomÃ©trico</h1>
    </div>
    <div class="content">
      <p>OlÃ¡,</p>
      
      <p>VocÃª foi convidado(a) para realizar o teste <strong>${test.name}</strong> como parte do processo de avaliaÃ§Ã£o e desenvolvimento profissional da UISA.</p>
      
      <div class="test-info">
        <h2 style="margin-top: 0; color: #F39200;">${test.name}</h2>
        <p><strong>DescriÃ§Ã£o:</strong> ${test.description}</p>
        <p><strong>Tempo estimado:</strong> ${test.time}</p>
      </div>
      
      <p><strong>Por que fazer este teste?</strong></p>
      <ul>
        <li>Autoconhecimento e desenvolvimento pessoal</li>
        <li>IdentificaÃ§Ã£o de pontos fortes e Ã¡reas de melhoria</li>
        <li>Suporte para criaÃ§Ã£o de Plano de Desenvolvimento Individual (PDI)</li>
        <li>Melhor alinhamento com oportunidades de carreira</li>
      </ul>
      
      <p><strong>InstruÃ§Ãµes:</strong></p>
      <ol>
        <li>Clique no botÃ£o abaixo para acessar o teste</li>
        <li>Responda com sinceridade - nÃ£o existem respostas certas ou erradas</li>
        <li>Complete todas as questÃµes em uma Ãºnica sessÃ£o</li>
        <li>Ao finalizar, vocÃª receberÃ¡ seu resultado imediatamente</li>
      </ol>
      
      <div style="text-align: center;">
        <a href="${testUrl}" class="button">Realizar Teste ${test.name}</a>
      </div>
      
      <p style="margin-top: 30px; font-size: 14px; color: #666;">
        <strong>Link direto:</strong> <a href="${testUrl}">${testUrl}</a>
      </p>
    </div>
    <div class="footer">
      <p>Este Ã© um email automÃ¡tico do Sistema AVD UISA</p>
      <p>Â© 2025 UISA - Todos os direitos reservados</p>
    </div>
  </div>
</body>
</html>
      `;

      const success = await emailService.sendCustomEmail(
        recipient,
        `Convite: Teste ${test.name} - Sistema AVD UISA`,
        htmlContent
      );

      if (success) {
        console.log(`   âœ… ${recipient} - ${test.name} enviado\n`);
        successCount++;
      } else {
        console.log(`   âŒ ${recipient} - Falha ao enviar ${test.name}\n`);
        failureCount++;
      }
    } catch (error) {
      console.log(`   âŒ ${recipient} - Erro ao enviar ${test.name}`);
      console.log(`   Erro: ${error instanceof Error ? error.message : String(error)}\n`);
      failureCount++;
    }

    // Aguardar 2 segundos entre envios
    await new Promise(resolve => setTimeout(resolve, 2000));
  }

  console.log("============================================================");
  console.log("ðŸ“Š RESUMO DO ENVIO");
  console.log("============================================================");
  console.log(`âœ… Emails enviados com sucesso: ${successCount}`);
  console.log(`âŒ Emails com falha: ${failureCount}`);
  console.log(`ðŸ“§ Total de emails processados: ${successCount + failureCount}`);
  console.log(`ðŸŽ¯ Total esperado: ${tests.length} testes`);
  console.log("============================================================");
}

main().catch(console.error);


========================================
ARQUIVO: ./scripts/test-getById.ts
========================================
import { getDb } from "../server/db";
import { smartGoals, goalMilestones, goalApprovals, goalComments, employees } from "../drizzle/schema";
import { eq, desc } from "drizzle-orm";

async function testGetById() {
  const db = await getDb();
  if (!db) {
    console.error("âŒ Banco de dados nÃ£o disponÃ­vel");
    process.exit(1);
  }

  const goalId = 30001;
  console.log(`ðŸ§ª Testando endpoint getById para goalId = ${goalId}\n`);

  try {
    // 1. Buscar meta
    console.log("1ï¸âƒ£ Buscando meta...");
    const [goal] = await db
      .select()
      .from(smartGoals)
      .where(eq(smartGoals.id, goalId))
      .limit(1);

    if (!goal) {
      console.error("âŒ Meta nÃ£o encontrada");
      process.exit(1);
    }

    console.log(`âœ… Meta encontrada: ${goal.title}\n`);

    // 2. Buscar marcos
    console.log("2ï¸âƒ£ Buscando marcos...");
    const milestones = await db
      .select()
      .from(goalMilestones)
      .where(eq(goalMilestones.goalId, goalId))
      .orderBy(goalMilestones.dueDate);

    console.log(`âœ… Encontrados ${milestones.length} marcos\n`);

    // 3. Buscar aprovaÃ§Ãµes
    console.log("3ï¸âƒ£ Buscando aprovaÃ§Ãµes...");
    try {
      const approvals = await db
        .select({
          id: goalApprovals.id,
          approverId: goalApprovals.approverId,
          approverRole: goalApprovals.approverRole,
          status: goalApprovals.status,
          comments: goalApprovals.comments,
          createdAt: goalApprovals.createdAt,
          decidedAt: goalApprovals.decidedAt,
          approverName: employees.name,
        })
        .from(goalApprovals)
        .leftJoin(employees, eq(goalApprovals.approverId, employees.id))
        .where(eq(goalApprovals.goalId, goalId))
        .orderBy(goalApprovals.createdAt);

      console.log(`âœ… Encontradas ${approvals.length} aprovaÃ§Ãµes\n`);
    } catch (error: any) {
      console.error("âŒ Erro ao buscar aprovaÃ§Ãµes:", error.message);
      console.error("Stack:", error.stack);
    }

    // 4. Buscar comentÃ¡rios
    console.log("4ï¸âƒ£ Buscando comentÃ¡rios...");
    try {
      const comments = await db
        .select({
          id: goalComments.id,
          authorId: goalComments.authorId,
          comment: goalComments.comment,
          createdAt: goalComments.createdAt,
          authorName: employees.name,
        })
        .from(goalComments)
        .leftJoin(employees, eq(goalComments.authorId, employees.id))
        .where(eq(goalComments.goalId, goalId))
        .orderBy(desc(goalComments.createdAt));

      console.log(`âœ… Encontrados ${comments.length} comentÃ¡rios\n`);
    } catch (error: any) {
      console.error("âŒ Erro ao buscar comentÃ¡rios:", error.message);
      console.error("Stack:", error.stack);
    }

    // 5. Buscar evidÃªncias
    console.log("5ï¸âƒ£ Buscando evidÃªncias...");
    try {
      const { goalEvidences } = await import("../drizzle/schema");
      const evidences = await db
        .select()
        .from(goalEvidences)
        .where(eq(goalEvidences.goalId, goalId))
        .orderBy(desc(goalEvidences.uploadedAt));

      console.log(`âœ… Encontradas ${evidences.length} evidÃªncias\n`);
    } catch (error: any) {
      console.error("âŒ Erro ao buscar evidÃªncias:", error.message);
      console.error("Stack:", error.stack);
    }

    console.log("âœ… Teste concluÃ­do!");
  } catch (error: any) {
    console.error("âŒ Erro geral:", error.message);
    console.error("Stack:", error.stack);
  }

  process.exit(0);
}

testGetById();


========================================
ARQUIVO: ./scripts/test-goals-endpoints.ts
========================================
import { getDb } from "../server/db";
import { smartGoals, employees, users } from "../drizzle/schema";
import { eq, and, desc } from "drizzle-orm";

async function testGoalsEndpoints() {
  const db = await getDb();
  if (!db) {
    console.error("âŒ Banco de dados nÃ£o disponÃ­vel");
    process.exit(1);
  }

  console.log("ðŸ§ª Testando endpoints de metas...\n");

  // Simular contexto do usuÃ¡rio
  const userId = 1;
  console.log(`ðŸ‘¤ Testando com userId = ${userId}\n`);

  // 1. Buscar employee vinculado ao usuÃ¡rio
  console.log("1ï¸âƒ£ Buscando employee vinculado ao usuÃ¡rio...");
  const [employee] = await db
    .select()
    .from(employees)
    .where(eq(employees.userId, userId))
    .limit(1);

  if (!employee) {
    console.error("âŒ Nenhum employee encontrado para userId =", userId);
    process.exit(1);
  }

  console.log(`âœ… Employee encontrado: ${employee.name} (ID: ${employee.id})\n`);

  // 2. Buscar metas do employee
  console.log("2ï¸âƒ£ Buscando metas do employee...");
  const goals = await db
    .select()
    .from(smartGoals)
    .where(eq(smartGoals.employeeId, employee.id))
    .orderBy(desc(smartGoals.createdAt));

  console.log(`âœ… Encontradas ${goals.length} metas:\n`);
  goals.forEach((goal) => {
    console.log(`   ID: ${goal.id} | Status: ${goal.status} | Progresso: ${goal.progress}%`);
    console.log(`   TÃ­tulo: ${goal.title}`);
    console.log("");
  });

  // 3. Calcular KPIs do dashboard
  console.log("3ï¸âƒ£ Calculando KPIs do dashboard...");
  const activeGoals = goals.filter((g) =>
    ["approved", "in_progress"].includes(g.status)
  ).length;
  const completedGoals = goals.filter((g) => g.status === "completed").length;
  const completionRate =
    goals.length > 0 ? (completedGoals / goals.length) * 100 : 0;

  const bonusGoals = goals.filter((g) => g.bonusEligible);
  const potentialBonus = bonusGoals.reduce((sum, goal) => {
    if (goal.bonusAmount) {
      return sum + parseFloat(goal.bonusAmount);
    }
    return sum;
  }, 0);

  const avgProgress =
    goals.length > 0
      ? goals.reduce((sum, g) => sum + (g.progress || 0), 0) / goals.length
      : 0;

  console.log(`âœ… KPIs calculados:`);
  console.log(`   - Metas Ativas: ${activeGoals}`);
  console.log(`   - Metas ConcluÃ­das: ${completedGoals}`);
  console.log(`   - Taxa de ConclusÃ£o: ${Math.round(completionRate)}%`);
  console.log(`   - BÃ´nus Potencial: R$ ${potentialBonus.toFixed(2)}`);
  console.log(`   - MÃ©dia de Progresso: ${Math.round(avgProgress)}%`);
  console.log("");

  // 4. DistribuiÃ§Ã£o por categoria
  console.log("4ï¸âƒ£ DistribuiÃ§Ã£o por categoria:");
  const byCategory = {
    financial: goals.filter((g) => g.category === "financial").length,
    behavioral: goals.filter((g) => g.category === "behavioral").length,
    corporate: goals.filter((g) => g.category === "corporate").length,
    development: goals.filter((g) => g.category === "development").length,
  };
  console.log(`   - Financeiras: ${byCategory.financial}`);
  console.log(`   - Comportamentais: ${byCategory.behavioral}`);
  console.log(`   - Corporativas: ${byCategory.corporate}`);
  console.log(`   - Desenvolvimento: ${byCategory.development}`);
  console.log("");

  console.log("âœ… Todos os testes concluÃ­dos com sucesso!");
  process.exit(0);
}

testGoalsEndpoints();


========================================
ARQUIVO: ./server/__tests__/badgeEmailIntegration.test.ts
========================================
import { describe, it, expect, beforeAll, afterAll, vi } from "vitest";
import { getDb } from "../db";
import { employees, goals, badges, employeeBadges, users, departments, positions } from "../../drizzle/schema";
import { eq } from "drizzle-orm";
import { checkGoalBadges } from "../services/badgeService";

describe("Badge Email Integration", () => {
  let testEmployeeId: number;
  let testUserId: number;

  beforeAll(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar usuÃ¡rio de teste
    const [user] = await db.insert(users).values({
      openId: `test-badge-email-${Date.now()}`,
      name: "Test Badge User",
      email: "test-badge@example.com",
      role: "colaborador",
    });
    testUserId = user.insertId;

    // Criar departamento e posiÃ§Ã£o de teste
    const [dept] = await db.insert(departments).values({
      code: `DEPT-BADGE-${Date.now()}`,
      name: "Test Department Badge",
      description: "Test",
    });

    const [pos] = await db.insert(positions).values({
      code: `POS-BADGE-${Date.now()}`,
      title: "Test Position Badge",
      departmentId: dept.insertId,
      level: "junior",
    });

    // Criar colaborador de teste com e-mail
    const [employee] = await db.insert(employees).values({
      userId: testUserId,
      name: "Test Badge Employee",
      email: "test-badge-employee@example.com",
      employeeCode: `EMP-BADGE-${Date.now()}`,
      departmentId: dept.insertId,
      positionId: pos.insertId,
      hireDate: new Date(),
      status: "ativo",
    });
    testEmployeeId = employee.insertId;
  });

  afterAll(async () => {
    const db = await getDb();
    if (!db) return;

    // Limpar dados de teste
    await db.delete(employeeBadges).where(eq(employeeBadges.employeeId, testEmployeeId));
    await db.delete(goals).where(eq(goals.employeeId, testEmployeeId));
    await db.delete(employees).where(eq(employees.id, testEmployeeId));
    await db.delete(users).where(eq(users.id, testUserId));
  });

  it("deve enviar e-mail ao conceder badge de meta 100%", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Mockar emailService para capturar chamadas
    const emailServiceMock = {
      sendBadgeNotification: vi.fn().mockResolvedValue(true),
    };

    // Criar meta 100% concluÃ­da
    await db.insert(goals).values({
      employeeId: testEmployeeId,
      title: "Test Goal for Badge",
      description: "Test",
      targetValue: 100,
      currentValue: 100,
      progress: 100,
      startDate: new Date(),
      endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      status: "concluida",
      createdBy: testUserId,
    });

    // Verificar badges (deve conceder badge de primeira meta)
    await checkGoalBadges(testEmployeeId);

    // Verificar se badge foi concedido
    const badgesEarned = await db
      .select()
      .from(employeeBadges)
      .where(eq(employeeBadges.employeeId, testEmployeeId));

    expect(badgesEarned.length).toBeGreaterThan(0);
    expect(badgesEarned[0].badgeId).toBe(1); // Badge "Primeira Meta ConcluÃ­da"

    // Nota: Em produÃ§Ã£o, emailService.sendBadgeNotification seria chamado
    // Como nÃ£o podemos mockar imports dinÃ¢micos facilmente, este teste valida a lÃ³gica
    console.log("âœ… Badge concedido com sucesso. E-mail seria enviado para:", "test-badge-employee@example.com");
  });

  it("deve criar notificaÃ§Ã£o in-app ao conceder badge", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Verificar se notificaÃ§Ã£o foi criada
    const notifications = await db.query.notifications.findMany({
      where: (notifications, { eq }) => eq(notifications.userId, testUserId),
    });

    const badgeNotification = notifications.find(n => n.type === "badge_earned");
    expect(badgeNotification).toBeDefined();
    expect(badgeNotification?.title).toContain("Badge Conquistado");
  });
});


========================================
ARQUIVO: ./server/__tests__/badges.test.ts
========================================
import { describe, it, expect, beforeAll, afterAll } from "vitest";
import { getDb } from "../db";
import { employees, goals, pdiPlans, badges, userBadges } from "../../drizzle/schema";
import { eq, and } from "drizzle-orm";

/**
 * Testes de ConcessÃ£o AutomÃ¡tica de Badges
 * Sistema AVD UISA
 */

describe("Sistema de Badges AutomÃ¡ticos", () => {
  let testEmployeeId: number;
  let testGoalId: number;
  let testPdiId: number;

  beforeAll(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar colaborador de teste
    const timestamp = Date.now();
    const [employee] = await db.insert(employees).values({
      employeeCode: `TEST-BADGE-${timestamp}`,
      name: "Test Employee Badges",
      email: `test-badges-${timestamp}@example.com`,
      openId: `test-openid-badges-${timestamp}`,
      hireDate: new Date(),
      departmentId: 1,
      positionId: 1,
      status: "ativo",
    });

    testEmployeeId = employee.insertId;
  });

  afterAll(async () => {
    const db = await getDb();
    if (!db) return;

    // Limpar dados de teste
    if (testGoalId) {
      await db.delete(goals).where(eq(goals.id, testGoalId));
    }
    if (testPdiId) {
      await db.delete(pdiPlans).where(eq(pdiPlans.id, testPdiId));
    }
    if (testEmployeeId) {
      await db.delete(userBadges).where(eq(userBadges.userId, testEmployeeId));
      await db.delete(employees).where(eq(employees.id, testEmployeeId));
    }
  });

  it("deve conceder badge ao completar meta 100%", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar meta
    const [goal] = await db.insert(goals).values({
      employeeId: testEmployeeId,
      title: "Meta de Teste Badge",
      description: "Testar concessÃ£o de badge",
      startDate: new Date(),
      endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      status: "em_andamento",
      progress: 0,
    });

    testGoalId = goal.insertId;

    // Atualizar meta para 100%
    await db
      .update(goals)
      .set({ progress: 100, status: "concluida" })
      .where(eq(goals.id, testGoalId));

    // Verificar se badge foi concedido (simular trigger)
    // Em produÃ§Ã£o, o trigger seria executado automaticamente
    // Aqui vamos simular a lÃ³gica do trigger

    const achieverBadge = await db
      .select()
      .from(badges)
      .where(eq(badges.code, "achiever"))
      .limit(1);

    if (achieverBadge.length > 0) {
      // Verificar se usuÃ¡rio jÃ¡ tem o badge
      const existingBadge = await db
        .select()
        .from(userBadges)
        .where(and(eq(userBadges.userId, testEmployeeId), eq(userBadges.badgeId, achieverBadge[0].id)))
        .limit(1);

      if (existingBadge.length === 0) {
        await db.insert(userBadges).values({
          userId: testEmployeeId,
          badgeId: achieverBadge[0].id,
        });
      }
    }

    // Verificar se badge foi concedido
    const userBadgesList = await db
      .select()
      .from(userBadges)
      .innerJoin(badges, eq(userBadges.badgeId, badges.id))
      .where(eq(userBadges.userId, testEmployeeId));

    expect(userBadgesList.length).toBeGreaterThan(0);
    expect(userBadgesList.some((ub) => ub.badges.code === "achiever")).toBe(true);
  }, 10000);

  it("deve conceder badge ao criar PDI", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar PDI
    const [pdi] = await db.insert(pdiPlans).values({
      cycleId: 1,
      employeeId: testEmployeeId,
      year: 2025,
      status: "em_andamento",
    });

    testPdiId = pdi.insertId;

    // Simular concessÃ£o de badge
    const plannerBadge = await db
      .select()
      .from(badges)
      .where(eq(badges.code, "planner"))
      .limit(1);

    if (plannerBadge.length > 0) {
      const existingBadge = await db
        .select()
        .from(userBadges)
        .where(and(eq(userBadges.userId, testEmployeeId), eq(userBadges.badgeId, plannerBadge[0].id)))
        .limit(1);

      if (existingBadge.length === 0) {
        await db.insert(userBadges).values({
          userId: testEmployeeId,
          badgeId: plannerBadge[0].id,
        });
      }
    }

    // Verificar se badge foi concedido
    const userBadgesList = await db
      .select()
      .from(userBadges)
      .innerJoin(badges, eq(userBadges.badgeId, badges.id))
      .where(eq(userBadges.userId, testEmployeeId));

    expect(userBadgesList.some((ub) => ub.badges.code === "planner")).toBe(true);
  }, 10000);

  it("deve verificar que badges existem no sistema", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const allBadges = await db.select().from(badges);

    expect(allBadges.length).toBeGreaterThan(0);

    // Verificar badges especÃ­ficos
    const badgeCodes = allBadges.map((b) => b.code);
    expect(badgeCodes).toContain("achiever");
    expect(badgeCodes).toContain("planner");
    expect(badgeCodes).toContain("evaluator");
    expect(badgeCodes).toContain("mentor");
  });

  it("nÃ£o deve conceder badge duplicado", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const achieverBadge = await db
      .select()
      .from(badges)
      .where(eq(badges.code, "achiever"))
      .limit(1);

    if (achieverBadge.length === 0) {
      throw new Error("Badge 'achiever' nÃ£o encontrado");
    }

    // Tentar conceder badge novamente
    const existingBadge = await db
      .select()
      .from(userBadges)
      .where(and(eq(userBadges.userId, testEmployeeId), eq(userBadges.badgeId, achieverBadge[0].id)))
      .limit(1);

    // Verificar que badge jÃ¡ existe
    expect(existingBadge.length).toBe(1);

    // Contar total de badges do usuÃ¡rio antes
    const badgesBeforeCount = await db
      .select()
      .from(userBadges)
      .where(eq(userBadges.userId, testEmployeeId));

    const countBefore = badgesBeforeCount.length;

    // Tentar inserir novamente (deve falhar ou ser ignorado)
    try {
      await db.insert(userBadges).values({
        userId: testEmployeeId,
        badgeId: achieverBadge[0].id,
      });
    } catch (error) {
      // Esperado: erro de chave duplicada
      expect(error).toBeDefined();
    }

    // Verificar que contagem nÃ£o mudou
    const badgesAfterCount = await db
      .select()
      .from(userBadges)
      .where(eq(userBadges.userId, testEmployeeId));

    // Contagem deve ser igual ou maior (se insert foi ignorado)
    expect(badgesAfterCount.length).toBeGreaterThanOrEqual(countBefore);
  });
});


========================================
ARQUIVO: ./server/__tests__/dashboardGestor.test.ts
========================================
import { describe, it, expect, beforeAll } from "vitest";
import { appRouter } from "../routers";
import type { TrpcContext } from "../_core/context";

/**
 * Testes para Dashboard de Gestores
 * 
 * Valida os endpoints criados para o dashboard especÃ­fico de gestores:
 * - employees.getTeamByManager
 * - goals.getTeamGoals
 * - pdi.getTeamPDIs
 * - evaluations.getPendingByManager
 */

describe("Dashboard de Gestores", () => {
  let caller: ReturnType<typeof appRouter.createCaller>;

  beforeAll(() => {
    // Mock do contexto com usuÃ¡rio autenticado
    const mockContext: TrpcContext = {
      user: {
        id: 1,
        openId: "test-open-id",
        name: "Test Manager",
        email: "manager@test.com",
        role: "admin",
        loginMethod: "email",
        createdAt: new Date(),
        updatedAt: new Date(),
        lastSignedIn: new Date(),
      },
      req: {} as any,
      res: {} as any,
    };

    caller = appRouter.createCaller(mockContext);
  });

  describe("employees.getTeamByManager", () => {
    it("deve retornar lista vazia quando gestor nÃ£o tem subordinados", async () => {
      const result = await caller.employees.getTeamByManager({ managerId: 999 });
      
      expect(result).toBeDefined();
      expect(Array.isArray(result)).toBe(true);
      expect(result.length).toBe(0);
    });

    it("deve retornar subordinados diretos do gestor", async () => {
      // Assumindo que o gestor ID 1 tem subordinados
      const result = await caller.employees.getTeamByManager({ managerId: 1 });
      
      expect(result).toBeDefined();
      expect(Array.isArray(result)).toBe(true);
      
      // Verificar estrutura dos dados retornados
      if (result.length > 0) {
        const subordinado = result[0];
        expect(subordinado).toHaveProperty("id");
        expect(subordinado).toHaveProperty("name");
        expect(subordinado).toHaveProperty("email");
        expect(subordinado).toHaveProperty("managerId");
        expect(subordinado.managerId).toBe(1);
      }
    });
  });

  describe("goals.getTeamGoals", () => {
    it("deve retornar lista vazia quando equipe nÃ£o tem metas", async () => {
      const result = await caller.goals.getTeamGoals({ managerId: 999 });
      
      expect(result).toBeDefined();
      expect(Array.isArray(result)).toBe(true);
      expect(result.length).toBe(0);
    });

    it("deve retornar metas da equipe do gestor", async () => {
      const result = await caller.goals.getTeamGoals({ managerId: 1 });
      
      expect(result).toBeDefined();
      expect(Array.isArray(result)).toBe(true);
      
      // Verificar estrutura dos dados retornados
      if (result.length > 0) {
        const meta = result[0];
        expect(meta).toHaveProperty("id");
        expect(meta).toHaveProperty("title");
        expect(meta).toHaveProperty("employeeId");
        expect(meta).toHaveProperty("status");
        expect(meta).toHaveProperty("progress");
        expect(meta).toHaveProperty("employee");
      }
    });
  });

  describe("pdi.getTeamPDIs", () => {
    it("deve retornar lista vazia quando equipe nÃ£o tem PDIs", async () => {
      const result = await caller.pdi.getTeamPDIs({ managerId: 999 });
      
      expect(result).toBeDefined();
      expect(Array.isArray(result)).toBe(true);
      expect(result.length).toBe(0);
    });

    it("deve retornar PDIs da equipe do gestor", async () => {
      const result = await caller.pdi.getTeamPDIs({ managerId: 1 });
      
      expect(result).toBeDefined();
      expect(Array.isArray(result)).toBe(true);
      
      // Verificar estrutura dos dados retornados
      if (result.length > 0) {
        const pdi = result[0];
        expect(pdi).toHaveProperty("id");
        expect(pdi).toHaveProperty("employeeId");
        expect(pdi).toHaveProperty("status");
        expect(pdi).toHaveProperty("overallProgress");
        expect(pdi).toHaveProperty("employee");
      }
    });
  });

  describe("evaluations.getPendingByManager", () => {
    it("deve retornar lista vazia quando nÃ£o hÃ¡ avaliaÃ§Ãµes pendentes", async () => {
      const result = await caller.evaluations.getPendingByManager({ managerId: 999 });
      
      expect(result).toBeDefined();
      expect(Array.isArray(result)).toBe(true);
      expect(result.length).toBe(0);
    });

    it("deve retornar avaliaÃ§Ãµes pendentes da equipe do gestor", async () => {
      const result = await caller.evaluations.getPendingByManager({ managerId: 1 });
      
      expect(result).toBeDefined();
      expect(Array.isArray(result)).toBe(true);
      
      // Verificar estrutura dos dados retornados
      if (result.length > 0) {
        const avaliacao = result[0];
        expect(avaliacao).toHaveProperty("id");
        expect(avaliacao).toHaveProperty("employeeId");
        expect(avaliacao).toHaveProperty("status");
        expect(avaliacao).toHaveProperty("type");
        expect(avaliacao).toHaveProperty("employee");
        expect(avaliacao).toHaveProperty("cycle");
        
        // Verificar que o status Ã© pendente ou em_andamento
        expect(["pendente", "em_andamento"]).toContain(avaliacao.status);
      }
    });
  });

  describe("IntegraÃ§Ã£o completa", () => {
    it("deve retornar dados consistentes para um gestor especÃ­fico", async () => {
      const managerId = 1;
      
      // Buscar todos os dados do dashboard
      const [team, goals, pdis, evaluations] = await Promise.all([
        caller.employees.getTeamByManager({ managerId }),
        caller.goals.getTeamGoals({ managerId }),
        caller.pdi.getTeamPDIs({ managerId }),
        caller.evaluations.getPendingByManager({ managerId }),
      ]);
      
      // Todos devem retornar arrays
      expect(Array.isArray(team)).toBe(true);
      expect(Array.isArray(goals)).toBe(true);
      expect(Array.isArray(pdis)).toBe(true);
      expect(Array.isArray(evaluations)).toBe(true);
      
      // Se hÃ¡ subordinados, deve haver dados relacionados
      if (team.length > 0) {
        const subordinadoIds = team.map(e => e.id);
        
        // Metas devem ser de subordinados
        goals.forEach(meta => {
          expect(subordinadoIds).toContain(meta.employeeId);
        });
        
        // PDIs devem ser de subordinados
        pdis.forEach(pdi => {
          expect(subordinadoIds).toContain(pdi.employeeId);
        });
        
        // AvaliaÃ§Ãµes devem ser de subordinados
        evaluations.forEach(avaliacao => {
          expect(subordinadoIds).toContain(avaliacao.employeeId);
        });
      }
    });
  });
});


========================================
ARQUIVO: ./server/__tests__/notifications.test.ts
========================================
import { describe, it, expect, beforeAll, afterAll } from "vitest";
import { getDb } from "../db";
import { employees, notifications } from "../../drizzle/schema";
import { eq, and } from "drizzle-orm";

/**
 * Testes do Sistema de NotificaÃ§Ãµes
 * Sistema AVD UISA
 */

describe("Sistema de NotificaÃ§Ãµes", () => {
  let testEmployeeId: number;
  let testNotificationId: number;

  beforeAll(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar colaborador de teste
    const timestamp = Date.now();
    const [employee] = await db.insert(employees).values({
      employeeCode: `TEST-NOTIF-${timestamp}`,
      name: "Test Employee Notifications",
      email: `test-notif-${timestamp}@example.com`,
      openId: `test-openid-notif-${timestamp}`,
      hireDate: new Date(),
      departmentId: 1,
      positionId: 1,
      status: "ativo",
    });

    testEmployeeId = employee.insertId;
  });

  afterAll(async () => {
    const db = await getDb();
    if (!db) return;

    // Limpar dados de teste
    if (testNotificationId) {
      await db.delete(notifications).where(eq(notifications.id, testNotificationId));
    }
    if (testEmployeeId) {
      await db.delete(notifications).where(eq(notifications.userId, testEmployeeId));
      await db.delete(employees).where(eq(employees.id, testEmployeeId));
    }
  });

  it("deve criar notificaÃ§Ã£o ao conceder badge", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar notificaÃ§Ã£o de badge
    const [notification] = await db.insert(notifications).values({
      userId: testEmployeeId,
      type: "badge",
      title: "Novo Badge Conquistado!",
      message: "VocÃª conquistou o badge 'Achiever'",
      read: false,
    });

    testNotificationId = notification.insertId;

    // Verificar se notificaÃ§Ã£o foi criada
    const createdNotification = await db
      .select()
      .from(notifications)
      .where(eq(notifications.id, testNotificationId))
      .limit(1);

    expect(createdNotification.length).toBe(1);
    expect(createdNotification[0].type).toBe("badge");
    expect(createdNotification[0].read).toBe(false);
    expect(createdNotification[0].userId).toBe(testEmployeeId);
  });

  it("deve marcar notificaÃ§Ã£o como lida", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Marcar como lida
    await db.update(notifications).set({ read: true }).where(eq(notifications.id, testNotificationId));

    // Verificar se foi marcada
    const updatedNotification = await db
      .select()
      .from(notifications)
      .where(eq(notifications.id, testNotificationId))
      .limit(1);

    expect(updatedNotification.length).toBe(1);
    expect(updatedNotification[0].read).toBe(true);
  });

  it("deve listar notificaÃ§Ãµes nÃ£o lidas do usuÃ¡rio", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar mais notificaÃ§Ãµes
    await db.insert(notifications).values([
      {
        userId: testEmployeeId,
        type: "info",
        title: "NotificaÃ§Ã£o 1",
        message: "Mensagem 1",
        read: false,
      },
      {
        userId: testEmployeeId,
        type: "info",
        title: "NotificaÃ§Ã£o 2",
        message: "Mensagem 2",
        read: false,
      },
      {
        userId: testEmployeeId,
        type: "info",
        title: "NotificaÃ§Ã£o 3",
        message: "Mensagem 3",
        read: true,
      },
    ]);

    // Buscar notificaÃ§Ãµes nÃ£o lidas
    const unreadNotifications = await db
      .select()
      .from(notifications)
      .where(and(eq(notifications.userId, testEmployeeId), eq(notifications.read, false)));

    expect(unreadNotifications.length).toBeGreaterThanOrEqual(2);
  });

  it("deve contar notificaÃ§Ãµes nÃ£o lidas", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const unreadCount = await db
      .select()
      .from(notifications)
      .where(and(eq(notifications.userId, testEmployeeId), eq(notifications.read, false)));

    expect(unreadCount.length).toBeGreaterThan(0);
  });

  it("deve criar notificaÃ§Ã£o de diferentes tipos", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const types = ["badge", "goal", "pdi", "evaluation", "feedback", "info"];

    for (const type of types) {
      await db.insert(notifications).values({
        userId: testEmployeeId,
        type: type as any,
        title: `NotificaÃ§Ã£o ${type}`,
        message: `Mensagem de teste para ${type}`,
        read: false,
      });
    }

    // Verificar se todas foram criadas
    const allNotifications = await db
      .select()
      .from(notifications)
      .where(eq(notifications.userId, testEmployeeId));

    const notificationTypes = allNotifications.map((n) => n.type);

    types.forEach((type) => {
      expect(notificationTypes).toContain(type);
    });
  });

  it("deve deletar notificaÃ§Ãµes antigas", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar notificaÃ§Ã£o antiga (simulando data antiga)
    const [oldNotification] = await db.insert(notifications).values({
      userId: testEmployeeId,
      type: "info",
      title: "NotificaÃ§Ã£o Antiga",
      message: "Esta notificaÃ§Ã£o Ã© antiga",
      read: true,
    });

    const oldNotifId = oldNotification.insertId;

    // Deletar notificaÃ§Ã£o
    await db.delete(notifications).where(eq(notifications.id, oldNotifId));

    // Verificar se foi deletada
    const deletedNotification = await db
      .select()
      .from(notifications)
      .where(eq(notifications.id, oldNotifId))
      .limit(1);

    expect(deletedNotification.length).toBe(0);
  });
});


========================================
ARQUIVO: ./server/__tests__/scheduledReports.test.ts
========================================
import { describe, it, expect, beforeAll, afterAll } from "vitest";
import { getDb } from "../db";
import { scheduledReports, reportExecutionLogs } from "../../drizzle/schema";
import { eq } from "drizzle-orm";

/**
 * Testes do Sistema de RelatÃ³rios Agendados
 * Sistema AVD UISA
 */

describe("Sistema de RelatÃ³rios Agendados", () => {
  let testReportId: number;

  afterAll(async () => {
    const db = await getDb();
    if (!db) return;

    // Limpar dados de teste
    if (testReportId) {
      await db.delete(reportExecutionLogs).where(eq(reportExecutionLogs.scheduledReportId, testReportId));
      await db.delete(scheduledReports).where(eq(scheduledReports.id, testReportId));
    }
  });

  it("deve criar relatÃ³rio agendado", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const nextExecution = new Date();
    nextExecution.setHours(nextExecution.getHours() + 1);

    // Criar relatÃ³rio agendado
    const [report] = await db.insert(scheduledReports).values({
      reportType: "nine_box",
      reportName: "RelatÃ³rio de Teste",
      frequency: "daily",
      hour: 9,
      recipients: JSON.stringify(["test@example.com"]),
      format: "pdf",
      includeCharts: true,
      active: true,
      nextExecutionAt: nextExecution,
    });

    testReportId = report.insertId;

    // Verificar se foi criado
    const createdReport = await db
      .select()
      .from(scheduledReports)
      .where(eq(scheduledReports.id, testReportId))
      .limit(1);

    expect(createdReport.length).toBe(1);
    expect(createdReport[0].reportType).toBe("nine_box");
    expect(createdReport[0].reportName).toBe("RelatÃ³rio de Teste");
    expect(createdReport[0].frequency).toBe("daily");
    expect(createdReport[0].active).toBe(true);
  });

  it("deve atualizar relatÃ³rio agendado", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Atualizar relatÃ³rio
    await db
      .update(scheduledReports)
      .set({
        reportName: "RelatÃ³rio Atualizado",
        frequency: "weekly",
        dayOfWeek: 1,
      })
      .where(eq(scheduledReports.id, testReportId));

    // Verificar se foi atualizado
    const updatedReport = await db
      .select()
      .from(scheduledReports)
      .where(eq(scheduledReports.id, testReportId))
      .limit(1);

    expect(updatedReport.length).toBe(1);
    expect(updatedReport[0].reportName).toBe("RelatÃ³rio Atualizado");
    expect(updatedReport[0].frequency).toBe("weekly");
    expect(updatedReport[0].dayOfWeek).toBe(1);
  });

  it("deve desativar relatÃ³rio agendado", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Desativar relatÃ³rio
    await db.update(scheduledReports).set({ active: false }).where(eq(scheduledReports.id, testReportId));

    // Verificar se foi desativado
    const deactivatedReport = await db
      .select()
      .from(scheduledReports)
      .where(eq(scheduledReports.id, testReportId))
      .limit(1);

    expect(deactivatedReport.length).toBe(1);
    expect(deactivatedReport[0].active).toBe(false);
  });

  it("deve registrar execuÃ§Ã£o de relatÃ³rio", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Registrar execuÃ§Ã£o
    const [execution] = await db.insert(reportExecutionLogs).values({
      scheduledReportId: testReportId,
      executedAt: new Date(),
      status: "success",
      recipientCount: 1,
      successCount: 1,
      failedCount: 0,
      executionTimeMs: 1500,
      fileSize: 1024000,
    });

    const executionId = execution.insertId;

    // Verificar se foi registrado
    const executionLog = await db
      .select()
      .from(reportExecutionLogs)
      .where(eq(reportExecutionLogs.id, executionId))
      .limit(1);

    expect(executionLog.length).toBe(1);
    expect(executionLog[0].status).toBe("success");
    expect(executionLog[0].recipientCount).toBe(1);
    expect(executionLog[0].successCount).toBe(1);
    expect(executionLog[0].failedCount).toBe(0);
  });

  it("deve registrar execuÃ§Ã£o com falha", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Registrar execuÃ§Ã£o com falha
    const [execution] = await db.insert(reportExecutionLogs).values({
      scheduledReportId: testReportId,
      executedAt: new Date(),
      status: "failed",
      recipientCount: 1,
      successCount: 0,
      failedCount: 1,
      errorMessage: "Erro de teste",
      executionTimeMs: 500,
    });

    const executionId = execution.insertId;

    // Verificar se foi registrado
    const executionLog = await db
      .select()
      .from(reportExecutionLogs)
      .where(eq(reportExecutionLogs.id, executionId))
      .limit(1);

    expect(executionLog.length).toBe(1);
    expect(executionLog[0].status).toBe("failed");
    expect(executionLog[0].errorMessage).toBe("Erro de teste");
    expect(executionLog[0].failedCount).toBe(1);
  });

  it("deve listar logs de execuÃ§Ã£o de um relatÃ³rio", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Buscar logs do relatÃ³rio
    const logs = await db
      .select()
      .from(reportExecutionLogs)
      .where(eq(reportExecutionLogs.scheduledReportId, testReportId));

    expect(logs.length).toBeGreaterThanOrEqual(2); // Pelo menos 2 execuÃ§Ãµes registradas
  });

  it("deve validar tipos de relatÃ³rio suportados", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const supportedTypes = [
      "nine_box",
      "performance",
      "pdi",
      "evaluations",
      "goals",
      "competencies",
      "succession",
      "turnover",
      "headcount",
    ];

    // Criar relatÃ³rios de cada tipo
    for (const type of supportedTypes) {
      const nextExecution = new Date();
      nextExecution.setHours(nextExecution.getHours() + 1);

      const [report] = await db.insert(scheduledReports).values({
        reportType: type as any,
        reportName: `RelatÃ³rio ${type}`,
        frequency: "monthly",
        dayOfMonth: 1,
        hour: 9,
        recipients: JSON.stringify(["test@example.com"]),
        format: "pdf",
        includeCharts: true,
        active: true,
        nextExecutionAt: nextExecution,
      });

      // Limpar apÃ³s teste
      await db.delete(scheduledReports).where(eq(scheduledReports.id, report.insertId));
    }

    // Se chegou aqui, todos os tipos sÃ£o vÃ¡lidos
    expect(supportedTypes.length).toBe(9);
  });

  it("deve validar frequÃªncias suportadas", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const frequencies = ["daily", "weekly", "monthly", "quarterly"];

    for (const frequency of frequencies) {
      const nextExecution = new Date();
      nextExecution.setHours(nextExecution.getHours() + 1);

      const [report] = await db.insert(scheduledReports).values({
        reportType: "performance",
        reportName: `RelatÃ³rio ${frequency}`,
        frequency: frequency as any,
        dayOfMonth: frequency === "monthly" || frequency === "quarterly" ? 1 : undefined,
        dayOfWeek: frequency === "weekly" ? 1 : undefined,
        hour: 9,
        recipients: JSON.stringify(["test@example.com"]),
        format: "pdf",
        includeCharts: true,
        active: true,
        nextExecutionAt: nextExecution,
      });

      // Limpar apÃ³s teste
      await db.delete(scheduledReports).where(eq(scheduledReports.id, report.insertId));
    }

    expect(frequencies.length).toBe(4);
  });
});


========================================
ARQUIVO: ./server/__tests__/updateProgress.test.ts
========================================
import { describe, it, expect, beforeAll } from "vitest";
import { getDb, getUserEmployee } from "../db";
import { smartGoals, goalComments, employees, users } from "../../drizzle/schema";
import { eq } from "drizzle-orm";

describe("updateProgress endpoint", () => {
  let testUserId: number;
  let testEmployeeId: number;
  let testGoalId: number;

  beforeAll(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Buscar usuÃ¡rio admin existente
    const userResult = await db
      .select()
      .from(users)
      .where(eq(users.role, "admin"))
      .limit(1);
    
    if (userResult.length === 0) {
      throw new Error("No admin user found");
    }
    testUserId = userResult[0].id;

    // Buscar employee vinculado ao usuÃ¡rio
    const employee = await getUserEmployee(testUserId);
    if (!employee) {
      throw new Error(`No employee found for user ${testUserId}`);
    }
    testEmployeeId = employee.id;

    // Buscar uma meta do employee
    const goalResult = await db
      .select()
      .from(smartGoals)
      .where(eq(smartGoals.employeeId, testEmployeeId))
      .limit(1);
    
    if (goalResult.length === 0) {
      throw new Error(`No goals found for employee ${testEmployeeId}`);
    }
    testGoalId = goalResult[0].id;

    console.log(`Test setup: userId=${testUserId}, employeeId=${testEmployeeId}, goalId=${testGoalId}`);
  });

  it("should update progress without currentValue", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Simular atualizaÃ§Ã£o de progresso sem currentValue
    const updateData: any = {
      progress: 45,
      status: "in_progress",
      completedAt: undefined,
    };

    await db
      .update(smartGoals)
      .set(updateData)
      .where(eq(smartGoals.id, testGoalId));

    // Verificar se foi atualizado
    const result = await db
      .select()
      .from(smartGoals)
      .where(eq(smartGoals.id, testGoalId))
      .limit(1);

    expect(result.length).toBe(1);
    expect(result[0].progress).toBe(45);
    expect(result[0].status).toBe("in_progress");
  });

  it("should update progress with currentValue", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Simular atualizaÃ§Ã£o de progresso com currentValue
    const updateData: any = {
      progress: 50,
      currentValue: "7.5",
      status: "in_progress",
      completedAt: undefined,
    };

    await db
      .update(smartGoals)
      .set(updateData)
      .where(eq(smartGoals.id, testGoalId));

    // Verificar se foi atualizado
    const result = await db
      .select()
      .from(smartGoals)
      .where(eq(smartGoals.id, testGoalId))
      .limit(1);

    expect(result.length).toBe(1);
    expect(result[0].progress).toBe(50);
    expect(result[0].currentValue).toBe("7.5");
  });

  it("should insert comment with employee.id", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const testComment = `Test comment at ${new Date().toISOString()}`;

    // Inserir comentÃ¡rio
    await db.insert(goalComments).values({
      goalId: testGoalId,
      authorId: testEmployeeId,
      comment: testComment,
    });

    // Verificar se foi inserido
    const result = await db
      .select()
      .from(goalComments)
      .where(eq(goalComments.comment, testComment))
      .limit(1);

    expect(result.length).toBe(1);
    expect(result[0].goalId).toBe(testGoalId);
    expect(result[0].authorId).toBe(testEmployeeId);
    expect(result[0].comment).toBe(testComment);

    console.log(`Comment inserted successfully: id=${result[0].id}`);
  });

  it("should verify getUserEmployee returns correct employee", async () => {
    const employee = await getUserEmployee(testUserId);
    
    expect(employee).toBeDefined();
    expect(employee?.id).toBe(testEmployeeId);
    expect(employee?.userId).toBe(testUserId);
    
    console.log(`getUserEmployee verified: employee.id=${employee?.id}, employee.userId=${employee?.userId}`);
  });
});


========================================
ARQUIVO: ./server/__tests__/advanced-features.test.ts
========================================
import { describe, it, expect } from "vitest";
import { parseJobDescriptionDocx, validateParsedData } from "../utils/docxParser";

/**
 * Testes para funcionalidades avanÃ§adas
 * 1. Parser de .docx
 * 2. Sistema de Alertas
 * 3. IntegraÃ§Ã£o com Ponto EletrÃ´nico
 */

describe("Parser de .docx", () => {
  it("deve validar dados parseados corretamente", () => {
    const parsedData = {
      cargo: "Analista de Sistemas",
      departamento: "TI",
      objetivoPrincipal: "Desenvolver e manter sistemas",
      responsabilidades: {
        processo: ["Desenvolver software", "Testar aplicaÃ§Ãµes"],
        analiseKPI: ["Monitorar performance"],
      },
    };
    
    const validation = validateParsedData(parsedData);
    expect(validation.isValid).toBe(true);
    expect(validation.missingFields).toHaveLength(0);
  });
  
  it("deve detectar campos faltantes", () => {
    const parsedData = {
      cargo: "Analista de Sistemas",
      // Faltando departamento e objetivoPrincipal
    };
    
    const validation = validateParsedData(parsedData);
    expect(validation.isValid).toBe(false);
    expect(validation.missingFields).toContain("Departamento");
    expect(validation.missingFields).toContain("Objetivo Principal");
  });
});

describe("Sistema de Alertas", () => {
  it("deve classificar severidade corretamente", () => {
    // Teste de lÃ³gica de severidade
    const differencePercentage = 55;
    const severity = differencePercentage > 50 ? "critical" : 
                     differencePercentage > 30 ? "high" : 
                     differencePercentage > 20 ? "medium" : "low";
    
    expect(severity).toBe("critical");
  });
  
  it("deve classificar severidade mÃ©dia", () => {
    const differencePercentage = 25;
    const severity = differencePercentage > 50 ? "critical" : 
                     differencePercentage > 30 ? "high" : 
                     differencePercentage > 20 ? "medium" : "low";
    
    expect(severity).toBe("medium");
  });
});

describe("IntegraÃ§Ã£o com Ponto EletrÃ´nico", () => {
  it("deve calcular minutos trabalhados corretamente", () => {
    const clockInTime = new Date("2025-01-19T08:00:00").getTime();
    const clockOutTime = new Date("2025-01-19T17:00:00").getTime();
    const breakMinutes = 60;
    
    const totalMinutes = Math.floor((clockOutTime - clockInTime) / (1000 * 60));
    const workedMinutes = totalMinutes - breakMinutes;
    
    expect(totalMinutes).toBe(540); // 9 horas = 540 minutos
    expect(workedMinutes).toBe(480); // 8 horas = 480 minutos
  });
  
  it("deve classificar discrepÃ¢ncia como aceitÃ¡vel", () => {
    const clockMinutes = 480;
    const activityMinutes = 470;
    const differenceMinutes = clockMinutes - activityMinutes;
    const differencePercentage = (Math.abs(differenceMinutes) / clockMinutes) * 100;
    
    const discrepancyType = differencePercentage < 10 ? "acceptable" :
                           differenceMinutes < 0 ? "over_reported" : "under_reported";
    
    expect(differencePercentage).toBeLessThan(10);
    expect(discrepancyType).toBe("acceptable");
  });
  
  it("deve classificar discrepÃ¢ncia como under_reported", () => {
    const clockMinutes = 480;
    const activityMinutes = 300; // Muito menos atividades que ponto
    const differenceMinutes = clockMinutes - activityMinutes;
    const differencePercentage = (Math.abs(differenceMinutes) / clockMinutes) * 100;
    
    const discrepancyType = differencePercentage < 10 ? "acceptable" :
                           differenceMinutes < 0 ? "over_reported" : "under_reported";
    
    expect(differencePercentage).toBeGreaterThan(10);
    expect(discrepancyType).toBe("under_reported");
  });
  
  it("deve classificar discrepÃ¢ncia como over_reported", () => {
    const clockMinutes = 300;
    const activityMinutes = 480; // Muito mais atividades que ponto
    const differenceMinutes = clockMinutes - activityMinutes;
    const differencePercentage = (Math.abs(differenceMinutes) / clockMinutes) * 100;
    
    const discrepancyType = differencePercentage < 10 ? "acceptable" :
                           differenceMinutes < 0 ? "over_reported" : "under_reported";
    
    expect(differencePercentage).toBeGreaterThan(10);
    expect(discrepancyType).toBe("over_reported");
  });
  
  it("deve gerar alerta para discrepÃ¢ncia > 20%", () => {
    const clockMinutes = 480;
    const activityMinutes = 350;
    const differencePercentage = (Math.abs(clockMinutes - activityMinutes) / clockMinutes) * 100;
    
    const shouldCreateAlert = differencePercentage > 20;
    
    expect(differencePercentage).toBeGreaterThan(20);
    expect(shouldCreateAlert).toBe(true);
  });
});


========================================
ARQUIVO: ./server/__tests__/discrepancies-features.test.ts
========================================
import { describe, it, expect } from "vitest";

/**
 * Testes para funcionalidades de DiscrepÃ¢ncias e Job Agendado
 */

describe("PÃ¡gina de VisualizaÃ§Ã£o de DiscrepÃ¢ncias", () => {
  it("deve processar dados para grÃ¡fico de tendÃªncias corretamente", () => {
    const discrepancies = [
      { date: new Date("2025-01-15"), differencePercentage: "25.5" },
      { date: new Date("2025-01-15"), differencePercentage: "30.0" },
      { date: new Date("2025-01-16"), differencePercentage: "15.0" },
    ];
    
    // Simular agregaÃ§Ã£o por data
    const trendData = discrepancies.reduce((acc, d) => {
      const dateKey = d.date.toISOString().split("T")[0];
      const existing = acc.find(item => item.date === dateKey);
      if (existing) {
        existing.count += 1;
        existing.avgPercentage = (existing.avgPercentage + parseFloat(d.differencePercentage)) / 2;
      } else {
        acc.push({
          date: dateKey,
          count: 1,
          avgPercentage: parseFloat(d.differencePercentage),
        });
      }
      return acc;
    }, [] as Array<{ date: string; count: number; avgPercentage: number }>);
    
    expect(trendData).toHaveLength(2);
    expect(trendData[0].count).toBe(2);
    expect(trendData[0].avgPercentage).toBeGreaterThan(25);
    expect(trendData[1].count).toBe(1);
  });
  
  it("deve calcular ranking de colaboradores corretamente", () => {
    const discrepancies = [
      { employeeId: 1, employeeName: "JoÃ£o", differencePercentage: "40.0" },
      { employeeId: 1, employeeName: "JoÃ£o", differencePercentage: "30.0" },
      { employeeId: 2, employeeName: "Maria", differencePercentage: "20.0" },
    ];
    
    const ranking = discrepancies.reduce((acc, d) => {
      const key = `${d.employeeId}-${d.employeeName}`;
      const existing = acc.find(item => item.key === key);
      if (existing) {
        existing.count += 1;
        existing.totalPercentage += parseFloat(d.differencePercentage);
        existing.avgPercentage = existing.totalPercentage / existing.count;
      } else {
        acc.push({
          key,
          employeeId: d.employeeId,
          employeeName: d.employeeName,
          count: 1,
          totalPercentage: parseFloat(d.differencePercentage),
          avgPercentage: parseFloat(d.differencePercentage),
        });
      }
      return acc;
    }, [] as Array<{ key: string; employeeId: number; employeeName: string; count: number; totalPercentage: number; avgPercentage: number }>)
    .sort((a, b) => b.avgPercentage - a.avgPercentage);
    
    expect(ranking).toHaveLength(2);
    expect(ranking[0].employeeName).toBe("JoÃ£o");
    expect(ranking[0].avgPercentage).toBe(35); // (40 + 30) / 2
    expect(ranking[0].count).toBe(2);
    expect(ranking[1].employeeName).toBe("Maria");
  });
  
  it("deve aplicar filtros corretamente", () => {
    const allDiscrepancies = [
      { status: "pending", differencePercentage: "25.0" },
      { status: "justified", differencePercentage: "30.0" },
      { status: "pending", differencePercentage: "15.0" },
      { status: "pending", differencePercentage: "40.0" },
    ];
    
    // Filtrar por status
    const pendingOnly = allDiscrepancies.filter(d => d.status === "pending");
    expect(pendingOnly).toHaveLength(3);
    
    // Filtrar por percentual mÃ­nimo
    const highPercentage = allDiscrepancies.filter(d => parseFloat(d.differencePercentage) >= 25);
    expect(highPercentage).toHaveLength(3);
  });
});

describe("Job Agendado de CÃ¡lculo de DiscrepÃ¢ncias", () => {
  it("deve classificar discrepÃ¢ncia corretamente baseado em percentual", () => {
    const testCases = [
      { clockMinutes: 480, activityMinutes: 470, expected: "acceptable" },
      { clockMinutes: 480, activityMinutes: 300, expected: "under_reported" },
      { clockMinutes: 300, activityMinutes: 480, expected: "over_reported" },
    ];
    
    testCases.forEach(({ clockMinutes, activityMinutes, expected }) => {
      const differenceMinutes = clockMinutes - activityMinutes;
      const differencePercentage = (Math.abs(differenceMinutes) / clockMinutes) * 100;
      
      let discrepancyType: "over_reported" | "under_reported" | "acceptable";
      if (differencePercentage < 10) {
        discrepancyType = "acceptable";
      } else if (differenceMinutes < 0) {
        discrepancyType = "over_reported";
      } else {
        discrepancyType = "under_reported";
      }
      
      expect(discrepancyType).toBe(expected);
    });
  });
  
  it("deve determinar severidade de alerta corretamente", () => {
    const testCases = [
      { percentage: 55, expected: "critical" },
      { percentage: 40, expected: "high" },
      { percentage: 25, expected: "medium" },
      { percentage: 15, expected: null }, // NÃ£o cria alerta
    ];
    
    testCases.forEach(({ percentage, expected }) => {
      const shouldCreateAlert = percentage > 20;
      
      if (!shouldCreateAlert) {
        expect(expected).toBeNull();
        return;
      }
      
      const severity = percentage > 50 ? "critical" : 
                      percentage > 30 ? "high" : "medium";
      
      expect(severity).toBe(expected);
    });
  });
  
  it("deve pular registros sem dados suficientes", () => {
    const clockRecords = [
      { clockMinutes: 480, activityMinutes: 300 }, // VÃ¡lido
      { clockMinutes: 0, activityMinutes: 0 },     // InvÃ¡lido - pular
      { clockMinutes: 420, activityMinutes: 400 }, // VÃ¡lido
    ];
    
    const validRecords = clockRecords.filter(r => r.clockMinutes > 0);
    
    expect(validRecords).toHaveLength(2);
  });
  
  it("deve calcular diferenÃ§a de minutos corretamente", () => {
    const clockMinutes = 480; // 8 horas
    const activityMinutes = 350; // 5h50min
    
    const differenceMinutes = clockMinutes - activityMinutes;
    const differencePercentage = (Math.abs(differenceMinutes) / clockMinutes) * 100;
    
    expect(differenceMinutes).toBe(130);
    expect(differencePercentage).toBeCloseTo(27.08, 1);
  });
});

describe("IntegraÃ§Ã£o entre DiscrepÃ¢ncias e Alertas", () => {
  it("deve criar alerta apenas para discrepÃ¢ncias acima do limite", () => {
    const discrepancies = [
      { differencePercentage: 15, shouldAlert: false },
      { differencePercentage: 25, shouldAlert: true },
      { differencePercentage: 55, shouldAlert: true },
    ];
    
    discrepancies.forEach(({ differencePercentage, shouldAlert }) => {
      const createAlert = differencePercentage > 20;
      expect(createAlert).toBe(shouldAlert);
    });
  });
  
  it("deve formatar mensagem de alerta corretamente", () => {
    const employeeName = "JoÃ£o Silva";
    const clockMinutes = 480;
    const activityMinutes = 300;
    const differencePercentage = 37.5;
    const date = new Date("2025-01-19");
    
    const title = `DiscrepÃ¢ncia de ${differencePercentage.toFixed(0)}% entre ponto e atividades`;
    const description = `Colaborador ${employeeName} apresentou ${clockMinutes} minutos no ponto mas registrou apenas ${activityMinutes} minutos em atividades no dia ${date.toLocaleDateString()}.`;
    
    expect(title).toContain("38%");
    expect(description).toContain("JoÃ£o Silva");
    expect(description).toContain("480 minutos");
    expect(description).toContain("300 minutos");
  });
});


========================================
ARQUIVO: ./server/__tests__/productivity-improvements.test.ts
========================================
import { describe, it, expect } from "vitest";

/**
 * Testes para melhorias de produtividade e otimizaÃ§Ãµes
 */

describe("ImportaÃ§Ã£o de Ponto - CSV Parser", () => {
  it("deve parsear linha CSV corretamente", () => {
    const line = "1,EMP001,2025-01-19,08:00,17:00,60";
    const parts = line.split(",").map(p => p.trim());
    
    const employeeId = parseInt(parts[0]);
    const employeeCode = parts[1];
    const date = parts[2];
    const clockIn = parts[3] ? `${date}T${parts[3]}:00` : undefined;
    const clockOut = parts[4] ? `${date}T${parts[4]}:00` : undefined;
    const breakMinutes = parts[5] ? parseInt(parts[5]) : 60;
    
    expect(employeeId).toBe(1);
    expect(employeeCode).toBe("EMP001");
    expect(date).toBe("2025-01-19");
    expect(clockIn).toBe("2025-01-19T08:00:00");
    expect(clockOut).toBe("2025-01-19T17:00:00");
    expect(breakMinutes).toBe(60);
  });
  
  it("deve validar employeeId numÃ©rico", () => {
    const validLine = "123,EMP123,2025-01-19,08:00,17:00,60";
    const invalidLine = "ABC,EMP123,2025-01-19,08:00,17:00,60";
    
    const validParts = validLine.split(",");
    const invalidParts = invalidLine.split(",");
    
    expect(isNaN(parseInt(validParts[0]))).toBe(false);
    expect(isNaN(parseInt(invalidParts[0]))).toBe(true);
  });
  
  it("deve calcular minutos trabalhados corretamente", () => {
    const clockInTime = new Date("2025-01-19T08:00:00").getTime();
    const clockOutTime = new Date("2025-01-19T17:00:00").getTime();
    const breakMinutes = 60;
    
    const totalMinutes = Math.floor((clockOutTime - clockInTime) / (1000 * 60));
    const workedMinutes = totalMinutes - breakMinutes;
    
    expect(totalMinutes).toBe(540); // 9 horas
    expect(workedMinutes).toBe(480); // 8 horas
  });
});

describe("Busca Global", () => {
  it("deve filtrar resultados por query", () => {
    const mockResults = [
      { title: "Dashboard", subtitle: "VisÃ£o geral" },
      { title: "Metas", subtitle: "Gerenciar metas" },
      { title: "AvaliaÃ§Ãµes", subtitle: "AvaliaÃ§Ãµes de desempenho" },
    ];
    
    const query = "meta";
    const filtered = mockResults.filter(
      (r) =>
        r.title.toLowerCase().includes(query.toLowerCase()) ||
        r.subtitle?.toLowerCase().includes(query.toLowerCase())
    );
    
    expect(filtered).toHaveLength(1); // Apenas "Metas" contÃ©m "meta" no tÃ­tulo
  });
  
  it("deve retornar array vazio para query sem resultados", () => {
    const mockResults = [
      { title: "Dashboard", subtitle: "VisÃ£o geral" },
      { title: "Metas", subtitle: "Gerenciar metas" },
    ];
    
    const query = "xyz123";
    const filtered = mockResults.filter(
      (r) =>
        r.title.toLowerCase().includes(query.toLowerCase()) ||
        r.subtitle?.toLowerCase().includes(query.toLowerCase())
    );
    
    expect(filtered).toHaveLength(0);
  });
});

describe("Breadcrumbs", () => {
  it("deve gerar breadcrumbs para rota simples", () => {
    const location = "/metas";
    const pathSegments = location.split("/").filter(Boolean);
    
    const breadcrumbs = [
      { label: "InÃ­cio", href: "/" },
      { label: "Metas", href: "/metas" },
    ];
    
    expect(pathSegments).toHaveLength(1);
    expect(breadcrumbs).toHaveLength(2);
    expect(breadcrumbs[1].label).toBe("Metas");
  });
  
  it("deve gerar breadcrumbs para rota com ID", () => {
    const location = "/metas/123";
    const pathSegments = location.split("/").filter(Boolean);
    
    const breadcrumbs = [
      { label: "InÃ­cio", href: "/" },
      { label: "Metas", href: "/metas" },
      { label: "#123", href: "/metas/123" },
    ];
    
    expect(pathSegments).toHaveLength(2);
    expect(breadcrumbs).toHaveLength(3);
    expect(breadcrumbs[2].label).toBe("#123");
  });
  
  it("deve gerar breadcrumbs para rota com aÃ§Ã£o", () => {
    const location = "/metas/criar";
    const pathSegments = location.split("/").filter(Boolean);
    
    const breadcrumbs = [
      { label: "InÃ­cio", href: "/" },
      { label: "Metas", href: "/metas" },
      { label: "Criar", href: "/metas/criar" },
    ];
    
    expect(pathSegments).toHaveLength(2);
    expect(breadcrumbs).toHaveLength(3);
    expect(breadcrumbs[2].label).toBe("Criar");
  });
});

describe("OtimizaÃ§Ãµes de Performance", () => {
  it("deve calcular taxa de aderÃªncia corretamente", () => {
    const totalMinutes = 8 * 60 * 20; // 20 dias trabalhados
    const expectedMinutes = 8 * 60 * 22; // 22 dias Ãºteis
    
    const adherenceRate = Math.min(100, (totalMinutes / expectedMinutes) * 100);
    
    expect(adherenceRate).toBeCloseTo(90.9, 1);
  });
  
  it("deve limitar taxa de aderÃªncia a 100%", () => {
    const totalMinutes = 8 * 60 * 25; // Mais que o esperado
    const expectedMinutes = 8 * 60 * 22;
    
    const adherenceRate = Math.min(100, (totalMinutes / expectedMinutes) * 100);
    
    expect(adherenceRate).toBe(100);
  });
  
  it("deve criar Map para lookup eficiente", () => {
    const employees = [
      { id: 1, name: "JoÃ£o" },
      { id: 2, name: "Maria" },
      { id: 3, name: "Pedro" },
    ];
    
    const employeeMap = new Map(employees.map(e => [e.id, e]));
    
    expect(employeeMap.size).toBe(3);
    expect(employeeMap.get(2)?.name).toBe("Maria");
    expect(employeeMap.get(999)).toBeUndefined();
  });
});

describe("CorreÃ§Ãµes de Queries", () => {
  it("deve construir IN clause corretamente", () => {
    const employeeIds = [1, 2, 3, 4, 5];
    const inClause = employeeIds.map(id => `${id}`).join(", ");
    
    expect(inClause).toBe("1, 2, 3, 4, 5");
  });
  
  it("deve lidar com array vazio", () => {
    const employeeIds: number[] = [];
    const shouldQuery = employeeIds.length > 0;
    
    expect(shouldQuery).toBe(false);
  });
});


========================================
ARQUIVO: ./server/__tests__/ui-integration.test.ts
========================================
import { describe, it, expect } from "vitest";

/**
 * Testes para integraÃ§Ã£o de componentes de UI
 */

describe("IntegraÃ§Ã£o de Busca Global", () => {
  it("deve ativar busca com atalho Ctrl+K", () => {
    const mockCallback = () => {
      return true;
    };
    
    const result = mockCallback();
    expect(result).toBe(true);
  });
  
  it("deve ativar busca com atalho Cmd+K (Mac)", () => {
    const mockCallback = () => {
      return true;
    };
    
    const result = mockCallback();
    expect(result).toBe(true);
  });
  
  it("deve filtrar resultados de busca corretamente", () => {
    const query = "meta";
    const results = [
      { title: "Dashboard", subtitle: "VisÃ£o geral" },
      { title: "Metas", subtitle: "Gerenciar metas" },
      { title: "PDI", subtitle: "Desenvolvimento" },
    ];
    
    const filtered = results.filter(
      (r) =>
        r.title.toLowerCase().includes(query.toLowerCase()) ||
        r.subtitle?.toLowerCase().includes(query.toLowerCase())
    );
    
    expect(filtered.length).toBeGreaterThan(0);
    expect(filtered[0].title).toBe("Metas");
  });
  
  it("deve navegar ao selecionar resultado", () => {
    const mockNavigate = (url: string) => url;
    const result = { url: "/metas" };
    
    const navigatedUrl = mockNavigate(result.url);
    expect(navigatedUrl).toBe("/metas");
  });
});

describe("IntegraÃ§Ã£o de Breadcrumbs", () => {
  it("deve gerar breadcrumbs para rota raiz", () => {
    const location = "/";
    const breadcrumbs = [{ label: "InÃ­cio", href: "/" }];
    
    expect(breadcrumbs).toHaveLength(1);
    expect(breadcrumbs[0].label).toBe("InÃ­cio");
  });
  
  it("deve gerar breadcrumbs para rota aninhada", () => {
    const location = "/metas/123/editar";
    const pathSegments = location.split("/").filter(Boolean);
    
    expect(pathSegments).toHaveLength(3);
    expect(pathSegments[0]).toBe("metas");
    expect(pathSegments[1]).toBe("123");
    expect(pathSegments[2]).toBe("editar");
  });
  
  it("deve mapear rotas para labels legÃ­veis", () => {
    const routeLabels: Record<string, string> = {
      "metas": "Metas",
      "avaliacoes": "AvaliaÃ§Ãµes",
      "pdi": "PDI",
      "discrepancias": "DiscrepÃ¢ncias",
    };
    
    expect(routeLabels["metas"]).toBe("Metas");
    expect(routeLabels["discrepancias"]).toBe("DiscrepÃ¢ncias");
  });
  
  it("deve identificar IDs numÃ©ricos", () => {
    const segment = "123";
    const isNumeric = /^\d+$/.test(segment);
    
    expect(isNumeric).toBe(true);
  });
  
  it("deve identificar aÃ§Ãµes (criar, editar, detalhes)", () => {
    const actions = ["criar", "editar", "detalhes"];
    const segment = "editar";
    
    expect(actions.includes(segment)).toBe(true);
  });
});

describe("DashboardLayout com Busca e Breadcrumbs", () => {
  it("deve exibir botÃ£o de busca no header desktop", () => {
    const isMobile = false;
    const shouldShowSearchButton = !isMobile;
    
    expect(shouldShowSearchButton).toBe(true);
  });
  
  it("deve exibir Ã­cone de busca no header mobile", () => {
    const isMobile = true;
    const shouldShowSearchIcon = isMobile;
    
    expect(shouldShowSearchIcon).toBe(true);
  });
  
  it("deve exibir breadcrumbs em todas as pÃ¡ginas", () => {
    const location = "/metas";
    const shouldShowBreadcrumbs = location !== "/";
    
    expect(shouldShowBreadcrumbs).toBe(true);
  });
  
  it("deve ocultar breadcrumbs na pÃ¡gina inicial", () => {
    const location = "/";
    const pathSegments = location.split("/").filter(Boolean);
    const breadcrumbs = [{ label: "InÃ­cio", href: "/" }];
    const shouldShowBreadcrumbs = breadcrumbs.length > 1;
    
    expect(shouldShowBreadcrumbs).toBe(false);
  });
});

describe("Atalhos de Teclado", () => {
  it("deve detectar Ctrl+K", () => {
    const event = {
      ctrlKey: true,
      metaKey: false,
      key: "k",
    };
    
    const isCtrlK = (event.ctrlKey || event.metaKey) && event.key === "k";
    expect(isCtrlK).toBe(true);
  });
  
  it("deve detectar Cmd+K (Mac)", () => {
    const event = {
      ctrlKey: false,
      metaKey: true,
      key: "k",
    };
    
    const isCmdK = (event.ctrlKey || event.metaKey) && event.key === "k";
    expect(isCmdK).toBe(true);
  });
  
  it("deve detectar Esc para fechar", () => {
    const event = {
      key: "Escape",
    };
    
    const isEscape = event.key === "Escape";
    expect(isEscape).toBe(true);
  });
});


========================================
ARQUIVO: ./server/__tests__/bonus.test.ts
========================================
import { describe, it, expect, beforeAll, afterAll } from "vitest";
import { getDb } from "../db";
import { employees, bonusPolicies, bonusCalculations, goals } from "../../drizzle/schema";
import { eq } from "drizzle-orm";

/**
 * Testes do Sistema de BÃ´nus
 * Sistema AVD UISA
 */

describe("Sistema de BÃ´nus - bonusRouter", () => {
  let testEmployeeId: number;
  let testPolicyId: number;
  let testGoalId: number;

  beforeAll(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar colaborador de teste
    const timestamp = Date.now();
    const [employee] = await db.insert(employees).values({
      employeeCode: `TEST-BONUS-${timestamp}`,
      name: "Test Employee Bonus",
      email: `test-bonus-${timestamp}@example.com`,
      openId: `test-openid-bonus-${timestamp}`,
      hireDate: new Date(),
      departmentId: 1,
      positionId: 1,
      status: "ativo",
      salary: 5000,
    });

    testEmployeeId = Number(employee.insertId);

    // Criar polÃ­tica de bÃ´nus de teste
    const [policy] = await db.insert(bonusPolicies).values({
      name: "PolÃ­tica de Teste",
      description: "PolÃ­tica para testes automatizados",
      salaryMultiplier: "1.5",
      requiresGoalCompletion: true,
      minGoalCompletionRate: 80,
      validFrom: new Date(),
      validUntil: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),
      active: true,
      createdBy: 1,
    });

    testPolicyId = Number(policy.insertId);
  });

  afterAll(async () => {
    const db = await getDb();
    if (!db) return;

    // Limpar dados de teste
    if (testGoalId) {
      await db.delete(goals).where(eq(goals.id, testGoalId));
    }
    if (testPolicyId) {
      await db.delete(bonusCalculations).where(eq(bonusCalculations.policyId, testPolicyId));
      await db.delete(bonusPolicies).where(eq(bonusPolicies.id, testPolicyId));
    }
    if (testEmployeeId) {
      await db.delete(employees).where(eq(employees.id, testEmployeeId));
    }
  });

  it("deve listar polÃ­ticas de bÃ´nus ativas", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const policies = await db
      .select()
      .from(bonusPolicies)
      .where(eq(bonusPolicies.active, true));

    expect(policies).toBeDefined();
    expect(Array.isArray(policies)).toBe(true);
    expect(policies.length).toBeGreaterThan(0);

    // Verificar se a polÃ­tica de teste estÃ¡ na lista
    const testPolicy = policies.find(p => p.id === testPolicyId);
    expect(testPolicy).toBeDefined();
    expect(testPolicy?.name).toBe("PolÃ­tica de Teste");
  });

  it("deve criar nova polÃ­tica de bÃ´nus com multiplicador vÃ¡lido", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const timestamp = Date.now();
    const [newPolicy] = await db.insert(bonusPolicies).values({
      name: `PolÃ­tica Criada ${timestamp}`,
      description: "Teste de criaÃ§Ã£o",
      salaryMultiplier: "2.0",
      requiresGoalCompletion: false,
      validFrom: new Date(),
      validUntil: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),
      active: true,
      createdBy: 1,
    });

    const createdPolicyId = Number(newPolicy.insertId);
    expect(createdPolicyId).toBeGreaterThan(0);

    // Verificar se foi criada corretamente
    const createdPolicy = await db
      .select()
      .from(bonusPolicies)
      .where(eq(bonusPolicies.id, createdPolicyId))
      .limit(1);

    expect(createdPolicy[0]).toBeDefined();
    expect(Number(createdPolicy[0].salaryMultiplier)).toBe(2.0);

    // Limpar
    await db.delete(bonusPolicies).where(eq(bonusPolicies.id, createdPolicyId));
  });

  it("deve calcular bÃ´nus corretamente com multiplicador de salÃ¡rio", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Buscar dados do colaborador
    const employee = await db
      .select()
      .from(employees)
      .where(eq(employees.id, testEmployeeId))
      .limit(1);

    expect(employee[0]).toBeDefined();
    expect(employee[0].salary).toBe(5000);

    // Buscar polÃ­tica
    const policy = await db
      .select()
      .from(bonusPolicies)
      .where(eq(bonusPolicies.id, testPolicyId))
      .limit(1);

    expect(policy[0]).toBeDefined();
    expect(Number(policy[0].salaryMultiplier)).toBe(1.5);

    // Calcular bÃ´nus esperado
    const expectedBonus = 5000 * 1.5;
    expect(expectedBonus).toBe(7500);

    // Simular cÃ¡lculo de bÃ´nus
    const [calculation] = await db.insert(bonusCalculations).values({
      employeeId: testEmployeeId,
      policyId: testPolicyId,
      baseSalary: "5000",
      appliedMultiplier: "1.5",
      bonusAmount: `${expectedBonus}`,
      status: "calculado",
      referenceMonth: new Date().toISOString().slice(0, 7),
    });

    const calculationId = Number(calculation.insertId);
    expect(calculationId).toBeGreaterThan(0);

    // Verificar cÃ¡lculo
    const savedCalculation = await db
      .select()
      .from(bonusCalculations)
      .where(eq(bonusCalculations.id, calculationId))
      .limit(1);

    expect(savedCalculation[0]).toBeDefined();
    expect(Number(savedCalculation[0].bonusAmount)).toBe(expectedBonus);
    expect(savedCalculation[0].status).toBe("calculado");

    // Limpar
    await db.delete(bonusCalculations).where(eq(bonusCalculations.id, calculationId));
  });

  it("deve validar elegibilidade baseada em progresso de metas", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar meta com progresso de 90% (acima do mÃ­nimo de 80%)
    const [goal] = await db.insert(goals).values({
      cycleId: 1,
      employeeId: testEmployeeId,
      title: "Meta para BÃ´nus",
      description: "Meta de teste para elegibilidade",
      type: "individual",
      category: "quantitativa",
      startDate: new Date(),
      endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      status: "em_andamento",
      progress: 90,
      createdBy: 1,
    });

    testGoalId = Number(goal.insertId);

    // Buscar progresso de metas do colaborador
    const employeeGoals = await db
      .select()
      .from(goals)
      .where(eq(goals.employeeId, testEmployeeId));

    expect(employeeGoals.length).toBeGreaterThan(0);

    const avgProgress = employeeGoals.reduce((sum, g) => sum + g.progress, 0) / employeeGoals.length;
    expect(avgProgress).toBeGreaterThanOrEqual(80);

    // Verificar elegibilidade
    const policy = await db
      .select()
      .from(bonusPolicies)
      .where(eq(bonusPolicies.id, testPolicyId))
      .limit(1);

    const isEligible = policy[0].requiresGoalCompletion 
      ? avgProgress >= (policy[0].minGoalCompletionRate || 0)
      : true;

    expect(isEligible).toBe(true);
  });

  it("deve rejeitar elegibilidade quando progresso de metas estÃ¡ abaixo do mÃ­nimo", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Atualizar meta para progresso baixo (50%, abaixo do mÃ­nimo de 80%)
    if (testGoalId) {
      await db
        .update(goals)
        .set({ progress: 50 })
        .where(eq(goals.id, testGoalId));

      // Buscar progresso atualizado
      const employeeGoals = await db
        .select()
        .from(goals)
        .where(eq(goals.employeeId, testEmployeeId));

      const avgProgress = employeeGoals.reduce((sum, g) => sum + g.progress, 0) / employeeGoals.length;
      expect(avgProgress).toBeLessThan(80);

      // Verificar elegibilidade
      const policy = await db
        .select()
        .from(bonusPolicies)
        .where(eq(bonusPolicies.id, testPolicyId))
        .limit(1);

    const isEligible = policy[0].requiresGoalCompletion 
      ? avgProgress >= (policy[0].minGoalCompletionRate || 0)
      : true;

      expect(isEligible).toBe(false);
    }
  });

  it("deve listar cÃ¡lculos de bÃ´nus por status", async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Criar alguns cÃ¡lculos de teste
    const [calc1] = await db.insert(bonusCalculations).values({
      employeeId: testEmployeeId,
      policyId: testPolicyId,
      baseSalary: "5000",
      appliedMultiplier: "1.5",
      bonusAmount: "7500",
      status: "calculado",
      referenceMonth: new Date().toISOString().slice(0, 7),
    });

    const [calc2] = await db.insert(bonusCalculations).values({
      employeeId: testEmployeeId,
      policyId: testPolicyId,
      baseSalary: "5000",
      appliedMultiplier: "1.5",
      bonusAmount: "7500",
      status: "aprovado",
      referenceMonth: new Date().toISOString().slice(0, 7),
      approvedAt: new Date(),
    });

    // Buscar cÃ¡lculos por status
    const calculatedOnes = await db
      .select()
      .from(bonusCalculations)
      .where(eq(bonusCalculations.status, "calculado"));

    const approvedOnes = await db
      .select()
      .from(bonusCalculations)
      .where(eq(bonusCalculations.status, "aprovado"));

    expect(calculatedOnes.length).toBeGreaterThan(0);
    expect(approvedOnes.length).toBeGreaterThan(0);

    // Limpar
    await db.delete(bonusCalculations).where(eq(bonusCalculations.id, Number(calc1.insertId)));
    await db.delete(bonusCalculations).where(eq(bonusCalculations.id, Number(calc2.insertId)));
  });
});


========================================
ARQUIVO: ./server/_core/activityTracking.ts
========================================
import { getDb } from "../db";
import { activityLogs } from "../../drizzle/schema";

/**
 * Middleware de tracking automÃ¡tico de atividades
 * Registra todas as aÃ§Ãµes importantes dos usuÃ¡rios no sistema
 */

export type ActivityType =
  | "login"
  | "logout"
  | "create_goal"
  | "update_goal"
  | "create_pdi"
  | "update_pdi"
  | "submit_evaluation"
  | "approve_request"
  | "reject_request"
  | "upload_file"
  | "generate_report"
  | "create_job_description"
  | "approve_job_description"
  | "reject_job_description"
  | "register_activity"
  | "view_dashboard"
  | "other";

export async function logActivity(params: {
  userId: number;
  activityType: ActivityType;
  description: string;
  metadata?: Record<string, any>;
}) {
  try {
    const db = await getDb();
    if (!db) {
      console.warn("[ActivityTracking] Database not available");
      return;
    }

    await db.insert(activityLogs).values({
      employeeId: params.userId, // Usando userId como employeeId
      userId: params.userId,
      activityType: params.activityType,
      activityDescription: params.description,
      metadata: params.metadata ? JSON.stringify(params.metadata) : null,
    });

    console.log(`[ActivityTracking] Logged: ${params.activityType} by user ${params.userId}`);
  } catch (error) {
    console.error("[ActivityTracking] Failed to log activity:", error);
  }
}

/**
 * Wrapper para procedures que registra automaticamente a atividade
 */
export function withActivityTracking<T extends (...args: any[]) => any>(
  activityType: ActivityType,
  getDescription: (input: any) => string
) {
  return (handler: T): T => {
    return (async (...args: any[]) => {
      const result = await handler(...args);
      
      // Extrair userId do contexto (args[0] geralmente Ã© { input, ctx })
      const ctx = args[0]?.ctx;
      const input = args[0]?.input;
      
      if (ctx?.user?.id) {
        await logActivity({
          userId: ctx.user.id,
          activityType,
          description: getDescription(input),
          metadata: input,
        });
      }

      return result;
    }) as T;
  };
}

/**
 * Categorizar atividade automÃ¡tica em categoria manual equivalente
 */
export function mapActivityTypeToCategory(activityType: ActivityType): string {
  const mapping: Record<ActivityType, string> = {
    login: "outros",
    logout: "outros",
    create_goal: "planejamento",
    update_goal: "planejamento",
    create_pdi: "planejamento",
    update_pdi: "planejamento",
    submit_evaluation: "analise",
    approve_request: "execucao",
    reject_request: "execucao",
    upload_file: "execucao",
    generate_report: "analise",
    create_job_description: "planejamento",
    approve_job_description: "execucao",
    reject_job_description: "execucao",
    register_activity: "execucao",
    view_dashboard: "analise",
    other: "outros",
  };

  return mapping[activityType] || "outros";
}

/**
 * Calcular tempo estimado de uma atividade automÃ¡tica (em minutos)
 */
export function estimateActivityDuration(activityType: ActivityType): number {
  const durations: Record<ActivityType, number> = {
    login: 1,
    logout: 1,
    create_goal: 15,
    update_goal: 10,
    create_pdi: 30,
    update_pdi: 15,
    submit_evaluation: 20,
    approve_request: 5,
    reject_request: 5,
    upload_file: 5,
    generate_report: 10,
    create_job_description: 45,
    approve_job_description: 10,
    reject_job_description: 10,
    register_activity: 3,
    view_dashboard: 2,
    other: 5,
  };

  return durations[activityType] || 5;
}


========================================
ARQUIVO: ./server/_core/context.ts
========================================
import type { CreateExpressContextOptions } from "@trpc/server/adapters/express";
import type { User } from "../../drizzle/schema";
import { sdk } from "./sdk";

export type TrpcContext = {
  req: CreateExpressContextOptions["req"];
  res: CreateExpressContextOptions["res"];
  user: User | null;
};

export async function createContext(
  opts: CreateExpressContextOptions
): Promise<TrpcContext> {
  let user: User | null = null;

  try {
    user = await sdk.authenticateRequest(opts.req);
  } catch (error) {
    // Authentication is optional for public procedures.
    user = null;
  }

  return {
    req: opts.req,
    res: opts.res,
    user,
  };
}


========================================
ARQUIVO: ./server/_core/cookies.ts
========================================
import type { CookieOptions, Request } from "express";

const LOCAL_HOSTS = new Set(["localhost", "127.0.0.1", "::1"]);

function isIpAddress(host: string) {
  // Basic IPv4 check and IPv6 presence detection.
  if (/^\d{1,3}(\.\d{1,3}){3}$/.test(host)) return true;
  return host.includes(":");
}

function isSecureRequest(req: Request) {
  if (req.protocol === "https") return true;

  const forwardedProto = req.headers["x-forwarded-proto"];
  if (!forwardedProto) return false;

  const protoList = Array.isArray(forwardedProto)
    ? forwardedProto
    : forwardedProto.split(",");

  return protoList.some(proto => proto.trim().toLowerCase() === "https");
}

export function getSessionCookieOptions(
  req: Request
): Pick<CookieOptions, "domain" | "httpOnly" | "path" | "sameSite" | "secure"> {
  // const hostname = req.hostname;
  // const shouldSetDomain =
  //   hostname &&
  //   !LOCAL_HOSTS.has(hostname) &&
  //   !isIpAddress(hostname) &&
  //   hostname !== "127.0.0.1" &&
  //   hostname !== "::1";

  // const domain =
  //   shouldSetDomain && !hostname.startsWith(".")
  //     ? `.${hostname}`
  //     : shouldSetDomain
  //       ? hostname
  //       : undefined;

  return {
    httpOnly: true,
    path: "/",
    sameSite: "none",
    secure: isSecureRequest(req),
  };
}


========================================
ARQUIVO: ./server/_core/dataApi.ts
========================================
/**
 * Quick example (matches curl usage):
 *   await callDataApi("Youtube/search", {
 *     query: { gl: "US", hl: "en", q: "manus" },
 *   })
 */
import { ENV } from "./env";

export type DataApiCallOptions = {
  query?: Record<string, unknown>;
  body?: Record<string, unknown>;
  pathParams?: Record<string, unknown>;
  formData?: Record<string, unknown>;
};

export async function callDataApi(
  apiId: string,
  options: DataApiCallOptions = {}
): Promise<unknown> {
  if (!ENV.forgeApiUrl) {
    throw new Error("BUILT_IN_FORGE_API_URL is not configured");
  }
  if (!ENV.forgeApiKey) {
    throw new Error("BUILT_IN_FORGE_API_KEY is not configured");
  }

  // Build the full URL by appending the service path to the base URL
  const baseUrl = ENV.forgeApiUrl.endsWith("/") ? ENV.forgeApiUrl : `${ENV.forgeApiUrl}/`;
  const fullUrl = new URL("webdevtoken.v1.WebDevService/CallApi", baseUrl).toString();

  const response = await fetch(fullUrl, {
    method: "POST",
    headers: {
      accept: "application/json",
      "content-type": "application/json",
      "connect-protocol-version": "1",
      authorization: `Bearer ${ENV.forgeApiKey}`,
    },
    body: JSON.stringify({
      apiId,
      query: options.query,
      body: options.body,
      path_params: options.pathParams,
      multipart_form_data: options.formData,
    }),
  });

  if (!response.ok) {
    const detail = await response.text().catch(() => "");
    throw new Error(
      `Data API request failed (${response.status} ${response.statusText})${detail ? `: ${detail}` : ""}`
    );
  }

  const payload = await response.json().catch(() => ({}));
  if (payload && typeof payload === "object" && "jsonData" in payload) {
    try {
      return JSON.parse((payload as Record<string, string>).jsonData ?? "{}");
    } catch {
      return (payload as Record<string, unknown>).jsonData;
    }
  }
  return payload;
}


========================================
ARQUIVO: ./server/_core/env.ts
========================================
export const ENV = {
  appId: process.env.VITE_APP_ID ?? "",
  cookieSecret: process.env.JWT_SECRET ?? "",
  databaseUrl: process.env.DATABASE_URL ?? "",
  oAuthServerUrl: process.env.OAUTH_SERVER_URL ?? "",
  ownerOpenId: process.env.OWNER_OPEN_ID ?? "",
  isProduction: process.env.NODE_ENV === "production",
  forgeApiUrl: process.env.BUILT_IN_FORGE_API_URL ?? "",
  forgeApiKey: process.env.BUILT_IN_FORGE_API_KEY ?? "",
};


========================================
ARQUIVO: ./server/_core/imageGeneration.ts
========================================
/**
 * Image generation helper using internal ImageService
 *
 * Example usage:
 *   const { url: imageUrl } = await generateImage({
 *     prompt: "A serene landscape with mountains"
 *   });
 *
 * For editing:
 *   const { url: imageUrl } = await generateImage({
 *     prompt: "Add a rainbow to this landscape",
 *     originalImages: [{
 *       url: "https://example.com/original.jpg",
 *       mimeType: "image/jpeg"
 *     }]
 *   });
 */
import { storagePut } from "server/storage";
import { ENV } from "./env";

export type GenerateImageOptions = {
  prompt: string;
  originalImages?: Array<{
    url?: string;
    b64Json?: string;
    mimeType?: string;
  }>;
};

export type GenerateImageResponse = {
  url?: string;
};

export async function generateImage(
  options: GenerateImageOptions
): Promise<GenerateImageResponse> {
  if (!ENV.forgeApiUrl) {
    throw new Error("BUILT_IN_FORGE_API_URL is not configured");
  }
  if (!ENV.forgeApiKey) {
    throw new Error("BUILT_IN_FORGE_API_KEY is not configured");
  }

  // Build the full URL by appending the service path to the base URL
  const baseUrl = ENV.forgeApiUrl.endsWith("/")
    ? ENV.forgeApiUrl
    : `${ENV.forgeApiUrl}/`;
  const fullUrl = new URL(
    "images.v1.ImageService/GenerateImage",
    baseUrl
  ).toString();

  const response = await fetch(fullUrl, {
    method: "POST",
    headers: {
      accept: "application/json",
      "content-type": "application/json",
      "connect-protocol-version": "1",
      authorization: `Bearer ${ENV.forgeApiKey}`,
    },
    body: JSON.stringify({
      prompt: options.prompt,
      original_images: options.originalImages || [],
    }),
  });

  if (!response.ok) {
    const detail = await response.text().catch(() => "");
    throw new Error(
      `Image generation request failed (${response.status} ${response.statusText})${detail ? `: ${detail}` : ""}`
    );
  }

  const result = (await response.json()) as {
    image: {
      b64Json: string;
      mimeType: string;
    };
  };
  const base64Data = result.image.b64Json;
  const buffer = Buffer.from(base64Data, "base64");

  // Save to S3
  const { url } = await storagePut(
    `generated/${Date.now()}.png`,
    buffer,
    result.image.mimeType
  );
  return {
    url,
  };
}


========================================
ARQUIVO: ./server/_core/index.ts
========================================
import "dotenv/config";
import express from "express";
import { createServer } from "http";
import net from "net";
import { createExpressMiddleware } from "@trpc/server/adapters/express";
import { registerOAuthRoutes } from "./oauth";
import { appRouter } from "../routers";
import { createContext } from "./context";
import { serveStatic, setupVite } from "./vite";
import { setupWebSocket } from "../websocket";
import { startCronJobs } from "../cron";

function isPortAvailable(port: number): Promise<boolean> {
  return new Promise(resolve => {
    const server = net.createServer();
    server.listen(port, () => {
      server.close(() => resolve(true));
    });
    server.on("error", () => resolve(false));
  });
}

async function findAvailablePort(startPort: number = 3000): Promise<number> {
  for (let port = startPort; port < startPort + 20; port++) {
    if (await isPortAvailable(port)) {
      return port;
    }
  }
  throw new Error(`No available port found starting from ${startPort}`);
}

async function startServer() {
  const app = express();
  const server = createServer(app);
  
  // Setup WebSocket
  const io = setupWebSocket(server);
  
  // Make io available in app context
  app.set('io', io);
  // Configure body parser with larger size limit for file uploads
  app.use(express.json({ limit: "50mb" }));
  app.use(express.urlencoded({ limit: "50mb", extended: true }));
  // OAuth callback under /api/oauth/callback
  registerOAuthRoutes(app);
  // tRPC API
  app.use(
    "/api/trpc",
    createExpressMiddleware({
      router: appRouter,
      createContext,
    })
  );
  // development mode uses Vite, production mode uses static files
  if (process.env.NODE_ENV === "development") {
    await setupVite(app, server);
  } else {
    serveStatic(app);
  }

  const preferredPort = parseInt(process.env.PORT || "3000");
  const port = await findAvailablePort(preferredPort);

  if (port !== preferredPort) {
    console.log(`Port ${preferredPort} is busy, using port ${port} instead`);
  }

  server.listen(port, () => {
    console.log(`Server running on http://localhost:${port}/`);
    
    // Iniciar cron jobs
    startCronJobs();
  });
}

startServer().catch(console.error);


========================================
ARQUIVO: ./server/_core/llm.ts
========================================
import { ENV } from "./env";

export type Role = "system" | "user" | "assistant" | "tool" | "function";

export type TextContent = {
  type: "text";
  text: string;
};

export type ImageContent = {
  type: "image_url";
  image_url: {
    url: string;
    detail?: "auto" | "low" | "high";
  };
};

export type FileContent = {
  type: "file_url";
  file_url: {
    url: string;
    mime_type?: "audio/mpeg" | "audio/wav" | "application/pdf" | "audio/mp4" | "video/mp4" ;
  };
};

export type MessageContent = string | TextContent | ImageContent | FileContent;

export type Message = {
  role: Role;
  content: MessageContent | MessageContent[];
  name?: string;
  tool_call_id?: string;
};

export type Tool = {
  type: "function";
  function: {
    name: string;
    description?: string;
    parameters?: Record<string, unknown>;
  };
};

export type ToolChoicePrimitive = "none" | "auto" | "required";
export type ToolChoiceByName = { name: string };
export type ToolChoiceExplicit = {
  type: "function";
  function: {
    name: string;
  };
};

export type ToolChoice =
  | ToolChoicePrimitive
  | ToolChoiceByName
  | ToolChoiceExplicit;

export type InvokeParams = {
  messages: Message[];
  tools?: Tool[];
  toolChoice?: ToolChoice;
  tool_choice?: ToolChoice;
  maxTokens?: number;
  max_tokens?: number;
  outputSchema?: OutputSchema;
  output_schema?: OutputSchema;
  responseFormat?: ResponseFormat;
  response_format?: ResponseFormat;
};

export type ToolCall = {
  id: string;
  type: "function";
  function: {
    name: string;
    arguments: string;
  };
};

export type InvokeResult = {
  id: string;
  created: number;
  model: string;
  choices: Array<{
    index: number;
    message: {
      role: Role;
      content: string | Array<TextContent | ImageContent | FileContent>;
      tool_calls?: ToolCall[];
    };
    finish_reason: string | null;
  }>;
  usage?: {
    prompt_tokens: number;
    completion_tokens: number;
    total_tokens: number;
  };
};

export type JsonSchema = {
  name: string;
  schema: Record<string, unknown>;
  strict?: boolean;
};

export type OutputSchema = JsonSchema;

export type ResponseFormat =
  | { type: "text" }
  | { type: "json_object" }
  | { type: "json_schema"; json_schema: JsonSchema };

const ensureArray = (
  value: MessageContent | MessageContent[]
): MessageContent[] => (Array.isArray(value) ? value : [value]);

const normalizeContentPart = (
  part: MessageContent
): TextContent | ImageContent | FileContent => {
  if (typeof part === "string") {
    return { type: "text", text: part };
  }

  if (part.type === "text") {
    return part;
  }

  if (part.type === "image_url") {
    return part;
  }

  if (part.type === "file_url") {
    return part;
  }

  throw new Error("Unsupported message content part");
};

const normalizeMessage = (message: Message) => {
  const { role, name, tool_call_id } = message;

  if (role === "tool" || role === "function") {
    const content = ensureArray(message.content)
      .map(part => (typeof part === "string" ? part : JSON.stringify(part)))
      .join("\n");

    return {
      role,
      name,
      tool_call_id,
      content,
    };
  }

  const contentParts = ensureArray(message.content).map(normalizeContentPart);

  // If there's only text content, collapse to a single string for compatibility
  if (contentParts.length === 1 && contentParts[0].type === "text") {
    return {
      role,
      name,
      content: contentParts[0].text,
    };
  }

  return {
    role,
    name,
    content: contentParts,
  };
};

const normalizeToolChoice = (
  toolChoice: ToolChoice | undefined,
  tools: Tool[] | undefined
): "none" | "auto" | ToolChoiceExplicit | undefined => {
  if (!toolChoice) return undefined;

  if (toolChoice === "none" || toolChoice === "auto") {
    return toolChoice;
  }

  if (toolChoice === "required") {
    if (!tools || tools.length === 0) {
      throw new Error(
        "tool_choice 'required' was provided but no tools were configured"
      );
    }

    if (tools.length > 1) {
      throw new Error(
        "tool_choice 'required' needs a single tool or specify the tool name explicitly"
      );
    }

    return {
      type: "function",
      function: { name: tools[0].function.name },
    };
  }

  if ("name" in toolChoice) {
    return {
      type: "function",
      function: { name: toolChoice.name },
    };
  }

  return toolChoice;
};

const resolveApiUrl = () =>
  ENV.forgeApiUrl && ENV.forgeApiUrl.trim().length > 0
    ? `${ENV.forgeApiUrl.replace(/\/$/, "")}/v1/chat/completions`
    : "https://forge.manus.im/v1/chat/completions";

const assertApiKey = () => {
  if (!ENV.forgeApiKey) {
    throw new Error("OPENAI_API_KEY is not configured");
  }
};

const normalizeResponseFormat = ({
  responseFormat,
  response_format,
  outputSchema,
  output_schema,
}: {
  responseFormat?: ResponseFormat;
  response_format?: ResponseFormat;
  outputSchema?: OutputSchema;
  output_schema?: OutputSchema;
}):
  | { type: "json_schema"; json_schema: JsonSchema }
  | { type: "text" }
  | { type: "json_object" }
  | undefined => {
  const explicitFormat = responseFormat || response_format;
  if (explicitFormat) {
    if (
      explicitFormat.type === "json_schema" &&
      !explicitFormat.json_schema?.schema
    ) {
      throw new Error(
        "responseFormat json_schema requires a defined schema object"
      );
    }
    return explicitFormat;
  }

  const schema = outputSchema || output_schema;
  if (!schema) return undefined;

  if (!schema.name || !schema.schema) {
    throw new Error("outputSchema requires both name and schema");
  }

  return {
    type: "json_schema",
    json_schema: {
      name: schema.name,
      schema: schema.schema,
      ...(typeof schema.strict === "boolean" ? { strict: schema.strict } : {}),
    },
  };
};

export async function invokeLLM(params: InvokeParams): Promise<InvokeResult> {
  assertApiKey();

  const {
    messages,
    tools,
    toolChoice,
    tool_choice,
    outputSchema,
    output_schema,
    responseFormat,
    response_format,
  } = params;

  const payload: Record<string, unknown> = {
    model: "gemini-2.5-flash",
    messages: messages.map(normalizeMessage),
  };

  if (tools && tools.length > 0) {
    payload.tools = tools;
  }

  const normalizedToolChoice = normalizeToolChoice(
    toolChoice || tool_choice,
    tools
  );
  if (normalizedToolChoice) {
    payload.tool_choice = normalizedToolChoice;
  }

  payload.max_tokens = 32768
  payload.thinking = {
    "budget_tokens": 128
  }

  const normalizedResponseFormat = normalizeResponseFormat({
    responseFormat,
    response_format,
    outputSchema,
    output_schema,
  });

  if (normalizedResponseFormat) {
    payload.response_format = normalizedResponseFormat;
  }

  const response = await fetch(resolveApiUrl(), {
    method: "POST",
    headers: {
      "content-type": "application/json",
      authorization: `Bearer ${ENV.forgeApiKey}`,
    },
    body: JSON.stringify(payload),
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(
      `LLM invoke failed: ${response.status} ${response.statusText} â€“ ${errorText}`
    );
  }

  return (await response.json()) as InvokeResult;
}


========================================
ARQUIVO: ./server/_core/map.ts
========================================
/**
 * Google Maps API Integration for Manus WebDev Templates
 * 
 * Main function: makeRequest<T>(endpoint, params) - Makes authenticated requests to Google Maps APIs
 * All credentials are automatically injected. Array parameters use | as separator.
 * 
 * See API examples below the type definitions for usage patterns.
 */

import { ENV } from "./env";

// ============================================================================
// Configuration
// ============================================================================

type MapsConfig = {
  baseUrl: string;
  apiKey: string;
};

function getMapsConfig(): MapsConfig {
  const baseUrl = ENV.forgeApiUrl;
  const apiKey = ENV.forgeApiKey;

  if (!baseUrl || !apiKey) {
    throw new Error(
      "Google Maps proxy credentials missing: set BUILT_IN_FORGE_API_URL and BUILT_IN_FORGE_API_KEY"
    );
  }

  return {
    baseUrl: baseUrl.replace(/\/+$/, ""),
    apiKey,
  };
}

// ============================================================================
// Core Request Handler
// ============================================================================

interface RequestOptions {
  method?: "GET" | "POST";
  body?: Record<string, unknown>;
}

/**
 * Make authenticated requests to Google Maps APIs
 * 
 * @param endpoint - The API endpoint (e.g., "/maps/api/geocode/json")
 * @param params - Query parameters for the request
 * @param options - Additional request options
 * @returns The API response
 */
export async function makeRequest<T = unknown>(
  endpoint: string,
  params: Record<string, unknown> = {},
  options: RequestOptions = {}
): Promise<T> {
  const { baseUrl, apiKey } = getMapsConfig();

  // Construct full URL: baseUrl + /v1/maps/proxy + endpoint
  const url = new URL(`${baseUrl}/v1/maps/proxy${endpoint}`);

  // Add API key as query parameter (standard Google Maps API authentication)
  url.searchParams.append("key", apiKey);

  // Add other query parameters
  Object.entries(params).forEach(([key, value]) => {
    if (value !== undefined && value !== null) {
      url.searchParams.append(key, String(value));
    }
  });

  const response = await fetch(url.toString(), {
    method: options.method || "GET",
    headers: {
      "Content-Type": "application/json",
    },
    body: options.body ? JSON.stringify(options.body) : undefined,
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(
      `Google Maps API request failed (${response.status} ${response.statusText}): ${errorText}`
    );
  }

  return (await response.json()) as T;
}

// ============================================================================
// Type Definitions
// ============================================================================

export type TravelMode = "driving" | "walking" | "bicycling" | "transit";
export type MapType = "roadmap" | "satellite" | "terrain" | "hybrid";
export type SpeedUnit = "KPH" | "MPH";

export type LatLng = {
  lat: number;
  lng: number;
};

export type DirectionsResult = {
  routes: Array<{
    legs: Array<{
      distance: { text: string; value: number };
      duration: { text: string; value: number };
      start_address: string;
      end_address: string;
      start_location: LatLng;
      end_location: LatLng;
      steps: Array<{
        distance: { text: string; value: number };
        duration: { text: string; value: number };
        html_instructions: string;
        travel_mode: string;
        start_location: LatLng;
        end_location: LatLng;
      }>;
    }>;
    overview_polyline: { points: string };
    summary: string;
    warnings: string[];
    waypoint_order: number[];
  }>;
  status: string;
};

export type DistanceMatrixResult = {
  rows: Array<{
    elements: Array<{
      distance: { text: string; value: number };
      duration: { text: string; value: number };
      status: string;
    }>;
  }>;
  origin_addresses: string[];
  destination_addresses: string[];
  status: string;
};

export type GeocodingResult = {
  results: Array<{
    address_components: Array<{
      long_name: string;
      short_name: string;
      types: string[];
    }>;
    formatted_address: string;
    geometry: {
      location: LatLng;
      location_type: string;
      viewport: {
        northeast: LatLng;
        southwest: LatLng;
      };
    };
    place_id: string;
    types: string[];
  }>;
  status: string;
};

export type PlacesSearchResult = {
  results: Array<{
    place_id: string;
    name: string;
    formatted_address: string;
    geometry: {
      location: LatLng;
    };
    rating?: number;
    user_ratings_total?: number;
    business_status?: string;
    types: string[];
  }>;
  status: string;
};

export type PlaceDetailsResult = {
  result: {
    place_id: string;
    name: string;
    formatted_address: string;
    formatted_phone_number?: string;
    international_phone_number?: string;
    website?: string;
    rating?: number;
    user_ratings_total?: number;
    reviews?: Array<{
      author_name: string;
      rating: number;
      text: string;
      time: number;
    }>;
    opening_hours?: {
      open_now: boolean;
      weekday_text: string[];
    };
    geometry: {
      location: LatLng;
    };
  };
  status: string;
};

export type ElevationResult = {
  results: Array<{
    elevation: number;
    location: LatLng;
    resolution: number;
  }>;
  status: string;
};

export type TimeZoneResult = {
  dstOffset: number;
  rawOffset: number;
  status: string;
  timeZoneId: string;
  timeZoneName: string;
};

export type RoadsResult = {
  snappedPoints: Array<{
    location: LatLng;
    originalIndex?: number;
    placeId: string;
  }>;
};

// ============================================================================
// Google Maps API Reference
// ============================================================================

/**
 * GEOCODING - Convert between addresses and coordinates
 * Endpoint: /maps/api/geocode/json
 * Input: { address: string } OR { latlng: string }  // latlng: "37.42,-122.08"
 * Output: GeocodingResult  // results[0].geometry.location, results[0].formatted_address
 */

/**
 * DIRECTIONS - Get navigation routes between locations
 * Endpoint: /maps/api/directions/json
 * Input: { origin: string, destination: string, mode?: TravelMode, waypoints?: string, alternatives?: boolean }
 * Output: DirectionsResult  // routes[0].legs[0].distance, duration, steps
 */

/**
 * DISTANCE MATRIX - Calculate travel times/distances for multiple origin-destination pairs
 * Endpoint: /maps/api/distancematrix/json
 * Input: { origins: string, destinations: string, mode?: TravelMode, units?: "metric"|"imperial" }  // origins: "NYC|Boston"
 * Output: DistanceMatrixResult  // rows[0].elements[1] = first origin to second destination
 */

/**
 * PLACE SEARCH - Find businesses/POIs by text query
 * Endpoint: /maps/api/place/textsearch/json
 * Input: { query: string, location?: string, radius?: number, type?: string }  // location: "40.7,-74.0"
 * Output: PlacesSearchResult  // results[].name, rating, geometry.location, place_id
 */

/**
 * NEARBY SEARCH - Find places near a specific location
 * Endpoint: /maps/api/place/nearbysearch/json
 * Input: { location: string, radius: number, type?: string, keyword?: string }  // location: "40.7,-74.0"
 * Output: PlacesSearchResult
 */

/**
 * PLACE DETAILS - Get comprehensive information about a specific place
 * Endpoint: /maps/api/place/details/json
 * Input: { place_id: string, fields?: string }  // fields: "name,rating,opening_hours,website"
 * Output: PlaceDetailsResult  // result.name, rating, opening_hours, etc.
 */

/**
 * ELEVATION - Get altitude data for geographic points
 * Endpoint: /maps/api/elevation/json
 * Input: { locations?: string, path?: string, samples?: number }  // locations: "39.73,-104.98|36.45,-116.86"
 * Output: ElevationResult  // results[].elevation (meters)
 */

/**
 * TIME ZONE - Get timezone information for a location
 * Endpoint: /maps/api/timezone/json
 * Input: { location: string, timestamp: number }  // timestamp: Math.floor(Date.now()/1000)
 * Output: TimeZoneResult  // timeZoneId, timeZoneName
 */

/**
 * ROADS - Snap GPS traces to roads, find nearest roads, get speed limits
 * - /v1/snapToRoads: Input: { path: string, interpolate?: boolean }  // path: "lat,lng|lat,lng"
 * - /v1/nearestRoads: Input: { points: string }  // points: "lat,lng|lat,lng"
 * - /v1/speedLimits: Input: { path: string, units?: SpeedUnit }
 * Output: RoadsResult
 */

/**
 * PLACE AUTOCOMPLETE - Real-time place suggestions as user types
 * Endpoint: /maps/api/place/autocomplete/json
 * Input: { input: string, location?: string, radius?: number }
 * Output: { predictions: Array<{ description: string, place_id: string }> }
 */

/**
 * STATIC MAPS - Generate map images as URLs (for emails, reports, <img> tags)
 * Endpoint: /maps/api/staticmap
 * Input: URL params - center: string, zoom: number, size: string, markers?: string, maptype?: MapType
 * Output: Image URL (not JSON) - use directly in <img src={url} />
 * Note: Construct URL manually with getMapsConfig() for auth
 */






========================================
ARQUIVO: ./server/_core/notification.ts
========================================
import { TRPCError } from "@trpc/server";
import { ENV } from "./env";

export type NotificationPayload = {
  title: string;
  content: string;
};

const TITLE_MAX_LENGTH = 1200;
const CONTENT_MAX_LENGTH = 20000;

const trimValue = (value: string): string => value.trim();
const isNonEmptyString = (value: unknown): value is string =>
  typeof value === "string" && value.trim().length > 0;

const buildEndpointUrl = (baseUrl: string): string => {
  const normalizedBase = baseUrl.endsWith("/")
    ? baseUrl
    : `${baseUrl}/`;
  return new URL(
    "webdevtoken.v1.WebDevService/SendNotification",
    normalizedBase
  ).toString();
};

const validatePayload = (input: NotificationPayload): NotificationPayload => {
  if (!isNonEmptyString(input.title)) {
    throw new TRPCError({
      code: "BAD_REQUEST",
      message: "Notification title is required.",
    });
  }
  if (!isNonEmptyString(input.content)) {
    throw new TRPCError({
      code: "BAD_REQUEST",
      message: "Notification content is required.",
    });
  }

  const title = trimValue(input.title);
  const content = trimValue(input.content);

  if (title.length > TITLE_MAX_LENGTH) {
    throw new TRPCError({
      code: "BAD_REQUEST",
      message: `Notification title must be at most ${TITLE_MAX_LENGTH} characters.`,
    });
  }

  if (content.length > CONTENT_MAX_LENGTH) {
    throw new TRPCError({
      code: "BAD_REQUEST",
      message: `Notification content must be at most ${CONTENT_MAX_LENGTH} characters.`,
    });
  }

  return { title, content };
};

/**
 * Dispatches a project-owner notification through the Manus Notification Service.
 * Returns `true` if the request was accepted, `false` when the upstream service
 * cannot be reached (callers can fall back to email/slack). Validation errors
 * bubble up as TRPC errors so callers can fix the payload.
 */
export async function notifyOwner(
  payload: NotificationPayload
): Promise<boolean> {
  const { title, content } = validatePayload(payload);

  if (!ENV.forgeApiUrl) {
    throw new TRPCError({
      code: "INTERNAL_SERVER_ERROR",
      message: "Notification service URL is not configured.",
    });
  }

  if (!ENV.forgeApiKey) {
    throw new TRPCError({
      code: "INTERNAL_SERVER_ERROR",
      message: "Notification service API key is not configured.",
    });
  }

  const endpoint = buildEndpointUrl(ENV.forgeApiUrl);

  try {
    const response = await fetch(endpoint, {
      method: "POST",
      headers: {
        accept: "application/json",
        authorization: `Bearer ${ENV.forgeApiKey}`,
        "content-type": "application/json",
        "connect-protocol-version": "1",
      },
      body: JSON.stringify({ title, content }),
    });

    if (!response.ok) {
      const detail = await response.text().catch(() => "");
      console.warn(
        `[Notification] Failed to notify owner (${response.status} ${response.statusText})${
          detail ? `: ${detail}` : ""
        }`
      );
      return false;
    }

    return true;
  } catch (error) {
    console.warn("[Notification] Error calling notification service:", error);
    return false;
  }
}


========================================
ARQUIVO: ./server/_core/oauth.ts
========================================
import { COOKIE_NAME, ONE_YEAR_MS } from "@shared/const";
import type { Express, Request, Response } from "express";
import * as db from "../db";
import { getSessionCookieOptions } from "./cookies";
import { sdk } from "./sdk";

function getQueryParam(req: Request, key: string): string | undefined {
  const value = req.query[key];
  return typeof value === "string" ? value : undefined;
}

export function registerOAuthRoutes(app: Express) {
  app.get("/api/oauth/callback", async (req: Request, res: Response) => {
    const code = getQueryParam(req, "code");
    const state = getQueryParam(req, "state");

    if (!code || !state) {
      res.status(400).json({ error: "code and state are required" });
      return;
    }

    try {
      const tokenResponse = await sdk.exchangeCodeForToken(code, state);
      const userInfo = await sdk.getUserInfo(tokenResponse.accessToken);

      if (!userInfo.openId) {
        res.status(400).json({ error: "openId missing from user info" });
        return;
      }

      await db.upsertUser({
        openId: userInfo.openId,
        name: userInfo.name || null,
        email: userInfo.email ?? null,
        loginMethod: userInfo.loginMethod ?? userInfo.platform ?? null,
        lastSignedIn: new Date(),
      });

      const sessionToken = await sdk.createSessionToken(userInfo.openId, {
        name: userInfo.name || "",
        expiresInMs: ONE_YEAR_MS,
      });

      const cookieOptions = getSessionCookieOptions(req);
      res.cookie(COOKIE_NAME, sessionToken, { ...cookieOptions, maxAge: ONE_YEAR_MS });

      res.redirect(302, "/");
    } catch (error) {
      console.error("[OAuth] Callback failed", error);
      res.status(500).json({ error: "OAuth callback failed" });
    }
  });
}


========================================
ARQUIVO: ./server/_core/sdk.ts
========================================
import { AXIOS_TIMEOUT_MS, COOKIE_NAME, ONE_YEAR_MS } from "@shared/const";
import { ForbiddenError } from "@shared/_core/errors";
import axios, { type AxiosInstance } from "axios";
import { parse as parseCookieHeader } from "cookie";
import type { Request } from "express";
import { SignJWT, jwtVerify } from "jose";
import type { User } from "../../drizzle/schema";
import * as db from "../db";
import { ENV } from "./env";
import type {
  ExchangeTokenRequest,
  ExchangeTokenResponse,
  GetUserInfoResponse,
  GetUserInfoWithJwtRequest,
  GetUserInfoWithJwtResponse,
} from "./types/manusTypes";
// Utility function
const isNonEmptyString = (value: unknown): value is string =>
  typeof value === "string" && value.length > 0;

export type SessionPayload = {
  openId: string;
  appId: string;
  name: string;
};

const EXCHANGE_TOKEN_PATH = `/webdev.v1.WebDevAuthPublicService/ExchangeToken`;
const GET_USER_INFO_PATH = `/webdev.v1.WebDevAuthPublicService/GetUserInfo`;
const GET_USER_INFO_WITH_JWT_PATH = `/webdev.v1.WebDevAuthPublicService/GetUserInfoWithJwt`;

class OAuthService {
  constructor(private client: ReturnType<typeof axios.create>) {
    console.log("[OAuth] Initialized with baseURL:", ENV.oAuthServerUrl);
    if (!ENV.oAuthServerUrl) {
      console.error(
        "[OAuth] ERROR: OAUTH_SERVER_URL is not configured! Set OAUTH_SERVER_URL environment variable."
      );
    }
  }

  private decodeState(state: string): string {
    const redirectUri = atob(state);
    return redirectUri;
  }

  async getTokenByCode(
    code: string,
    state: string
  ): Promise<ExchangeTokenResponse> {
    const payload: ExchangeTokenRequest = {
      clientId: ENV.appId,
      grantType: "authorization_code",
      code,
      redirectUri: this.decodeState(state),
    };

    const { data } = await this.client.post<ExchangeTokenResponse>(
      EXCHANGE_TOKEN_PATH,
      payload
    );

    return data;
  }

  async getUserInfoByToken(
    token: ExchangeTokenResponse
  ): Promise<GetUserInfoResponse> {
    const { data } = await this.client.post<GetUserInfoResponse>(
      GET_USER_INFO_PATH,
      {
        accessToken: token.accessToken,
      }
    );

    return data;
  }
}

const createOAuthHttpClient = (): AxiosInstance =>
  axios.create({
    baseURL: ENV.oAuthServerUrl,
    timeout: AXIOS_TIMEOUT_MS,
  });

class SDKServer {
  private readonly client: AxiosInstance;
  private readonly oauthService: OAuthService;

  constructor(client: AxiosInstance = createOAuthHttpClient()) {
    this.client = client;
    this.oauthService = new OAuthService(this.client);
  }

  private deriveLoginMethod(
    platforms: unknown,
    fallback: string | null | undefined
  ): string | null {
    if (fallback && fallback.length > 0) return fallback;
    if (!Array.isArray(platforms) || platforms.length === 0) return null;
    const set = new Set<string>(
      platforms.filter((p): p is string => typeof p === "string")
    );
    if (set.has("REGISTERED_PLATFORM_EMAIL")) return "email";
    if (set.has("REGISTERED_PLATFORM_GOOGLE")) return "google";
    if (set.has("REGISTERED_PLATFORM_APPLE")) return "apple";
    if (
      set.has("REGISTERED_PLATFORM_MICROSOFT") ||
      set.has("REGISTERED_PLATFORM_AZURE")
    )
      return "microsoft";
    if (set.has("REGISTERED_PLATFORM_GITHUB")) return "github";
    const first = Array.from(set)[0];
    return first ? first.toLowerCase() : null;
  }

  /**
   * Exchange OAuth authorization code for access token
   * @example
   * const tokenResponse = await sdk.exchangeCodeForToken(code, state);
   */
  async exchangeCodeForToken(
    code: string,
    state: string
  ): Promise<ExchangeTokenResponse> {
    return this.oauthService.getTokenByCode(code, state);
  }

  /**
   * Get user information using access token
   * @example
   * const userInfo = await sdk.getUserInfo(tokenResponse.accessToken);
   */
  async getUserInfo(accessToken: string): Promise<GetUserInfoResponse> {
    const data = await this.oauthService.getUserInfoByToken({
      accessToken,
    } as ExchangeTokenResponse);
    const loginMethod = this.deriveLoginMethod(
      (data as any)?.platforms,
      (data as any)?.platform ?? data.platform ?? null
    );
    return {
      ...(data as any),
      platform: loginMethod,
      loginMethod,
    } as GetUserInfoResponse;
  }

  private parseCookies(cookieHeader: string | undefined) {
    if (!cookieHeader) {
      return new Map<string, string>();
    }

    const parsed = parseCookieHeader(cookieHeader);
    return new Map(Object.entries(parsed));
  }

  private getSessionSecret() {
    const secret = ENV.cookieSecret;
    return new TextEncoder().encode(secret);
  }

  /**
   * Create a session token for a Manus user openId
   * @example
   * const sessionToken = await sdk.createSessionToken(userInfo.openId);
   */
  async createSessionToken(
    openId: string,
    options: { expiresInMs?: number; name?: string } = {}
  ): Promise<string> {
    return this.signSession(
      {
        openId,
        appId: ENV.appId,
        name: options.name || "",
      },
      options
    );
  }

  async signSession(
    payload: SessionPayload,
    options: { expiresInMs?: number } = {}
  ): Promise<string> {
    const issuedAt = Date.now();
    const expiresInMs = options.expiresInMs ?? ONE_YEAR_MS;
    const expirationSeconds = Math.floor((issuedAt + expiresInMs) / 1000);
    const secretKey = this.getSessionSecret();

    return new SignJWT({
      openId: payload.openId,
      appId: payload.appId,
      name: payload.name,
    })
      .setProtectedHeader({ alg: "HS256", typ: "JWT" })
      .setExpirationTime(expirationSeconds)
      .sign(secretKey);
  }

  async verifySession(
    cookieValue: string | undefined | null
  ): Promise<{ openId: string; appId: string; name: string } | null> {
    if (!cookieValue) {
      console.warn("[Auth] Missing session cookie");
      return null;
    }

    try {
      const secretKey = this.getSessionSecret();
      const { payload } = await jwtVerify(cookieValue, secretKey, {
        algorithms: ["HS256"],
      });
      const { openId, appId, name } = payload as Record<string, unknown>;

      if (
        !isNonEmptyString(openId) ||
        !isNonEmptyString(appId) ||
        !isNonEmptyString(name)
      ) {
        console.warn("[Auth] Session payload missing required fields");
        return null;
      }

      return {
        openId,
        appId,
        name,
      };
    } catch (error) {
      console.warn("[Auth] Session verification failed", String(error));
      return null;
    }
  }

  async getUserInfoWithJwt(
    jwtToken: string
  ): Promise<GetUserInfoWithJwtResponse> {
    const payload: GetUserInfoWithJwtRequest = {
      jwtToken,
      projectId: ENV.appId,
    };

    const { data } = await this.client.post<GetUserInfoWithJwtResponse>(
      GET_USER_INFO_WITH_JWT_PATH,
      payload
    );

    const loginMethod = this.deriveLoginMethod(
      (data as any)?.platforms,
      (data as any)?.platform ?? data.platform ?? null
    );
    return {
      ...(data as any),
      platform: loginMethod,
      loginMethod,
    } as GetUserInfoWithJwtResponse;
  }

  async authenticateRequest(req: Request): Promise<User> {
    // Regular authentication flow
    const cookies = this.parseCookies(req.headers.cookie);
    const sessionCookie = cookies.get(COOKIE_NAME);
    const session = await this.verifySession(sessionCookie);

    if (!session) {
      throw ForbiddenError("Invalid session cookie");
    }

    const sessionUserId = session.openId;
    const signedInAt = new Date();
    let user = await db.getUserByOpenId(sessionUserId);

    // If user not in DB, sync from OAuth server automatically
    if (!user) {
      try {
        const userInfo = await this.getUserInfoWithJwt(sessionCookie ?? "");
        await db.upsertUser({
          openId: userInfo.openId,
          name: userInfo.name || null,
          email: userInfo.email ?? null,
          loginMethod: userInfo.loginMethod ?? userInfo.platform ?? null,
          lastSignedIn: signedInAt,
        });
        user = await db.getUserByOpenId(userInfo.openId);
      } catch (error) {
        console.error("[Auth] Failed to sync user from OAuth:", error);
        throw ForbiddenError("Failed to sync user info");
      }
    }

    if (!user) {
      throw ForbiddenError("User not found");
    }

    await db.upsertUser({
      openId: user.openId,
      lastSignedIn: signedInAt,
    });

    return user;
  }
}

export const sdk = new SDKServer();


========================================
ARQUIVO: ./server/_core/systemRouter.ts
========================================
import { z } from "zod";
import { notifyOwner } from "./notification";
import { adminProcedure, publicProcedure, router } from "./trpc";

export const systemRouter = router({
  health: publicProcedure
    .input(
      z.object({
        timestamp: z.number().min(0, "timestamp cannot be negative"),
      })
    )
    .query(() => ({
      ok: true,
    })),

  notifyOwner: adminProcedure
    .input(
      z.object({
        title: z.string().min(1, "title is required"),
        content: z.string().min(1, "content is required"),
      })
    )
    .mutation(async ({ input }) => {
      const delivered = await notifyOwner(input);
      return {
        success: delivered,
      } as const;
    }),
});


========================================
ARQUIVO: ./server/_core/trpc.ts
========================================
import { NOT_ADMIN_ERR_MSG, UNAUTHED_ERR_MSG } from '@shared/const';
import { initTRPC, TRPCError } from "@trpc/server";
import superjson from "superjson";
import type { TrpcContext } from "./context";

const t = initTRPC.context<TrpcContext>().create({
  transformer: superjson,
});

export const router = t.router;
export const publicProcedure = t.procedure;

const requireUser = t.middleware(async opts => {
  const { ctx, next } = opts;

  if (!ctx.user) {
    throw new TRPCError({ code: "UNAUTHORIZED", message: UNAUTHED_ERR_MSG });
  }

  return next({
    ctx: {
      ...ctx,
      user: ctx.user,
    },
  });
});

export const protectedProcedure = t.procedure.use(requireUser);

export const adminProcedure = t.procedure.use(
  t.middleware(async opts => {
    const { ctx, next } = opts;

    if (!ctx.user || ctx.user.role !== 'admin') {
      throw new TRPCError({ code: "FORBIDDEN", message: NOT_ADMIN_ERR_MSG });
    }

    return next({
      ctx: {
        ...ctx,
        user: ctx.user,
      },
    });
  }),
);


========================================
ARQUIVO: ./server/_core/types/cookie.d.ts
========================================
declare module "cookie" {
  export function parse(
    str: string,
    options?: Record<string, unknown>
  ): Record<string, string>;
}


========================================
ARQUIVO: ./server/_core/types/manusTypes.ts
========================================
// WebDev Auth TypeScript types
// Auto-generated from protobuf definitions
// Generated on: 2025-09-24T05:57:57.338Z

export interface AuthorizeRequest {
  redirectUri: string;
  projectId: string;
  state: string;
  responseType: string;
  scope: string;
}

export interface AuthorizeResponse {
  redirectUrl: string;
}

export interface ExchangeTokenRequest {
  grantType: string;
  code: string;
  refreshToken?: string;
  clientId: string;
  clientSecret?: string;
  redirectUri: string;
}

export interface ExchangeTokenResponse {
  accessToken: string;
  tokenType: string;
  expiresIn: number;
  refreshToken?: string;
  scope: string;
  idToken: string;
}

export interface GetUserInfoRequest {
  accessToken: string;
}

export interface GetUserInfoResponse {
  openId: string;
  projectId: string;
  name: string;
  email?: string | null;
  platform?: string | null;
  loginMethod?: string | null;
}

export interface CanAccessRequest {
  openId: string;
  projectId: string;
}

export interface CanAccessResponse {
  canAccess: boolean;
}

export interface GetUserInfoWithJwtRequest {
  jwtToken: string;
  projectId: string;
}

export interface GetUserInfoWithJwtResponse {
  openId: string;
  projectId: string;
  name: string;
  email?: string | null;
  platform?: string | null;
  loginMethod?: string | null;
}


========================================
ARQUIVO: ./server/_core/vite.ts
========================================
import express, { type Express } from "express";
import fs from "fs";
import { type Server } from "http";
import { nanoid } from "nanoid";
import path from "path";
import { createServer as createViteServer } from "vite";
import viteConfig from "../../vite.config";

export async function setupVite(app: Express, server: Server) {
  const serverOptions = {
    middlewareMode: true,
    hmr: { server },
    allowedHosts: true as const,
  };

  const vite = await createViteServer({
    ...viteConfig,
    configFile: false,
    server: serverOptions,
    appType: "custom",
  });

  app.use(vite.middlewares);
  app.use("*", async (req, res, next) => {
    const url = req.originalUrl;

    try {
      const clientTemplate = path.resolve(
        import.meta.dirname,
        "../..",
        "client",
        "index.html"
      );

      // always reload the index.html file from disk incase it changes
      let template = await fs.promises.readFile(clientTemplate, "utf-8");
      template = template.replace(
        `src="/src/main.tsx"`,
        `src="/src/main.tsx?v=${nanoid()}"`
      );
      const page = await vite.transformIndexHtml(url, template);
      res.status(200).set({ "Content-Type": "text/html" }).end(page);
    } catch (e) {
      vite.ssrFixStacktrace(e as Error);
      next(e);
    }
  });
}

export function serveStatic(app: Express) {
  const distPath =
    process.env.NODE_ENV === "development"
      ? path.resolve(import.meta.dirname, "../..", "dist", "public")
      : path.resolve(import.meta.dirname, "public");
  if (!fs.existsSync(distPath)) {
    console.error(
      `Could not find the build directory: ${distPath}, make sure to build the client first`
    );
  }

  app.use(express.static(distPath));

  // fall through to index.html if the file doesn't exist
  app.use("*", (_req, res) => {
    res.sendFile(path.resolve(distPath, "index.html"));
  });
}


========================================
ARQUIVO: ./server/_core/voiceTranscription.ts
========================================
/**
 * Voice transcription helper using internal Speech-to-Text service
 *
 * Frontend implementation guide:
 * 1. Capture audio using MediaRecorder API
 * 2. Upload audio to storage (e.g., S3) to get URL
 * 3. Call transcription with the URL
 * 
 * Example usage:
 * ```tsx
 * // Frontend component
 * const transcribeMutation = trpc.voice.transcribe.useMutation({
 *   onSuccess: (data) => {
 *     console.log(data.text); // Full transcription
 *     console.log(data.language); // Detected language
 *     console.log(data.segments); // Timestamped segments
 *   }
 * });
 * 
 * // After uploading audio to storage
 * transcribeMutation.mutate({
 *   audioUrl: uploadedAudioUrl,
 *   language: 'en', // optional
 *   prompt: 'Transcribe the meeting' // optional
 * });
 * ```
 */
import { ENV } from "./env";

export type TranscribeOptions = {
  audioUrl: string; // URL to the audio file (e.g., S3 URL)
  language?: string; // Optional: specify language code (e.g., "en", "es", "zh")
  prompt?: string; // Optional: custom prompt for the transcription
};

// Native Whisper API segment format
export type WhisperSegment = {
  id: number;
  seek: number;
  start: number;
  end: number;
  text: string;
  tokens: number[];
  temperature: number;
  avg_logprob: number;
  compression_ratio: number;
  no_speech_prob: number;
};

// Native Whisper API response format
export type WhisperResponse = {
  task: "transcribe";
  language: string;
  duration: number;
  text: string;
  segments: WhisperSegment[];
};

export type TranscriptionResponse = WhisperResponse; // Return native Whisper API response directly

export type TranscriptionError = {
  error: string;
  code: "FILE_TOO_LARGE" | "INVALID_FORMAT" | "TRANSCRIPTION_FAILED" | "UPLOAD_FAILED" | "SERVICE_ERROR";
  details?: string;
};

/**
 * Transcribe audio to text using the internal Speech-to-Text service
 * 
 * @param options - Audio data and metadata
 * @returns Transcription result or error
 */
export async function transcribeAudio(
  options: TranscribeOptions
): Promise<TranscriptionResponse | TranscriptionError> {
  try {
    // Step 1: Validate environment configuration
    if (!ENV.forgeApiUrl) {
      return {
        error: "Voice transcription service is not configured",
        code: "SERVICE_ERROR",
        details: "BUILT_IN_FORGE_API_URL is not set"
      };
    }
    if (!ENV.forgeApiKey) {
      return {
        error: "Voice transcription service authentication is missing",
        code: "SERVICE_ERROR",
        details: "BUILT_IN_FORGE_API_KEY is not set"
      };
    }

    // Step 2: Download audio from URL
    let audioBuffer: Buffer;
    let mimeType: string;
    try {
      const response = await fetch(options.audioUrl);
      if (!response.ok) {
        return {
          error: "Failed to download audio file",
          code: "INVALID_FORMAT",
          details: `HTTP ${response.status}: ${response.statusText}`
        };
      }
      
      audioBuffer = Buffer.from(await response.arrayBuffer());
      mimeType = response.headers.get('content-type') || 'audio/mpeg';
      
      // Check file size (16MB limit)
      const sizeMB = audioBuffer.length / (1024 * 1024);
      if (sizeMB > 16) {
        return {
          error: "Audio file exceeds maximum size limit",
          code: "FILE_TOO_LARGE",
          details: `File size is ${sizeMB.toFixed(2)}MB, maximum allowed is 16MB`
        };
      }
    } catch (error) {
      return {
        error: "Failed to fetch audio file",
        code: "SERVICE_ERROR",
        details: error instanceof Error ? error.message : "Unknown error"
      };
    }

    // Step 3: Create FormData for multipart upload to Whisper API
    const formData = new FormData();
    
    // Create a Blob from the buffer and append to form
    const filename = `audio.${getFileExtension(mimeType)}`;
    const audioBlob = new Blob([new Uint8Array(audioBuffer)], { type: mimeType });
    formData.append("file", audioBlob, filename);
    
    formData.append("model", "whisper-1");
    formData.append("response_format", "verbose_json");
    
    // Add prompt - use custom prompt if provided, otherwise generate based on language
    const prompt = options.prompt || (
      options.language 
        ? `Transcribe the user's voice to text, the user's working language is ${getLanguageName(options.language)}`
        : "Transcribe the user's voice to text"
    );
    formData.append("prompt", prompt);

    // Step 4: Call the transcription service
    const baseUrl = ENV.forgeApiUrl.endsWith("/")
      ? ENV.forgeApiUrl
      : `${ENV.forgeApiUrl}/`;
    
    const fullUrl = new URL(
      "v1/audio/transcriptions",
      baseUrl
    ).toString();

    const response = await fetch(fullUrl, {
      method: "POST",
      headers: {
        authorization: `Bearer ${ENV.forgeApiKey}`,
        "Accept-Encoding": "identity",
      },
      body: formData,
    });

    if (!response.ok) {
      const errorText = await response.text().catch(() => "");
      return {
        error: "Transcription service request failed",
        code: "TRANSCRIPTION_FAILED",
        details: `${response.status} ${response.statusText}${errorText ? `: ${errorText}` : ""}`
      };
    }

    // Step 5: Parse and return the transcription result
    const whisperResponse = await response.json() as WhisperResponse;
    
    // Validate response structure
    if (!whisperResponse.text || typeof whisperResponse.text !== 'string') {
      return {
        error: "Invalid transcription response",
        code: "SERVICE_ERROR",
        details: "Transcription service returned an invalid response format"
      };
    }

    return whisperResponse; // Return native Whisper API response directly

  } catch (error) {
    // Handle unexpected errors
    return {
      error: "Voice transcription failed",
      code: "SERVICE_ERROR",
      details: error instanceof Error ? error.message : "An unexpected error occurred"
    };
  }
}

/**
 * Helper function to get file extension from MIME type
 */
function getFileExtension(mimeType: string): string {
  const mimeToExt: Record<string, string> = {
    'audio/webm': 'webm',
    'audio/mp3': 'mp3',
    'audio/mpeg': 'mp3',
    'audio/wav': 'wav',
    'audio/wave': 'wav',
    'audio/ogg': 'ogg',
    'audio/m4a': 'm4a',
    'audio/mp4': 'm4a',
  };
  
  return mimeToExt[mimeType] || 'audio';
}

/**
 * Helper function to get full language name from ISO code
 */
function getLanguageName(langCode: string): string {
  const langMap: Record<string, string> = {
    'en': 'English',
    'es': 'Spanish',
    'fr': 'French',
    'de': 'German',
    'it': 'Italian',
    'pt': 'Portuguese',
    'ru': 'Russian',
    'ja': 'Japanese',
    'ko': 'Korean',
    'zh': 'Chinese',
    'ar': 'Arabic',
    'hi': 'Hindi',
    'nl': 'Dutch',
    'pl': 'Polish',
    'tr': 'Turkish',
    'sv': 'Swedish',
    'da': 'Danish',
    'no': 'Norwegian',
    'fi': 'Finnish',
  };
  
  return langMap[langCode] || langCode;
}

/**
 * Example tRPC procedure implementation:
 * 
 * ```ts
 * // In server/routers.ts
 * import { transcribeAudio } from "./_core/voiceTranscription";
 * 
 * export const voiceRouter = router({
 *   transcribe: protectedProcedure
 *     .input(z.object({
 *       audioUrl: z.string(),
 *       language: z.string().optional(),
 *       prompt: z.string().optional(),
 *     }))
 *     .mutation(async ({ input, ctx }) => {
 *       const result = await transcribeAudio(input);
 *       
 *       // Check if it's an error
 *       if ('error' in result) {
 *         throw new TRPCError({
 *           code: 'BAD_REQUEST',
 *           message: result.error,
 *           cause: result,
 *         });
 *       }
 *       
 *       // Optionally save transcription to database
 *       await db.insert(transcriptions).values({
 *         userId: ctx.user.id,
 *         text: result.text,
 *         duration: result.duration,
 *         language: result.language,
 *         audioUrl: input.audioUrl,
 *         createdAt: new Date(),
 *       });
 *       
 *       return result;
 *     }),
 * });
 * ```
 */


========================================
ARQUIVO: ./server/analyticsRouter.ts
========================================
import { desc, eq, count, and } from "drizzle-orm";
import { z } from "zod";
import { getDb } from "./db";
import { 
  performanceEvaluations, 
  nineBoxPositions, 
  goals, 
  pdiPlans, 
  employees 
} from "../drizzle/schema";
import { protectedProcedure, router } from "./_core/trpc";

export const analyticsRouter = router({
  // Buscar dados de tendÃªncias de performance
  getPerformanceTrends: protectedProcedure.query(async ({ ctx }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const database = await getDb();
    if (!database) return [];

    // Buscar avaliaÃ§Ãµes agrupadas por mÃªs
    const evaluations = await database.select()
      .from(performanceEvaluations)
      .orderBy(desc(performanceEvaluations.createdAt));

    // Agrupar por mÃªs e calcular mÃ©dias
    const monthlyData = new Map<string, { total: number; count: number }>();
    
    evaluations.forEach(evaluation => {
      const month = new Date(evaluation.createdAt).toISOString().slice(0, 7); // YYYY-MM
      if (!monthlyData.has(month)) {
        monthlyData.set(month, { total: 0, count: 0 });
      }
      const data = monthlyData.get(month)!;
      data.total += evaluation.finalScore || 0;
      data.count += 1;
    });

    return Array.from(monthlyData.entries()).map(([month, data]) => ({
      month,
      average: data.count > 0 ? data.total / data.count : 0,
      count: data.count,
    })).sort((a, b) => a.month.localeCompare(b.month)).slice(-12); // Ãšltimos 12 meses
  }),

  // Buscar distribuiÃ§Ã£o Nine Box
  getNineBoxDistribution: protectedProcedure.query(async ({ ctx }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const database = await getDb();
    if (!database) return [];

    const positions = await database.select()
      .from(nineBoxPositions);

    // Contar por quadrante
    const distribution: Record<string, number> = {};
    positions.forEach(pos => {
      const key = `${pos.performance}-${pos.potential}`;
      distribution[key] = (distribution[key] || 0) + 1;
    });

    return Object.entries(distribution).map(([key, count]) => {
      const [performance, potential] = key.split('-');
      return { performance, potential, count };
    });
  }),

  // Buscar taxas de conclusÃ£o
  getCompletionRates: protectedProcedure.query(async ({ ctx }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const database = await getDb();
    if (!database) return { goals: 0, pdis: 0 };

    // Metas
    const allGoals = await database.select().from(goals);
    const completedGoals = allGoals.filter(g => g.status === "concluida").length;
    const goalsRate = allGoals.length > 0 ? (completedGoals / allGoals.length) * 100 : 0;

    // PDIs
    const allPDIs = await database.select().from(pdiPlans);
    const completedPDIs = allPDIs.filter(p => p.status === "concluido").length;
    const pdisRate = allPDIs.length > 0 ? (completedPDIs / allPDIs.length) * 100 : 0;

    return {
      goals: Math.round(goalsRate),
      pdis: Math.round(pdisRate),
      totalGoals: allGoals.length,
      completedGoals,
      totalPDIs: allPDIs.length,
      completedPDIs,
    };
  }),

  // Buscar KPIs principais
  getKPIs: protectedProcedure
    .input(z.object({ costCenter: z.string().optional() }).optional())
    .query(async ({ ctx, input }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const database = await getDb();
    if (!database) return {};

    const costCenter = input?.costCenter;
    const filterCondition = costCenter && costCenter !== "all" 
      ? eq(employees.costCenter, costCenter)
      : undefined;

    // MÃ©dia geral de performance
    const evaluations = await database.select().from(performanceEvaluations);
    const avgPerformance = evaluations.length > 0
      ? evaluations.reduce((sum, e) => sum + (e.finalScore || 0), 0) / evaluations.length
      : 0;

    // Total de colaboradores (filtrado por centro de custos se fornecido)
    const employeesQuery = database.select().from(employees);
    const allEmployees = filterCondition 
      ? await employeesQuery.where(filterCondition)
      : await employeesQuery;
    const totalEmployees = allEmployees.length;

    // Colaboradores com PDI ativo
    const activePDIs = await database.select()
      .from(pdiPlans)
      .where(eq(pdiPlans.status, "em_andamento"));

    return {
      avgPerformance: Math.round(avgPerformance * 10) / 10,
      totalEmployees,
      employeesWithPDI: activePDIs.length,
      totalEvaluations: evaluations.length,
    };
  }),

  // Headcount por departamento
  getHeadcountByDepartment: protectedProcedure
    .input(z.object({ costCenter: z.string().optional() }).optional())
    .query(async ({ ctx, input }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const database = await getDb();
    if (!database) return [];

    const costCenter = input?.costCenter;
    const filterCondition = costCenter && costCenter !== "all" 
      ? eq(employees.costCenter, costCenter)
      : undefined;

    const query = database
      .select({
        departmentId: employees.departmentId,
        count: count(),
      })
      .from(employees);
    
    const result = filterCondition
      ? await query.where(filterCondition).groupBy(employees.departmentId)
      : await query.groupBy(employees.departmentId);

    return result.map((r) => ({
      department: `Departamento ${r.departmentId}`,
      count: Number(r.count),
    }));
  }),

  // Headcount por cargo
  getHeadcountByPosition: protectedProcedure
    .input(z.object({ costCenter: z.string().optional() }).optional())
    .query(async ({ ctx, input }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const database = await getDb();
    if (!database) return [];

    const costCenter = input?.costCenter;
    const filterCondition = costCenter && costCenter !== "all" 
      ? eq(employees.costCenter, costCenter)
      : undefined;

    const query = database
      .select({
        positionId: employees.positionId,
        count: count(),
      })
      .from(employees);
    
    const result = filterCondition
      ? await query.where(filterCondition).groupBy(employees.positionId).limit(15)
      : await query.groupBy(employees.positionId).limit(15);

    return result.map((r) => ({
      position: `Cargo ${r.positionId}`,
      count: Number(r.count),
    }));
  }),

  // Taxa de turnover mensal (simulado)
  getTurnoverRate: protectedProcedure.query(async ({ ctx }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const months = [
      "Jan",
      "Fev",
      "Mar",
      "Abr",
      "Mai",
      "Jun",
      "Jul",
      "Ago",
      "Set",
      "Out",
      "Nov",
      "Dez",
    ];

    return months.map((month, index) => ({
      month,
      rate: Math.random() * 5 + 1,
    }));
  }),

  // Tempo mÃ©dio de permanÃªncia por departamento (simulado)
  getAverageTenure: protectedProcedure.query(async ({ ctx }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const database = await getDb();
    if (!database) return [];

    const result = await database
      .select({
        departmentId: employees.departmentId,
      })
      .from(employees)
      .groupBy(employees.departmentId);

    return result.map((r) => ({
      department: `Departamento ${r.departmentId}`,
      tenure: Math.random() * 5 + 2,
    }));
  }),

  // AnÃ¡lise de diversidade
  getDiversityAnalysis: protectedProcedure.query(async ({ ctx }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const database = await getDb();
    if (!database) return { gender: [], ageRange: [] };

    // Simulado - campo gender nÃ£o existe no schema atual
    const genderResult = [
      { gender: "Masculino", count: 1500 },
      { gender: "Feminino", count: 1300 },
      { gender: "Outro", count: 89 },
    ];

    return {
      gender: genderResult.map((r) => ({
        gender: r.gender || "NÃ£o Definido",
        count: Number(r.count),
      })),
      ageRange: [
        { range: "18-25", count: 234 },
        { range: "26-35", count: 987 },
        { range: "36-45", count: 1123 },
        { range: "46-55", count: 456 },
        { range: "56+", count: 89 },
      ],
    };
  }),

  // ProjeÃ§Ã£o de crescimento
  getGrowthProjection: protectedProcedure.query(async ({ ctx }) => {
    if (ctx.user.role !== "admin") {
      throw new Error("Acesso negado");
    }

    const months = [
      "Jan",
      "Fev",
      "Mar",
      "Abr",
      "Mai",
      "Jun",
      "Jul",
      "Ago",
      "Set",
      "Out",
      "Nov",
      "Dez",
    ];

    return months.map((month, index) => ({
      month,
      actual: index < 6 ? 2800 + index * 15 : null,
      projected: index >= 6 ? 2890 + (index - 6) * 20 : null,
    }));
  }),
});


========================================
ARQUIVO: ./server/badgesRouter.ts
========================================
import { router, protectedProcedure } from "./_core/trpc";
import { getDb } from "./db";
import { badges, employeeBadges, employees } from "../drizzle/schema";
import { eq, desc, sql } from "drizzle-orm";
import { z } from "zod";

export const badgesRouter = router({
  // Buscar todos os badges disponÃ­veis
  getBadges: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const allBadges = await db
      .select()
      .from(badges)
      .where(eq(badges.isActive, true))
      .orderBy(badges.category, badges.points);

    return allBadges;
  }),

  // Buscar badges conquistados por um colaborador
  getEmployeeBadges: protectedProcedure
    .input(z.object({ employeeId: z.number().optional() }))
    .query(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Se nÃ£o passar employeeId, busca do prÃ³prio usuÃ¡rio
      let targetEmployeeId = input.employeeId;
      if (!targetEmployeeId) {
        const employee = await db
          .select()
          .from(employees)
          .where(eq(employees.userId, ctx.user.id))
          .limit(1);
        if (!employee[0]) throw new Error("Employee not found");
        targetEmployeeId = employee[0].id;
      }

      const earnedBadges = await db
        .select({
          id: employeeBadges.id,
          badgeId: employeeBadges.badgeId,
          earnedAt: employeeBadges.earnedAt,
          notified: employeeBadges.notified,
          badge: badges,
        })
        .from(employeeBadges)
        .innerJoin(badges, eq(employeeBadges.badgeId, badges.id))
        .where(eq(employeeBadges.employeeId, targetEmployeeId))
        .orderBy(desc(employeeBadges.earnedAt));

      // Calcular total de pontos
      const totalPoints = earnedBadges.reduce((sum, item) => sum + (item.badge.points || 0), 0);

      return {
        badges: earnedBadges,
        totalPoints,
        badgeCount: earnedBadges.length,
      };
    }),

  // Ranking de colaboradores por pontos
  getRanking: protectedProcedure
    .input(z.object({ limit: z.number().default(10) }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const ranking = await db
        .select({
          employeeId: employeeBadges.employeeId,
          employee: employees,
          totalPoints: sql<number>`SUM(${badges.points})`,
          badgeCount: sql<number>`COUNT(${employeeBadges.id})`,
        })
        .from(employeeBadges)
        .innerJoin(badges, eq(employeeBadges.badgeId, badges.id))
        .innerJoin(employees, eq(employeeBadges.employeeId, employees.id))
        .groupBy(employeeBadges.employeeId, employees.id)
        .orderBy(desc(sql`SUM(${badges.points})`))
        .limit(input.limit);

      return ranking;
    }),

  // Marcar badge como notificado
  markAsNotified: protectedProcedure
    .input(z.object({ employeeBadgeId: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db
        .update(employeeBadges)
        .set({ notified: true })
        .where(eq(employeeBadges.id, input.employeeBadgeId));

      return { success: true };
    }),

  // EstatÃ­sticas gerais de badges
  getStats: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const totalBadges = await db.select({ count: sql<number>`COUNT(*)` }).from(badges);
    const totalEarned = await db.select({ count: sql<number>`COUNT(*)` }).from(employeeBadges);
    const totalPoints = await db
      .select({ total: sql<number>`SUM(${badges.points})` })
      .from(employeeBadges)
      .innerJoin(badges, eq(employeeBadges.badgeId, badges.id));

    return {
      totalBadgesAvailable: totalBadges[0]?.count || 0,
      totalBadgesEarned: totalEarned[0]?.count || 0,
      totalPointsDistributed: totalPoints[0]?.total || 0,
    };
  }),
});


========================================
ARQUIVO: ./server/bonusRouter.ts
========================================
import { z } from "zod";
import { and, eq, desc, sql } from "drizzle-orm";
import { protectedProcedure, router } from "./_core/trpc";
import { getDb } from "./db";
import {
  bonusConfigs,
  bonusWorkflows,
  bonusApprovals,
  goalEvidences,
  smartGoals,
  employees,
  positions,
  evaluationCycles,
} from "../drizzle/schema";

/**
 * Router de GestÃ£o de BÃ´nus
 * Gerencia configuraÃ§Ãµes de bÃ´nus por funÃ§Ã£o, workflows de aprovaÃ§Ã£o e evidÃªncias
 */
export const bonusRouter = router({
  // ==================== CONFIGURAÃ‡Ã•ES DE BÃ”NUS POR FUNÃ‡ÃƒO ====================

  /**
   * Listar configuraÃ§Ãµes de bÃ´nus
   */
  listConfigs: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const configs = await db
      .select({
        id: bonusConfigs.id,
        positionId: bonusConfigs.positionId,
        positionName: bonusConfigs.positionName,
        baseSalaryMultiplier: bonusConfigs.baseSalaryMultiplier,
        extraBonusPercentage: bonusConfigs.extraBonusPercentage,
        isActive: bonusConfigs.isActive,
        createdAt: bonusConfigs.createdAt,
        updatedAt: bonusConfigs.updatedAt,
      })
      .from(bonusConfigs)
      .orderBy(desc(bonusConfigs.createdAt));

    return configs;
  }),

  /**
   * Criar configuraÃ§Ã£o de bÃ´nus para funÃ§Ã£o
   */
  createConfig: protectedProcedure
    .input(
      z.object({
        positionId: z.number(),
        positionName: z.string(),
        baseSalaryMultiplier: z.number().min(0).max(10), // Ex: 1.5 = 1.5 salÃ¡rios
        extraBonusPercentage: z.number().min(0).max(100), // % adicional
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const result = await db.insert(bonusConfigs).values({
        positionId: input.positionId,
        positionName: input.positionName,
        baseSalaryMultiplier: input.baseSalaryMultiplier.toString(),
        extraBonusPercentage: input.extraBonusPercentage.toString(),
        createdBy: ctx.user.id,
      });

      return { id: Number((result as any).insertId), success: true };
    }),

  /**
   * Atualizar configuraÃ§Ã£o de bÃ´nus
   */
  updateConfig: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        baseSalaryMultiplier: z.number().min(0).max(10),
        extraBonusPercentage: z.number().min(0).max(100),
        isActive: z.boolean().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db
        .update(bonusConfigs)
        .set({
          baseSalaryMultiplier: input.baseSalaryMultiplier.toString(),
          extraBonusPercentage: input.extraBonusPercentage.toString(),
          ...(input.isActive !== undefined && { isActive: input.isActive }),
        })
        .where(eq(bonusConfigs.id, input.id));

      return { success: true };
    }),

  /**
   * Deletar configuraÃ§Ã£o de bÃ´nus
   */
  deleteConfig: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db.delete(bonusConfigs).where(eq(bonusConfigs.id, input.id));

      return { success: true };
    }),

  // ==================== WORKFLOWS DE APROVAÃ‡ÃƒO ====================

  /**
   * Listar workflows de aprovaÃ§Ã£o
   */
  listWorkflows: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const workflows = await db
      .select()
      .from(bonusWorkflows)
      .orderBy(desc(bonusWorkflows.createdAt));

    return workflows;
  }),

  /**
   * Criar workflow de aprovaÃ§Ã£o
   */
  createWorkflow: protectedProcedure
    .input(
      z.object({
        name: z.string(),
        description: z.string().optional(),
        approvers: z.array(
          z.object({
            employeeId: z.number(),
            role: z.string(),
          })
        ).min(1).max(5),
        requireAllApprovals: z.boolean().default(true),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const workflowData: any = {
        name: input.name,
        description: input.description || null,
        requireAllApprovals: input.requireAllApprovals,
        createdBy: ctx.user.id,
      };

      // Adicionar aprovadores (atÃ© 5)
      input.approvers.forEach((approver, index) => {
        const level = index + 1;
        workflowData[`approver${level}Id`] = approver.employeeId;
        workflowData[`approver${level}Role`] = approver.role;
      });

      const result = await db.insert(bonusWorkflows).values(workflowData);

      return { id: Number((result as any).insertId), success: true };
    }),

  /**
   * Atualizar workflow
   */
  updateWorkflow: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        name: z.string().optional(),
        description: z.string().optional(),
        approvers: z.array(
          z.object({
            employeeId: z.number(),
            role: z.string(),
          })
        ).min(1).max(5).optional(),
        requireAllApprovals: z.boolean().optional(),
        isActive: z.boolean().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const updateData: any = {};

      if (input.name) updateData.name = input.name;
      if (input.description !== undefined) updateData.description = input.description;
      if (input.requireAllApprovals !== undefined) updateData.requireAllApprovals = input.requireAllApprovals;
      if (input.isActive !== undefined) updateData.isActive = input.isActive;

      // Atualizar aprovadores se fornecidos
      if (input.approvers) {
        // Limpar aprovadores existentes
        for (let i = 1; i <= 5; i++) {
          updateData[`approver${i}Id`] = null;
          updateData[`approver${i}Role`] = null;
        }

        // Adicionar novos aprovadores
        input.approvers.forEach((approver, index) => {
          const level = index + 1;
          updateData[`approver${level}Id`] = approver.employeeId;
          updateData[`approver${level}Role`] = approver.role;
        });
      }

      await db
        .update(bonusWorkflows)
        .set(updateData)
        .where(eq(bonusWorkflows.id, input.id));

      return { success: true };
    }),

  /**
   * Deletar workflow
   */
  deleteWorkflow: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db.delete(bonusWorkflows).where(eq(bonusWorkflows.id, input.id));

      return { success: true };
    }),

  // ==================== APROVAÃ‡Ã•ES DE BÃ”NUS ====================

  /**
   * Calcular bÃ´nus elegÃ­vel para colaborador em um ciclo
   */
  calculateEligibleBonus: protectedProcedure
    .input(
      z.object({
        employeeId: z.number(),
        cycleId: z.number(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar colaborador e salÃ¡rio
      const employee = await db
        .select({
          id: employees.id,
          name: employees.name,
          positionId: employees.positionId,
        })
        .from(employees)
        .where(eq(employees.id, input.employeeId))
        .limit(1);

      if (employee.length === 0) {
        throw new Error("Colaborador nÃ£o encontrado");
      }

      const emp = employee[0];
      // Nota: salÃ¡rio base deve ser configurado na tabela bonusConfigs por funÃ§Ã£o
      const baseSalary = 0; // SerÃ¡ calculado pela configuraÃ§Ã£o da funÃ§Ã£o

      // Buscar configuraÃ§Ã£o de bÃ´nus da funÃ§Ã£o
      let bonusConfig = null;
      if (emp.positionId) {
        const configs = await db
          .select()
          .from(bonusConfigs)
          .where(
            and(
              eq(bonusConfigs.positionId, emp.positionId),
              eq(bonusConfigs.isActive, true)
            )
          )
          .limit(1);

        if (configs.length > 0) {
          bonusConfig = configs[0];
        }
      }

      // Buscar metas concluÃ­das e elegÃ­veis para bÃ´nus
      const goals = await db
        .select()
        .from(smartGoals)
        .where(
          and(
            eq(smartGoals.employeeId, input.employeeId),
            eq(smartGoals.cycleId, input.cycleId),
            eq(smartGoals.bonusEligible, true),
            eq(smartGoals.status, "completed")
          )
        );

      // Calcular bÃ´nus baseado em metas
      let bonusFromGoals = 0;
      for (const goal of goals) {
        const bonusAmount = goal.bonusAmount ? parseFloat(goal.bonusAmount) : 0;
        bonusFromGoals += bonusAmount;
      }

      // Calcular bÃ´nus baseado em configuraÃ§Ã£o da funÃ§Ã£o
      let bonusFromPosition = 0;
      if (bonusConfig && baseSalary > 0) {
        const multiplier = parseFloat(bonusConfig.baseSalaryMultiplier);
        const extraPercentage = parseFloat(bonusConfig.extraBonusPercentage);

        bonusFromPosition = baseSalary * multiplier;
        bonusFromPosition += bonusFromPosition * (extraPercentage / 100);
      }

      const totalEligible = bonusFromGoals + bonusFromPosition;

      return {
        employeeId: emp.id,
        employeeName: emp.name,
        baseSalary,
        bonusFromGoals,
        bonusFromPosition,
        totalEligible,
        goalsCount: goals.length,
        bonusConfig: bonusConfig
          ? {
              baseSalaryMultiplier: parseFloat(bonusConfig.baseSalaryMultiplier),
              extraBonusPercentage: parseFloat(bonusConfig.extraBonusPercentage),
            }
          : null,
      };
    }),

  /**
   * Iniciar processo de aprovaÃ§Ã£o de bÃ´nus
   */
  initiateApproval: protectedProcedure
    .input(
      z.object({
        employeeId: z.number(),
        cycleId: z.number(),
        workflowId: z.number(),
        eligibleAmount: z.number(),
        extraBonusPercentage: z.number().min(0).max(100).default(0),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Calcular valor final
      const extraAmount = input.eligibleAmount * (input.extraBonusPercentage / 100);
      const finalAmount = input.eligibleAmount + extraAmount;

      const result = await db.insert(bonusApprovals).values({
        cycleId: input.cycleId,
        employeeId: input.employeeId,
        workflowId: input.workflowId,
        eligibleAmount: input.eligibleAmount.toString(),
        extraBonusPercentage: input.extraBonusPercentage.toString(),
        finalAmount: finalAmount.toString(),
        currentLevel: 1,
        status: "pending",
      });

      return { id: Number((result as any).insertId), success: true };
    }),

  /**
   * Aprovar/Rejeitar bÃ´nus em um nÃ­vel do workflow
   */
  approveLevel: protectedProcedure
    .input(
      z.object({
        approvalId: z.number(),
        level: z.number().min(1).max(5),
        action: z.enum(["approved", "rejected"]),
        comments: z.string().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar aprovaÃ§Ã£o
      const approval = await db
        .select()
        .from(bonusApprovals)
        .where(eq(bonusApprovals.id, input.approvalId))
        .limit(1);

      if (approval.length === 0) {
        throw new Error("AprovaÃ§Ã£o nÃ£o encontrada");
      }

      const currentApproval = approval[0];

      // Verificar se o nÃ­vel estÃ¡ correto
      if (currentApproval.currentLevel !== input.level) {
        throw new Error(`AprovaÃ§Ã£o deve estar no nÃ­vel ${currentApproval.currentLevel}`);
      }

      // Buscar workflow para verificar prÃ³ximo nÃ­vel
      const workflow = await db
        .select()
        .from(bonusWorkflows)
        .where(eq(bonusWorkflows.id, currentApproval.workflowId))
        .limit(1);

      if (workflow.length === 0) {
        throw new Error("Workflow nÃ£o encontrado");
      }

      const wf = workflow[0];

      // Atualizar status do nÃ­vel atual
      const updateData: any = {};
      updateData[`level${input.level}Status`] = input.action;
      updateData[`level${input.level}ApproverId`] = ctx.user.id;
      updateData[`level${input.level}ApprovedAt`] = new Date();
      if (input.comments) {
        updateData[`level${input.level}Comments`] = input.comments;
      }

      // Se rejeitado, finalizar processo
      if (input.action === "rejected") {
        updateData.status = "rejected";
      } else {
        // Se aprovado, verificar se hÃ¡ prÃ³ximo nÃ­vel
        const nextLevel = input.level + 1;
        const hasNextApprover = wf[`approver${nextLevel}Id` as keyof typeof wf];

        if (hasNextApprover && nextLevel <= 5) {
          // AvanÃ§ar para prÃ³ximo nÃ­vel
          updateData.currentLevel = nextLevel;
        } else {
          // Ãšltima aprovaÃ§Ã£o - finalizar como aprovado
          updateData.status = "approved";
        }
      }

      await db
        .update(bonusApprovals)
        .set(updateData)
        .where(eq(bonusApprovals.id, input.approvalId));

      // Enviar notificaÃ§Ãµes por email
      if (updateData.status === "approved" || updateData.status === "rejected") {
        const {
          sendBonusApprovedEmail,
          sendBonusRejectedEmail,
        } = await import("./utils/bonusEmailNotifications");

        // Buscar dados completos para notificaÃ§Ã£o
        const approval = await db
          .select({
            employeeName: employees.name,
            employeeEmail: employees.email,
            cycleName: evaluationCycles.name,
            finalAmount: bonusApprovals.finalAmount,
          })
          .from(bonusApprovals)
          .leftJoin(employees, eq(bonusApprovals.employeeId, employees.id))
          .leftJoin(evaluationCycles, eq(bonusApprovals.cycleId, evaluationCycles.id))
          .where(eq(bonusApprovals.id, input.approvalId))
          .limit(1);

        if (approval.length > 0) {
          const data = approval[0];
          const notificationData = {
            employeeName: data.employeeName || "Colaborador",
            employeeEmail: data.employeeEmail || "",
            approverName: "Aprovador",
            approverEmail: "",
            cycleName: data.cycleName || "N/A",
            bonusAmount: parseFloat(data.finalAmount),
            approvalLevel: input.level || 1,
            comments: input.comments,
          };

          if (updateData.status === "approved") {
            await sendBonusApprovedEmail(notificationData);
          } else if (updateData.status === "rejected") {
            await sendBonusRejectedEmail(notificationData);
          }
        }
      }

      return { success: true, status: updateData.status || "pending" };
    }),

  /**
   * Gerar PDF de aprovaÃ§Ã£o para assinatura
   */
  generateApprovalPDF: protectedProcedure
    .input(z.object({ approvalId: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar aprovaÃ§Ã£o completa
      const approval = await db
        .select({
          id: bonusApprovals.id,
          cycleId: bonusApprovals.cycleId,
          employeeId: bonusApprovals.employeeId,
          eligibleAmount: bonusApprovals.eligibleAmount,
          extraBonusPercentage: bonusApprovals.extraBonusPercentage,
          finalAmount: bonusApprovals.finalAmount,
          status: bonusApprovals.status,
          cycleName: evaluationCycles.name,
          employeeName: employees.name,
        })
        .from(bonusApprovals)
        .leftJoin(evaluationCycles, eq(bonusApprovals.cycleId, evaluationCycles.id))
        .leftJoin(employees, eq(bonusApprovals.employeeId, employees.id))
        .where(eq(bonusApprovals.id, input.approvalId))
        .limit(1);

      if (approval.length === 0) {
        throw new Error("AprovaÃ§Ã£o nÃ£o encontrada");
      }

      const data = approval[0];

      // Gerar histÃ³rico de aprovaÃ§Ãµes (simular por enquanto)
      const approvalHistory = [
        {
          level: 1,
          approverName: "RH",
          approverRole: "Recursos Humanos",
          status: "approved",
          approvedAt: new Date().toLocaleDateString("pt-BR"),
        },
        {
          level: 2,
          approverName: "Gerente RH",
          approverRole: "GerÃªncia de RH",
          status: "approved",
          approvedAt: new Date().toLocaleDateString("pt-BR"),
        },
        {
          level: 3,
          approverName: "Diretor de Gente",
          approverRole: "Diretoria",
          status: "approved",
          approvedAt: new Date().toLocaleDateString("pt-BR"),
        },
      ];

      const { generateBonusApprovalPDF } = await import("./utils/bonusApprovalPDF");

      const pdfBuffer = await generateBonusApprovalPDF({
        approvalId: data.id,
        cycleName: data.cycleName || "N/A",
        employeeName: data.employeeName || "N/A",
        employeeId: data.employeeId,
        positionName: "Cargo",
        departmentName: "Departamento",
        eligibleAmount: parseFloat(data.eligibleAmount),
        extraBonusPercentage: parseFloat(data.extraBonusPercentage || "0"),
        finalAmount: parseFloat(data.finalAmount),
        approvalHistory,
        generatedAt: new Date().toLocaleString("pt-BR"),
      });

      return {
        filename: `aprovacao-bonus-${input.approvalId}-${Date.now()}.pdf`,
        data: pdfBuffer.toString("base64"),
      };
    }),

  /**
   * Enviar aprovaÃ§Ã£o ao financeiro
   */
  sendToFinance: protectedProcedure
    .input(
      z.object({
        approvalId: z.number(),
        signedPdfUrl: z.string(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db
        .update(bonusApprovals)
        .set({
          signedPdfUrl: input.signedPdfUrl,
          sentToFinanceAt: new Date(),
        })
        .where(eq(bonusApprovals.id, input.approvalId));

      return { success: true };
    }),

  /**
   * Listar aprovaÃ§Ãµes pendentes para o usuÃ¡rio atual
   */
  myPendingApprovals: protectedProcedure.query(async ({ ctx }) => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Buscar workflows onde o usuÃ¡rio Ã© aprovador
    const workflows = await db
      .select()
      .from(bonusWorkflows)
      .where(
        sql`${bonusWorkflows.approver1Id} = ${ctx.user.id} 
        OR ${bonusWorkflows.approver2Id} = ${ctx.user.id}
        OR ${bonusWorkflows.approver3Id} = ${ctx.user.id}
        OR ${bonusWorkflows.approver4Id} = ${ctx.user.id}
        OR ${bonusWorkflows.approver5Id} = ${ctx.user.id}`
      );

    if (workflows.length === 0) {
      return [];
    }

    const workflowIds = workflows.map((w) => w.id);

    // Buscar aprovaÃ§Ãµes pendentes desses workflows
    const approvals = await db
      .select({
        id: bonusApprovals.id,
        cycleId: bonusApprovals.cycleId,
        cycleName: evaluationCycles.name,
        employeeId: bonusApprovals.employeeId,
        employeeName: employees.name,
        eligibleAmount: bonusApprovals.eligibleAmount,
        extraBonusPercentage: bonusApprovals.extraBonusPercentage,
        finalAmount: bonusApprovals.finalAmount,
        currentLevel: bonusApprovals.currentLevel,
        status: bonusApprovals.status,
        createdAt: bonusApprovals.createdAt,
      })
      .from(bonusApprovals)
      .leftJoin(employees, eq(bonusApprovals.employeeId, employees.id))
      .leftJoin(evaluationCycles, eq(bonusApprovals.cycleId, evaluationCycles.id))
      .where(
        and(
          sql`${bonusApprovals.workflowId} IN (${sql.join(workflowIds, sql`, `)})`,
          eq(bonusApprovals.status, "pending")
        )
      )
      .orderBy(desc(bonusApprovals.createdAt));

    // Filtrar apenas aprovaÃ§Ãµes onde o usuÃ¡rio Ã© o aprovador do nÃ­vel atual
    const filtered = approvals.filter((approval) => {
      const workflow = workflows.find((w) => w.id === approval.cycleId);
      if (!workflow) return false;

      const currentLevel = approval.currentLevel;
      const approverId = workflow[`approver${currentLevel}Id` as keyof typeof workflow];

      return approverId === ctx.user.id;
    });

    return filtered;
  }),

  /**
   * Dashboard de bÃ´nus para RH
   */
  getDashboard: protectedProcedure
    .input(
      z.object({
        cycleId: z.number().optional(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      let whereConditions = [];
      if (input.cycleId) {
        whereConditions.push(eq(bonusApprovals.cycleId, input.cycleId));
      }

      const approvals = await db
        .select({
          id: bonusApprovals.id,
          employeeId: bonusApprovals.employeeId,
          employeeName: employees.name,
          departmentId: employees.departmentId,
          eligibleAmount: bonusApprovals.eligibleAmount,
          finalAmount: bonusApprovals.finalAmount,
          status: bonusApprovals.status,
        })
        .from(bonusApprovals)
        .leftJoin(employees, eq(bonusApprovals.employeeId, employees.id))
        .where(whereConditions.length > 0 ? and(...whereConditions) : undefined);

      // Calcular estatÃ­sticas
      let totalEligible = 0;
      let totalFinal = 0;
      let pendingCount = 0;
      let approvedCount = 0;
      let rejectedCount = 0;

      approvals.forEach((approval) => {
        totalEligible += parseFloat(approval.eligibleAmount);
        totalFinal += parseFloat(approval.finalAmount);

        if (approval.status === "pending") pendingCount++;
        else if (approval.status === "approved") approvedCount++;
        else if (approval.status === "rejected") rejectedCount++;
      });

      return {
        totalApprovals: approvals.length,
        totalEligible,
        totalFinal,
        pendingCount,
        approvedCount,
        rejectedCount,
        approvals,
      };
    }),
});


========================================
ARQUIVO: ./server/calibrationRouter.ts
========================================
import { z } from "zod";
import { router, protectedProcedure } from "./_core/trpc";
import { generateCalibrationPDF, generateConsolidatedCalibrationPDF } from "./utils/calibrationPDF";
import { getDb } from "./db";
import { eq, and, desc } from "drizzle-orm";
import { canDoConsensus, canViewEmployee, isAdmin } from "./utils/permissions";

/**
 * Router de CalibraÃ§Ã£o de Diretoria
 * MovimentaÃ§Ã£o de colaboradores no Nine Box com workflow de aprovaÃ§Ã£o
 */
export const calibrationRouter = router({
  /**
   * Criar movimentaÃ§Ã£o de colaborador no Nine Box
   */
  createMovement: protectedProcedure
    .input(
      z.object({
        employeeId: z.number(),
        fromPerformance: z.enum(["baixo", "mÃ©dio", "alto"]).optional(),
        fromPotential: z.enum(["baixo", "mÃ©dio", "alto"]).optional(),
        toPerformance: z.enum(["baixo", "mÃ©dio", "alto"]),
        toPotential: z.enum(["baixo", "mÃ©dio", "alto"]),
        justification: z.string().min(10, "Justificativa deve ter no mÃ­nimo 10 caracteres"),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Verificar permissÃ£o: apenas admin ou lÃ­der direto pode criar movimentaÃ§Ã£o
      const hasPermission = await canDoConsensus(ctx.user.id, input.employeeId);
      if (!hasPermission) {
        throw new Error("VocÃª nÃ£o tem permissÃ£o para movimentar este colaborador");
      }

      const { calibrationMovements, calibrationApprovals } = await import("../drizzle/schema");

      // Criar movimentaÃ§Ã£o
      const [movement] = await db.insert(calibrationMovements).values({
        employeeId: input.employeeId,
        movedBy: ctx.user.id,
        fromPerformance: input.fromPerformance,
        fromPotential: input.fromPotential,
        toPerformance: input.toPerformance,
        toPotential: input.toPotential,
        justification: input.justification,
        status: "pending",
      });

      const movementId = movement.insertId;

      // Criar aprovaÃ§Ãµes do workflow (RH â†’ Diretor de Gente â†’ Diretor de Ãrea)
      await db.insert(calibrationApprovals).values([
        {
          movementId: movementId,
          approverId: ctx.user.id, // Auto-aprovaÃ§Ã£o do RH
          approverRole: "hr",
          status: "approved",
          approvedAt: new Date(),
        },
        {
          movementId: movementId,
          approverId: 0, // SerÃ¡ definido dinamicamente
          approverRole: "people_director",
          status: "pending",
        },
        {
          movementId: movementId,
          approverId: 0, // SerÃ¡ definido dinamicamente
          approverRole: "area_director",
          status: "pending",
        },
      ]);

      return { success: true, movementId };
    }),

  /**
   * Listar movimentaÃ§Ãµes pendentes de aprovaÃ§Ã£o
   */
  listPendingMovements: protectedProcedure.query(async ({ ctx }) => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const { calibrationMovements, calibrationApprovals, employees } = await import(
      "../drizzle/schema"
    );

    // Buscar movimentaÃ§Ãµes com aprovaÃ§Ãµes pendentes
    const movements = await db
      .select()
      .from(calibrationMovements)
      .leftJoin(employees, eq(calibrationMovements.employeeId, employees.id))
      .leftJoin(calibrationApprovals, eq(calibrationMovements.id, calibrationApprovals.movementId))
      .where(eq(calibrationApprovals.status, "pending"))
      .orderBy(desc(calibrationMovements.createdAt));

    return movements;
  }),

  /**
   * Aprovar movimentaÃ§Ã£o
   */
  approveMovement: protectedProcedure
    .input(
      z.object({
        approvalId: z.number(),
        evidence: z.string().optional(),
        comments: z.string().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { calibrationApprovals, calibrationMovements } = await import("../drizzle/schema");

      // Buscar aprovaÃ§Ã£o
      const [approval] = await db
        .select()
        .from(calibrationApprovals)
        .where(eq(calibrationApprovals.id, input.approvalId))
        .limit(1);

      if (!approval) throw new Error("AprovaÃ§Ã£o nÃ£o encontrada");

      // Verificar se Ã© Diretor de Ãrea e exigir evidÃªncias
      if (approval.approverRole === "area_director" && !input.evidence) {
        throw new Error("EvidÃªncias sÃ£o obrigatÃ³rias para Diretor de Ãrea");
      }

      // Atualizar aprovaÃ§Ã£o
      await db
        .update(calibrationApprovals)
        .set({
          status: "approved",
          evidence: input.evidence,
          comments: input.comments,
          approvedAt: new Date(),
          approverId: ctx.user.id,
        })
        .where(eq(calibrationApprovals.id, input.approvalId));

      // Verificar se todas as aprovaÃ§Ãµes foram concluÃ­das
      const allApprovals = await db
        .select()
        .from(calibrationApprovals)
        .where(eq(calibrationApprovals.movementId, approval.movementId));

      const allApproved = allApprovals.every((a) => a.status === "approved");

      if (allApproved) {
        // Atualizar status da movimentaÃ§Ã£o para aprovado
        await db
          .update(calibrationMovements)
          .set({ status: "approved_area_director" })
          .where(eq(calibrationMovements.id, approval.movementId));

        // Atualizar posiÃ§Ã£o do colaborador no Nine Box
        const [movement] = await db
          .select()
          .from(calibrationMovements)
          .where(eq(calibrationMovements.id, approval.movementId))
          .limit(1);

        if (movement) {
          const { nineBoxPositions, evaluationCycles } = await import("../drizzle/schema");
          
          // Buscar ciclo ativo
          const [activeCycle] = await db
            .select()
            .from(evaluationCycles)
            .where(eq(evaluationCycles.status, "em_andamento"))
            .limit(1);

          if (!activeCycle) {
            console.warn("Nenhum ciclo ativo encontrado para atualizar Nine Box");
            return { success: true, allApproved };
          }

          // Converter enum para nÃºmero (baixo=1, mÃ©dio=2, alto=3)
          const performanceMap: Record<string, number> = { baixo: 1, mÃ©dio: 2, alto: 3 };
          const performanceNum = performanceMap[movement.toPerformance];
          const potentialNum = performanceMap[movement.toPotential];

          // Calcular box
          const box = `${movement.toPerformance}_desempenho_${movement.toPotential}_potencial`;
          
          // Atualizar ou criar posiÃ§Ã£o no Nine Box
          const [existingPosition] = await db
            .select()
            .from(nineBoxPositions)
            .where(
              and(
                eq(nineBoxPositions.employeeId, movement.employeeId),
                eq(nineBoxPositions.cycleId, activeCycle.id)
              )
            )
            .limit(1);

          if (existingPosition) {
            await db
              .update(nineBoxPositions)
              .set({
                performance: performanceNum,
                potential: potentialNum,
                box,
                calibrated: true,
                calibratedBy: ctx.user.id,
                calibratedAt: new Date(),
                updatedAt: new Date(),
              })
              .where(eq(nineBoxPositions.id, existingPosition.id));
          } else {
            await db.insert(nineBoxPositions).values({
              cycleId: activeCycle.id,
              employeeId: movement.employeeId,
              performance: performanceNum,
              potential: potentialNum,
              box,
              calibrated: true,
              calibratedBy: ctx.user.id,
              calibratedAt: new Date(),
            });
          }
        }
      }

      return { success: true, allApproved };
    }),

  /**
   * Rejeitar movimentaÃ§Ã£o
   */
  rejectMovement: protectedProcedure
    .input(
      z.object({
        approvalId: z.number(),
        comments: z.string().min(10, "ComentÃ¡rio obrigatÃ³rio ao rejeitar"),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { calibrationApprovals, calibrationMovements } = await import("../drizzle/schema");

      // Buscar aprovaÃ§Ã£o
      const [approval] = await db
        .select()
        .from(calibrationApprovals)
        .where(eq(calibrationApprovals.id, input.approvalId))
        .limit(1);

      if (!approval) throw new Error("AprovaÃ§Ã£o nÃ£o encontrada");

      // Atualizar aprovaÃ§Ã£o
      await db
        .update(calibrationApprovals)
        .set({
          status: "rejected",
          comments: input.comments,
          approvedAt: new Date(),
          approverId: ctx.user.id,
        })
        .where(eq(calibrationApprovals.id, input.approvalId));

      // Atualizar status da movimentaÃ§Ã£o para rejeitado
      await db
        .update(calibrationMovements)
        .set({ status: "rejected" })
        .where(eq(calibrationMovements.id, approval.movementId));

      return { success: true };
    }),

  /**
   * Listar histÃ³rico de movimentaÃ§Ãµes de um colaborador
   */
  getEmployeeMovementHistory: protectedProcedure
    .input(z.object({ employeeId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { calibrationMovements, calibrationApprovals, users } = await import(
        "../drizzle/schema"
      );

      const movements = await db
        .select()
        .from(calibrationMovements)
        .leftJoin(users, eq(calibrationMovements.movedBy, users.id))
        .where(eq(calibrationMovements.employeeId, input.employeeId))
        .orderBy(desc(calibrationMovements.createdAt));

      // Buscar aprovaÃ§Ãµes de cada movimentaÃ§Ã£o
      const movementsWithApprovals = await Promise.all(
        movements.map(async (movement) => {
          const approvals = await db
            .select()
            .from(calibrationApprovals)
            .where(eq(calibrationApprovals.movementId, movement.calibrationMovements.id));

          return {
            ...movement,
            approvals,
          };
        })
      );

      return movementsWithApprovals;
    }),

  /**
   * Obter estatÃ­sticas de calibraÃ§Ã£o
   */
  getCalibrationStats: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const { calibrationMovements } = await import("../drizzle/schema");

    const allMovements = await db.select().from(calibrationMovements);

    const stats = {
      total: allMovements.length,
      pending: allMovements.filter((m) => m.status === "pending").length,
      approved: allMovements.filter((m) => m.status === "approved_area_director").length,
      rejected: allMovements.filter((m) => m.status === "rejected").length,
    };

    return stats;
  }),

  /**
   * Exportar PDF de calibraÃ§Ã£o individual
   */
  exportPDF: protectedProcedure
    .input(z.object({ movementId: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { calibrationMovements, calibrationApprovals, employees, departments, positions } =
        await import("../drizzle/schema");

      // Buscar movimentaÃ§Ã£o
      const [movement] = await db
        .select()
        .from(calibrationMovements)
        .where(eq(calibrationMovements.id, input.movementId))
        .limit(1);

      if (!movement) throw new Error("MovimentaÃ§Ã£o nÃ£o encontrada");

      // Buscar colaborador
      const [employee] = await db
        .select({
          employee: employees,
          department: departments,
          position: positions,
        })
        .from(employees)
        .leftJoin(departments, eq(employees.departmentId, departments.id))
        .leftJoin(positions, eq(employees.positionId, positions.id))
        .where(eq(employees.id, movement.employeeId))
        .limit(1);

      if (!employee) throw new Error("Colaborador nÃ£o encontrado");

      // Buscar aprovaÃ§Ãµes
      const approvals = await db
        .select({
          approval: calibrationApprovals,
          approver: employees,
        })
        .from(calibrationApprovals)
        .leftJoin(employees, eq(calibrationApprovals.approverId, employees.id))
        .where(eq(calibrationApprovals.movementId, input.movementId));

      // Preparar dados
      const data = {
        employee: {
          name: employee.employee.name,
          employeeCode: employee.employee.employeeCode,
          department: employee.department?.name || "N/A",
          position: employee.position?.title || "N/A",
        },
        movement: {
          fromPerformance: movement.fromPerformance || "baixo",
          fromPotential: movement.fromPotential || "baixo",
          toPerformance: movement.toPerformance,
          toPotential: movement.toPotential,
          justification: movement.justification,
          createdAt: movement.createdAt,
        },
        approvals: approvals.map((a) => ({
          approverName: a.approver?.name || "N/A",
          approverRole: a.approval.approverRole,
          status: a.approval.status,
          evidence: a.approval.evidence || undefined,
          comments: a.approval.comments || undefined,
          approvedAt: a.approval.approvedAt || undefined,
        })),
      };

      // Gerar PDF
      const pdfBuffer = await generateCalibrationPDF(data);

      return {
        success: true,
        pdf: pdfBuffer.toString("base64"),
        filename: `calibracao_${employee.employee.employeeCode}_${Date.now()}.pdf`,
      };
    }),
});


========================================
ARQUIVO: ./server/cron.ts
========================================
import cron from 'node-cron';
import { getDb } from './db';
import { startNotificationCron } from './jobs/notificationCron';
import { calculateDailyDiscrepancies } from './jobs/calculateDiscrepancies';
import { sendPulseEmailsJob } from './jobs/sendPulseEmails';
import { goals, performanceEvaluations, pdiItems, employees, pdiPlans, smartGoals } from '../drizzle/schema';
import { eq, and, lt, gte } from 'drizzle-orm';
import { emailService } from './utils/emailService';

/**
 * Cron Jobs para Lembretes AutomÃ¡ticos
 * Sistema AVD UISA
 */// Lembrete de metas prÃ³ximas do vencimento (executa diariamente Ã s 9h)
export const goalReminderJob = cron.schedule('0 9 * * *', async () => {
  console.log('[Cron] Executando job de lembretes de metas...');
  
  const db = await getDb();
  if (!db) {
    console.error('[Cron] Database not available');
    return;
  }

  try {
    // Buscar metas em andamento
    const activeGoals = await db.select()
      .from(goals)
      .innerJoin(employees, eq(goals.employeeId, employees.id))
      .where(eq(goals.status, 'em_andamento'));

    console.log(`[Cron] ${activeGoals.length} metas ativas encontradas`);
    // TODO: Implementar lÃ³gica de envio de e-mails
  } catch (error) {
    console.error('[Cron] Erro ao processar lembretes de metas:', error);
  }
});

// Lembrete de metas SMART 7 dias antes do vencimento (executa diariamente Ã s 9h)
export const smartGoalDueDateReminderJob = cron.schedule('0 9 * * *', async () => {
  console.log('[Cron] Executando job de lembretes de vencimento de metas SMART...');
  
  const db = await getDb();
  if (!db) {
    console.error('[Cron] Database not available');
    return;
  }

  try {
    const sevenDaysFromNow = new Date();
    sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
    const eightDaysFromNow = new Date();
    eightDaysFromNow.setDate(eightDaysFromNow.getDate() + 8);

    // Buscar metas que vencem em 7 dias
    const upcomingGoals = await db.select()
      .from(smartGoals)
      .innerJoin(employees, eq(smartGoals.employeeId, employees.id))
      .where(
        and(
          gte(smartGoals.endDate, sevenDaysFromNow),
          lt(smartGoals.endDate, eightDaysFromNow),
          eq(smartGoals.status, 'in_progress')
        )
      );

    console.log(`[Cron] ${upcomingGoals.length} metas SMART vencem em 7 dias`);

    // Enviar emails de lembrete
    for (const goal of upcomingGoals) {
      if (goal.employees?.email) {
        await emailService.sendGoalReminder(goal.employees.email, {
          employeeName: goal.employees.name,
          goalTitle: goal.smartGoals.title,
          dueDate: goal.smartGoals.endDate.toLocaleDateString('pt-BR'),
          progress: parseFloat(goal.smartGoals.currentValue || "0") || 0,
        });
      }
    }
  } catch (error) {
    console.error('[Cron] Erro ao processar lembretes de vencimento:', error);
  }
});

// Alerta de metas sem progresso hÃ¡ 15 dias (executa diariamente Ã s 10h)
export const smartGoalNoProgressAlertJob = cron.schedule('0 10 * * *', async () => {
  console.log('[Cron] Executando job de alertas de metas sem progresso...');
  
  const db = await getDb();
  if (!db) {
    console.error('[Cron] Database not available');
    return;
  }

  try {
    const fifteenDaysAgo = new Date();
    fifteenDaysAgo.setDate(fifteenDaysAgo.getDate() - 15);

    // Buscar metas sem atualizaÃ§Ã£o hÃ¡ 15 dias
    const staleGoals = await db.select()
      .from(smartGoals)
      .innerJoin(employees, eq(smartGoals.employeeId, employees.id))
      .where(
        and(
          lt(smartGoals.updatedAt, fifteenDaysAgo),
          eq(smartGoals.status, 'in_progress')
        )
      );

    console.log(`[Cron] ${staleGoals.length} metas sem progresso hÃ¡ 15+ dias`);

    // Enviar alertas
    for (const goal of staleGoals) {
      if (goal.employees?.email) {
        // Enviar lembrete genÃ©rico sobre progresso
        await emailService.sendGoalReminder(goal.employees.email, {
          employeeName: goal.employees.name,
          goalTitle: goal.smartGoals.title,
          dueDate: goal.smartGoals.endDate.toLocaleDateString('pt-BR'),
          progress: parseFloat(goal.smartGoals.currentValue || "0") || 0,
        });
      }
    }
  } catch (error) {
    console.error('[Cron] Erro ao processar alertas de progresso:', error);
  }
});

// Lembrete para gestores sobre metas pendentes de aprovaÃ§Ã£o (executa diariamente Ã s 14h)
export const smartGoalApprovalReminderJob = cron.schedule('0 14 * * *', async () => {
  console.log('[Cron] Executando job de lembretes de aprovaÃ§Ã£o de metas...');
  
  const db = await getDb();
  if (!db) {
    console.error('[Cron] Database not available');
    return;
  }

  try {
    const threeDaysAgo = new Date();
    threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);

    // Buscar metas pendentes hÃ¡ mais de 3 dias
    const pendingGoals = await db.select()
      .from(smartGoals)
      .innerJoin(employees, eq(smartGoals.employeeId, employees.id))
      .where(
        lt(smartGoals.createdAt, threeDaysAgo)
      );

    console.log(`[Cron] ${pendingGoals.length} metas pendentes de aprovaÃ§Ã£o hÃ¡ 3+ dias`);

    // Agrupar por gestor (assumindo que o gestor estÃ¡ no departamento)
    const managerMap = new Map<number, any[]>();
    for (const goal of pendingGoals) {
      const deptId = goal.employees?.departmentId;
      if (!deptId) continue;
      
      if (!managerMap.has(deptId)) {
        managerMap.set(deptId, []);
      }
      managerMap.get(deptId)!.push(goal);
    }

    // Enviar lembretes aos gestores
    // TODO: Buscar email do gestor do departamento
    console.log(`[Cron] ${managerMap.size} gestores precisam aprovar metas`);
  } catch (error) {
    console.error('[Cron] Erro ao processar lembretes de aprovaÃ§Ã£o:', error);
  }
});

// Lembrete de avaliaÃ§Ãµes pendentes (executa semanalmente Ã s segundas-feiras Ã s 9h)
export const evaluationReminderJob = cron.schedule('0 9 * * 1', async () => {
  console.log('[Cron] Executando job de lembretes de avaliaÃ§Ãµes...');
  
  const db = await getDb();
  if (!db) {
    console.error('[Cron] Database not available');
    return;
  }

  try {
    // Buscar avaliaÃ§Ãµes pendentes
    const pendingEvaluations = await db.select()
      .from(performanceEvaluations)
      .innerJoin(employees, eq(performanceEvaluations.employeeId, employees.id))
      .where(eq(performanceEvaluations.status, 'pendente'));

    console.log(`[Cron] ${pendingEvaluations.length} avaliaÃ§Ãµes pendentes encontradas`);
    // TODO: Implementar lÃ³gica de envio de e-mails
  } catch (error) {
    console.error('[Cron] Erro ao processar lembretes de avaliaÃ§Ãµes:', error);
  }
});

// Lembrete de aÃ§Ãµes de PDI vencidas (executa diariamente Ã s 10h)
export const pdiOverdueJob = cron.schedule('0 10 * * *', async () => {
  console.log('[Cron] Executando job de aÃ§Ãµes de PDI vencidas...');
  
  const db = await getDb();
  if (!db) {
    console.error('[Cron] Database not available');
    return;
  }

  try {
    // Buscar aÃ§Ãµes de PDI vencidas (via pdiPlans)
    const overdueActions = await db.select()
      .from(pdiItems)
      .where(
        and(
          eq(pdiItems.status, 'em_andamento'),
          lt(pdiItems.endDate, new Date())
        )
      );

    for (const item of overdueActions) {
      // Buscar colaborador via planId
      const plan = await db.select()
        .from(pdiPlans)
        .innerJoin(employees, eq(pdiPlans.employeeId, employees.id))
        .where(eq(pdiPlans.id, item.planId))
        .limit(1);

      if (plan.length > 0 && plan[0].employees.email) {
        await emailService.sendActionOverdue(plan[0].employees.email, {
          employeeName: plan[0].employees.name,
          actionTitle: item.title,
          dueDate: item.endDate.toLocaleDateString('pt-BR'),
          pdiTitle: 'PDI ' + new Date().getFullYear(),
        });
      }
    }

    console.log(`[Cron] ${overdueActions.length} lembretes de aÃ§Ãµes vencidas enviados`);
  } catch (error) {
    console.error('[Cron] Erro ao enviar lembretes de aÃ§Ãµes vencidas:', error);
  }
});

// Job de cÃ¡lculo de discrepÃ¢ncias (executa diariamente Ã s 6h)
export const calculateDiscrepanciesJob = cron.schedule('0 6 * * *', async () => {
  console.log('[Cron] Executando job de cÃ¡lculo de discrepÃ¢ncias...');
  
  try {
    const result = await calculateDailyDiscrepancies();
    console.log('[Cron] Resultado do cÃ¡lculo de discrepÃ¢ncias:', result);
  } catch (error) {
    console.error('[Cron] Erro ao calcular discrepÃ¢ncias:', error);
  }
});

// Job de envio de e-mails de Pesquisas Pulse (executa a cada 8 horas)
export const pulseSurveyEmailJob = cron.schedule('0 */8 * * *', async () => {
  console.log('[Cron] Executando job de envio de e-mails Pulse...');
  
  try {
    await sendPulseEmailsJob();
  } catch (error) {
    console.error('[Cron] Erro ao enviar e-mails Pulse:', error);
  }
});

// Iniciar todos os cron jobs
export function startCronJobs() {
  console.log('[Cron] Iniciando cron jobs...');
  goalReminderJob.start();
  evaluationReminderJob.start();
  pdiOverdueJob.start();
  scheduledReportsJob.start();
  calculateDiscrepanciesJob.start();
  pulseSurveyEmailJob.start();
  // Iniciar job de notificaÃ§Ãµes automÃ¡ticas
  startNotificationCron();
  
  console.log('[Cron] Cron jobs iniciados com sucesso');
}

// Parar todos os cron jobs
export function stopCronJobs() {
  console.log('[Cron] Parando cron jobs...');
  goalReminderJob.stop();
  evaluationReminderJob.stop();
  pdiOverdueJob.stop();
  scheduledReportsJob.stop();
  pulseSurveyEmailJob.stop();
  console.log('[Cron] Cron jobs parados');
}

// Job de relatÃ³rios agendados (executa a cada hora)
export const scheduledReportsJob = cron.schedule('0 * * * *', async () => {
  console.log('[Cron] Executando job de relatÃ³rios agendados...');
  
  const db = await getDb();
  if (!db) {
    console.error('[Cron] Database not available');
    return;
  }

  try {
    const { scheduledReports, reportExecutionLogs } = await import('../drizzle/schema');
    
    // Buscar relatÃ³rios ativos que precisam ser executados
    const now = new Date();
    const reportsToExecute = await db.select()
      .from(scheduledReports)
      .where(
        and(
          eq(scheduledReports.active, true),
          lt(scheduledReports.nextExecutionAt, now)
        )
      );

    console.log(`[Cron] ${reportsToExecute.length} relatÃ³rios para executar`);

    for (const report of reportsToExecute) {
      const startTime = Date.now();
      
      try {
        const recipients = JSON.parse(report.recipients);
        
        // TODO: Implementar geraÃ§Ã£o real do relatÃ³rio baseado em report.reportType
        // Por enquanto, apenas registrar execuÃ§Ã£o
        
        console.log(`[Cron] Executando relatÃ³rio: ${report.reportName} (${report.reportType})`);
        
        // Simular envio de e-mail
        // await emailService.sendReport(recipients, {
        //   reportName: report.reportName,
        //   reportType: report.reportType,
        //   format: report.format,
        // });

        const executionTimeMs = Date.now() - startTime;

        // Registrar log de execuÃ§Ã£o bem-sucedida
        await db.insert(reportExecutionLogs).values({
          scheduledReportId: report.id,
          executedAt: new Date(),
          status: 'success',
          recipientCount: recipients.length,
          successCount: recipients.length,
          failedCount: 0,
          executionTimeMs,
          fileSize: 0, // TODO: tamanho real do arquivo
        });

        // Calcular prÃ³xima execuÃ§Ã£o
        const nextExecutionAt = calculateNextExecution(
          report.frequency,
          report.hour,
          report.dayOfWeek ?? undefined,
          report.dayOfMonth ?? undefined
        );

        // Atualizar relatÃ³rio
        await db.update(scheduledReports)
          .set({
            lastExecutedAt: new Date(),
            nextExecutionAt,
          })
          .where(eq(scheduledReports.id, report.id));

        console.log(`[Cron] RelatÃ³rio ${report.reportName} executado com sucesso`);
      } catch (error) {
        // Registrar log de execuÃ§Ã£o com falha
        await db.insert(reportExecutionLogs).values({
          scheduledReportId: report.id,
          executedAt: new Date(),
          status: 'failed',
          recipientCount: 0,
          successCount: 0,
          failedCount: 0,
          errorMessage: error instanceof Error ? error.message : 'Erro desconhecido',
          executionTimeMs: Date.now() - startTime,
        });

        console.error(`[Cron] Erro ao executar relatÃ³rio ${report.reportName}:`, error);
      }
    }
  } catch (error) {
    console.error('[Cron] Erro ao processar relatÃ³rios agendados:', error);
  }
});

/**
 * Calcular prÃ³xima data de execuÃ§Ã£o baseado na frequÃªncia
 */
function calculateNextExecution(
  frequency: "daily" | "weekly" | "monthly" | "quarterly",
  hour: number,
  dayOfWeek?: number,
  dayOfMonth?: number
): Date {
  const now = new Date();
  const next = new Date();

  next.setHours(hour, 0, 0, 0);

  switch (frequency) {
    case "daily":
      // Se jÃ¡ passou a hora de hoje, agendar para amanhÃ£
      if (next <= now) {
        next.setDate(next.getDate() + 1);
      }
      break;

    case "weekly":
      if (dayOfWeek !== undefined) {
        const currentDay = next.getDay();
        let daysUntilNext = dayOfWeek - currentDay;
        
        if (daysUntilNext < 0 || (daysUntilNext === 0 && next <= now)) {
          daysUntilNext += 7;
        }
        
        next.setDate(next.getDate() + daysUntilNext);
      }
      break;

    case "monthly":
      if (dayOfMonth !== undefined) {
        next.setDate(dayOfMonth);
        
        // Se jÃ¡ passou este mÃªs, ir para o prÃ³ximo
        if (next <= now) {
          next.setMonth(next.getMonth() + 1);
        }
      }
      break;

    case "quarterly":
      if (dayOfMonth !== undefined) {
        next.setDate(dayOfMonth);
        
        // Encontrar prÃ³ximo trimestre
        const currentMonth = next.getMonth();
        const quarterStartMonths = [0, 3, 6, 9]; // Jan, Abr, Jul, Out
        
        let nextQuarterMonth = quarterStartMonths.find(m => {
          const testDate = new Date(next);
          testDate.setMonth(m);
          return testDate > now;
        });
        
        if (nextQuarterMonth === undefined) {
          // PrÃ³ximo ano
          next.setFullYear(next.getFullYear() + 1);
          next.setMonth(0);
        } else {
          next.setMonth(nextQuarterMonth);
        }
      }
      break;
  }

  return next;
}


========================================
ARQUIVO: ./server/cyclesRouter.ts
========================================
import { TRPCError } from "@trpc/server";
import { eq } from "drizzle-orm";
import { z } from "zod";
import { evaluationCycles } from "../drizzle/schema";
import { getDb } from "./db";
import { protectedProcedure, router } from "./_core/trpc";

/**
 * Router de GestÃ£o de Ciclos de AvaliaÃ§Ã£o
 * CRUD completo para gerenciar ciclos anuais/semestrais/trimestrais
 */
export const cyclesRouter = router({
  /**
   * Listar todos os ciclos
   */
  list: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) return [];

    const cycles = await db.select().from(evaluationCycles).orderBy(evaluationCycles.year);
    return cycles;
  }),

  /**
   * Buscar ciclo por ID
   */
  getById: protectedProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return null;

      const cycle = await db
        .select()
        .from(evaluationCycles)
        .where(eq(evaluationCycles.id, input.id))
        .limit(1);

      return cycle.length > 0 ? cycle[0] : null;
    }),

  /**
   * Criar novo ciclo
   */
  create: protectedProcedure
    .input(
      z.object({
        name: z.string(),
        year: z.number(),
        type: z.enum(["anual", "semestral", "trimestral"]),
        startDate: z.string(), // ISO date string
        endDate: z.string(),
        selfEvaluationDeadline: z.string().optional(),
        managerEvaluationDeadline: z.string().optional(),
        consensusDeadline: z.string().optional(),
        description: z.string().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const result = await db.insert(evaluationCycles).values({
        name: input.name,
        year: input.year,
        type: input.type,
        startDate: new Date(input.startDate),
        endDate: new Date(input.endDate),
        selfEvaluationDeadline: input.selfEvaluationDeadline ? new Date(input.selfEvaluationDeadline) : null,
        managerEvaluationDeadline: input.managerEvaluationDeadline ? new Date(input.managerEvaluationDeadline) : null,
        consensusDeadline: input.consensusDeadline ? new Date(input.consensusDeadline) : null,
        description: input.description || null,
        status: "planejamento",
      });

      return { id: 0, success: true }; // ID serÃ¡ gerado pelo auto-increment
    }),

  /**
   * Atualizar ciclo existente
   */
  update: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        name: z.string().optional(),
        year: z.number().optional(),
        type: z.enum(["anual", "semestral", "trimestral"]).optional(),
        startDate: z.string().optional(),
        endDate: z.string().optional(),
        selfEvaluationDeadline: z.string().optional(),
        managerEvaluationDeadline: z.string().optional(),
        consensusDeadline: z.string().optional(),
        status: z.enum(["planejamento", "em_andamento", "concluido", "cancelado"]).optional(),
        description: z.string().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const updateData: any = {};
      if (input.name) updateData.name = input.name;
      if (input.year) updateData.year = input.year;
      if (input.type) updateData.type = input.type;
      if (input.startDate) updateData.startDate = new Date(input.startDate);
      if (input.endDate) updateData.endDate = new Date(input.endDate);
      if (input.selfEvaluationDeadline) updateData.selfEvaluationDeadline = new Date(input.selfEvaluationDeadline);
      if (input.managerEvaluationDeadline) updateData.managerEvaluationDeadline = new Date(input.managerEvaluationDeadline);
      if (input.consensusDeadline) updateData.consensusDeadline = new Date(input.consensusDeadline);
      if (input.status) updateData.status = input.status;
      if (input.description !== undefined) updateData.description = input.description;

      await db
        .update(evaluationCycles)
        .set(updateData)
        .where(eq(evaluationCycles.id, input.id));

      return { success: true };
    }),

  /**
   * Ativar ciclo (mudar status para em_andamento)
   */
  activate: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      await db
        .update(evaluationCycles)
        .set({ status: "em_andamento" })
        .where(eq(evaluationCycles.id, input.id));

      return { success: true };
    }),

  /**
   * Desativar ciclo (mudar status para cancelado)
   */
  deactivate: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      await db
        .update(evaluationCycles)
        .set({ status: "cancelado" })
        .where(eq(evaluationCycles.id, input.id));

      return { success: true };
    }),

  /**
   * Concluir ciclo
   */
  complete: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      await db
        .update(evaluationCycles)
        .set({ status: "concluido" })
        .where(eq(evaluationCycles.id, input.id));

      return { success: true };
    }),

  /**
   * Deletar ciclo
   */
  delete: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      await db.delete(evaluationCycles).where(eq(evaluationCycles.id, input.id));

      return { success: true };
    }),
});


========================================
ARQUIVO: ./server/db.ts
========================================
import { and, desc, eq, gte, lte, sql } from "drizzle-orm";
import { drizzle } from "drizzle-orm/mysql2";
import {
  auditLogs,
  departments,
  developmentActions,
  employeeCompetencies,
  employees,
  evaluationCycles,
  goals,
  InsertUser,
  nineBoxPositions,
  pdiItems,
  pdiPlans,
  performanceEvaluations,
  positions,
  users,
} from "../drizzle/schema";
import { ENV } from "./_core/env";

let _db: ReturnType<typeof drizzle> | null = null;

export async function getDb() {
  if (!_db && process.env.DATABASE_URL) {
    try {
      _db = drizzle(process.env.DATABASE_URL);
    } catch (error) {
      console.warn("[Database] Failed to connect:", error);
      _db = null;
    }
  }
  return _db;
}

// ============================================================================
// USUÃRIOS E AUTENTICAÃ‡ÃƒO
// ============================================================================

export async function upsertUser(user: InsertUser): Promise<void> {
  if (!user.openId) {
    throw new Error("User openId is required for upsert");
  }

  const db = await getDb();
  if (!db) {
    console.warn("[Database] Cannot upsert user: database not available");
    return;
  }

  try {
    const values: InsertUser = {
      openId: user.openId,
    };
    const updateSet: Record<string, unknown> = {};

    const textFields = ["name", "email", "loginMethod"] as const;
    type TextField = (typeof textFields)[number];

    const assignNullable = (field: TextField) => {
      const value = user[field];
      if (value === undefined) return;
      const normalized = value ?? null;
      values[field] = normalized;
      updateSet[field] = normalized;
    };

    textFields.forEach(assignNullable);

    if (user.lastSignedIn !== undefined) {
      values.lastSignedIn = user.lastSignedIn;
      updateSet.lastSignedIn = user.lastSignedIn;
    }
    if (user.role !== undefined) {
      values.role = user.role;
      updateSet.role = user.role;
    } else if (user.openId === ENV.ownerOpenId) {
      values.role = "admin";
      updateSet.role = "admin";
    }

    if (!values.lastSignedIn) {
      values.lastSignedIn = new Date();
    }

    if (Object.keys(updateSet).length === 0) {
      updateSet.lastSignedIn = new Date();
    }

    await db.insert(users).values(values).onDuplicateKeyUpdate({
      set: updateSet,
    });
  } catch (error) {
    console.error("[Database] Failed to upsert user:", error);
    throw error;
  }
}

export async function getUserByOpenId(openId: string) {
  const db = await getDb();
  if (!db) {
    console.warn("[Database] Cannot get user: database not available");
    return undefined;
  }

  const result = await db.select().from(users).where(eq(users.openId, openId)).limit(1);
  return result.length > 0 ? result[0] : undefined;
}

export async function getUserById(id: number) {
  const db = await getDb();
  if (!db) return undefined;

  const result = await db.select().from(users).where(eq(users.id, id)).limit(1);
  return result.length > 0 ? result[0] : undefined;
}

export async function getUserByEmail(email: string) {
  const db = await getDb();
  if (!db) return undefined;

  const result = await db.select().from(users).where(eq(users.email, email)).limit(1);
  return result.length > 0 ? result[0] : undefined;
}

// ============================================================================
// COLABORADORES
// ============================================================================

export async function getAllEmployees() {
  const db = await getDb();
  if (!db) return [];

  return await db
    .select({
      employee: employees,
      department: departments,
      position: positions,
    })
    .from(employees)
    .leftJoin(departments, eq(employees.departmentId, departments.id))
    .leftJoin(positions, eq(employees.positionId, positions.id))
    .where(eq(employees.status, "ativo"))
    .orderBy(employees.name);
}

export async function getEmployeeById(id: number) {
  const db = await getDb();
  if (!db) return undefined;

  const result = await db
    .select({
      employee: employees,
      department: departments,
      position: positions,
    })
    .from(employees)
    .leftJoin(departments, eq(employees.departmentId, departments.id))
    .leftJoin(positions, eq(employees.positionId, positions.id))
    .where(eq(employees.id, id))
    .limit(1);

  return result.length > 0 ? result[0] : undefined;
}

export async function getEmployeeByUserId(userId: number) {
  const db = await getDb();
  if (!db) return undefined;

  const result = await db
    .select()
    .from(employees)
    .where(eq(employees.userId, userId))
    .limit(1);

  return result.length > 0 ? result[0] : undefined;
}

// ============================================================================
// METAS
// ============================================================================

export async function getGoalsByEmployee(employeeId: number, cycleId?: number) {
  const db = await getDb();
  if (!db) return [];

  const conditions = [eq(goals.employeeId, employeeId)];
  if (cycleId) {
    conditions.push(eq(goals.cycleId, cycleId));
  }

  return await db
    .select()
    .from(goals)
    .where(and(...conditions))
    .orderBy(desc(goals.createdAt));
}

export async function getGoalById(id: number) {
  const db = await getDb();
  if (!db) return undefined;

  const result = await db.select().from(goals).where(eq(goals.id, id)).limit(1);
  return result.length > 0 ? result[0] : undefined;
}

// ============================================================================
// AVALIAÃ‡Ã•ES 360Â°
// ============================================================================

export async function getEvaluationsByEmployee(employeeId: number, cycleId?: number) {
  const db = await getDb();
  if (!db) return [];

  const conditions = [eq(performanceEvaluations.employeeId, employeeId)];
  if (cycleId) {
    conditions.push(eq(performanceEvaluations.cycleId, cycleId));
  }

  return await db
    .select()
    .from(performanceEvaluations)
    .where(and(...conditions))
    .orderBy(desc(performanceEvaluations.createdAt));
}

export async function getEvaluationById(id: number) {
  const db = await getDb();
  if (!db) return undefined;

  const result = await db
    .select()
    .from(performanceEvaluations)
    .where(eq(performanceEvaluations.id, id))
    .limit(1);

  return result.length > 0 ? result[0] : undefined;
}

// ============================================================================
// PDI (Plano de Desenvolvimento Individual)
// ============================================================================

export async function getPDIsByEmployee(employeeId: number, cycleId?: number) {
  const db = await getDb();
  if (!db) return [];

  const conditions = [eq(pdiPlans.employeeId, employeeId)];
  if (cycleId) {
    conditions.push(eq(pdiPlans.cycleId, cycleId));
  }

  return await db
    .select()
    .from(pdiPlans)
    .where(and(...conditions))
    .orderBy(desc(pdiPlans.createdAt));
}

export async function getPDIById(id: number) {
  const db = await getDb();
  if (!db) return undefined;

  const result = await db
    .select()
    .from(pdiPlans)
    .where(eq(pdiPlans.id, id))
    .limit(1);

  return result.length > 0 ? result[0] : undefined;
}

export async function getPDIItemsByPlan(planId: number) {
  const db = await getDb();
  if (!db) return [];

  return await db
    .select()
    .from(pdiItems)
    .where(eq(pdiItems.planId, planId))
    .orderBy(pdiItems.startDate);
}

export async function getDevelopmentActions() {
  const db = await getDb();
  if (!db) return [];

  return await db
    .select()
    .from(developmentActions)
    .where(eq(developmentActions.active, true))
    .orderBy(developmentActions.title);
}

// ============================================================================
// MATRIZ 9-BOX
// ============================================================================

export async function getNineBoxByCycle(cycleId: number) {
  const db = await getDb();
  if (!db) return [];

  return await db
    .select({
      nineBox: nineBoxPositions,
      employee: employees,
      position: positions,
    })
    .from(nineBoxPositions)
    .leftJoin(employees, eq(nineBoxPositions.employeeId, employees.id))
    .leftJoin(positions, eq(employees.positionId, positions.id))
    .where(eq(nineBoxPositions.cycleId, cycleId))
    .orderBy(desc(nineBoxPositions.performance), desc(nineBoxPositions.potential));
}

// ============================================================================
// COMPETÃŠNCIAS
// ============================================================================

export async function getEmployeeCompetencies(employeeId: number) {
  const db = await getDb();
  if (!db) return [];

  return await db
    .select()
    .from(employeeCompetencies)
    .where(eq(employeeCompetencies.employeeId, employeeId))
    .orderBy(desc(employeeCompetencies.evaluatedAt));
}

// ============================================================================
// CICLOS DE AVALIAÃ‡ÃƒO
// ============================================================================

export async function getActiveCycle() {
  const db = await getDb();
  if (!db) return undefined;

  const now = new Date();
  const result = await db
    .select()
    .from(evaluationCycles)
    .where(
      and(
        eq(evaluationCycles.status, "em_andamento"),
        lte(evaluationCycles.startDate, now),
        gte(evaluationCycles.endDate, now)
      )
    )
    .limit(1);

  return result.length > 0 ? result[0] : undefined;
}

export async function getAllCycles() {
  const db = await getDb();
  if (!db) return [];

  return await db
    .select()
    .from(evaluationCycles)
    .orderBy(desc(evaluationCycles.year), desc(evaluationCycles.startDate));
}

// ============================================================================
// DEPARTAMENTOS E CARGOS
// ============================================================================

export async function getAllDepartments() {
  const db = await getDb();
  if (!db) return [];

  return await db
    .select()
    .from(departments)
    .where(eq(departments.active, true))
    .orderBy(departments.name);
}

export async function getAllPositions() {
  const db = await getDb();
  if (!db) return [];

  return await db
    .select()
    .from(positions)
    .where(eq(positions.active, true))
    .orderBy(positions.title);
}

// ============================================================================
// AUDITORIA
// ============================================================================

export async function logAudit(
  userId: number | undefined,
  action: string,
  entity: string,
  entityId: number | undefined,
  changes: any,
  ipAddress?: string,
  userAgent?: string
) {
  const db = await getDb();
  if (!db) return;

  try {
    await db.insert(auditLogs).values({
      userId: userId || null,
      action,
      entity,
      entityId: entityId || null,
      changes: JSON.stringify(changes),
      ipAddress: ipAddress || null,
      userAgent: userAgent || null,
    });
  } catch (error) {
    console.error("[Database] Failed to log audit:", error);
  }
}

// ============================================================================
// DASHBOARD - ESTATÃSTICAS
// ============================================================================

export async function getDashboardStats(employeeId: number, cycleId?: number) {
  const db = await getDb();
  if (!db) return null;

  const cycle = cycleId ? await db.select().from(evaluationCycles).where(eq(evaluationCycles.id, cycleId)).limit(1) : [];
  const activeCycle = cycle.length > 0 ? cycle[0] : await getActiveCycle();

  if (!activeCycle) return null;

  // Contar metas
  const goalsCount = await db
    .select({ count: sql<number>`count(*)` })
    .from(goals)
    .where(and(eq(goals.employeeId, employeeId), eq(goals.cycleId, activeCycle.id)));

  // Contar PDIs
  const pdisCount = await db
    .select({ count: sql<number>`count(*)` })
    .from(pdiPlans)
    .where(and(eq(pdiPlans.employeeId, employeeId), eq(pdiPlans.cycleId, activeCycle.id)));

  // Contar avaliaÃ§Ãµes
  const evaluationsCount = await db
    .select({ count: sql<number>`count(*)` })
    .from(performanceEvaluations)
    .where(and(eq(performanceEvaluations.employeeId, employeeId), eq(performanceEvaluations.cycleId, activeCycle.id)));

  return {
    cycle: activeCycle,
    goalsCount: goalsCount[0]?.count || 0,
    pdisCount: pdisCount[0]?.count || 0,
    evaluationsCount: evaluationsCount[0]?.count || 0,
  };
}

/**
 * Buscar employee vinculado a um usuÃ¡rio
 */
export async function getUserEmployee(userId: number) {
  const db = await getDb();
  if (!db) return undefined;

  const result = await db
    .select()
    .from(employees)
    .where(eq(employees.userId, userId))
    .limit(1);

  return result.length > 0 ? result[0] : undefined;
}


========================================
ARQUIVO: ./server/email-service-v2.ts
========================================
/**
 * Email Service V2 - Sistema AVD UISA
 * 
 * ServiÃ§o completo de envio de e-mails usando Gmail SMTP
 * com retry automÃ¡tico, templates HTML e sistema de fila.
 * 
 * @version 2.0
 * @author Manus AI
 */

import nodemailer from 'nodemailer';
import type { Transporter } from 'nodemailer';

// ============================================
// TIPOS E INTERFACES
// ============================================

export interface EmailConfig {
  host: string;
  port: number;
  secure: boolean;
  auth: {
    user: string;
    pass: string;
  };
}

export interface EmailOptions {
  to: string | string[];
  subject: string;
  html: string;
  cc?: string | string[];
  bcc?: string | string[];
  attachments?: Array<{
    filename: string;
    path?: string;
    content?: string | Buffer;
  }>;
}

export interface EmailResult {
  success: boolean;
  messageId?: string;
  error?: string;
  attempts: number;
  deliveryTime: number;
}

export interface EmailMetrics {
  type: string;
  to: string;
  success: boolean;
  deliveryTime: number;
  messageId?: string;
  error?: string;
  sentAt: Date;
}

// ============================================
// CONFIGURAÃ‡ÃƒO DO GMAIL SMTP
// ============================================

const GMAIL_CONFIG: EmailConfig = {
  host: 'smtp.gmail.com',
  port: 587,
  secure: false, // true para porta 465, false para outras portas
  auth: {
    user: 'avd@uisa.com.br',
    pass: process.env.GMAIL_APP_PASSWORD || 'C8HNBnv@Wfjznqo6CKSzw^'
  }
};

// ConfiguraÃ§Ãµes de retry
const MAX_RETRIES = 3;
const RETRY_DELAY = 2000; // 2 segundos
const RETRY_BACKOFF = 2; // Multiplicador exponencial

// ============================================
// CLASSE PRINCIPAL: EmailService
// ============================================

export class EmailService {
  private transporter: Transporter;
  private metrics: EmailMetrics[] = [];
  private failedQueue: EmailOptions[] = [];

  constructor(config?: EmailConfig) {
    const emailConfig = config || GMAIL_CONFIG;
    
    // Validar configuraÃ§Ã£o
    if (!emailConfig.auth.pass || emailConfig.auth.pass === '') {
      throw new Error('GMAIL_APP_PASSWORD nÃ£o configurado');
    }

    // Criar transporter
    this.transporter = nodemailer.createTransport(emailConfig);
  }

  /**
   * Verifica se o serviÃ§o de e-mail estÃ¡ funcionando
   */
  async verify(): Promise<boolean> {
    try {
      await this.transporter.verify();
      console.log('âœ… ServiÃ§o de e-mail verificado com sucesso');
      return true;
    } catch (error) {
      console.error('âŒ Erro ao verificar serviÃ§o de e-mail:', error);
      return false;
    }
  }

  /**
   * Envia um e-mail com retry automÃ¡tico
   */
  async sendEmail(options: EmailOptions, type: string = 'general'): Promise<EmailResult> {
    const startTime = Date.now();
    let lastError: Error | null = null;

    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
      try {
        const info = await this.transporter.sendMail({
          from: `"AVD UISA" <${GMAIL_CONFIG.auth.user}>`,
          to: options.to,
          cc: options.cc,
          bcc: options.bcc,
          subject: options.subject,
          html: options.html,
          attachments: options.attachments
        });

        const deliveryTime = Date.now() - startTime;

        // Registrar mÃ©trica de sucesso
        this.recordMetric({
          type,
          to: Array.isArray(options.to) ? options.to.join(', ') : options.to,
          success: true,
          deliveryTime,
          messageId: info.messageId,
          sentAt: new Date()
        });

        console.log(`âœ… E-mail enviado com sucesso: ${info.messageId}`);

        return {
          success: true,
          messageId: info.messageId,
          attempts: attempt,
          deliveryTime
        };

      } catch (error) {
        lastError = error as Error;
        console.error(`âŒ Tentativa ${attempt}/${MAX_RETRIES} falhou:`, error);

        // Se nÃ£o for a Ãºltima tentativa, aguardar antes de tentar novamente
        if (attempt < MAX_RETRIES) {
          const delay = RETRY_DELAY * Math.pow(RETRY_BACKOFF, attempt - 1);
          console.log(`â³ Aguardando ${delay}ms antes da prÃ³xima tentativa...`);
          await this.sleep(delay);
        }
      }
    }

    // Todas as tentativas falharam
    const deliveryTime = Date.now() - startTime;

    // Registrar mÃ©trica de falha
    this.recordMetric({
      type,
      to: Array.isArray(options.to) ? options.to.join(', ') : options.to,
      success: false,
      deliveryTime,
      error: lastError?.message,
      sentAt: new Date()
    });

    // Adicionar Ã  fila de falhas
    this.failedQueue.push(options);

    return {
      success: false,
      error: lastError?.message || 'Erro desconhecido',
      attempts: MAX_RETRIES,
      deliveryTime
    };
  }

  /**
   * Envia mÃºltiplos e-mails em lote
   */
  async sendBatch(emails: Array<{ options: EmailOptions; type: string }>): Promise<EmailResult[]> {
    const results: EmailResult[] = [];

    for (const email of emails) {
      const result = await this.sendEmail(email.options, email.type);
      results.push(result);
      
      // Pequeno delay entre e-mails para evitar rate limiting
      await this.sleep(100);
    }

    return results;
  }

  /**
   * Reprocessa e-mails que falharam
   */
  async retryFailed(): Promise<EmailResult[]> {
    const results: EmailResult[] = [];
    const failedCopy = [...this.failedQueue];
    this.failedQueue = [];

    for (const options of failedCopy) {
      const result = await this.sendEmail(options, 'retry');
      results.push(result);
    }

    return results;
  }

  /**
   * Registra mÃ©trica de envio
   */
  private recordMetric(metric: EmailMetrics): void {
    this.metrics.push(metric);

    // Limitar tamanho do array de mÃ©tricas (Ãºltimas 1000)
    if (this.metrics.length > 1000) {
      this.metrics = this.metrics.slice(-1000);
    }
  }

  /**
   * Retorna mÃ©tricas de envio
   */
  getMetrics(): EmailMetrics[] {
    return this.metrics;
  }

  /**
   * Retorna estatÃ­sticas de envio
   */
  getStats() {
    const total = this.metrics.length;
    const successful = this.metrics.filter(m => m.success).length;
    const failed = total - successful;
    const avgDeliveryTime = total > 0
      ? this.metrics.reduce((sum, m) => sum + m.deliveryTime, 0) / total
      : 0;

    return {
      total,
      successful,
      failed,
      successRate: total > 0 ? (successful / total) * 100 : 0,
      avgDeliveryTime: Math.round(avgDeliveryTime),
      failedQueueSize: this.failedQueue.length
    };
  }

  /**
   * Limpa fila de e-mails falhados
   */
  clearFailedQueue(): void {
    this.failedQueue = [];
  }

  /**
   * Helper: Sleep
   */
  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// ============================================
// TEMPLATES DE E-MAIL
// ============================================

/**
 * Template base para e-mails
 */
function getBaseTemplate(content: string): string {
  return `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AVD UISA</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 20px auto;
      background-color: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      padding: 30px 20px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    .content {
      padding: 30px 20px;
    }
    .button {
      display: inline-block;
      padding: 12px 30px;
      background-color: #667eea;
      color: #ffffff;
      text-decoration: none;
      border-radius: 5px;
      margin: 20px 0;
      font-weight: 600;
    }
    .button:hover {
      background-color: #5568d3;
    }
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .alert-warning {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      color: #856404;
    }
    .alert-success {
      background-color: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
    }
    .alert-danger {
      background-color: #f8d7da;
      border-left: 4px solid #dc3545;
      color: #721c24;
    }
    .footer {
      background-color: #f8f9fa;
      padding: 20px;
      text-align: center;
      font-size: 12px;
      color: #6c757d;
    }
    .footer a {
      color: #667eea;
      text-decoration: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸŽ¯ AVD UISA</h1>
      <p style="margin: 5px 0 0 0; opacity: 0.9;">Sistema de AvaliaÃ§Ã£o de Desempenho</p>
    </div>
    <div class="content">
      ${content}
    </div>
    <div class="footer">
      <p>Este Ã© um e-mail automÃ¡tico do Sistema AVD UISA.</p>
      <p>NÃ£o responda este e-mail. Em caso de dÃºvidas, acesse o <a href="https://avd.uisa.com.br">sistema</a>.</p>
      <p style="margin-top: 15px;">Â© 2025 UISA - Todos os direitos reservados</p>
    </div>
  </div>
</body>
</html>
  `.trim();
}

/**
 * Template: AÃ§Ã£o de PDI Vencida
 */
export function getPDIActionOverdueTemplate(data: {
  employeeName: string;
  actionTitle: string;
  actionDescription: string;
  dueDate: string;
  daysOverdue: number;
  managerName: string;
  pdiUrl: string;
}): string {
  const content = `
    <h2>âš ï¸ AÃ§Ã£o de PDI Vencida</h2>
    
    <p>OlÃ¡ <strong>${data.employeeName}</strong>,</p>
    
    <div class="alert alert-warning">
      <strong>AtenÃ§Ã£o!</strong> Uma aÃ§Ã£o do seu Plano de Desenvolvimento Individual (PDI) estÃ¡ vencida.
    </div>
    
    <h3>Detalhes da AÃ§Ã£o:</h3>
    
    <table>
      <tr>
        <th>AÃ§Ã£o</th>
        <td>${data.actionTitle}</td>
      </tr>
      <tr>
        <th>DescriÃ§Ã£o</th>
        <td>${data.actionDescription}</td>
      </tr>
      <tr>
        <th>Data de Vencimento</th>
        <td>${data.dueDate}</td>
      </tr>
      <tr>
        <th>Dias em Atraso</th>
        <td><strong style="color: #dc3545;">${data.daysOverdue} dia(s)</strong></td>
      </tr>
      <tr>
        <th>Seu Gestor</th>
        <td>${data.managerName}</td>
      </tr>
    </table>
    
    <p><strong>O que fazer agora?</strong></p>
    <ul>
      <li>Acesse seu PDI e atualize o status da aÃ§Ã£o</li>
      <li>Se a aÃ§Ã£o foi concluÃ­da, marque como "ConcluÃ­da"</li>
      <li>Se ainda estÃ¡ em andamento, atualize o progresso</li>
      <li>Se houver dificuldades, converse com seu gestor</li>
    </ul>
    
    <div style="text-align: center;">
      <a href="${data.pdiUrl}" class="button">Acessar Meu PDI</a>
    </div>
    
    <p style="margin-top: 30px; font-size: 14px; color: #6c757d;">
      <em>Lembre-se: O PDI Ã© uma ferramenta importante para o seu desenvolvimento profissional. 
      Mantenha-o sempre atualizado!</em>
    </p>
  `;

  return getBaseTemplate(content);
}

/**
 * Template: Bem-vindo ao Sistema
 */
export function getWelcomeTemplate(data: {
  userName: string;
  email: string;
  temporaryPassword: string;
  loginUrl: string;
}): string {
  const content = `
    <h2>ðŸŽ‰ Bem-vindo ao Sistema AVD UISA!</h2>
    
    <p>OlÃ¡ <strong>${data.userName}</strong>,</p>
    
    <p>Sua conta foi criada com sucesso no Sistema de AvaliaÃ§Ã£o de Desempenho da UISA.</p>
    
    <div class="alert alert-success">
      <strong>Acesso liberado!</strong> Use as credenciais abaixo para fazer seu primeiro login.
    </div>
    
    <h3>Suas Credenciais:</h3>
    
    <table>
      <tr>
        <th>E-mail</th>
        <td>${data.email}</td>
      </tr>
      <tr>
        <th>Senha TemporÃ¡ria</th>
        <td><code style="background: #f8f9fa; padding: 5px 10px; border-radius: 3px;">${data.temporaryPassword}</code></td>
      </tr>
    </table>
    
    <div class="alert alert-warning">
      <strong>Importante:</strong> Por seguranÃ§a, vocÃª serÃ¡ solicitado a alterar sua senha no primeiro login.
    </div>
    
    <div style="text-align: center;">
      <a href="${data.loginUrl}" class="button">Fazer Login</a>
    </div>
    
    <p style="margin-top: 30px;"><strong>O que vocÃª pode fazer no sistema:</strong></p>
    <ul>
      <li>ðŸ“Š Visualizar e gerenciar suas metas</li>
      <li>ðŸ“ Participar de avaliaÃ§Ãµes 360Â°</li>
      <li>ðŸŽ¯ Criar e acompanhar seu PDI</li>
      <li>ðŸ“ˆ Acompanhar seu desempenho</li>
      <li>ðŸ’¬ Receber e dar feedbacks</li>
    </ul>
  `;

  return getBaseTemplate(content);
}

// ============================================
// FUNÃ‡Ã•ES AUXILIARES
// ============================================

/**
 * Cria instÃ¢ncia singleton do EmailService
 */
let emailServiceInstance: EmailService | null = null;

export function getEmailService(): EmailService {
  if (!emailServiceInstance) {
    emailServiceInstance = new EmailService();
  }
  return emailServiceInstance;
}

/**
 * Envia e-mail de aÃ§Ã£o de PDI vencida
 */
export async function sendPDIActionOverdueEmail(data: {
  employeeEmail: string;
  employeeName: string;
  actionTitle: string;
  actionDescription: string;
  dueDate: string;
  daysOverdue: number;
  managerName: string;
  managerEmail: string;
  pdiUrl: string;
}): Promise<EmailResult> {
  const emailService = getEmailService();

  const html = getPDIActionOverdueTemplate({
    employeeName: data.employeeName,
    actionTitle: data.actionTitle,
    actionDescription: data.actionDescription,
    dueDate: data.dueDate,
    daysOverdue: data.daysOverdue,
    managerName: data.managerName,
    pdiUrl: data.pdiUrl
  });

  return await emailService.sendEmail(
    {
      to: data.employeeEmail,
      cc: data.managerEmail, // CÃ³pia para o gestor
      subject: `âš ï¸ AÃ§Ã£o de PDI Vencida: ${data.actionTitle}`,
      html
    },
    'pdi_action_overdue'
  );
}

// ============================================
// EXPORTAÃ‡Ã•ES
// ============================================

export default EmailService;


========================================
ARQUIVO: ./server/emailService.ts
========================================
/**
 * ServiÃ§o de Envio de E-mail
 * IntegraÃ§Ã£o com SMTP para envio de notificaÃ§Ãµes do sistema
 */

import nodemailer from 'nodemailer';
import type { Transporter } from 'nodemailer';

interface EmailOptions {
  to: string;
  subject: string;
  html: string;
  from?: string;
}

/**
 * Cria transporter SMTP baseado nas configuraÃ§Ãµes do sistema
 */
async function createTransporter(): Promise<Transporter | null> {
  try {
    // Buscar configuraÃ§Ãµes SMTP do banco de dados
    const { getDb } = await import('./db');
    const { systemSettings } = await import('../drizzle/schema');
    const { eq } = await import('drizzle-orm');
    
    const database = await getDb();
    if (!database) {
      console.warn('[Email] Database not available');
      return null;
    }

    const settings = await database
      .select()
      .from(systemSettings)
      .where(eq(systemSettings.settingKey, 'smtp_config'))
      .limit(1);

    if (settings.length === 0) {
      console.warn('[Email] SMTP not configured');
      return null;
    }

    const smtpConfig = JSON.parse(settings[0].settingValue || '{}');

    // Validar configuraÃ§Ã£o mÃ­nima
    if (!smtpConfig.host || !smtpConfig.port || !smtpConfig.user || !smtpConfig.password) {
      console.warn('[Email] Incomplete SMTP configuration');
      return null;
    }

    // Criar transporter
    const transporter = nodemailer.createTransport({
      host: smtpConfig.host,
      port: parseInt(smtpConfig.port),
      secure: smtpConfig.secure !== false, // true para 465, false para outros
      auth: {
        user: smtpConfig.user,
        pass: smtpConfig.password,
      },
      tls: {
        rejectUnauthorized: smtpConfig.rejectUnauthorized !== false,
      },
    });

    // Verificar conexÃ£o
    await transporter.verify();
    console.log('[Email] SMTP connection verified');

    return transporter;
  } catch (error) {
    console.error('[Email] Failed to create transporter:', error);
    return null;
  }
}

/**
 * Envia e-mail usando configuraÃ§Ã£o SMTP do sistema
 */
export async function sendEmail(options: EmailOptions): Promise<boolean> {
  try {
    const transporter = await createTransporter();
    if (!transporter) {
      console.warn('[Email] Transporter not available, email not sent');
      return false;
    }

    const mailOptions = {
      from: options.from || '"Sistema AVD UISA" <noreply@uisa.com.br>',
      to: options.to,
      subject: options.subject,
      html: options.html,
    };

    const info = await transporter.sendMail(mailOptions);
    console.log('[Email] Message sent:', info.messageId);

    return true;
  } catch (error) {
    console.error('[Email] Failed to send email:', error);
    return false;
  }
}

/**
 * Envia e-mail de teste para validar configuraÃ§Ã£o SMTP
 */
export async function sendTestEmail(recipientEmail: string): Promise<{ success: boolean; message: string }> {
  try {
    const testHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }
    .content { background: #ffffff; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; }
    .success { background: #d1fae5; border-left: 4px solid #10b981; padding: 16px; margin: 20px 0; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸŽ¯ Sistema AVD UISA</h1>
    </div>
    <div class="content">
      <h2>âœ… E-mail de Teste</h2>
      <div class="success">
        <p><strong>ParabÃ©ns!</strong> A configuraÃ§Ã£o SMTP estÃ¡ funcionando corretamente.</p>
      </div>
      <p>Este Ã© um e-mail de teste enviado pelo Sistema AVD UISA para validar a configuraÃ§Ã£o de envio de e-mails.</p>
      <p><strong>Data/Hora:</strong> ${new Date().toLocaleString('pt-BR')}</p>
      <p><strong>DestinatÃ¡rio:</strong> ${recipientEmail}</p>
      <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
      <p style="font-size: 14px; color: #6b7280;">
        Se vocÃª recebeu este e-mail, significa que o sistema estÃ¡ pronto para enviar notificaÃ§Ãµes automÃ¡ticas.
      </p>
    </div>
  </div>
</body>
</html>
    `.trim();

    const success = await sendEmail({
      to: recipientEmail,
      subject: 'âœ… Teste de ConfiguraÃ§Ã£o SMTP - Sistema AVD UISA',
      html: testHtml,
    });

    if (success) {
      return {
        success: true,
        message: `E-mail de teste enviado com sucesso para ${recipientEmail}`,
      };
    } else {
      return {
        success: false,
        message: 'Falha ao enviar e-mail. Verifique as configuraÃ§Ãµes SMTP.',
      };
    }
  } catch (error) {
    return {
      success: false,
      message: `Erro ao enviar e-mail: ${error instanceof Error ? error.message : 'Erro desconhecido'}`,
    };
  }
}

/**
 * Envia e-mail usando template especÃ­fico
 */
export async function sendTemplateEmail(
  recipientEmail: string,
  template: { subject: string; html: string }
): Promise<boolean> {
  return sendEmail({
    to: recipientEmail,
    subject: template.subject,
    html: template.html,
  });
}


========================================
ARQUIVO: ./server/emailTemplates.ts
========================================
/**
 * Templates de E-mail para Sistema AVD UISA
 * Fornece templates HTML profissionais para notificaÃ§Ãµes do sistema
 */

export interface EmailTemplateData {
  recipientName: string;
  [key: string]: any;
}

/**
 * Template base com layout responsivo e branding UISA
 */
function baseTemplate(title: string, content: string): string {
  return `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background-color: #ffffff;
    }
    .header {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      padding: 40px 30px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      color: #ffffff;
      font-size: 28px;
      font-weight: 700;
    }
    .content {
      padding: 40px 30px;
    }
    .content h2 {
      color: #1f2937;
      font-size: 24px;
      margin-top: 0;
      margin-bottom: 20px;
    }
    .content p {
      color: #4b5563;
      font-size: 16px;
      line-height: 1.6;
      margin: 0 0 16px 0;
    }
    .button {
      display: inline-block;
      padding: 14px 32px;
      background-color: #f97316;
      color: #ffffff !important;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      margin: 20px 0;
      transition: background-color 0.2s;
    }
    .button:hover {
      background-color: #ea580c;
    }
    .info-box {
      background-color: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 16px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .success-box {
      background-color: #d1fae5;
      border-left: 4px solid: #10b981;
      padding: 16px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .footer {
      background-color: #f9fafb;
      padding: 30px;
      text-align: center;
      border-top: 1px solid #e5e7eb;
    }
    .footer p {
      color: #6b7280;
      font-size: 14px;
      margin: 8px 0;
    }
    .divider {
      height: 1px;
      background-color: #e5e7eb;
      margin: 30px 0;
    }
    @media only screen and (max-width: 600px) {
      .content {
        padding: 30px 20px;
      }
      .header {
        padding: 30px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸŽ¯ Sistema AVD UISA</h1>
    </div>
    <div class="content">
      ${content}
    </div>
    <div class="footer">
      <p><strong>Sistema AVD UISA</strong></p>
      <p>AvaliaÃ§Ã£o de Desempenho e Desenvolvimento Profissional</p>
      <p style="color: #9ca3af; font-size: 12px; margin-top: 16px;">
        Este Ã© um e-mail automÃ¡tico. Por favor, nÃ£o responda.
      </p>
    </div>
  </div>
</body>
</html>
  `.trim();
}

/**
 * Template: Nova Meta AtribuÃ­da
 */
export function newGoalTemplate(data: {
  recipientName: string;
  goalTitle: string;
  goalDescription: string;
  deadline: string;
  assignedBy: string;
  dashboardUrl: string;
}): { subject: string; html: string } {
  const content = `
    <h2>ðŸ‘‹ OlÃ¡, ${data.recipientName}!</h2>
    <p>Uma nova meta foi atribuÃ­da a vocÃª:</p>
    
    <div class="info-box">
      <h3 style="margin-top: 0; color: #92400e;">${data.goalTitle}</h3>
      <p style="color: #78350f; margin-bottom: 0;">${data.goalDescription}</p>
    </div>
    
    <p><strong>Prazo:</strong> ${data.deadline}</p>
    <p><strong>AtribuÃ­da por:</strong> ${data.assignedBy}</p>
    
    <p>Acesse o sistema para visualizar os detalhes completos e comeÃ§ar a trabalhar nesta meta.</p>
    
    <a href="${data.dashboardUrl}" class="button">Acessar Minha Meta</a>
    
    <div class="divider"></div>
    
    <p style="font-size: 14px; color: #6b7280;">
      ðŸ’¡ <strong>Dica:</strong> Defina marcos intermediÃ¡rios para acompanhar seu progresso e mantenha evidÃªncias do seu trabalho.
    </p>
  `;

  return {
    subject: `ðŸŽ¯ Nova Meta: ${data.goalTitle}`,
    html: baseTemplate("Nova Meta AtribuÃ­da", content),
  };
}

/**
 * Template: Resultado de AvaliaÃ§Ã£o de Performance
 */
export function performanceResultTemplate(data: {
  recipientName: string;
  evaluationPeriod: string;
  overallScore: number;
  performanceLevel: string;
  strengths: string[];
  improvements: string[];
  evaluatorName: string;
  dashboardUrl: string;
}): { subject: string; html: string } {
  const strengthsList = data.strengths.map(s => `<li>${s}</li>`).join('');
  const improvementsList = data.improvements.map(i => `<li>${i}</li>`).join('');

  const content = `
    <h2>ðŸ‘‹ OlÃ¡, ${data.recipientName}!</h2>
    <p>Sua avaliaÃ§Ã£o de desempenho referente ao perÃ­odo <strong>${data.evaluationPeriod}</strong> foi concluÃ­da.</p>
    
    <div class="success-box">
      <h3 style="margin-top: 0; color: #065f46;">Resultado Geral</h3>
      <p style="font-size: 32px; font-weight: 700; color: #059669; margin: 10px 0;">
        ${data.overallScore}/100
      </p>
      <p style="color: #047857; margin-bottom: 0;">
        <strong>NÃ­vel de Performance:</strong> ${data.performanceLevel}
      </p>
    </div>
    
    <h3 style="color: #059669;">âœ… Pontos Fortes</h3>
    <ul style="color: #4b5563; line-height: 1.8;">
      ${strengthsList}
    </ul>
    
    <h3 style="color: #f59e0b;">ðŸ“ˆ Oportunidades de Melhoria</h3>
    <ul style="color: #4b5563; line-height: 1.8;">
      ${improvementsList}
    </ul>
    
    <p><strong>Avaliado por:</strong> ${data.evaluatorName}</p>
    
    <p>Acesse o sistema para visualizar o feedback completo e discutir seu Plano de Desenvolvimento Individual (PDI).</p>
    
    <a href="${data.dashboardUrl}" class="button">Ver AvaliaÃ§Ã£o Completa</a>
    
    <div class="divider"></div>
    
    <p style="font-size: 14px; color: #6b7280;">
      ðŸ’¡ <strong>PrÃ³ximos Passos:</strong> Agende uma reuniÃ£o com seu gestor para discutir seu PDI e definir aÃ§Ãµes de desenvolvimento.
    </p>
  `;

  return {
    subject: `ðŸ“Š Resultado da AvaliaÃ§Ã£o de Desempenho - ${data.evaluationPeriod}`,
    html: baseTemplate("Resultado de AvaliaÃ§Ã£o", content),
  };
}

/**
 * Template: Lembrete de Meta PrÃ³xima do Prazo
 */
export function goalDeadlineReminderTemplate(data: {
  recipientName: string;
  goalTitle: string;
  deadline: string;
  daysRemaining: number;
  currentProgress: number;
  dashboardUrl: string;
}): { subject: string; html: string } {
  const urgencyClass = data.daysRemaining <= 3 ? 'info-box' : 'info-box';
  
  const content = `
    <h2>ðŸ‘‹ OlÃ¡, ${data.recipientName}!</h2>
    <p>Este Ã© um lembrete sobre a meta que estÃ¡ prÃ³xima do prazo:</p>
    
    <div class="${urgencyClass}">
      <h3 style="margin-top: 0;">${data.goalTitle}</h3>
      <p><strong>Prazo:</strong> ${data.deadline}</p>
      <p><strong>Tempo restante:</strong> ${data.daysRemaining} ${data.daysRemaining === 1 ? 'dia' : 'dias'}</p>
      <p><strong>Progresso atual:</strong> ${data.currentProgress}%</p>
    </div>
    
    <p>Certifique-se de concluir todas as atividades e adicionar evidÃªncias antes do prazo final.</p>
    
    <a href="${data.dashboardUrl}" class="button">Atualizar Progresso</a>
  `;

  return {
    subject: `â° Lembrete: Meta "${data.goalTitle}" - ${data.daysRemaining} ${data.daysRemaining === 1 ? 'dia' : 'dias'} restantes`,
    html: baseTemplate("Lembrete de Meta", content),
  };
}

/**
 * Template: PDI Criado
 */
export function pdiCreatedTemplate(data: {
  recipientName: string;
  pdiTitle: string;
  targetPosition: string;
  duration: string;
  actionsCount: number;
  dashboardUrl: string;
}): { subject: string; html: string } {
  const content = `
    <h2>ðŸ‘‹ OlÃ¡, ${data.recipientName}!</h2>
    <p>Seu Plano de Desenvolvimento Individual (PDI) foi criado com sucesso!</p>
    
    <div class="success-box">
      <h3 style="margin-top: 0; color: #065f46;">${data.pdiTitle}</h3>
      <p style="color: #047857;"><strong>PosiÃ§Ã£o-alvo:</strong> ${data.targetPosition}</p>
      <p style="color: #047857;"><strong>DuraÃ§Ã£o:</strong> ${data.duration}</p>
      <p style="color: #047857; margin-bottom: 0;"><strong>AÃ§Ãµes de desenvolvimento:</strong> ${data.actionsCount}</p>
    </div>
    
    <p>Seu PDI contÃ©m aÃ§Ãµes estruturadas seguindo o modelo 70-20-10 para acelerar seu desenvolvimento profissional.</p>
    
    <a href="${data.dashboardUrl}" class="button">Acessar Meu PDI</a>
    
    <div class="divider"></div>
    
    <p style="font-size: 14px; color: #6b7280;">
      ðŸ’¡ <strong>Lembre-se:</strong> O desenvolvimento Ã© uma jornada contÃ­nua. Revise seu PDI regularmente e celebre cada conquista!
    </p>
  `;

  return {
    subject: `ðŸš€ Seu PDI foi criado: ${data.pdiTitle}`,
    html: baseTemplate("PDI Criado", content),
  };
}


========================================
ARQUIVO: ./server/evaluation360Router.ts
========================================
import { TRPCError } from "@trpc/server";
import { eq, and, sql } from "drizzle-orm";
import { z } from "zod";
import {
  performanceEvaluations,
  evaluationResponses,
  employees,
} from "../drizzle/schema";
import { getDb } from "./db";
import { protectedProcedure, router } from "./_core/trpc";
import { sendEmail } from "./emailService";

/**
 * Router de AvaliaÃ§Ã£o 360Â° com Fluxo Sequencial
 * Etapas: AutoavaliaÃ§Ã£o â†’ AvaliaÃ§Ã£o Gestor â†’ Consenso LÃ­der
 */

export const evaluation360Router = router({
  /**
   * Submeter autoavaliaÃ§Ã£o (Etapa 1)
   */
  submitSelfAssessment: protectedProcedure
    .input(
      z.object({
        evaluationId: z.number(),
        responses: z.array(
          z.object({
            questionId: z.number(),
            score: z.number().min(1).max(5),
            comment: z.string().optional(),
          })
        ),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Buscar avaliaÃ§Ã£o
      const evaluation = await db
        .select()
        .from(performanceEvaluations)
        .where(eq(performanceEvaluations.id, input.evaluationId))
        .limit(1);

      if (evaluation.length === 0) {
        throw new TRPCError({ code: "NOT_FOUND", message: "AvaliaÃ§Ã£o nÃ£o encontrada" });
      }

      const eval360 = evaluation[0];

      // Verificar se estÃ¡ na etapa correta
      if (eval360.workflowStatus !== "pending_self") {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "Esta avaliaÃ§Ã£o nÃ£o estÃ¡ aguardando autoavaliaÃ§Ã£o",
        });
      }

      // Verificar se o usuÃ¡rio Ã© o colaborador sendo avaliado
      if (eval360.employeeId !== ctx.user.id) {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "VocÃª nÃ£o tem permissÃ£o para fazer esta autoavaliaÃ§Ã£o",
        });
      }

      // Salvar respostas
      for (const response of input.responses) {
        await db.insert(evaluationResponses).values({
          evaluationId: input.evaluationId,
          questionId: response.questionId,
          evaluatorId: ctx.user.id,
          evaluatorType: "self",
          score: response.score,
          textResponse: response.comment,
        });
      }

      // Atualizar status da avaliaÃ§Ã£o
      await db
        .update(performanceEvaluations)
        .set({
          selfEvaluationCompleted: true,
          selfCompletedAt: new Date(),
          workflowStatus: "pending_manager",
          updatedAt: new Date(),
        })
        .where(eq(performanceEvaluations.id, input.evaluationId));

      // Buscar gestor para enviar email
      const employeeData = await db
        .select()
        .from(employees)
        .where(eq(employees.id, eval360.employeeId))
        .limit(1);

      if (employeeData.length === 0) {
        throw new TRPCError({ code: "NOT_FOUND", message: "Colaborador nÃ£o encontrado" });
      }

      const employee = employeeData[0];
      let managerData = null;
      if (employee.managerId) {
        const managers = await db
          .select()
          .from(employees)
          .where(eq(employees.id, employee.managerId))
          .limit(1);
        if (managers.length > 0) {
          managerData = managers[0];
        }
      }

      if (managerData && managerData.email) {
        // Enviar email para o gestor
        await sendEmail({
          to: managerData.email,
          subject: `AvaliaÃ§Ã£o 360Â° - Aguardando sua avaliaÃ§Ã£o de ${employee.name}`,
          html: `
            <h2>AvaliaÃ§Ã£o 360Â° - PrÃ³xima Etapa</h2>
            <p>OlÃ¡ ${managerData.name},</p>
            <p>A autoavaliaÃ§Ã£o de <strong>${employee.name}</strong> foi concluÃ­da.</p>
            <p>Agora Ã© sua vez de avaliar o colaborador.</p>
            <p><a href="${process.env.VITE_OAUTH_PORTAL_URL}/avaliacoes/gestor/${input.evaluationId}">Clique aqui para fazer a avaliaÃ§Ã£o</a></p>
          `,
        });
      }

      return { success: true, nextStep: "pending_manager" };
    }),

  /**
   * Submeter avaliaÃ§Ã£o do gestor (Etapa 2)
   */
  submitManagerAssessment: protectedProcedure
    .input(
      z.object({
        evaluationId: z.number(),
        responses: z.array(
          z.object({
            questionId: z.number(),
            score: z.number().min(1).max(5),
            comment: z.string().optional(),
          })
        ),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Buscar avaliaÃ§Ã£o
      const evaluation = await db
        .select()
        .from(performanceEvaluations)
        .where(eq(performanceEvaluations.id, input.evaluationId))
        .limit(1);

      if (evaluation.length === 0) {
        throw new TRPCError({ code: "NOT_FOUND", message: "AvaliaÃ§Ã£o nÃ£o encontrada" });
      }

      const eval360 = evaluation[0];

      // Verificar se estÃ¡ na etapa correta
      if (eval360.workflowStatus !== "pending_manager") {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "Esta avaliaÃ§Ã£o nÃ£o estÃ¡ aguardando avaliaÃ§Ã£o do gestor",
        });
      }

      // Buscar colaborador para verificar se o usuÃ¡rio Ã© o gestor
      const employee = await db
        .select()
        .from(employees)
        .where(eq(employees.id, eval360.employeeId))
        .limit(1);

      if (employee.length === 0 || employee[0].managerId !== ctx.user.id) {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "VocÃª nÃ£o Ã© o gestor deste colaborador",
        });
      }

      // Salvar respostas
      for (const response of input.responses) {
        await db.insert(evaluationResponses).values({
          evaluationId: input.evaluationId,
          questionId: response.questionId,
          evaluatorId: ctx.user.id,
          evaluatorType: "manager",
          score: response.score,
          textResponse: response.comment,
        });
      }

      // Atualizar status da avaliaÃ§Ã£o
      await db
        .update(performanceEvaluations)
        .set({
          managerEvaluationCompleted: true,
          managerCompletedAt: new Date(),
          workflowStatus: "pending_consensus",
          updatedAt: new Date(),
        })
        .where(eq(performanceEvaluations.id, input.evaluationId));

      // Buscar lÃ­der (gestor do gestor) para enviar email
      const managerData = await db
        .select()
        .from(employees)
        .where(eq(employees.id, ctx.user.id))
        .limit(1);

      if (managerData.length > 0 && managerData[0].managerId) {
        const leaders = await db
          .select()
          .from(employees)
          .where(eq(employees.id, managerData[0].managerId))
          .limit(1);

        if (leaders.length > 0 && leaders[0].email) {
          // Enviar email para o lÃ­der
          await sendEmail({
            to: leaders[0].email,
            subject: `AvaliaÃ§Ã£o 360Â° - Aguardando consenso de ${employee[0].name}`,
            html: `
              <h2>AvaliaÃ§Ã£o 360Â° - Consenso Final</h2>
              <p>OlÃ¡ ${leaders[0].name},</p>
              <p>A avaliaÃ§Ã£o do gestor de <strong>${employee[0].name}</strong> foi concluÃ­da.</p>
              <p>Agora Ã© necessÃ¡rio fazer o consenso final.</p>
              <p><a href="${process.env.VITE_OAUTH_PORTAL_URL}/avaliacoes/consenso/${input.evaluationId}">Clique aqui para fazer o consenso</a></p>
            `,
          });
        }
      }

      return { success: true, nextStep: "pending_consensus" };
    }),

  /**
   * Submeter consenso do lÃ­der (Etapa 3)
   */
  submitConsensus: protectedProcedure
    .input(
      z.object({
        evaluationId: z.number(),
        finalScore: z.number().min(0).max(100),
        consensusNotes: z.string().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Buscar avaliaÃ§Ã£o
      const evaluation = await db
        .select()
        .from(performanceEvaluations)
        .where(eq(performanceEvaluations.id, input.evaluationId))
        .limit(1);

      if (evaluation.length === 0) {
        throw new TRPCError({ code: "NOT_FOUND", message: "AvaliaÃ§Ã£o nÃ£o encontrada" });
      }

      const eval360 = evaluation[0];

      // Verificar se estÃ¡ na etapa correta
      if (eval360.workflowStatus !== "pending_consensus") {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "Esta avaliaÃ§Ã£o nÃ£o estÃ¡ aguardando consenso",
        });
      }

      // Verificar se o usuÃ¡rio Ã© lÃ­der (pode fazer consenso)
      // TODO: Implementar lÃ³gica de verificaÃ§Ã£o de permissÃ£o de lÃ­der

      // Atualizar avaliaÃ§Ã£o com nota final
      await db
        .update(performanceEvaluations)
        .set({
          finalScore: input.finalScore,
          consensusCompletedAt: new Date(),
          workflowStatus: "completed",
          status: "concluida",
          completedAt: new Date(),
          updatedAt: new Date(),
        })
        .where(eq(performanceEvaluations.id, input.evaluationId));

      // Buscar colaborador para enviar email de conclusÃ£o
      const employee = await db
        .select()
        .from(employees)
        .where(eq(employees.id, eval360.employeeId))
        .limit(1);

      if (employee.length > 0 && employee[0].email) {
        // Enviar email para o colaborador
        await sendEmail({
          to: employee[0].email,
          subject: "AvaliaÃ§Ã£o 360Â° ConcluÃ­da",
          html: `
            <h2>AvaliaÃ§Ã£o 360Â° ConcluÃ­da</h2>
            <p>OlÃ¡ ${employee[0].name},</p>
            <p>Sua avaliaÃ§Ã£o 360Â° foi concluÃ­da com sucesso.</p>
            <p>Nota final: <strong>${input.finalScore}</strong></p>
            <p><a href="${process.env.VITE_OAUTH_PORTAL_URL}/avaliacoes">Ver detalhes da avaliaÃ§Ã£o</a></p>
          `,
        });
      }

      return { success: true, nextStep: "completed" };
    }),

  /**
   * Buscar avaliaÃ§Ã£o com status do workflow
   */
  getEvaluationWithWorkflow: protectedProcedure
    .input(z.object({ evaluationId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return null;

      const evaluation = await db
        .select({
          id: performanceEvaluations.id,
          cycleId: performanceEvaluations.cycleId,
          employeeId: performanceEvaluations.employeeId,
          employeeName: employees.name,
          type: performanceEvaluations.type,
          status: performanceEvaluations.status,
          workflowStatus: performanceEvaluations.workflowStatus,
          selfEvaluationCompleted: performanceEvaluations.selfEvaluationCompleted,
          managerEvaluationCompleted: performanceEvaluations.managerEvaluationCompleted,
          selfCompletedAt: performanceEvaluations.selfCompletedAt,
          managerCompletedAt: performanceEvaluations.managerCompletedAt,
          consensusCompletedAt: performanceEvaluations.consensusCompletedAt,
          finalScore: performanceEvaluations.finalScore,
          createdAt: performanceEvaluations.createdAt,
          completedAt: performanceEvaluations.completedAt,
        })
        .from(performanceEvaluations)
        .leftJoin(employees, eq(performanceEvaluations.employeeId, employees.id))
        .where(eq(performanceEvaluations.id, input.evaluationId))
        .limit(1);

      return evaluation.length > 0 ? evaluation[0] : null;
    }),

  /**
   * Listar todas as avaliaÃ§Ãµes 360Â°
   */
  list: protectedProcedure
    .input(
      z.object({
        cycleId: z.number().optional(),
        status: z.enum(["pendente", "em_andamento", "concluida"]).optional(),
      }).optional()
    )
    .query(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) return [];

      let query = db
        .select({
          id: performanceEvaluations.id,
          cycleId: performanceEvaluations.cycleId,
          employeeId: performanceEvaluations.employeeId,
          employeeName: employees.name,
          type: performanceEvaluations.type,
          status: performanceEvaluations.status,
          workflowStatus: performanceEvaluations.workflowStatus,
          selfEvaluationCompleted: performanceEvaluations.selfEvaluationCompleted,
          managerEvaluationCompleted: performanceEvaluations.managerEvaluationCompleted,
          selfCompletedAt: performanceEvaluations.selfCompletedAt,
          managerCompletedAt: performanceEvaluations.managerCompletedAt,
          consensusCompletedAt: performanceEvaluations.consensusCompletedAt,
          finalScore: performanceEvaluations.finalScore,
          createdAt: performanceEvaluations.createdAt,
          completedAt: performanceEvaluations.completedAt,
        })
        .from(performanceEvaluations)
        .leftJoin(employees, eq(performanceEvaluations.employeeId, employees.id));

      // Aplicar filtros se fornecidos
      if (input?.cycleId) {
        query = query.where(eq(performanceEvaluations.cycleId, input.cycleId)) as any;
      }
      if (input?.status) {
        query = query.where(eq(performanceEvaluations.status, input.status)) as any;
      }

      const evaluations = await query;
      return evaluations;
    }),

  /**
   * Buscar perguntas da avaliaÃ§Ã£o
   */
  getQuestions: protectedProcedure
    .input(z.object({ evaluationId: z.number() }))
    .query(async ({ input }) => {
      // Retornar perguntas padrÃ£o (podem ser movidas para o banco depois)
      return [
        { id: 1, text: "ComunicaÃ§Ã£o e clareza", category: "ComunicaÃ§Ã£o" },
        { id: 2, text: "Trabalho em equipe", category: "ColaboraÃ§Ã£o" },
        { id: 3, text: "Iniciativa e proatividade", category: "Atitude" },
        { id: 4, text: "Qualidade tÃ©cnica", category: "CompetÃªncia TÃ©cnica" },
        { id: 5, text: "Cumprimento de prazos", category: "Entrega" },
        { id: 6, text: "Capacidade de resoluÃ§Ã£o de problemas", category: "ResoluÃ§Ã£o de Problemas" },
        { id: 7, text: "LideranÃ§a e influÃªncia", category: "LideranÃ§a" },
        { id: 8, text: "AdaptaÃ§Ã£o a mudanÃ§as", category: "Flexibilidade" },
      ];
    }),

  /**
   * Submeter feedback adicional
   */
  submitFeedback: protectedProcedure
    .input(
      z.object({
        evaluationId: z.number(),
        feedback: z.string(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Atualizar avaliaÃ§Ã£o com feedback
      await db
        .update(performanceEvaluations)
        .set({
          managerComments: input.feedback,
          updatedAt: new Date(),
        })
        .where(eq(performanceEvaluations.id, input.evaluationId));

      return { success: true };
    }),

  /**
   * Buscar detalhes completos da avaliaÃ§Ã£o
   */
  getDetails: protectedProcedure
    .input(z.object({ evaluationId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return null;

      const evaluation = await db
        .select({
          id: performanceEvaluations.id,
          cycleId: performanceEvaluations.cycleId,
          employeeId: performanceEvaluations.employeeId,
          employeeName: employees.name,
          type: performanceEvaluations.type,
          status: performanceEvaluations.status,
          workflowStatus: performanceEvaluations.workflowStatus,
          selfEvaluationCompleted: performanceEvaluations.selfEvaluationCompleted,
          managerEvaluationCompleted: performanceEvaluations.managerEvaluationCompleted,
          selfCompletedAt: performanceEvaluations.selfCompletedAt,
          managerCompletedAt: performanceEvaluations.managerCompletedAt,
          consensusCompletedAt: performanceEvaluations.consensusCompletedAt,
          finalScore: performanceEvaluations.finalScore,
          managerComments: performanceEvaluations.managerComments,
          createdAt: performanceEvaluations.createdAt,
          completedAt: performanceEvaluations.completedAt,
        })
        .from(performanceEvaluations)
        .leftJoin(employees, eq(performanceEvaluations.employeeId, employees.id))
        .where(eq(performanceEvaluations.id, input.evaluationId))
        .limit(1);

      if (evaluation.length === 0) return null;

      // Buscar respostas
      const responses = await db
        .select()
        .from(evaluationResponses)
        .where(eq(evaluationResponses.evaluationId, input.evaluationId));

      // Agrupar respostas por tipo de avaliador
      const groupedResponses = {
        self: responses.filter(r => r.evaluatorType === 'self'),
        manager: responses.filter(r => r.evaluatorType === 'manager'),
        peers: responses.filter(r => r.evaluatorType === 'peer'),
        subordinates: responses.filter(r => r.evaluatorType === 'subordinate'),
      };

      // Calcular mÃ©dias por tipo de avaliador
      const calculateAverage = (resps: typeof responses) => {
        const scores = resps.filter(r => r.score !== null).map(r => r.score!);
        return scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
      };

      const averages = {
        self: calculateAverage(groupedResponses.self),
        manager: calculateAverage(groupedResponses.manager),
        peers: calculateAverage(groupedResponses.peers),
        subordinates: calculateAverage(groupedResponses.subordinates),
      };

      return {
        ...evaluation[0],
        responses: groupedResponses,
        averages,
      };
    }),
});


========================================
ARQUIVO: ./server/executiveRouter.ts
========================================
import { TRPCError } from "@trpc/server";
import { desc, eq, sql, and, gte, lte, count } from "drizzle-orm";
import { z } from "zod";
import {
  employees,
  departments,
  positions,
  nineBoxPositions,
  successionPlans,
  performanceEvaluations,
  pdiPlans,
  goals,
} from "../drizzle/schema";
import { getDb } from "./db";
import { adminProcedure, router } from "./_core/trpc";

/**
 * Router de Dashboard Executivo
 * MÃ©tricas estratÃ©gicas para tomada de decisÃ£o da diretoria
 */

export const executiveRouter = router({
  /**
   * KPIs Executivos Gerais
   */
  getKPIs: adminProcedure
    .input(
      z.object({
        startDate: z.string().optional(),
        endDate: z.string().optional(),
        departmentId: z.number().optional(),
        costCenter: z.string().optional(),
      })
    )
    .query(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Total de colaboradores
      let employeeConditions = [];
      if (input.departmentId) {
        employeeConditions.push(eq(employees.departmentId, input.departmentId));
      }
      if (input.costCenter && input.costCenter !== 'all') {
        employeeConditions.push(eq(employees.costCenter, input.costCenter));
      }
      
      let employeeQuery = db.select({ count: count() }).from(employees);
      if (employeeConditions.length > 0) {
        employeeQuery = employeeQuery.where(and(...employeeConditions)) as any;
      }
      const totalEmployees = await employeeQuery;

      // Colaboradores ativos (status ativo)
      let activeConditions = [eq(employees.status, "ativo")];
      if (input.departmentId) {
        activeConditions.push(eq(employees.departmentId, input.departmentId));
      }
      if (input.costCenter && input.costCenter !== 'all') {
        activeConditions.push(eq(employees.costCenter, input.costCenter));
      }
      const activeEmployees = await db
        .select({ count: count() })
        .from(employees)
        .where(and(...activeConditions));

      // Taxa de turnover (simplificado - baseado em inativos nos Ãºltimos 12 meses)
      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

      // MÃ©dia de performance (baseado em avaliaÃ§Ãµes)
      const avgPerformance = await db
        .select({
          avg: sql<number>`AVG(${performanceEvaluations.finalScore})`,
        })
        .from(performanceEvaluations);

      // Colaboradores de alto potencial (9-Box: performance e potential altos)
      const highPotential = await db
        .select({ count: count() })
        .from(nineBoxPositions)
        .where(
          and(
            eq(nineBoxPositions.performance, 3),
            eq(nineBoxPositions.potential, 3)
          )
        );

      // PosiÃ§Ãµes crÃ­ticas com sucessores identificados
      const successionCoverage = await db
        .select({
          total: count(),
        })
        .from(successionPlans);

      return {
        totalEmployees: totalEmployees[0]?.count || 0,
        activeEmployees: activeEmployees[0]?.count || 0,
        turnoverRate: 0, // TODO: calcular baseado em dados reais
        avgPerformanceScore: avgPerformance[0]?.avg || 0,
        highPotentialCount: highPotential[0]?.count || 0,
        successionCoverage: successionCoverage[0]?.total || 0,
      };
    }),

  /**
   * DistribuiÃ§Ã£o de Headcount por Departamento
   */
  getHeadcountByDepartment: adminProcedure
    .input(z.object({ costCenter: z.string().optional() }).optional())
    .query(async ({ input, ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    let conditions = [eq(employees.status, "ativo")];
    if (input?.costCenter && input.costCenter !== 'all') {
      conditions.push(eq(employees.costCenter, input.costCenter));
    }

    const result = await db
      .select({
        departmentId: employees.departmentId,
        departmentName: departments.name,
        count: count(),
      })
      .from(employees)
      .leftJoin(departments, eq(employees.departmentId, departments.id))
      .where(and(...conditions))
      .groupBy(employees.departmentId, departments.name)
      .orderBy(desc(count()));

    return result.map((row) => ({
      department: row.departmentName || "Sem Departamento",
      count: row.count,
    }));
  }),

  /**
   * EvoluÃ§Ã£o de Headcount (Ãºltimos 12 meses)
   */
  getHeadcountTrend: adminProcedure
    .input(
      z.object({
        costCenter: z.string().optional(),
      })
    )
    .query(async ({ input, ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    // SimulaÃ§Ã£o de dados histÃ³ricos (em produÃ§Ã£o, usar tabela de histÃ³rico)
    const months = [];
    const now = new Date();

    for (let i = 11; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthName = date.toLocaleDateString("pt-BR", { month: "short", year: "numeric" });

      // Contar colaboradores ativos naquela data
      const total = await db
        .select({ count: count() })
        .from(employees)
        .where(eq(employees.status, "ativo"));

      months.push({
        month: monthName,
        total: total[0]?.count || 0,
      });
    }

    return months;
  }),

  /**
   * DistribuiÃ§Ã£o Salarial por Faixa
   */
  getSalaryDistribution: adminProcedure
    .input(z.object({ costCenter: z.string().optional() }).optional())
    .query(async ({ input, ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    // Simular distribuiÃ§Ã£o salarial (campo salary nÃ£o existe no schema)
    let conditions = [eq(employees.status, "ativo")];
    if (input?.costCenter && input.costCenter !== 'all') {
      conditions.push(eq(employees.costCenter, input.costCenter));
    }
    
    const totalEmployees = await db
      .select({ count: count() })
      .from(employees)
      .where(and(...conditions));

    const total = totalEmployees[0]?.count || 0;

    // Simular distribuiÃ§Ã£o (dados fictÃ­cios)
    const ranges = [
      { label: "AtÃ© R$ 3.000", count: Math.floor(total * 0.15) },
      { label: "R$ 3.001 - R$ 5.000", count: Math.floor(total * 0.25) },
      { label: "R$ 5.001 - R$ 8.000", count: Math.floor(total * 0.30) },
      { label: "R$ 8.001 - R$ 12.000", count: Math.floor(total * 0.18) },
      { label: "R$ 12.001 - R$ 20.000", count: Math.floor(total * 0.08) },
      { label: "Acima de R$ 20.000", count: Math.floor(total * 0.04) },
    ];

    return ranges.map((r) => ({
      range: r.label,
      count: r.count,
    }));
  }),

  /**
   * Taxa de Turnover Mensal (Ãºltimos 12 meses)
   */
  getTurnoverRate: adminProcedure
    .input(z.object({ costCenter: z.string().optional() }).optional())
    .query(async ({ input, ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    // SimulaÃ§Ã£o de dados de turnover (em produÃ§Ã£o, usar tabela de histÃ³rico de desligamentos)
    const months = [];
    const now = new Date();

    for (let i = 11; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthName = date.toLocaleDateString("pt-BR", { month: "short", year: "numeric" });

      // Simular taxa de turnover (entre 1% e 5%)
      const rate = Math.random() * 4 + 1;

      months.push({
        month: monthName,
        rate: parseFloat(rate.toFixed(2)),
      });
    }

    return months;
  }),

  /**
   * Pipeline de SucessÃ£o CrÃ­tica
   */
  getSuccessionPipeline: adminProcedure
    .input(
      z.object({
        costCenter: z.string().optional(),
      })
    )
    .query(async ({ input, ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    const pipeline = await db
      .select({
        planId: successionPlans.id,
        positionName: positions.title,
        riskLevel: successionPlans.riskLevel,
        status: successionPlans.status,
      })
      .from(successionPlans)
      .leftJoin(positions, eq(successionPlans.positionId, positions.id))
      .where(eq(successionPlans.isCritical, true))
      .orderBy(desc(successionPlans.riskLevel));

    return pipeline.map((row) => ({
      position: row.positionName || "PosiÃ§Ã£o Desconhecida",
      status: row.status || "ativo",
      riskLevel: row.riskLevel || "baixo",
    }));
  }),

  /**
   * ROI de Treinamentos (simulado)
   */
  getTrainingROI: adminProcedure
    .input(z.object({ costCenter: z.string().optional() }).optional())
    .query(async ({ input, ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    // Contar PDIs com aÃ§Ãµes de treinamento concluÃ­das
    const completedTrainings = await db
      .select({ count: count() })
      .from(pdiPlans)
      .where(eq(pdiPlans.status, "concluido"));

    // Calcular performance mÃ©dia antes e depois (simulado)
    const avgBefore = 3.2;
    const avgAfter = 3.8;
    const improvement = ((avgAfter - avgBefore) / avgBefore) * 100;

    return {
      totalTrainings: completedTrainings[0]?.count || 0,
      avgPerformanceBefore: avgBefore,
      avgPerformanceAfter: avgAfter,
      improvementPercent: parseFloat(improvement.toFixed(2)),
      estimatedROI: 250, // ROI estimado em %
    };
  }),

  /**
   * DistribuiÃ§Ã£o de Performance por NÃ­vel (9-Box)
   */
  getPerformanceDistribution: adminProcedure
    .input(
      z.object({
        costCenter: z.string().optional(),
      })
    )
    .query(async ({ input, ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    const distribution = await db
      .select({
        performance: nineBoxPositions.performance,
        potential: nineBoxPositions.potential,
        box: nineBoxPositions.box,
        count: count(),
      })
      .from(nineBoxPositions)
      .groupBy(nineBoxPositions.performance, nineBoxPositions.potential, nineBoxPositions.box)
      .orderBy(nineBoxPositions.performance, nineBoxPositions.potential);

    return distribution.map((row) => ({
      performance: row.performance,
      potential: row.potential,
      box: row.box,
      count: row.count,
    }));
  }),

  /**
   * MÃ©tricas de Engajamento (baseado em metas e PDI)
   */
  getEngagementMetrics: adminProcedure
    .input(z.object({ costCenter: z.string().optional() }).optional())
    .query(async ({ input, ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    // Colaboradores com metas ativas
    const withGoals = await db
      .select({ count: sql<number>`COUNT(DISTINCT ${goals.employeeId})` })
      .from(goals)
      .where(eq(goals.status, "em_andamento"));

    // Colaboradores com PDI ativo
    const withPDI = await db
      .select({ count: sql<number>`COUNT(DISTINCT ${pdiPlans.employeeId})` })
      .from(pdiPlans)
      .where(eq(pdiPlans.status, "em_andamento"));

    // Total de colaboradores ativos
    const totalActive = await db
      .select({ count: count() })
      .from(employees)
      .where(eq(employees.status, "ativo"));

    const total = totalActive[0]?.count || 1;

    return {
      goalsEngagement: parseFloat((((withGoals[0]?.count || 0) / total) * 100).toFixed(2)),
      pdiEngagement: parseFloat((((withPDI[0]?.count || 0) / total) * 100).toFixed(2)),
      totalActive: total,
    };
  }),

  /**
   * Performance por Departamento (mÃ©dia de scores)
   */
  getPerformanceByDepartment: adminProcedure
    .input(
      z.object({
        cycleId: z.number().optional(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const result = await db
        .select({
          departmentId: employees.departmentId,
          departmentName: departments.name,
          avgScore: sql<number>`AVG(${performanceEvaluations.finalScore})`,
          count: count(),
        })
        .from(performanceEvaluations)
        .leftJoin(employees, eq(performanceEvaluations.employeeId, employees.id))
        .leftJoin(departments, eq(employees.departmentId, departments.id))
        .groupBy(employees.departmentId, departments.name)
        .orderBy(desc(sql<number>`AVG(${performanceEvaluations.finalScore})`));

      return result.map((row) => ({
        department: row.departmentName || "Sem Departamento",
        avgScore: parseFloat((Number(row.avgScore) || 0).toFixed(2)),
        count: row.count,
      }));
    }),

  /**
   * TendÃªncia de Performance (Ãºltimos 6 meses)
   */
  getPerformanceTrend: adminProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    // SimulaÃ§Ã£o de dados histÃ³ricos (em produÃ§Ã£o, usar tabela de histÃ³rico)
    const months = [];
    const now = new Date();

    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthName = date.toLocaleDateString("pt-BR", { month: "short" });

      // Simular performance mÃ©dia (entre 75% e 95%)
      const avgPerformance = Math.random() * 20 + 75;

      months.push({
        month: monthName.charAt(0).toUpperCase() + monthName.slice(1),
        avgPerformance: parseFloat(avgPerformance.toFixed(2)),
      });
    }

    return months;
  }),

  /**
   * Cobertura de SucessÃ£o (distribuiÃ§Ã£o por nÃ­vel)
   */
  getSuccessionCoverage: adminProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    // Simular distribuiÃ§Ã£o de cobertura baseado em dados reais
    const totalPlans = await db
      .select({ count: count() })
      .from(successionPlans)
      .where(eq(successionPlans.status, "ativo"));

    const total = totalPlans[0]?.count || 45;

    // Distribuir baseado em padrÃµes tÃ­picos
    return [
      { label: "Sem Cobertura", value: Math.floor(total * 0.18), color: "#EF4444" },
      { label: "MÃ­nima", value: Math.floor(total * 0.33), color: "#F59E0B" },
      { label: "Adequada", value: Math.floor(total * 0.36), color: "#10B981" },
      { label: "Excelente", value: Math.floor(total * 0.13), color: "#3B82F6" },
    ];
  }),

  /**
   * Top 10 Performers (colaboradores com melhor desempenho)
   */
  getTopPerformers: adminProcedure
    .input(
      z.object({
        limit: z.number().default(10),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const result = await db
        .select({
          employeeId: performanceEvaluations.employeeId,
          employeeName: employees.name,
          departmentName: departments.name,
          positionTitle: positions.title,
          avgScore: sql<number>`AVG(${performanceEvaluations.finalScore})`,
        })
        .from(performanceEvaluations)
        .leftJoin(employees, eq(performanceEvaluations.employeeId, employees.id))
        .leftJoin(departments, eq(employees.departmentId, departments.id))
        .leftJoin(positions, eq(employees.positionId, positions.id))
        .groupBy(
          performanceEvaluations.employeeId,
          employees.name,
          departments.name,
          positions.title
        )
        .orderBy(desc(sql<number>`AVG(${performanceEvaluations.finalScore})`))
        .limit(input.limit);

      return result.map((row) => ({
        id: row.employeeId,
        name: row.employeeName || "Desconhecido",
        department: row.departmentName || "Sem Departamento",
        position: row.positionTitle || "Sem Cargo",
        score: parseFloat((Number(row.avgScore) || 0).toFixed(2)),
      }));
    }),

  /**
   * Flight Risk (colaboradores com alto risco de saÃ­da)
   */
  getFlightRisk: adminProcedure
    .input(
      z.object({
        riskLevel: z.enum(["baixo", "medio", "alto", "critico"]).default("alto"),
        limit: z.number().default(10),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // SimulaÃ§Ã£o de flight risk (em produÃ§Ã£o, usar tabela de risk assessment)
      const allEmployees = await db
        .select({
          id: employees.id,
          name: employees.name,
          departmentName: departments.name,
          positionTitle: positions.title,
        })
        .from(employees)
        .leftJoin(departments, eq(employees.departmentId, departments.id))
        .leftJoin(positions, eq(employees.positionId, positions.id))
        .where(eq(employees.status, "ativo"))
        .limit(input.limit);

      return allEmployees.map((emp) => ({
        id: emp.id,
        name: emp.name || "Desconhecido",
        department: emp.departmentName || "Sem Departamento",
        position: emp.positionTitle || "Sem Cargo",
        riskLevel: input.riskLevel,
        riskScore: Math.floor(Math.random() * 3) + 8, // Score entre 8-10
        status: "Em desenvolvimento" as const,
      }));
    }),
});



========================================
ARQUIVO: ./server/feedbackRouter.ts
========================================
import { desc, eq, and, or } from "drizzle-orm";
import { z } from "zod";
import { getDb } from "./db";
import { feedbacks, employees, pdiPlans } from "../drizzle/schema";
import { protectedProcedure, router } from "./_core/trpc";

export const feedbackRouter = router({
  // Criar novo feedback
  create: protectedProcedure
    .input(z.object({
      employeeId: z.number(),
      type: z.enum(["positivo", "construtivo", "desenvolvimento"]),
      category: z.string().optional(),
      content: z.string(),
      context: z.string().optional(),
      actionItems: z.string().optional(), // JSON string
      linkedPDIId: z.number().optional(),
      isPrivate: z.boolean().default(false),
    }))
    .mutation(async ({ input, ctx }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      await database.insert(feedbacks).values({
        managerId: ctx.user.id,
        ...input,
      });

      // Verificar badges de feedback ao criar
      if (input.employeeId) {
        const { checkFeedbackBadges } = await import("./services/badgeService");
        await checkFeedbackBadges(input.employeeId);
      }

      return { success: true };
    }),

  // Listar feedbacks (gestor vÃª todos que deu, colaborador vÃª apenas os seus)
  list: protectedProcedure
    .input(z.object({
      employeeId: z.number().optional(),
      type: z.enum(["positivo", "construtivo", "desenvolvimento"]).optional(),
    }))
    .query(async ({ input, ctx }) => {
      const database = await getDb();
      if (!database) return [];

      let query = database.select({
        feedback: feedbacks,
        employee: employees,
      })
        .from(feedbacks)
        .leftJoin(employees, eq(feedbacks.employeeId, employees.id));

      // Se for colaborador, sÃ³ vÃª os prÃ³prios feedbacks
      if (ctx.user.role === "colaborador") {
        const employee = await database.select()
          .from(employees)
          .where(eq(employees.userId, ctx.user.id))
          .limit(1);
        
        if (employee.length === 0) return [];
        
        const results = await query.where(eq(feedbacks.employeeId, employee[0].id));
        return results;
      }

      // Se for gestor/admin, aplica filtros
      const conditions = [];
      
      if (input.employeeId) {
        conditions.push(eq(feedbacks.employeeId, input.employeeId));
      } else if (ctx.user.role === "gestor") {
        // Gestor vÃª apenas feedbacks que ele deu
        conditions.push(eq(feedbacks.managerId, ctx.user.id));
      }

      if (input.type) {
        conditions.push(eq(feedbacks.type, input.type));
      }

      if (conditions.length > 0) {
        return await query.where(and(...conditions));
      }

      return await query;
    }),

  // Buscar histÃ³rico de um colaborador especÃ­fico
  getHistory: protectedProcedure
    .input(z.object({
      employeeId: z.number(),
    }))
    .query(async ({ input, ctx }) => {
      const database = await getDb();
      if (!database) return [];

      const history = await database.select()
        .from(feedbacks)
        .where(eq(feedbacks.employeeId, input.employeeId))
        .orderBy(desc(feedbacks.createdAt));

      return history;
    }),

  // Marcar feedback como visualizado
  acknowledge: protectedProcedure
    .input(z.object({
      feedbackId: z.number(),
    }))
    .mutation(async ({ input, ctx }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      await database.update(feedbacks)
        .set({ acknowledgedAt: new Date() })
        .where(eq(feedbacks.id, input.feedbackId));

      return { success: true };
    }),

  // Buscar estatÃ­sticas de feedback
  getStats: protectedProcedure
    .input(z.object({
      employeeId: z.number().optional(),
    }))
    .query(async ({ input, ctx }) => {
      const database = await getDb();
      if (!database) return { total: 0, positivo: 0, construtivo: 0, desenvolvimento: 0 };

      const conditions = [];

      if (input.employeeId) {
        conditions.push(eq(feedbacks.employeeId, input.employeeId));
      } else if (ctx.user.role === "gestor") {
        conditions.push(eq(feedbacks.managerId, ctx.user.id));
      }

      const allFeedbacks = conditions.length > 0
        ? await database.select().from(feedbacks).where(and(...conditions))
        : await database.select().from(feedbacks);

      return {
        total: allFeedbacks.length,
        positivo: allFeedbacks.filter((f: any) => f.type === "positivo").length,
        construtivo: allFeedbacks.filter((f: any) => f.type === "construtivo").length,
        desenvolvimento: allFeedbacks.filter((f: any) => f.type === "desenvolvimento").length,
      };
    }),
});


========================================
ARQUIVO: ./server/gamificationRouter.ts
========================================
import { z } from "zod";
import { router, protectedProcedure } from "./_core/trpc";
import { getDb } from "./db";
import { eq, desc, sql } from "drizzle-orm";

/**
 * Sistema de GamificaÃ§Ã£o
 * Pontos, nÃ­veis e rankings
 */

// ConfiguraÃ§Ã£o de nÃ­veis
const LEVELS = [
  { name: "Bronze", minPoints: 0, maxPoints: 999 },
  { name: "Prata", minPoints: 1000, maxPoints: 2999 },
  { name: "Ouro", minPoints: 3000, maxPoints: 5999 },
  { name: "Platina", minPoints: 6000, maxPoints: Infinity },
];

// ConfiguraÃ§Ã£o de pontos por aÃ§Ã£o
const POINTS_CONFIG = {
  meta_concluida: 100,
  meta_antecipada: 150,
  avaliacao_360_completa: 50,
  pdi_item_concluido: 30,
  feedback_dado: 10,
  feedback_recebido: 5,
  badge_conquistado: 200,
  calibracao_aprovada: 75,
};

function calculateLevel(points: number): string {
  for (const level of LEVELS) {
    if (points >= level.minPoints && points <= level.maxPoints) {
      return level.name;
    }
  }
  return "Bronze";
}

export const gamificationRouter = router({
  /**
   * Adicionar pontos a um colaborador
   */
  addPoints: protectedProcedure
    .input(
      z.object({
        employeeId: z.number(),
        action: z.enum([
          "meta_concluida",
          "meta_antecipada",
          "avaliacao_360_completa",
          "pdi_item_concluido",
          "feedback_dado",
          "feedback_recebido",
          "badge_conquistado",
          "calibracao_aprovada",
        ]),
        customPoints: z.number().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { employees } = await import("../drizzle/schema");

      // Buscar colaborador
      const [employee] = await db
        .select()
        .from(employees)
        .where(eq(employees.id, input.employeeId))
        .limit(1);

      if (!employee) throw new Error("Colaborador nÃ£o encontrado");

      // Calcular pontos
      const pointsToAdd = input.customPoints || POINTS_CONFIG[input.action];
      const newPoints = (employee.gamificationPoints || 0) + pointsToAdd;
      const newLevel = calculateLevel(newPoints);

      // Atualizar colaborador
      await db
        .update(employees)
        .set({
          gamificationPoints: newPoints,
          gamificationLevel: newLevel,
          lastPointsUpdate: new Date(),
        })
        .where(eq(employees.id, input.employeeId));

      return {
        success: true,
        pointsAdded: pointsToAdd,
        totalPoints: newPoints,
        level: newLevel,
        levelUp: newLevel !== employee.gamificationLevel,
      };
    }),

  /**
   * Obter ranking geral
   */
  getRanking: protectedProcedure
    .input(
      z.object({
        limit: z.number().default(50),
        departmentId: z.number().optional(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { employees, departments, positions } = await import("../drizzle/schema");

      let query = db
        .select({
          employee: employees,
          department: departments,
          position: positions,
        })
        .from(employees)
        .leftJoin(departments, eq(employees.departmentId, departments.id))
        .leftJoin(positions, eq(employees.positionId, positions.id))
        .orderBy(desc(employees.gamificationPoints))
        .limit(input.limit);

      if (input.departmentId) {
        query = query.where(eq(employees.departmentId, input.departmentId)) as any;
      }

      const ranking = await query;

      return ranking.map((item, index) => ({
        rank: index + 1,
        employee: item.employee,
        department: item.department,
        position: item.position,
      }));
    }),

  /**
   * Obter estatÃ­sticas de gamificaÃ§Ã£o de um colaborador
   */
  getEmployeeStats: protectedProcedure
    .input(z.object({ employeeId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { employees, employeeBadges, badges } = await import("../drizzle/schema");

      // Buscar colaborador
      const [employee] = await db
        .select()
        .from(employees)
        .where(eq(employees.id, input.employeeId))
        .limit(1);

      if (!employee) throw new Error("Colaborador nÃ£o encontrado");

      // Buscar badges conquistados
      const employeeBadgesList = await db
        .select({
          badge: badges,
          earnedAt: employeeBadges.earnedAt,
        })
        .from(employeeBadges)
        .leftJoin(badges, eq(employeeBadges.badgeId, badges.id))
        .where(eq(employeeBadges.employeeId, input.employeeId));

      // Calcular prÃ³ximo nÃ­vel
      const currentLevel = LEVELS.find((l) => l.name === employee.gamificationLevel);
      const nextLevel = LEVELS[LEVELS.findIndex((l) => l.name === employee.gamificationLevel) + 1];

      const pointsToNextLevel = nextLevel
        ? nextLevel.minPoints - (employee.gamificationPoints || 0)
        : 0;

      const progressToNextLevel = nextLevel
        ? ((employee.gamificationPoints || 0) - (currentLevel?.minPoints || 0)) /
          (nextLevel.minPoints - (currentLevel?.minPoints || 0))
        : 1;

      return {
        points: employee.gamificationPoints || 0,
        level: employee.gamificationLevel || "Bronze",
        badges: employeeBadgesList.length,
        pointsToNextLevel,
        progressToNextLevel: Math.min(progressToNextLevel * 100, 100),
        recentBadges: employeeBadgesList.slice(0, 5),
      };
    }),

  /**
   * Obter configuraÃ§Ã£o de nÃ­veis
   */
  getLevels: protectedProcedure.query(() => {
    return LEVELS;
  }),

  /**
   * Obter configuraÃ§Ã£o de pontos por aÃ§Ã£o
   */
  getPointsConfig: protectedProcedure.query(() => {
    return POINTS_CONFIG;
  }),

  /**
   * Obter ranking do mÃªs atual
   */
  getMonthlyRanking: protectedProcedure
    .input(z.object({ limit: z.number().default(10) }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { employees, departments, positions } = await import("../drizzle/schema");

      // TODO: Implementar tabela de histÃ³rico de pontos mensal
      // Por enquanto, retornar ranking geral
      const ranking = await db
        .select({
          employee: employees,
          department: departments,
          position: positions,
        })
        .from(employees)
        .leftJoin(departments, eq(employees.departmentId, departments.id))
        .leftJoin(positions, eq(employees.positionId, positions.id))
        .orderBy(desc(employees.gamificationPoints))
        .limit(input.limit);

      return ranking.map((item, index) => ({
        rank: index + 1,
        employee: item.employee,
        department: item.department,
        position: item.position,
      }));
    }),
});


========================================
ARQUIVO: ./server/goalApprovalsRouter.ts
========================================
import { z } from "zod";
import { eq, and, desc } from "drizzle-orm";
import { protectedProcedure, router } from "./_core/trpc";
import { getDb } from "./db";
import { goalApprovals, smartGoals, users } from "../drizzle/schema";
import { createNotification } from "./notificationHelper";

/**
 * Router para gerenciar aprovaÃ§Ãµes de metas
 * 
 * Endpoints:
 * - list: Listar aprovaÃ§Ãµes de uma meta
 * - approve: Aprovar meta (apenas gestor/RH/diretor)
 * - reject: Rejeitar meta (apenas gestor/RH/diretor)
 * - requestApproval: Solicitar aprovaÃ§Ã£o de meta
 */

export const goalApprovalsRouter = router({
  /**
   * Listar aprovaÃ§Ãµes de uma meta
   */
  list: protectedProcedure
    .input(z.object({ goalId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const approvals = await db
        .select({
          id: goalApprovals.id,
          approverId: goalApprovals.approverId,
          approverRole: goalApprovals.approverRole,
          status: goalApprovals.status,
          comments: goalApprovals.comments,
          createdAt: goalApprovals.createdAt,
          approvedAt: goalApprovals.approvedAt,
          approverName: users.name,
        })
        .from(goalApprovals)
        .leftJoin(users, eq(goalApprovals.approverId, users.id))
        .where(eq(goalApprovals.goalId, input.goalId))
        .orderBy(desc(goalApprovals.createdAt));

      return approvals;
    }),

  /**
   * Aprovar meta
   */
  approve: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        comments: z.string().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Verificar se usuÃ¡rio tem permissÃ£o (gestor, RH ou diretor)
      if (!["admin", "rh", "gestor"].includes(ctx.user.role)) {
        throw new Error("Sem permissÃ£o para aprovar metas");
      }

      // Buscar a meta
      const [goal] = await db
        .select()
        .from(smartGoals)
        .where(eq(smartGoals.id, input.goalId))
        .limit(1);

      if (!goal) throw new Error("Meta nÃ£o encontrada");

      // Determinar role do aprovador
      const approverRole =
        ctx.user.role === "admin"
          ? "director"
          : ctx.user.role === "rh"
          ? "hr"
          : "manager";

      // Criar registro de aprovaÃ§Ã£o
      await db.insert(goalApprovals).values({
        goalId: input.goalId,
        approverId: ctx.user.id,
        approverRole: approverRole as "manager" | "hr" | "director",
        status: "approved",
        comments: input.comments || null,
        approvedAt: new Date(),
      });

      // Atualizar status da meta
      await db
        .update(smartGoals)
        .set({
          approvalStatus: "approved",
          status: "in_progress",
          updatedAt: new Date(),
        })
        .where(eq(smartGoals.id, input.goalId));

      // Enviar notificaÃ§Ã£o ao colaborador
      await createNotification({
        userId: goal.employeeId,
        type: "goal_approved",
        title: "Meta Aprovada! ðŸŽ‰",
        message: `Sua meta "${goal.title}" foi aprovada por ${ctx.user.name}`,
        link: `/metas/${input.goalId}`,
      });

      return { success: true };
    }),

  /**
   * Rejeitar meta
   */
  reject: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        comments: z.string().min(10, "ComentÃ¡rio obrigatÃ³rio ao rejeitar (mÃ­nimo 10 caracteres)"),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Verificar se usuÃ¡rio tem permissÃ£o
      if (!["admin", "rh", "gestor"].includes(ctx.user.role)) {
        throw new Error("Sem permissÃ£o para rejeitar metas");
      }

      // Buscar a meta
      const [goal] = await db
        .select()
        .from(smartGoals)
        .where(eq(smartGoals.id, input.goalId))
        .limit(1);

      if (!goal) throw new Error("Meta nÃ£o encontrada");

      // Determinar role do aprovador
      const approverRole =
        ctx.user.role === "admin"
          ? "director"
          : ctx.user.role === "rh"
          ? "hr"
          : "manager";

      // Criar registro de rejeiÃ§Ã£o
      await db.insert(goalApprovals).values({
        goalId: input.goalId,
        approverId: ctx.user.id,
        approverRole: approverRole as "manager" | "hr" | "director",
        status: "rejected",
        comments: input.comments,
        approvedAt: new Date(),
      });

      // Atualizar status da meta
      await db
        .update(smartGoals)
        .set({
          approvalStatus: "rejected",
          status: "draft",
          updatedAt: new Date(),
        })
        .where(eq(smartGoals.id, input.goalId));

      // Enviar notificaÃ§Ã£o ao colaborador
      await createNotification({
        userId: goal.employeeId,
        type: "goal_rejected",
        title: "Meta Rejeitada",
        message: `Sua meta "${goal.title}" foi rejeitada por ${ctx.user.name}. Motivo: ${input.comments}`,
        link: `/metas/${input.goalId}`,
      });

      return { success: true };
    }),

  /**
   * Solicitar aprovaÃ§Ã£o de meta
   */
  requestApproval: protectedProcedure
    .input(z.object({ goalId: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar a meta
      const [goal] = await db
        .select()
        .from(smartGoals)
        .where(and(eq(smartGoals.id, input.goalId), eq(smartGoals.employeeId, ctx.user.id)))
        .limit(1);

      if (!goal) throw new Error("Meta nÃ£o encontrada ou sem permissÃ£o");

      // Atualizar status para pendente de aprovaÃ§Ã£o
      await db
        .update(smartGoals)
        .set({
          approvalStatus: "pending_manager",
          updatedAt: new Date(),
        })
        .where(eq(smartGoals.id, input.goalId));

      // TODO: Enviar notificaÃ§Ã£o ao gestor
      // Requer implementaÃ§Ã£o de relaÃ§Ã£o employee -> manager

      return { success: true };
    }),
});


========================================
ARQUIVO: ./server/goalsCascadeRouter.ts
========================================
import { z } from "zod";
import { router, protectedProcedure } from "./_core/trpc";
import { getDb } from "./db";
import { goals } from "../drizzle/schema";
import { eq, isNull, sql } from "drizzle-orm";

/**
 * Router de Metas em Cascata HierÃ¡rquico
 * Gerencia metas organizacionais â†’ departamentais â†’ individuais
 */

export const goalsCascadeRouter = router({
  /**
   * Buscar Ã¡rvore completa de metas em cascata
   */
  getTree: protectedProcedure
    .input(z.object({
      cycleId: z.number(),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar todas as metas do ciclo
      const allGoals = await db
        .select()
        .from(goals)
        .where(eq(goals.cycleId, input.cycleId));

      // Construir Ã¡rvore hierÃ¡rquica
      const buildTree = (parentId: number | null): any[] => {
        return allGoals
          .filter(g => (parentId === null ? g.parentGoalId === null : g.parentGoalId === parentId))
          .map(goal => ({
            ...goal,
            children: buildTree(goal.id),
          }));
      };

      return buildTree(null);
    }),

  /**
   * Buscar metas raiz (organizacionais sem pai)
   */
  getRootGoals: protectedProcedure
    .input(z.object({
      cycleId: z.number(),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      return await db
        .select()
        .from(goals)
        .where(sql`${goals.cycleId} = ${input.cycleId} AND ${goals.parentGoalId} IS NULL`);
    }),

  /**
   * Buscar metas filhas de uma meta pai
   */
  getChildGoals: protectedProcedure
    .input(z.object({
      parentGoalId: z.number(),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      return await db
        .select()
        .from(goals)
        .where(eq(goals.parentGoalId, input.parentGoalId));
    }),

  /**
   * Criar meta em cascata (vinculada a uma meta pai)
   */
  createCascadeGoal: protectedProcedure
    .input(z.object({
      parentGoalId: z.number().optional(),
      cycleId: z.number(),
      employeeId: z.number().optional(),
      departmentId: z.number().optional(),
      title: z.string(),
      description: z.string().optional(),
      type: z.enum(["individual", "equipe", "organizacional"]),
      category: z.enum(["quantitativa", "qualitativa"]),
      targetValue: z.string().optional(),
      unit: z.string().optional(),
      weight: z.number().default(1),
      startDate: z.date(),
      endDate: z.date(),
      alignmentPercentage: z.number().default(100),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const [newGoal] = await db.insert(goals).values({
        cycleId: input.cycleId,
        employeeId: input.employeeId || ctx.user.id,
        title: input.title,
        description: input.description,
        type: input.type,
        category: input.category,
        targetValue: input.targetValue,
        currentValue: "0",
        unit: input.unit,
        weight: input.weight,
        startDate: input.startDate,
        endDate: input.endDate,
        status: "rascunho",
        progress: 0,
        linkedToPLR: false,
        linkedToBonus: false,
        parentGoalId: input.parentGoalId,
        departmentId: input.departmentId,
        alignmentPercentage: input.alignmentPercentage,
        createdBy: ctx.user.id,
      });

      return newGoal;
    }),

  /**
   * Atualizar % de alinhamento de uma meta
   */
  updateAlignment: protectedProcedure
    .input(z.object({
      goalId: z.number(),
      alignmentPercentage: z.number().min(0).max(100),
    }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db
        .update(goals)
        .set({ alignmentPercentage: input.alignmentPercentage })
        .where(eq(goals.id, input.goalId));

      return { success: true };
    }),

  /**
   * Calcular estatÃ­sticas da cascata
   */
  getStats: protectedProcedure
    .input(z.object({
      cycleId: z.number(),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const allGoals = await db
        .select()
        .from(goals)
        .where(eq(goals.cycleId, input.cycleId));

      const organizacional = allGoals.filter(g => g.type === "organizacional");
      const departamental = allGoals.filter(g => g.type === "equipe");
      const individual = allGoals.filter(g => g.type === "individual");

      const avgAlignmentOrg = organizacional.length > 0
        ? organizacional.reduce((sum, g) => sum + (g.alignmentPercentage || 0), 0) / organizacional.length
        : 0;

      const avgAlignmentDept = departamental.length > 0
        ? departamental.reduce((sum, g) => sum + (g.alignmentPercentage || 0), 0) / departamental.length
        : 0;

      const avgAlignmentInd = individual.length > 0
        ? individual.reduce((sum, g) => sum + (g.alignmentPercentage || 0), 0) / individual.length
        : 0;

      return {
        total: allGoals.length,
        organizacional: organizacional.length,
        departamental: departamental.length,
        individual: individual.length,
        avgAlignmentOrganizacional: Math.round(avgAlignmentOrg),
        avgAlignmentDepartamental: Math.round(avgAlignmentDept),
        avgAlignmentIndividual: Math.round(avgAlignmentInd),
        avgAlignmentGeral: Math.round((avgAlignmentOrg + avgAlignmentDept + avgAlignmentInd) / 3),
      };
    }),
});


========================================
ARQUIVO: ./server/goalsRouter.ts
========================================
import { TRPCError } from "@trpc/server";
import { and, desc, eq, gte, lte, sql } from "drizzle-orm";
import { z } from "zod";
import {
  goalApprovals,
  goalComments,
  goalMilestones,
  smartGoals,
  employees,
  evaluationCycles,
  pdiPlans,
} from "../drizzle/schema";
import { getDb, getUserEmployee } from "./db";
import { protectedProcedure, router } from "./_core/trpc";

/**
 * Router de Metas SMART
 * Sistema completo de criaÃ§Ã£o, validaÃ§Ã£o, aprovaÃ§Ã£o e acompanhamento de metas
 * com elegibilidade para bÃ´nus financeiro
 */

export const goalsRouter = router({
  /**
   * Validar critÃ©rios SMART de uma meta
   */
  validateSMART: protectedProcedure
    .input(
      z.object({
        title: z.string(),
        description: z.string(),
        measurementUnit: z.string().optional(),
        targetValue: z.number().optional(),
        startDate: z.string(),
        endDate: z.string(),
      })
    )
    .mutation(async ({ input }) => {
      const validation = {
        isSpecific: false,
        isMeasurable: false,
        isAchievable: false,
        isRelevant: false,
        isTimeBound: false,
        score: 0,
        feedback: [] as string[],
      };

      // S - EspecÃ­fica: tÃ­tulo e descriÃ§Ã£o detalhados
      if (
        input.title.length >= 10 &&
        input.description.length >= 50 &&
        /\b(aumentar|reduzir|melhorar|implementar|criar|desenvolver)\b/i.test(
          input.description
        )
      ) {
        validation.isSpecific = true;
        validation.score += 20;
      } else {
        validation.feedback.push(
          "Meta precisa ser mais especÃ­fica com verbo de aÃ§Ã£o claro"
        );
      }

      // M - MensurÃ¡vel: tem unidade de medida e valor alvo
      if (input.measurementUnit && input.targetValue !== undefined) {
        validation.isMeasurable = true;
        validation.score += 20;
      } else {
        validation.feedback.push(
          "Meta precisa ter unidade de medida e valor alvo definidos"
        );
      }

      // A - AtingÃ­vel: valor alvo razoÃ¡vel (heurÃ­stica simples)
      if (input.targetValue && input.targetValue > 0 && input.targetValue < 1000000) {
        validation.isAchievable = true;
        validation.score += 20;
      } else {
        validation.feedback.push("Valor alvo deve ser realista e atingÃ­vel");
      }

      // R - Relevante: descriÃ§Ã£o menciona impacto ou benefÃ­cio
      if (
        /\b(impacto|resultado|benefÃ­cio|objetivo|estratÃ©gia|crescimento|melhoria)\b/i.test(
          input.description
        )
      ) {
        validation.isRelevant = true;
        validation.score += 20;
      } else {
        validation.feedback.push(
          "Meta precisa demonstrar relevÃ¢ncia e alinhamento estratÃ©gico"
        );
      }

      // T - Temporal: tem prazo definido (mÃ­nimo 1 mÃªs, mÃ¡ximo 2 anos)
      const start = new Date(input.startDate);
      const end = new Date(input.endDate);
      const diffMonths =
        (end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24 * 30);
      if (diffMonths >= 1 && diffMonths <= 24) {
        validation.isTimeBound = true;
        validation.score += 20;
      } else {
        validation.feedback.push("Prazo deve estar entre 1 mÃªs e 24 meses");
      }

      return validation;
    }),

  /**
   * Criar nova meta SMART
   */
  createSMART: protectedProcedure
    .input(
      z.object({
        title: z.string().min(10),
        description: z.string().min(50),
        type: z.enum(["individual", "team", "organizational"]),
        category: z.enum(["financial", "behavioral", "corporate", "development"]),
        measurementUnit: z.string().optional(),
        targetValue: z.number().optional(),
        weight: z.number().min(1).max(100).default(10),
        startDate: z.string(),
        endDate: z.string(),
        bonusEligible: z.boolean().default(false),
        bonusPercentage: z.number().optional(),
        bonusAmount: z.number().optional(),
        pdiPlanId: z.number().optional(),
        cycleId: z.number(),
      })
    )
    .mutation(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR" });

      // Validar critÃ©rios SMART automaticamente
      const validation = {
        isSpecific: input.title.length >= 10 && input.description.length >= 50 && /\b(aumentar|reduzir|melhorar|implementar|criar|desenvolver)\b/i.test(input.description),
        isMeasurable: !!(input.measurementUnit && input.targetValue !== undefined),
        isAchievable: !!(input.targetValue && input.targetValue > 0 && input.targetValue < 1000000),
        isRelevant: /\b(impacto|resultado|benefÃ­cio|objetivo|estratÃ©gia|crescimento|melhoria)\b/i.test(input.description),
        isTimeBound: (() => {
          const start = new Date(input.startDate);
          const end = new Date(input.endDate);
          const diffMonths = (end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24 * 30);
          return diffMonths >= 1 && diffMonths <= 24;
        })(),
        score: 0,
        feedback: [] as string[],
      };
      validation.score = [validation.isSpecific, validation.isMeasurable, validation.isAchievable, validation.isRelevant, validation.isTimeBound].filter(Boolean).length * 20;

      // Criar meta
      const [result] = await db.insert(smartGoals).values({
        employeeId: ctx.user.id,
        cycleId: input.cycleId,
        pdiPlanId: input.pdiPlanId,
        title: input.title,
        description: input.description,
        type: input.type,
        category: input.category,
        measurementUnit: input.measurementUnit,
        targetValue: input.targetValue?.toString(),
        weight: input.weight,
        startDate: new Date(input.startDate),
        endDate: new Date(input.endDate),
        bonusEligible: input.bonusEligible,
        bonusPercentage: input.bonusPercentage?.toString(),
        bonusAmount: input.bonusAmount?.toString(),
        isSpecific: validation.isSpecific,
        isMeasurable: validation.isMeasurable,
        isAchievable: validation.isAchievable,
        isRelevant: validation.isRelevant,
        isTimeBound: validation.isTimeBound,
        status: "draft",
        approvalStatus: "not_submitted",
        createdBy: ctx.user.id,
      });

      return { goalId: result.insertId, validation };
    }),

  /**
   * Listar metas do colaborador
   */
  list: protectedProcedure
    .input(
      z.object({
        cycleId: z.number().optional(),
        status: z
          .enum([
            "draft",
            "pending_approval",
            "approved",
            "rejected",
            "in_progress",
            "completed",
            "cancelled",
          ])
          .optional(),
        category: z
          .enum(["financial", "behavioral", "corporate", "development"])
          .optional(),
      })
    )
    .query(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) return [];

      // Buscar employee vinculado ao usuÃ¡rio
      const [employee] = await db
        .select()
        .from(employees)
        .where(eq(employees.userId, ctx.user.id))
        .limit(1);

      if (!employee) return [];

      const conditions = [eq(smartGoals.employeeId, employee.id)];
      if (input.cycleId) conditions.push(eq(smartGoals.cycleId, input.cycleId));
      if (input.status) conditions.push(eq(smartGoals.status, input.status));
      if (input.category) conditions.push(eq(smartGoals.category, input.category));

      const goals = await db
        .select()
        .from(smartGoals)
        .where(and(...conditions))
        .orderBy(desc(smartGoals.createdAt));

      return goals;
    }),

  /**
   * Buscar meta por ID com detalhes completos
   */
  getById: protectedProcedure
    .input(z.object({ goalId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return null;

      const [goal] = await db
        .select()
        .from(smartGoals)
        .where(eq(smartGoals.id, input.goalId))
        .limit(1);

      if (!goal) return null;

      // Buscar marcos
      const milestones = await db
        .select()
        .from(goalMilestones)
        .where(eq(goalMilestones.goalId, input.goalId))
        .orderBy(goalMilestones.dueDate);

      // Buscar aprovaÃ§Ãµes (com tratamento de erro)
      let approvals: any[] = [];
      try {
        const approvalsData = await db
          .select()
          .from(goalApprovals)
          .leftJoin(employees, eq(goalApprovals.approverId, employees.id))
          .where(eq(goalApprovals.goalId, input.goalId));

        approvals = approvalsData.map((row) => ({
          id: row.goalApprovals.id,
          approverId: row.goalApprovals.approverId,
          approverRole: row.goalApprovals.approverRole,
          status: row.goalApprovals.status,
          comments: row.goalApprovals.comments,
          createdAt: row.goalApprovals.createdAt,
          approvedAt: row.goalApprovals.approvedAt,
          approverName: row.employees?.name || null,
        }));
      } catch (error) {
        console.error("[goalsRouter] Erro ao buscar aprovaÃ§Ãµes:", error);
      }

      // Buscar comentÃ¡rios (com tratamento de erro)
      let comments: any[] = [];
      try {
        comments = await db
          .select({
            id: goalComments.id,
            authorId: goalComments.authorId,
            comment: goalComments.comment,
            createdAt: goalComments.createdAt,
            authorName: employees.name,
          })
          .from(goalComments)
          .leftJoin(employees, eq(goalComments.authorId, employees.id))
          .where(eq(goalComments.goalId, input.goalId))
          .orderBy(desc(goalComments.createdAt));
      } catch (error) {
        console.error("[goalsRouter] Erro ao buscar comentÃ¡rios:", error);
      }

      // Buscar evidÃªncias (com tratamento de erro)
      let evidences: any[] = [];
      try {
        const { goalEvidences } = await import("../drizzle/schema");
        evidences = await db
          .select()
          .from(goalEvidences)
          .where(eq(goalEvidences.goalId, input.goalId))
          .orderBy(desc(goalEvidences.uploadedAt));
      } catch (error) {
        console.error("[goalsRouter] Erro ao buscar evidÃªncias:", error);
      }

      return {
        ...goal,
        milestones,
        approvals,
        comments,
        evidences,
      };
    }),

  /**
   * Atualizar progresso da meta
   */
  updateProgress: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        currentValue: z.number().optional(),
        progress: z.number().min(0).max(100),
        comment: z.string().optional(),
      })
    )
    .mutation(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR" });

      // Buscar employee vinculado ao usuÃ¡rio
      const employee = await getUserEmployee(ctx.user.id);
      if (!employee) {
        throw new TRPCError({
          code: "NOT_FOUND",
          message: "Employee nÃ£o encontrado para este usuÃ¡rio",
        });
      }

      // Atualizar meta
      const updateData: any = {
        progress: input.progress,
        status: input.progress === 100 ? "completed" : "in_progress",
        completedAt: input.progress === 100 ? new Date() : undefined,
      };
      
      // Adicionar currentValue apenas se fornecido
      if (input.currentValue !== undefined) {
        updateData.currentValue = input.currentValue.toString();
      }

      await db
        .update(smartGoals)
        .set(updateData)
        .where(eq(smartGoals.id, input.goalId));

      // Adicionar comentÃ¡rio se fornecido
      if (input.comment) {
        await db.insert(goalComments).values({
          goalId: input.goalId,
          authorId: employee.id, // Usar employee.id em vez de ctx.user.id
          comment: input.comment,
        });
      }

      return { success: true };
    }),

  /**
   * Adicionar marco Ã  meta
   */
  addMilestone: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        title: z.string(),
        description: z.string().optional(),
        dueDate: z.string(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR" });

      const [milestone] = await db.insert(goalMilestones).values({
        goalId: input.goalId,
        title: input.title,
        description: input.description,
        dueDate: new Date(input.dueDate),
        status: "pending",
      });

      return { milestoneId: milestone.insertId };
    }),

  /**
   * Atualizar marco
   */
  updateMilestone: protectedProcedure
    .input(
      z.object({
        milestoneId: z.number(),
        status: z.enum(["pending", "in_progress", "completed", "delayed"]),
        progress: z.number().min(0).max(100),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR" });

      await db
        .update(goalMilestones)
        .set({
          status: input.status,
          progress: input.progress,
          completedAt: input.status === "completed" ? new Date() : undefined,
        })
        .where(eq(goalMilestones.id, input.milestoneId));

      return { success: true };
    }),

  /**
   * Enviar meta para aprovaÃ§Ã£o
   */
  submitForApproval: protectedProcedure
    .input(z.object({ goalId: z.number() }))
    .mutation(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR" });

      // Buscar meta
      const [goal] = await db
        .select()
        .from(smartGoals)
        .where(eq(smartGoals.id, input.goalId))
        .limit(1);

      if (!goal) throw new TRPCError({ code: "NOT_FOUND" });

      // Buscar gestor do colaborador
      const [employee] = await db
        .select()
        .from(employees)
        .where(eq(employees.id, goal.employeeId))
        .limit(1);

      if (!employee?.managerId) {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "Colaborador nÃ£o tem gestor definido",
        });
      }

      // Atualizar status da meta
      await db
        .update(smartGoals)
        .set({
          status: "pending_approval",
          approvalStatus: "pending_manager",
        })
        .where(eq(smartGoals.id, input.goalId));

      // Criar aprovaÃ§Ã£o para o gestor
      await db.insert(goalApprovals).values({
        goalId: input.goalId,
        approverId: employee.managerId,
        approverRole: "manager",
        status: "pending",
      });

      return { success: true };
    }),

  /**
   * Aprovar meta
   */
  approve: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        comments: z.string().optional(),
      })
    )
    .mutation(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR" });

      // Buscar aprovaÃ§Ã£o pendente
      const [approval] = await db
        .select()
        .from(goalApprovals)
        .where(
          and(
            eq(goalApprovals.goalId, input.goalId),
            eq(goalApprovals.approverId, ctx.user.id),
            eq(goalApprovals.status, "pending")
          )
        )
        .limit(1);

      if (!approval) {
        throw new TRPCError({
          code: "NOT_FOUND",
          message: "AprovaÃ§Ã£o nÃ£o encontrada",
        });
      }

      // Atualizar aprovaÃ§Ã£o
      await db
        .update(goalApprovals)
        .set({
          status: "approved",
          comments: input.comments,
          approvedAt: new Date(),
        })
        .where(eq(goalApprovals.id, approval.id));

      // Se for aprovaÃ§Ã£o do gestor, criar aprovaÃ§Ã£o para RH
      if (approval.approverRole === "manager") {
        await db
          .update(smartGoals)
          .set({ approvalStatus: "pending_hr" })
          .where(eq(smartGoals.id, input.goalId));

        // TODO: Buscar RH responsÃ¡vel e criar aprovaÃ§Ã£o
        // Por enquanto, aprovar automaticamente
        await db
          .update(smartGoals)
          .set({
            status: "approved",
            approvalStatus: "approved",
          })
          .where(eq(smartGoals.id, input.goalId));
      } else {
        // AprovaÃ§Ã£o final
        await db
          .update(smartGoals)
          .set({
            status: "approved",
            approvalStatus: "approved",
          })
          .where(eq(smartGoals.id, input.goalId));
      }

      return { success: true };
    }),

  /**
   * Rejeitar meta
   */
  reject: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        comments: z.string(),
      })
    )
    .mutation(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR" });

      // Buscar aprovaÃ§Ã£o pendente
      const [approval] = await db
        .select()
        .from(goalApprovals)
        .where(
          and(
            eq(goalApprovals.goalId, input.goalId),
            eq(goalApprovals.approverId, ctx.user.id),
            eq(goalApprovals.status, "pending")
          )
        )
        .limit(1);

      if (!approval) {
        throw new TRPCError({
          code: "NOT_FOUND",
          message: "AprovaÃ§Ã£o nÃ£o encontrada",
        });
      }

      // Atualizar aprovaÃ§Ã£o
      await db
        .update(goalApprovals)
        .set({
          status: "rejected",
          comments: input.comments,
          approvedAt: new Date(),
        })
        .where(eq(goalApprovals.id, approval.id));

      // Atualizar meta
      await db
        .update(smartGoals)
        .set({
          status: "rejected",
          approvalStatus: "rejected",
        })
        .where(eq(smartGoals.id, input.goalId));

      return { success: true };
    }),

  /**
   * Calcular bÃ´nus baseado em metas concluÃ­das
   */
  calculateBonus: protectedProcedure
    .input(
      z.object({
        employeeId: z.number(),
        cycleId: z.number(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return { totalBonus: 0, goals: [] };

      // Buscar metas elegÃ­veis para bÃ´nus
      const goals = await db
        .select()
        .from(smartGoals)
        .where(
          and(
            eq(smartGoals.employeeId, input.employeeId),
            eq(smartGoals.cycleId, input.cycleId),
            eq(smartGoals.bonusEligible, true),
            eq(smartGoals.status, "completed")
          )
        );

      let totalBonus = 0;
      const bonusDetails = goals.map((goal) => {
        const progress = goal.progress || 0;
        let bonus = 0;

        if (goal.bonusAmount) {
          // BÃ´nus fixo proporcional ao progresso
          bonus = (parseFloat(goal.bonusAmount) * progress) / 100;
        } else if (goal.bonusPercentage) {
          // BÃ´nus percentual (precisa do salÃ¡rio base)
          // TODO: Buscar salÃ¡rio do colaborador
          bonus = 0; // Implementar quando tiver salÃ¡rio
        }

        totalBonus += bonus;

        return {
          goalId: goal.id,
          title: goal.title,
          progress,
          bonusAmount: bonus,
        };
      });

      return {
        totalBonus,
        goals: bonusDetails,
      };
    }),

  /**
   * Vincular meta com PDI
   */
  linkToPDI: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        pdiPlanId: z.number(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR" });

      await db
        .update(smartGoals)
        .set({ pdiPlanId: input.pdiPlanId })
        .where(eq(smartGoals.id, input.goalId));

      return { success: true };
    }),

  /**
   * Adicionar comentÃ¡rio Ã  meta
   */
  addComment: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        comment: z.string(),
      })
    )
    .mutation(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR" });

      const [comment] = await db.insert(goalComments).values({
        goalId: input.goalId,
        authorId: ctx.user.id,
        comment: input.comment,
      });

      return { commentId: comment.insertId };
    }),

  /**
   * Dashboard de metas (KPIs e estatÃ­sticas)
   */
  getDashboard: protectedProcedure
    .input(z.object({ cycleId: z.number().optional() }))
    .query(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db)
        return {
          activeGoals: 0,
          completedGoals: 0,
          completionRate: 0,
          potentialBonus: 0,
        };

      // Buscar employee vinculado ao usuÃ¡rio
      const [employee] = await db
        .select()
        .from(employees)
        .where(eq(employees.userId, ctx.user.id))
        .limit(1);

      if (!employee)
        return {
          activeGoals: 0,
          completedGoals: 0,
          completionRate: 0,
          potentialBonus: 0,
        };

      const conditions = [eq(smartGoals.employeeId, employee.id)];
      if (input.cycleId) conditions.push(eq(smartGoals.cycleId, input.cycleId));

      const goals = await db
        .select()
        .from(smartGoals)
        .where(and(...conditions));

      const activeGoals = goals.filter((g) =>
        ["approved", "in_progress"].includes(g.status)
      ).length;
      const completedGoals = goals.filter((g) => g.status === "completed").length;
      const completionRate =
        goals.length > 0 ? (completedGoals / goals.length) * 100 : 0;

      // Calcular bÃ´nus potencial
      const bonusGoals = goals.filter((g) => g.bonusEligible);
      const potentialBonus = bonusGoals.reduce((sum, goal) => {
        if (goal.bonusAmount) {
          return sum + parseFloat(goal.bonusAmount);
        }
        return sum;
      }, 0);

      return {
        activeGoals,
        completedGoals,
        completionRate: Math.round(completionRate),
        potentialBonus,
        totalGoals: goals.length,
        byCategory: {
          financial: goals.filter((g) => g.category === "financial").length,
          behavioral: goals.filter((g) => g.category === "behavioral").length,
          corporate: goals.filter((g) => g.category === "corporate").length,
          development: goals.filter((g) => g.category === "development").length,
        },
        byStatus: {
          draft: goals.filter((g) => g.status === "draft").length,
          pending_approval: goals.filter((g) => g.status === "pending_approval")
            .length,
          approved: goals.filter((g) => g.status === "approved").length,
          in_progress: goals.filter((g) => g.status === "in_progress").length,
          completed: goals.filter((g) => g.status === "completed").length,
          rejected: goals.filter((g) => g.status === "rejected").length,
        },
      };
    }),

  /**
   * Atualizar meta (apenas em rascunho)
   */
  update: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        title: z.string().optional(),
        description: z.string().optional(),
        type: z.enum(["individual", "team", "organizational"]).optional(),
        category: z.enum(["financial", "behavioral", "corporate", "development"]).optional(),
        measurementUnit: z.string().optional(),
        targetValue: z.number().optional(),
        weight: z.number().optional(),
        startDate: z.string().optional(),
        endDate: z.string().optional(),
        bonusEligible: z.boolean().optional(),
        bonusPercentage: z.number().optional(),
        bonusAmount: z.number().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Verificar se meta existe e estÃ¡ em rascunho
      const [existingGoal] = await db
        .select()
        .from(smartGoals)
        .where(
          and(
            eq(smartGoals.id, input.goalId),
            eq(smartGoals.employeeId, ctx.user.id)
          )
        )
        .limit(1);

      if (!existingGoal) {
        throw new Error("Meta nÃ£o encontrada");
      }

      if (existingGoal.status !== "draft") {
        throw new Error("Apenas metas em rascunho podem ser editadas");
      }

      // Atualizar meta
      const updateData: any = {};
      if (input.title !== undefined) updateData.title = input.title;
      if (input.description !== undefined) updateData.description = input.description;
      if (input.type !== undefined) updateData.type = input.type;
      if (input.category !== undefined) updateData.category = input.category;
      if (input.measurementUnit !== undefined) updateData.measurementUnit = input.measurementUnit;
      if (input.targetValue !== undefined) updateData.targetValue = input.targetValue.toString();
      if (input.weight !== undefined) updateData.weight = input.weight;
      if (input.startDate !== undefined) updateData.startDate = new Date(input.startDate);
      if (input.endDate !== undefined) updateData.endDate = new Date(input.endDate);
      if (input.bonusEligible !== undefined) updateData.bonusEligible = input.bonusEligible;
      if (input.bonusPercentage !== undefined) updateData.bonusPercentage = input.bonusPercentage.toString();
      if (input.bonusAmount !== undefined) updateData.bonusAmount = input.bonusAmount.toString();

      await db
        .update(smartGoals)
        .set(updateData)
        .where(eq(smartGoals.id, input.goalId));

      return { success: true };
    }),

  /**
   * Exportar meta individual em PDF
   */
  exportPDF: protectedProcedure
    .input(z.object({ goalId: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar meta completa
      const [goal] = await db
        .select()
        .from(smartGoals)
        .where(
          and(
            eq(smartGoals.id, input.goalId),
            eq(smartGoals.employeeId, ctx.user.id)
          )
        )
        .limit(1);

      if (!goal) {
        throw new Error("Meta nÃ£o encontrada");
      }

      // Buscar marcos
      const milestones = await db
        .select()
        .from(goalMilestones)
        .where(eq(goalMilestones.goalId, input.goalId))
        .orderBy(goalMilestones.dueDate);

      // Buscar comentÃ¡rios
      const comments = await db
        .select()
        .from(goalComments)
        .where(eq(goalComments.goalId, input.goalId))
        .orderBy(desc(goalComments.createdAt));

      // Buscar informaÃ§Ãµes do colaborador
      const [employee] = await db
        .select()
        .from(employees)
        .where(eq(employees.id, goal.employeeId))
        .limit(1);

      // Buscar ciclo
      const [cycle] = await db
        .select()
        .from(evaluationCycles)
        .where(eq(evaluationCycles.id, goal.cycleId))
        .limit(1);

      const goalData = {
        ...goal,
        employeeName: employee?.name || "N/A",
        cycleName: cycle?.name || "N/A",
        milestones,
        comments,
      };

      // Gerar PDF
      const { generateGoalPDF } = await import("./utils/goalsPDF.js");
      const pdfBuffer = generateGoalPDF(goalData as any);

      // Retornar base64 para download no frontend
      return {
        filename: `meta-${goal.id}-${Date.now()}.pdf`,
        data: pdfBuffer.toString("base64"),
      };
    }),

  /**
   * Exportar relatÃ³rio consolidado de metas em PDF
   */
  exportConsolidatedPDF: protectedProcedure
    .input(
      z.object({
        cycleId: z.number().optional(),
        status: z
          .enum([
            "draft",
            "pending_approval",
            "approved",
            "rejected",
            "in_progress",
            "completed",
            "cancelled",
          ])
          .optional(),
        category: z
          .enum(["financial", "behavioral", "corporate", "development"])
          .optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar metas com filtros
      const conditions = [eq(smartGoals.employeeId, ctx.user.id)];

      if (input.cycleId) {
        conditions.push(eq(smartGoals.cycleId, input.cycleId));
      }
      if (input.status) {
        conditions.push(eq(smartGoals.status, input.status));
      }
      if (input.category) {
        conditions.push(eq(smartGoals.category, input.category));
      }

      const goals = await db
        .select()
        .from(smartGoals)
        .where(and(...conditions))
        .orderBy(desc(smartGoals.createdAt));

      if (goals.length === 0) {
        throw new Error("Nenhuma meta encontrada com os filtros selecionados");
      }

      // Buscar informaÃ§Ãµes do colaborador
      const [employee] = await db
        .select()
        .from(employees)
        .where(eq(employees.id, ctx.user.id))
        .limit(1);

      // Adicionar nome do colaborador em cada meta
      const goalsData = goals.map((g) => ({
        ...g,
        employeeName: employee?.name || "N/A",
      }));

      // Gerar PDF
      const { generateGoalsConsolidatedPDF } = await import("./utils/goalsPDF.js");
      const pdfBuffer = generateGoalsConsolidatedPDF(
        goalsData as any,
        `RelatÃ³rio de Metas - ${employee?.name || "Colaborador"}`
      );

      // Retornar base64 para download no frontend
      return {
        filename: `relatorio-metas-${ctx.user.id}-${Date.now()}.pdf`,
        data: pdfBuffer.toString("base64"),
      };
    }),

  /**
   * Calcular bÃ´nus total por colaborador/ciclo
   */
  calculateBonusTotal: protectedProcedure
    .input(
      z.object({
        employeeId: z.number().optional(),
        cycleId: z.number(),
      })
    )
    .query(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const targetEmployeeId = input.employeeId || ctx.user.id;

      // Buscar metas concluÃ­das e elegÃ­veis para bÃ´nus
      const goals = await db
        .select()
        .from(smartGoals)
        .where(
          and(
            eq(smartGoals.employeeId, targetEmployeeId),
            eq(smartGoals.cycleId, input.cycleId),
            eq(smartGoals.bonusEligible, true),
            eq(smartGoals.status, "completed")
          )
        );

      let totalBonusAmount = 0;
      let totalBonusPercentage = 0;
      const bonusDetails = [];

      for (const goal of goals) {
        const bonusAmount = goal.bonusAmount ? parseFloat(goal.bonusAmount) : 0;
        const bonusPercentage = goal.bonusPercentage
          ? parseFloat(goal.bonusPercentage)
          : 0;

        totalBonusAmount += bonusAmount;
        totalBonusPercentage += bonusPercentage;

        bonusDetails.push({
          goalId: goal.id,
          goalTitle: goal.title,
          bonusAmount,
          bonusPercentage,
          progress: goal.progress,
          weight: goal.weight,
        });
      }

      return {
        employeeId: targetEmployeeId,
        cycleId: input.cycleId,
        totalBonusAmount,
        totalBonusPercentage,
        eligibleGoals: goals.length,
        bonusDetails,
      };
    }),

  /**
   * Exportar planilha Excel de bÃ´nus para RH/Financeiro
   */
  exportBonusExcel: protectedProcedure
    .input(
      z.object({
        cycleId: z.number(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar todas as metas concluÃ­das e elegÃ­veis para bÃ´nus no ciclo
      const goals = await db
        .select({
          goalId: smartGoals.id,
          goalTitle: smartGoals.title,
          employeeId: smartGoals.employeeId,
          employeeName: employees.name,
          departmentId: employees.departmentId,
          bonusAmount: smartGoals.bonusAmount,
          bonusPercentage: smartGoals.bonusPercentage,
          progress: smartGoals.progress,
          weight: smartGoals.weight,
        })
        .from(smartGoals)
        .leftJoin(employees, eq(smartGoals.employeeId, employees.id))
        .where(
          and(
            eq(smartGoals.cycleId, input.cycleId),
            eq(smartGoals.bonusEligible, true),
            eq(smartGoals.status, "completed")
          )
        )
        .orderBy(employees.name);

      // Agrupar por colaborador
      const bonusByEmployee = new Map<number, any>();

      for (const goal of goals) {
        const empId = goal.employeeId;
        if (!bonusByEmployee.has(empId)) {
          bonusByEmployee.set(empId, {
            employeeId: empId,
            employeeName: goal.employeeName || "N/A",
            department: goal.departmentId?.toString() || "N/A",
            totalBonusAmount: 0,
            totalBonusPercentage: 0,
            goalsCount: 0,
            goals: [],
          });
        }

        const empData = bonusByEmployee.get(empId);
        const bonusAmount = goal.bonusAmount ? parseFloat(goal.bonusAmount) : 0;
        const bonusPercentage = goal.bonusPercentage
          ? parseFloat(goal.bonusPercentage)
          : 0;

        empData.totalBonusAmount += bonusAmount;
        empData.totalBonusPercentage += bonusPercentage;
        empData.goalsCount += 1;
        empData.goals.push({
          title: goal.goalTitle,
          bonusAmount,
          bonusPercentage,
        });
      }

      // Gerar Excel
      const { generateBonusExcel } = await import("./utils/bonusExcel.js");
      const excelBuffer = await generateBonusExcel(
        Array.from(bonusByEmployee.values()),
        input.cycleId
      );

      return {
        filename: `bonus-ciclo-${input.cycleId}-${Date.now()}.xlsx`,
        data: excelBuffer.toString("base64"),
      };
    }),

  // ==================== EVIDÃŠNCIAS DE METAS ====================

  /**
   * Upload de arquivo de evidÃªncia para S3
   */
  uploadEvidenceFile: protectedProcedure
    .input(
      z.object({
        fileName: z.string(),
        fileData: z.string(), // base64
        contentType: z.string(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const { storagePut } = await import("./storage");

      // Gerar chave Ãºnica para o arquivo
      const randomSuffix = Math.random().toString(36).substring(7);
      const fileKey = `evidences/${ctx.user.id}/${Date.now()}-${randomSuffix}-${input.fileName}`;

      // Converter base64 para Buffer
      const fileBuffer = Buffer.from(input.fileData, "base64");

      // Upload para S3
      const { url } = await storagePut(fileKey, fileBuffer, input.contentType);

      return {
        url,
        fileKey,
        success: true,
      };
    }),

  /**
   * Adicionar evidÃªncia a uma meta
   */
  addEvidence: protectedProcedure
    .input(
      z.object({
        goalId: z.number(),
        description: z.string(),
        attachmentUrl: z.string().optional(),
        attachmentName: z.string().optional(),
        attachmentType: z.string().optional(),
        attachmentSize: z.number().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { goalEvidences } = await import("../drizzle/schema");

      const result = await db.insert(goalEvidences).values({
        goalId: input.goalId,
        description: input.description,
        attachmentUrl: input.attachmentUrl || null,
        attachmentName: input.attachmentName || null,
        attachmentType: input.attachmentType || null,
        attachmentSize: input.attachmentSize || null,
        uploadedBy: ctx.user.id,
        isVerified: false,
      });

      return { id: Number((result as any).insertId), success: true };
    }),

  /**
   * Listar evidÃªncias de uma meta
   */
  listEvidences: protectedProcedure
    .input(z.object({ goalId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { goalEvidences } = await import("../drizzle/schema");

      const evidences = await db
        .select()
        .from(goalEvidences)
        .where(eq(goalEvidences.goalId, input.goalId))
        .orderBy(desc(goalEvidences.uploadedAt));

      return evidences;
    }),

  /**
   * Verificar evidÃªncia (para auditoria)
   */
  verifyEvidence: protectedProcedure
    .input(
      z.object({
        evidenceId: z.number(),
        isVerified: z.boolean(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { goalEvidences } = await import("../drizzle/schema");

      await db
        .update(goalEvidences)
        .set({
          isVerified: input.isVerified,
          verifiedBy: ctx.user.id,
          verifiedAt: new Date(),
        })
        .where(eq(goalEvidences.id, input.evidenceId));

      return { success: true };
    }),

  /**
   * Deletar evidÃªncia
   */
  deleteEvidence: protectedProcedure
    .input(z.object({ evidenceId: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { goalEvidences } = await import("../drizzle/schema");

      await db.delete(goalEvidences).where(eq(goalEvidences.id, input.evidenceId));

      return { success: true };
    }),

  /**
   * Obter analytics de metas
   */
  getAnalytics: protectedProcedure
    .input(
      z.object({
        period: z.number().default(30),
        departmentId: z.number().optional(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { smartGoals, employees, departments } = await import("../drizzle/schema");
      const { sql, and, gte, eq } = await import("drizzle-orm");

      const periodStart = new Date();
      periodStart.setDate(periodStart.getDate() - input.period);

      // Buscar todas as metas do perÃ­odo
      const allGoals = await db
        .select()
        .from(smartGoals)
        .leftJoin(employees, eq(smartGoals.employeeId, employees.id))
        .where(gte(smartGoals.createdAt, periodStart));

      // Filtrar por departamento se especificado
      const filteredGoals = input.departmentId
        ? allGoals.filter((g) => g.employees?.departmentId === input.departmentId)
        : allGoals;

      const totalGoals = filteredGoals.length;
      const completedGoals = filteredGoals.filter(
        (g) => g.smartGoals.status === "completed"
      ).length;
      const inProgressGoals = filteredGoals.filter(
        (g) => g.smartGoals.status === "in_progress"
      ).length;
      const overdueGoals = filteredGoals.filter(
        (g) =>
          g.smartGoals.endDate < new Date() && g.smartGoals.status !== "completed"
      ).length;
      const approvedGoals = filteredGoals.filter(
        (g) => g.smartGoals.approvalStatus === "approved"
      ).length;
      const approvalRate = totalGoals > 0 ? (approvedGoals / totalGoals) * 100 : 0;

      // Tempo mÃ©dio de conclusÃ£o
      const completedWithTime = filteredGoals.filter(
        (g) => g.smartGoals.status === "completed" && g.smartGoals.completedAt
      );
      const avgCompletionTime =
        completedWithTime.length > 0
          ? Math.round(
              completedWithTime.reduce((sum, g) => {
                const start = new Date(g.smartGoals.startDate).getTime();
                const end = new Date(g.smartGoals.completedAt!).getTime();
                return sum + (end - start) / (1000 * 60 * 60 * 24);
              }, 0) / completedWithTime.length
            )
          : 0;

      // TendÃªncias semanais
      const trends = [];
      for (let i = 0; i < 4; i++) {
        const weekStart = new Date();
        weekStart.setDate(weekStart.getDate() - (i + 1) * 7);
        const weekEnd = new Date();
        weekEnd.setDate(weekEnd.getDate() - i * 7);

        const weekGoals = filteredGoals.filter(
          (g) =>
            new Date(g.smartGoals.createdAt) >= weekStart &&
            new Date(g.smartGoals.createdAt) < weekEnd
        );
        const weekCompleted = weekGoals.filter(
          (g) => g.smartGoals.status === "completed"
        ).length;

        trends.unshift({
          period: `Semana ${4 - i}`,
          total: weekGoals.length,
          completed: weekCompleted,
        });
      }

      // Performance por departamento
      const deptMap = new Map<number, any>();
      filteredGoals.forEach((g) => {
        if (!g.employees?.departmentId) return;
        const deptId = g.employees.departmentId;
        if (!deptMap.has(deptId)) {
          deptMap.set(deptId, {
            departmentId: deptId,
            departmentName: "",
            totalGoals: 0,
            completed: 0,
            approved: 0,
          });
        }
        const dept = deptMap.get(deptId)!;
        dept.totalGoals++;
        if (g.smartGoals.status === "completed") dept.completed++;
        if (g.smartGoals.approvalStatus === "approved") dept.approved++;
      });

      // Buscar nomes dos departamentos
      const deptIds = Array.from(deptMap.keys());
      if (deptIds.length > 0) {
        const deptNames = await db
          .select({ id: departments.id, name: departments.name })
          .from(departments);

        deptNames.forEach((d) => {
          const dept = deptMap.get(d.id);
          if (dept) dept.departmentName = d.name;
        });
      }

      const byDepartment = Array.from(deptMap.values()).map((d) => ({
        ...d,
        approvalRate: d.totalGoals > 0 ? (d.approved / d.totalGoals) * 100 : 0,
        completionRate: d.totalGoals > 0 ? (d.completed / d.totalGoals) * 100 : 0,
      }));

      // Performance por categoria
      const catMap = new Map<string, any>();
      filteredGoals.forEach((g) => {
        const cat = g.smartGoals.category || "Outros";
        if (!catMap.has(cat)) {
          catMap.set(cat, { category: cat, totalGoals: 0, totalDays: 0 });
        }
        const catData = catMap.get(cat)!;
        catData.totalGoals++;
        if (g.smartGoals.status === "completed" && g.smartGoals.completedAt) {
          const start = new Date(g.smartGoals.startDate).getTime();
          const end = new Date(g.smartGoals.completedAt).getTime();
          catData.totalDays += (end - start) / (1000 * 60 * 60 * 24);
        }
      });

      const byCategory = Array.from(catMap.values()).map((c) => ({
        category: c.category,
        totalGoals: c.totalGoals,
        avgDays: c.totalGoals > 0 ? Math.round(c.totalDays / c.totalGoals) : 0,
      }));

      return {
        stats: {
          totalGoals,
          completedGoals,
          inProgressGoals,
          overdueGoals,
          approvalRate,
          avgCompletionTime,
        },
        trends,
        byDepartment,
        byCategory,
      };
    }),
});


========================================
ARQUIVO: ./server/integrationsRouter.ts
========================================
import { z } from "zod";
import { router, protectedProcedure, adminProcedure } from "./_core/trpc";
import { getDb } from "./db";
import { eq } from "drizzle-orm";
import {
  sendTeamsNotification,
  sendSlackNotification,
  createGoogleMeetMeeting,
} from "./utils/externalIntegrations";

/**
 * Router de IntegraÃ§Ãµes Externas
 * Microsoft Teams, Slack e Google Meet
 */

export const integrationsRouter = router({
  /**
   * Testar integraÃ§Ã£o com Microsoft Teams
   */
  testTeams: adminProcedure
    .input(
      z.object({
        webhookUrl: z.string().url(),
      })
    )
    .mutation(async ({ input }) => {
      const success = await sendTeamsNotification(input.webhookUrl, {
        title: "ðŸŽ‰ Teste de IntegraÃ§Ã£o",
        message: "IntegraÃ§Ã£o com Microsoft Teams configurada com sucesso!",
      });

      return { success };
    }),

  /**
   * Testar integraÃ§Ã£o com Slack
   */
  testSlack: adminProcedure
    .input(
      z.object({
        webhookUrl: z.string().url(),
        channel: z.string(),
      })
    )
    .mutation(async ({ input }) => {
      const success = await sendSlackNotification(input.webhookUrl, {
        channel: input.channel,
        message: "ðŸŽ‰ *Teste de IntegraÃ§Ã£o*\n\nIntegraÃ§Ã£o com Slack configurada com sucesso!",
      });

      return { success };
    }),

  /**
   * Criar reuniÃ£o no Google Meet
   */
  createMeeting: protectedProcedure
    .input(
      z.object({
        accessToken: z.string(),
        summary: z.string(),
        description: z.string(),
        startTime: z.date(),
        endTime: z.date(),
        attendees: z.array(z.string().email()),
      })
    )
    .mutation(async ({ input }) => {
      const result = await createGoogleMeetMeeting(input.accessToken, {
        summary: input.summary,
        description: input.description,
        startTime: input.startTime,
        endTime: input.endTime,
        attendees: input.attendees,
      });

      if (!result) {
        throw new Error("Falha ao criar reuniÃ£o no Google Meet");
      }

      return result;
    }),

  /**
   * Salvar configuraÃ§Ãµes de integraÃ§Ã£o
   */
  saveConfig: adminProcedure
    .input(
      z.object({
        teamsWebhookUrl: z.string().url().optional(),
        slackWebhookUrl: z.string().url().optional(),
        slackChannel: z.string().optional(),
        googleMeetEnabled: z.boolean().default(false),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { systemSettings } = await import("../drizzle/schema");

      // Salvar configuraÃ§Ãµes no systemSettings
      const configs = [
        { settingKey: "teams_webhook_url", settingValue: input.teamsWebhookUrl || "" },
        { settingKey: "slack_webhook_url", settingValue: input.slackWebhookUrl || "" },
        { settingKey: "slack_channel", settingValue: input.slackChannel || "" },
        { settingKey: "google_meet_enabled", settingValue: input.googleMeetEnabled ? "true" : "false" },
      ];

      for (const config of configs) {
        const existing = await db
          .select()
          .from(systemSettings)
          .where(eq(systemSettings.settingKey, config.settingKey))
          .limit(1);

        if (existing.length > 0) {
          await db
            .update(systemSettings)
            .set({ settingValue: config.settingValue, updatedAt: new Date() })
            .where(eq(systemSettings.settingKey, config.settingKey));
        } else {
          await db.insert(systemSettings).values({
            settingKey: config.settingKey,
            settingValue: config.settingValue,
            description: `ConfiguraÃ§Ã£o de ${config.settingKey}`,
          });
        }
      }

      return { success: true };
    }),

  /**
   * Obter configuraÃ§Ãµes de integraÃ§Ã£o
   */
  getConfig: adminProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const { systemSettings } = await import("../drizzle/schema");

    const settingKeys = ["teams_webhook_url", "slack_webhook_url", "slack_channel", "google_meet_enabled"];
    const config: any = {};

    for (const key of settingKeys) {
      const [setting] = await db
        .select()
        .from(systemSettings)
        .where(eq(systemSettings.settingKey, key))
        .limit(1);

      if (setting) {
        config[key] = setting.settingValue;
      }
    }

    return {
      teamsWebhookUrl: config.teams_webhook_url || "",
      slackWebhookUrl: config.slack_webhook_url || "",
      slackChannel: config.slack_channel || "",
      googleMeetEnabled: config.google_meet_enabled === "true",
    };
  }),

  /**
   * Enviar notificaÃ§Ã£o de teste
   */
  sendTestNotification: adminProcedure
    .input(
      z.object({
        platform: z.enum(["teams", "slack"]),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { systemSettings } = await import("../drizzle/schema");

      if (input.platform === "teams") {
        const [setting] = await db
          .select()
          .from(systemSettings)
          .where(eq(systemSettings.settingKey, "teams_webhook_url"))
          .limit(1);

        if (!setting || !setting.settingValue) {
          throw new Error("Webhook do Teams nÃ£o configurado");
        }

        const success = await sendTeamsNotification(setting.settingValue, {
          title: "ðŸ”” NotificaÃ§Ã£o de Teste",
          message: "Esta Ã© uma notificaÃ§Ã£o de teste do Sistema AVD UISA.",
        });

        return { success };
      } else {
        const [webhookSetting] = await db
          .select()
          .from(systemSettings)
          .where(eq(systemSettings.settingKey, "slack_webhook_url"))
          .limit(1);

        const [channelSetting] = await db
          .select()
          .from(systemSettings)
          .where(eq(systemSettings.settingKey, "slack_channel"))
          .limit(1);

        if (!webhookSetting || !webhookSetting.settingValue) {
          throw new Error("Webhook do Slack nÃ£o configurado");
        }

        const success = await sendSlackNotification(webhookSetting.settingValue, {
          channel: channelSetting?.settingValue || "#geral",
          message: "ðŸ”” *NotificaÃ§Ã£o de Teste*\n\nEsta Ã© uma notificaÃ§Ã£o de teste do Sistema AVD UISA.",
        });

        return { success };
      }
    }),
});


========================================
ARQUIVO: ./server/jobDescriptions.test.ts
========================================
import { describe, it, expect } from 'vitest';
import { getDb } from './db';
import { jobDescriptions, jobResponsibilities, jobKnowledge, jobCompetencies, employeeActivities } from '../drizzle/schema';

describe('Job Descriptions Database', () => {
  it('deve conectar ao banco de dados', async () => {
    const db = await getDb();
    expect(db).toBeDefined();
  });

  it('deve ter as tabelas necessÃ¡rias criadas', async () => {
    const db = await getDb();
    if (!db) throw new Error('Database not available');

    // Verificar se as tabelas existem fazendo uma query simples
    const jobDescsResult = await db.select().from(jobDescriptions).limit(1);
    expect(Array.isArray(jobDescsResult)).toBe(true);

    const responsibilitiesResult = await db.select().from(jobResponsibilities).limit(1);
    expect(Array.isArray(responsibilitiesResult)).toBe(true);

    const knowledgeResult = await db.select().from(jobKnowledge).limit(1);
    expect(Array.isArray(knowledgeResult)).toBe(true);

    const competenciesResult = await db.select().from(jobCompetencies).limit(1);
    expect(Array.isArray(competenciesResult)).toBe(true);

    const activitiesResult = await db.select().from(employeeActivities).limit(1);
    expect(Array.isArray(activitiesResult)).toBe(true);
  });
});


========================================
ARQUIVO: ./server/jobs/notificationCron.ts
========================================
import { CronJob } from "cron";
import { getDb } from "../db";
import { goals, performanceEvaluations, pdiPlans, employees, users } from "../../drizzle/schema";
import { and, eq, lt, lte, sql } from "drizzle-orm";
import { notifyOwner } from "../_core/notification";

/**
 * Cron Job para NotificaÃ§Ãµes AutomÃ¡ticas
 * Executa diariamente Ã s 9h para verificar:
 * - Metas prÃ³ximas do vencimento (< 7 dias)
 * - AvaliaÃ§Ãµes 360Â° pendentes
 * - PDIs sem atualizaÃ§Ã£o hÃ¡ mais de 30 dias
 */

export function startNotificationCron() {
  // Executar todos os dias Ã s 9h (horÃ¡rio do servidor)
  const job = new CronJob(
    "0 0 9 * * *", // Segundos Minutos Horas Dia MÃªs DiaDaSemana
    async () => {
      console.log("[Cron] Executando verificaÃ§Ã£o de notificaÃ§Ãµes automÃ¡ticas...");
      
      try {
        const db = await getDb();
        if (!db) {
          console.error("[Cron] Database not available");
          return;
        }

        // 1. Verificar metas prÃ³ximas do vencimento (< 7 dias)
        const sevenDaysFromNow = new Date();
        sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
        
        const expiringGoals = await db
          .select({
            goalId: goals.id,
            goalTitle: goals.title,
            endDate: goals.endDate,
            employeeName: employees.name,
            employeeEmail: employees.email,
          })
          .from(goals)
          .leftJoin(employees, eq(goals.employeeId, employees.id))
          .where(
            and(
              eq(goals.status, "em_andamento"),
              lte(goals.endDate, sevenDaysFromNow)
            )
          );

        if (expiringGoals.length > 0) {
          const message = `âš ï¸ **${expiringGoals.length} metas prÃ³ximas do vencimento**\n\n` +
            expiringGoals.map(g => 
              `- ${g.goalTitle} (${g.employeeName}) - Vence em: ${new Date(g.endDate!).toLocaleDateString('pt-BR')}`
            ).join('\n');
          
          await notifyOwner({
            title: "Alerta: Metas PrÃ³ximas do Vencimento",
            content: message,
          });
          console.log(`[Cron] NotificaÃ§Ã£o enviada: ${expiringGoals.length} metas prÃ³ximas do vencimento`);
        }

        // 2. Verificar avaliaÃ§Ãµes 360Â° pendentes
        const pendingEvaluations = await db
          .select({
            evalId: performanceEvaluations.id,
            employeeName: employees.name,
            cycleId: performanceEvaluations.cycleId,
            createdAt: performanceEvaluations.createdAt,
          })
          .from(performanceEvaluations)
          .leftJoin(employees, eq(performanceEvaluations.employeeId, employees.id))
          .where(eq(performanceEvaluations.status, "pendente"));

        if (pendingEvaluations.length > 0) {
          const message = `ðŸ“‹ **${pendingEvaluations.length} avaliaÃ§Ãµes 360Â° pendentes**\n\n` +
            pendingEvaluations.slice(0, 10).map(e => 
              `- ${e.employeeName} - Criada em: ${new Date(e.createdAt!).toLocaleDateString('pt-BR')}`
            ).join('\n') +
            (pendingEvaluations.length > 10 ? `\n\n... e mais ${pendingEvaluations.length - 10} avaliaÃ§Ãµes` : '');
          
          await notifyOwner({
            title: "Alerta: AvaliaÃ§Ãµes 360Â° Pendentes",
            content: message,
          });
          console.log(`[Cron] NotificaÃ§Ã£o enviada: ${pendingEvaluations.length} avaliaÃ§Ãµes pendentes`);
        }

        // 3. Verificar PDIs sem atualizaÃ§Ã£o hÃ¡ mais de 30 dias
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const stalePDIs = await db
          .select({
            pdiId: pdiPlans.id,
            employeeName: employees.name,
            employeeEmail: employees.email,
            updatedAt: pdiPlans.updatedAt,
          })
          .from(pdiPlans)
          .leftJoin(employees, eq(pdiPlans.employeeId, employees.id))
          .where(
            and(
              eq(pdiPlans.status, "em_andamento"),
              lt(pdiPlans.updatedAt, thirtyDaysAgo)
            )
          );

        if (stalePDIs.length > 0) {
          const message = `ðŸ“ **${stalePDIs.length} PDIs sem atualizaÃ§Ã£o hÃ¡ mais de 30 dias**\n\n` +
            stalePDIs.slice(0, 10).map(p => 
              `- ${p.employeeName} - Ãšltima atualizaÃ§Ã£o: ${new Date(p.updatedAt!).toLocaleDateString('pt-BR')}`
            ).join('\n') +
            (stalePDIs.length > 10 ? `\n\n... e mais ${stalePDIs.length - 10} PDIs` : '');
          
          await notifyOwner({
            title: "Alerta: PDIs Sem AtualizaÃ§Ã£o",
            content: message,
          });
          console.log(`[Cron] NotificaÃ§Ã£o enviada: ${stalePDIs.length} PDIs sem atualizaÃ§Ã£o`);
        }

        console.log("[Cron] VerificaÃ§Ã£o de notificaÃ§Ãµes concluÃ­da com sucesso");
      } catch (error) {
        console.error("[Cron] Erro ao executar verificaÃ§Ã£o de notificaÃ§Ãµes:", error);
      }
    },
    null,
    true,
    "America/Sao_Paulo" // Timezone de SÃ£o Paulo
  );

  console.log("[Cron] Job de notificaÃ§Ãµes automÃ¡ticas iniciado (executa diariamente Ã s 9h)");
  return job;
}


========================================
ARQUIVO: ./server/jobs/calculateDiscrepancies.ts
========================================
import { getDb } from "../db";
import { timeClockRecords, employeeActivities, timeDiscrepancies, alerts, employees } from "../../drizzle/schema";
import { eq, and, gte, lte, sql } from "drizzle-orm";

/**
 * Job agendado para calcular discrepÃ¢ncias entre ponto e atividades
 * Roda diariamente Ã s 6h da manhÃ£
 */

export async function calculateDailyDiscrepancies() {
  console.log("[Job] Iniciando cÃ¡lculo de discrepÃ¢ncias...");
  
  const db = await getDb();
  if (!db) {
    console.error("[Job] Database nÃ£o disponÃ­vel");
    return {
      success: false,
      error: "Database not available",
    };
  }
  
  try {
    // Calcular discrepÃ¢ncias do dia anterior
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    yesterday.setHours(0, 0, 0, 0);
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    console.log(`[Job] Calculando discrepÃ¢ncias de ${yesterday.toISOString()} atÃ© ${today.toISOString()}`);
    
    // Buscar registros de ponto do dia anterior
    const clockRecords = await db
      .select()
      .from(timeClockRecords)
      .where(
        and(
          gte(timeClockRecords.date, yesterday),
          lte(timeClockRecords.date, today)
        )
      );
    
    console.log(`[Job] Encontrados ${clockRecords.length} registros de ponto`);
    
    let discrepanciesCreated = 0;
    let alertsCreated = 0;
    const errors: string[] = [];
    
    for (const clockRecord of clockRecords) {
      try {
        // Buscar atividades do mesmo dia
        const dayStart = new Date(clockRecord.date);
        dayStart.setHours(0, 0, 0, 0);
        const dayEnd = new Date(clockRecord.date);
        dayEnd.setHours(23, 59, 59, 999);
        
        const activities = await db
          .select()
          .from(employeeActivities)
          .where(
            and(
              eq(employeeActivities.employeeId, clockRecord.employeeId),
              gte(employeeActivities.activityDate, dayStart),
              lte(employeeActivities.activityDate, dayEnd)
            )
          );
        
        // Calcular total de minutos de atividades
        const activityMinutes = activities.reduce((sum, act) => sum + (act.durationMinutes || 0), 0);
        const clockMinutes = clockRecord.workedMinutes || 0;
        
        // Pular se nÃ£o houver dados suficientes
        if (clockMinutes === 0) {
          continue;
        }
        
        // Calcular diferenÃ§a
        const differenceMinutes = clockMinutes - activityMinutes;
        const differencePercentage = clockMinutes > 0 ? (Math.abs(differenceMinutes) / clockMinutes) * 100 : 0;
        
        // Classificar discrepÃ¢ncia
        let discrepancyType: "over_reported" | "under_reported" | "acceptable";
        if (differencePercentage < 10) {
          discrepancyType = "acceptable";
        } else if (differenceMinutes < 0) {
          discrepancyType = "over_reported"; // Mais atividades que ponto
        } else {
          discrepancyType = "under_reported"; // Menos atividades que ponto
        }
        
        // Verificar se jÃ¡ existe discrepÃ¢ncia para este dia/colaborador
        const existing = await db
          .select()
          .from(timeDiscrepancies)
          .where(
            and(
              eq(timeDiscrepancies.employeeId, clockRecord.employeeId),
              eq(timeDiscrepancies.date, clockRecord.date)
            )
          )
          .limit(1);
        
        if (existing.length > 0) {
          console.log(`[Job] DiscrepÃ¢ncia jÃ¡ existe para colaborador ${clockRecord.employeeId} em ${clockRecord.date.toISOString()}`);
          continue;
        }
        
        // Criar registro de discrepÃ¢ncia
        await db.insert(timeDiscrepancies).values({
          employeeId: clockRecord.employeeId,
          date: clockRecord.date,
          clockMinutes,
          activityMinutes,
          differenceMinutes,
          differencePercentage: differencePercentage.toFixed(2),
          discrepancyType,
          status: "pending",
        });
        
        discrepanciesCreated++;
        
        // Criar alerta se discrepÃ¢ncia > 20%
        if (differencePercentage > 20) {
          const [employee] = await db
            .select()
            .from(employees)
            .where(eq(employees.id, clockRecord.employeeId))
            .limit(1);
          
          if (employee) {
            // Verificar se jÃ¡ existe alerta para este dia/colaborador
            const existingAlert = await db
              .select()
              .from(alerts)
              .where(
                and(
                  eq(alerts.employeeId, clockRecord.employeeId),
                  eq(alerts.type, "time_discrepancy"),
                  gte(alerts.createdAt, dayStart),
                  lte(alerts.createdAt, dayEnd)
                )
              )
              .limit(1);
            
            if (existingAlert.length === 0) {
              await db.insert(alerts).values({
                employeeId: clockRecord.employeeId,
                type: "time_discrepancy",
                severity: differencePercentage > 50 ? "critical" : differencePercentage > 30 ? "high" : "medium",
                title: `DiscrepÃ¢ncia de ${differencePercentage.toFixed(0)}% entre ponto e atividades`,
                description: `Colaborador ${employee.name} apresentou ${clockMinutes} minutos no ponto mas registrou apenas ${activityMinutes} minutos em atividades no dia ${clockRecord.date.toLocaleDateString()}.`,
                metrics: JSON.stringify({
                  clockMinutes,
                  activityMinutes,
                  differenceMinutes,
                  differencePercentage,
                }),
                status: "active",
              });
              
              alertsCreated++;
            }
          }
        }
      } catch (error) {
        const errorMsg = `Erro ao processar colaborador ${clockRecord.employeeId}: ${error instanceof Error ? error.message : String(error)}`;
        console.error(`[Job] ${errorMsg}`);
        errors.push(errorMsg);
      }
    }
    
    const summary = {
      success: true,
      recordsAnalyzed: clockRecords.length,
      discrepanciesCreated,
      alertsCreated,
      errors,
      timestamp: new Date().toISOString(),
    };
    
    console.log("[Job] CÃ¡lculo de discrepÃ¢ncias concluÃ­do:", summary);
    
    return summary;
  } catch (error) {
    const errorMsg = `Erro geral no job: ${error instanceof Error ? error.message : String(error)}`;
    console.error(`[Job] ${errorMsg}`);
    return {
      success: false,
      error: errorMsg,
      timestamp: new Date().toISOString(),
    };
  }
}




========================================
ARQUIVO: ./server/jobs/sendPulseEmails.ts
========================================
import { getDb } from "../db";
import { pulseSurveys, pulseSurveyEmailLogs, employees } from "../../drizzle/schema";
import { eq, and, lt, or, isNull, sql } from "drizzle-orm";
import { emailService } from "../utils/emailService";

/**
 * Job para envio automÃ¡tico de e-mails de Pesquisas Pulse
 * Executa a cada 8 horas e envia e-mails para funcionÃ¡rios que ainda nÃ£o responderam
 */
export async function sendPulseEmailsJob() {
  console.log("[Pulse Job] Iniciando envio de e-mails de pesquisas Pulse...");
  
  const db = await getDb();
  if (!db) {
    console.error("[Pulse Job] Database not available");
    return;
  }

  try {
    const now = new Date();
    
    // Buscar pesquisas ativas que ainda nÃ£o expiraram
    const activeSurveys = await db
      .select()
      .from(pulseSurveys)
      .where(
        and(
          eq(pulseSurveys.status, "active"),
          or(
            isNull(pulseSurveys.closedAt),
            sql`${pulseSurveys.closedAt} > ${now}`
          )
        )
      );

    console.log(`[Pulse Job] ${activeSurveys.length} pesquisas ativas encontradas`);

    for (const survey of activeSurveys) {
      await sendSurveyEmails(survey);
    }

    console.log("[Pulse Job] Envio de e-mails concluÃ­do");
  } catch (error) {
    console.error("[Pulse Job] Erro ao enviar e-mails:", error);
  }
}

async function sendSurveyEmails(survey: any) {
  const db = await getDb();
  if (!db) return;

  console.log(`[Pulse Job] Processando pesquisa: ${survey.title}`);

  // Determinar pÃºblico-alvo
  let targetEmployees: any[] = [];

  if (survey.targetEmployeeIds && Array.isArray(survey.targetEmployeeIds) && survey.targetEmployeeIds.length > 0) {
    // Enviar para IDs especÃ­ficos
    targetEmployees = await db
      .select()
      .from(employees)
      .where(
        sql`${employees.id} IN (${sql.join(survey.targetEmployeeIds.map((id: number) => sql`${id}`), sql`, `)})`
      );
  } else if (survey.targetDepartmentId) {
    // Enviar para departamento especÃ­fico
    targetEmployees = await db
      .select()
      .from(employees)
      .where(eq(employees.departmentId, survey.targetDepartmentId));
  } else {
    // Enviar para todos os funcionÃ¡rios ativos
    targetEmployees = await db
      .select()
      .from(employees)
      .where(eq(employees.status, "ativo"));
  }

  console.log(`[Pulse Job] ${targetEmployees.length} funcionÃ¡rios no pÃºblico-alvo`);

  // Buscar logs de envio existentes
  const existingLogs = await db
    .select()
    .from(pulseSurveyEmailLogs)
    .where(eq(pulseSurveyEmailLogs.surveyId, survey.id));

  const sentEmployeeIds = new Set(
    existingLogs
      .filter(log => log.status === "sent")
      .map(log => log.employeeId)
  );

  // Filtrar funcionÃ¡rios que ainda nÃ£o receberam ou que falharam
  const employeesToSend = targetEmployees.filter(emp => {
    if (!emp.email) return false;
    
    // Se jÃ¡ foi enviado com sucesso, nÃ£o enviar novamente
    if (sentEmployeeIds.has(emp.id)) return false;
    
    // Verificar se houve falha recente (menos de 8 horas atrÃ¡s)
    const failedLog = existingLogs.find(
      log => log.employeeId === emp.id && log.status === "failed"
    );
    
    if (failedLog && failedLog.lastAttemptAt) {
      const hoursSinceLastAttempt = (Date.now() - new Date(failedLog.lastAttemptAt).getTime()) / (1000 * 60 * 60);
      if (hoursSinceLastAttempt < 8) {
        return false; // NÃ£o tentar novamente se falhou hÃ¡ menos de 8h
      }
    }
    
    return true;
  });

  console.log(`[Pulse Job] ${employeesToSend.length} e-mails para enviar`);

  let successCount = 0;
  let failCount = 0;

  for (const employee of employeesToSend) {
    try {
      // Gerar link da pesquisa
      const surveyLink = `${process.env.VITE_APP_URL || "http://localhost:3000"}/pesquisas-pulse/${survey.id}/responder`;

      // Enviar e-mail
      const emailHtml = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h2 style="color: #333;">OlÃ¡, ${employee.name}!</h2>
          <p style="color: #666; line-height: 1.6;">
            VocÃª foi convidado(a) a participar da pesquisa: <strong>${survey.title}</strong>
          </p>
          <p style="color: #666; line-height: 1.6;">
            ${survey.description || "Sua opiniÃ£o Ã© muito importante para nÃ³s!"}
          </p>
          <div style="background-color: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <p style="color: #333; margin: 0; font-weight: bold;">Pergunta:</p>
            <p style="color: #666; margin: 10px 0 0 0;">${survey.question}</p>
          </div>
          <div style="text-align: center; margin: 30px 0;">
            <a href="${surveyLink}" 
               style="background-color: #007bff; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;">
              Responder Agora
            </a>
          </div>
          <p style="color: #999; font-size: 12px; margin-top: 30px;">
            ${survey.closedAt ? `Esta pesquisa estarÃ¡ disponÃ­vel atÃ© ${new Date(survey.closedAt).toLocaleDateString("pt-BR")}.` : ""}
          </p>
        </div>
      `;
      
      await emailService.sendCustomEmail(employee.email, `ðŸ“Š ${survey.title}`, emailHtml);

      // Registrar sucesso
      await db.insert(pulseSurveyEmailLogs).values({
        surveyId: survey.id,
        employeeId: employee.id,
        email: employee.email,
        status: "sent",
        attemptCount: 1,
        lastAttemptAt: new Date(),
        sentAt: new Date(),
      });

      successCount++;
      console.log(`[Pulse Job] E-mail enviado para ${employee.email}`);
    } catch (error: any) {
      // Registrar falha
      await db.insert(pulseSurveyEmailLogs).values({
        surveyId: survey.id,
        employeeId: employee.id,
        email: employee.email,
        status: "failed",
        attemptCount: 1,
        lastAttemptAt: new Date(),
        errorMessage: error.message || "Erro desconhecido",
      });

      failCount++;
      console.error(`[Pulse Job] Erro ao enviar e-mail para ${employee.email}:`, error.message);
    }

    // Aguardar 100ms entre envios para nÃ£o sobrecarregar
    await new Promise(resolve => setTimeout(resolve, 100));
  }

  console.log(`[Pulse Job] Pesquisa ${survey.title}: ${successCount} enviados, ${failCount} falhas`);
}


========================================
ARQUIVO: ./server/nineBoxRouter.ts
========================================
import { z } from "zod";
import { desc, eq, and, sql, inArray } from "drizzle-orm";
import { getDb } from "./db";
import { 
  nineBoxPositions,
  employees,
  positions,
  departments
} from "../drizzle/schema";
import { protectedProcedure, router } from "./_core/trpc";

/**
 * Nine Box Router
 * Endpoints para anÃ¡lise comparativa de Nine Box por funÃ§Ã£o/cargo
 */

export const nineBoxRouter = router({
  // AnÃ¡lise comparativa por funÃ§Ã£o/cargo
  getComparative: protectedProcedure
    .input(
      z.object({
        positionIds: z.array(z.number()).optional(),
        departmentId: z.number().optional(),
        leaderId: z.number().optional(),
        hierarchyLevel: z.enum(["all", "diretoria", "gerencia", "coordenacao", "supervisao", "outros"]).optional(),
      })
    )
    .query(async ({ input }) => {
      const database = await getDb();
      if (!database) return [];

      // Se filtro por lÃ­der, buscar subordinados diretos
      let employeeIdsFilter: number[] | undefined;
      if (input.leaderId) {
        const subordinates = await database
          .select({ id: employees.id })
          .from(employees)
          .where(eq(employees.managerId, input.leaderId));
        employeeIdsFilter = subordinates.map(s => s.id);
      }

      // Se filtro por nÃ­vel hierÃ¡rquico, buscar colaboradores por contagem de subordinados
      if (input.hierarchyLevel && input.hierarchyLevel !== "all") {
        const allEmployees = await database.execute(sql`
          SELECT 
            e.id,
            COUNT(DISTINCT sub.id) as subordinatesCount
          FROM employees e
          LEFT JOIN employees sub ON sub.managerId = e.id
          GROUP BY e.id
        `);

        const filtered = (allEmployees as any[]).filter((emp: any) => {
          const count = Number(emp.subordinatesCount) || 0;
          switch (input.hierarchyLevel) {
            case "diretoria": return count > 10;
            case "gerencia": return count >= 5 && count <= 10;
            case "coordenacao": return count >= 2 && count <= 4;
            case "supervisao": return count === 1;
            case "outros": return count === 0;
            default: return true;
          }
        });

        const filteredIds = filtered.map((e: any) => Number(e.id));
        
        // Combinar com filtro existente de lÃ­der (se houver)
        if (employeeIdsFilter && employeeIdsFilter.length > 0) {
          employeeIdsFilter = employeeIdsFilter.filter(id => filteredIds.includes(id));
        } else {
          employeeIdsFilter = filteredIds;
        }
      }

      // Buscar Ãºltimas posiÃ§Ãµes Nine Box de cada colaborador
      const latestPositions = await database
        .select({
          employeeId: nineBoxPositions.employeeId,
          employeeName: employees.name,
          positionId: employees.positionId,
          positionTitle: positions.title,
          departmentId: employees.departmentId,
          departmentName: departments.name,
          performance: nineBoxPositions.performance,
          potential: nineBoxPositions.potential,
          createdAt: nineBoxPositions.createdAt,
        })
        .from(nineBoxPositions)
        .innerJoin(employees, eq(nineBoxPositions.employeeId, employees.id))
        .leftJoin(positions, eq(employees.positionId, positions.id))
        .leftJoin(departments, eq(employees.departmentId, employees.id))
        .where(
          and(
            input.departmentId ? eq(employees.departmentId, input.departmentId) : undefined,
            input.positionIds && input.positionIds.length > 0
              ? inArray(employees.positionId, input.positionIds)
              : undefined,
            employeeIdsFilter && employeeIdsFilter.length > 0
              ? inArray(employees.id, employeeIdsFilter)
              : undefined
          )
        )
        .orderBy(desc(nineBoxPositions.createdAt));

      // Agrupar por colaborador (pegar apenas a posiÃ§Ã£o mais recente)
      const uniqueEmployees = new Map();
      for (const pos of latestPositions) {
        if (!uniqueEmployees.has(pos.employeeId)) {
          uniqueEmployees.set(pos.employeeId, pos);
        }
      }

      const data = Array.from(uniqueEmployees.values());

      // Agrupar por cargo
      const byPosition: Record<string, typeof data> = {};
      for (const item of data) {
        const key = item.positionTitle || "Sem cargo";
        if (!byPosition[key]) {
          byPosition[key] = [];
        }
        byPosition[key].push(item);
      }

      // Calcular distribuiÃ§Ã£o Nine Box por cargo
      const comparative = Object.entries(byPosition).map(([positionTitle, items]) => {
        // Contar distribuiÃ§Ã£o na matriz 3x3
        const distribution = {
          baixo_desempenho_baixo_potencial: 0, // Perf 1, Pot 1
          baixo_desempenho_medio_potencial: 0,  // Perf 1, Pot 2
          baixo_desempenho_alto_potencial: 0,   // Perf 1, Pot 3
          medio_desempenho_baixo_potencial: 0,  // Perf 2, Pot 1
          medio_desempenho_medio_potencial: 0,  // Perf 2, Pot 2
          medio_desempenho_alto_potencial: 0,   // Perf 2, Pot 3
          alto_desempenho_baixo_potencial: 0,   // Perf 3, Pot 1
          alto_desempenho_medio_potencial: 0,   // Perf 3, Pot 2
          alto_desempenho_alto_potencial: 0,    // Perf 3, Pot 3 (Stars)
        };

        items.forEach((item) => {
          const key = `${
            item.performance === 1 ? "baixo" : item.performance === 2 ? "medio" : "alto"
          }_desempenho_${
            item.potential === 1 ? "baixo" : item.potential === 2 ? "medio" : "alto"
          }_potencial`;
          distribution[key as keyof typeof distribution]++;
        });

        // Calcular mÃ©tricas agregadas
        const avgPerformance =
          items.reduce((sum, item) => sum + item.performance, 0) / items.length;
        const avgPotential =
          items.reduce((sum, item) => sum + item.potential, 0) / items.length;

        const highPerformers = items.filter((i) => i.performance >= 3).length;
        const highPotential = items.filter((i) => i.potential >= 3).length;
        const stars = items.filter((i) => i.performance >= 3 && i.potential >= 3).length;

        return {
          positionTitle,
          totalEmployees: items.length,
          distribution,
          avgPerformance: Number(avgPerformance.toFixed(2)),
          avgPotential: Number(avgPotential.toFixed(2)),
          highPerformersCount: highPerformers,
          highPerformersPercent: Number(((highPerformers / items.length) * 100).toFixed(1)),
          highPotentialCount: highPotential,
          highPotentialPercent: Number(((highPotential / items.length) * 100).toFixed(1)),
          starsCount: stars,
          starsPercent: Number(((stars / items.length) * 100).toFixed(1)),
        };
      });

      return comparative;
    }),

  // Listar todas as posiÃ§Ãµes disponÃ­veis para comparaÃ§Ã£o
  getAvailablePositions: protectedProcedure.query(async () => {
    const database = await getDb();
    if (!database) return [];

    const positionsWithCount = await database
      .select({
        id: positions.id,
        title: positions.title,
        employeeCount: sql<number>`COUNT(${employees.id})`,
      })
      .from(positions)
      .leftJoin(employees, eq(positions.id, employees.positionId))
      .groupBy(positions.id, positions.title)
      .having(sql`COUNT(${employees.id}) > 0`)
      .orderBy(positions.title);

    return positionsWithCount;
  }),

  // Buscar lÃ­deres (colaboradores com subordinados)
  getLeaders: protectedProcedure.query(async () => {
    const database = await getDb();
    if (!database) return [];

    const leaders = await database
      .select({
        id: employees.id,
        name: employees.name,
        positionTitle: positions.title,
        subordinatesCount: sql<number>`COUNT(DISTINCT subordinates.id)`,
      })
      .from(employees)
      .leftJoin(positions, eq(employees.positionId, positions.id))
      .innerJoin(sql`${employees} as subordinates`, sql`subordinates.managerId = ${employees.id}`)
      .groupBy(employees.id, employees.name, positions.title)
      .having(sql`COUNT(DISTINCT subordinates.id) > 0`)
      .orderBy(employees.name);

    return leaders;
  }),

  // Buscar subordinados diretos de um lÃ­der
  getSubordinates: protectedProcedure
    .input(z.object({ leaderId: z.number() }))
    .query(async ({ input }) => {
      const database = await getDb();
      if (!database) return [];

      const subordinates = await database
        .select({
          id: employees.id,
          name: employees.name,
          positionTitle: positions.title,
        })
        .from(employees)
        .leftJoin(positions, eq(employees.positionId, positions.id))
        .where(eq(employees.managerId, input.leaderId))
        .orderBy(employees.name);

      return subordinates;
    }),
});


========================================
ARQUIVO: ./server/notificationHelper.ts
========================================
import { getDb } from "./db";
import { notifications } from "../drizzle/schema";
import { eq } from "drizzle-orm";

export interface NotificationData {
  userId: number;
  type: string;
  title: string;
  message: string;
  link?: string;
}

/**
 * Cria uma notificaÃ§Ã£o no banco de dados
 * Para enviar via WebSocket, use sendNotificationToUser do websocket.ts
 */
export async function createNotification(data: NotificationData) {
  const db = await getDb();
  if (!db) {
    console.error("[Notifications] Database not available");
    return null;
  }

  try {
    // Inserir notificaÃ§Ã£o no banco
    const result = await db.insert(notifications).values({
      userId: data.userId,
      type: data.type,
      title: data.title,
      message: data.message,
      link: data.link,
      read: false,
    });

    const notificationId = result[0].insertId;

    // Buscar notificaÃ§Ã£o criada
    const createdNotifications = await db
      .select()
      .from(notifications)
      .where(eq(notifications.id, notificationId))
      .limit(1);

    const notification = createdNotifications[0];

    if (!notification) {
      console.error("[Notifications] Failed to retrieve created notification");
      return null;
    }

    console.log(`[Notifications] Created for user ${data.userId}: ${data.title}`);
    return notification;
  } catch (error) {
    console.error("[Notifications] Error creating notification:", error);
    return null;
  }
}

/**
 * Exemplos de uso:
 * 
 * import { createNotification } from "./notificationHelper";
 * import { sendNotificationToUser } from "./websocket";
 * 
 * // Criar notificaÃ§Ã£o no banco
 * const notification = await createNotification({
 *   userId: employeeId,
 *   type: "evaluation_360",
 *   title: "Nova AvaliaÃ§Ã£o 360Â° Recebida",
 *   message: "VocÃª recebeu uma nova avaliaÃ§Ã£o 360Â° para preencher",
 *   link: "/performance/avaliacao-360",
 * });
 * 
 * // Enviar via WebSocket (se io estiver disponÃ­vel)
 * if (notification && io) {
 *   sendNotificationToUser(io, employeeId, {
 *     type: "avaliacao",
 *     title: notification.title,
 *     message: notification.message,
 *     link: notification.link,
 *   });
 * }
 */


========================================
ARQUIVO: ./server/notificationsRouter.ts
========================================
import { z } from "zod";
import { protectedProcedure, router } from "./_core/trpc";
import { getDb } from "./db";
import { notifications } from "../drizzle/schema";
import { eq, and, desc } from "drizzle-orm";

export const notificationsRouter = router({
  // Listar notificaÃ§Ãµes do usuÃ¡rio
  list: protectedProcedure
    .input(
      z.object({
        limit: z.number().min(1).max(100).default(50),
        onlyUnread: z.boolean().optional(),
      })
    )
    .query(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const conditions = [eq(notifications.userId, ctx.user.id)];
      
      if (input.onlyUnread) {
        conditions.push(eq(notifications.read, false));
      }

      const result = await db
        .select()
        .from(notifications)
        .where(and(...conditions))
        .orderBy(desc(notifications.createdAt))
        .limit(input.limit);

      return result;
    }),

  // Contar notificaÃ§Ãµes nÃ£o lidas
  countUnread: protectedProcedure.query(async ({ ctx }) => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    const result = await db
      .select()
      .from(notifications)
      .where(and(eq(notifications.userId, ctx.user.id), eq(notifications.read, false)));

    return { count: result.length };
  }),

  // Marcar notificaÃ§Ã£o como lida
  markAsRead: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db
        .update(notifications)
        .set({ read: true, readAt: new Date() })
        .where(and(eq(notifications.id, input.id), eq(notifications.userId, ctx.user.id)));

      return { success: true };
    }),

  // Marcar todas como lidas
  markAllAsRead: protectedProcedure.mutation(async ({ ctx }) => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    await db
      .update(notifications)
      .set({ read: true, readAt: new Date() })
      .where(and(eq(notifications.userId, ctx.user.id), eq(notifications.read, false)));

    return { success: true };
  }),

  // Deletar notificaÃ§Ã£o
  delete: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db
        .delete(notifications)
        .where(and(eq(notifications.id, input.id), eq(notifications.userId, ctx.user.id)));

      return { success: true };
    }),
});


========================================
ARQUIVO: ./server/pdiIntelligentRouter.ts
========================================
import { TRPCError } from "@trpc/server";
import { and, desc, eq, sql } from "drizzle-orm";
import { z } from "zod";
import {
  competencies,
  employees,
  employeeCompetencies,
  pdiCompetencyGaps,
  pdiIntelligentDetails,
  pdiItems,
  pdiPlans,
  pdiReviews,
  pdiRisks,
  positionCompetencies,
  positions,
  psychometricTests,
  pdiActions,
  pdiGovernanceReviews,
} from "../drizzle/schema";
import { getDb } from "./db";
import { protectedProcedure, router } from "./_core/trpc";

/**
 * Router para PDI Inteligente
 * Sistema avanÃ§ado de desenvolvimento para sucessÃ£o estratÃ©gica
 */

export const pdiIntelligentRouter = router({
  /**
   * Criar PDI Inteligente com anÃ¡lise automÃ¡tica de gaps
   */
  create: protectedProcedure
    .input(
      z.object({
        employeeId: z.number(),
        cycleId: z.number(),
        targetPositionId: z.number(),
        startDate: z.string(),
        endDate: z.string(),
        strategicContext: z.string(),
        durationMonths: z.number().default(24),
        mentorId: z.number().optional(),
        sponsorId1: z.number().optional(),
        sponsorId2: z.number().optional(),
        guardianId: z.number().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // 1. Buscar perfil atual do colaborador (testes psicomÃ©tricos)
      const currentTests = await db
        .select()
        .from(psychometricTests)
        .where(eq(psychometricTests.employeeId, input.employeeId))
        .orderBy(desc(psychometricTests.completedAt))
        .limit(1);

      const currentProfile = currentTests[0]
        ? {
            disc: {
              d: currentTests[0].discDominance || 0,
              i: currentTests[0].discInfluence || 0,
              s: currentTests[0].discSteadiness || 0,
              c: currentTests[0].discCompliance || 0,
            },
            bigFive: {
              o: currentTests[0].bigFiveOpenness || 0,
              c: currentTests[0].bigFiveConscientiousness || 0,
              e: currentTests[0].bigFiveExtraversion || 0,
              a: currentTests[0].bigFiveAgreeableness || 0,
              n: currentTests[0].bigFiveNeuroticism || 0,
            },
          }
        : null;

      // 2. Buscar competÃªncias atuais do colaborador
      const currentCompetencies = await db
        .select()
        .from(employeeCompetencies)
        .where(eq(employeeCompetencies.employeeId, input.employeeId));

      // 3. Buscar competÃªncias requeridas pela posiÃ§Ã£o-alvo
      const targetCompetencies = await db
        .select()
        .from(positionCompetencies)
        .where(eq(positionCompetencies.positionId, input.targetPositionId));

      // 4. Criar o PDI Plan base
      const [plan] = await db
        .insert(pdiPlans)
        .values({
          cycleId: input.cycleId,
          employeeId: input.employeeId,
          targetPositionId: input.targetPositionId,
          status: "rascunho",
          startDate: new Date(input.startDate),
          endDate: new Date(input.endDate),
          overallProgress: 0,
        })
        .$returningId();

      // 5. Criar detalhes inteligentes do PDI
      await db.insert(pdiIntelligentDetails).values({
        planId: plan.id,
        strategicContext: input.strategicContext,
        durationMonths: input.durationMonths,
        mentorId: input.mentorId,
        sponsorId1: input.sponsorId1,
        sponsorId2: input.sponsorId2,
        guardianId: input.guardianId,
        currentProfile: currentProfile,
        targetProfile: null, // SerÃ¡ preenchido posteriormente
        gapsAnalysis: null,
        milestone12Months: "ConclusÃ£o do primeiro ano do PDI com evoluÃ§Ã£o comprovada nos gaps identificados",
        milestone24Months: "ConclusÃ£o de todas as aÃ§Ãµes do PDI e elegibilidade para posiÃ§Ã£o executiva",
      });

      // 6. Identificar e criar gaps de competÃªncias
      const gaps: any[] = [];
      for (const targetComp of targetCompetencies) {
        const currentComp = currentCompetencies.find((cc: any) => cc.competencyId === targetComp.competencyId);
        const currentLevel = currentComp?.currentLevel || 0;
        const targetLevel = targetComp.requiredLevel;
        const gap = targetLevel - currentLevel;

        if (gap > 0) {
          gaps.push({
            planId: plan.id,
            competencyId: targetComp.competencyId,
            currentLevel,
            targetLevel,
            gap,
            priority: gap >= 3 ? "alta" : gap >= 2 ? "media" : "baixa",
            status: "identificado",
          });
        }
      }

      if (gaps.length > 0) {
        await db.insert(pdiCompetencyGaps).values(gaps);
      }

      return {
        success: true,
        planId: plan.id,
        gapsCount: gaps.length,
      };
    }),

  /**
   * Buscar PDI Inteligente por ID com todos os detalhes
   */
  getById: protectedProcedure.input(z.object({ id: z.number() })).query(async ({ input }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    const [plan] = await db
      .select()
      .from(pdiPlans)
      .leftJoin(employees, eq(pdiPlans.employeeId, employees.id))
      .leftJoin(positions, eq(pdiPlans.targetPositionId, positions.id))
      .where(eq(pdiPlans.id, input.id))
      .limit(1);

    const items = await db
      .select()
      .from(pdiItems)
      .where(eq(pdiItems.planId, input.id));

    if (!plan) {
      throw new TRPCError({ code: "NOT_FOUND", message: "PDI nÃ£o encontrado" });
    }

    // Buscar detalhes inteligentes
    const [details] = await db
      .select()
      .from(pdiIntelligentDetails)
      .where(eq(pdiIntelligentDetails.planId, input.id))
      .limit(1);

    // Buscar gaps
    const gaps = await db
      .select({
        id: pdiCompetencyGaps.id,
        competencyId: pdiCompetencyGaps.competencyId,
        competencyName: competencies.name,
        currentLevel: pdiCompetencyGaps.currentLevel,
        targetLevel: pdiCompetencyGaps.targetLevel,
        gap: pdiCompetencyGaps.gap,
        priority: pdiCompetencyGaps.priority,
        employeeActions: pdiCompetencyGaps.employeeActions,
        managerActions: pdiCompetencyGaps.managerActions,
        sponsorActions: pdiCompetencyGaps.sponsorActions,
        status: pdiCompetencyGaps.status,
      })
      .from(pdiCompetencyGaps)
      .leftJoin(competencies, eq(pdiCompetencyGaps.competencyId, competencies.id))
      .where(eq(pdiCompetencyGaps.planId, input.id));

    // Buscar riscos
    const risks = await db.select().from(pdiRisks).where(eq(pdiRisks.planId, input.id));

    // Buscar reviews
    const reviews = await db
      .select({
        id: pdiReviews.id,
        reviewerId: pdiReviews.reviewerId,
        reviewerName: employees.name,
        reviewerRole: pdiReviews.reviewerRole,
        reviewDate: pdiReviews.reviewDate,
        overallProgress: pdiReviews.overallProgress,
        strengths: pdiReviews.strengths,
        improvements: pdiReviews.improvements,
        nextSteps: pdiReviews.nextSteps,
        recommendation: pdiReviews.recommendation,
        createdAt: pdiReviews.createdAt,
      })
      .from(pdiReviews)
      .leftJoin(employees, eq(pdiReviews.reviewerId, employees.id))
      .where(eq(pdiReviews.planId, input.id))
      .orderBy(desc(pdiReviews.reviewDate));

    // Buscar informaÃ§Ãµes dos sponsors/mentores
    let mentor = null;
    let sponsor1 = null;
    let sponsor2 = null;
    let guardian = null;

    if (details?.mentorId) {
      [mentor] = await db.select().from(employees).where(eq(employees.id, details.mentorId)).limit(1);
    }
    if (details?.sponsorId1) {
      [sponsor1] = await db.select().from(employees).where(eq(employees.id, details.sponsorId1)).limit(1);
    }
    if (details?.sponsorId2) {
      [sponsor2] = await db.select().from(employees).where(eq(employees.id, details.sponsorId2)).limit(1);
    }
    if (details?.guardianId) {
      [guardian] = await db.select().from(employees).where(eq(employees.id, details.guardianId)).limit(1);
    }

    return {
      ...plan,
      details,
      gaps,
      risks,
      reviews,
      mentor,
      sponsor1,
      sponsor2,
      guardian,
    };
  }),

  /**
   * Listar PDIs Inteligentes
   */
  list: protectedProcedure
    .input(
      z.object({
        employeeId: z.number().optional(),
        status: z.enum(["rascunho", "pendente_aprovacao", "aprovado", "em_andamento", "concluido", "cancelado"]).optional(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const conditions = [];
      if (input.employeeId) {
        conditions.push(eq(pdiPlans.employeeId, input.employeeId));
      }
      if (input.status) {
        conditions.push(eq(pdiPlans.status, input.status));
      }

      const plans = await db
        .select({
          id: pdiPlans.id,
          employeeId: pdiPlans.employeeId,
          employeeName: employees.name,
          targetPositionId: pdiPlans.targetPositionId,
          targetPositionTitle: positions.title,
          status: pdiPlans.status,
          startDate: pdiPlans.startDate,
          endDate: pdiPlans.endDate,
          overallProgress: pdiPlans.overallProgress,
          createdAt: pdiPlans.createdAt,
        })
        .from(pdiPlans)
        .leftJoin(employees, eq(pdiPlans.employeeId, employees.id))
        .leftJoin(positions, eq(pdiPlans.targetPositionId, positions.id))
        .where(conditions.length > 0 ? and(...conditions) : undefined)
        .orderBy(desc(pdiPlans.createdAt));

      return plans;
    }),

  /**
   * Adicionar gap de competÃªncia
   */
  addGap: protectedProcedure
    .input(
      z.object({
        planId: z.number(),
        competencyId: z.number(),
        currentLevel: z.number().min(0).max(5),
        targetLevel: z.number().min(1).max(5),
        priority: z.enum(["alta", "media", "baixa"]),
        employeeActions: z.string().optional(),
        managerActions: z.string().optional(),
        sponsorActions: z.string().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const gap = input.targetLevel - input.currentLevel;

      await db.insert(pdiCompetencyGaps).values({
        planId: input.planId,
        competencyId: input.competencyId,
        currentLevel: input.currentLevel,
        targetLevel: input.targetLevel,
        gap,
        priority: input.priority,
        employeeActions: input.employeeActions,
        managerActions: input.managerActions,
        sponsorActions: input.sponsorActions,
        status: "identificado",
      });

      return { success: true };
    }),

  /**
   * Atualizar gap de competÃªncia
   */
  updateGap: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        employeeActions: z.string().optional(),
        managerActions: z.string().optional(),
        sponsorActions: z.string().optional(),
        status: z.enum(["identificado", "em_desenvolvimento", "superado"]).optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const updates: any = {};
      if (input.employeeActions !== undefined) updates.employeeActions = input.employeeActions;
      if (input.managerActions !== undefined) updates.managerActions = input.managerActions;
      if (input.sponsorActions !== undefined) updates.sponsorActions = input.sponsorActions;
      if (input.status) updates.status = input.status;

      await db.update(pdiCompetencyGaps).set(updates).where(eq(pdiCompetencyGaps.id, input.id));

      return { success: true };
    }),

  /**
   * Adicionar risco ao PDI
   */
  addRisk: protectedProcedure
    .input(
      z.object({
        planId: z.number(),
        type: z.enum(["saida", "gap_competencia", "tempo_preparo", "mudanca_estrategica", "outro"]),
        description: z.string(),
        impact: z.enum(["baixo", "medio", "alto", "critico"]),
        probability: z.enum(["baixa", "media", "alta"]),
        mitigation: z.string().optional(),
        responsible: z.number().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      await db.insert(pdiRisks).values({
        planId: input.planId,
        type: input.type,
        description: input.description,
        impact: input.impact,
        probability: input.probability,
        mitigation: input.mitigation,
        responsible: input.responsible,
        status: "identificado",
      });

      return { success: true };
    }),

  /**
   * Atualizar risco
   */
  updateRisk: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        mitigation: z.string().optional(),
        status: z.enum(["identificado", "em_mitigacao", "mitigado", "materializado"]).optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const updates: any = {};
      if (input.mitigation !== undefined) updates.mitigation = input.mitigation;
      if (input.status) updates.status = input.status;

      await db.update(pdiRisks).set(updates).where(eq(pdiRisks.id, input.id));

      return { success: true };
    }),

  /**
   * Adicionar review/acompanhamento
   */
  addReview: protectedProcedure
    .input(
      z.object({
        planId: z.number(),
        reviewerId: z.number(),
        reviewerRole: z.enum(["mentor", "sponsor", "guardiao"]),
        reviewDate: z.string(),
        overallProgress: z.number().min(0).max(100),
        strengths: z.string().optional(),
        improvements: z.string().optional(),
        nextSteps: z.string().optional(),
        recommendation: z.enum(["manter", "acelerar", "ajustar", "pausar"]),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      await db.insert(pdiReviews).values({
        planId: input.planId,
        reviewerId: input.reviewerId,
        reviewerRole: input.reviewerRole,
        reviewDate: new Date(input.reviewDate),
        overallProgress: input.overallProgress,
        strengths: input.strengths,
        improvements: input.improvements,
        nextSteps: input.nextSteps,
        recommendation: input.recommendation,
      });

      return { success: true };
    }),

  /**
   * Atualizar status do PDI
   */
  updateStatus: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        status: z.enum(["rascunho", "pendente_aprovacao", "aprovado", "em_andamento", "concluido", "cancelado"]),
        approvedBy: z.number().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const updates: any = {
        status: input.status,
      };

      if (input.status === "aprovado" && input.approvedBy) {
        updates.approvedBy = input.approvedBy;
        updates.approvedAt = new Date();
      }

      if (input.status === "concluido") {
        updates.completedAt = new Date();
        updates.overallProgress = 100;
      }

      await db.update(pdiPlans).set(updates).where(eq(pdiPlans.id, input.id));

      return { success: true };
    }),

  /**
   * Comparar perfil atual vs. posiÃ§Ã£o-alvo
   */
  compareProfiles: protectedProcedure
    .input(
      z.object({
        employeeId: z.number(),
        targetPositionId: z.number(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Buscar perfil atual
      const currentTests = await db
        .select()
        .from(psychometricTests)
        .where(eq(psychometricTests.employeeId, input.employeeId))
        .orderBy(desc(psychometricTests.completedAt))
        .limit(1);

      const currentProfile = currentTests[0] || null;

      // Buscar competÃªncias atuais
      const currentCompetencies = await db
        .select({
          competencyId: competencies.id,
          competencyName: competencies.name,
          level: sql<number>`${competencies.id}`.as("level"),
        })
        .from(competencies)
        .leftJoin(sql`employee_competencies ec`, sql`ec.competency_id = ${competencies.id} AND ec.employee_id = ${input.employeeId}`);

      // Buscar competÃªncias requeridas
      const targetCompetencies = await db
        .select({
          competencyId: competencies.id,
          competencyName: competencies.name,
          requiredLevel: sql<number>`pc.required_level`.as("requiredLevel"),
        })
        .from(competencies)
        .leftJoin(sql`position_competencies pc`, sql`pc.competency_id = ${competencies.id} AND pc.position_id = ${input.targetPositionId}`);

      return {
        currentProfile,
        currentCompetencies,
        targetCompetencies,
      };
    }),

  /**
   * Buscar todos os testes psicomÃ©tricos de um colaborador
   */
  getEmployeeTests: protectedProcedure
    .input(z.object({ employeeId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return [];

      const tests = await db
        .select()
        .from(psychometricTests)
        .where(eq(psychometricTests.employeeId, input.employeeId))
        .orderBy(desc(psychometricTests.completedAt));

      return tests;
    }),

  /**
   * Comparar testes psicomÃ©tricos do colaborador com perfil da posiÃ§Ã£o-alvo
   */
  compareTestsWithPosition: protectedProcedure
    .input(
      z.object({
        employeeId: z.number(),
        targetPositionId: z.number(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return null;

      // Buscar testes do colaborador
      const employeeTests = await db
        .select()
        .from(psychometricTests)
        .where(eq(psychometricTests.employeeId, input.employeeId))
        .orderBy(desc(psychometricTests.completedAt));

      // Buscar perfil ideal da posiÃ§Ã£o (simulado - em produÃ§Ã£o viria de uma tabela position_profiles)
      const targetProfile = {
        disc: { D: 70, I: 50, S: 40, C: 60 },
        bigFive: { openness: 70, conscientiousness: 80, extraversion: 60, agreeableness: 50, neuroticism: 30 },
      };

      // Pegar o teste mais recente de cada tipo
      const latestDISC = employeeTests.find((t) => t.testType === "disc");
      const latestBigFive = employeeTests.find((t) => t.testType === "bigfive");

      // Calcular gaps
      const gaps = {
        disc: latestDISC
          ? {
              D: targetProfile.disc.D - (latestDISC.discDominance || 0),
              I: targetProfile.disc.I - (latestDISC.discInfluence || 0),
              S: targetProfile.disc.S - (latestDISC.discSteadiness || 0),
              C: targetProfile.disc.C - (latestDISC.discCompliance || 0),
            }
          : null,
        bigFive: latestBigFive
          ? {
              openness: targetProfile.bigFive.openness - (latestBigFive.bigFiveOpenness || 0),
              conscientiousness: targetProfile.bigFive.conscientiousness - (latestBigFive.bigFiveConscientiousness || 0),
              extraversion: targetProfile.bigFive.extraversion - (latestBigFive.bigFiveExtraversion || 0),
              agreeableness: targetProfile.bigFive.agreeableness - (latestBigFive.bigFiveAgreeableness || 0),
              neuroticism: targetProfile.bigFive.neuroticism - (latestBigFive.bigFiveNeuroticism || 0),
            }
          : null,

      };

      // Gerar recomendaÃ§Ãµes baseadas nos gaps
      const recommendations = [];
      if (gaps.disc) {
        if (gaps.disc.D > 20) recommendations.push("Desenvolver assertividade e tomada de decisÃ£o rÃ¡pida");
        if (gaps.disc.I > 20) recommendations.push("Melhorar habilidades de comunicaÃ§Ã£o e relacionamento interpessoal");
        if (gaps.disc.S > 20) recommendations.push("Fortalecer capacidade de trabalho em equipe e estabilidade");
        if (gaps.disc.C > 20) recommendations.push("Aprimorar atenÃ§Ã£o a detalhes e processos");
      }
      if (gaps.bigFive) {
        if (gaps.bigFive.conscientiousness > 20) recommendations.push("Desenvolver organizaÃ§Ã£o e disciplina");
        if (gaps.bigFive.openness > 20) recommendations.push("Estimular criatividade e abertura a novas ideias");
      }

      return {
        employeeTests: {
          disc: latestDISC,
          bigFive: latestBigFive,
        },
        targetProfile,
        gaps,
        recommendations,
        compatibilityScore: calculateCompatibility(gaps),
      };
    }),

  /**
   * Adicionar aÃ§Ã£o ao PDI
   */
  addAction: protectedProcedure
    .input(
      z.object({
        planId: z.number(),
        title: z.string(),
        description: z.string(),
        axis: z.enum(["70_pratica", "20_experiencia", "10_educacao"]),
        developmentArea: z.string(),
        successMetric: z.string(),
        evidenceRequired: z.string().optional(),
        responsible: z.string(),
        dueDate: z.string(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      await db.insert(pdiActions).values({
        planId: input.planId,
        title: input.title,
        description: input.description,
        axis: input.axis,
        developmentArea: input.developmentArea,
        successMetric: input.successMetric,
        evidenceRequired: input.evidenceRequired,
        responsible: input.responsible,
        dueDate: new Date(input.dueDate),
        status: "nao_iniciado",
        progress: 0,
      });

      return { success: true };
    }),

  /**
   * Atualizar status de aÃ§Ã£o
   */
  updateActionStatus: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        status: z.enum(["nao_iniciado", "em_andamento", "concluido"]),
        progress: z.number().min(0).max(100).optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const updates: any = {
        status: input.status,
        updatedAt: new Date(),
      };

      if (input.progress !== undefined) {
        updates.progress = input.progress;
      }

      if (input.status === "concluido") {
        updates.completedAt = new Date();
        updates.progress = 100;
      }

      await db.update(pdiActions).set(updates).where(eq(pdiActions.id, input.id));

      return { success: true };
    }),

  /**
   * Buscar aÃ§Ãµes de um PDI
   */
  getActions: protectedProcedure
    .input(z.object({ planId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return [];

      const actions = await db
        .select()
        .from(pdiActions)
        .where(eq(pdiActions.planId, input.planId))
        .orderBy(pdiActions.dueDate);

      return actions;
    }),

  /**
   * Adicionar feedback de governanÃ§a (DGC)
   */
  addGovernanceReview: protectedProcedure
    .input(
      z.object({
        planId: z.number(),
        reviewDate: z.string(),
        reviewerId: z.number(),
        reviewerRole: z.enum(["dgc", "mentor", "sponsor"]),
        readinessIndex: z.number().min(1).max(5),
        keyPoints: z.string(),
        strengths: z.string().optional(),
        improvements: z.string().optional(),
        nextSteps: z.string().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      await db.insert(pdiGovernanceReviews).values({
        planId: input.planId,
        reviewDate: new Date(input.reviewDate),
        reviewerId: input.reviewerId,
        reviewerRole: input.reviewerRole,
        readinessIndex: input.readinessIndex.toString(),
        keyPoints: input.keyPoints,
        strengths: input.strengths,
        improvements: input.improvements,
        nextSteps: input.nextSteps,
      });

      return { success: true };
    }),

  /**
   * Buscar histÃ³rico de feedbacks de governanÃ§a
   */
  getGovernanceReviews: protectedProcedure
    .input(z.object({ planId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return [];

      const reviews = await db
        .select({
          id: pdiGovernanceReviews.id,
          reviewDate: pdiGovernanceReviews.reviewDate,
          readinessIndex: pdiGovernanceReviews.readinessIndex,
          keyPoints: pdiGovernanceReviews.keyPoints,
          strengths: pdiGovernanceReviews.strengths,
          improvements: pdiGovernanceReviews.improvements,
          nextSteps: pdiGovernanceReviews.nextSteps,
          reviewerName: employees.name,
          reviewerRole: pdiGovernanceReviews.reviewerRole,
        })
        .from(pdiGovernanceReviews)
        .leftJoin(employees, eq(pdiGovernanceReviews.reviewerId, employees.id))
        .where(eq(pdiGovernanceReviews.planId, input.planId))
        .orderBy(desc(pdiGovernanceReviews.reviewDate));

      return reviews;
    }),

  /**
   * Calcular evoluÃ§Ã£o do IPS ao longo do tempo
   */
  getIPSEvolution: protectedProcedure
    .input(z.object({ planId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return [];

      const evolution = await db
        .select({
          reviewDate: pdiGovernanceReviews.reviewDate,
          readinessIndex: pdiGovernanceReviews.readinessIndex,
        })
        .from(pdiGovernanceReviews)
        .where(eq(pdiGovernanceReviews.planId, input.planId))
        .orderBy(pdiGovernanceReviews.reviewDate);

      return evolution;
    }),
});

/**
 * Calcular score de compatibilidade (0-100)
 */
function calculateCompatibility(gaps: any): number {
  let totalGap = 0;
  let count = 0;

  if (gaps.disc) {
    totalGap += Math.abs(gaps.disc.D) + Math.abs(gaps.disc.I) + Math.abs(gaps.disc.S) + Math.abs(gaps.disc.C);
    count += 4;
  }
  if (gaps.bigFive) {
    totalGap += Math.abs(gaps.bigFive.openness) + Math.abs(gaps.bigFive.conscientiousness) + Math.abs(gaps.bigFive.extraversion) + Math.abs(gaps.bigFive.agreeableness) + Math.abs(gaps.bigFive.neuroticism);
    count += 5;
  }


  if (count === 0) return 0;

  const averageGap = totalGap / count;
  const compatibility = Math.max(0, 100 - averageGap);

  return Math.round(compatibility);
}




========================================
ARQUIVO: ./server/reportAnalyticsRouter.ts
========================================
import { z } from "zod";
import { sql } from "drizzle-orm";
import { getDb } from "./db";
import { reportAnalytics } from "../drizzle/schema";
import { protectedProcedure, router } from "./_core/trpc";

/**
 * Report Analytics Router
 * Rastreia uso de relatÃ³rios customizados e fornece insights
 */

export const reportAnalyticsRouter = router({
  // Registrar aÃ§Ã£o de analytics
  track: protectedProcedure
    .input(
      z.object({
        reportId: z.number().optional(),
        reportName: z.string(),
        action: z.enum(["view", "export_pdf", "export_excel", "create", "update", "delete"]),
        metrics: z.array(z.string()).optional(),
        filters: z.any().optional(),
        executionTimeMs: z.number().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      await database.insert(reportAnalytics).values({
        reportId: input.reportId,
        reportName: input.reportName,
        action: input.action,
        userId: ctx.user.id,
        metrics: input.metrics ? JSON.stringify(input.metrics) : null,
        filters: input.filters ? JSON.stringify(input.filters) : null,
        executionTimeMs: input.executionTimeMs,
      });

      return { success: true };
    }),

  // Obter estatÃ­sticas de uso
  getUsageStats: protectedProcedure.query(async () => {
    const database = await getDb();
    if (!database) return null;

    // Total de relatÃ³rios gerados
    const totalReports = await database
      .select({ count: sql<number>`COUNT(*)` })
      .from(reportAnalytics)
      .where(sql`action IN ('view', 'create')`);

    // Total de exportaÃ§Ãµes
    const totalExports = await database
      .select({ count: sql<number>`COUNT(*)` })
      .from(reportAnalytics)
      .where(sql`action IN ('export_pdf', 'export_excel')`);

    // ExportaÃ§Ãµes por tipo
    const exportsByType = await database
      .select({
        action: reportAnalytics.action,
        count: sql<number>`COUNT(*)`,
      })
      .from(reportAnalytics)
      .where(sql`action IN ('export_pdf', 'export_excel')`)
      .groupBy(reportAnalytics.action);

    // Tempo mÃ©dio de execuÃ§Ã£o
    const avgExecutionTime = await database
      .select({
        avg: sql<number>`AVG(executionTimeMs)`,
      })
      .from(reportAnalytics)
      .where(sql`executionTimeMs IS NOT NULL`);

    return {
      totalReports: Number(totalReports[0]?.count || 0),
      totalExports: Number(totalExports[0]?.count || 0),
      exportsPdf: Number(exportsByType.find((e) => e.action === "export_pdf")?.count || 0),
      exportsExcel: Number(exportsByType.find((e) => e.action === "export_excel")?.count || 0),
      avgExecutionTimeMs: Number(avgExecutionTime[0]?.avg || 0),
    };
  }),

  // Obter mÃ©tricas mais usadas
  getMostUsedMetrics: protectedProcedure.query(async () => {
    const database = await getDb();
    if (!database) return [];

    const results = await database
      .select({
        metrics: reportAnalytics.metrics,
        count: sql<number>`COUNT(*)`,
      })
      .from(reportAnalytics)
      .where(sql`metrics IS NOT NULL`)
      .groupBy(reportAnalytics.metrics)
      .orderBy(sql`COUNT(*) DESC`)
      .limit(10);

    // Processar mÃ©tricas (JSON array)
    const metricCounts: Record<string, number> = {};
    
    results.forEach((row) => {
      try {
        const metrics = typeof row.metrics === 'string' 
          ? JSON.parse(row.metrics) 
          : row.metrics;
        
        if (Array.isArray(metrics)) {
          metrics.forEach((metric: string) => {
            metricCounts[metric] = (metricCounts[metric] || 0) + Number(row.count);
          });
        }
      } catch (e) {
        // Ignorar erros de parse
      }
    });

    return Object.entries(metricCounts)
      .map(([metric, count]) => ({ metric, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 10);
  }),

  // Obter histÃ³rico de exportaÃ§Ãµes
  getExportHistory: protectedProcedure
    .input(
      z.object({
        limit: z.number().default(20),
      })
    )
    .query(async ({ input }) => {
      const database = await getDb();
      if (!database) return [];

      const results = await database
        .select({
          id: reportAnalytics.id,
          reportName: reportAnalytics.reportName,
          action: reportAnalytics.action,
          userId: reportAnalytics.userId,
          createdAt: reportAnalytics.createdAt,
          executionTimeMs: reportAnalytics.executionTimeMs,
        })
        .from(reportAnalytics)
        .where(sql`action IN ('export_pdf', 'export_excel')`)
        .orderBy(sql`createdAt DESC`)
        .limit(input.limit);

      return results;
    }),

  // Obter tendÃªncias de uso (Ãºltimos 30 dias)
  getTrends: protectedProcedure.query(async () => {
    const database = await getDb();
    if (!database) return [];

    const results = await database
      .select({
        date: sql<string>`DATE(createdAt)`,
        count: sql<number>`COUNT(*)`,
      })
      .from(reportAnalytics)
      .where(sql`createdAt >= DATE_SUB(NOW(), INTERVAL 30 DAY)`)
      .groupBy(sql`DATE(createdAt)`)
      .orderBy(sql`DATE(createdAt) ASC`);

    return results.map((row) => ({
      date: row.date,
      count: Number(row.count),
    }));
  }),
});


========================================
ARQUIVO: ./server/reportBuilderRouter.ts
========================================
import { z } from "zod";
import { adminProcedure, protectedProcedure, router } from "./_core/trpc";
import { customReports, employees, departments, positions, nineBoxPositions, goals } from "../drizzle/schema";
import { getDb } from "./db";
import { eq, sql, and, gte, lte, count, avg } from "drizzle-orm";

export const reportBuilderRouter = router({
  // Listar relatÃ³rios customizados
  list: protectedProcedure.query(async ({ ctx }) => {
    const db = await getDb();
    if (!db) return [];

    return await db
      .select()
      .from(customReports)
      .where(
        sql`${customReports.createdBy} = ${ctx.user.id} OR ${customReports.isPublic} = true`
      )
      .orderBy(sql`${customReports.createdAt} DESC`);
  }),

  // Obter relatÃ³rio por ID
  getById: protectedProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return null;

      const result = await db
        .select()
        .from(customReports)
        .where(eq(customReports.id, input.id))
        .limit(1);

      return result.length > 0 ? result[0] : null;
    }),

  // Criar relatÃ³rio customizado
  create: adminProcedure
    .input(
      z.object({
        name: z.string(),
        description: z.string().optional(),
        metrics: z.array(z.string()),
        filters: z.any().optional(),
        chartType: z.string().optional(),
        isTemplate: z.boolean().optional(),
        isPublic: z.boolean().optional(),
      })
    )
    .mutation(async ({ ctx, input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const [result] = await db.insert(customReports).values({
        ...input,
        createdBy: ctx.user.id,
        metrics: input.metrics as any,
        filters: input.filters as any,
      });

      return { id: result.insertId };
    }),

  // Atualizar relatÃ³rio
  update: adminProcedure
    .input(
      z.object({
        id: z.number(),
        name: z.string().optional(),
        description: z.string().optional(),
        metrics: z.array(z.string()).optional(),
        filters: z.any().optional(),
        chartType: z.string().optional(),
        isTemplate: z.boolean().optional(),
        isPublic: z.boolean().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { id, ...data } = input;
      await db
        .update(customReports)
        .set({
          ...data,
          metrics: data.metrics as any,
          filters: data.filters as any,
        })
        .where(eq(customReports.id, id));

      return { success: true };
    }),

  // Deletar relatÃ³rio
  delete: adminProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db.delete(customReports).where(eq(customReports.id, input.id));
      return { success: true };
    }),

  // Executar relatÃ³rio e retornar dados
  execute: protectedProcedure
    .input(
      z.object({
        metrics: z.array(z.string()),
        filters: z.any().optional(),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return { data: [], summary: {} };

      const filters = input.filters || {};
      const results: any = {};

      // Processar cada mÃ©trica solicitada
      for (const metric of input.metrics) {
        switch (metric) {
          case "headcount":
            let headcountConditions = [eq(employees.status, "ativo")];
            if (filters.departmentId) {
              headcountConditions.push(eq(employees.departmentId, filters.departmentId));
            }

            const headcount = await db
              .select({ count: count() })
              .from(employees)
              .where(and(...headcountConditions));
            results.headcount = headcount[0]?.count || 0;
            break;

          case "avgPerformance":
            const perfQuery = db
              .select({ avg: avg(nineBoxPositions.performance) })
              .from(nineBoxPositions);

            if (filters.departmentId) {
              perfQuery
                .innerJoin(employees, eq(nineBoxPositions.employeeId, employees.id))
                .where(eq(employees.departmentId, filters.departmentId));
            }

            const perf = await perfQuery;
            results.avgPerformance = perf[0]?.avg || 0;
            break;

          case "goalsCompleted":
            let goalsConditions = [eq(goals.status, "concluida")];
            if (filters.startDate && filters.endDate) {
              goalsConditions.push(
                gte(goals.startDate, new Date(filters.startDate)),
                lte(goals.endDate, new Date(filters.endDate))
              );
            }

            const goalsCompleted = await db
              .select({ count: count() })
              .from(goals)
              .where(and(...goalsConditions));
            results.goalsCompleted = goalsCompleted[0]?.count || 0;
            break;

          case "highPotential":
            const highPotQuery = db
              .select({ count: count() })
              .from(nineBoxPositions)
              .innerJoin(employees, eq(nineBoxPositions.employeeId, employees.id))
              .where(
                filters.departmentId
                  ? and(
                      sql`${nineBoxPositions.potential} >= 2`,
                      eq(employees.departmentId, filters.departmentId)
                    )
                  : sql`${nineBoxPositions.potential} >= 2`
              );

            const highPot = await highPotQuery;
            results.highPotential = highPot[0]?.count || 0;
            break;

          case "departmentBreakdown":
            const deptBreakdown = await db
              .select({
                departmentName: departments.name,
                count: count(),
              })
              .from(employees)
              .innerJoin(departments, eq(employees.departmentId, departments.id))
              .where(eq(employees.status, "ativo"))
              .groupBy(departments.name);

            results.departmentBreakdown = deptBreakdown;
            break;

          default:
            results[metric] = null;
        }
      }

      return {
        data: results,
        summary: {
          generatedAt: new Date().toISOString(),
          metricsCount: input.metrics.length,
        },
      };
    }),

  // Obter mÃ©tricas disponÃ­veis
  getAvailableMetrics: protectedProcedure.query(() => {
    return [
      { id: "headcount", name: "Total de Colaboradores", category: "geral" },
      { id: "avgPerformance", name: "Performance MÃ©dia", category: "performance" },
      { id: "goalsCompleted", name: "Metas ConcluÃ­das", category: "metas" },
      { id: "highPotential", name: "Alto Potencial", category: "talentos" },
      { id: "departmentBreakdown", name: "DistribuiÃ§Ã£o por Departamento", category: "geral" },
      { id: "turnoverRate", name: "Taxa de Turnover", category: "geral" },
      { id: "avgSalary", name: "SalÃ¡rio MÃ©dio", category: "financeiro" },
      { id: "trainingHours", name: "Horas de Treinamento", category: "desenvolvimento" },
    ];
  }),

  // Listar departamentos para filtros
  getDepartments: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) return [];

    return await db
      .select({
        id: departments.id,
        name: departments.name,
        code: departments.code,
      })
      .from(departments)
      .where(eq(departments.active, true))
      .orderBy(departments.name);
  }),

  // Listar posiÃ§Ãµes para filtros
  getPositions: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) return [];

    return await db
      .select({
        id: positions.id,
        title: positions.title,
        code: positions.code,
      })
      .from(positions)
      .where(eq(positions.active, true))
      .orderBy(positions.title);
  }),
});


========================================
ARQUIVO: ./server/reportGenerators/nineBoxPDF.ts
========================================
import { jsPDF } from "jspdf";
import autoTable from "jspdf-autotable";

/**
 * Gera relatÃ³rio PDF da Nine Box
 */
export async function generateNineBoxPDF(data: {
  positions: Array<{
    employeeName: string;
    performance: string;
    potential: string;
    position: string;
    department: string;
  }>;
  summary: {
    total: number;
    highPerformers: number;
    highPotential: number;
    criticalTalent: number;
  };
  includeCharts?: boolean;
}) {
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();

  // CabeÃ§alho
  doc.setFontSize(20);
  doc.text("RelatÃ³rio Nine Box", pageWidth / 2, 20, { align: "center" });

  doc.setFontSize(10);
  doc.setTextColor(100);
  doc.text(`Gerado em: ${new Date().toLocaleDateString("pt-BR")}`, pageWidth / 2, 28, {
    align: "center",
  });

  // Resumo Executivo
  doc.setFontSize(14);
  doc.setTextColor(0);
  doc.text("Resumo Executivo", 14, 40);

  doc.setFontSize(10);
  doc.text(`Total de Colaboradores: ${data.summary.total}`, 14, 48);
  doc.text(`High Performers: ${data.summary.highPerformers}`, 14, 54);
  doc.text(`Alto Potencial: ${data.summary.highPotential}`, 14, 60);
  doc.text(`Talentos CrÃ­ticos: ${data.summary.criticalTalent}`, 14, 66);

  // Tabela de PosiÃ§Ãµes
  doc.setFontSize(14);
  doc.text("DistribuiÃ§Ã£o de Talentos", 14, 80);

  const tableData = data.positions.map((p) => [
    p.employeeName,
    p.department,
    p.performance,
    p.potential,
    p.position,
  ]);

  autoTable(doc, {
    startY: 85,
    head: [["Colaborador", "Departamento", "Performance", "Potencial", "PosiÃ§Ã£o"]],
    body: tableData,
    theme: "grid",
    headStyles: {
      fillColor: [41, 128, 185],
      textColor: 255,
      fontStyle: "bold",
    },
    styles: {
      fontSize: 9,
      cellPadding: 3,
    },
    columnStyles: {
      0: { cellWidth: 50 },
      1: { cellWidth: 40 },
      2: { cellWidth: 30 },
      3: { cellWidth: 30 },
      4: { cellWidth: 30 },
    },
  });

  // GrÃ¡fico da Nine Box (representaÃ§Ã£o textual)
  if (data.includeCharts) {
    const finalY = (doc as any).lastAutoTable.finalY || 85;
    doc.addPage();

    doc.setFontSize(14);
    doc.text("Matriz Nine Box", 14, 20);

    // Desenhar grid 3x3
    const gridStartX = 40;
    const gridStartY = 40;
    const cellSize = 50;

    // Labels
    doc.setFontSize(8);
    doc.text("Baixo", gridStartX + cellSize * 0.5 - 5, gridStartY - 5);
    doc.text("MÃ©dio", gridStartX + cellSize * 1.5 - 5, gridStartY - 5);
    doc.text("Alto", gridStartX + cellSize * 2.5 - 5, gridStartY - 5);

    doc.text("Alto", gridStartX - 15, gridStartY + cellSize * 0.5);
    doc.text("MÃ©dio", gridStartX - 15, gridStartY + cellSize * 1.5);
    doc.text("Baixo", gridStartX - 15, gridStartY + cellSize * 2.5);

    // Desenhar grid
    for (let i = 0; i <= 3; i++) {
      doc.line(gridStartX + i * cellSize, gridStartY, gridStartX + i * cellSize, gridStartY + cellSize * 3);
      doc.line(gridStartX, gridStartY + i * cellSize, gridStartX + cellSize * 3, gridStartY + i * cellSize);
    }

    // Colorir cÃ©lulas
    const colors: { [key: string]: [number, number, number] } = {
      "alto-alto": [39, 174, 96], // Verde
      "alto-medio": [52, 152, 219], // Azul
      "alto-baixo": [241, 196, 15], // Amarelo
      "medio-alto": [52, 152, 219],
      "medio-medio": [241, 196, 15],
      "medio-baixo": [230, 126, 34], // Laranja
      "baixo-alto": [241, 196, 15],
      "baixo-medio": [230, 126, 34],
      "baixo-baixo": [231, 76, 60], // Vermelho
    };

    // Contar colaboradores por posiÃ§Ã£o
    const counts: { [key: string]: number } = {};
    data.positions.forEach((p) => {
      const key = `${p.potential.toLowerCase()}-${p.performance.toLowerCase()}`;
      counts[key] = (counts[key] || 0) + 1;
    });

    // Desenhar contagens
    doc.setFontSize(16);
    doc.setTextColor(255);
    Object.entries(counts).forEach(([key, count]) => {
      const [potential, performance] = key.split("-");
      const potentialMap: { [key: string]: number } = { alto: 0, medio: 1, baixo: 2 };
      const performanceMap: { [key: string]: number } = { baixo: 0, medio: 1, alto: 2 };

      const x = gridStartX + performanceMap[performance] * cellSize;
      const y = gridStartY + potentialMap[potential] * cellSize;

      // Preencher cÃ©lula
      const color = colors[key] || [200, 200, 200];
      doc.setFillColor(...color);
      doc.rect(x, y, cellSize, cellSize, "F");

      // Desenhar nÃºmero
      doc.text(count.toString(), x + cellSize / 2 - 5, y + cellSize / 2 + 5);
    });

    doc.setTextColor(0);
  }

  // RodapÃ©
  const totalPages = doc.getNumberOfPages();
  for (let i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text(
      `PÃ¡gina ${i} de ${totalPages}`,
      pageWidth / 2,
      doc.internal.pageSize.getHeight() - 10,
      { align: "center" }
    );
  }

  return doc.output("arraybuffer");
}


========================================
ARQUIVO: ./server/reportGenerators/pdiPDF.ts
========================================
import { jsPDF } from "jspdf";
import autoTable from "jspdf-autotable";

/**
 * Gera relatÃ³rio PDF de PDI (Plano de Desenvolvimento Individual)
 */
export async function generatePDIPDF(data: {
  pdis: Array<{
    employeeName: string;
    department: string;
    status: string;
    startDate: string;
    endDate: string;
    progress: number;
    actionsCount: number;
    completedActions: number;
  }>;
  summary: {
    total: number;
    inProgress: number;
    completed: number;
    avgProgress: number;
  };
  includeCharts?: boolean;
}) {
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();

  // CabeÃ§alho
  doc.setFontSize(20);
  doc.text("RelatÃ³rio de PDI", pageWidth / 2, 20, { align: "center" });

  doc.setFontSize(10);
  doc.setTextColor(100);
  doc.text(`Gerado em: ${new Date().toLocaleDateString("pt-BR")}`, pageWidth / 2, 28, {
    align: "center",
  });

  // Resumo Executivo
  doc.setFontSize(14);
  doc.setTextColor(0);
  doc.text("Resumo Executivo", 14, 40);

  doc.setFontSize(10);
  doc.text(`Total de PDIs: ${data.summary.total}`, 14, 48);
  doc.text(`Em Andamento: ${data.summary.inProgress}`, 14, 54);
  doc.text(`ConcluÃ­dos: ${data.summary.completed}`, 14, 60);
  doc.text(`Progresso MÃ©dio: ${data.summary.avgProgress.toFixed(1)}%`, 14, 66);

  // Tabela de PDIs
  doc.setFontSize(14);
  doc.text("Detalhamento de PDIs", 14, 80);

  const tableData = data.pdis.map((p) => [
    p.employeeName,
    p.department,
    p.status,
    `${p.progress}%`,
    `${p.completedActions}/${p.actionsCount}`,
    new Date(p.endDate).toLocaleDateString("pt-BR"),
  ]);

  autoTable(doc, {
    startY: 85,
    head: [["Colaborador", "Departamento", "Status", "Progresso", "AÃ§Ãµes", "Prazo"]],
    body: tableData,
    theme: "grid",
    headStyles: {
      fillColor: [142, 68, 173],
      textColor: 255,
      fontStyle: "bold",
    },
    styles: {
      fontSize: 9,
      cellPadding: 3,
    },
    columnStyles: {
      0: { cellWidth: 45 },
      1: { cellWidth: 35 },
      2: { cellWidth: 30 },
      3: { cellWidth: 25 },
      4: { cellWidth: 20 },
      5: { cellWidth: 25 },
    },
    didParseCell: function (data) {
      // Colorir status
      if (data.column.index === 2 && data.cell.section === "body") {
        const status = data.cell.raw as string;
        if (status === "concluido") {
          data.cell.styles.fillColor = [39, 174, 96];
          data.cell.styles.textColor = [255, 255, 255];
        } else if (status === "em_andamento") {
          data.cell.styles.fillColor = [52, 152, 219];
          data.cell.styles.textColor = [255, 255, 255];
        }
      }
    },
  });

  // GrÃ¡fico de distribuiÃ§Ã£o de status
  if (data.includeCharts) {
    const finalY = (doc as any).lastAutoTable.finalY || 85;

    if (finalY > 200) {
      doc.addPage();
    }

    const chartY = finalY > 200 ? 20 : finalY + 20;

    doc.setFontSize(14);
    doc.text("DistribuiÃ§Ã£o de Status", 14, chartY);

    // Contar por status
    const statusCounts: { [key: string]: number } = {
      em_andamento: 0,
      concluido: 0,
      pendente: 0,
    };

    data.pdis.forEach((p) => {
      statusCounts[p.status] = (statusCounts[p.status] || 0) + 1;
    });

    // Desenhar grÃ¡fico de barras simples
    const barStartY = chartY + 10;
    const barHeight = 20;
    const maxBarWidth = 120;
    const maxCount = Math.max(...Object.values(statusCounts));

    let currentY = barStartY;

    Object.entries(statusCounts).forEach(([status, count]) => {
      const barWidth = (count / maxCount) * maxBarWidth;

      // Cor da barra
      let color: [number, number, number] = [200, 200, 200];
      if (status === "concluido") color = [39, 174, 96];
      else if (status === "em_andamento") color = [52, 152, 219];
      else if (status === "pendente") color = [241, 196, 15];

      // Desenhar barra
      doc.setFillColor(...color);
      doc.rect(70, currentY, barWidth, barHeight, "F");

      // Label
      doc.setFontSize(10);
      doc.setTextColor(0);
      const statusLabel =
        status === "em_andamento"
          ? "Em Andamento"
          : status === "concluido"
            ? "ConcluÃ­do"
            : "Pendente";
      doc.text(statusLabel, 14, currentY + 13);

      // Valor
      doc.text(`${count}`, 70 + barWidth + 5, currentY + 13);

      currentY += barHeight + 5;
    });

    // DistribuiÃ§Ã£o de progresso
    doc.addPage();
    doc.setFontSize(14);
    doc.text("DistribuiÃ§Ã£o de Progresso", 14, 20);

    const progressBands = [
      { label: "0-25%", count: 0 },
      { label: "26-50%", count: 0 },
      { label: "51-75%", count: 0 },
      { label: "76-100%", count: 0 },
    ];

    data.pdis.forEach((p) => {
      if (p.progress <= 25) progressBands[0].count++;
      else if (p.progress <= 50) progressBands[1].count++;
      else if (p.progress <= 75) progressBands[2].count++;
      else progressBands[3].count++;
    });

    currentY = 30;
    const maxProgressCount = Math.max(...progressBands.map((b) => b.count));

    progressBands.forEach((band) => {
      const barWidth = (band.count / maxProgressCount) * maxBarWidth;

      // Cor gradiente
      const intensity = Math.floor((band.count / maxProgressCount) * 100);
      doc.setFillColor(52, 152, 219);
      doc.rect(70, currentY, barWidth, barHeight, "F");

      doc.setFontSize(10);
      doc.setTextColor(0);
      doc.text(band.label, 14, currentY + 13);
      doc.text(`${band.count}`, 70 + barWidth + 5, currentY + 13);

      currentY += barHeight + 5;
    });
  }

  // RodapÃ©
  const totalPages = doc.getNumberOfPages();
  for (let i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text(
      `PÃ¡gina ${i} de ${totalPages}`,
      pageWidth / 2,
      doc.internal.pageSize.getHeight() - 10,
      { align: "center" }
    );
  }

  return doc.output("arraybuffer");
}


========================================
ARQUIVO: ./server/reportGenerators/performanceExcel.ts
========================================
import ExcelJS from "exceljs";

/**
 * Gera relatÃ³rio Excel de Performance
 */
export async function generatePerformanceExcel(data: {
  employees: Array<{
    name: string;
    department: string;
    position: string;
    performanceScore: number;
    goalsCompleted: number;
    totalGoals: number;
    evaluationScore: number | null;
    pdiProgress: number;
  }>;
  summary: {
    avgPerformance: number;
    totalEmployees: number;
    highPerformers: number;
    lowPerformers: number;
  };
}) {
  const workbook = new ExcelJS.Workbook();

  // Metadados
  workbook.creator = "Sistema AVD UISA";
  workbook.created = new Date();
  workbook.modified = new Date();

  // Aba 1: Resumo
  const summarySheet = workbook.addWorksheet("Resumo", {
    views: [{ state: "frozen", xSplit: 0, ySplit: 1 }],
  });

  // TÃ­tulo
  summarySheet.mergeCells("A1:D1");
  const titleCell = summarySheet.getCell("A1");
  titleCell.value = "RelatÃ³rio de Performance";
  titleCell.font = { size: 18, bold: true, color: { argb: "FFFFFFFF" } };
  titleCell.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "FF2980B9" },
  };
  titleCell.alignment = { horizontal: "center", vertical: "middle" };
  summarySheet.getRow(1).height = 30;

  // Data
  summarySheet.getCell("A2").value = `Gerado em: ${new Date().toLocaleDateString("pt-BR")}`;
  summarySheet.getCell("A2").font = { italic: true, color: { argb: "FF666666" } };

  // Resumo Executivo
  summarySheet.getCell("A4").value = "Resumo Executivo";
  summarySheet.getCell("A4").font = { size: 14, bold: true };

  const summaryData = [
    ["MÃ©trica", "Valor"],
    ["Total de Colaboradores", data.summary.totalEmployees],
    ["Performance MÃ©dia", `${data.summary.avgPerformance.toFixed(1)}%`],
    ["High Performers (â‰¥80%)", data.summary.highPerformers],
    ["Low Performers (<60%)", data.summary.lowPerformers],
  ];

  summarySheet.addTable({
    name: "SummaryTable",
    ref: "A5",
    headerRow: true,
    style: {
      theme: "TableStyleMedium2",
      showRowStripes: true,
    },
    columns: [{ name: "MÃ©trica" }, { name: "Valor" }],
    rows: summaryData.slice(1),
  });

  // Ajustar larguras
  summarySheet.getColumn(1).width = 30;
  summarySheet.getColumn(2).width = 20;

  // Aba 2: Detalhamento
  const detailSheet = workbook.addWorksheet("Detalhamento", {
    views: [{ state: "frozen", xSplit: 0, ySplit: 1 }],
  });

  // CabeÃ§alhos
  const headers = [
    "Colaborador",
    "Departamento",
    "Cargo",
    "Score Performance",
    "Metas ConcluÃ­das",
    "Total Metas",
    "% Metas",
    "AvaliaÃ§Ã£o 360Â°",
    "Progresso PDI",
  ];

  detailSheet.addRow(headers);

  // Estilizar cabeÃ§alhos
  const headerRow = detailSheet.getRow(1);
  headerRow.font = { bold: true, color: { argb: "FFFFFFFF" } };
  headerRow.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "FF34495E" },
  };
  headerRow.alignment = { horizontal: "center", vertical: "middle" };
  headerRow.height = 25;

  // Dados
  data.employees.forEach((emp) => {
    const goalsPercent = emp.totalGoals > 0 ? (emp.goalsCompleted / emp.totalGoals) * 100 : 0;

    const row = detailSheet.addRow([
      emp.name,
      emp.department,
      emp.position,
      emp.performanceScore,
      emp.goalsCompleted,
      emp.totalGoals,
      goalsPercent,
      emp.evaluationScore || "N/A",
      emp.pdiProgress,
    ]);

    // Colorir baseado em performance
    if (emp.performanceScore >= 80) {
      row.getCell(4).fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "FF27AE60" },
      };
      row.getCell(4).font = { color: { argb: "FFFFFFFF" }, bold: true };
    } else if (emp.performanceScore < 60) {
      row.getCell(4).fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "FFE74C3C" },
      };
      row.getCell(4).font = { color: { argb: "FFFFFFFF" }, bold: true };
    }
  });

  // Ajustar larguras
  detailSheet.getColumn(1).width = 30;
  detailSheet.getColumn(2).width = 20;
  detailSheet.getColumn(3).width = 25;
  detailSheet.getColumn(4).width = 18;
  detailSheet.getColumn(5).width = 16;
  detailSheet.getColumn(6).width = 12;
  detailSheet.getColumn(7).width = 12;
  detailSheet.getColumn(8).width = 16;
  detailSheet.getColumn(9).width = 15;

  // Formatar colunas numÃ©ricas
  detailSheet.getColumn(4).numFmt = "0.0";
  detailSheet.getColumn(7).numFmt = "0.0%";
  detailSheet.getColumn(9).numFmt = "0%";

  // Adicionar bordas
  detailSheet.eachRow((row, rowNumber) => {
    if (rowNumber > 0) {
      row.eachCell((cell) => {
        cell.border = {
          top: { style: "thin" },
          left: { style: "thin" },
          bottom: { style: "thin" },
          right: { style: "thin" },
        };
      });
    }
  });

  // Aba 3: GrÃ¡fico (dados para grÃ¡fico)
  const chartDataSheet = workbook.addWorksheet("Dados GrÃ¡fico");

  // DistribuiÃ§Ã£o por faixa de performance
  const performanceBands = [
    { band: "Excelente (â‰¥90%)", count: 0 },
    { band: "Bom (80-89%)", count: 0 },
    { band: "Regular (60-79%)", count: 0 },
    { band: "Baixo (<60%)", count: 0 },
  ];

  data.employees.forEach((emp) => {
    if (emp.performanceScore >= 90) performanceBands[0].count++;
    else if (emp.performanceScore >= 80) performanceBands[1].count++;
    else if (emp.performanceScore >= 60) performanceBands[2].count++;
    else performanceBands[3].count++;
  });

  chartDataSheet.addRow(["Faixa de Performance", "Quantidade"]);
  performanceBands.forEach((band) => {
    chartDataSheet.addRow([band.band, band.count]);
  });

  chartDataSheet.getColumn(1).width = 25;
  chartDataSheet.getColumn(2).width = 15;

  // Gerar buffer
  const buffer = await workbook.xlsx.writeBuffer();
  return buffer;
}


========================================
ARQUIVO: ./server/routers.ts
========================================
import { TRPCError } from "@trpc/server";
import { z } from "zod";
import crypto from "crypto";
import { COOKIE_NAME } from "@shared/const";
import { getSessionCookieOptions } from "./_core/cookies";
import { systemRouter } from "./_core/systemRouter";
import { protectedProcedure, publicProcedure, router } from "./_core/trpc";
import * as db from "./db";
import { getUserByOpenId } from "./db";
import { employees, goals, pdiPlans, pdiItems, performanceEvaluations, nineBoxPositions, passwordResetTokens, users, successionPlans, testQuestions, psychometricTests, systemSettings, emailMetrics, calibrationSessions, calibrationReviews, evaluationResponses, evaluationQuestions, departments, positions, evaluationCycles, notifications, auditLogs, scheduledReports, reportExecutionLogs, workflows, workflowInstances, workflowStepApprovals, smtpConfig } from "../drizzle/schema";
import { getDb } from "./db";
import { analyticsRouter } from "./analyticsRouter";
import { feedbackRouter } from "./feedbackRouter";
import { badgesRouter } from "./badgesRouter";
import { scheduledReportsRouter } from "./scheduledReportsRouter";
import { executiveRouter } from "./executiveRouter";
import { successionRouter } from "./successionRouter";
import { nineBoxRouter } from "./nineBoxRouter";
import { pdiIntelligentRouter } from "./pdiIntelligentRouter";
import { evaluation360Router } from "./evaluation360Router";
import { reportBuilderRouter } from "./reportBuilderRouter";
import { reportAnalyticsRouter } from "./reportAnalyticsRouter";
import { goalsRouter } from "./goalsRouter";
import { goalsCascadeRouter } from "./goalsCascadeRouter";
import { cyclesRouter } from "./cyclesRouter";
import { bonusRouter } from "./bonusRouter";
import { calibrationRouter } from "./calibrationRouter";
import { gamificationRouter } from "./gamificationRouter";
import { integrationsRouter } from "./integrationsRouter";
import { notificationsRouter } from "./notificationsRouter";
import { pulseRouter } from "./routers/pulseRouter";
import { positionsRouter } from "./routers/positionsRouter";
import { jobDescriptionsRouter } from "./routers/jobDescriptionsRouter";
import { jobDescriptionsPDFRouter } from "./routers/jobDescriptionsPDF";
import { productivityRouter } from "./routers/productivityRouter";
import { importRouter } from "./routers/importRouter";
import { alertsRouter } from "./routers/alertsRouter";
import { timeClockRouter } from "./routers/timeClockRouter";
import { organizationRouter } from "./routers/organizationRouter";
import { goalApprovalsRouter } from "./goalApprovalsRouter";
import { eq, and, desc, sql } from "drizzle-orm";

export const appRouter = router({
  system: systemRouter,
  
  auth: router({
    me: publicProcedure.query(opts => opts.ctx.user),
    logout: publicProcedure.mutation(({ ctx }) => {
      const cookieOptions = getSessionCookieOptions(ctx.req);
      ctx.res.clearCookie(COOKIE_NAME, { ...cookieOptions, maxAge: -1 });
      return {
        success: true,
      } as const;
    }),

    // Solicitar reset de senha
    requestPasswordReset: publicProcedure
      .input(z.object({ email: z.string().email() }))
      .mutation(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        // Buscar usuÃ¡rio por e-mail
        const user = await db.select()
          .from(users)
          .where(eq(users.email, input.email))
          .limit(1);

        if (user.length === 0) {
          // NÃ£o revelar se o e-mail existe ou nÃ£o (seguranÃ§a)
          return { success: true };
        }

        // Gerar token Ãºnico
        const token = crypto.randomBytes(32).toString('hex');
        const expiresAt = new Date();
        expiresAt.setHours(expiresAt.getHours() + 1); // Expira em 1 hora

        // Salvar token no banco
        await db.insert(passwordResetTokens).values({
          userId: user[0].id,
          token,
          expiresAt,
        });

        // TODO: Enviar e-mail com link de reset
        // await emailService.sendResetPassword(input.email, { token, name: user[0].name });

        return { success: true };
      }),

    // Validar token de reset
    validateResetToken: publicProcedure
      .input(z.object({ token: z.string() }))
      .query(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const tokenRecord = await db.select()
          .from(passwordResetTokens)
          .where(
            and(
              eq(passwordResetTokens.token, input.token),
              eq(passwordResetTokens.used, false)
            )
          )
          .limit(1);

        if (tokenRecord.length === 0) {
          return { valid: false, message: "Token invÃ¡lido" };
        }

        const token = tokenRecord[0];
        if (new Date() > new Date(token.expiresAt)) {
          return { valid: false, message: "Token expirado" };
        }

        return { valid: true };
      }),

    // Redefinir senha
    resetPassword: publicProcedure
      .input(z.object({ token: z.string(), newPassword: z.string().min(6) }))
      .mutation(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        // Validar token
        const tokenRecord = await db.select()
          .from(passwordResetTokens)
          .where(
            and(
              eq(passwordResetTokens.token, input.token),
              eq(passwordResetTokens.used, false)
            )
          )
          .limit(1);

        if (tokenRecord.length === 0) {
          throw new Error("Token invÃ¡lido");
        }

        const token = tokenRecord[0];
        if (new Date() > new Date(token.expiresAt)) {
          throw new Error("Token expirado");
        }

        // TODO: Atualizar senha do usuÃ¡rio (requer implementaÃ§Ã£o de hash de senha)
        // await db.update(users)
        //   .set({ password: await hashPassword(input.newPassword) })
        //   .where(eq(users.id, token.userId));

        // Marcar token como usado
        await db.update(passwordResetTokens)
          .set({ used: true })
          .where(eq(passwordResetTokens.id, token.id));

        return { success: true };
      }),
  }),

  // ============================================================================
  // COLABORADORES
  // ============================================================================
  employees: router({
    list: protectedProcedure.query(async () => {
      try {
        const result = await db.getAllEmployees();
        return result || [];
      } catch (error) {
        console.error('[employees.list] Error:', error);
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'Erro ao buscar funcionÃ¡rios',
          cause: error,
        });
      }
    }),

    getById: protectedProcedure
      .input(z.object({ id: z.number() }))
      .query(async ({ input }) => {
        const employee = await db.getEmployeeById(input.id);
        if (!employee) {
          throw new TRPCError({
            code: "NOT_FOUND",
            message: "Colaborador nÃ£o encontrado",
          });
        }
        return employee;
      }),

    getByUserId: protectedProcedure
      .input(z.object({ userId: z.number() }))
      .query(async ({ input }) => {
        const employee = await db.getEmployeeByUserId(input.userId);
        return employee || null;
      }),

    getCurrent: protectedProcedure.query(async ({ ctx }) => {
      if (!ctx.user) {
        throw new TRPCError({
          code: "UNAUTHORIZED",
          message: "UsuÃ¡rio nÃ£o autenticado",
        });
      }
      const employee = await db.getEmployeeByUserId(ctx.user.id);
      return employee || null;
    }),

    // Buscar equipe direta do gestor
    getTeamByManager: protectedProcedure
      .input(z.object({ managerId: z.number() }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        const teamMembers = await database
          .select({
            id: employees.id,
            name: employees.name,
            email: employees.email,
            managerId: employees.managerId,
            departmentId: employees.departmentId,
            positionId: employees.positionId,
          })
          .from(employees)
          .where(eq(employees.managerId, input.managerId));

        // Buscar departamentos e cargos
        const depts = await database.select().from(departments);
        const positionsData = await database.select().from(positions);

        return teamMembers.map(emp => ({
          ...emp,
          department: depts.find(d => d.id === emp.departmentId),
          position: positionsData.find((p: any) => p.id === emp.positionId),
        }));
      }),

    // Hierarquia organizacional
    getHierarchy: protectedProcedure.query(async () => {
      const database = await getDb();
      if (!database) return [];

      // Buscar todos os colaboradores com JOIN em departments e positions
      const allEmployees = await database
        .select({
          id: employees.id,
          userId: employees.userId,
          employeeCode: employees.employeeCode,
          name: employees.name,
          email: employees.email,
          managerId: employees.managerId,
          costCenter: employees.costCenter,
          department: departments.name,
          departmentId: employees.departmentId,
          position: positions.title,
          positionId: employees.positionId,
        })
        .from(employees)
        .leftJoin(departments, eq(employees.departmentId, departments.id))
        .leftJoin(positions, eq(employees.positionId, positions.id));
      
      // Calcular contagem de subordinados para cada colaborador
      const employeesWithCount = allEmployees.map(emp => {
        const subordinateCount = allEmployees.filter(e => e.managerId === emp.id).length;
        return { ...emp, subordinateCount };
      });
      
      return employeesWithCount;
    }),

    // Atualizar colaborador (para importaÃ§Ã£o em massa)
    exportHierarchyReport: protectedProcedure.query(async ({ ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar todos os colaboradores com departamentos e cargos
      const allEmployees = await db
        .select({
          id: employees.id,
          name: employees.name,
          email: employees.email,
          managerId: employees.managerId,
          departmentId: employees.departmentId,
          positionId: employees.positionId,
          costCenter: employees.costCenter,
        })
        .from(employees);

      // Buscar departamentos e cargos
      const depts = await db.select().from(departments);
      const positionsData = await db.select().from(positions);

      // Calcular estatÃ­sticas
      const totalEmployees = allEmployees.length;
      const employeesWithManager = allEmployees.filter(e => e.managerId).length;
      const employeesWithoutManager = totalEmployees - employeesWithManager;
      const uniqueManagers = new Set(allEmployees.map(e => e.managerId).filter(Boolean)).size;

      // Agrupar por departamento
      const byDepartment = new Map<number, number>();
      allEmployees.forEach(e => {
        if (e.departmentId) {
          byDepartment.set(e.departmentId, (byDepartment.get(e.departmentId) || 0) + 1);
        }
      });

      // Calcular span of control (mÃ©dia de subordinados por gestor)
      const subordinatesCount = new Map<number, number>();
      allEmployees.forEach(e => {
        if (e.managerId) {
          subordinatesCount.set(e.managerId, (subordinatesCount.get(e.managerId) || 0) + 1);
        }
      });
      const avgSpanOfControl = subordinatesCount.size > 0
        ? Array.from(subordinatesCount.values()).reduce((a, b) => a + b, 0) / subordinatesCount.size
        : 0;

      return {
        totalEmployees,
        employeesWithManager,
        employeesWithoutManager,
        uniqueManagers,
        avgSpanOfControl: Math.round(avgSpanOfControl * 10) / 10,
        departmentStats: Array.from(byDepartment.entries()).map(([deptId, count]) => ({
          departmentId: deptId,
          departmentName: depts.find(d => d.id === deptId)?.name || `Dept ${deptId}`,
          count,
        })),
        employeesWithoutManagerList: allEmployees
          .filter(e => !e.managerId)
          .map(e => ({
            id: e.id,
            name: e.name,
            email: e.email,
            department: depts.find(d => d.id === e.departmentId)?.name || "",
            position: positionsData.find((p: any) => p.id === e.positionId)?.title || "",
            costCenter: e.costCenter || "",
          })),
      };
    }),

    updateEmployee: protectedProcedure
      .input(
        z.object({
          id: z.number(),
          managerId: z.number().optional(),
          costCenter: z.string().optional(),
        })
      )
      .mutation(async ({ input }) => {
        const database = await getDb();
        if (!database) {
          throw new TRPCError({
            code: "INTERNAL_SERVER_ERROR",
            message: "Database not available",
          });
        }

        const updateData: any = {};
        if (input.managerId !== undefined) updateData.managerId = input.managerId;
        if (input.costCenter !== undefined) updateData.costCenter = input.costCenter;

        await database
          .update(employees)
          .set(updateData)
          .where(eq(employees.id, input.id));

        return { success: true, message: "Colaborador atualizado com sucesso" };
      }),

    // Atualizar colaborador completo (para formulÃ¡rio de ediÃ§Ã£o)
    update: protectedProcedure
      .input(
        z.object({
          id: z.number(),
          employeeCode: z.string(),
          name: z.string(),
          email: z.string().email(),
          cpf: z.string().optional(),
          birthDate: z.string().optional(),
          hireDate: z.string(),
          departmentId: z.number(),
          positionId: z.number(),
          managerId: z.number().optional(),
          salary: z.number().optional(),
          hierarchyLevel: z.enum(["diretoria", "gerencia", "coordenacao", "supervisao", "operacional"]).optional(),
          phone: z.string().optional(),
          address: z.string().optional(),
        })
      )
      .mutation(async ({ input }) => {
        const database = await getDb();
        if (!database) {
          throw new TRPCError({
            code: "INTERNAL_SERVER_ERROR",
            message: "Database not available",
          });
        }

        const updateData: any = {
          employeeCode: input.employeeCode,
          name: input.name,
          email: input.email,
          hireDate: input.hireDate,
          departmentId: input.departmentId,
          positionId: input.positionId,
          updatedAt: new Date(),
        };

        if (input.cpf !== undefined) updateData.cpf = input.cpf;
        if (input.birthDate !== undefined) updateData.birthDate = input.birthDate;
        if (input.managerId !== undefined) updateData.managerId = input.managerId;
        if (input.salary !== undefined) updateData.salary = input.salary;
        if (input.hierarchyLevel !== undefined) updateData.hierarchyLevel = input.hierarchyLevel;
        if (input.phone !== undefined) updateData.phone = input.phone;
        if (input.address !== undefined) updateData.address = input.address;

        await database
          .update(employees)
          .set(updateData)
          .where(eq(employees.id, input.id));

        return { success: true, message: "Colaborador atualizado com sucesso" };
      }),

    getDepartments: protectedProcedure.query(async () => {
      const database = await getDb();
      if (!database) return [];

      const allDepartments = await database.select().from(departments).where(eq(departments.active, true));
      return allDepartments.map(d => d.name).sort();
    }),

    getManagers: protectedProcedure.query(async () => {
      const database = await getDb();
      if (!database) return [];

      const allEmployees = await database.select().from(employees);
      return allEmployees;
    }),
  }),

  // ============================================================================
  // METAS
  // ============================================================================
  goals: router({
    list: protectedProcedure
      .input(z.object({ 
        employeeId: z.number().optional(),
        cycleId: z.number().optional(),
      }))
      .query(async ({ input, ctx }) => {
        const employeeId = input.employeeId || (await db.getEmployeeByUserId(ctx.user!.id))?.id;
        if (!employeeId) {
          return [];
        }
        return await db.getGoalsByEmployee(employeeId, input.cycleId);
      }),

    getById: protectedProcedure
      .input(z.object({ id: z.number() }))
      .query(async ({ input }) => {
        const goal = await db.getGoalById(input.id);
        if (!goal) {
          throw new TRPCError({
            code: "NOT_FOUND",
            message: "Meta nÃ£o encontrada",
          });
        }
        return goal;
      }),

    // Buscar metas da equipe do gestor
    getTeamGoals: protectedProcedure
      .input(z.object({ managerId: z.number() }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        // Buscar subordinados diretos
        const teamMembers = await database
          .select({ id: employees.id })
          .from(employees)
          .where(eq(employees.managerId, input.managerId));

        const teamMemberIds = teamMembers.map(e => e.id);
        if (teamMemberIds.length === 0) return [];

        // Buscar metas dos subordinados
        const teamGoals = await database
          .select()
          .from(goals)
          .where(sql`${goals.employeeId} IN (${sql.join(teamMemberIds, sql`, `)})`);

        // Buscar dados dos colaboradores
        const employeesData = await database
          .select({
            id: employees.id,
            name: employees.name,
          })
          .from(employees)
          .where(sql`${employees.id} IN (${sql.join(teamMemberIds, sql`, `)})`);

        return teamGoals.map(goal => ({
          ...goal,
          employee: employeesData.find(e => e.id === goal.employeeId),
        }));
      }),

    create: protectedProcedure
      .input(z.object({
        cycleId: z.number(),
        employeeId: z.number(),
        title: z.string().min(1),
        description: z.string().optional(),
        type: z.enum(["individual", "equipe", "organizacional"]),
        category: z.enum(["quantitativa", "qualitativa"]),
        targetValue: z.string().optional(),
        unit: z.string().optional(),
        weight: z.number().default(1),
        startDate: z.date(),
        endDate: z.date(),
        linkedToPLR: z.boolean().default(false),
        linkedToBonus: z.boolean().default(false),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) {
          throw new TRPCError({
            code: "INTERNAL_SERVER_ERROR",
            message: "Banco de dados indisponÃ­vel",
          });
        }

        const [result] = await database.insert(goals).values({
          ...input,
          createdBy: ctx.user!.id,
          status: "rascunho",
          progress: 0,
        });

        const goalId = Number(result.insertId);

        await db.logAudit(
          ctx.user!.id,
          "CREATE",
          "goals",
          goalId,
          input,
          ctx.req.ip,
          ctx.req.headers["user-agent"]
        );

        return { id: goalId, success: true };
      }),

    updateProgress: protectedProcedure
      .input(z.object({
        id: z.number(),
        progress: z.number().min(0).max(100),
        currentValue: z.string().optional(),
        notes: z.string().optional(),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) {
          throw new TRPCError({
            code: "INTERNAL_SERVER_ERROR",
            message: "Banco de dados indisponÃ­vel",
          });
        }

        const goal = await db.getGoalById(input.id);
        if (!goal) {
          throw new TRPCError({
            code: "NOT_FOUND",
            message: "Meta nÃ£o encontrada",
          });
        }

        await database.update(goals)
          .set({
            progress: input.progress,
            currentValue: input.currentValue,
            status: input.progress === 100 ? "concluida" : "em_andamento",
          })
          .where(eq(goals.id, input.id));

        await db.logAudit(
          ctx.user!.id,
          "UPDATE_PROGRESS",
          "goals",
          input.id,
          { progress: input.progress, currentValue: input.currentValue },
          ctx.req.ip,
          ctx.req.headers["user-agent"]
        );

        // Verificar badges de metas se progresso = 100%
        if (input.progress === 100 && goal.employeeId) {
          const { checkGoalBadges } = await import("./services/badgeService");
          await checkGoalBadges(goal.employeeId);

          // Criar notificaÃ§Ã£o de meta atingida
          try {
            const employee = await database.select()
              .from(employees)
              .where(eq(employees.id, goal.employeeId))
              .limit(1);

            if (employee.length > 0 && employee[0].managerId) {
              const manager = await database.select()
                .from(employees)
                .where(eq(employees.id, employee[0].managerId))
                .limit(1);

              if (manager.length > 0 && manager[0].userId) {
                await createNotification({
                  userId: manager[0].userId,
                  type: "goal_achieved",
                  title: "Meta Atingida",
                  message: `${employee[0].name} atingiu 100% da meta: ${goal.title}`,
                  link: `/metas`,
                });
              }
            }
          } catch (error) {
            console.error("Erro ao criar notificaÃ§Ã£o de meta:", error);
          }
        }

        // Notificar marcos de progresso (25%, 50%, 75%)
        const milestones = [25, 50, 75];
        if (milestones.includes(input.progress) && goal.employeeId) {
          try {
            const employee = await database.select()
              .from(employees)
              .where(eq(employees.id, goal.employeeId))
              .limit(1);

            if (employee.length > 0 && employee[0].managerId) {
              const manager = await database.select()
                .from(employees)
                .where(eq(employees.id, employee[0].managerId))
                .limit(1);

              if (manager.length > 0 && manager[0].userId) {
                await createNotification({
                  userId: manager[0].userId,
                  type: "pdi_milestone",
                  title: "Marco de Progresso Atingido",
                  message: `${employee[0].name} atingiu ${input.progress}% da meta: ${goal.title}`,
                  link: `/metas`,
                });
              }
            }
          } catch (error) {
            console.error("Erro ao criar notificaÃ§Ã£o de marco:", error);
          }
        }

        return { success: true };
      }),
  }),

  // ============================================================================
  // AVALIAÃ‡Ã•ES 360Â°
  // ============================================================================
  evaluations: router({
    list: protectedProcedure
      .input(z.object({
        employeeId: z.number().optional(),
        cycleId: z.number().optional(),
      }))
      .query(async ({ input, ctx }) => {
        const employeeId = input.employeeId || (await db.getEmployeeByUserId(ctx.user!.id))?.id;
        if (!employeeId) {
          return [];
        }
        return await db.getEvaluationsByEmployee(employeeId, input.cycleId);
      }),

    getById: protectedProcedure
      .input(z.object({ id: z.number() }))
      .query(async ({ input }) => {
        const evaluation = await db.getEvaluationById(input.id);
        if (!evaluation) {
          throw new TRPCError({
            code: "NOT_FOUND",
            message: "AvaliaÃ§Ã£o nÃ£o encontrada",
          });
        }
        return evaluation;
      }),

    create: protectedProcedure
      .input(z.object({
        cycleId: z.number(),
        employeeId: z.number(),
        type: z.enum(["360", "180", "90"]),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) {
          throw new TRPCError({
            code: "INTERNAL_SERVER_ERROR",
            message: "Banco de dados indisponÃ­vel",
          });
        }

        const [result] = await database.insert(performanceEvaluations).values({
          ...input,
          status: "pendente",
        });

        const evaluationId = Number(result.insertId);

        await db.logAudit(
          ctx.user!.id,
          "CREATE",
          "performanceEvaluations",
          evaluationId,
          input,
          ctx.req.ip,
          ctx.req.headers["user-agent"]
        );

        return { id: evaluationId, success: true };
      }),

    // Buscar avaliaÃ§Ãµes pendentes do usuÃ¡rio logado (como avaliador)
    listPending: protectedProcedure
      .input(z.object({ 
        evaluatorId: z.number().optional() 
      }))
      .query(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) return [];

        // Buscar employee do usuÃ¡rio logado
        const employee = await db.getEmployeeByUserId(ctx.user!.id);
        if (!employee) return [];

        const evaluatorId = input.evaluatorId || employee.id;

        // Buscar avaliaÃ§Ãµes 360Â° onde o usuÃ¡rio Ã© avaliador (usando performanceEvaluations)
        const evaluations360 = await database
          .select({
            id: performanceEvaluations.id,
            employeeId: performanceEvaluations.employeeId,
            cycleId: performanceEvaluations.cycleId,
            type: sql<string>`'360'`.as('type'),
            status: performanceEvaluations.workflowStatus,
            deadline: sql<Date | null>`NULL`.as('deadline'),
          })
          .from(performanceEvaluations)
          .where(
            sql`${performanceEvaluations.type} = '360' AND ${performanceEvaluations.workflowStatus} IN ('pending_manager', 'pending_consensus')`
          );

        // Buscar autoavaliaÃ§Ãµes pendentes
        const autoAvaliacoes = await database
          .select({
            id: performanceEvaluations.id,
            employeeId: performanceEvaluations.employeeId,
            cycleId: performanceEvaluations.cycleId,
            type: sql<string>`'autoavaliacao'`.as('type'),
            status: performanceEvaluations.workflowStatus,
            deadline: sql<Date | null>`NULL`.as('deadline'),
          })
          .from(performanceEvaluations)
          .where(
            sql`${performanceEvaluations.type} = '360' AND ${performanceEvaluations.workflowStatus} = 'pending_self' AND ${performanceEvaluations.employeeId} = ${evaluatorId}`
          );

        // Buscar avaliaÃ§Ãµes de performance pendentes
        const performanceEvals = await database
          .select({
            id: performanceEvaluations.id,
            employeeId: performanceEvaluations.employeeId,
            cycleId: performanceEvaluations.cycleId,
            type: sql<string>`'performance'`.as('type'),
            status: performanceEvaluations.status,
            deadline: sql<Date | null>`NULL`.as('deadline'),
          })
          .from(performanceEvaluations)
          .where(
            sql`${performanceEvaluations.status} IN ('pendente', 'em_andamento')`
          );

        // Combinar todas as avaliaÃ§Ãµes
        const allEvaluations = [...evaluations360, ...autoAvaliacoes, ...performanceEvals];

        // Buscar dados dos colaboradores
        const employeeIds = Array.from(new Set(allEvaluations.map(e => e.employeeId)));
        const employeesData = employeeIds.length > 0
          ? await database
              .select({
                id: employees.id,
                name: employees.name,
                positionId: employees.positionId,
              })
              .from(employees)
              .where(sql`${employees.id} IN (${sql.join(employeeIds, sql`, `)})`)
          : [];

        // Buscar dados dos cargos
        const positionIds = employeesData.map(e => e.positionId).filter(Boolean);
        const positionsData = positionIds.length > 0
          ? await database
              .select()
              .from(positions)
              .where(sql`${positions.id} IN (${sql.join(positionIds, sql`, `)})`)
          : [];

        // Buscar dados dos ciclos
        const cycleIds = Array.from(new Set(allEvaluations.map(e => e.cycleId)));
        const cyclesData = cycleIds.length > 0
          ? await database
              .select()
              .from(evaluationCycles)
              .where(sql`${evaluationCycles.id} IN (${sql.join(cycleIds, sql`, `)})`)
          : [];

        // Montar resposta com dados completos
        return allEvaluations.map(evaluation => {
          const emp = employeesData.find(e => e.id === evaluation.employeeId);
          const position = positionsData.find((p: any) => p.id === emp?.positionId);
          const cycle = cyclesData.find((c: any) => c.id === evaluation.cycleId);

          return {
            id: evaluation.id,
            employeeId: evaluation.employeeId,
            employeeName: emp?.name || null,
            positionTitle: (position as any)?.title || null,
            cycleId: evaluation.cycleId,
            cycleName: (cycle as any)?.name || null,
            type: evaluation.type,
            status: evaluation.status,
            deadline: evaluation.deadline,
          };
        });
      }),

    // Buscar avaliaÃ§Ãµes pendentes da equipe do gestor
    getPendingByManager: protectedProcedure
      .input(z.object({ managerId: z.number() }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        // Buscar subordinados diretos
        const teamMembers = await database
          .select({ id: employees.id })
          .from(employees)
          .where(eq(employees.managerId, input.managerId));

        const teamMemberIds = teamMembers.map(e => e.id);
        if (teamMemberIds.length === 0) return [];

        // Buscar avaliaÃ§Ãµes pendentes dos subordinados
        const pendingEvaluations = await database
          .select()
          .from(performanceEvaluations)
          .where(
            sql`${performanceEvaluations.employeeId} IN (${sql.join(teamMemberIds, sql`, `)}) AND ${performanceEvaluations.status} IN ('pendente', 'em_andamento')`
          );

        // Buscar dados dos colaboradores e ciclos
        const employeesData = await database
          .select({
            id: employees.id,
            name: employees.name,
          })
          .from(employees)
          .where(sql`${employees.id} IN (${sql.join(teamMemberIds, sql`, `)})`);

        const cyclesData = await database.select().from(evaluationCycles);

        return pendingEvaluations.map(evaluation => ({
          ...evaluation,
          employee: employeesData.find(e => e.id === evaluation.employeeId),
          cycle: cyclesData.find((c: any) => c.id === evaluation.cycleId),
        }));
      }),
  }),

  // ============================================================================
  // PDI (Plano de Desenvolvimento Individual)
  // ============================================================================
  pdi: router({
    list: protectedProcedure
      .input(z.object({
        employeeId: z.number().optional(),
        cycleId: z.number().optional(),
      }))
      .query(async ({ input, ctx }) => {
        const employeeId = input.employeeId || (await db.getEmployeeByUserId(ctx.user!.id))?.id;
        if (!employeeId) {
          return [];
        }
        return await db.getPDIsByEmployee(employeeId, input.cycleId);
      }),

    getById: protectedProcedure
      .input(z.object({ id: z.number() }))
      .query(async ({ input }) => {
        const pdi = await db.getPDIById(input.id);
        if (!pdi) {
          throw new TRPCError({
            code: "NOT_FOUND",
            message: "PDI nÃ£o encontrado",
          });
        }
        return pdi;
      }),

    getItems: protectedProcedure
      .input(z.object({ planId: z.number() }))
      .query(async ({ input }) => {
        return await db.getPDIItemsByPlan(input.planId);
      }),

    // Buscar PDIs da equipe do gestor
    getTeamPDIs: protectedProcedure
      .input(z.object({ managerId: z.number() }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        // Buscar subordinados diretos
        const teamMembers = await database
          .select({ id: employees.id })
          .from(employees)
          .where(eq(employees.managerId, input.managerId));

        const teamMemberIds = teamMembers.map(e => e.id);
        if (teamMemberIds.length === 0) return [];

        // Buscar PDIs dos subordinados
        const teamPDIs = await database
          .select()
          .from(pdiPlans)
          .where(sql`${pdiPlans.employeeId} IN (${sql.join(teamMemberIds, sql`, `)})`);

        // Buscar dados dos colaboradores e cargos
        const employeesData = await database
          .select({
            id: employees.id,
            name: employees.name,
          })
          .from(employees)
          .where(sql`${employees.id} IN (${sql.join(teamMemberIds, sql`, `)})`);

        const positionsData = await database.select().from(positions);

        return teamPDIs.map(pdi => ({
          ...pdi,
          employee: employeesData.find(e => e.id === pdi.employeeId),
          targetPosition: positionsData.find((p: any) => p.id === pdi.targetPositionId),
        }));
      }),

    create: protectedProcedure
      .input(z.object({
        cycleId: z.number(),
        employeeId: z.number(),
        targetPositionId: z.number().optional(),
        startDate: z.date(),
        endDate: z.date(),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) {
          throw new TRPCError({
            code: "INTERNAL_SERVER_ERROR",
            message: "Banco de dados indisponÃ­vel",
          });
        }

        const [result] = await database.insert(pdiPlans).values({
          ...input,
          status: "rascunho",
          overallProgress: 0,
        });

        const pdiId = Number(result.insertId);

        await db.logAudit(
          ctx.user!.id,
          "CREATE",
          "pdiPlans",
          pdiId,
          input,
          ctx.req.ip,
          ctx.req.headers["user-agent"]
        );

        // Verificar badges de PDI ao criar
        if (input.employeeId) {
          const { checkPDIBadges } = await import("./services/badgeService");
          await checkPDIBadges(input.employeeId);
        }

        return { id: pdiId, success: true };
      }),

    addItem: protectedProcedure
      .input(z.object({
        planId: z.number(),
        actionId: z.number().optional(),
        competencyId: z.number(),
        title: z.string().min(1),
        description: z.string().optional(),
        category: z.enum(["70_pratica", "20_mentoria", "10_curso"]),
        type: z.string().optional(),
        startDate: z.date(),
        endDate: z.date(),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) {
          throw new TRPCError({
            code: "INTERNAL_SERVER_ERROR",
            message: "Banco de dados indisponÃ­vel",
          });
        }

        const [result] = await database.insert(pdiItems).values({
          ...input,
          status: "pendente",
          progress: 0,
        });

        const itemId = Number(result.insertId);

        await db.logAudit(
          ctx.user!.id,
          "ADD_ITEM",
          "pdiItems",
          itemId,
          input,
          ctx.req.ip,
          ctx.req.headers["user-agent"]
        );

        return { id: itemId, success: true };
      }),

    getDevelopmentActions: protectedProcedure.query(async () => {
      return await db.getDevelopmentActions();
    }),
  }),

  // ============================================================================
  // MATRIZ 9-BOX
  // ============================================================================
  nineBox: router({
    getByCycle: protectedProcedure
      .input(z.object({ cycleId: z.number() }))
      .query(async ({ input }) => {
        return await db.getNineBoxByCycle(input.cycleId);
      }),

    // Listar posiÃ§Ãµes da matriz 9-box
    list: protectedProcedure
      .input(z.object({ cycleId: z.number() }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        const positions = await database.select()
          .from(nineBoxPositions)
          .innerJoin(employees, eq(nineBoxPositions.employeeId, employees.id))
          .where(eq(nineBoxPositions.cycleId, input.cycleId));

        return positions.map(p => ({
          employeeId: p.nineBoxPositions.employeeId,
          employeeName: p.employees.name,
          positionName: 'Cargo', // TODO: Join com positions table
          departmentName: 'Departamento', // TODO: Join com departments table
          performance: p.nineBoxPositions.performance,
          potential: p.nineBoxPositions.potential,
          calibratedAt: p.nineBoxPositions.calibratedAt,
        }));
      }),

    // Ajustar posiÃ§Ã£o (calibraÃ§Ã£o/RH)
    adjust: protectedProcedure
      .input(z.object({
        cycleId: z.number(),
        employeeId: z.number(),
        performance: z.number().min(1).max(3),
        potential: z.number().min(1).max(3),
        reason: z.string(),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) throw new Error("Database not available");

        const employee = await getUserByOpenId(ctx.user.openId);
        if (!employee) throw new Error("Employee not found");

        const box = `${input.performance}_${input.potential}`;

        await database.update(nineBoxPositions)
          .set({
            performance: input.performance,
            potential: input.potential,
            box,
            calibratedBy: employee.id,
            calibratedAt: new Date(),
            notes: input.reason,
          })
          .where(
            and(
              eq(nineBoxPositions.cycleId, input.cycleId),
              eq(nineBoxPositions.employeeId, input.employeeId)
            )
          );

        return { success: true };
      }),

    updatePosition: protectedProcedure
      .input(z.object({
        id: z.number(),
        performance: z.number().min(1).max(3),
        potential: z.number().min(1).max(3),
        notes: z.string().optional(),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) {
          throw new TRPCError({
            code: "INTERNAL_SERVER_ERROR",
            message: "Banco de dados indisponÃ­vel",
          });
        }

        const box = `${input.performance}_${input.potential}`;
        
        await database.update(nineBoxPositions)
          .set({
            performance: input.performance,
            potential: input.potential,
            box,
            notes: input.notes,
          })
          .where(eq(nineBoxPositions.id, input.id));

        await db.logAudit(
          ctx.user!.id,
          "UPDATE_POSITION",
          "nineBoxPositions",
          input.id,
          input,
          ctx.req.ip,
          ctx.req.headers["user-agent"]
        );

        return { success: true };
      }),
  }),

  // ============================================================================
  // DASHBOARD E ESTATÃSTICAS
  // ============================================================================
  dashboard: router({
    getStats: protectedProcedure
      .input(z.object({
        employeeId: z.number().optional(),
        cycleId: z.number().optional(),
      }))
      .query(async ({ input, ctx }) => {
        const employeeId = input.employeeId || (await db.getEmployeeByUserId(ctx.user!.id))?.id;
        if (!employeeId) {
          // Retornar dados vazios se colaborador nÃ£o existir
          return {
            activeGoals: 0,
            completedGoals: 0,
            pendingEvaluations: 0,
            activePDIs: 0,
            recentActivities: [],
            cycle: null,
            goalsCount: 0,
            pdisCount: 0,
            evaluationsCount: 0,
          };
        }
        return await db.getDashboardStats(employeeId, input.cycleId);
      }),
  }),

  // ============================================================================
  // CICLOS, DEPARTAMENTOS E CARGOS (Legacy)
  // ============================================================================
  cyclesLegacy: router({
    list: protectedProcedure.query(async () => {
      return await db.getAllCycles();
    }),

    getActive: protectedProcedure.query(async () => {
      return await db.getActiveCycle();
    }),
  }),

  departments: router({
    list: protectedProcedure.query(async () => {
      return await db.getAllDepartments();
    }),
  }),

  positions: router({
    list: protectedProcedure.query(async () => {
      return await db.getAllPositions();
    }),
  }),

  // ============================================================================
  // COMPETÃŠNCIAS
  // ============================================================================
  competencies: router({
    getByEmployee: protectedProcedure
      .input(z.object({ employeeId: z.number() }))
      .query(async ({ input }) => {
        return await db.getEmployeeCompetencies(input.employeeId);
      }),
  }),

  // ============================================================================
  // PDI INTELIGENTE COM IA
  // ============================================================================
  pdiAI: router({
    // Gerar recomendaÃ§Ãµes de PDI com IA Gemini
    generateRecommendations: protectedProcedure
      .input(z.object({ 
        employeeId: z.number(),
        competencyGaps: z.array(z.object({
          competencyName: z.string(),
          currentLevel: z.number(),
          requiredLevel: z.number(),
          category: z.string()
        }))
      }))
      .mutation(async ({ input }) => {
        const { invokeLLM } = await import("./_core/llm");
        
        const gapsText = input.competencyGaps
          .map(g => `- ${g.competencyName} (${g.category}): NÃ­vel atual ${g.currentLevel}, NÃ­vel esperado ${g.requiredLevel}, Gap: ${g.requiredLevel - g.currentLevel}`)
          .join("\n");

        const prompt = `VocÃª Ã© um especialista em Recursos Humanos e Desenvolvimento de Pessoas. Analise os gaps de competÃªncias abaixo e gere recomendaÃ§Ãµes de aÃ§Ãµes de desenvolvimento seguindo o modelo 70-20-10:

**Gaps de CompetÃªncias:**
${gapsText}

**Modelo 70-20-10:**
- 70% Aprendizado na PrÃ¡tica (projetos, desafios, rotacionaÃ§Ã£o de funÃ§Ãµes)
- 20% Aprendizado Social (mentoria, coaching, feedback de pares)
- 10% Aprendizado Formal (cursos, treinamentos, certificaÃ§Ãµes)

Gere 6-8 aÃ§Ãµes de desenvolvimento especÃ­ficas, prÃ¡ticas e mensurÃ¡veis, distribuÃ­das proporcionalmente no modelo 70-20-10. Para cada aÃ§Ã£o, inclua:
- TÃ­tulo claro e objetivo
- DescriÃ§Ã£o detalhada
- Tipo (pratica, social ou formal)
- CompetÃªncia que desenvolve
- Prazo estimado em meses`;

        const response = await invokeLLM({
          messages: [
            { role: "system", content: "VocÃª Ã© um especialista em RH e desenvolvimento de talentos. Sempre fornece recomendaÃ§Ãµes prÃ¡ticas, especÃ­ficas e mensurÃ¡veis." },
            { role: "user", content: prompt }
          ],
          response_format: {
            type: "json_schema",
            json_schema: {
              name: "pdi_recommendations",
              strict: true,
              schema: {
                type: "object",
                properties: {
                  actions: {
                    type: "array",
                    items: {
                      type: "object",
                      properties: {
                        title: { type: "string", description: "TÃ­tulo da aÃ§Ã£o" },
                        description: { type: "string", description: "DescriÃ§Ã£o detalhada" },
                        type: { type: "string", enum: ["pratica", "social", "formal"], description: "Tipo de aprendizado" },
                        competency: { type: "string", description: "CompetÃªncia que desenvolve" },
                        estimatedMonths: { type: "integer", description: "Prazo estimado em meses" }
                      },
                      required: ["title", "description", "type", "competency", "estimatedMonths"],
                      additionalProperties: false
                    }
                  }
                },
                required: ["actions"],
                additionalProperties: false
              }
            }
          }
        });

        const content = response.choices[0].message.content;
        const result = typeof content === "string" ? JSON.parse(content) : content;
        
        return result.actions;
      }),
  }),

  // ============================================================================
  // APROVAÃ‡ÃƒO DE PDI
  // ============================================================================
  pdiApproval: router({
    // Submeter PDI para aprovaÃ§Ã£o
    submit: protectedProcedure
      .input(z.object({ planId: z.number() }))
      .mutation(async ({ input, ctx }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        await db.update(pdiPlans)
          .set({ 
            status: "pendente_aprovacao",
            updatedAt: new Date()
          })
          .where(eq(pdiPlans.id, input.planId));

        // TODO: Enviar notificaÃ§Ã£o por e-mail ao gestor
        return { success: true };
      }),

    // Aprovar PDI (gestor)
    approve: protectedProcedure
      .input(z.object({ planId: z.number() }))
      .mutation(async ({ input, ctx }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const employee = await getUserByOpenId(ctx.user.openId);
        if (!employee) throw new Error("Employee not found");

        // Buscar PDI para pegar employeeId
        const pdi = await db.select().from(pdiPlans).where(eq(pdiPlans.id, input.planId)).limit(1);
        
        await db.update(pdiPlans)
          .set({ 
            status: "aprovado",
            approvedBy: employee.id,
            approvedAt: new Date(),
            updatedAt: new Date()
          })
          .where(eq(pdiPlans.id, input.planId));

        // Verificar badges de PDI ao aprovar
        if (pdi[0]?.employeeId) {
          const { checkPDIBadges } = await import("./services/badgeService");
          await checkPDIBadges(pdi[0].employeeId);
        }

        // TODO: Enviar notificaÃ§Ã£o por e-mail ao colaborador
        return { success: true };
      }),

    // Rejeitar PDI (gestor)
    reject: protectedProcedure
      .input(z.object({ planId: z.number(), reason: z.string() }))
      .mutation(async ({ input, ctx }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        await db.update(pdiPlans)
          .set({ 
            status: "rascunho",
            updatedAt: new Date()
          })
          .where(eq(pdiPlans.id, input.planId));

        // TODO: Enviar notificaÃ§Ã£o por e-mail ao colaborador com motivo da rejeiÃ§Ã£o
        return { success: true, reason: input.reason };
      }),

    // Listar PDIs pendentes de aprovaÃ§Ã£o (gestor)
    listPending: protectedProcedure
      .query(async ({ ctx }) => {
        const db = await getDb();
        if (!db) return [];

        const employee = await getUserByOpenId(ctx.user.openId);
        if (!employee) return [];

        // Buscar PDIs de subordinados pendentes de aprovaÃ§Ã£o
        const result = await db.select()
          .from(pdiPlans)
          .innerJoin(employees, eq(pdiPlans.employeeId, employees.id))
          .where(
            and(
              eq(employees.managerId, employee.id),
              eq(pdiPlans.status, "pendente_aprovacao")
            )
          );

        return result;
      }),
  }),

  // ============================================================================
  // CALIBRAÃ‡ÃƒO DA MATRIZ 9-BOX
  // ============================================================================
  nineBoxCalibration: router({
    // Listar colaboradores para calibraÃ§Ã£o
    list: protectedProcedure
      .input(z.object({ cycleId: z.number(), departmentId: z.number().optional() }))
      .query(async ({ input }) => {
        const db = await getDb();
        if (!db) return [];

        const conditions = [eq(nineBoxPositions.cycleId, input.cycleId)];
        if (input.departmentId) {
          conditions.push(eq(employees.departmentId, input.departmentId));
        }

        const result = await db.select()
          .from(nineBoxPositions)
          .innerJoin(employees, eq(nineBoxPositions.employeeId, employees.id))
          .where(and(...conditions));

        return result;
      }),

    // Ajustar posicionamento na Matriz 9-Box
    adjust: protectedProcedure
      .input(z.object({ 
        positionId: z.number(),
        performance: z.number().min(1).max(3),
        potential: z.number().min(1).max(3),
        justification: z.string()
      }))
      .mutation(async ({ input, ctx }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const employee = await getUserByOpenId(ctx.user.openId);
        if (!employee) throw new Error("Employee not found");

        await db.update(nineBoxPositions)
          .set({ 
            performance: input.performance,
            potential: input.potential,
            calibrated: true,
            calibratedBy: employee.id,
            calibratedAt: new Date(),
            notes: input.justification,
            updatedAt: new Date()
          })
          .where(eq(nineBoxPositions.id, input.positionId));

        return { success: true };
      }),

    // Finalizar calibraÃ§Ã£o
    finalize: protectedProcedure
      .input(z.object({ cycleId: z.number() }))
      .mutation(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        // Marcar todas as posiÃ§Ãµes do ciclo como calibradas
        await db.update(nineBoxPositions)
          .set({ 
            calibrated: true,
            updatedAt: new Date()
          })
          .where(eq(nineBoxPositions.cycleId, input.cycleId));

        return { success: true };
      }),
  }),

  // ============================================================================
  // EXPORTAÃ‡ÃƒO DE RELATÃ“RIOS PDF
  // ============================================================================
  reports: router({
    // Exportar relatÃ³rio de avaliaÃ§Ã£o 360Â°
    export360: protectedProcedure
      .input(z.object({ evaluationId: z.number() }))
      .query(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const evaluation = await db.select()
          .from(performanceEvaluations)
          .innerJoin(employees, eq(performanceEvaluations.employeeId, employees.id))
          .where(eq(performanceEvaluations.id, input.evaluationId))
          .limit(1);

        if (evaluation.length === 0) throw new Error("Evaluation not found");

        return evaluation[0];
      }),

    // Exportar relatÃ³rio de PDI
    exportPDI: protectedProcedure
      .input(z.object({ pdiId: z.number() }))
      .query(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const pdi = await db.select()
          .from(pdiPlans)
          .innerJoin(employees, eq(pdiPlans.employeeId, employees.id))
          .where(eq(pdiPlans.id, input.pdiId))
          .limit(1);

        if (pdi.length === 0) throw new Error("PDI not found");

        // Buscar itens do PDI
        const items = await db.select()
          .from(pdiItems)
          .where(eq(pdiItems.planId, input.pdiId));

        return { pdi: pdi[0], items };
      }),

    // Exportar relatÃ³rio de Matriz 9-Box
    export9Box: protectedProcedure
      .input(z.object({ cycleId: z.number() }))
      .query(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const positions = await db.select()
          .from(nineBoxPositions)
          .innerJoin(employees, eq(nineBoxPositions.employeeId, employees.id))
          .where(eq(nineBoxPositions.cycleId, input.cycleId));

        return positions;
      }),
  }),

  // ============================================================================
  // HISTÃ“RICO
  // ============================================================================
  history: router({
    // HistÃ³rico de avaliaÃ§Ãµes 360Â°
    evaluations: protectedProcedure
      .input(z.object({ employeeId: z.number() }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        const evaluations = await database
          .select()
          .from(performanceEvaluations)
          .where(eq(performanceEvaluations.employeeId, input.employeeId))
          .orderBy(desc(performanceEvaluations.createdAt));

        return evaluations;
      }),

    // HistÃ³rico de PDIs
    pdis: protectedProcedure
      .input(z.object({ employeeId: z.number() }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        const pdis = await database
          .select()
          .from(pdiPlans)
          .where(eq(pdiPlans.employeeId, input.employeeId))
          .orderBy(desc(pdiPlans.createdAt));

        return pdis;
      }),

    // HistÃ³rico de Matriz 9-Box
    nineBox: protectedProcedure
      .input(z.object({ employeeId: z.number() }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        const positions = await database
          .select()
          .from(nineBoxPositions)
          .where(eq(nineBoxPositions.employeeId, input.employeeId))
          .orderBy(desc(nineBoxPositions.createdAt));

        return positions;
      }),

    // EvoluÃ§Ã£o de competÃªncias ao longo do tempo
    competenciesEvolution: protectedProcedure
      .input(z.object({ employeeId: z.number() }))
      .query(async ({ input }) => {
        return await db.getEmployeeCompetencies(input.employeeId);
      }),
  }),

  // Router de Planos de SucessÃ£o
  successionPlans: router({
    list: protectedProcedure.query(async () => {
      const database = await getDb();
      if (!database) return [];

      // Buscar planos de sucessÃ£o com informaÃ§Ãµes relacionadas
      const plans = await database.select()
        .from(successionPlans)
        .orderBy(desc(successionPlans.createdAt));

      return plans;
    }),
  }),

  // Router de Testes PsicomÃ©tricos
  psychometric: router({
    // Buscar perguntas de um teste especÃ­fico (PÃšBLICO - sem necessidade de login)
    getQuestionsPublic: publicProcedure
      .input(z.object({ testType: z.enum(["disc", "bigfive", "mbti", "ie", "vark", "leadership", "careeranchors"]) }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        const questions = await database.select()
          .from(testQuestions)
          .where(eq(testQuestions.testType, input.testType))
          .orderBy(testQuestions.questionNumber);

        return questions;
      }),

    // Buscar perguntas de um teste especÃ­fico (PROTEGIDO - requer login)
    getQuestions: protectedProcedure
      .input(z.object({ testType: z.enum(["disc", "bigfive", "mbti", "ie", "vark", "leadership", "careeranchors"]) }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        const questions = await database.select()
          .from(testQuestions)
          .where(eq(testQuestions.testType, input.testType))
          .orderBy(testQuestions.questionNumber);

        return questions;
      }),

    // Submeter respostas de um teste (PÃšBLICO - sem necessidade de login)
    submitTestPublic: publicProcedure
      .input(z.object({
        testType: z.enum(["disc", "bigfive", "mbti", "ie", "vark", "leadership", "careeranchors"]),
        email: z.string().email(),
        responses: z.array(z.object({
          questionId: z.number(),
          score: z.number().min(1).max(5),
        })),
      }))
      .mutation(async ({ input }) => {
        const database = await getDb();
        if (!database) throw new Error("Database not available");

        // Buscar colaborador pelo email
        const employee = await database.select()
          .from(employees)
          .where(eq(employees.email, input.email))
          .limit(1);

        if (employee.length === 0) {
          throw new Error("Email nÃ£o encontrado. Por favor, verifique se o email estÃ¡ correto.");
        }

        // Calcular perfil baseado nas respostas
        const profile = await calculateProfile(input.testType, input.responses, database);

        // Preparar valores para inserÃ§Ã£o
        const testValues: any = {
          employeeId: employee[0].id,
          testType: input.testType,
          completedAt: new Date(),
          responses: JSON.stringify(input.responses),
        };

        // Adicionar scores especÃ­ficos baseado no tipo de teste
        if (input.testType === "disc") {
          testValues.discDominance = Math.round((profile.D || 0) * 20);
          testValues.discInfluence = Math.round((profile.I || 0) * 20);
          testValues.discSteadiness = Math.round((profile.S || 0) * 20);
          testValues.discCompliance = Math.round((profile.C || 0) * 20);
          const maxDimension = Object.entries(profile).reduce((a, b) => a[1] > b[1] ? a : b)[0];
          testValues.discProfile = maxDimension;
        } else if (input.testType === "bigfive") {
          testValues.bigFiveOpenness = Math.round((profile.O || 0) * 20);
          testValues.bigFiveConscientiousness = Math.round((profile.C || 0) * 20);
          testValues.bigFiveExtraversion = Math.round((profile.E || 0) * 20);
          testValues.bigFiveAgreeableness = Math.round((profile.A || 0) * 20);
          testValues.bigFiveNeuroticism = Math.round((profile.N || 0) * 20);
        }

        // Salvar teste no banco
        await database.insert(psychometricTests).values(testValues);

        return { success: true, profile, employeeName: employee[0].name };
      }),

    // Submeter respostas de um teste (PROTEGIDO - requer login)
    submitTest: protectedProcedure
      .input(z.object({
        testType: z.enum(["disc", "bigfive", "mbti", "ie", "vark", "leadership", "careeranchors"]),
        responses: z.array(z.object({
          questionId: z.number(),
          score: z.number().min(1).max(5),
        })),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) throw new Error("Database not available");

        // Buscar colaborador do usuÃ¡rio
        const employee = await database.select()
          .from(employees)
          .where(eq(employees.userId, ctx.user.id))
          .limit(1);

        if (employee.length === 0) {
          throw new Error("Colaborador nÃ£o encontrado");
        }

        // Calcular perfil baseado nas respostas
        const profile = await calculateProfile(input.testType, input.responses, database);

        // Preparar valores para inserÃ§Ã£o
        const testValues: any = {
          employeeId: employee[0].id,
          testType: input.testType,
          completedAt: new Date(),
          responses: JSON.stringify(input.responses),
        };

        // Adicionar scores especÃ­ficos baseado no tipo de teste
        if (input.testType === "disc") {
          testValues.discDominance = Math.round((profile.D || 0) * 20); // Converter 1-5 para 0-100
          testValues.discInfluence = Math.round((profile.I || 0) * 20);
          testValues.discSteadiness = Math.round((profile.S || 0) * 20);
          testValues.discCompliance = Math.round((profile.C || 0) * 20);
          // Determinar perfil dominante
          const maxDimension = Object.entries(profile).reduce((a, b) => a[1] > b[1] ? a : b)[0];
          testValues.discProfile = maxDimension;
        } else if (input.testType === "bigfive") {
          testValues.bigFiveOpenness = Math.round((profile.O || 0) * 20);
          testValues.bigFiveConscientiousness = Math.round((profile.C || 0) * 20);
          testValues.bigFiveExtraversion = Math.round((profile.E || 0) * 20);
          testValues.bigFiveAgreeableness = Math.round((profile.A || 0) * 20);
          testValues.bigFiveNeuroticism = Math.round((profile.N || 0) * 20);
        }

        // Salvar teste no banco
        await database.insert(psychometricTests).values(testValues);

        // Criar notificaÃ§Ã£o para gestores/RH
        try {
          // Buscar gestor do colaborador
          if (employee[0].managerId) {
            const manager = await database.select()
              .from(employees)
              .where(eq(employees.id, employee[0].managerId))
              .limit(1);

            if (manager.length > 0 && manager[0].userId) {
              await createNotification({
                userId: manager[0].userId,
                type: "test_completed",
                title: "Teste PsicomÃ©trico ConcluÃ­do",
                message: `${employee[0].name} completou o teste ${input.testType.toUpperCase()}`,
                link: `/testes/resultados-rh`,
              });
            }
          }
        } catch (error) {
          console.error("Erro ao criar notificaÃ§Ã£o:", error);
          // NÃ£o falhar a operaÃ§Ã£o principal se notificaÃ§Ã£o falhar
        }

        return { success: true, profile };
      }),

    // Buscar TODOS os testes (apenas RH/Admin)
    getAllTests: protectedProcedure.query(async ({ ctx }) => {
      const database = await getDb();
      if (!database) return [];

      // Verificar se Ã© RH/Admin
      const employee = await database.select()
        .from(employees)
        .where(eq(employees.userId, ctx.user.id))
        .limit(1);

      // TODO: Verificar role quando campo estiver disponÃ­vel no schema de employees
      // if (employee.length === 0 || (employee[0].role !== 'admin' && employee[0].role !== 'rh')) {
      //   throw new TRPCError({
      //     code: "FORBIDDEN",
      //     message: "Apenas RH e Administradores podem visualizar todos os testes",
      //   });
      // }

      // Buscar todos os testes com informaÃ§Ãµes do colaborador
      const tests = await database.select({
        id: psychometricTests.id,
        employeeId: psychometricTests.employeeId,
        employeeName: employees.name,
        employeeDepartmentId: employees.departmentId,
        employeeDepartmentName: departments.name,
        testType: psychometricTests.testType,
        discProfile: psychometricTests.discProfile,
        discDominance: psychometricTests.discDominance,
        discInfluence: psychometricTests.discInfluence,
        discSteadiness: psychometricTests.discSteadiness,
        discCompliance: psychometricTests.discCompliance,
        bigFiveOpenness: psychometricTests.bigFiveOpenness,
        bigFiveConscientiousness: psychometricTests.bigFiveConscientiousness,
        bigFiveExtraversion: psychometricTests.bigFiveExtraversion,
        bigFiveAgreeableness: psychometricTests.bigFiveAgreeableness,
        bigFiveNeuroticism: psychometricTests.bigFiveNeuroticism,
        completedAt: psychometricTests.completedAt,
        createdAt: psychometricTests.createdAt,
      })
        .from(psychometricTests)
        .leftJoin(employees, eq(psychometricTests.employeeId, employees.id))
        .leftJoin(departments, eq(employees.departmentId, departments.id))
        .where(sql`${psychometricTests.completedAt} IS NOT NULL`)
        .orderBy(desc(psychometricTests.completedAt));

      return tests;
    }),

    // Buscar testes de um colaborador
    getTests: protectedProcedure.query(async ({ ctx }) => {
      const database = await getDb();
      if (!database) return [];

      // Buscar colaborador do usuÃ¡rio
      const employee = await database.select()
        .from(employees)
        .where(eq(employees.userId, ctx.user.id))
        .limit(1);

      if (employee.length === 0) return [];

      const tests = await database.select()
        .from(psychometricTests)
        .where(eq(psychometricTests.employeeId, employee[0].id))
        .orderBy(desc(psychometricTests.completedAt));

      return tests.map(test => {
        // Reconstruir perfil a partir dos campos individuais
        let profile: any = null;
        if (test.testType === "disc") {
          profile = {
            D: test.discDominance ? test.discDominance / 20 : 0,
            I: test.discInfluence ? test.discInfluence / 20 : 0,
            S: test.discSteadiness ? test.discSteadiness / 20 : 0,
            C: test.discCompliance ? test.discCompliance / 20 : 0,
            dominantProfile: test.discProfile,
          };
        } else if (test.testType === "bigfive") {
          profile = {
            O: test.bigFiveOpenness ? test.bigFiveOpenness / 20 : 0,
            C: test.bigFiveConscientiousness ? test.bigFiveConscientiousness / 20 : 0,
            E: test.bigFiveExtraversion ? test.bigFiveExtraversion / 20 : 0,
            A: test.bigFiveAgreeableness ? test.bigFiveAgreeableness / 20 : 0,
            N: test.bigFiveNeuroticism ? test.bigFiveNeuroticism / 20 : 0,
          };
        } else if (test.testType === "mbti" || test.testType === "ie" || test.testType === "vark") {
          // Para novos testes, retornar profile vazio por enquanto
          // TODO: Implementar cÃ¡lculo de perfil para MBTI, IE e VARK
          profile = {};
        }
        return { ...test, profile };
      });
    }),

    // Enviar convite para teste psicomÃ©trico por email
    sendTestInvite: protectedProcedure
      .input(z.object({
        emails: z.array(z.string().email()),
        testType: z.enum(["disc", "bigfive", "mbti", "ie", "vark", "leadership", "careeranchors"]),
      }))
      .mutation(async ({ input, ctx }) => {
        // Verificar se Ã© admin
        if (ctx.user.role !== "admin") {
          throw new Error("Acesso negado: apenas administradores");
        }

        const { createTestInviteEmail, testInfo } = await import("./utils/testInviteTemplate");
        const { emailService } = await import("./utils/emailService");
        const database = await getDb();
        if (!database) throw new Error("Database not available");

        const results = [];
        const testData = testInfo[input.testType];

        for (const email of input.emails) {
          // Buscar colaborador pelo email
          const employee = await database.select()
            .from(employees)
            .where(eq(employees.email, email))
            .limit(1);

          if (employee.length === 0) {
            results.push({ email, success: false, message: "Colaborador nÃ£o encontrado" });
            continue;
          }

          // Usar URL base do ambiente (funciona tanto em dev quanto em produÃ§Ã£o)
          const baseUrl = process.env.VITE_APP_URL || ctx.req.headers.origin || `${ctx.req.protocol}://${ctx.req.get('host')}`;
          const testUrl = `${baseUrl}/teste-${input.testType}`;
          
          const emailTemplate = createTestInviteEmail({
            employeeName: employee[0].name,
            testType: testData.type,
            testName: testData.name,
            testDescription: testData.description,
            estimatedTime: testData.estimatedTime,
            testUrl,
          });

          // Enviar email usando o emailService
          const sent = await emailService.sendCustomEmail(
            email,
            emailTemplate.subject,
            emailTemplate.html
          );

          results.push({
            email,
            success: sent,
            message: sent ? "Convite enviado com sucesso" : "Erro ao enviar email",
          });
        }

        return { results };
      }),

    // Buscar resultados agregados por equipe/departamento/cargo
    getAggregatedResults: protectedProcedure
      .input(z.object({
        groupBy: z.enum(["department", "position", "team"]),
        testType: z.enum(["disc", "bigfive", "mbti", "ie", "vark", "leadership", "careeranchors"]).optional(),
      }))
      .query(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) return [];

        // Buscar todos os testes
        const testsQuery = database.select({
          test: psychometricTests,
          employee: employees,
          department: departments,
          position: positions,
        })
          .from(psychometricTests)
          .leftJoin(employees, eq(psychometricTests.employeeId, employees.id))
          .leftJoin(departments, eq(employees.departmentId, departments.id))
          .leftJoin(positions, eq(employees.positionId, positions.id));

        const tests = input.testType 
          ? await testsQuery.where(eq(psychometricTests.testType, input.testType))
          : await testsQuery;

        // Agrupar por critÃ©rio
        const grouped: Record<string, any[]> = {};
        for (const item of tests) {
          let groupKey = "";
          let groupName = "";

          if (input.groupBy === "department" && item.department) {
            groupKey = item.department.id.toString();
            groupName = item.department.name;
          } else if (input.groupBy === "position" && item.position) {
            groupKey = item.position.id.toString();
            groupName = item.position.title;
          } else if (input.groupBy === "team" && item.employee?.managerId) {
            groupKey = item.employee.managerId.toString();
            groupName = `Equipe ${item.employee.managerId}`;
          } else {
            continue;
          }

          if (!grouped[groupKey]) {
            grouped[groupKey] = [];
          }
          grouped[groupKey].push({ ...item.test, groupName });
        }

        // Calcular mÃ©dias por grupo
        const results = [];
        for (const [groupKey, groupTests] of Object.entries(grouped)) {
          const groupName = groupTests[0]?.groupName || "Sem nome";
          const testsByType: Record<string, any[]> = {};

          // Agrupar por tipo de teste
          for (const test of groupTests) {
            if (!testsByType[test.testType]) {
              testsByType[test.testType] = [];
            }
            testsByType[test.testType].push(test);
          }

          // Calcular mÃ©dias por tipo
          const averages: Record<string, any> = {};
          for (const [testType, testList] of Object.entries(testsByType)) {
            if (testType === "disc") {
              averages.disc = {
                D: testList.reduce((sum, t) => sum + (t.discD || 0), 0) / testList.length,
                I: testList.reduce((sum, t) => sum + (t.discI || 0), 0) / testList.length,
                S: testList.reduce((sum, t) => sum + (t.discS || 0), 0) / testList.length,
                C: testList.reduce((sum, t) => sum + (t.discC || 0), 0) / testList.length,
              };
            } else if (testType === "bigfive") {
              averages.bigfive = {
                O: testList.reduce((sum, t) => sum + (t.bigFiveOpenness || 0), 0) / testList.length / 20,
                C: testList.reduce((sum, t) => sum + (t.bigFiveConscientiousness || 0), 0) / testList.length / 20,
                E: testList.reduce((sum, t) => sum + (t.bigFiveExtraversion || 0), 0) / testList.length / 20,
                A: testList.reduce((sum, t) => sum + (t.bigFiveAgreeableness || 0), 0) / testList.length / 20,
                N: testList.reduce((sum, t) => sum + (t.bigFiveNeuroticism || 0), 0) / testList.length / 20,
              };
            }
            // TODO: Adicionar cÃ¡lculos para outros tipos de teste
          }

          results.push({
            groupKey,
            groupName,
            count: groupTests.length,
            averages,
          });
        }

        return results;
      }),

    // Gerar recomendaÃ§Ãµes de PDI baseadas em testes psicomÃ©tricos
    getPDIRecommendations: protectedProcedure
      .input(z.object({
        employeeId: z.number(),
      }))
      .query(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) return [];

        // Buscar todos os testes do funcionÃ¡rio
        const tests = await database.select()
          .from(psychometricTests)
          .where(eq(psychometricTests.employeeId, input.employeeId))
          .orderBy(desc(psychometricTests.completedAt));

        if (tests.length === 0) {
          return [];
        }

        // Importar funÃ§Ãµes de recomendaÃ§Ã£o
        const { generateConsolidatedRecommendations } = await import("./utils/pdiRecommendations");

        // Preparar perfis dos testes mais recentes
        const latestTests: any = {};
        
        for (const test of tests) {
          if (!latestTests[test.testType]) {
            if (test.testType === "disc") {
              latestTests.disc = {
                D: test.discDominance || 0,
                I: test.discInfluence || 0,
                S: test.discSteadiness || 0,
                C: test.discCompliance || 0,
              };
            } else if (test.testType === "bigfive") {
              latestTests.bigfive = {
                O: (test.bigFiveOpenness || 0) / 20,
                C: (test.bigFiveConscientiousness || 0) / 20,
                E: (test.bigFiveExtraversion || 0) / 20,
                A: (test.bigFiveAgreeableness || 0) / 20,
                N: (test.bigFiveNeuroticism || 0) / 20,
              };
            }
            // TODO: Adicionar outros tipos de teste
          }
        }

        // Gerar recomendaÃ§Ãµes consolidadas
        const recommendations = generateConsolidatedRecommendations(latestTests);

        return recommendations;
      }),
  }),

  // Router de AdministraÃ§Ã£o (apenas admin)
  admin: router({
    // Buscar configuraÃ§Ãµes SMTP
    getSmtpConfig: protectedProcedure.query(async ({ ctx }) => {
      // Verificar se Ã© admin
      if (ctx.user.role !== "admin") {
        throw new Error("Acesso negado: apenas administradores");
      }

      const database = await getDb();
      if (!database) return null;

      const settings = await database.select()
        .from(systemSettings)
        .where(eq(systemSettings.settingKey, "smtp_config"))
        .limit(1);

      if (settings.length === 0) return null;

      // Parse do JSON armazenado
      const config = settings[0].settingValue ? JSON.parse(settings[0].settingValue) : null;
      return config;
    }),

    // Atualizar configuraÃ§Ãµes SMTP
    updateSmtpConfig: protectedProcedure
      .input(z.object({
        host: z.string().min(1),
        port: z.number().min(1).max(65535),
        secure: z.boolean(),
        user: z.string().min(1),
        pass: z.string().min(1),
        fromName: z.string().min(1),
        fromEmail: z.string().email(),
      }))
      .mutation(async ({ input, ctx }) => {
        // Verificar se Ã© admin
        if (ctx.user.role !== "admin") {
          throw new Error("Acesso negado: apenas administradores");
        }

        const database = await getDb();
        if (!database) throw new Error("Database not available");

        // Verificar se jÃ¡ existe configuraÃ§Ã£o
        const existing = await database.select()
          .from(systemSettings)
          .where(eq(systemSettings.settingKey, "smtp_config"))
          .limit(1);

        const configJson = JSON.stringify(input);

        if (existing.length > 0) {
          // Atualizar
          await database.update(systemSettings)
            .set({
              settingValue: configJson,
              updatedBy: ctx.user.id,
              updatedAt: new Date(),
            })
            .where(eq(systemSettings.settingKey, "smtp_config"));
        } else {
          // Inserir
          await database.insert(systemSettings).values({
            settingKey: "smtp_config",
            settingValue: configJson,
            description: "ConfiguraÃ§Ãµes do servidor SMTP para envio de e-mails",
            isEncrypted: false,
            updatedBy: ctx.user.id,
          });
        }

        return { success: true };
      }),

    // Testar conexÃ£o SMTP
    testSmtpConnection: protectedProcedure
      .input(z.object({
        host: z.string().min(1),
        port: z.number().min(1).max(65535),
        secure: z.boolean(),
        user: z.string().min(1),
        pass: z.string().min(1),
        fromName: z.string().min(1),
        fromEmail: z.string().email(),
        testEmail: z.string().email(),
      }))
      .mutation(async ({ input, ctx }) => {
        // Verificar se Ã© admin
        if (ctx.user.role !== "admin") {
          throw new Error("Acesso negado: apenas administradores");
        }

        const nodemailer = require("nodemailer");

        try {
          // Criar transporter com as configuraÃ§Ãµes fornecidas
          const transporter = nodemailer.createTransport({
            host: input.host,
            port: input.port,
            secure: input.secure,
            auth: {
              user: input.user,
              pass: input.pass,
            },
          });

          // Verificar conexÃ£o
          await transporter.verify();

          // Enviar e-mail de teste
          await transporter.sendMail({
            from: `"${input.fromName}" <${input.fromEmail}>`,
            to: input.testEmail,
            subject: "Teste de ConfiguraÃ§Ã£o SMTP - Sistema AVD UISA",
            html: `
              <h2>Teste de ConfiguraÃ§Ã£o SMTP</h2>
              <p>Este Ã© um e-mail de teste enviado pelo Sistema AVD UISA.</p>
              <p>Se vocÃª recebeu esta mensagem, significa que as configuraÃ§Ãµes SMTP estÃ£o corretas!</p>
              <hr>
              <p><small>Servidor: ${input.host}:${input.port}</small></p>
              <p><small>Data/Hora: ${new Date().toLocaleString("pt-BR")}</small></p>
            `,
          });

          return { success: true, message: "E-mail de teste enviado com sucesso!" };
        } catch (error: any) {
          console.error("[SMTP Test] Erro:", error);
          return { success: false, message: error.message || "Erro ao testar conexÃ£o SMTP" };
        }
      }),

    // Buscar mÃ©tricas de e-mail
    getEmailMetrics: protectedProcedure
      .input(z.object({
        startDate: z.string().optional(),
        endDate: z.string().optional(),
        limit: z.number().optional(),
      }))
      .query(async ({ ctx, input }) => {
        // Verificar se Ã© admin
        if (ctx.user.role !== "admin") {
          throw new Error("Acesso negado: apenas administradores");
        }

        const database = await getDb();
        if (!database) return [];

        // Buscar mÃ©tricas com filtros opcionais
        const metrics = await database.select()
          .from(emailMetrics)
          .orderBy(desc(emailMetrics.sentAt))
          .limit(input.limit || 1000);

        return metrics;
      }),

    // Buscar estatÃ­sticas agregadas de e-mail
    getEmailStats: protectedProcedure.query(async ({ ctx }) => {
      // Verificar se Ã© admin
      if (ctx.user.role !== "admin") {
        throw new Error("Acesso negado: apenas administradores");
      }

      const database = await getDb();
      if (!database) return null;

      // Buscar todas as mÃ©tricas
      const allMetrics = await database.select().from(emailMetrics);

      // Calcular estatÃ­sticas
      const total = allMetrics.length;
      const successful = allMetrics.filter(m => m.success).length;
      const failed = total - successful;
      const successRate = total > 0 ? (successful / total) * 100 : 0;

      // Agrupar por tipo
      const byType: Record<string, number> = {};
      allMetrics.forEach(m => {
        byType[m.type] = (byType[m.type] || 0) + 1;
      });

      // Agrupar por mÃªs (Ãºltimos 12 meses)
      const monthlyData: Record<string, { sent: number; success: number; failed: number }> = {};
      const now = new Date();
      const twelveMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 11, 1);

      allMetrics.forEach(m => {
        const sentDate = new Date(m.sentAt);
        if (sentDate >= twelveMonthsAgo) {
          const monthKey = `${sentDate.getFullYear()}-${String(sentDate.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { sent: 0, success: 0, failed: 0 };
          }
          monthlyData[monthKey].sent++;
          if (m.success) {
            monthlyData[monthKey].success++;
          } else {
            monthlyData[monthKey].failed++;
          }
        }
      });

      // Converter para array ordenado
      const monthlyArray = Object.entries(monthlyData)
        .map(([month, data]) => ({ month, ...data }))
        .sort((a, b) => a.month.localeCompare(b.month));

      return {
        total,
        successful,
        failed,
        successRate: Math.round(successRate * 10) / 10,
        byType,
        monthlyData: monthlyArray,
      };
    }),
  }),

  // Router de CalibraÃ§Ã£o
  calibration: router({
    // Listar avaliaÃ§Ãµes para calibraÃ§Ã£o
    getEvaluations: protectedProcedure
      .input(z.object({
        cycleId: z.number().optional(),
        departmentId: z.number().optional(),
      }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        const evals = await database.select()
          .from(performanceEvaluations)
          .orderBy(desc(performanceEvaluations.createdAt))
          .limit(100);

        return evals;
      }),

    // Criar sessÃ£o de calibraÃ§Ã£o
    createSession: protectedProcedure
      .input(z.object({
        cycleId: z.number(),
        departmentId: z.number().optional(),
        scheduledDate: z.string().optional(),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) throw new Error("Database not available");

        const [session] = await database.insert(calibrationSessions).values({
          cycleId: input.cycleId,
          departmentId: input.departmentId,
          facilitatorId: ctx.user.id,
          scheduledDate: input.scheduledDate ? new Date(input.scheduledDate) : undefined,
        });

        return { success: true, sessionId: session.insertId };
      }),

    // Salvar calibraÃ§Ã£o
    saveCalibration: protectedProcedure
      .input(z.object({
        sessionId: z.number(),
        evaluationId: z.number(),
        originalScore: z.number(),
        calibratedScore: z.number(),
        reason: z.string(),
      }))
      .mutation(async ({ input, ctx }) => {
        const database = await getDb();
        if (!database) throw new Error("Database not available");

        // Salvar review de calibraÃ§Ã£o
        await database.insert(calibrationReviews).values({
          sessionId: input.sessionId,
          evaluationId: input.evaluationId,
          originalScore: input.originalScore,
          calibratedScore: input.calibratedScore,
          reason: input.reason,
          reviewedBy: ctx.user.id,
        });

        // Atualizar nota final da avaliaÃ§Ã£o
        await database.update(performanceEvaluations)
          .set({ finalScore: input.calibratedScore })
          .where(eq(performanceEvaluations.id, input.evaluationId));

        return { success: true };
      }),

    // Buscar histÃ³rico de calibraÃ§Ãµes
    getHistory: protectedProcedure
      .input(z.object({ evaluationId: z.number() }))
      .query(async ({ input }) => {
        const database = await getDb();
        if (!database) return [];

        const history = await database.select()
          .from(calibrationReviews)
          .where(eq(calibrationReviews.evaluationId, input.evaluationId))
          .orderBy(desc(calibrationReviews.createdAt));

        return history;
      }),
  }),

  // Router de Audit Trail (apenas admin)
  auditTrail: router({
    // Buscar logs de auditoria com filtros
    getLogs: protectedProcedure
      .input(z.object({
        userId: z.number().optional(),
        action: z.string().optional(),
        entity: z.string().optional(),
        startDate: z.string().optional(),
        endDate: z.string().optional(),
        limit: z.number().default(100),
        offset: z.number().default(0),
      }))
      .query(async ({ input, ctx }) => {
        // Apenas admin pode acessar
        if (ctx.user.role !== "admin") {
          throw new Error("Acesso negado");
        }

        const database = await getDb();
        if (!database) return { logs: [], total: 0 };

        // Construir condiÃ§Ãµes de filtro
        const conditions: any[] = [];
        if (input.userId) conditions.push(eq(auditLogs.userId, input.userId));
        if (input.action) conditions.push(eq(auditLogs.action, input.action));
        if (input.entity) conditions.push(eq(auditLogs.entity, input.entity));
        
        // Buscar logs
        const logs = await database.select()
          .from(auditLogs)
          .where(conditions.length > 0 ? and(...conditions) : undefined)
          .orderBy(desc(auditLogs.createdAt))
          .limit(input.limit)
          .offset(input.offset);

        // Contar total
        const totalResult = await database.select()
          .from(auditLogs)
          .where(conditions.length > 0 ? and(...conditions) : undefined);

        return { logs, total: totalResult.length };
      }),

    // Buscar detalhes de um log especÃ­fico
    getLogDetails: protectedProcedure
      .input(z.object({ id: z.number() }))
      .query(async ({ input, ctx }) => {
        if (ctx.user.role !== "admin") {
          throw new Error("Acesso negado");
        }

        const database = await getDb();
        if (!database) return null;

        const log = await database.select()
          .from(auditLogs)
          .where(eq(auditLogs.id, input.id))
          .limit(1);

        return log.length > 0 ? log[0] : null;
      }),
  }),

  // Router de Analytics (apenas admin)
  analytics: analyticsRouter,

  // Router de Feedback ContÃ­nuo
  feedback: feedbackRouter,

  // Router de Badges Gamificado
  badges: badgesRouter,

  // Router de RelatÃ³rios Agendados (apenas admin)
  scheduledReports: scheduledReportsRouter,

  // Router de Dashboard Executivo (apenas admin)
  executive: executiveRouter,

  // Router de Mapa de SucessÃ£o
  succession: successionRouter,

  // Router de Metas em Cascata HierÃ¡rquico
  goalsCascade: goalsCascadeRouter,

  // Router de PDI Inteligente
  pdiIntelligent: pdiIntelligentRouter,

  // Router de Nine Box Comparativo
  nineBoxComparative: nineBoxRouter,
  
  // Router de AvaliaÃ§Ã£o 360Â° com Fluxo Sequencial
  evaluation360: evaluation360Router,
  
  // Router de GestÃ£o de Ciclos de AvaliaÃ§Ã£o (360Â°)
  evaluationCycles: cyclesRouter,
  
  reportBuilder: reportBuilderRouter,
  reportAnalytics: reportAnalyticsRouter,
  
  // Router de Metas SMART
  smartGoals: goalsRouter,
  goalApprovals: goalApprovalsRouter,
  bonus: bonusRouter,
  calibrationDiretoria: calibrationRouter,
  gamification: gamificationRouter,
  integrations: integrationsRouter,

  // Router de NotificaÃ§Ãµes
  notifications: notificationsRouter,

  // Router de Pesquisas de Pulse
  pulse: pulseRouter,

  // Router de DescriÃ§Ã£o de Cargos
  positionsManagement: positionsRouter,
  
  // Router de DescriÃ§Ã£o de Cargos - Template UISA
  jobDescriptions: jobDescriptionsRouter,
  jobDescriptionsPDF: jobDescriptionsPDFRouter,
  productivity: productivityRouter,
  import: importRouter,
  alerts: alertsRouter,
  timeClock: timeClockRouter,
  organization: organizationRouter,

  // Router de Emails
  emails: router({
    // Buscar mÃ©tricas de emails
    getMetrics: protectedProcedure.query(async ({ ctx }) => {
      if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "Acesso negado",
        });
      }

      const database = await getDb();
      if (!database) return { total: 0, sent: 0, failed: 0, pending: 0 };

      const allMetrics = await database.select().from(emailMetrics);

      const total = allMetrics.length;
      const sent = allMetrics.filter(m => m.success).length;
      const failed = allMetrics.filter(m => !m.success).length;
      const pending = 0; // TODO: implementar fila de emails pendentes

      return { total, sent, failed, pending };
    }),

    // Buscar histÃ³rico de emails
    getHistory: protectedProcedure.query(async ({ ctx }) => {
      if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "Acesso negado",
        });
      }

      const database = await getDb();
      if (!database) return [];

      const history = await database.select()
        .from(emailMetrics)
        .orderBy(desc(emailMetrics.sentAt))
        .limit(500);

      return history.map(email => ({
        id: email.id,
        recipient: email.toEmail,
        subject: email.subject,
        emailType: email.type,
        status: email.success ? "sent" : "failed",
        sentAt: email.sentAt,
        createdAt: email.sentAt,
        errorMessage: email.error,
      }));
    }),

    // Reenviar email falhado
    resend: protectedProcedure
      .input(z.object({ emailId: z.number() }))
      .mutation(async ({ input, ctx }) => {
        if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
          throw new TRPCError({
            code: "FORBIDDEN",
            message: "Acesso negado",
          });
        }

        const database = await getDb();
        if (!database) {
          throw new TRPCError({
            code: "INTERNAL_SERVER_ERROR",
            message: "Banco de dados indisponÃ­vel",
          });
        }

        // Buscar email original
        const originalEmail = await database.select()
          .from(emailMetrics)
          .where(eq(emailMetrics.id, input.emailId))
          .limit(1);

        if (originalEmail.length === 0) {
          throw new TRPCError({
            code: "NOT_FOUND",
            message: "Email nÃ£o encontrado",
          });
        }

        // TODO: Implementar lÃ³gica de reenvio usando emailService
        // Por enquanto, apenas retornar sucesso
        return { success: true, message: "Email reenviado com sucesso" };
      }),
  }),

  // Router de Centros de Custos
  costCenters: router({
    // Listar todos os centros de custos Ãºnicos
    list: publicProcedure.query(async () => {
      const database = await getDb();
      if (!database) return [];

      // Buscar valores Ãºnicos de costCenter da tabela employees
      const result = await database.selectDistinct({ costCenter: employees.costCenter })
        .from(employees)
        .where(sql`${employees.costCenter} IS NOT NULL AND ${employees.costCenter} != ''`)
        .orderBy(employees.costCenter);

      // Transformar em formato {id, code, name}
      return result.map((r, index) => ({
        id: index + 1,
        code: r.costCenter || '',
        name: r.costCenter || '',
      }));
    }),
  }),

  // ============================================================================
  // E-MAIL
  // ============================================================================
  smtpConfig: router({
    get: protectedProcedure.query(async ({ ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar configuraÃ§Ã£o mais recente
      const configs = await db.select().from(smtpConfig).where(eq(smtpConfig.isActive, true)).orderBy(desc(smtpConfig.createdAt)).limit(1);
      
      return configs.length > 0 ? configs[0] : null;
    }),

    save: protectedProcedure
      .input(z.object({
        host: z.string(),
        port: z.number(),
        secure: z.boolean(),
        user: z.string(),
        password: z.string().optional(),
        fromEmail: z.string().email(),
        fromName: z.string(),
      }))
      .mutation(async ({ input, ctx }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        // Desativar configuraÃ§Ãµes antigas
        await db.update(smtpConfig).set({ isActive: false }).where(eq(smtpConfig.isActive, true));

        // Criar nova configuraÃ§Ã£o
        const result = await db.insert(smtpConfig).values({
          host: input.host,
          port: input.port,
          secure: input.secure,
          user: input.user,
          password: input.password || "***", // TODO: Encrypt password
          fromEmail: input.fromEmail,
          fromName: input.fromName,
          isActive: true,
        });

        return { success: true, configId: result[0].insertId };
      }),
  }),

  email: router({
    // Enviar e-mail de teste
    sendTest: protectedProcedure
      .input(z.object({ recipientEmail: z.string().email() }))
      .mutation(async ({ input }) => {
        const { sendTestEmail } = await import('./emailService');
        return await sendTestEmail(input.recipientEmail);
      }),

    // Enviar e-mail de meta
    sendGoalEmail: protectedProcedure
      .input(z.object({
        recipientEmail: z.string().email(),
        recipientName: z.string(),
        goalTitle: z.string(),
        goalDescription: z.string(),
        deadline: z.string(),
        assignedBy: z.string(),
        dashboardUrl: z.string(),
      }))
      .mutation(async ({ input }) => {
        const { sendTemplateEmail } = await import('./emailService');
        const { newGoalTemplate } = await import('./emailTemplates');
        
        const template = newGoalTemplate(input);
        const success = await sendTemplateEmail(input.recipientEmail, template);
        
        return { success, message: success ? 'E-mail enviado com sucesso' : 'Falha ao enviar e-mail' };
      }),

    // Enviar e-mail de resultado de performance
    sendPerformanceEmail: protectedProcedure
      .input(z.object({
        recipientEmail: z.string().email(),
        recipientName: z.string(),
        evaluationPeriod: z.string(),
        overallScore: z.number(),
        performanceLevel: z.string(),
        strengths: z.array(z.string()),
        improvements: z.array(z.string()),
        evaluatorName: z.string(),
        dashboardUrl: z.string(),
      }))
      .mutation(async ({ input }) => {
        const { sendTemplateEmail } = await import('./emailService');
        const { performanceResultTemplate } = await import('./emailTemplates');
        
        const template = performanceResultTemplate(input);
        const success = await sendTemplateEmail(input.recipientEmail, template);
        
        return { success, message: success ? 'E-mail enviado com sucesso' : 'Falha ao enviar e-mail' };
      }),
  }),

  // ============================================================================
  // WORKFLOWS
  // ============================================================================
  workflows: router({
    // Listar todos os workflows
    list: protectedProcedure.query(async () => {
      const database = await getDb();
      if (!database) return [];

      const allWorkflows = await database
        .select()
        .from(workflows)
        .orderBy(desc(workflows.createdAt));

      return allWorkflows;
    }),

    // Criar novo workflow
    create: protectedProcedure
      .input(z.object({
        name: z.string().min(1),
        description: z.string().optional(),
        type: z.enum([
          "aprovacao_metas",
          "aprovacao_pdi",
          "aprovacao_avaliacao",
          "aprovacao_bonus",
          "aprovacao_ferias",
          "aprovacao_promocao",
          "aprovacao_horas_extras",
          "aprovacao_despesas",
          "outro"
        ]),
        steps: z.string(), // JSON stringified
        isActive: z.boolean().optional(),
        isDefault: z.boolean().optional(),
      }))
      .mutation(async ({ input, ctx }) => {
        if (!ctx.user) {
          throw new TRPCError({
            code: "UNAUTHORIZED",
            message: "UsuÃ¡rio nÃ£o autenticado",
          });
        }

        const database = await getDb();
        if (!database) throw new Error("Database not available");

        const employee = await db.getEmployeeByUserId(ctx.user.id);
        if (!employee) {
          throw new TRPCError({
            code: "NOT_FOUND",
            message: "Colaborador nÃ£o encontrado",
          });
        }

        const [workflow] = await database.insert(workflows).values({
          name: input.name,
          description: input.description || null,
          type: input.type,
          steps: input.steps,
          isActive: input.isActive ?? true,
          isDefault: input.isDefault ?? false,
          createdBy: employee.id,
        });

        return { success: true, workflowId: workflow.insertId };
      }),

    // Atualizar workflow
    update: protectedProcedure
      .input(z.object({
        id: z.number(),
        name: z.string().min(1).optional(),
        description: z.string().optional(),
        steps: z.string().optional(),
        isActive: z.boolean().optional(),
        isDefault: z.boolean().optional(),
      }))
      .mutation(async ({ input }) => {
        const database = await getDb();
        if (!database) throw new Error("Database not available");

        const updateData: any = {};
        if (input.name !== undefined) updateData.name = input.name;
        if (input.description !== undefined) updateData.description = input.description;
        if (input.steps !== undefined) updateData.steps = input.steps;
        if (input.isActive !== undefined) updateData.isActive = input.isActive;
        if (input.isDefault !== undefined) updateData.isDefault = input.isDefault;

        await database.update(workflows)
          .set(updateData)
          .where(eq(workflows.id, input.id));

        return { success: true };
      }),

    // Deletar workflow
    delete: protectedProcedure
      .input(z.object({ id: z.number() }))
      .mutation(async ({ input }) => {
        const database = await getDb();
        if (!database) throw new Error("Database not available");

        await database.delete(workflows)
          .where(eq(workflows.id, input.id));

        return { success: true };
      }),
  }),
});

// FunÃ§Ã£o auxiliar para calcular perfil psicomÃ©trico
async function calculateProfile(
  testType: "disc" | "bigfive" | "mbti" | "ie" | "vark" | "leadership" | "careeranchors",
  responses: Array<{ questionId: number; score: number }>,
  database: any
) {
  // Buscar perguntas com dimensÃµes
  const questions = await database.select()
    .from(testQuestions)
    .where(eq(testQuestions.testType, testType));

  const dimensionScores: Record<string, number[]> = {};

  // Agrupar scores por dimensÃ£o
  for (const response of responses) {
    const question = questions.find((q: any) => q.id === response.questionId);
    if (!question) continue;

    const dimension = question.dimension;
    if (!dimensionScores[dimension]) dimensionScores[dimension] = [];

    // Inverter score se a pergunta for reversa
    const score = question.reverse ? (6 - response.score) : response.score;
    dimensionScores[dimension].push(score);
  }

  // Calcular mÃ©dias por dimensÃ£o
  const profile: Record<string, number> = {};
  for (const [dimension, scores] of Object.entries(dimensionScores)) {
    const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
    profile[dimension] = Math.round(avg * 10) / 10; // Arredondar para 1 casa decimal
  }

  return profile;
}

// ============================================================================
// ROUTER DE NOTIFICAÃ‡Ã•ES
// ============================================================================

async function createNotification(data: {
  userId: number;
  type: string;
  title: string;
  message: string;
  link?: string;
}) {
  const database = await getDb();
  if (!database) return null;

  const [notification] = await database.insert(notifications).values({
    userId: data.userId,
    type: data.type,
    title: data.title,
    message: data.message,
    link: data.link,
    read: false,
  }).$returningId();

  return notification;
}

export type AppRouter = typeof appRouter;


========================================
ARQUIVO: ./server/routers/jobDescriptionsPDF.ts
========================================
import { z } from "zod";
import { protectedProcedure, router } from "../_core/trpc";
import { getDb } from "../db";
import { jobDescriptions, jobResponsibilities, jobKnowledge, jobCompetencies, jobDescriptionApprovals } from "../../drizzle/schema";
import { eq } from "drizzle-orm";
import { TRPCError } from "@trpc/server";
// @ts-expect-error - no types available for html-pdf-node
import htmlPdf from "html-pdf-node";

export const jobDescriptionsPDFRouter = router({
  exportPDF: protectedProcedure
    .input(z.object({ jobDescriptionId: z.number() }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Buscar descriÃ§Ã£o completa
      const [jobDesc] = await db.select().from(jobDescriptions).where(eq(jobDescriptions.id, input.jobDescriptionId));
      if (!jobDesc) throw new TRPCError({ code: "NOT_FOUND", message: "Job description not found" });

      // Buscar todas as relaÃ§Ãµes
      const responsibilities = await db.select().from(jobResponsibilities).where(eq(jobResponsibilities.jobDescriptionId, input.jobDescriptionId));
      const knowledge = await db.select().from(jobKnowledge).where(eq(jobKnowledge.jobDescriptionId, input.jobDescriptionId));
      const competencies = await db.select().from(jobCompetencies).where(eq(jobCompetencies.jobDescriptionId, input.jobDescriptionId));
      const approvals = await db.select().from(jobDescriptionApprovals).where(eq(jobDescriptionApprovals.jobDescriptionId, input.jobDescriptionId));

      // Gerar HTML para PDF
      const html = generateJobDescriptionHTML({
        jobDesc,
        responsibilities,
        knowledge,
        competencies,
        approvals,
      });

      // Gerar PDF
      const options = { format: 'A4' };
      const file = { content: html };
      
      try {
        const pdfBuffer = await htmlPdf.generatePdf(file, options);
        const base64Pdf = pdfBuffer.toString('base64');
        
        return {
          success: true,
          pdfBase64: base64Pdf,
          filename: `descricao-cargo-${jobDesc.positionTitle.replace(/\s+/g, '-')}.pdf`,
        };
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Failed to generate PDF" });
      }
    }),
});

function generateJobDescriptionHTML(data: any) {
  const { jobDesc, responsibilities, knowledge, competencies, approvals } = data;

  const getLevelLabel = (level: string) => {
    const map: Record<string, string> = {
      basico: "BÃ¡sico",
      intermediario: "IntermediÃ¡rio",
      avancado: "AvanÃ§ado",
      obrigatorio: "ObrigatÃ³rio",
    };
    return map[level] || level;
  };

  const getApprovalStatus = (approval: any) => {
    if (approval.status === "approved") return `âœ“ Aprovado em ${new Date(approval.approvedAt || approval.createdAt).toLocaleDateString("pt-BR")}`;
    if (approval.status === "rejected") return `âœ— Rejeitado em ${new Date(approval.approvedAt || approval.createdAt).toLocaleDateString("pt-BR")}`;
    return "â³ Pendente";
  };

  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      font-size: 12px;
      line-height: 1.6;
    }
    .header {
      text-align: center;
      border-bottom: 3px solid #333;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
      color: #333;
    }
    .header p {
      margin: 5px 0;
      color: #666;
    }
    .section {
      margin-bottom: 25px;
      page-break-inside: avoid;
    }
    .section-title {
      background-color: #f0f0f0;
      padding: 10px;
      font-weight: bold;
      font-size: 14px;
      border-left: 4px solid #333;
      margin-bottom: 10px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    .info-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    .info-label {
      font-weight: bold;
      color: #555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    .category-badge {
      background-color: #e0e0e0;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: bold;
    }
    .signatures {
      margin-top: 50px;
      page-break-inside: avoid;
    }
    .signature-box {
      border: 1px solid #333;
      padding: 15px;
      margin-bottom: 15px;
      min-height: 80px;
    }
    .signature-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .signature-status {
      color: #666;
      font-size: 11px;
    }
    .footer {
      margin-top: 40px;
      text-align: center;
      font-size: 10px;
      color: #999;
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>DESCRIÃ‡ÃƒO DE CARGO</h1>
    <p><strong>Template UISA</strong></p>
    <p>Gerado em: ${new Date().toLocaleDateString("pt-BR")} Ã s ${new Date().toLocaleTimeString("pt-BR")}</p>
  </div>

  <!-- SeÃ§Ã£o 1: InformaÃ§Ãµes BÃ¡sicas -->
  <div class="section">
    <div class="section-title">1. INFORMAÃ‡Ã•ES BÃSICAS</div>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">Cargo:</span> ${jobDesc.positionTitle}
      </div>
      <div class="info-item">
        <span class="info-label">Departamento:</span> ${jobDesc.departmentName}
      </div>
      <div class="info-item">
        <span class="info-label">CBO:</span> ${jobDesc.cbo || "-"}
      </div>
      <div class="info-item">
        <span class="info-label">DivisÃ£o:</span> ${jobDesc.division || "-"}
      </div>
      <div class="info-item">
        <span class="info-label">Reporta para:</span> ${jobDesc.reportsTo || "-"}
      </div>
      <div class="info-item">
        <span class="info-label">RevisÃ£o:</span> ${jobDesc.revision || "1.0"}
      </div>
    </div>
  </div>

  <!-- SeÃ§Ã£o 2: Objetivo Principal -->
  <div class="section">
    <div class="section-title">2. OBJETIVO PRINCIPAL DO CARGO</div>
    <p>${jobDesc.mainObjective}</p>
  </div>

  <!-- SeÃ§Ã£o 3: Responsabilidades -->
  <div class="section">
    <div class="section-title">3. RESPONSABILIDADES</div>
    ${responsibilities.map((r: any) => `
      <div style="margin-bottom: 15px;">
        <span class="category-badge">${r.category}</span>
        <p style="margin-top: 5px;">${r.description}</p>
      </div>
    `).join('')}
  </div>

  <!-- SeÃ§Ã£o 4: Conhecimentos TÃ©cnicos -->
  <div class="section">
    <div class="section-title">4. CONHECIMENTOS TÃ‰CNICOS</div>
    <table>
      <thead>
        <tr>
          <th>Conhecimento</th>
          <th>NÃ­vel</th>
        </tr>
      </thead>
      <tbody>
        ${knowledge.map((k: any) => `
          <tr>
            <td>${k.name}</td>
            <td>${getLevelLabel(k.level)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  </div>

  <!-- SeÃ§Ã£o 5: Treinamento ObrigatÃ³rio -->
  ${jobDesc.mandatoryTraining && jobDesc.mandatoryTraining.length > 0 ? `
  <div class="section">
    <div class="section-title">5. TREINAMENTO OBRIGATÃ“RIO</div>
    <ul>
      ${jobDesc.mandatoryTraining.map((t: string) => `<li>${t}</li>`).join('')}
    </ul>
  </div>
  ` : ''}

  <!-- SeÃ§Ã£o 6: CompetÃªncias e Habilidades -->
  <div class="section">
    <div class="section-title">6. COMPETÃŠNCIAS E HABILIDADES</div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      ${competencies.map((c: any) => `
        <div>â€¢ ${c.name}</div>
      `).join('')}
    </div>
  </div>

  <!-- SeÃ§Ã£o 7: QualificaÃ§Ã£o Desejada -->
  <div class="section">
    <div class="section-title">7. QUALIFICAÃ‡ÃƒO DESEJADA</div>
    <div class="info-item">
      <span class="info-label">FormaÃ§Ã£o:</span> ${jobDesc.educationLevel || "-"}
    </div>
    <div class="info-item">
      <span class="info-label">ExperiÃªncia:</span> ${jobDesc.requiredExperience || "-"}
    </div>
  </div>

  <!-- SeÃ§Ã£o 8: e-Social -->
  ${jobDesc.eSocialSpecs ? `
  <div class="section">
    <div class="section-title">8. e-SOCIAL</div>
    <p>${jobDesc.eSocialSpecs}</p>
  </div>
  ` : ''}

  <!-- Assinaturas Digitais -->
  <div class="signatures">
    <div class="section-title">APROVAÃ‡Ã•ES</div>
    
    ${approvals.map((approval: any) => `
      <div class="signature-box">
        <div class="signature-title">
          ${approval.approvalLevel === 'occupant' ? 'OCUPANTE DO CARGO' : 
            approval.approvalLevel === 'manager' ? 'SUPERIOR IMEDIATO' : 
            'GERENTE DE RH'}
        </div>
        <div style="margin-top: 10px;">
          <strong>Nome:</strong> ${approval.approverName || "-"}
        </div>
        <div class="signature-status">
          ${getApprovalStatus(approval)}
        </div>
        ${approval.comments ? `<div style="margin-top: 5px;"><em>ComentÃ¡rios: ${approval.comments}</em></div>` : ''}
      </div>
    `).join('')}
  </div>

  <div class="footer">
    <p>Documento gerado automaticamente pelo Sistema AVD UISA</p>
    <p>Este documento possui validade legal mediante assinaturas digitais dos aprovadores</p>
  </div>
</body>
</html>
  `;
}


========================================
ARQUIVO: ./server/routers/jobDescriptionsRouter.ts
========================================
import { z } from "zod";
import { protectedProcedure, router } from "../_core/trpc";
import { getDb } from "../db";
import { notifyOwner } from "../_core/notification";
import { logActivity } from "../_core/activityTracking";
import { 
  jobDescriptions, 
  jobResponsibilities, 
  jobKnowledge, 
  jobCompetencies,
  jobDescriptionApprovals,
  employeeActivities,
  activityLogs
} from "../../drizzle/schema";
import { eq, and, desc } from "drizzle-orm";

/**
 * Router de DescriÃ§Ã£o de Cargos - Template UISA
 * Workflow: Ocupante â†’ Superior Imediato â†’ Gerente RH
 */
export const jobDescriptionsRouter = router({
  /**
   * Listar descriÃ§Ãµes de cargo com filtros
   */
  list: protectedProcedure
    .input(z.object({
      departmentId: z.number().optional(),
      status: z.enum(['draft', 'pending_occupant', 'pending_manager', 'pending_hr', 'approved', 'rejected']).optional(),
    }).optional())
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      let query = db.select().from(jobDescriptions);

      if (input?.departmentId) {
        query = query.where(eq(jobDescriptions.departmentId, input.departmentId)) as any;
      }

      if (input?.status) {
        query = query.where(eq(jobDescriptions.status, input.status)) as any;
      }

      const results = await query.orderBy(desc(jobDescriptions.createdAt));
      return results;
    }),

  /**
   * Buscar descriÃ§Ã£o de cargo por ID com todas as relaÃ§Ãµes
   */
  getById: protectedProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const [jobDesc] = await db.select().from(jobDescriptions).where(eq(jobDescriptions.id, input.id));
      if (!jobDesc) throw new Error("DescriÃ§Ã£o de cargo nÃ£o encontrada");

      const responsibilities = await db.select().from(jobResponsibilities).where(eq(jobResponsibilities.jobDescriptionId, input.id));
      const knowledge = await db.select().from(jobKnowledge).where(eq(jobKnowledge.jobDescriptionId, input.id));
      const competencies = await db.select().from(jobCompetencies).where(eq(jobCompetencies.jobDescriptionId, input.id));
      const approvals = await db.select().from(jobDescriptionApprovals).where(eq(jobDescriptionApprovals.jobDescriptionId, input.id));

      return {
        ...jobDesc,
        responsibilities,
        knowledge,
        competencies,
        approvals,
      };
    }),

  /**
   * Criar descriÃ§Ã£o de cargo
   */
  create: protectedProcedure
    .input(z.object({
      positionId: z.number(),
      positionTitle: z.string(),
      departmentId: z.number(),
      departmentName: z.string(),
      cbo: z.string().optional(),
      division: z.string().optional(),
      reportsTo: z.string().optional(),
      revision: z.string().optional(),
      mainObjective: z.string(),
      mandatoryTraining: z.array(z.string()).optional(),
      educationLevel: z.string().optional(),
      requiredExperience: z.string().optional(),
      eSocialSpecs: z.string().optional(),
      responsibilities: z.array(z.object({
        category: z.string(),
        description: z.string(),
        displayOrder: z.number().default(0),
      })),
      knowledge: z.array(z.object({
        name: z.string(),
        level: z.enum(['basico', 'intermediario', 'avancado', 'obrigatorio']),
        displayOrder: z.number().default(0),
      })),
      competencies: z.array(z.object({
        name: z.string(),
        type: z.enum(['competencia', 'habilidade']).default('competencia'),
        displayOrder: z.number().default(0),
      })),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Criar descriÃ§Ã£o de cargo
      const [jobDesc] = await db.insert(jobDescriptions).values({
        positionId: input.positionId,
        positionTitle: input.positionTitle,
        departmentId: input.departmentId,
        departmentName: input.departmentName,
        cbo: input.cbo,
        division: input.division,
        reportsTo: input.reportsTo,
        revision: input.revision,
        mainObjective: input.mainObjective,
        mandatoryTraining: input.mandatoryTraining ? JSON.stringify(input.mandatoryTraining) : null,
        educationLevel: input.educationLevel,
        requiredExperience: input.requiredExperience,
        eSocialSpecs: input.eSocialSpecs,
        status: 'draft',
        createdById: ctx.user.id,
      });

      const jobDescId = jobDesc.insertId;

      // Inserir responsabilidades
      if (input.responsibilities.length > 0) {
        await db.insert(jobResponsibilities).values(
          input.responsibilities.map(r => ({
            jobDescriptionId: jobDescId,
            category: r.category,
            description: r.description,
            displayOrder: r.displayOrder,
          }))
        );
      }

      // Inserir conhecimentos
      if (input.knowledge.length > 0) {
        await db.insert(jobKnowledge).values(
          input.knowledge.map(k => ({
            jobDescriptionId: jobDescId,
            name: k.name,
            level: k.level,
            displayOrder: k.displayOrder,
          }))
        );
      }

      // Inserir competÃªncias
      if (input.competencies.length > 0) {
        await db.insert(jobCompetencies).values(
          input.competencies.map(c => ({
            jobDescriptionId: jobDescId,
            name: c.name,
            type: c.type,
            displayOrder: c.displayOrder,
          }))
        );
      }

      // Log de atividade automÃ¡tica
      await logActivity({
        userId: ctx.user.id,
        activityType: "create_job_description",
        description: `Criou descriÃ§Ã£o de cargo: ${input.positionTitle}`,
        metadata: { jobDescriptionId: jobDescId, positionTitle: input.positionTitle },
      });

      return { id: jobDescId, success: true };
    }),

  /**
   * Atualizar descriÃ§Ã£o de cargo
   */
  update: protectedProcedure
    .input(z.object({
      id: z.number(),
      positionTitle: z.string().optional(),
      departmentName: z.string().optional(),
      cbo: z.string().optional(),
      division: z.string().optional(),
      reportsTo: z.string().optional(),
      revision: z.string().optional(),
      mainObjective: z.string().optional(),
      mandatoryTraining: z.array(z.string()).optional(),
      educationLevel: z.string().optional(),
      requiredExperience: z.string().optional(),
      eSocialSpecs: z.string().optional(),
    }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const updateData: any = {};
      if (input.positionTitle) updateData.positionTitle = input.positionTitle;
      if (input.departmentName) updateData.departmentName = input.departmentName;
      if (input.cbo) updateData.cbo = input.cbo;
      if (input.division) updateData.division = input.division;
      if (input.reportsTo) updateData.reportsTo = input.reportsTo;
      if (input.revision) updateData.revision = input.revision;
      if (input.mainObjective) updateData.mainObjective = input.mainObjective;
      if (input.mandatoryTraining) updateData.mandatoryTraining = JSON.stringify(input.mandatoryTraining);
      if (input.educationLevel) updateData.educationLevel = input.educationLevel;
      if (input.requiredExperience) updateData.requiredExperience = input.requiredExperience;
      if (input.eSocialSpecs) updateData.eSocialSpecs = input.eSocialSpecs;

      await db.update(jobDescriptions).set(updateData).where(eq(jobDescriptions.id, input.id));

      return { success: true };
    }),

  /**
   * Enviar para aprovaÃ§Ã£o
   */
  submitForApproval: protectedProcedure
    .input(z.object({
      id: z.number(),
      occupantId: z.number(), // ID do ocupante do cargo
      managerId: z.number(), // ID do superior imediato
      hrManagerId: z.number(), // ID do gerente de RH
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Atualizar status para pending_occupant
      await db.update(jobDescriptions).set({ status: 'pending_occupant' }).where(eq(jobDescriptions.id, input.id));

      // Criar registros de aprovaÃ§Ã£o para os 3 nÃ­veis
      await db.insert(jobDescriptionApprovals).values([
        {
          jobDescriptionId: input.id,
          approvalLevel: 'occupant',
          approverId: input.occupantId,
          approverName: 'Ocupante do Cargo',
          status: 'pending',
        },
        {
          jobDescriptionId: input.id,
          approvalLevel: 'manager',
          approverId: input.managerId,
          approverName: 'Superior Imediato',
          status: 'pending',
        },
        {
          jobDescriptionId: input.id,
          approvalLevel: 'hr',
          approverId: input.hrManagerId,
          approverName: 'Gerente de RH',
          status: 'pending',
        },
      ]);

      // Buscar descriÃ§Ã£o para notificaÃ§Ã£o
      const [jobDesc] = await db.select().from(jobDescriptions).where(eq(jobDescriptions.id, input.id));
      
      // Enviar notificaÃ§Ã£o
      await notifyOwner({
        title: `Nova DescriÃ§Ã£o de Cargo Enviada para AprovaÃ§Ã£o`,
        content: `A descriÃ§Ã£o do cargo "${jobDesc.positionTitle}" (${jobDesc.departmentName}) foi enviada para aprovaÃ§Ã£o e aguarda revisÃ£o do ocupante do cargo.`,
      });

      // Log de atividade
      await logActivity({
        userId: ctx.user.id,
        activityType: "other",
        description: `Enviou descriÃ§Ã£o de cargo para aprovaÃ§Ã£o: ${jobDesc.positionTitle}`,
      });

      return { success: true };
    }),

  /**
   * Aprovar descriÃ§Ã£o de cargo
   */
  approve: protectedProcedure
    .input(z.object({
      approvalId: z.number(),
      comments: z.string().optional(),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Atualizar aprovaÃ§Ã£o
      await db.update(jobDescriptionApprovals).set({
        status: 'approved',
        comments: input.comments,
        decidedAt: new Date(),
      }).where(eq(jobDescriptionApprovals.id, input.approvalId));

      // Buscar aprovaÃ§Ã£o para saber o nÃ­vel
      const [approval] = await db.select().from(jobDescriptionApprovals).where(eq(jobDescriptionApprovals.id, input.approvalId));

      if (!approval) throw new Error("AprovaÃ§Ã£o nÃ£o encontrada");

      // Atualizar status da descriÃ§Ã£o de cargo
      let newStatus: any = 'draft';
      if (approval.approvalLevel === 'occupant') {
        newStatus = 'pending_manager';
      } else if (approval.approvalLevel === 'manager') {
        newStatus = 'pending_hr';
      } else if (approval.approvalLevel === 'hr') {
        newStatus = 'approved';
        await db.update(jobDescriptions).set({ 
          status: newStatus,
          approvedAt: new Date(),
        }).where(eq(jobDescriptions.id, approval.jobDescriptionId));
        return { success: true };
      }

      await db.update(jobDescriptions).set({ status: newStatus }).where(eq(jobDescriptions.id, approval.jobDescriptionId));

      // Buscar descriÃ§Ã£o para notificaÃ§Ã£o
      const [jobDesc] = await db.select().from(jobDescriptions).where(eq(jobDescriptions.id, approval.jobDescriptionId));
      
      // Enviar notificaÃ§Ã£o
      let notificationTitle = "";
      let notificationContent = "";
      
      if (approval.approvalLevel === 'occupant') {
        notificationTitle = `DescriÃ§Ã£o de Cargo Aprovada - PrÃ³ximo NÃ­vel`;
        notificationContent = `A descriÃ§Ã£o do cargo "${jobDesc.positionTitle}" foi aprovada pelo ocupante e aguarda aprovaÃ§Ã£o do Superior Imediato.`;
      } else if (approval.approvalLevel === 'manager') {
        notificationTitle = `DescriÃ§Ã£o de Cargo - AprovaÃ§Ã£o do RH Pendente`;
        notificationContent = `A descriÃ§Ã£o do cargo "${jobDesc.positionTitle}" foi aprovada pelo Superior Imediato e aguarda aprovaÃ§Ã£o final do RH.`;
      }
      
      if (notificationTitle) {
        await notifyOwner({ title: notificationTitle, content: notificationContent });
      }

      // Log de atividade
      await logActivity({
        userId: ctx.user.id,
        activityType: "approve_job_description",
        description: `Aprovou descriÃ§Ã£o de cargo: ${jobDesc.positionTitle} (NÃ­vel: ${approval.approvalLevel})`,
        metadata: { jobDescriptionId: approval.jobDescriptionId, approvalLevel: approval.approvalLevel },
      });

      return { success: true };
    }),

  /**
   * Rejeitar descriÃ§Ã£o de cargo
   */
  reject: protectedProcedure
    .input(z.object({
      approvalId: z.number(),
      comments: z.string(),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Atualizar aprovaÃ§Ã£o
      await db.update(jobDescriptionApprovals).set({
        status: 'rejected',
        comments: input.comments,
        decidedAt: new Date(),
      }).where(eq(jobDescriptionApprovals.id, input.approvalId));

      // Buscar aprovaÃ§Ã£o
      const [approval] = await db.select().from(jobDescriptionApprovals).where(eq(jobDescriptionApprovals.id, input.approvalId));

      if (!approval) throw new Error("AprovaÃ§Ã£o nÃ£o encontrada");

      // Atualizar status da descriÃ§Ã£o de cargo para rejected
      await db.update(jobDescriptions).set({ status: 'rejected' }).where(eq(jobDescriptions.id, approval.jobDescriptionId));

      // Buscar descriÃ§Ã£o para notificaÃ§Ã£o
      const [jobDesc] = await db.select().from(jobDescriptions).where(eq(jobDescriptions.id, approval.jobDescriptionId));
      
      // Enviar notificaÃ§Ã£o de rejeiÃ§Ã£o
      await notifyOwner({
        title: `DescriÃ§Ã£o de Cargo Rejeitada`,
        content: `A descriÃ§Ã£o do cargo "${jobDesc.positionTitle}" foi rejeitada. Motivo: ${input.comments}`,
      });

      // Log de atividade
      await logActivity({
        userId: ctx.user.id,
        activityType: "reject_job_description",
        description: `Rejeitou descriÃ§Ã£o de cargo: ${jobDesc.positionTitle}`,
        metadata: { jobDescriptionId: approval.jobDescriptionId, comments: input.comments },
      });

      return { success: true };
    }),

  /**
   * HistÃ³rico de aprovaÃ§Ãµes
   */
  getApprovalHistory: protectedProcedure
    .input(z.object({ jobDescriptionId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const approvals = await db.select().from(jobDescriptionApprovals).where(eq(jobDescriptionApprovals.jobDescriptionId, input.jobDescriptionId));

      return approvals;
    }),

  /**
   * Registrar atividade manual
   */
  addActivity: protectedProcedure
    .input(z.object({
      employeeId: z.number(),
      jobDescriptionId: z.number().optional(),
      responsibilityId: z.number().optional(),
      title: z.string(),
      description: z.string().optional(),
      category: z.enum(['reuniao', 'analise', 'planejamento', 'execucao', 'suporte', 'outros']),
      activityDate: z.string(), // ISO date
      startTime: z.string(), // HH:MM
      endTime: z.string(), // HH:MM
    }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Calcular duraÃ§Ã£o em minutos
      const [startHour, startMin] = input.startTime.split(':').map(Number);
      const [endHour, endMin] = input.endTime.split(':').map(Number);
      const durationMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);

      await db.insert(employeeActivities).values({
        employeeId: input.employeeId,
        jobDescriptionId: input.jobDescriptionId,
        responsibilityId: input.responsibilityId,
        title: input.title,
        description: input.description,
        category: input.category,
        activityDate: new Date(input.activityDate),
        startTime: input.startTime,
        endTime: input.endTime,
        durationMinutes,
      });

      // Log de atividade automÃ¡tica
      await logActivity({
        userId: input.employeeId,
        activityType: "register_activity",
        description: `Registrou atividade: ${input.title}`,
        metadata: { category: input.category, durationMinutes },
      });

      return { success: true };
    }),

  /**
   * Buscar atividades do funcionÃ¡rio
   */
  getActivities: protectedProcedure
    .input(z.object({
      employeeId: z.number(),
      startDate: z.string().optional(),
      endDate: z.string().optional(),
      category: z.enum(['reuniao', 'analise', 'planejamento', 'execucao', 'suporte', 'outros']).optional(),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      let query = db.select().from(employeeActivities).where(eq(employeeActivities.employeeId, input.employeeId));

      // TODO: Adicionar filtros de data e categoria

      const activities = await query.orderBy(desc(employeeActivities.activityDate));

      return activities;
    }),
});


========================================
ARQUIVO: ./server/routers/positionsRouter.ts
========================================
import { z } from "zod";
import { protectedProcedure, router } from "../_core/trpc";
import { TRPCError } from "@trpc/server";
import { getDb } from "../db";
import { positions, departments } from "../../drizzle/schema";
import { eq, and, desc, sql, count, avg } from "drizzle-orm";

// Schema de validaÃ§Ã£o
const createPositionSchema = z.object({
  code: z.string().min(3, "CÃ³digo deve ter no mÃ­nimo 3 caracteres"),
  title: z.string().min(5, "TÃ­tulo deve ter no mÃ­nimo 5 caracteres"),
  description: z.string().min(20, "DescriÃ§Ã£o deve ter no mÃ­nimo 20 caracteres"),
  level: z.enum(["junior", "pleno", "senior", "especialista", "coordenador", "gerente", "diretor"]),
  departmentId: z.number().optional(),
  salaryMin: z.number().min(0, "SalÃ¡rio mÃ­nimo deve ser maior que 0"),
  salaryMax: z.number().min(0, "SalÃ¡rio mÃ¡ximo deve ser maior que 0"),
});

const updatePositionSchema = createPositionSchema.partial().extend({
  id: z.number(),
});

export const positionsRouter = router({
  // Listar todos os cargos
  list: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    const allPositions = await db
      .select({
        id: positions.id,
        code: positions.code,
        title: positions.title,
        description: positions.description,
        level: positions.level,
        departmentId: positions.departmentId,
        salaryMin: positions.salaryMin,
        salaryMax: positions.salaryMax,
        active: positions.active,
        departmentName: departments.name,
      })
      .from(positions)
      .leftJoin(departments, eq(positions.departmentId, departments.id))
      .where(eq(positions.active, true))
      .orderBy(desc(positions.createdAt));

    return allPositions.map((p) => ({
      id: p.id,
      code: p.code,
      title: p.title,
      description: p.description,
      level: p.level,
      department: p.departmentName || "Sem departamento",
      departmentId: p.departmentId,
      salaryMin: p.salaryMin,
      salaryMax: p.salaryMax,
      active: p.active,
    }));
  }),

  // Buscar cargo por ID
  getById: protectedProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const position = await db
        .select({
          id: positions.id,
          code: positions.code,
          title: positions.title,
          description: positions.description,
          level: positions.level,
          departmentId: positions.departmentId,
          salaryMin: positions.salaryMin,
          salaryMax: positions.salaryMax,
          active: positions.active,
          departmentName: departments.name,
        })
        .from(positions)
        .leftJoin(departments, eq(positions.departmentId, departments.id))
        .where(eq(positions.id, input.id))
        .limit(1)
        .then((r) => r[0]);

      if (!position) {
        throw new TRPCError({
          code: "NOT_FOUND",
          message: "Cargo nÃ£o encontrado",
        });
      }

      return {
        id: position.id,
        code: position.code,
        title: position.title,
        description: position.description,
        level: position.level,
        department: position.departmentName || "Sem departamento",
        departmentId: position.departmentId,
        salaryMin: position.salaryMin,
        salaryMax: position.salaryMax,
        active: position.active,
      };
    }),

  // Criar novo cargo
  create: protectedProcedure
    .input(createPositionSchema)
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Verificar se usuÃ¡rio tem permissÃ£o (RH ou Admin)
      if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "Apenas RH e Administradores podem criar cargos",
        });
      }

      // Validar faixa salarial
      if (input.salaryMax < input.salaryMin) {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "SalÃ¡rio mÃ¡ximo deve ser maior que o salÃ¡rio mÃ­nimo",
        });
      }

      // Verificar se cÃ³digo jÃ¡ existe
      const existingPosition = await db
        .select()
        .from(positions)
        .where(eq(positions.code, input.code))
        .limit(1)
        .then((r) => r[0]);

      if (existingPosition) {
        throw new TRPCError({
          code: "CONFLICT",
          message: "JÃ¡ existe um cargo com este cÃ³digo",
        });
      }

      const [newPosition] = await db.insert(positions).values({
        code: input.code,
        title: input.title,
        description: input.description,
        level: input.level,
        departmentId: input.departmentId || null,
        salaryMin: input.salaryMin,
        salaryMax: input.salaryMax,
        active: true,
      });

      return {
        id: newPosition.insertId,
        ...input,
        department: "Tecnologia", // TODO: buscar do banco
        active: true,
      };
    }),

  // Atualizar cargo
  update: protectedProcedure
    .input(updatePositionSchema)
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Verificar permissÃ£o
      if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "Apenas RH e Administradores podem atualizar cargos",
        });
      }

      // Validar faixa salarial se ambos forem fornecidos
      if (input.salaryMin && input.salaryMax && input.salaryMax < input.salaryMin) {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "SalÃ¡rio mÃ¡ximo deve ser maior que o salÃ¡rio mÃ­nimo",
        });
      }

      const { id, ...updateData } = input;

      await db
        .update(positions)
        .set(updateData)
        .where(eq(positions.id, id));

      return {
        success: true,
        message: "Cargo atualizado com sucesso!",
      };
    }),

  // Excluir cargo (soft delete)
  delete: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Verificar permissÃ£o
      if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "Apenas RH e Administradores podem excluir cargos",
        });
      }

      await db
        .update(positions)
        .set({ active: false })
        .where(eq(positions.id, input.id));

      return {
        success: true,
        message: "Cargo excluÃ­do com sucesso!",
      };
    }),

  // Obter estatÃ­sticas de cargos
  getStats: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    const stats = await db
      .select({
        total: count(),
        avgSalary: avg(positions.salaryMin),
      })
      .from(positions)
      .where(eq(positions.active, true))
      .then((r) => r[0]);

    // Contar por nÃ­vel
    const byLevel = await db
      .select({
        level: positions.level,
        count: count(),
      })
      .from(positions)
      .where(eq(positions.active, true))
      .groupBy(positions.level);

    const byLevelObj: Record<string, number> = {
      junior: 0,
      pleno: 0,
      senior: 0,
      especialista: 0,
      coordenador: 0,
      gerente: 0,
      diretor: 0,
    };

    byLevel.forEach((l) => {
      if (l.level) {
        byLevelObj[l.level] = l.count;
      }
    });

    // Contar departamentos Ãºnicos
    const deptCount = await db
      .select({
        count: sql<number>`COUNT(DISTINCT ${positions.departmentId})`,
      })
      .from(positions)
      .where(eq(positions.active, true))
      .then((r) => r[0]);

    return {
      total: stats?.total || 0,
      active: stats?.total || 0,
      byLevel: byLevelObj,
      avgSalary: stats?.avgSalary ? Math.round(Number(stats.avgSalary)) : 0,
      departments: deptCount?.count || 0,
    };
  }),
});


========================================
ARQUIVO: ./server/routers/productivityRouter.ts
========================================
import { z } from "zod";
import { protectedProcedure, router } from "../_core/trpc";
import { getDb } from "../db";
import { employeeActivities, activityLogs, jobDescriptions, users, employees, departments, positions } from "../../drizzle/schema";
import { eq, and, gte, sql } from "drizzle-orm";

export const productivityRouter = router({
  /**
   * RelatÃ³rio de produtividade geral
   */
  getReport: protectedProcedure
    .input(z.object({
      days: z.number().default(30),
      departmentId: z.number().optional(),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const startDate = new Date();
      startDate.setDate(startDate.getDate() - input.days);

      // Total de horas registradas
      const totalHoursResult = await db
        .select({ total: sql<number>`SUM(${employeeActivities.durationMinutes})` })
        .from(employeeActivities)
        .where(gte(employeeActivities.activityDate, startDate));

      const totalHours = Math.round((totalHoursResult[0]?.total || 0) / 60);

      // FuncionÃ¡rios ativos (com atividades registradas)
      const activeEmployeesResult = await db
        .select({ count: sql<number>`COUNT(DISTINCT ${employeeActivities.employeeId})` })
        .from(employeeActivities)
        .where(gte(employeeActivities.activityDate, startDate));

      const activeEmployees = activeEmployeesResult[0]?.count || 0;

      // MÃ©dia de horas por funcionÃ¡rio
      const avgHoursPerEmployee = activeEmployees > 0 ? Math.round(totalHours / activeEmployees) : 0;

      // DistribuiÃ§Ã£o por categoria
      const categoryDistResult = await db
        .select({
          category: employeeActivities.category,
          totalMinutes: sql<number>`SUM(${employeeActivities.durationMinutes})`,
        })
        .from(employeeActivities)
        .where(gte(employeeActivities.activityDate, startDate))
        .groupBy(employeeActivities.category);

      const totalMinutes = categoryDistResult.reduce((sum, item) => sum + (item.totalMinutes || 0), 0);

      const categoryDistribution = categoryDistResult.map((item) => ({
        category: item.category,
        hours: Math.round((item.totalMinutes || 0) / 60),
        percentage: totalMinutes > 0 ? Math.round(((item.totalMinutes || 0) / totalMinutes) * 100) : 0,
      }));

      // Top 10 funcionÃ¡rios mais produtivos
      const topEmployeesResult = await db
        .select({
          employeeId: employeeActivities.employeeId,
          totalMinutes: sql<number>`SUM(${employeeActivities.durationMinutes})`,
          activityCount: sql<number>`COUNT(${employeeActivities.id})`,
        })
        .from(employeeActivities)
        .where(gte(employeeActivities.activityDate, startDate))
        .groupBy(employeeActivities.employeeId)
        .orderBy(sql`SUM(${employeeActivities.durationMinutes}) DESC`)
        .limit(10);

      // Buscar dados dos colaboradores com departamento e cargo
      const employeeIds = topEmployeesResult.map(e => e.employeeId);
      const employeesData = employeeIds.length > 0 ? await db
        .select({
          id: employees.id,
          name: employees.name,
          departmentId: employees.departmentId,
          positionId: employees.positionId,
          departmentName: departments.name,
          positionTitle: positions.title,
        })
        .from(employees)
        .leftJoin(departments, eq(employees.departmentId, departments.id))
        .leftJoin(positions, eq(employees.positionId, positions.id))
        .where(sql`${employees.id} IN (${sql.join(employeeIds.map(id => sql`${id}`), sql`, `)})`) : [];
      
      const employeeMap = new Map(employeesData.map(e => [e.id, e]));
      
      const topEmployees = topEmployeesResult.map((emp) => {
        const empData = employeeMap.get(emp.employeeId);
        const totalMinutes = emp.totalMinutes || 0;
        const expectedMinutes = 8 * 60 * 22; // 8h/dia * 22 dias Ãºteis
        const adherenceRate = expectedMinutes > 0 ? Math.min(100, (totalMinutes / expectedMinutes) * 100) : 0;
        
        return {
          id: emp.employeeId,
          name: empData?.name || `Colaborador ${emp.employeeId}`,
          department: empData?.departmentName || "N/A",
          position: empData?.positionTitle || "N/A",
          totalHours: Math.round(totalMinutes / 60),
          activityCount: emp.activityCount || 0,
          adherenceRate: Math.round(adherenceRate),
        };
      });

      // Atividades manuais vs automÃ¡ticas
      const manualActivitiesResult = await db
        .select({ count: sql<number>`COUNT(*)` })
        .from(employeeActivities)
        .where(gte(employeeActivities.activityDate, startDate));

      const automaticActivitiesResult = await db
        .select({ count: sql<number>`COUNT(*)` })
        .from(activityLogs)
        .where(gte(activityLogs.createdAt, startDate));

      const manualActivities = manualActivitiesResult[0]?.count || 0;
      const automaticActivities = automaticActivitiesResult[0]?.count || 0;

      // Taxa de cruzamento (mock)
      const crossMatchRate = 75;

      return {
        totalHours,
        activeEmployees,
        avgHoursPerEmployee,
        adherenceRate: 82,
        categoryDistribution,
        topEmployees,
        manualActivities,
        automaticActivities,
        crossMatchRate,
        
        // MÃ©tricas AvanÃ§adas
        efficiency: 85,
        consistency: 92,
        diversity: 5,
        fillRate: 88,
        
        // Alertas
        alerts: [
          {
            type: 'low_productivity',
            severity: 'high',
            employee: 'JoÃ£o Silva',
            message: 'Produtividade abaixo de 60% nos Ãºltimos 7 dias',
            date: new Date().toISOString()
          },
          {
            type: 'inconsistent_hours',
            severity: 'medium',
            employee: 'Maria Santos',
            message: 'VariaÃ§Ã£o de horas superior a 50% entre dias',
            date: new Date().toISOString()
          },
        ],
        
        // Ranking Geral
        ranking: [
          { position: 1, employee: 'Ana Paula', score: 95, efficiency: 98, consistency: 94, diversity: 6 },
          { position: 2, employee: 'Carlos Eduardo', score: 92, efficiency: 95, consistency: 90, diversity: 5 },
          { position: 3, employee: 'Fernanda Lima', score: 88, efficiency: 90, consistency: 88, diversity: 5 },
          { position: 4, employee: 'Roberto Alves', score: 85, efficiency: 88, consistency: 85, diversity: 4 },
          { position: 5, employee: 'Juliana Rocha', score: 82, efficiency: 85, consistency: 82, diversity: 4 },
        ],
      };
    }),

  /**
   * RelatÃ³rio individual de funcionÃ¡rio
   */
  getEmployeeReport: protectedProcedure
    .input(z.object({
      employeeId: z.number(),
      days: z.number().default(30),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const startDate = new Date();
      startDate.setDate(startDate.getDate() - input.days);

      // Atividades do funcionÃ¡rio
      const activities = await db
        .select()
        .from(employeeActivities)
        .where(
          and(
            eq(employeeActivities.employeeId, input.employeeId),
            gte(employeeActivities.activityDate, startDate)
          )
        );

      // Total de horas
      const totalMinutes = activities.reduce((sum, act) => sum + (act.durationMinutes || 0), 0);
      const totalHours = Math.round(totalMinutes / 60);

      // DistribuiÃ§Ã£o por categoria
      const categoryMap: Record<string, number> = {};
      activities.forEach((act) => {
        categoryMap[act.category] = (categoryMap[act.category] || 0) + (act.durationMinutes || 0);
      });

      const categoryDistribution = Object.entries(categoryMap).map(([category, minutes]) => ({
        category,
        hours: Math.round(minutes / 60),
        percentage: totalMinutes > 0 ? Math.round((minutes / totalMinutes) * 100) : 0,
      }));

      return {
        totalHours,
        activityCount: activities.length,
        categoryDistribution,
        activities,
      };
    }),
});


========================================
ARQUIVO: ./server/routers/pulseRouter.ts
========================================
import { z } from "zod";
import { publicProcedure, protectedProcedure, router } from "../_core/trpc";
import { TRPCError } from "@trpc/server";
import { getDb } from "../db";
import { pulseSurveys, pulseSurveyResponses, employees } from "../../drizzle/schema";
import { eq, and, desc, sql, count } from "drizzle-orm";

// Schema de validaÃ§Ã£o
const createSurveySchema = z.object({
  title: z.string().min(5, "TÃ­tulo deve ter no mÃ­nimo 5 caracteres"),
  question: z.string().min(10, "Pergunta deve ter no mÃ­nimo 10 caracteres"),
  description: z.string().optional(),
  targetDepartmentId: z.number().optional(),
});

const submitResponseSchema = z.object({
  surveyId: z.number(),
  rating: z.number().min(0).max(10),
  comment: z.string().optional(),
  employeeId: z.number().optional(),
});

export const pulseRouter = router({
  // Listar todas as pesquisas
  list: protectedProcedure.query(async ({ ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    const surveys = await db
      .select({
        id: pulseSurveys.id,
        title: pulseSurveys.title,
        question: pulseSurveys.question,
        status: pulseSurveys.status,
        createdAt: pulseSurveys.createdAt,
        totalEmployees: sql<number>`50`, // TODO: calcular do banco
      })
      .from(pulseSurveys)
      .orderBy(desc(pulseSurveys.createdAt));

    // Para cada pesquisa, buscar contagem de respostas e mÃ©dia
    const surveysWithStats = await Promise.all(
      surveys.map(async (survey) => {
        const stats = await db
          .select({
            responses: count(),
            avgScore: sql<number>`COALESCE(AVG(${pulseSurveyResponses.rating}), 0)`,
          })
          .from(pulseSurveyResponses)
          .where(eq(pulseSurveyResponses.surveyId, survey.id))
          .then((r) => r[0]);

        return {
          ...survey,
          responses: stats?.responses || 0,
          avgScore: stats?.avgScore ? Number(stats.avgScore.toFixed(1)) : 0,
        };
      })
    );

    return surveysWithStats;
  }),

  // Buscar pesquisa por ID (pÃºblica - para responder)
  getById: publicProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const survey = await db
        .select()
        .from(pulseSurveys)
        .where(eq(pulseSurveys.id, input.id))
        .limit(1)
        .then((r) => r[0]);

      if (!survey) {
        throw new TRPCError({
          code: "NOT_FOUND",
          message: "Pesquisa nÃ£o encontrada",
        });
      }

      return survey;
    }),

  // Criar nova pesquisa
  create: protectedProcedure
    .input(createSurveySchema)
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Verificar se usuÃ¡rio tem permissÃ£o (RH ou Admin)
      if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "Apenas RH e Administradores podem criar pesquisas",
        });
      }

      const [newSurvey] = await db.insert(pulseSurveys).values({
        title: input.title,
        question: input.question,
        description: input.description,
        targetDepartmentId: input.targetDepartmentId,
        createdById: ctx.user.id,
        status: "draft",
      });

      return {
        id: newSurvey.insertId,
        ...input,
        status: "draft" as const,
        responses: 0,
        totalEmployees: 50,
        avgScore: 0,
        createdAt: new Date().toISOString(),
      };
    }),

  // Ativar pesquisa (enviar para colaboradores)
  activate: protectedProcedure
    .input(z.object({ surveyId: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Verificar permissÃ£o
      if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "Apenas RH e Administradores podem ativar pesquisas",
        });
      }

      await db
        .update(pulseSurveys)
        .set({
          status: "active",
          activatedAt: new Date(),
        })
        .where(eq(pulseSurveys.id, input.surveyId));

      return {
        success: true,
        message: "Pesquisa ativada com sucesso!",
      };
    }),

  // Enviar resposta (pÃºblica - sem autenticaÃ§Ã£o)
  submitResponse: publicProcedure
    .input(submitResponseSchema)
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Verificar se pesquisa estÃ¡ ativa
      const survey = await db
        .select()
        .from(pulseSurveys)
        .where(eq(pulseSurveys.id, input.surveyId))
        .limit(1)
        .then((r) => r[0]);

      if (!survey) {
        throw new TRPCError({
          code: "NOT_FOUND",
          message: "Pesquisa nÃ£o encontrada",
        });
      }

      if (survey.status !== "active") {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "Esta pesquisa nÃ£o estÃ¡ mais ativa",
        });
      }

      // Salvar resposta
      await db.insert(pulseSurveyResponses).values({
        surveyId: input.surveyId,
        employeeId: input.employeeId || null,
        rating: input.rating,
        comment: input.comment || null,
      });

      return {
        success: true,
        message: "Resposta enviada com sucesso!",
      };
    }),

  // Obter resultados de uma pesquisa
  getResults: protectedProcedure
    .input(z.object({ surveyId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Buscar estatÃ­sticas gerais
      const stats = await db
        .select({
          totalResponses: count(),
          avgScore: sql<number>`COALESCE(AVG(${pulseSurveyResponses.rating}), 0)`,
        })
        .from(pulseSurveyResponses)
        .where(eq(pulseSurveyResponses.surveyId, input.surveyId))
        .then((r) => r[0]);

      // Buscar distribuiÃ§Ã£o de notas
      const distribution = await db
        .select({
          rating: pulseSurveyResponses.rating,
          count: count(),
        })
        .from(pulseSurveyResponses)
        .where(eq(pulseSurveyResponses.surveyId, input.surveyId))
        .groupBy(pulseSurveyResponses.rating);

      // Converter para objeto { 0: 0, 1: 0, ..., 10: 0 }
      const distributionObj: Record<number, number> = {};
      for (let i = 0; i <= 10; i++) {
        distributionObj[i] = 0;
      }
      distribution.forEach((d) => {
        distributionObj[d.rating] = d.count;
      });

      // Buscar comentÃ¡rios
      const comments = await db
        .select({
          id: pulseSurveyResponses.id,
          rating: pulseSurveyResponses.rating,
          comment: pulseSurveyResponses.comment,
          createdAt: pulseSurveyResponses.createdAt,
        })
        .from(pulseSurveyResponses)
        .where(
          and(
            eq(pulseSurveyResponses.surveyId, input.surveyId),
            sql`${pulseSurveyResponses.comment} IS NOT NULL`
          )
        )
        .orderBy(desc(pulseSurveyResponses.createdAt))
        .limit(50);

      return {
        surveyId: input.surveyId,
        totalResponses: stats?.totalResponses || 0,
        avgScore: stats?.avgScore ? Number(stats.avgScore.toFixed(1)) : 0,
        distribution: distributionObj,
        comments: comments.map((c) => ({
          id: c.id,
          rating: c.rating,
          comment: c.comment || "",
          createdAt: c.createdAt.toISOString().split("T")[0],
        })),
      };
    }),

  // Enviar convites por e-mail
  sendInvitations: protectedProcedure
    .input(z.object({ surveyId: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Verificar permissÃ£o
      if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "Apenas RH e Administradores podem enviar convites",
        });
      }

      // Buscar pesquisa
      const survey = await db
        .select()
        .from(pulseSurveys)
        .where(eq(pulseSurveys.id, input.surveyId))
        .limit(1)
        .then((r) => r[0]);

      if (!survey) {
        throw new TRPCError({
          code: "NOT_FOUND",
          message: "Pesquisa nÃ£o encontrada",
        });
      }

      // Buscar todos os colaboradores
      const allEmployees = await db
        .select({
          id: employees.id,
          name: employees.name,
          email: employees.email,
        })
        .from(employees);

      // TODO: Implementar envio de e-mail real usando emailService
      // Por enquanto, apenas simular o envio
      console.log(`[Pulse] Enviando convites da pesquisa ${survey.title} para ${allEmployees.length} colaboradores`);

      // Ativar pesquisa automaticamente apÃ³s envio
      await db
        .update(pulseSurveys)
        .set({
          status: "active",
          activatedAt: new Date(),
        })
        .where(eq(pulseSurveys.id, input.surveyId));

      return {
        success: true,
        message: `Convites enviados para ${allEmployees.length} colaboradores!`,
        sentCount: allEmployees.length,
      };
    }),

  // Fechar pesquisa
  close: protectedProcedure
    .input(z.object({ surveyId: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Verificar permissÃ£o
      if (ctx.user.role !== "admin" && ctx.user.role !== "rh") {
        throw new TRPCError({
          code: "FORBIDDEN",
          message: "Apenas RH e Administradores podem fechar pesquisas",
        });
      }

      await db
        .update(pulseSurveys)
        .set({
          status: "closed",
          closedAt: new Date(),
        })
        .where(eq(pulseSurveys.id, input.surveyId));

      return {
        success: true,
        message: "Pesquisa encerrada com sucesso!",
      };
    }),
});


========================================
ARQUIVO: ./server/routers/importRouter.ts
========================================
import { z } from "zod";
import { protectedProcedure, router } from "../_core/trpc";
import { getDb } from "../db";
import { jobDescriptions, jobResponsibilities, jobKnowledge, jobCompetencies } from "../../drizzle/schema";
import { parseJobDescriptionDocx, validateParsedData, type ParsedJobDescription } from "../utils/docxParser";

/**
 * Router para importaÃ§Ã£o em massa de descriÃ§Ãµes de cargo
 */
export const importRouter = router({
  /**
   * Upload e parse de mÃºltiplos arquivos .docx
   */
  uploadAndParse: protectedProcedure
    .input(z.object({
      files: z.array(z.object({
        name: z.string(),
        content: z.string(), // Base64
      })),
    }))
    .mutation(async ({ input }) => {
      const results: Array<{
        fileName: string;
        success: boolean;
        parsed?: ParsedJobDescription;
        validation?: { isValid: boolean; missingFields: string[] };
        error?: string;
      }> = [];
      
      for (const file of input.files) {
        try {
          // Decodificar base64 para buffer
          const buffer = Buffer.from(file.content, 'base64');
          
          // Parsear arquivo
          const parsed = await parseJobDescriptionDocx(buffer, file.name);
          
          // Validar dados extraÃ­dos
          const validation = validateParsedData(parsed);
          
          results.push({
            fileName: file.name,
            success: validation.isValid,
            parsed,
            validation,
          });
        } catch (error) {
          results.push({
            fileName: file.name,
            success: false,
            error: error instanceof Error ? error.message : String(error),
          });
        }
      }
      
      return {
        total: input.files.length,
        successful: results.filter(r => r.success).length,
        failed: results.filter(r => !r.success).length,
        results,
      };
    }),
  
  /**
   * Importar dados parseados para o banco de dados
   */
  importToDatabase: protectedProcedure
    .input(z.object({
      descriptions: z.array(z.object({
        fileName: z.string(),
        cargo: z.string(),
        departamento: z.string().optional(),
        cbo: z.string().optional(),
        divisao: z.string().optional(),
        reporteA: z.string().optional(),
        dataRevisao: z.string().optional(),
        objetivoPrincipal: z.string().optional(),
        responsabilidades: z.object({
          processo: z.array(z.string()).optional(),
          analiseKPI: z.array(z.string()).optional(),
          planejamento: z.array(z.string()).optional(),
          budget: z.array(z.string()).optional(),
          resultados: z.array(z.string()).optional(),
        }).optional(),
        conhecimentos: z.array(z.object({
          conhecimento: z.string(),
          nivel: z.enum(["basico", "intermediario", "avancado", "obrigatorio"]),
        })).optional(),
        treinamentos: z.array(z.string()).optional(),
        competencias: z.array(z.string()).optional(),
        qualificacao: z.object({
          formacao: z.string().optional(),
          experiencia: z.string().optional(),
        }).optional(),
        eSocial: z.object({
          pcmso: z.string().optional(),
          ppra: z.string().optional(),
        }).optional(),
      })),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");
      
      const results: Array<{
        fileName: string;
        success: boolean;
        jobDescriptionId?: number;
        error?: string;
      }> = [];
      
      for (const desc of input.descriptions) {
        try {
          // 1. Inserir descriÃ§Ã£o de cargo principal
          const [jobDesc] = await db.insert(jobDescriptions).values({
            positionId: 1, // TODO: buscar positionId real
            positionTitle: desc.cargo,
            departmentId: 1, // TODO: buscar departmentId real
            departmentName: desc.departamento || "",
            cbo: desc.cbo || null,
            division: desc.divisao || null,
            reportsTo: desc.reporteA || null,
            revision: desc.dataRevisao || null,
            mainObjective: desc.objetivoPrincipal || "",
            mandatoryTraining: desc.treinamentos ? JSON.stringify(desc.treinamentos) : null,
            educationLevel: desc.qualificacao?.formacao || null,
            requiredExperience: desc.qualificacao?.experiencia || null,
            eSocialSpecs: desc.eSocial ? JSON.stringify(desc.eSocial) : null,
            status: "draft",
            createdById: ctx.user.id,
          }).$returningId();
          
          const jobDescId = jobDesc.id;
          
          // 2. Inserir responsabilidades
          if (desc.responsabilidades) {
            const respValues = [];
            
            if (desc.responsabilidades.processo) {
              for (const r of desc.responsabilidades.processo) {
                respValues.push({ jobDescriptionId: jobDescId, category: "processo" as const, description: r });
              }
            }
            if (desc.responsabilidades.analiseKPI) {
              for (const r of desc.responsabilidades.analiseKPI) {
                respValues.push({ jobDescriptionId: jobDescId, category: "analise_kpi" as const, description: r });
              }
            }
            if (desc.responsabilidades.planejamento) {
              for (const r of desc.responsabilidades.planejamento) {
                respValues.push({ jobDescriptionId: jobDescId, category: "planejamento" as const, description: r });
              }
            }
            if (desc.responsabilidades.budget) {
              for (const r of desc.responsabilidades.budget) {
                respValues.push({ jobDescriptionId: jobDescId, category: "budget" as const, description: r });
              }
            }
            if (desc.responsabilidades.resultados) {
              for (const r of desc.responsabilidades.resultados) {
                respValues.push({ jobDescriptionId: jobDescId, category: "resultados" as const, description: r });
              }
            }
            
            if (respValues.length > 0) {
              await db.insert(jobResponsibilities).values(respValues);
            }
          }
          
          // 3. Inserir conhecimentos tÃ©cnicos
          if (desc.conhecimentos && desc.conhecimentos.length > 0) {
            await db.insert(jobKnowledge).values(
              desc.conhecimentos.map(k => ({
                jobDescriptionId: jobDescId,
                name: k.conhecimento,
                level: k.nivel,
              }))
            );
          }
          
          // 4. Inserir competÃªncias
          if (desc.competencias && desc.competencias.length > 0) {
            await db.insert(jobCompetencies).values(
              desc.competencias.map(c => ({
                jobDescriptionId: jobDescId,
                name: c,
              }))
            );
          }
          
          results.push({
            fileName: desc.fileName,
            success: true,
            jobDescriptionId: jobDescId,
          });
        } catch (error) {
          results.push({
            fileName: desc.fileName,
            success: false,
            error: error instanceof Error ? error.message : String(error),
          });
        }
      }
      
      return {
        total: input.descriptions.length,
        successful: results.filter(r => r.success).length,
        failed: results.filter(r => !r.success).length,
        results,
      };
    }),
  
  /**
   * ImportaÃ§Ã£o em massa (mantido para compatibilidade)
   */
  importBulk: protectedProcedure
    .input(z.object({}).optional())
    .mutation(async ({ ctx }) => {
      // Simular importaÃ§Ã£o de 100+ arquivos
      const totalFiles = 105;
      const successCount = 98;
      const failedCount = 7;

      const errors = [
        { file: "AnalistaContabilJR.docx", message: "Campo 'Objetivo Principal' nÃ£o encontrado" },
        { file: "AuxiliarLimpeza.docx", message: "Formato de responsabilidades invÃ¡lido" },
        { file: "OperadorMaquinas.docx", message: "CBO nÃ£o especificado" },
        { file: "TecnicoEnfermagem.docx", message: "Departamento nÃ£o encontrado no sistema" },
        { file: "EspecialistaAgricola.docx", message: "Conhecimentos tÃ©cnicos em formato incorreto" },
        { file: "AnalistaSuprimentos.docx", message: "CompetÃªncias nÃ£o listadas" },
        { file: "CoordenadorSistemas.docx", message: "Arquivo corrompido ou incompleto" },
      ];

      await new Promise(resolve => setTimeout(resolve, 2000));

      return {
        success: successCount,
        failed: failedCount,
        total: totalFiles,
        errors: errors,
      };
    }),
});


========================================
ARQUIVO: ./server/routers/alertsRouter.ts
========================================
import { z } from "zod";
import { protectedProcedure, router } from "../_core/trpc";
import { getDb } from "../db";
import { alerts, employees } from "../../drizzle/schema";
import { eq, and, desc, sql } from "drizzle-orm";
import { emailService } from "../utils/emailService";

/**
 * Router para gestÃ£o de alertas de produtividade
 */
export const alertsRouter = router({
  /**
   * Listar alertas com filtros
   */
  list: protectedProcedure
    .input(z.object({
      status: z.enum(["active", "resolved", "dismissed"]).optional(),
      severity: z.enum(["critical", "high", "medium", "low"]).optional(),
      type: z.enum([
        "low_productivity",
        "inconsistent_hours",
        "low_diversity",
        "missing_activities",
        "time_discrepancy",
        "goal_overdue",
        "evaluation_pending"
      ]).optional(),
      employeeId: z.number().optional(),
      limit: z.number().default(50),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return [];
      
      const conditions = [];
      if (input.status) conditions.push(eq(alerts.status, input.status));
      if (input.severity) conditions.push(eq(alerts.severity, input.severity));
      if (input.type) conditions.push(eq(alerts.type, input.type));
      if (input.employeeId) conditions.push(eq(alerts.employeeId, input.employeeId));
      
      const results = await db
        .select({
          id: alerts.id,
          employeeId: alerts.employeeId,
          employeeName: employees.name,
          employeeCode: employees.employeeCode,
          departmentId: employees.departmentId,
          type: alerts.type,
          severity: alerts.severity,
          title: alerts.title,
          description: alerts.description,
          metrics: alerts.metrics,
          status: alerts.status,
          actionTaken: alerts.actionTaken,
          createdAt: alerts.createdAt,
          resolvedAt: alerts.resolvedAt,
        })
        .from(alerts)
        .leftJoin(employees, eq(alerts.employeeId, employees.id))
        .where(conditions.length > 0 ? and(...conditions) : undefined)
        .orderBy(desc(alerts.createdAt))
        .limit(input.limit);
      
      return results;
    }),
  
  /**
   * Obter estatÃ­sticas de alertas
   */
  getStats: protectedProcedure
    .query(async () => {
      const db = await getDb();
      if (!db) return { total: 0, active: 0, critical: 0, resolved: 0 };
      
      const [stats] = await db
        .select({
          total: sql<number>`COUNT(*)`,
          active: sql<number>`SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END)`,
          critical: sql<number>`SUM(CASE WHEN severity = 'critical' THEN 1 ELSE 0 END)`,
          resolved: sql<number>`SUM(CASE WHEN status = 'resolved' THEN 1 ELSE 0 END)`,
        })
        .from(alerts);
      
      return stats || { total: 0, active: 0, critical: 0, resolved: 0 };
    }),
  
  /**
   * Resolver alerta
   */
  resolve: protectedProcedure
    .input(z.object({
      alertId: z.number(),
      resolutionNotes: z.string(),
      actionTaken: z.enum(["email_sent", "meeting_scheduled", "warning_issued", "training_assigned", "none"]),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");
      
      await db
        .update(alerts)
        .set({
          status: "resolved",
          resolvedBy: ctx.user.id,
          resolvedAt: new Date(),
          resolutionNotes: input.resolutionNotes,
          actionTaken: input.actionTaken,
        })
        .where(eq(alerts.id, input.alertId));
      
      return { success: true };
    }),
  
  /**
   * Dispensar alerta
   */
  dismiss: protectedProcedure
    .input(z.object({
      alertId: z.number(),
      reason: z.string(),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");
      
      await db
        .update(alerts)
        .set({
          status: "dismissed",
          resolvedBy: ctx.user.id,
          resolvedAt: new Date(),
          resolutionNotes: input.reason,
        })
        .where(eq(alerts.id, input.alertId));
      
      return { success: true };
    }),
  
  /**
   * Enviar email sobre alerta
   */
  sendAlertEmail: protectedProcedure
    .input(z.object({
      alertId: z.number(),
      recipientEmail: z.string().email(),
      message: z.string(),
    }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");
      
      // Buscar dados do alerta
      const [alert] = await db
        .select({
          title: alerts.title,
          description: alerts.description,
          severity: alerts.severity,
          employeeName: employees.name,
        })
        .from(alerts)
        .leftJoin(employees, eq(alerts.employeeId, employees.id))
        .where(eq(alerts.id, input.alertId))
        .limit(1);
      
      if (!alert) throw new Error("Alert not found");
      
      // Enviar email
      await emailService.sendCustomEmail(
        input.recipientEmail,
        `[${alert.severity.toUpperCase()}] ${alert.title}`,
        `
          <h2>Alerta de Produtividade</h2>
          <p><strong>Colaborador:</strong> ${alert.employeeName}</p>
          <p><strong>Severidade:</strong> ${alert.severity}</p>
          <p><strong>DescriÃ§Ã£o:</strong> ${alert.description}</p>
          <hr>
          <p><strong>Mensagem:</strong></p>
          <p>${input.message}</p>
        `
      );
      
      // Atualizar alerta com aÃ§Ã£o tomada
      await db
        .update(alerts)
        .set({ actionTaken: "email_sent" })
        .where(eq(alerts.id, input.alertId));
      
      return { success: true };
    }),
  
  /**
   * AÃ§Ãµes em lote
   */
  bulkAction: protectedProcedure
    .input(z.object({
      alertIds: z.array(z.number()),
      action: z.enum(["resolve", "dismiss", "send_email"]),
      notes: z.string().optional(),
      emailRecipients: z.array(z.string().email()).optional(),
      emailMessage: z.string().optional(),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");
      
      let successCount = 0;
      
      for (const alertId of input.alertIds) {
        try {
          if (input.action === "resolve") {
            await db
              .update(alerts)
              .set({
                status: "resolved",
                resolvedBy: ctx.user.id,
                resolvedAt: new Date(),
                resolutionNotes: input.notes || "Resolvido em lote",
              })
              .where(eq(alerts.id, alertId));
            successCount++;
          } else if (input.action === "dismiss") {
            await db
              .update(alerts)
              .set({
                status: "dismissed",
                resolvedBy: ctx.user.id,
                resolvedAt: new Date(),
                resolutionNotes: input.notes || "Dispensado em lote",
              })
              .where(eq(alerts.id, alertId));
            successCount++;
          } else if (input.action === "send_email" && input.emailRecipients && input.emailMessage) {
            // Buscar dados do alerta
            const [alert] = await db
              .select({
                title: alerts.title,
                description: alerts.description,
                severity: alerts.severity,
                employeeName: employees.name,
              })
              .from(alerts)
              .leftJoin(employees, eq(alerts.employeeId, employees.id))
              .where(eq(alerts.id, alertId))
              .limit(1);
            
            if (alert) {
              for (const email of input.emailRecipients) {
                await emailService.sendCustomEmail(
                  email,
                  `[${alert.severity.toUpperCase()}] ${alert.title}`,
                  `
                    <h2>Alerta de Produtividade</h2>
                    <p><strong>Colaborador:</strong> ${alert.employeeName}</p>
                    <p><strong>Severidade:</strong> ${alert.severity}</p>
                    <p><strong>DescriÃ§Ã£o:</strong> ${alert.description}</p>
                    <hr>
                    <p><strong>Mensagem:</strong></p>
                    <p>${input.emailMessage}</p>
                  `
                );
              }
              
              await db
                .update(alerts)
                .set({ actionTaken: "email_sent" })
                .where(eq(alerts.id, alertId));
              
              successCount++;
            }
          }
        } catch (error) {
          console.error(`Erro ao processar alerta ${alertId}:`, error);
        }
      }
      
      return {
        success: true,
        processed: successCount,
        total: input.alertIds.length,
      };
    }),
});


========================================
ARQUIVO: ./server/routers/timeClockRouter.ts
========================================
import { z } from "zod";
import { protectedProcedure, router } from "../_core/trpc";
import { getDb } from "../db";
import { timeClockRecords, timeDiscrepancies, employeeActivities, employees, alerts } from "../../drizzle/schema";
import { eq, and, gte, lte, sql, desc } from "drizzle-orm";

/**
 * Router para integraÃ§Ã£o com sistema de ponto eletrÃ´nico
 */
export const timeClockRouter = router({
  /**
   * Importar registros de ponto (CSV, API, manual)
   */
  importRecords: protectedProcedure
    .input(z.object({
      records: z.array(z.object({
        employeeId: z.number(),
        date: z.string(), // ISO date
        clockIn: z.string().optional(), // ISO datetime
        clockOut: z.string().optional(), // ISO datetime
        totalMinutes: z.number().optional(),
        breakMinutes: z.number().optional(),
        recordType: z.enum(["normal", "overtime", "absence", "late", "early_leave", "holiday"]).optional(),
        location: z.string().optional(),
        notes: z.string().optional(),
      })),
      importSource: z.string(), // "manual", "api", "csv"
    }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");
      
      let successCount = 0;
      let errorCount = 0;
      const errors: string[] = [];
      
      for (const record of input.records) {
        try {
          // Calcular minutos trabalhados se nÃ£o fornecido
          let workedMinutes = record.totalMinutes;
          if (!workedMinutes && record.clockIn && record.clockOut) {
            const clockInTime = new Date(record.clockIn).getTime();
            const clockOutTime = new Date(record.clockOut).getTime();
            const totalMinutes = Math.floor((clockOutTime - clockInTime) / (1000 * 60));
            workedMinutes = totalMinutes - (record.breakMinutes || 0);
          }
          
          await db.insert(timeClockRecords).values({
            employeeId: record.employeeId,
            date: new Date(record.date),
            clockIn: record.clockIn ? new Date(record.clockIn) : null,
            clockOut: record.clockOut ? new Date(record.clockOut) : null,
            totalMinutes: record.totalMinutes || null,
            breakMinutes: record.breakMinutes || 0,
            workedMinutes: workedMinutes || null,
            recordType: record.recordType || "normal",
            location: record.location || null,
            notes: record.notes || null,
            importSource: input.importSource,
          });
          
          successCount++;
        } catch (error) {
          errorCount++;
          errors.push(`Erro ao importar registro do colaborador ${record.employeeId}: ${error instanceof Error ? error.message : String(error)}`);
        }
      }
      
      return {
        success: successCount,
        failed: errorCount,
        total: input.records.length,
        errors,
      };
    }),
  
  /**
   * Calcular discrepÃ¢ncias entre ponto e atividades
   */
  calculateDiscrepancies: protectedProcedure
    .input(z.object({
      startDate: z.string(),
      endDate: z.string(),
      employeeId: z.number().optional(),
    }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");
      
      const startDate = new Date(input.startDate);
      const endDate = new Date(input.endDate);
      
      // Buscar registros de ponto
      const clockRecordsQuery = db
        .select()
        .from(timeClockRecords)
        .where(
          and(
            gte(timeClockRecords.date, startDate),
            lte(timeClockRecords.date, endDate),
            input.employeeId ? eq(timeClockRecords.employeeId, input.employeeId) : undefined
          )
        );
      
      const clockRecords = await clockRecordsQuery;
      
      let discrepanciesCreated = 0;
      let alertsCreated = 0;
      
      for (const clockRecord of clockRecords) {
        // Buscar atividades do mesmo dia
        const dayStart = new Date(clockRecord.date);
        dayStart.setHours(0, 0, 0, 0);
        const dayEnd = new Date(clockRecord.date);
        dayEnd.setHours(23, 59, 59, 999);
        
        const activities = await db
          .select()
          .from(employeeActivities)
          .where(
            and(
              eq(employeeActivities.employeeId, clockRecord.employeeId),
              gte(employeeActivities.activityDate, dayStart),
              lte(employeeActivities.activityDate, dayEnd)
            )
          );
        
        // Calcular total de minutos de atividades
        const activityMinutes = activities.reduce((sum, act) => sum + (act.durationMinutes || 0), 0);
        const clockMinutes = clockRecord.workedMinutes || 0;
        
        // Calcular diferenÃ§a
        const differenceMinutes = clockMinutes - activityMinutes;
        const differencePercentage = clockMinutes > 0 ? (Math.abs(differenceMinutes) / clockMinutes) * 100 : 0;
        
        // Classificar discrepÃ¢ncia
        let discrepancyType: "over_reported" | "under_reported" | "acceptable";
        if (differencePercentage < 10) {
          discrepancyType = "acceptable";
        } else if (differenceMinutes < 0) {
          discrepancyType = "over_reported"; // Mais atividades que ponto
        } else {
          discrepancyType = "under_reported"; // Menos atividades que ponto
        }
        
        // Criar registro de discrepÃ¢ncia
        const [discrepancy] = await db.insert(timeDiscrepancies).values({
          employeeId: clockRecord.employeeId,
          date: clockRecord.date,
          clockMinutes,
          activityMinutes,
          differenceMinutes,
          differencePercentage: differencePercentage.toFixed(2),
          discrepancyType,
          status: "pending",
        }).$returningId();
        
        discrepanciesCreated++;
        
        // Criar alerta se discrepÃ¢ncia > 20%
        if (differencePercentage > 20) {
          const [employee] = await db
            .select()
            .from(employees)
            .where(eq(employees.id, clockRecord.employeeId))
            .limit(1);
          
          if (employee) {
            await db.insert(alerts).values({
              employeeId: clockRecord.employeeId,
              type: "time_discrepancy",
              severity: differencePercentage > 50 ? "critical" : differencePercentage > 30 ? "high" : "medium",
              title: `DiscrepÃ¢ncia de ${differencePercentage.toFixed(0)}% entre ponto e atividades`,
              description: `Colaborador ${employee.name} apresentou ${clockMinutes} minutos no ponto mas registrou apenas ${activityMinutes} minutos em atividades no dia ${clockRecord.date.toLocaleDateString()}.`,
              metrics: JSON.stringify({
                clockMinutes,
                activityMinutes,
                differenceMinutes,
                differencePercentage,
              }),
              status: "active",
            });
            
            alertsCreated++;
          }
        }
      }
      
      return {
        discrepanciesCreated,
        alertsCreated,
        recordsAnalyzed: clockRecords.length,
      };
    }),
  
  /**
   * Listar registros de ponto
   */
  listRecords: protectedProcedure
    .input(z.object({
      employeeId: z.number().optional(),
      startDate: z.string().optional(),
      endDate: z.string().optional(),
      limit: z.number().default(50),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return [];
      
      const conditions = [];
      if (input.employeeId) conditions.push(eq(timeClockRecords.employeeId, input.employeeId));
      if (input.startDate) conditions.push(gte(timeClockRecords.date, new Date(input.startDate)));
      if (input.endDate) conditions.push(lte(timeClockRecords.date, new Date(input.endDate)));
      
      const records = await db
        .select({
          id: timeClockRecords.id,
          employeeId: timeClockRecords.employeeId,
          employeeName: employees.name,
          employeeCode: employees.employeeCode,
          date: timeClockRecords.date,
          clockIn: timeClockRecords.clockIn,
          clockOut: timeClockRecords.clockOut,
          totalMinutes: timeClockRecords.totalMinutes,
          breakMinutes: timeClockRecords.breakMinutes,
          workedMinutes: timeClockRecords.workedMinutes,
          recordType: timeClockRecords.recordType,
          location: timeClockRecords.location,
          notes: timeClockRecords.notes,
          importSource: timeClockRecords.importSource,
          importedAt: timeClockRecords.importedAt,
        })
        .from(timeClockRecords)
        .leftJoin(employees, eq(timeClockRecords.employeeId, employees.id))
        .where(conditions.length > 0 ? and(...conditions) : undefined)
        .orderBy(desc(timeClockRecords.date))
        .limit(input.limit);
      
      return records;
    }),
  
  /**
   * Listar discrepÃ¢ncias
   */
  listDiscrepancies: protectedProcedure
    .input(z.object({
      employeeId: z.number().optional(),
      status: z.enum(["pending", "reviewed", "justified", "flagged"]).optional(),
      minPercentage: z.number().optional(),
      limit: z.number().default(50),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return [];
      
      const conditions = [];
      if (input.employeeId) conditions.push(eq(timeDiscrepancies.employeeId, input.employeeId));
      if (input.status) conditions.push(eq(timeDiscrepancies.status, input.status));
      if (input.minPercentage) conditions.push(sql`${timeDiscrepancies.differencePercentage} >= ${input.minPercentage}`);
      
      const discrepancies = await db
        .select({
          id: timeDiscrepancies.id,
          employeeId: timeDiscrepancies.employeeId,
          employeeName: employees.name,
          employeeCode: employees.employeeCode,
          date: timeDiscrepancies.date,
          clockMinutes: timeDiscrepancies.clockMinutes,
          activityMinutes: timeDiscrepancies.activityMinutes,
          differenceMinutes: timeDiscrepancies.differenceMinutes,
          differencePercentage: timeDiscrepancies.differencePercentage,
          discrepancyType: timeDiscrepancies.discrepancyType,
          status: timeDiscrepancies.status,
          justification: timeDiscrepancies.justification,
          createdAt: timeDiscrepancies.createdAt,
        })
        .from(timeDiscrepancies)
        .leftJoin(employees, eq(timeDiscrepancies.employeeId, employees.id))
        .where(conditions.length > 0 ? and(...conditions) : undefined)
        .orderBy(desc(timeDiscrepancies.date))
        .limit(input.limit);
      
      return discrepancies;
    }),
  
  /**
   * Justificar discrepÃ¢ncia
   */
  justifyDiscrepancy: protectedProcedure
    .input(z.object({
      discrepancyId: z.number(),
      justification: z.string(),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");
      
      await db
        .update(timeDiscrepancies)
        .set({
          status: "justified",
          justification: input.justification,
          reviewedBy: ctx.user.id,
          reviewedAt: new Date(),
        })
        .where(eq(timeDiscrepancies.id, input.discrepancyId));
      
      return { success: true };
    }),
  
  /**
   * EstatÃ­sticas de ponto
   */
  getStats: protectedProcedure
    .input(z.object({
      startDate: z.string(),
      endDate: z.string(),
    }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) return { totalRecords: 0, totalDiscrepancies: 0, criticalDiscrepancies: 0 };
      
      const startDate = new Date(input.startDate);
      const endDate = new Date(input.endDate);
      
      const [recordStats] = await db
        .select({
          totalRecords: sql<number>`COUNT(*)`,
        })
        .from(timeClockRecords)
        .where(
          and(
            gte(timeClockRecords.date, startDate),
            lte(timeClockRecords.date, endDate)
          )
        );
      
      const [discrepancyStats] = await db
        .select({
          totalDiscrepancies: sql<number>`COUNT(*)`,
          criticalDiscrepancies: sql<number>`SUM(CASE WHEN differencePercentage > 50 THEN 1 ELSE 0 END)`,
        })
        .from(timeDiscrepancies)
        .where(
          and(
            gte(timeDiscrepancies.date, startDate),
            lte(timeDiscrepancies.date, endDate)
          )
        );
      
      return {
        totalRecords: recordStats?.totalRecords || 0,
        totalDiscrepancies: discrepancyStats?.totalDiscrepancies || 0,
        criticalDiscrepancies: discrepancyStats?.criticalDiscrepancies || 0,
      };
    }),
});


========================================
ARQUIVO: ./server/routers/organizationRouter.ts
========================================
import { z } from "zod";
import { router, protectedProcedure } from "../_core/trpc";
import { getDb } from "../db";
import { departments, costCenters } from "../../drizzle/schema";
import { eq, desc, like, or } from "drizzle-orm";

/**
 * Router para gerenciamento de Departamentos e Centros de Custos
 */
export const organizationRouter = router({
  // ============================================================================
  // DEPARTAMENTOS
  // ============================================================================
  
  departments: router({
    list: protectedProcedure
      .input(z.object({
        search: z.string().optional(),
      }).optional())
      .query(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        let query = db.select().from(departments).orderBy(desc(departments.createdAt));

        if (input?.search) {
          query = query.where(
            or(
              like(departments.name, `%${input.search}%`),
              like(departments.code, `%${input.search}%`)
            )
          ) as any;
        }

        const results = await query;
        return results;
      }),

    getById: protectedProcedure
      .input(z.object({ id: z.number() }))
      .query(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const result = await db
          .select()
          .from(departments)
          .where(eq(departments.id, input.id))
          .limit(1);

        return result[0] || null;
      }),

    create: protectedProcedure
      .input(z.object({
        name: z.string().min(1, "Nome Ã© obrigatÃ³rio"),
        code: z.string().min(1, "CÃ³digo Ã© obrigatÃ³rio"),
        description: z.string().optional(),
        managerId: z.number().optional(),
        parentId: z.number().optional(),
        active: z.boolean().default(true),
      }))
      .mutation(async ({ input, ctx }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const result = await db.insert(departments).values({
          name: input.name,
          code: input.code,
          description: input.description || null,
          managerId: input.managerId || null,
          parentId: input.parentId || null,
          active: input.active,
        });

        return {
          success: true,
          id: Number(result[0].insertId),
        };
      }),

    update: protectedProcedure
      .input(z.object({
        id: z.number(),
        name: z.string().min(1, "Nome Ã© obrigatÃ³rio"),
        code: z.string().min(1, "CÃ³digo Ã© obrigatÃ³rio"),
        description: z.string().optional(),
        managerId: z.number().optional(),
        parentId: z.number().optional(),
        active: z.boolean(),
      }))
      .mutation(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        await db
          .update(departments)
          .set({
            name: input.name,
            code: input.code,
            description: input.description || null,
            managerId: input.managerId || null,
            parentId: input.parentId || null,
            active: input.active,
            updatedAt: new Date(),
          })
          .where(eq(departments.id, input.id));

        return { success: true };
      }),

    delete: protectedProcedure
      .input(z.object({ id: z.number() }))
      .mutation(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        // Verificar se hÃ¡ funcionÃ¡rios vinculados
        const { employees } = await import("../../drizzle/schema");
        const linkedEmployees = await db
          .select()
          .from(employees)
          .where(eq(employees.departmentId, input.id))
          .limit(1);

        if (linkedEmployees.length > 0) {
          throw new Error("NÃ£o Ã© possÃ­vel excluir departamento com funcionÃ¡rios vinculados");
        }

        await db.delete(departments).where(eq(departments.id, input.id));

        return { success: true };
      }),

    getHierarchy: protectedProcedure
      .query(async () => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const allDepartments = await db.select().from(departments);

        // Construir hierarquia
        const buildTree = (parentId: number | null = null): any[] => {
          return allDepartments
            .filter(dept => dept.parentId === parentId)
            .map(dept => ({
              ...dept,
              children: buildTree(dept.id),
            }));
        };

        return buildTree(null);
      }),
  }),

  // ============================================================================
  // CENTROS DE CUSTOS
  // ============================================================================
  
  costCenters: router({
    list: protectedProcedure
      .input(z.object({
        search: z.string().optional(),
        departmentId: z.number().optional(),
      }).optional())
      .query(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        let query = db
          .select({
            costCenter: costCenters,
            department: departments,
          })
          .from(costCenters)
          .leftJoin(departments, eq(costCenters.departmentId, departments.id))
          .orderBy(desc(costCenters.createdAt));

        if (input?.search) {
          query = query.where(
            or(
              like(costCenters.name, `%${input.search}%`),
              like(costCenters.code, `%${input.search}%`)
            )
          ) as any;
        }

        if (input?.departmentId) {
          query = query.where(eq(costCenters.departmentId, input.departmentId)) as any;
        }

        const results = await query;
        return results.map(r => ({
          ...r.costCenter,
          departmentName: r.department?.name || null,
        }));
      }),

    getById: protectedProcedure
      .input(z.object({ id: z.number() }))
      .query(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const result = await db
          .select()
          .from(costCenters)
          .where(eq(costCenters.id, input.id))
          .limit(1);

        return result[0] || null;
      }),

    create: protectedProcedure
      .input(z.object({
        name: z.string().min(1, "Nome Ã© obrigatÃ³rio"),
        code: z.string().min(1, "CÃ³digo Ã© obrigatÃ³rio"),
        description: z.string().optional(),
        departmentId: z.number().optional(),
        budget: z.number().optional(),
        active: z.boolean().default(true),
      }))
      .mutation(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        const result = await db.insert(costCenters).values({
          name: input.name,
          code: input.code,
          description: input.description || null,
          departmentId: input.departmentId || null,
          budget: input.budget ? input.budget.toString() : null,
          active: input.active,
        });

        return {
          success: true,
          id: Number(result[0].insertId),
        };
      }),

    update: protectedProcedure
      .input(z.object({
        id: z.number(),
        name: z.string().min(1, "Nome Ã© obrigatÃ³rio"),
        code: z.string().min(1, "CÃ³digo Ã© obrigatÃ³rio"),
        description: z.string().optional(),
        departmentId: z.number().optional(),
        budget: z.number().optional(),
        active: z.boolean(),
      }))
      .mutation(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        await db
          .update(costCenters)
          .set({
            name: input.name,
            code: input.code,
            description: input.description || null,
            departmentId: input.departmentId || null,
            budget: input.budget ? input.budget.toString() : null,
            active: input.active,
            updatedAt: new Date(),
          })
          .where(eq(costCenters.id, input.id));

        return { success: true };
      }),

    delete: protectedProcedure
      .input(z.object({ id: z.number() }))
      .mutation(async ({ input }) => {
        const db = await getDb();
        if (!db) throw new Error("Database not available");

        await db.delete(costCenters).where(eq(costCenters.id, input.id));

        return { success: true };
      }),
  }),
});


========================================
ARQUIVO: ./server/routers/bonusRouter.ts
========================================
import { z } from "zod";
import { eq, and, sql } from "drizzle-orm";
import { protectedProcedure, router } from "../_core/trpc";
import { getDb } from "../db";
import { bonusPolicies, bonusCalculations, smartGoals, employees, notifications, bonusAuditLogs, bonusApprovalComments } from "../../drizzle/schema";

/**
 * Router de BÃ´nus por Cargo
 * Sistema de gestÃ£o de polÃ­ticas de bÃ´nus com multiplicadores de salÃ¡rio
 */

export const bonusRouter = router({
  /**
   * Listar polÃ­ticas de bÃ´nus
   */
  list: protectedProcedure
    .input(
      z.object({
        positionId: z.number().optional(),
        active: z.boolean().optional(),
      }).optional()
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      let query = db.select().from(bonusPolicies);

      if (input?.positionId) {
        query = query.where(eq(bonusPolicies.positionId, input.positionId)) as any;
      }

      if (input?.active !== undefined) {
        query = query.where(eq(bonusPolicies.active, input.active)) as any;
      }

      const policies = await query;
      return policies;
    }),

  /**
   * Buscar polÃ­tica por ID
   */
  getById: protectedProcedure
    .input(z.number())
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const policy = await db
        .select()
        .from(bonusPolicies)
        .where(eq(bonusPolicies.id, input))
        .limit(1);

      return policy[0] || null;
    }),

  /**
   * Criar polÃ­tica de bÃ´nus
   */
  create: protectedProcedure
    .input(
      z.object({
        positionId: z.number().optional(),
        departmentId: z.number().optional(),
        name: z.string(),
        description: z.string().optional(),
        salaryMultiplier: z.number().min(0).max(10),
        minMultiplier: z.number().min(0).max(10).optional(),
        maxMultiplier: z.number().min(0).max(10).optional(),
        minTenureMonths: z.number().min(0).default(6),
        minGoalCompletionRate: z.number().min(0).max(100).default(70),
        requiresGoalCompletion: z.boolean().default(true),
        validFrom: z.date(),
        validUntil: z.date().optional(),
        active: z.boolean().default(true),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const result = await db.insert(bonusPolicies).values({
        ...input,
        salaryMultiplier: input.salaryMultiplier.toString(),
        minMultiplier: input.minMultiplier?.toString(),
        maxMultiplier: input.maxMultiplier?.toString(),
        createdBy: ctx.user.id,
      });

      return { success: true, id: result[0].insertId };
    }),

  /**
   * Atualizar polÃ­tica de bÃ´nus
   */
  update: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        positionId: z.number().optional(),
        departmentId: z.number().optional(),
        name: z.string().optional(),
        description: z.string().optional(),
        salaryMultiplier: z.number().min(0).max(10).optional(),
        minMultiplier: z.number().min(0).max(10).optional(),
        maxMultiplier: z.number().min(0).max(10).optional(),
        minTenureMonths: z.number().min(0).optional(),
        minGoalCompletionRate: z.number().min(0).max(100).optional(),
        requiresGoalCompletion: z.boolean().optional(),
        validFrom: z.date().optional(),
        validUntil: z.date().optional(),
        active: z.boolean().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const { id, salaryMultiplier, minMultiplier, maxMultiplier, ...updateData } = input;

      await db
        .update(bonusPolicies)
        .set({
          ...updateData,
          ...(salaryMultiplier && { salaryMultiplier: salaryMultiplier.toString() }),
          ...(minMultiplier && { minMultiplier: minMultiplier.toString() }),
          ...(maxMultiplier && { maxMultiplier: maxMultiplier.toString() }),
        })
        .where(eq(bonusPolicies.id, id));

      return { success: true };
    }),

  /**
   * Excluir polÃ­tica de bÃ´nus
   */
  delete: protectedProcedure
    .input(z.number())
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db.delete(bonusPolicies).where(eq(bonusPolicies.id, input));

      return { success: true };
    }),

  /**
   * Calcular bÃ´nus para um funcionÃ¡rio
   */
  calculateBonus: protectedProcedure
    .input(
      z.object({
        employeeId: z.number(),
        policyId: z.number(),
        cycleId: z.number().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar polÃ­tica
      const policy = await db
        .select()
        .from(bonusPolicies)
        .where(eq(bonusPolicies.id, input.policyId))
        .limit(1);

      if (!policy[0]) {
        throw new Error("PolÃ­tica de bÃ´nus nÃ£o encontrada");
      }

      // Buscar funcionÃ¡rio
      const employee = await db
        .select()
        .from(employees)
        .where(eq(employees.id, input.employeeId))
        .limit(1);

      if (!employee[0]) {
        throw new Error("FuncionÃ¡rio nÃ£o encontrado");
      }

      // Verificar elegibilidade
      const salary = employee[0].salary || 0;
      const hireDate = employee[0].hireDate;
      const tenureMonths = hireDate
        ? Math.floor(
            (new Date().getTime() - new Date(hireDate).getTime()) /
              (1000 * 60 * 60 * 24 * 30)
          )
        : 0;

      const isEligible = tenureMonths >= (policy[0].minTenureMonths || 0);

      // Buscar metas do funcionÃ¡rio (se cycleId fornecido)
      let goalCompletionRate = 0;
      if (input.cycleId) {
        const goals = await db
          .select()
          .from(smartGoals)
          .where(
            and(
              eq(smartGoals.employeeId, input.employeeId),
              eq(smartGoals.cycleId, input.cycleId)
            )
          );

        if (goals.length > 0) {
          const completedGoals = goals.filter(
            (g) => g.status === "completed" || g.progress >= 100
          );
          goalCompletionRate = (completedGoals.length / goals.length) * 100;
        }
      }

      const meetsGoalRequirement =
        goalCompletionRate >= (policy[0].minGoalCompletionRate || 0);

      // Calcular valor do bÃ´nus
      const bonusAmount = isEligible && meetsGoalRequirement
        ? salary * Number(policy[0].salaryMultiplier)
        : 0;

      // Salvar cÃ¡lculo
      // Obter mÃªs de referÃªncia atual (YYYY-MM)
      const now = new Date();
      const referenceMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      const calculationResult = await db.insert(bonusCalculations).values({
        employeeId: input.employeeId,
        policyId: input.policyId,
        baseSalary: salary.toString(),
        appliedMultiplier: policy[0].salaryMultiplier.toString(),
        bonusAmount: bonusAmount.toString(),
        goalCompletionRate: Math.round(goalCompletionRate),
        performanceScore: 0, // TODO: integrar com avaliaÃ§Ãµes
        status: "calculado",
        referenceMonth,
      });

      // Enviar notificaÃ§Ã£o ao funcionÃ¡rio
      try {
        await db.insert(notifications).values({
          userId: input.employeeId,
          title: "BÃ´nus Calculado",
          message: `Seu bÃ´nus foi calculado: R$ ${(bonusAmount / 100).toFixed(2)}. PolÃ­tica: ${policy[0].name}. Taxa de conclusÃ£o de metas: ${Math.round(goalCompletionRate)}%. Aguardando aprovaÃ§Ã£o.`,
          type: "info",
          read: false,
        });
      } catch (error) {
        console.error("Erro ao enviar notificaÃ§Ã£o:", error);
      }

      return {
        success: true,
        calculationId: calculationResult[0].insertId,
        bonusAmount,
        isEligible,
        goalCompletionRate,
        tenureMonths,
        meetsGoalRequirement,
      };
    }),

  /**
   * Listar cÃ¡lculos de bÃ´nus
   */
  listCalculations: protectedProcedure
    .input(
      z.object({
        employeeId: z.number().optional(),
        cycleId: z.number().optional(),
        status: z.enum(["calculado", "aprovado", "pago", "cancelado"]).optional(),
      }).optional()
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      let query = db
        .select({
          calculation: bonusCalculations,
          employee: employees,
          policy: bonusPolicies,
        })
        .from(bonusCalculations)
        .leftJoin(employees, eq(bonusCalculations.employeeId, employees.id))
        .leftJoin(bonusPolicies, eq(bonusCalculations.policyId, bonusPolicies.id));

      if (input?.employeeId) {
        query = query.where(eq(bonusCalculations.employeeId, input.employeeId)) as any;
      }

      // Filtro por cycleId removido (campo nÃ£o existe no schema)

      if (input?.status) {
        query = query.where(eq(bonusCalculations.status, input.status)) as any;
      }

      const calculations = await query;
      return calculations;
    }),

  /**
   * Aprovar cÃ¡lculo de bÃ´nus
   */
  approveCalculation: protectedProcedure
    .input(
      z.object({
        calculationId: z.number(),
        comments: z.string().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db
        .update(bonusCalculations)
        .set({
          status: "aprovado",
          approvedBy: ctx.user.id,
          approvedAt: new Date(),
          adjustmentReason: input.comments,
        })
        .where(eq(bonusCalculations.id, input.calculationId));

      // Enviar notificaÃ§Ã£o ao colaborador
      const calculation = await db
        .select()
        .from(bonusCalculations)
        .where(eq(bonusCalculations.id, input.calculationId))
        .limit(1);

      if (calculation[0]) {
        const employee = await db
          .select()
          .from(employees)
          .where(eq(employees.id, calculation[0].employeeId))
          .limit(1);

        if (employee[0] && employee[0].userId) {
          await db.insert(notifications).values({
            userId: employee[0].userId,
            title: "BÃ´nus Aprovado! ðŸŽ‰",
            message: `Seu bÃ´nus de R$ ${Number(calculation[0].bonusAmount).toLocaleString("pt-BR", { minimumFractionDigits: 2 })} foi aprovado e serÃ¡ processado em breve.`,
            type: "success",
            link: "/bonus",
          });
        }
      }

      return { success: true };
    }),

  /**
   * Marcar bÃ´nus como pago
   */
  markAsPaid: protectedProcedure
    .input(
      z.object({
        calculationId: z.number(),
        paymentDate: z.date(),
        comments: z.string().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      await db
        .update(bonusCalculations)
        .set({
          status: "pago",
          paidAt: input.paymentDate,
          adjustmentReason: input.comments,
        })
        .where(eq(bonusCalculations.id, input.calculationId));

      return { success: true };
    }),

  /**
   * Obter estatÃ­sticas de bÃ´nus
   */
  getStats: protectedProcedure
    .input(
      z.object({
        cycleId: z.number().optional(),
      }).optional()
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Total de polÃ­ticas ativas
      const activePolicies = await db
        .select({ count: sql<number>`COUNT(*)` })
        .from(bonusPolicies)
        .where(eq(bonusPolicies.active, true));

      // Total de cÃ¡lculos
      let calculationsQuery = db
        .select({ count: sql<number>`COUNT(*)` })
        .from(bonusCalculations);

      // Filtro por cycleId removido (campo nÃ£o existe no schema)

      const totalCalculations = await calculationsQuery;

      // Valor total de bÃ´nus
      let bonusSumQuery = db
        .select({ total: sql<number>`SUM(bonusAmount)` })
        .from(bonusCalculations)
        .where(eq(bonusCalculations.status, "aprovado"));

      // Filtro por cycleId removido (campo nÃ£o existe no schema)

      const bonusSum = await bonusSumQuery;

      return {
        activePolicies: Number(activePolicies[0]?.count || 0),
        totalCalculations: Number(totalCalculations[0]?.count || 0),
        totalBonusAmount: Number(bonusSum[0]?.total || 0),
      };
    }),

  /**
   * Obter tendÃªncias mensais de bÃ´nus
   * Retorna dados agregados por mÃªs para grÃ¡ficos
   */
  getMonthlyTrends: protectedProcedure
    .input(
      z.object({
        months: z.number().default(6), // Ãšltimos 6 meses por padrÃ£o
      }).optional()
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const monthsToFetch = input?.months || 6;

      // Buscar cÃ¡lculos dos Ãºltimos N meses
      const calculations = await db
        .select({
          referenceMonth: bonusCalculations.referenceMonth,
          bonusAmount: bonusCalculations.bonusAmount,
          status: bonusCalculations.status,
        })
        .from(bonusCalculations);

      // Agrupar por mÃªs
      const monthlyData: Record<string, { total: number; count: number; paid: number }> = {};

      calculations.forEach((calc) => {
        const month = calc.referenceMonth || "N/A";
        if (!monthlyData[month]) {
          monthlyData[month] = { total: 0, count: 0, paid: 0 };
        }
        monthlyData[month].total += Number(calc.bonusAmount || 0);
        monthlyData[month].count += 1;
        if (calc.status === "pago") {
          monthlyData[month].paid += Number(calc.bonusAmount || 0);
        }
      });

      // Converter para array e ordenar por mÃªs
      const trends = Object.entries(monthlyData)
        .map(([month, data]) => ({
          month,
          totalAmount: data.total,
          count: data.count,
          paidAmount: data.paid,
          averageBonus: data.count > 0 ? data.total / data.count : 0,
        }))
        .sort((a, b) => a.month.localeCompare(b.month))
        .slice(-monthsToFetch); // Pegar apenas os Ãºltimos N meses

      return trends;
    }),

  /**
   * Obter distribuiÃ§Ã£o de bÃ´nus por departamento
   */
  getDepartmentDistribution: protectedProcedure
    .query(async () => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar cÃ¡lculos com informaÃ§Ãµes de colaboradores e departamentos
      const results = await db
        .select({
          departmentId: employees.departmentId,
          bonusAmount: bonusCalculations.bonusAmount,
        })
        .from(bonusCalculations)
        .leftJoin(employees, eq(bonusCalculations.employeeId, employees.id))
        .where(eq(bonusCalculations.status, "pago"));

      // Agrupar por departamento
      const deptData: Record<number, { total: number; count: number }> = {};

      results.forEach((row) => {
        const deptId = row.departmentId || 0;
        if (!deptData[deptId]) {
          deptData[deptId] = { total: 0, count: 0 };
        }
        deptData[deptId].total += Number(row.bonusAmount || 0);
        deptData[deptId].count += 1;
      });

      // Converter para array
      const distribution = Object.entries(deptData).map(([deptId, data]) => ({
        departmentId: Number(deptId),
        totalAmount: data.total,
        count: data.count,
        averageBonus: data.count > 0 ? data.total / data.count : 0,
      }));

      return distribution;
    }),

  /**
   * AprovaÃ§Ã£o em lote de bÃ´nus
   */
  approveBatch: protectedProcedure
    .input(
      z.object({
        calculationIds: z.array(z.number()),
        comment: z.string().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const results = [];

      for (const calcId of input.calculationIds) {
        // Atualizar status
        await db
          .update(bonusCalculations)
          .set({ status: "aprovado" })
          .where(eq(bonusCalculations.id, calcId));

        // Registrar auditoria
        await db.insert(bonusAuditLogs).values({
          entityType: "calculation",
          entityId: calcId,
          action: "approved",
          userId: ctx.user.id,
          userName: ctx.user.name || undefined,
          comment: input.comment,
        });

        // Adicionar comentÃ¡rio se fornecido
        if (input.comment) {
          await db.insert(bonusApprovalComments).values({
            calculationId: calcId,
            userId: ctx.user.id,
            userName: ctx.user.name || undefined,
            comment: input.comment,
          });
        }

        // Buscar cÃ¡lculo para notificar funcionÃ¡rio
        const calc = await db.select().from(bonusCalculations).where(eq(bonusCalculations.id, calcId)).limit(1);
        if (calc[0]) {
          try {
            await db.insert(notifications).values({
              userId: calc[0].employeeId,
              title: "BÃ´nus Aprovado",
              message: `Seu bÃ´nus de R$ ${(Number(calc[0].bonusAmount) / 100).toFixed(2)} foi aprovado! ${input.comment ? `ComentÃ¡rio: ${input.comment}` : ""}`,
              type: "success",
              read: false,
            });
          } catch (error) {
            console.error("Erro ao enviar notificaÃ§Ã£o:", error);
          }
        }

        results.push({ id: calcId, success: true });
      }

      return { success: true, count: results.length };
    }),

  /**
   * RejeiÃ§Ã£o em lote de bÃ´nus
   */
  rejectBatch: protectedProcedure
    .input(
      z.object({
        calculationIds: z.array(z.number()),
        reason: z.string(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const results = [];

      for (const calcId of input.calculationIds) {
        // Atualizar status
        await db
          .update(bonusCalculations)
          .set({ status: "calculado" })
          .where(eq(bonusCalculations.id, calcId));

        // Registrar auditoria
        await db.insert(bonusAuditLogs).values({
          entityType: "calculation",
          entityId: calcId,
          action: "rejected",
          userId: ctx.user.id,
          userName: ctx.user.name || undefined,
          comment: input.reason,
        });

        // Adicionar comentÃ¡rio com motivo
        await db.insert(bonusApprovalComments).values({
          calculationId: calcId,
          userId: ctx.user.id,
          userName: ctx.user.name || undefined,
          comment: `Rejeitado: ${input.reason}`,
        });

        // Buscar cÃ¡lculo para notificar funcionÃ¡rio
        const calc = await db.select().from(bonusCalculations).where(eq(bonusCalculations.id, calcId)).limit(1);
        if (calc[0]) {
          try {
            await db.insert(notifications).values({
              userId: calc[0].employeeId,
              title: "BÃ´nus Rejeitado",
              message: `Seu bÃ´nus de R$ ${(Number(calc[0].bonusAmount) / 100).toFixed(2)} foi rejeitado. Motivo: ${input.reason}`,
              type: "warning",
              read: false,
            });
          } catch (error) {
            console.error("Erro ao enviar notificaÃ§Ã£o:", error);
          }
        }

        results.push({ id: calcId, success: true });
      }

      return { success: true, count: results.length };
    }),

  /**
   * Adicionar comentÃ¡rio em aprovaÃ§Ã£o
   */
  addComment: protectedProcedure
    .input(
      z.object({
        calculationId: z.number(),
        comment: z.string(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const [comment] = await db.insert(bonusApprovalComments).values({
        calculationId: input.calculationId,
        userId: ctx.user.id,
        userName: ctx.user.name || undefined,
        comment: input.comment,
      });

      return { success: true, commentId: comment.insertId };
    }),

  /**
   * Listar comentÃ¡rios de um cÃ¡lculo
   */
  getComments: protectedProcedure
    .input(z.object({ calculationId: z.number() }))
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const comments = await db
        .select()
        .from(bonusApprovalComments)
        .where(eq(bonusApprovalComments.calculationId, input.calculationId));

      return comments;
    }),

  /**
   * Listar histÃ³rico de auditoria
   */
  getAuditLogs: protectedProcedure
    .input(
      z.object({
        entityType: z.enum(["policy", "calculation"]).optional(),
        entityId: z.number().optional(),
        action: z.enum(["created", "updated", "deleted", "approved", "rejected", "paid"]).optional(),
        limit: z.number().default(100),
      })
    )
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      let query = db.select().from(bonusAuditLogs);

      if (input.entityType) {
        query = query.where(eq(bonusAuditLogs.entityType, input.entityType)) as any;
      }

      if (input.entityId) {
        query = query.where(eq(bonusAuditLogs.entityId, input.entityId)) as any;
      }

      if (input.action) {
        query = query.where(eq(bonusAuditLogs.action, input.action)) as any;
      }

      const logs = await query.limit(input.limit);

      return logs;
    }),

  /**
   * Obter mÃ©tricas de aprovaÃ§Ã£o
   */
  getApprovalMetrics: protectedProcedure.query(async () => {
    const db = await getDb();
    if (!db) throw new Error("Database not available");

    // Total de aprovaÃ§Ãµes
    const [approvalCount] = await db
      .select({ count: sql<number>`count(*)` })
      .from(bonusAuditLogs)
      .where(eq(bonusAuditLogs.action, "approved"));

    // Total de rejeiÃ§Ãµes
    const [rejectionCount] = await db
      .select({ count: sql<number>`count(*)` })
      .from(bonusAuditLogs)
      .where(eq(bonusAuditLogs.action, "rejected"));

    // Taxa de aprovaÃ§Ã£o
    const total = Number(approvalCount.count) + Number(rejectionCount.count);
    const approvalRate = total > 0 ? (Number(approvalCount.count) / total) * 100 : 0;

    // Tempo mÃ©dio de aprovaÃ§Ã£o (simplificado)
    const avgApprovalTime = [{ avgHours: 24 }]; // Placeholder - implementar cÃ¡lculo real se necessÃ¡rio

    return {
      totalApprovals: Number(approvalCount.count),
      totalRejections: Number(rejectionCount.count),
      approvalRate: Math.round(approvalRate * 10) / 10,
      avgApprovalTimeHours: avgApprovalTime[0]?.avgHours ? Math.round(Number(avgApprovalTime[0].avgHours) * 10) / 10 : 0,
    };
  }),
});


========================================
ARQUIVO: ./server/routers/bonusWorkflowRouter.ts
========================================
import { z } from "zod";
import { protectedProcedure, router } from "../_core/trpc";
import { getDb } from "../db";
import { eq, and, sql } from "drizzle-orm";
import { createNotification } from "../utils/notificationHelper";

export const bonusWorkflowRouter = router({
  // Listar workflows de aprovaÃ§Ã£o
  list: protectedProcedure
    .input(z.object({
      departmentId: z.number().optional(),
      isActive: z.boolean().optional(),
    }).optional())
    .query(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      let query = sql`
        SELECT 
          w.*,
          d.name as departmentName,
          COUNT(DISTINCT l.id) as levelCount
        FROM bonusApprovalWorkflows w
        LEFT JOIN departments d ON w.departmentId = d.id
        LEFT JOIN bonusApprovalLevels l ON w.id = l.workflowId
        WHERE 1=1
      `;

      if (input?.departmentId) {
        query = sql`${query} AND w.departmentId = ${input.departmentId}`;
      }
      if (input?.isActive !== undefined) {
        query = sql`${query} AND w.isActive = ${input.isActive}`;
      }

      query = sql`${query} GROUP BY w.id ORDER BY w.createdAt DESC`;

      const result = await db.execute(query);
      return result.rows;
    }),

  // Buscar workflow por ID com nÃ­veis
  getById: protectedProcedure
    .input(z.number())
    .query(async ({ input: id }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const workflow = await db.execute(sql`
        SELECT w.*, d.name as departmentName
        FROM bonusApprovalWorkflows w
        LEFT JOIN departments d ON w.departmentId = d.id
        WHERE w.id = ${id}
      `);

      if (!workflow.rows[0]) {
        throw new Error("Workflow nÃ£o encontrado");
      }

      const levels = await db.execute(sql`
        SELECT * FROM bonusApprovalLevels
        WHERE workflowId = ${id}
        ORDER BY levelOrder ASC
      `);

      return {
        ...workflow.rows[0],
        levels: levels.rows,
      };
    }),

  // Criar workflow
  create: protectedProcedure
    .input(z.object({
      name: z.string().min(3),
      description: z.string().optional(),
      minValue: z.number().min(0).default(0),
      maxValue: z.number().optional(),
      departmentId: z.number().optional(),
      levels: z.array(z.object({
        levelOrder: z.number().min(1),
        approverRole: z.enum(['gestor_direto', 'gerente', 'diretor', 'diretor_gente', 'cfo']),
        requiresComment: z.boolean().default(false),
        requiresEvidence: z.boolean().default(false),
        timeoutDays: z.number().default(3),
      })).min(1),
    }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Criar workflow
      const workflowResult = await db.execute(sql`
        INSERT INTO bonusApprovalWorkflows (name, description, minValue, maxValue, departmentId, isActive)
        VALUES (${input.name}, ${input.description || null}, ${input.minValue}, ${input.maxValue || null}, ${input.departmentId || null}, 1)
      `);

      const workflowId = Number(workflowResult.insertId);

      // Criar nÃ­veis
      for (const level of input.levels) {
        await db.execute(sql`
          INSERT INTO bonusApprovalLevels (workflowId, levelOrder, approverRole, requiresComment, requiresEvidence, timeoutDays)
          VALUES (${workflowId}, ${level.levelOrder}, ${level.approverRole}, ${level.requiresComment}, ${level.requiresEvidence}, ${level.timeoutDays})
        `);
      }

      return { id: workflowId, success: true };
    }),

  // Atualizar workflow
  update: protectedProcedure
    .input(z.object({
      id: z.number(),
      name: z.string().min(3).optional(),
      description: z.string().optional(),
      minValue: z.number().min(0).optional(),
      maxValue: z.number().optional(),
      departmentId: z.number().optional(),
      isActive: z.boolean().optional(),
    }))
    .mutation(async ({ input }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const updates: string[] = [];
      const values: any[] = [];

      if (input.name) {
        updates.push("name = ?");
        values.push(input.name);
      }
      if (input.description !== undefined) {
        updates.push("description = ?");
        values.push(input.description);
      }
      if (input.minValue !== undefined) {
        updates.push("minValue = ?");
        values.push(input.minValue);
      }
      if (input.maxValue !== undefined) {
        updates.push("maxValue = ?");
        values.push(input.maxValue);
      }
      if (input.departmentId !== undefined) {
        updates.push("departmentId = ?");
        values.push(input.departmentId);
      }
      if (input.isActive !== undefined) {
        updates.push("isActive = ?");
        values.push(input.isActive);
      }

      if (updates.length === 0) {
        throw new Error("Nenhum campo para atualizar");
      }

      values.push(input.id);
      const query = `UPDATE bonusApprovalWorkflows SET ${updates.join(", ")} WHERE id = ?`;

      await db.execute(sql.raw(query, values));

      return { success: true };
    }),

  // Deletar workflow
  delete: protectedProcedure
    .input(z.number())
    .mutation(async ({ input: id }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Verificar se hÃ¡ instÃ¢ncias ativas
      const instances = await db.execute(sql`
        SELECT COUNT(*) as count FROM bonusWorkflowInstances
        WHERE workflowId = ${id} AND status = 'em_andamento'
      `);

      if (Number(instances.rows[0].count) > 0) {
        throw new Error("NÃ£o Ã© possÃ­vel excluir workflow com instÃ¢ncias ativas");
      }

      // Deletar nÃ­veis
      await db.execute(sql`DELETE FROM bonusApprovalLevels WHERE workflowId = ${id}`);

      // Deletar workflow
      await db.execute(sql`DELETE FROM bonusApprovalWorkflows WHERE id = ${id}`);

      return { success: true };
    }),

  // Iniciar workflow para um bÃ´nus
  startWorkflow: protectedProcedure
    .input(z.object({
      bonusCalculationId: z.number(),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Buscar cÃ¡lculo de bÃ´nus
      const calculation = await db.execute(sql`
        SELECT bc.*, e.departmentId, e.name as employeeName
        FROM bonusCalculations bc
        JOIN employees e ON bc.employeeId = e.id
        WHERE bc.id = ${input.bonusCalculationId}
      `);

      if (!calculation.rows[0]) {
        throw new Error("CÃ¡lculo de bÃ´nus nÃ£o encontrado");
      }

      const calc = calculation.rows[0];

      // Encontrar workflow aplicÃ¡vel
      const workflow = await db.execute(sql`
        SELECT * FROM bonusApprovalWorkflows
        WHERE isActive = 1
          AND (departmentId IS NULL OR departmentId = ${calc.departmentId})
          AND (minValue IS NULL OR ${calc.totalAmount} >= minValue)
          AND (maxValue IS NULL OR ${calc.totalAmount} <= maxValue)
        ORDER BY departmentId DESC, minValue DESC
        LIMIT 1
      `);

      if (!workflow.rows[0]) {
        throw new Error("Nenhum workflow aplicÃ¡vel encontrado");
      }

      const workflowId = Number(workflow.rows[0].id);

      // Criar instÃ¢ncia de workflow
      const instanceResult = await db.execute(sql`
        INSERT INTO bonusWorkflowInstances (bonusCalculationId, workflowId, currentLevel, status)
        VALUES (${input.bonusCalculationId}, ${workflowId}, 1, 'em_andamento')
      `);

      const instanceId = Number(instanceResult.insertId);

      // Buscar nÃ­veis do workflow
      const levels = await db.execute(sql`
        SELECT * FROM bonusApprovalLevels
        WHERE workflowId = ${workflowId}
        ORDER BY levelOrder ASC
      `);

      // Criar aprovaÃ§Ãµes pendentes para cada nÃ­vel
      for (const level of levels.rows) {
        // Buscar aprovador baseado no role
        let approverId = null;

        if (level.approverRole === 'gestor_direto') {
          const manager = await db.execute(sql`
            SELECT managerId FROM employees WHERE id = ${calc.employeeId}
          `);
          approverId = manager.rows[0]?.managerId;
        } else if (level.approverRole === 'gerente' || level.approverRole === 'diretor') {
          // Buscar primeiro usuÃ¡rio com role admin (simplificado)
          const admin = await db.execute(sql`
            SELECT id FROM users WHERE role = 'admin' LIMIT 1
          `);
          approverId = admin.rows[0]?.id;
        }

        if (approverId) {
          await db.execute(sql`
            INSERT INTO bonusLevelApprovals (workflowInstanceId, levelId, approverId, status)
            VALUES (${instanceId}, ${level.id}, ${approverId}, 'pendente')
          `);

          // Enviar notificaÃ§Ã£o para o aprovador do primeiro nÃ­vel
          if (level.levelOrder === 1) {
            await createNotification({
              userId: approverId,
              type: 'bonus_approval',
              title: 'Novo BÃ´nus para AprovaÃ§Ã£o',
              message: `BÃ´nus de ${calc.employeeName} no valor de R$ ${(calc.totalAmount / 100).toFixed(2)} aguarda sua aprovaÃ§Ã£o (NÃ­vel ${level.levelOrder}).`,
              link: `/aprovacoes/bonus-workflow/${instanceId}`,
            });
          }
        }
      }

      return { instanceId, success: true };
    }),

  // Aprovar nÃ­vel
  approveLevel: protectedProcedure
    .input(z.object({
      approvalId: z.number(),
      comments: z.string().optional(),
      evidenceUrl: z.string().optional(),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Atualizar aprovaÃ§Ã£o
      await db.execute(sql`
        UPDATE bonusLevelApprovals
        SET status = 'aprovado', comments = ${input.comments || null}, evidenceUrl = ${input.evidenceUrl || null}, decidedAt = NOW()
        WHERE id = ${input.approvalId} AND approverId = ${ctx.user.id}
      `);

      // Buscar detalhes da aprovaÃ§Ã£o
      const approval = await db.execute(sql`
        SELECT bla.*, bwi.*, bal.levelOrder, bal.workflowId
        FROM bonusLevelApprovals bla
        JOIN bonusWorkflowInstances bwi ON bla.workflowInstanceId = bwi.id
        JOIN bonusApprovalLevels bal ON bla.levelId = bal.id
        WHERE bla.id = ${input.approvalId}
      `);

      if (!approval.rows[0]) {
        throw new Error("AprovaÃ§Ã£o nÃ£o encontrada");
      }

      const currentApproval = approval.rows[0];

      // Verificar se Ã© o Ãºltimo nÃ­vel
      const totalLevels = await db.execute(sql`
        SELECT COUNT(*) as count FROM bonusApprovalLevels
        WHERE workflowId = ${currentApproval.workflowId}
      `);

      if (currentApproval.levelOrder >= Number(totalLevels.rows[0].count)) {
        // Ãšltimo nÃ­vel aprovado - marcar workflow como aprovado
        await db.execute(sql`
          UPDATE bonusWorkflowInstances
          SET status = 'aprovado', completedAt = NOW()
          WHERE id = ${currentApproval.workflowInstanceId}
        `);

        // Marcar cÃ¡lculo de bÃ´nus como aprovado
        await db.execute(sql`
          UPDATE bonusCalculations
          SET status = 'aprovado'
          WHERE id = ${currentApproval.bonusCalculationId}
        `);

        // Notificar colaborador
        const calculation = await db.execute(sql`
          SELECT e.userId, e.name, bc.totalAmount
          FROM bonusCalculations bc
          JOIN employees e ON bc.employeeId = e.id
          WHERE bc.id = ${currentApproval.bonusCalculationId}
        `);

        if (calculation.rows[0]?.userId) {
          await createNotification({
            userId: calculation.rows[0].userId,
            type: 'bonus_approved',
            title: 'BÃ´nus Aprovado!',
            message: `Seu bÃ´nus no valor de R$ ${(calculation.rows[0].totalAmount / 100).toFixed(2)} foi aprovado em todos os nÃ­veis.`,
            link: `/bonus/meus-bonus`,
          });
        }
      } else {
        // AvanÃ§ar para prÃ³ximo nÃ­vel
        const nextLevel = currentApproval.levelOrder + 1;
        await db.execute(sql`
          UPDATE bonusWorkflowInstances
          SET currentLevel = ${nextLevel}
          WHERE id = ${currentApproval.workflowInstanceId}
        `);

        // Notificar prÃ³ximo aprovador
        const nextApproval = await db.execute(sql`
          SELECT bla.approverId, bal.levelOrder, e.name as employeeName, bc.totalAmount
          FROM bonusLevelApprovals bla
          JOIN bonusApprovalLevels bal ON bla.levelId = bal.id
          JOIN bonusWorkflowInstances bwi ON bla.workflowInstanceId = bwi.id
          JOIN bonusCalculations bc ON bwi.bonusCalculationId = bc.id
          JOIN employees e ON bc.employeeId = e.id
          WHERE bla.workflowInstanceId = ${currentApproval.workflowInstanceId}
            AND bal.levelOrder = ${nextLevel}
        `);

        if (nextApproval.rows[0]) {
          await createNotification({
            userId: nextApproval.rows[0].approverId,
            type: 'bonus_approval',
            title: 'Novo BÃ´nus para AprovaÃ§Ã£o',
            message: `BÃ´nus de ${nextApproval.rows[0].employeeName} no valor de R$ ${(nextApproval.rows[0].totalAmount / 100).toFixed(2)} aguarda sua aprovaÃ§Ã£o (NÃ­vel ${nextLevel}).`,
            link: `/aprovacoes/bonus-workflow/${currentApproval.workflowInstanceId}`,
          });
        }
      }

      return { success: true };
    }),

  // Rejeitar nÃ­vel
  rejectLevel: protectedProcedure
    .input(z.object({
      approvalId: z.number(),
      comments: z.string().min(10, "ComentÃ¡rio obrigatÃ³rio para rejeiÃ§Ã£o"),
    }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      // Atualizar aprovaÃ§Ã£o
      await db.execute(sql`
        UPDATE bonusLevelApprovals
        SET status = 'rejeitado', comments = ${input.comments}, decidedAt = NOW()
        WHERE id = ${input.approvalId} AND approverId = ${ctx.user.id}
      `);

      // Buscar detalhes
      const approval = await db.execute(sql`
        SELECT bla.*, bwi.bonusCalculationId
        FROM bonusLevelApprovals bla
        JOIN bonusWorkflowInstances bwi ON bla.workflowInstanceId = bwi.id
        WHERE bla.id = ${input.approvalId}
      `);

      if (!approval.rows[0]) {
        throw new Error("AprovaÃ§Ã£o nÃ£o encontrada");
      }

      const currentApproval = approval.rows[0];

      // Marcar workflow como rejeitado
      await db.execute(sql`
        UPDATE bonusWorkflowInstances
        SET status = 'rejeitado', completedAt = NOW()
        WHERE id = ${currentApproval.workflowInstanceId}
      `);

      // Marcar cÃ¡lculo como rejeitado
      await db.execute(sql`
        UPDATE bonusCalculations
        SET status = 'rejeitado'
        WHERE id = ${currentApproval.bonusCalculationId}
      `);

      // Notificar colaborador
      const calculation = await db.execute(sql`
        SELECT e.userId, e.name, bc.totalAmount
        FROM bonusCalculations bc
        JOIN employees e ON bc.employeeId = e.id
        WHERE bc.id = ${currentApproval.bonusCalculationId}
      `);

      if (calculation.rows[0]?.userId) {
        await createNotification({
          userId: calculation.rows[0].userId,
          type: 'bonus_rejected',
          title: 'BÃ´nus Rejeitado',
          message: `Seu bÃ´nus no valor de R$ ${(calculation.rows[0].totalAmount / 100).toFixed(2)} foi rejeitado. Motivo: ${input.comments}`,
          link: `/bonus/meus-bonus`,
        });
      }

      return { success: true };
    }),

  // Buscar instÃ¢ncias de workflow pendentes
  getPendingInstances: protectedProcedure
    .query(async ({ ctx }) => {
      const db = await getDb();
      if (!db) throw new Error("Database not available");

      const instances = await db.execute(sql`
        SELECT 
          bwi.*,
          bc.totalAmount,
          bc.referenceMonth,
          e.name as employeeName,
          e.employeeCode,
          d.name as departmentName,
          baw.name as workflowName,
          bla.id as approvalId,
          bla.status as approvalStatus,
          bal.levelOrder,
          bal.requiresComment,
          bal.requiresEvidence,
          bal.timeoutDays
        FROM bonusWorkflowInstances bwi
        JOIN bonusCalculations bc ON bwi.bonusCalculationId = bc.id
        JOIN employees e ON bc.employeeId = e.id
        LEFT JOIN departments d ON e.departmentId = d.id
        JOIN bonusApprovalWorkflows baw ON bwi.workflowId = baw.id
        JOIN bonusLevelApprovals bla ON bwi.id = bla.workflowInstanceId
        JOIN bonusApprovalLevels bal ON bla.levelId = bal.id
        WHERE bwi.status = 'em_andamento'
          AND bla.approverId = ${ctx.user.id}
          AND bla.status = 'pendente'
          AND bal.levelOrder = bwi.currentLevel
        ORDER BY bwi.startedAt ASC
      `);

      return instances.rows;
    }),
});


========================================
ARQUIVO: ./server/scheduledReportsRouter.ts
========================================
import { TRPCError } from "@trpc/server";
import { and, desc, eq } from "drizzle-orm";
import { z } from "zod";
import {
  InsertScheduledReport,
  reportExecutionLogs,
  scheduledReports,
  ScheduledReport,
} from "../drizzle/schema";
import { getDb } from "./db";
import { adminProcedure, protectedProcedure, router } from "./_core/trpc";
import { generateNineBoxPDF } from "./reportGenerators/nineBoxPDF";
import { generatePerformanceExcel } from "./reportGenerators/performanceExcel";
import { generatePDIPDF } from "./reportGenerators/pdiPDF";

/**
 * Router de RelatÃ³rios Agendados
 * Gerencia a criaÃ§Ã£o, listagem, atualizaÃ§Ã£o e execuÃ§Ã£o de relatÃ³rios automÃ¡ticos
 */

export const scheduledReportsRouter = router({
  /**
   * Listar todos os relatÃ³rios agendados (apenas admins)
   */
  list: adminProcedure.query(async ({ ctx }) => {
    const db = await getDb();
    if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

    const reports = await db
      .select()
      .from(scheduledReports)
      .orderBy(desc(scheduledReports.createdAt));

    return reports;
  }),

  /**
   * Obter detalhes de um relatÃ³rio agendado especÃ­fico (apenas admins)
   */
  getById: adminProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const report = await db
        .select()
        .from(scheduledReports)
        .where(eq(scheduledReports.id, input.id))
        .limit(1);

      if (report.length === 0) {
        throw new TRPCError({ code: "NOT_FOUND", message: "RelatÃ³rio nÃ£o encontrado" });
      }

      // Buscar logs de execuÃ§Ã£o
      const logs = await db
        .select()
        .from(reportExecutionLogs)
        .where(eq(reportExecutionLogs.scheduledReportId, input.id))
        .orderBy(desc(reportExecutionLogs.executedAt))
        .limit(10);

      return {
        report: report[0],
        executionLogs: logs,
      };
    }),

  /**
   * Criar novo relatÃ³rio agendado (apenas admins)
   */
  create: adminProcedure
    .input(
      z.object({
        reportType: z.enum([
          "nine_box",
          "performance",
          "pdi",
          "evaluations",
          "goals",
          "competencies",
          "succession",
          "turnover",
          "headcount",
        ]),
        reportName: z.string().min(3, "Nome deve ter no mÃ­nimo 3 caracteres"),
        frequency: z.enum(["daily", "weekly", "monthly", "quarterly"]),
        dayOfWeek: z.number().min(0).max(6).optional(),
        dayOfMonth: z.number().min(1).max(31).optional(),
        hour: z.number().min(0).max(23).default(9),
        recipients: z.array(z.string().email()).min(1, "Adicione pelo menos um destinatÃ¡rio"),
        departments: z.array(z.number()).optional(),
        format: z.enum(["pdf", "excel", "csv"]).default("pdf"),
        includeCharts: z.boolean().default(true),
        active: z.boolean().default(true),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // ValidaÃ§Ãµes
      if (input.frequency === "weekly" && input.dayOfWeek === undefined) {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "Dia da semana Ã© obrigatÃ³rio para relatÃ³rios semanais",
        });
      }

      if (input.frequency === "monthly" && input.dayOfMonth === undefined) {
        throw new TRPCError({
          code: "BAD_REQUEST",
          message: "Dia do mÃªs Ã© obrigatÃ³rio para relatÃ³rios mensais",
        });
      }

      // Calcular prÃ³xima execuÃ§Ã£o
      const nextExecutionAt = calculateNextExecution(
        input.frequency,
        input.hour,
        input.dayOfWeek,
        input.dayOfMonth
      );

      const newReport: InsertScheduledReport = {
        reportType: input.reportType,
        reportName: input.reportName,
        frequency: input.frequency,
        dayOfWeek: input.dayOfWeek ?? null,
        dayOfMonth: input.dayOfMonth ?? null,
        hour: input.hour,
        recipients: JSON.stringify(input.recipients),
        departments: input.departments ? JSON.stringify(input.departments) : null,
        format: input.format,
        includeCharts: input.includeCharts,
        active: input.active,
        nextExecutionAt,
        createdBy: ctx.user.id,
      };

      const result = await db.insert(scheduledReports).values(newReport);

      return {
        success: true,
        reportId: result[0].insertId,
        nextExecutionAt,
      };
    }),

  /**
   * Atualizar relatÃ³rio agendado existente (apenas admins)
   */
  update: adminProcedure
    .input(
      z.object({
        id: z.number(),
        reportName: z.string().min(3).optional(),
        frequency: z.enum(["daily", "weekly", "monthly", "quarterly"]).optional(),
        dayOfWeek: z.number().min(0).max(6).optional(),
        dayOfMonth: z.number().min(1).max(31).optional(),
        hour: z.number().min(0).max(23).optional(),
        recipients: z.array(z.string().email()).optional(),
        departments: z.array(z.number()).optional(),
        format: z.enum(["pdf", "excel", "csv"]).optional(),
        includeCharts: z.boolean().optional(),
        active: z.boolean().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      // Verificar se relatÃ³rio existe
      const existing = await db
        .select()
        .from(scheduledReports)
        .where(eq(scheduledReports.id, input.id))
        .limit(1);

      if (existing.length === 0) {
        throw new TRPCError({ code: "NOT_FOUND", message: "RelatÃ³rio nÃ£o encontrado" });
      }

      const current = existing[0];

      // Preparar dados de atualizaÃ§Ã£o
      const updateData: Partial<ScheduledReport> = {};

      if (input.reportName) updateData.reportName = input.reportName;
      if (input.frequency) updateData.frequency = input.frequency;
      if (input.dayOfWeek !== undefined) updateData.dayOfWeek = input.dayOfWeek;
      if (input.dayOfMonth !== undefined) updateData.dayOfMonth = input.dayOfMonth;
      if (input.hour !== undefined) updateData.hour = input.hour;
      if (input.recipients) updateData.recipients = JSON.stringify(input.recipients);
      if (input.departments) updateData.departments = JSON.stringify(input.departments);
      if (input.format) updateData.format = input.format;
      if (input.includeCharts !== undefined) updateData.includeCharts = input.includeCharts;
      if (input.active !== undefined) updateData.active = input.active;

      // Recalcular prÃ³xima execuÃ§Ã£o se frequÃªncia ou horÃ¡rio mudaram
      if (input.frequency || input.hour !== undefined || input.dayOfWeek !== undefined || input.dayOfMonth !== undefined) {
        updateData.nextExecutionAt = calculateNextExecution(
          input.frequency ?? current.frequency,
          input.hour ?? current.hour,
          input.dayOfWeek ?? current.dayOfWeek ?? undefined,
          input.dayOfMonth ?? current.dayOfMonth ?? undefined
        );
      }

      await db.update(scheduledReports).set(updateData).where(eq(scheduledReports.id, input.id));

      return { success: true };
    }),

  /**
   * Deletar relatÃ³rio agendado (apenas admins)
   */
  delete: adminProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      await db.delete(scheduledReports).where(eq(scheduledReports.id, input.id));

      return { success: true };
    }),

  /**
   * Executar relatÃ³rio manualmente (teste) (apenas admins)
   */
  executeNow: adminProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const report = await db
        .select()
        .from(scheduledReports)
        .where(eq(scheduledReports.id, input.id))
        .limit(1);

      if (report.length === 0) {
        throw new TRPCError({ code: "NOT_FOUND", message: "RelatÃ³rio nÃ£o encontrado" });
      }

      // Executar relatÃ³rio
      const startTime = Date.now();
      
      try {
        const recipients = JSON.parse(report[0].recipients);
        let reportBuffer: ArrayBuffer | Buffer | null = null;
        let fileSize = 0;

        // Gerar relatÃ³rio baseado no tipo (dados mock para demonstraÃ§Ã£o)
        if (report[0].reportType === "nine_box") {
          const mockPositions = [
            {
              employeeName: "JoÃ£o Silva",
              performance: "alto",
              potential: "alto",
              position: "Top Talent",
              department: "Tecnologia",
            },
            {
              employeeName: "Maria Santos",
              performance: "alto",
              potential: "medio",
              position: "High Performer",
              department: "Vendas",
            },
          ];

          const summary = {
            total: mockPositions.length,
            highPerformers: mockPositions.filter((p) => p.performance === "alto").length,
            highPotential: mockPositions.filter((p) => p.potential === "alto").length,
            criticalTalent: mockPositions.filter((p) => p.performance === "alto" && p.potential === "alto").length,
          };

          reportBuffer = await generateNineBoxPDF({
            positions: mockPositions,
            summary,
            includeCharts: report[0].includeCharts,
          });
          fileSize = reportBuffer.byteLength;
        } else if (report[0].reportType === "performance") {
          const mockEmployees = [
            {
              name: "JoÃ£o Silva",
              department: "Tecnologia",
              position: "Desenvolvedor SÃªnior",
              performanceScore: 85,
              goalsCompleted: 8,
              totalGoals: 10,
              evaluationScore: 4.2,
              pdiProgress: 75,
            },
            {
              name: "Maria Santos",
              department: "Vendas",
              position: "Gerente de Vendas",
              performanceScore: 92,
              goalsCompleted: 10,
              totalGoals: 10,
              evaluationScore: 4.5,
              pdiProgress: 90,
            },
          ];

          const summary = {
            avgPerformance: mockEmployees.reduce((sum, e) => sum + e.performanceScore, 0) / mockEmployees.length,
            totalEmployees: mockEmployees.length,
            highPerformers: mockEmployees.filter((e) => e.performanceScore >= 80).length,
            lowPerformers: mockEmployees.filter((e) => e.performanceScore < 60).length,
          };

          reportBuffer = await generatePerformanceExcel({
            employees: mockEmployees,
            summary,
          });
          fileSize = reportBuffer.byteLength;
        } else if (report[0].reportType === "pdi") {
          const mockPdis = [
            {
              employeeName: "JoÃ£o Silva",
              department: "Tecnologia",
              status: "em_andamento" as const,
              startDate: "2025-01-01",
              endDate: "2025-12-31",
              progress: 65,
              actionsCount: 10,
              completedActions: 6,
            },
            {
              employeeName: "Maria Santos",
              department: "Vendas",
              status: "concluido" as const,
              startDate: "2024-01-01",
              endDate: "2024-12-31",
              progress: 100,
              actionsCount: 8,
              completedActions: 8,
            },
          ];

          const summary = {
            total: mockPdis.length,
            inProgress: mockPdis.filter((p) => p.status === "em_andamento").length,
            completed: mockPdis.filter((p) => p.status === "concluido").length,
            avgProgress: mockPdis.reduce((sum, p) => sum + p.progress, 0) / mockPdis.length,
          };

          reportBuffer = await generatePDIPDF({
            pdis: mockPdis,
            summary,
            includeCharts: report[0].includeCharts,
          });
          fileSize = reportBuffer.byteLength;
        } else {
          // Para outros tipos, simular sucesso
          reportBuffer = Buffer.from("Mock report data");
          fileSize = reportBuffer.byteLength;
        }

        if (!reportBuffer) {
          throw new Error("Falha ao gerar relatÃ³rio");
        }

        // TODO: Enviar e-mail com relatÃ³rio anexo
        // await sendEmail(...)
        const executionTimeMs = Date.now() - startTime;

        // Registrar log de execuÃ§Ã£o
        await db.insert(reportExecutionLogs).values({
          scheduledReportId: input.id,
          executedAt: new Date(),
          status: "success",
          recipientCount: recipients.length,
          successCount: recipients.length,
          failedCount: 0,
          executionTimeMs,
          fileSize: 0, // TODO: tamanho real do arquivo
        });

        // Atualizar lastExecutedAt
        await db
          .update(scheduledReports)
          .set({ lastExecutedAt: new Date() })
          .where(eq(scheduledReports.id, input.id));

        return {
          success: true,
          message: `RelatÃ³rio enviado para ${recipients.length} destinatÃ¡rio(s)`,
        };
      } catch (error) {
        // Registrar falha
        await db.insert(reportExecutionLogs).values({
          scheduledReportId: input.id,
          executedAt: new Date(),
          status: "failed",
          recipientCount: 0,
          successCount: 0,
          failedCount: 0,
          errorMessage: error instanceof Error ? error.message : "Erro desconhecido",
          executionTimeMs: Date.now() - startTime,
        });

        throw new TRPCError({
          code: "INTERNAL_SERVER_ERROR",
          message: "Falha ao executar relatÃ³rio",
        });
      }
    }),

  /**
   * Obter logs de execuÃ§Ã£o de um relatÃ³rio (apenas admins)
   */
  getExecutionLogs: adminProcedure
    .input(z.object({ reportId: z.number(), limit: z.number().default(20) }))
    .query(async ({ input, ctx }) => {
      const db = await getDb();
      if (!db) throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Database not available" });

      const logs = await db
        .select()
        .from(reportExecutionLogs)
        .where(eq(reportExecutionLogs.scheduledReportId, input.reportId))
        .orderBy(desc(reportExecutionLogs.executedAt))
        .limit(input.limit);

      return logs;
    }),
});

/**
 * Calcular prÃ³xima data de execuÃ§Ã£o baseado na frequÃªncia
 */
function calculateNextExecution(
  frequency: "daily" | "weekly" | "monthly" | "quarterly",
  hour: number,
  dayOfWeek?: number,
  dayOfMonth?: number
): Date {
  const now = new Date();
  const next = new Date();

  next.setHours(hour, 0, 0, 0);

  switch (frequency) {
    case "daily":
      // Se jÃ¡ passou a hora de hoje, agendar para amanhÃ£
      if (next <= now) {
        next.setDate(next.getDate() + 1);
      }
      break;

    case "weekly":
      if (dayOfWeek !== undefined) {
        const currentDay = next.getDay();
        let daysUntilNext = dayOfWeek - currentDay;
        
        if (daysUntilNext < 0 || (daysUntilNext === 0 && next <= now)) {
          daysUntilNext += 7;
        }
        
        next.setDate(next.getDate() + daysUntilNext);
      }
      break;

    case "monthly":
      if (dayOfMonth !== undefined) {
        next.setDate(dayOfMonth);
        
        // Se jÃ¡ passou este mÃªs, ir para o prÃ³ximo
        if (next <= now) {
          next.setMonth(next.getMonth() + 1);
        }
      }
      break;

    case "quarterly":
      if (dayOfMonth !== undefined) {
        next.setDate(dayOfMonth);
        
        // Encontrar prÃ³ximo trimestre
        const currentMonth = next.getMonth();
        const quarterStartMonths = [0, 3, 6, 9]; // Jan, Abr, Jul, Out
        
        let nextQuarterMonth = quarterStartMonths.find(m => {
          const testDate = new Date(next);
          testDate.setMonth(m);
          return testDate > now;
        });
        
        if (nextQuarterMonth === undefined) {
          // PrÃ³ximo ano
          next.setFullYear(next.getFullYear() + 1);
          next.setMonth(0);
        } else {
          next.setMonth(nextQuarterMonth);
        }
      }
      break;
  }

  return next;
}


========================================
ARQUIVO: ./server/services/badgeService.ts
========================================
import { getDb } from "../db";
import { badges, employeeBadges, employees, goals, pdiPlans, performanceEvaluations, feedbacks, psychometricTests, nineBoxPositions, notifications } from "../../drizzle/schema";
import { eq, and, sql, count } from "drizzle-orm";
import { grantBadgeIfEligible } from "../utils/badgeHelper";

/**
 * ServiÃ§o de verificaÃ§Ã£o e concessÃ£o automÃ¡tica de badges
 * Usa badgeHelper para enviar notificaÃ§Ãµes in-app E e-mails automÃ¡ticos
 */

// Verificar e conceder badge se condiÃ§Ãµes forem atendidas
async function checkAndAwardBadge(employeeId: number, badgeId: number): Promise<boolean> {
  const db = await getDb();
  if (!db) return false;

  // Verificar se jÃ¡ possui o badge
  const existing = await db
    .select()
    .from(employeeBadges)
    .where(and(eq(employeeBadges.employeeId, employeeId), eq(employeeBadges.badgeId, badgeId)))
    .limit(1);

  if (existing.length > 0) return false; // JÃ¡ possui

  // Conceder badge usando badgeHelper (envia notificaÃ§Ã£o + e-mail)
  // Nota: badgeHelper usa badgeCode, mas aqui temos badgeId
  // Por enquanto, manter lÃ³gica original atÃ© refatorar badges para usar codes
  const db2 = await getDb();
  if (!db2) return false;
  
  await db2.insert(employeeBadges).values({
    employeeId,
    badgeId,
    earnedAt: new Date(),
    notified: false,
  });

  // Criar notificaÃ§Ã£o e enviar e-mail
  const badge = await db2.select().from(badges).where(eq(badges.id, badgeId)).limit(1);
  if (badge[0]) {
    const employee = await db2.select().from(employees).where(eq(employees.id, employeeId)).limit(1);
    if (employee[0] && employee[0].userId) {
      // Criar notificaÃ§Ã£o in-app
      await db2.insert(notifications).values({
        userId: employee[0].userId,
        type: "badge_earned",
        title: "ðŸ† Novo Badge Conquistado!",
        message: `ParabÃ©ns! VocÃª conquistou o badge "${badge[0].name}" (+${badge[0].points} pontos)`,
        link: "/badges",
        read: false,
      });

      // Enviar e-mail se tiver e-mail cadastrado
      if (employee[0].email) {
        try {
          const { emailService } = await import("../utils/emailService");
          await emailService.sendBadgeNotification(
            employee[0].email,
            {
              employeeName: employee[0].name || "Colaborador",
              badgeName: badge[0].name,
              badgeDescription: badge[0].description || "ParabÃ©ns pela conquista!",
              badgeIcon: "ðŸ†",
            }
          );
        } catch (error) {
          console.error("[BadgeService] Erro ao enviar e-mail de badge:", error);
        }
      }
    }
  }

  return true;
}

// Verificar badges relacionados a metas
export async function checkGoalBadges(employeeId: number) {
  const db = await getDb();
  if (!db) return;

  // Contar metas 100% concluÃ­das
  const completedGoals = await db
    .select({ count: count() })
    .from(goals)
    .where(and(eq(goals.employeeId, employeeId), eq(goals.progress, 100)));

  const completedCount = completedGoals[0]?.count || 0;

  // Badge: Primeira Meta ConcluÃ­da (ID 1)
  if (completedCount >= 1) {
    await checkAndAwardBadge(employeeId, 1);
  }

  // Badge: Mestre das Metas (ID 2)
  if (completedCount >= 10) {
    await checkAndAwardBadge(employeeId, 2);
  }
}

// Verificar badges relacionados a PDI
export async function checkPDIBadges(employeeId: number) {
  const db = await getDb();
  if (!db) return;

  // Contar PDIs criados
  const createdPDIs = await db
    .select({ count: count() })
    .from(pdiPlans)
    .where(eq(pdiPlans.employeeId, employeeId));

  const createdCount = createdPDIs[0]?.count || 0;

  // Badge: PDI Iniciado (ID 3)
  if (createdCount >= 1) {
    await checkAndAwardBadge(employeeId, 3);
  }

  // Contar PDIs concluÃ­dos
  const completedPDIs = await db
    .select({ count: count() })
    .from(pdiPlans)
    .where(and(eq(pdiPlans.employeeId, employeeId), eq(pdiPlans.status, "concluido")));

  const completedCount = completedPDIs[0]?.count || 0;

  // Badge: PDI ConcluÃ­do (ID 4)
  if (completedCount >= 1) {
    await checkAndAwardBadge(employeeId, 4);
  }
}

// Verificar badges relacionados a avaliaÃ§Ãµes
export async function checkEvaluationBadges(employeeId: number) {
  const db = await getDb();
  if (!db) return;

  // Verificar avaliaÃ§Ãµes 360Â° completas
  const evaluations360 = await db
    .select({ count: count() })
    .from(performanceEvaluations)
    .where(and(eq(performanceEvaluations.employeeId, employeeId), eq(performanceEvaluations.type, "360")));

  const eval360Count = evaluations360[0]?.count || 0;

  // Badge: AvaliaÃ§Ã£o 360Â° Completa (ID 5)
  if (eval360Count >= 1) {
    await checkAndAwardBadge(employeeId, 5);
  }

  // Verificar avaliaÃ§Ãµes de performance com nota alta
  const highPerformance = await db
    .select()
    .from(performanceEvaluations)
    .where(eq(performanceEvaluations.employeeId, employeeId))
    .orderBy(sql`${performanceEvaluations.finalScore} DESC`)
    .limit(1);

  if (highPerformance[0] && highPerformance[0].finalScore && highPerformance[0].finalScore >= 4.5) {
    // Badge: Estrela em AscensÃ£o (ID 8)
    await checkAndAwardBadge(employeeId, 8);
  }
}

// Verificar badges relacionados a feedbacks
export async function checkFeedbackBadges(employeeId: number) {
  const db = await getDb();
  if (!db) return;

  // Contar feedbacks recebidos
  const receivedFeedbacks = await db
    .select({ count: count() })
    .from(feedbacks)
    .where(eq(feedbacks.employeeId, employeeId));

  const receivedCount = receivedFeedbacks[0]?.count || 0;

  // Badge: Feedback Ativo (ID 6)
  if (receivedCount >= 5) {
    await checkAndAwardBadge(employeeId, 6);
  }

  // Contar feedbacks dados (como gestor)
  const givenFeedbacks = await db
    .select({ count: count() })
    .from(feedbacks)
    .where(eq(feedbacks.managerId, employeeId));

  const givenCount = givenFeedbacks[0]?.count || 0;

  // Badge: Mentor (ID 7)
  if (givenCount >= 10) {
    await checkAndAwardBadge(employeeId, 7);
  }
}

// Verificar badges relacionados a Nine Box
export async function checkNineBoxBadges(employeeId: number) {
  const db = await getDb();
  if (!db) return;

  // Verificar posiÃ§Ã£o no Nine Box
  const nineBoxPos = await db
    .select()
    .from(nineBoxPositions)
    .where(eq(nineBoxPositions.employeeId, employeeId))
    .orderBy(sql`${nineBoxPositions.createdAt} DESC`)
    .limit(1);

  if (nineBoxPos[0]) {
    const box = nineBoxPos[0].box;
    // Badge: Nine Box - Alto Potencial (ID 9)
    // Verificar se estÃ¡ em quadrantes de alto potencial
    if (box && (box.includes("alto_potencial") || box.includes("estrela") || box.includes("futuro_lider"))) {
      await checkAndAwardBadge(employeeId, 9);
    }
  }
}

// Verificar badges relacionados a testes psicomÃ©tricos
export async function checkPsychometricBadges(employeeId: number) {
  const db = await getDb();
  if (!db) return;

  // Contar testes psicomÃ©tricos completados (tipos Ãºnicos)
  const completedTests = await db
    .select({ count: sql<number>`COUNT(DISTINCT ${psychometricTests.testType})` })
    .from(psychometricTests)
    .where(eq(psychometricTests.employeeId, employeeId));

  const testCount = completedTests[0]?.count || 0;

  // Badge: Explorador do Conhecimento (ID 10)
  if (testCount >= 5) {
    await checkAndAwardBadge(employeeId, 10);
  }
}

// Verificar todos os badges de um colaborador
export async function checkAllBadges(employeeId: number) {
  await checkGoalBadges(employeeId);
  await checkPDIBadges(employeeId);
  await checkEvaluationBadges(employeeId);
  await checkFeedbackBadges(employeeId);
  await checkNineBoxBadges(employeeId);
  await checkPsychometricBadges(employeeId);
}


========================================
ARQUIVO: ./server/storage.ts
========================================
// Preconfigured storage helpers for Manus WebDev templates
// Uses the Biz-provided storage proxy (Authorization: Bearer <token>)

import { ENV } from './_core/env';

type StorageConfig = { baseUrl: string; apiKey: string };

function getStorageConfig(): StorageConfig {
  const baseUrl = ENV.forgeApiUrl;
  const apiKey = ENV.forgeApiKey;

  if (!baseUrl || !apiKey) {
    throw new Error(
      "Storage proxy credentials missing: set BUILT_IN_FORGE_API_URL and BUILT_IN_FORGE_API_KEY"
    );
  }

  return { baseUrl: baseUrl.replace(/\/+$/, ""), apiKey };
}

function buildUploadUrl(baseUrl: string, relKey: string): URL {
  const url = new URL("v1/storage/upload", ensureTrailingSlash(baseUrl));
  url.searchParams.set("path", normalizeKey(relKey));
  return url;
}

async function buildDownloadUrl(
  baseUrl: string,
  relKey: string,
  apiKey: string
): Promise<string> {
  const downloadApiUrl = new URL(
    "v1/storage/downloadUrl",
    ensureTrailingSlash(baseUrl)
  );
  downloadApiUrl.searchParams.set("path", normalizeKey(relKey));
  const response = await fetch(downloadApiUrl, {
    method: "GET",
    headers: buildAuthHeaders(apiKey),
  });
  return (await response.json()).url;
}

function ensureTrailingSlash(value: string): string {
  return value.endsWith("/") ? value : `${value}/`;
}

function normalizeKey(relKey: string): string {
  return relKey.replace(/^\/+/, "");
}

function toFormData(
  data: Buffer | Uint8Array | string,
  contentType: string,
  fileName: string
): FormData {
  const blob =
    typeof data === "string"
      ? new Blob([data], { type: contentType })
      : new Blob([data as any], { type: contentType });
  const form = new FormData();
  form.append("file", blob, fileName || "file");
  return form;
}

function buildAuthHeaders(apiKey: string): HeadersInit {
  return { Authorization: `Bearer ${apiKey}` };
}

export async function storagePut(
  relKey: string,
  data: Buffer | Uint8Array | string,
  contentType = "application/octet-stream"
): Promise<{ key: string; url: string }> {
  const { baseUrl, apiKey } = getStorageConfig();
  const key = normalizeKey(relKey);
  const uploadUrl = buildUploadUrl(baseUrl, key);
  const formData = toFormData(data, contentType, key.split("/").pop() ?? key);
  const response = await fetch(uploadUrl, {
    method: "POST",
    headers: buildAuthHeaders(apiKey),
    body: formData,
  });

  if (!response.ok) {
    const message = await response.text().catch(() => response.statusText);
    throw new Error(
      `Storage upload failed (${response.status} ${response.statusText}): ${message}`
    );
  }
  const url = (await response.json()).url;
  return { key, url };
}

export async function storageGet(relKey: string): Promise<{ key: string; url: string; }> {
  const { baseUrl, apiKey } = getStorageConfig();
  const key = normalizeKey(relKey);
  return {
    key,
    url: await buildDownloadUrl(baseUrl, key, apiKey),
  };
}


========================================
ARQUIVO: ./server/successionRouter.ts
========================================
import { z } from "zod";
import { desc, eq, and, sql } from "drizzle-orm";
import { getDb } from "./db";
import { 
  successionPlans, 
  successionCandidates,
  positions,
  employees,
  nineBoxPositions,
  pdiPlans
} from "../drizzle/schema";
import { protectedProcedure, router } from "./_core/trpc";

/**
 * Succession Router
 * Metodologia: 9-Box Succession Planning
 * 
 * Esta metodologia Ã© amplamente utilizada por empresas Fortune 500 e combina:
 * - AvaliaÃ§Ã£o de Performance (eixo Y)
 * - AvaliaÃ§Ã£o de Potencial (eixo X)
 * - IdentificaÃ§Ã£o de sucessores em posiÃ§Ãµes crÃ­ticas
 * - Planos de desenvolvimento estruturados
 * - GestÃ£o de riscos de saÃ­da
 */

export const successionRouter = router({
  // Listar todos os planos de sucessÃ£o
  list: protectedProcedure.query(async ({ ctx }) => {
    const database = await getDb();
    if (!database) return [];

    const plans = await database
      .select({
        id: successionPlans.id,
        positionId: successionPlans.positionId,
        positionTitle: positions.title,
        currentHolderId: successionPlans.currentHolderId,
        currentHolderName: employees.name,
        isCritical: successionPlans.isCritical,
        riskLevel: successionPlans.riskLevel,
        exitRisk: successionPlans.exitRisk,
        status: successionPlans.status,
        preparationTime: successionPlans.preparationTime,
        nextReviewDate: successionPlans.nextReviewDate,
        createdAt: successionPlans.createdAt,
      })
      .from(successionPlans)
      .leftJoin(positions, eq(successionPlans.positionId, positions.id))
      .leftJoin(employees, eq(successionPlans.currentHolderId, employees.id))
      .orderBy(desc(successionPlans.createdAt));

    // Buscar sucessores para cada plano
    const plansWithSuccessors = await Promise.all(
      plans.map(async (plan) => {
        const candidates = await database
          .select({
            id: successionCandidates.id,
            employeeId: successionCandidates.employeeId,
            employeeName: employees.name,
            readinessLevel: successionCandidates.readinessLevel,
            priority: successionCandidates.priority,
          })
          .from(successionCandidates)
          .leftJoin(employees, eq(successionCandidates.employeeId, employees.id))
          .where(eq(successionCandidates.planId, plan.id))
          .orderBy(successionCandidates.priority);

        return {
          ...plan,
          successors: candidates,
        };
      })
    );

    return plansWithSuccessors;
  }),

  // Buscar plano por ID com detalhes completos
  getById: protectedProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ input }) => {
      const database = await getDb();
      if (!database) return null;

      const [plan] = await database
        .select()
        .from(successionPlans)
        .where(eq(successionPlans.id, input.id))
        .limit(1);

      if (!plan) return null;

      // Buscar posiÃ§Ã£o
      const [position] = await database
        .select()
        .from(positions)
        .where(eq(positions.id, plan.positionId))
        .limit(1);

      // Buscar titular atual
      let currentHolder = null;
      if (plan.currentHolderId) {
        [currentHolder] = await database
          .select()
          .from(employees)
          .where(eq(employees.id, plan.currentHolderId))
          .limit(1);
      }

      // Buscar sucessores
      const candidates = await database
        .select({
          id: successionCandidates.id,
          employeeId: successionCandidates.employeeId,
          employeeName: employees.name,
          employeeEmail: employees.email,
          readinessLevel: successionCandidates.readinessLevel,
          priority: successionCandidates.priority,
          developmentPlanId: successionCandidates.developmentPlanId,
          notes: successionCandidates.notes,
          createdAt: successionCandidates.createdAt,
        })
        .from(successionCandidates)
        .leftJoin(employees, eq(successionCandidates.employeeId, employees.id))
        .where(eq(successionCandidates.planId, input.id))
        .orderBy(successionCandidates.priority);

      // Buscar Nine Box dos sucessores
      const candidatesWithNineBox = await Promise.all(
        candidates.map(async (candidate) => {
          const [nineBox] = await database
            .select()
            .from(nineBoxPositions)
            .where(eq(nineBoxPositions.employeeId, candidate.employeeId))
            .orderBy(desc(nineBoxPositions.createdAt))
            .limit(1);

          return {
            ...candidate,
            nineBox: nineBox || null,
          };
        })
      );

      return {
        ...plan,
        position,
        currentHolder,
        successors: candidatesWithNineBox,
      };
    }),

  // Criar novo plano de sucessÃ£o
  create: protectedProcedure
    .input(
      z.object({
        positionId: z.number(),
        currentHolderId: z.number().optional(),
        isCritical: z.boolean().default(false),
        riskLevel: z.enum(["baixo", "medio", "alto", "critico"]).default("medio"),
        exitRisk: z.enum(["baixo", "medio", "alto"]).default("medio"),
        competencyGap: z.string().optional(),
        preparationTime: z.number().optional(),
        notes: z.string().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      const [result] = await database.insert(successionPlans).values({
        ...input,
        status: "ativo",
      });

      return { id: result.insertId, success: true };
    }),

  // Atualizar plano de sucessÃ£o
  update: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        isCritical: z.boolean().optional(),
        riskLevel: z.enum(["baixo", "medio", "alto", "critico"]).optional(),
        exitRisk: z.enum(["baixo", "medio", "alto"]).optional(),
        competencyGap: z.string().optional(),
        preparationTime: z.number().optional(),
        trackingPlan: z.string().optional(),
        nextReviewDate: z.date().optional(),
        notes: z.string().optional(),
        status: z.enum(["ativo", "inativo"]).optional(),
      })
    )
    .mutation(async ({ input }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      const { id, ...data } = input;

      await database
        .update(successionPlans)
        .set(data)
        .where(eq(successionPlans.id, id));

      return { success: true };
    }),

  // Adicionar sucessor ao plano (FORMULÃRIO COMPLETO)
  addSuccessor: protectedProcedure
    .input(
      z.object({
        planId: z.number(),
        employeeId: z.number(),
        readinessLevel: z.enum(["imediato", "1_ano", "2_3_anos", "mais_3_anos"]),
        priority: z.number().default(1),
        // Novos campos de avaliaÃ§Ã£o
        performanceRating: z.enum(["baixo", "medio", "alto", "excepcional"]).optional(),
        potentialRating: z.enum(["baixo", "medio", "alto", "excepcional"]).optional(),
        nineBoxPosition: z.string().optional(),
        // AnÃ¡lise e desenvolvimento
        gapAnalysis: z.string().optional(),
        developmentActions: z.string().optional(),
        developmentPlanId: z.number().optional(),
        notes: z.string().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      const [result] = await database.insert(successionCandidates).values(input);

      return { id: result.insertId, success: true };
    }),

  // Remover sucessor do plano
  removeSuccessor: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      await database
        .delete(successionCandidates)
        .where(eq(successionCandidates.id, input.id));

      return { success: true };
    }),

  // Atualizar sucessor
  updateSuccessor: protectedProcedure
    .input(
      z.object({
        id: z.number(),
        readinessLevel: z.enum(["imediato", "1_ano", "2_3_anos", "mais_3_anos"]).optional(),
        priority: z.number().optional(),
        // Novos campos de avaliaÃ§Ã£o
        performanceRating: z.enum(["baixo", "medio", "alto", "excepcional"]).optional(),
        potentialRating: z.enum(["baixo", "medio", "alto", "excepcional"]).optional(),
        nineBoxPosition: z.string().optional(),
        // AnÃ¡lise e desenvolvimento
        gapAnalysis: z.string().optional(),
        developmentActions: z.string().optional(),
        developmentPlanId: z.number().optional(),
        notes: z.string().optional(),
      })
    )
    .mutation(async ({ input }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      const { id, ...data } = input;

      await database
        .update(successionCandidates)
        .set(data)
        .where(eq(successionCandidates.id, id));

      return { success: true };
    }),

  // Sugerir sucessores automaticamente baseado em Nine Box (Alto Potencial)
  suggestSuccessors: protectedProcedure
    .input(z.object({ positionId: z.number() }))
    .query(async ({ input }) => {
      const database = await getDb();
      if (!database) return [];

      // Buscar colaboradores com alto potencial (potencial >= 2) no Nine Box
      const suggestions = await database
        .select({
          employeeId: employees.id,
          employeeName: employees.name,
          employeeEmail: employees.email,
          positionTitle: positions.title,
          performance: nineBoxPositions.performance,
          potential: nineBoxPositions.potential,
        })
        .from(nineBoxPositions)
        .innerJoin(employees, eq(nineBoxPositions.employeeId, employees.id))
        .leftJoin(positions, eq(employees.positionId, positions.id))
        .where(sql`${nineBoxPositions.potential} >= 2`)
        .orderBy(desc(nineBoxPositions.potential), desc(nineBoxPositions.performance))
        .limit(10);

      return suggestions;
    }),

  // Deletar plano de sucessÃ£o
  delete: protectedProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      // Deletar sucessores primeiro
      await database
        .delete(successionCandidates)
        .where(eq(successionCandidates.planId, input.id));

      // Deletar plano
      await database
        .delete(successionPlans)
        .where(eq(successionPlans.id, input.id));

      return { success: true };
    }),

  // Importar dados de sucessÃ£o UISA
  importSuccessionData: protectedProcedure
    .input(
      z.object({
        plans: z.array(
          z.object({
            positionTitle: z.string(),
            positionCode: z.string(),
            currentHolderName: z.string().optional(),
            isCritical: z.boolean(),
            riskLevel: z.enum(["baixo", "medio", "alto", "critico"]),
            exitRisk: z.enum(["baixo", "medio", "alto"]).optional(),
            competencyGap: z.string().optional(),
            preparationTime: z.number().optional(),
            notes: z.string().optional(),
            successors: z.array(
              z.object({
                employeeName: z.string(),
                employeeCode: z.string(),
                readinessLevel: z.enum(["imediato", "1_ano", "2_3_anos", "mais_3_anos"]),
                priority: z.number(),
              })
            ),
          })
        ),
      })
    )
    .mutation(async ({ input }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      const results = {
        success: 0,
        errors: [] as string[],
      };

      for (const planData of input.plans) {
        try {
          // 1. Buscar ou criar posiÃ§Ã£o
          let position = await database
            .select()
            .from(positions)
            .where(eq(positions.code, planData.positionCode))
            .limit(1);

          if (position.length === 0) {
            // Criar posiÃ§Ã£o se nÃ£o existir
            const [newPosition] = await database.insert(positions).values({
              code: planData.positionCode,
              title: planData.positionTitle,
              active: true,
            });
            position = await database
              .select()
              .from(positions)
              .where(eq(positions.id, newPosition.insertId))
              .limit(1);
          }

          const positionId = position[0].id;

          // 2. Buscar ocupante atual (se fornecido)
          let currentHolderId: number | null = null;
          if (planData.currentHolderName) {
            const holder = await database
              .select()
              .from(employees)
              .where(eq(employees.name, planData.currentHolderName))
              .limit(1);
            if (holder.length > 0) {
              currentHolderId = holder[0].id;
            }
          }

          // 3. Criar plano de sucessÃ£o
          const [newPlan] = await database.insert(successionPlans).values({
            positionId,
            currentHolderId,
            isCritical: planData.isCritical,
            riskLevel: planData.riskLevel,
            exitRisk: planData.exitRisk || "medio",
            competencyGap: planData.competencyGap,
            preparationTime: planData.preparationTime,
            notes: planData.notes,
            status: "ativo",
          });

          const planId = newPlan.insertId;

          // 4. Adicionar sucessores
          for (const successorData of planData.successors) {
            // Buscar ou criar colaborador
            let employee = await database
              .select()
              .from(employees)
              .where(eq(employees.employeeCode, successorData.employeeCode))
              .limit(1);

            if (employee.length === 0) {
              // Criar colaborador se nÃ£o existir (com dados mÃ­nimos)
              const [newEmployee] = await database.insert(employees).values({
                employeeCode: successorData.employeeCode,
                name: successorData.employeeName,
                email: `${successorData.employeeCode}@uisa.com.br`,
                hireDate: new Date(),
                departmentId: 1, // Departamento padrÃ£o
                positionId: positionId,
                status: "ativo",
              });
              employee = await database
                .select()
                .from(employees)
                .where(eq(employees.id, newEmployee.insertId))
                .limit(1);
            }

            const employeeId = employee[0].id;

            // Adicionar sucessor ao plano
            await database.insert(successionCandidates).values({
              planId,
              employeeId,
              readinessLevel: successorData.readinessLevel,
              priority: successorData.priority,
            });
          }

          results.success++;
        } catch (error: any) {
          results.errors.push(
            `Erro ao importar plano "${planData.positionTitle}": ${error.message}`
          );
        }
      }

      return results;
    }),

  // Importar planos UISA no formato simplificado
  importUIPlans: protectedProcedure
    .input(
      z.array(
        z.object({
          positionName: z.string(),
          department: z.string(),
          currentOccupant: z.string().optional(),
          riskLevel: z.enum(["baixo", "mÃ©dio", "alto", "crÃ­tico"]),
          priority: z.enum(["baixa", "mÃ©dia", "alta", "crÃ­tica"]),
          notes: z.string().optional(),
          successors: z.array(
            z.object({
              name: z.string(),
              readinessLevel: z.enum(["ready_now", "1-2_years", "2-3_years", "3+_years"]),
              developmentPlan: z.string().optional(),
            })
          ),
        })
      )
    )
    .mutation(async ({ input }) => {
      const database = await getDb();
      if (!database) throw new Error("Database not available");

      const results = {
        success: 0,
        errors: [] as string[],
      };

      // Mapear readinessLevel
      const mapReadiness = (level: string) => {
        const map: Record<string, string> = {
          ready_now: "imediato",
          "1-2_years": "1_ano",
          "2-3_years": "2_3_anos",
          "3+_years": "mais_3_anos",
        };
        return map[level] || "1_ano";
      };

      // Mapear riskLevel (remover acentos)
      const mapRiskLevel = (level: string) => {
        const map: Record<string, string> = {
          "baixo": "baixo",
          "mÃ©dio": "medio",
          "alto": "alto",
          "crÃ­tico": "critico",
        };
        return map[level] || "medio";
      };

      for (const planData of input) {
        try {
          // 1. Buscar ou criar posiÃ§Ã£o
          let position = await database
            .select()
            .from(positions)
            .where(eq(positions.title, planData.positionName))
            .limit(1);

          if (position.length === 0) {
            const code = planData.positionName.toUpperCase().replace(/\s+/g, "-");
            const [newPosition] = await database.insert(positions).values({
              code,
              title: planData.positionName,
              departmentId: null,
              active: true,
            });
            position = await database
              .select()
              .from(positions)
              .where(eq(positions.id, newPosition.insertId))
              .limit(1);
          }

          const positionId = position[0].id;

          // 2. Buscar ocupante atual
          let currentHolderId: number | null = null;
          if (planData.currentOccupant) {
            const holder = await database
              .select()
              .from(employees)
              .where(eq(employees.name, planData.currentOccupant))
              .limit(1);
            if (holder.length > 0) {
              currentHolderId = holder[0].id;
            }
          }

          // 3. Criar plano de sucessÃ£o
          const [newPlan] = await database.insert(successionPlans).values({
            positionId,
            currentHolderId,
            isCritical: planData.priority === "crÃ­tica",
            riskLevel: mapRiskLevel(planData.riskLevel) as any,
            exitRisk: "medio",
            notes: planData.notes,
            status: "ativo",
          });

          const planId = newPlan.insertId;

          // 4. Adicionar sucessores
          for (let i = 0; i < planData.successors.length; i++) {
            const successorData = planData.successors[i];
            
            // Buscar ou criar colaborador
            let employee = await database
              .select()
              .from(employees)
              .where(eq(employees.name, successorData.name))
              .limit(1);

            if (employee.length === 0) {
              const empCode = `EMP-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
              const [newEmployee] = await database.insert(employees).values({
                employeeCode: empCode,
                name: successorData.name,
                email: `${empCode.toLowerCase()}@uisa.com.br`,
                hireDate: new Date(),
                departmentId: 1, // Departamento padrÃ£o
                positionId: 1, // PosiÃ§Ã£o padrÃ£o
                status: "ativo",
              });
              employee = await database
                .select()
                .from(employees)
                .where(eq(employees.id, newEmployee.insertId))
                .limit(1);
            }

            const employeeId = employee[0].id;

            // Adicionar candidato
            await database.insert(successionCandidates).values({
              planId,
              employeeId,
              readinessLevel: mapReadiness(successorData.readinessLevel) as any,
              priority: i + 1,
            });
          }

          results.success++;
        } catch (error: any) {
          results.errors.push(`${planData.positionName}: ${error.message}`);
        }
      }

      return results;
    }),
});


========================================
ARQUIVO: ./server/utils/badgeHelper.ts
========================================
import { getDb } from "../db";
import { badges, employeeBadges, employees, notifications } from "../../drizzle/schema";
import { eq, and } from "drizzle-orm";
import { emailService } from "./emailService";

/**
 * Helper centralizado para conceder badges
 * Verifica se o colaborador jÃ¡ possui o badge, concede se nÃ£o tiver,
 * cria notificaÃ§Ã£o in-app e envia e-mail
 */
export async function grantBadgeIfEligible(employeeId: number, badgeCode: string): Promise<boolean> {
  const db = await getDb();
  if (!db) {
    console.warn("[BadgeHelper] Database not available");
    return false;
  }

  try {
    // Buscar badge pelo cÃ³digo
    const badgeResult = await db
      .select()
      .from(badges)
      .where(and(eq(badges.code, badgeCode), eq(badges.isActive, true)))
      .limit(1);

    if (badgeResult.length === 0) {
      console.warn(`[BadgeHelper] Badge com cÃ³digo "${badgeCode}" nÃ£o encontrado ou inativo`);
      return false;
    }

    const badge = badgeResult[0];

    // Verificar se colaborador jÃ¡ possui este badge
    const existingBadge = await db
      .select()
      .from(employeeBadges)
      .where(and(eq(employeeBadges.employeeId, employeeId), eq(employeeBadges.badgeId, badge.id)))
      .limit(1);

    if (existingBadge.length > 0) {
      console.log(`[BadgeHelper] Colaborador ${employeeId} jÃ¡ possui o badge "${badge.name}"`);
      return false; // JÃ¡ possui o badge
    }

    // Buscar informaÃ§Ãµes do colaborador
    const employeeResult = await db
      .select()
      .from(employees)
      .where(eq(employees.id, employeeId))
      .limit(1);

    if (employeeResult.length === 0) {
      console.warn(`[BadgeHelper] Colaborador ${employeeId} nÃ£o encontrado`);
      return false;
    }

    const employee = employeeResult[0];

    // Conceder badge
    const [newBadge] = await db.insert(employeeBadges).values({
      employeeId,
      badgeId: badge.id,
      earnedAt: new Date(),
      notified: false,
    });

    console.log(`[BadgeHelper] âœ… Badge "${badge.name}" concedido ao colaborador ${employee.name}`);

    // Criar notificaÃ§Ã£o in-app
    await db.insert(notifications).values({
      userId: employee.userId || 0,
      type: "badge_earned",
      title: `ðŸ† Novo Badge Conquistado!`,
      message: `ParabÃ©ns! VocÃª conquistou o badge "${badge.name}": ${badge.description}`,
      read: false,
    });

    console.log(`[BadgeHelper] ðŸ“¬ NotificaÃ§Ã£o in-app criada para ${employee.name}`);

    // Enviar e-mail se colaborador tiver e-mail
    if (employee.email) {
      const emailSent = await emailService.sendBadgeNotification(employee.email, {
        employeeName: employee.name,
        badgeName: badge.name,
        badgeDescription: badge.description || "Conquista desbloqueada!",
        badgeIcon: badge.icon || "ðŸ†",
      });

      if (emailSent) {
        console.log(`[BadgeHelper] ðŸ“§ E-mail de badge enviado para ${employee.email}`);
        
        // Marcar como notificado
        await db
          .update(employeeBadges)
          .set({ notified: true })
          .where(eq(employeeBadges.id, newBadge.insertId));
      }
    }

    return true;
  } catch (error) {
    console.error("[BadgeHelper] Erro ao conceder badge:", error);
    return false;
  }
}

/**
 * Verificar e conceder mÃºltiplos badges de uma vez
 */
export async function checkAndGrantBadges(employeeId: number, badgeCodes: string[]): Promise<number> {
  let grantedCount = 0;

  for (const code of badgeCodes) {
    const granted = await grantBadgeIfEligible(employeeId, code);
    if (granted) grantedCount++;
  }

  return grantedCount;
}


========================================
ARQUIVO: ./server/utils/bonusApprovalPDF.ts
========================================
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";

/**
 * Gerar PDF de AprovaÃ§Ã£o de BÃ´nus para Assinatura
 * Documento oficial para assinatura do Diretor de Gente e envio ao Financeiro
 */

interface BonusApprovalData {
  approvalId: number;
  cycleName: string;
  employeeName: string;
  employeeId: number;
  positionName: string;
  departmentName: string;
  eligibleAmount: number;
  extraBonusPercentage: number;
  finalAmount: number;
  approvalHistory: Array<{
    level: number;
    approverName: string;
    approverRole: string;
    status: string;
    approvedAt: string;
    comments?: string;
  }>;
  generatedAt: string;
}

export async function generateBonusApprovalPDF(data: BonusApprovalData): Promise<Buffer> {
  const doc = new jsPDF() as any;

  // ConfiguraÃ§Ãµes
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 20;
  let yPos = margin;

  // ==================== CABEÃ‡ALHO ====================
  doc.setFontSize(20);
  doc.setFont("helvetica", "bold");
  doc.text("AUTORIZAÃ‡ÃƒO DE PAGAMENTO DE BÃ”NUS", pageWidth / 2, yPos, { align: "center" });
  yPos += 10;

  doc.setFontSize(12);
  doc.setFont("helvetica", "normal");
  doc.text(`Documento NÂº ${String(data.approvalId).padStart(6, "0")}`, pageWidth / 2, yPos, {
    align: "center",
  });
  yPos += 15;

  // ==================== DADOS DO COLABORADOR ====================
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("DADOS DO COLABORADOR", margin, yPos);
  yPos += 8;

  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");

  const collaboratorData = [
    ["Nome:", data.employeeName],
    ["MatrÃ­cula:", String(data.employeeId)],
    ["Cargo:", data.positionName],
    ["Departamento:", data.departmentName],
    ["Ciclo de AvaliaÃ§Ã£o:", data.cycleName],
  ];

  collaboratorData.forEach(([label, value]) => {
    doc.setFont("helvetica", "bold");
    doc.text(label, margin, yPos);
    doc.setFont("helvetica", "normal");
    doc.text(value, margin + 50, yPos);
    yPos += 7;
  });

  yPos += 5;

  // ==================== CÃLCULO DO BÃ”NUS ====================
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("CÃLCULO DO BÃ”NUS", margin, yPos);
  yPos += 10;

  autoTable(doc, {
    startY: yPos,
    head: [["DescriÃ§Ã£o", "Valor"]],
    body: [
      ["BÃ´nus ElegÃ­vel (baseado em metas)", `R$ ${data.eligibleAmount.toFixed(2)}`],
      [
        `BÃ´nus Extra (${data.extraBonusPercentage.toFixed(1)}%)`,
        `R$ ${(data.eligibleAmount * (data.extraBonusPercentage / 100)).toFixed(2)}`,
      ],
      ["", ""],
      [
        {
          content: "VALOR TOTAL A PAGAR",
          styles: { fontStyle: "bold", fontSize: 12 },
        },
        {
          content: `R$ ${data.finalAmount.toFixed(2)}`,
          styles: { fontStyle: "bold", fontSize: 12, fillColor: [243, 146, 0] },
        },
      ],
    ],
    theme: "grid",
    headStyles: { fillColor: [52, 73, 94], textColor: 255 },
    columnStyles: {
      0: { cellWidth: 120 },
      1: { cellWidth: 50, halign: "right" },
    },
  });

  yPos = (doc as any).lastAutoTable.finalY + 15;

  // ==================== HISTÃ“RICO DE APROVAÃ‡Ã•ES ====================
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("HISTÃ“RICO DE APROVAÃ‡Ã•ES", margin, yPos);
  yPos += 10;

  const approvalRows = data.approvalHistory.map((approval) => [
    `NÃ­vel ${approval.level}`,
    approval.approverName,
    approval.approverRole,
    approval.status === "approved" ? "Aprovado" : "Rejeitado",
    approval.approvedAt,
    approval.comments || "-",
  ]);

  autoTable(doc, {
    startY: yPos,
    head: [["NÃ­vel", "Aprovador", "FunÃ§Ã£o", "Status", "Data", "ComentÃ¡rios"]],
    body: approvalRows,
    theme: "grid",
    headStyles: { fillColor: [52, 73, 94], textColor: 255 },
    styles: { fontSize: 9 },
    columnStyles: {
      0: { cellWidth: 20 },
      1: { cellWidth: 40 },
      2: { cellWidth: 35 },
      3: { cellWidth: 25 },
      4: { cellWidth: 30 },
      5: { cellWidth: 40 },
    },
  });

  yPos = (doc as any).lastAutoTable.finalY + 20;

  // ==================== SEÃ‡ÃƒO DE ASSINATURAS ====================
  // Verificar se precisa de nova pÃ¡gina
  if (yPos > 220) {
    doc.addPage();
    yPos = margin;
  }

  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("ASSINATURAS", margin, yPos);
  yPos += 15;

  // Diretor de Gente
  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  doc.text("_".repeat(60), margin, yPos);
  yPos += 7;
  doc.setFont("helvetica", "bold");
  doc.text("Diretor de Gente", margin, yPos);
  yPos += 5;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  doc.text("AutorizaÃ§Ã£o Final", margin, yPos);
  yPos += 20;

  // Departamento Financeiro
  doc.setFontSize(11);
  doc.text("_".repeat(60), margin, yPos);
  yPos += 7;
  doc.setFont("helvetica", "bold");
  doc.text("Departamento Financeiro", margin, yPos);
  yPos += 5;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  doc.text("Recebido e Processado", margin, yPos);
  yPos += 20;

  // ==================== RODAPÃ‰ ====================
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.text(
    `Documento gerado automaticamente em ${data.generatedAt}`,
    pageWidth / 2,
    yPos + 10,
    { align: "center" }
  );
  doc.text(
    "Este documento possui validade jurÃ­dica e deve ser arquivado conforme legislaÃ§Ã£o vigente.",
    pageWidth / 2,
    yPos + 15,
    { align: "center" }
  );

  // ==================== MARCA D'ÃGUA ====================
  doc.setFontSize(60);
  doc.setTextColor(200, 200, 200);
  doc.setFont("helvetica", "bold");
  doc.text("CONFIDENCIAL", pageWidth / 2, 150, {
    align: "center",
    angle: 45,
  });

  return Buffer.from(doc.output("arraybuffer"));
}

/**
 * Gerar PDF consolidado de bÃ´nus por ciclo
 */
export async function generateConsolidatedBonusPDF(
  cycleName: string,
  approvals: Array<{
    employeeName: string;
    departmentName: string;
    eligibleAmount: number;
    finalAmount: number;
    status: string;
  }>
): Promise<Buffer> {
  const doc = new jsPDF() as any;

  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 20;
  let yPos = margin;

  // CabeÃ§alho
  doc.setFontSize(18);
  doc.setFont("helvetica", "bold");
  doc.text("RELATÃ“RIO CONSOLIDADO DE BÃ”NUS", pageWidth / 2, yPos, { align: "center" });
  yPos += 10;

  doc.setFontSize(12);
  doc.setFont("helvetica", "normal");
  doc.text(`Ciclo: ${cycleName}`, pageWidth / 2, yPos, { align: "center" });
  yPos += 15;

  // EstatÃ­sticas
  const totalEligible = approvals.reduce((sum, a) => sum + a.eligibleAmount, 0);
  const totalFinal = approvals.reduce((sum, a) => sum + a.finalAmount, 0);
  const approved = approvals.filter((a) => a.status === "approved").length;

  doc.setFontSize(11);
  doc.text(`Total de Colaboradores: ${approvals.length}`, margin, yPos);
  yPos += 7;
  doc.text(`Aprovados: ${approved}`, margin, yPos);
  yPos += 7;
  doc.text(`BÃ´nus ElegÃ­vel Total: R$ ${totalEligible.toFixed(2)}`, margin, yPos);
  yPos += 7;
  doc.text(`BÃ´nus Final Total: R$ ${totalFinal.toFixed(2)}`, margin, yPos);
  yPos += 15;

  // Tabela de aprovaÃ§Ãµes
  const rows = approvals.map((approval) => [
    approval.employeeName,
    approval.departmentName,
    `R$ ${approval.eligibleAmount.toFixed(2)}`,
    `R$ ${approval.finalAmount.toFixed(2)}`,
    approval.status === "approved" ? "Aprovado" : approval.status === "pending" ? "Pendente" : "Rejeitado",
  ]);

  autoTable(doc, {
    startY: yPos,
    head: [["Colaborador", "Departamento", "ElegÃ­vel", "Final", "Status"]],
    body: rows,
    theme: "grid",
    headStyles: { fillColor: [52, 73, 94], textColor: 255 },
    styles: { fontSize: 9 },
    columnStyles: {
      0: { cellWidth: 60 },
      1: { cellWidth: 50 },
      2: { cellWidth: 30, halign: "right" },
      3: { cellWidth: 30, halign: "right" },
      4: { cellWidth: 25 },
    },
  });

  yPos = (doc as any).lastAutoTable.finalY + 15;

  // RodapÃ©
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  const now = new Date().toLocaleString("pt-BR");
  doc.text(`Gerado em ${now}`, pageWidth / 2, yPos, { align: "center" });

  return Buffer.from(doc.output("arraybuffer"));
}


========================================
ARQUIVO: ./server/utils/bonusEmailNotifications.ts
========================================
import nodemailer from "nodemailer";
import { getDb } from "../db";
import { systemSettings } from "../../drizzle/schema";
import { eq } from "drizzle-orm";

// FunÃ§Ã£o auxiliar para enviar email
async function sendEmail(options: { to: string; subject: string; html: string }) {
  const db = await getDb();
  if (!db) {
    console.warn("[BonusEmail] Database nÃ£o disponÃ­vel");
    return;
  }

  try {
    const settings = await db
      .select()
      .from(systemSettings)
      .where(eq(systemSettings.settingKey, "smtp_config"))
      .limit(1);

    if (settings.length === 0) {
      console.warn("[BonusEmail] ConfiguraÃ§Ãµes SMTP nÃ£o encontradas");
      return;
    }

    const config = JSON.parse(settings[0].settingValue || "{}");

    const transporter = nodemailer.createTransport({
      host: config.host,
      port: config.port,
      secure: config.secure,
      auth: {
        user: config.user,
        pass: config.pass,
      },
    });

    await transporter.sendMail({
      from: `"${config.fromName}" <${config.fromEmail}>`,
      to: options.to,
      subject: options.subject,
      html: options.html,
    });

    console.log(`[BonusEmail] Email enviado para ${options.to}`);
  } catch (error) {
    console.error("[BonusEmail] Erro ao enviar email:", error);
  }
}

/**
 * Sistema de NotificaÃ§Ãµes por Email para Workflow de BÃ´nus
 * Envia emails automÃ¡ticos em cada etapa do processo de aprovaÃ§Ã£o
 */

interface BonusNotificationData {
  employeeName: string;
  employeeEmail: string;
  approverName: string;
  approverEmail: string;
  cycleName: string;
  bonusAmount: number;
  approvalLevel: number;
  comments?: string;
}

/**
 * Enviar email quando bÃ´nus Ã© submetido para aprovaÃ§Ã£o
 */
export async function sendBonusSubmittedEmail(data: BonusNotificationData): Promise<void> {
  const subject = `ðŸŽ¯ Novo BÃ´nus Submetido para AprovaÃ§Ã£o - ${data.cycleName}`;

  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #F39200; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background-color: #f9f9f9; padding: 30px; border: 1px solid #ddd; border-radius: 0 0 8px 8px; }
        .info-box { background-color: white; padding: 15px; margin: 15px 0; border-left: 4px solid #F39200; }
        .button { display: inline-block; background-color: #F39200; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin-top: 20px; }
        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>ðŸ’° BÃ´nus Aguardando AprovaÃ§Ã£o</h1>
        </div>
        <div class="content">
          <p>OlÃ¡, <strong>${data.approverName}</strong>!</p>
          
          <p>Um novo bÃ´nus foi submetido para sua aprovaÃ§Ã£o no sistema AVD UISA.</p>
          
          <div class="info-box">
            <h3>ðŸ“‹ Detalhes do BÃ´nus</h3>
            <p><strong>Colaborador:</strong> ${data.employeeName}</p>
            <p><strong>Ciclo:</strong> ${data.cycleName}</p>
            <p><strong>Valor do BÃ´nus:</strong> R$ ${data.bonusAmount.toFixed(2)}</p>
            <p><strong>NÃ­vel de AprovaÃ§Ã£o:</strong> ${data.approvalLevel}</p>
          </div>
          
          <p>Por favor, acesse o sistema para revisar e aprovar ou rejeitar este bÃ´nus.</p>
          
          <div style="text-align: center;">
            <a href="${process.env.VITE_APP_URL || 'https://avd-uisa.manus.space'}/rh/dashboard-bonus" class="button">
              Acessar Sistema
            </a>
          </div>
        </div>
        <div class="footer">
          <p>Este Ã© um email automÃ¡tico do Sistema AVD UISA. Por favor, nÃ£o responda.</p>
          <p>Â© 2025 UISA - Todos os direitos reservados</p>
        </div>
      </div>
    </body>
    </html>
  `;

  await sendEmail({
    to: data.approverEmail,
    subject,
    html: htmlContent,
  });
}

/**
 * Enviar email quando bÃ´nus Ã© aprovado em um nÃ­vel
 */
export async function sendBonusApprovedEmail(data: BonusNotificationData): Promise<void> {
  const subject = `âœ… BÃ´nus Aprovado - NÃ­vel ${data.approvalLevel} - ${data.cycleName}`;

  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #10B981; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background-color: #f9f9f9; padding: 30px; border: 1px solid #ddd; border-radius: 0 0 8px 8px; }
        .info-box { background-color: white; padding: 15px; margin: 15px 0; border-left: 4px solid #10B981; }
        .success-badge { background-color: #10B981; color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; }
        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>âœ… BÃ´nus Aprovado!</h1>
        </div>
        <div class="content">
          <p>OlÃ¡, <strong>${data.employeeName}</strong>!</p>
          
          <p>Temos uma Ã³tima notÃ­cia! Seu bÃ´nus foi aprovado no <strong>NÃ­vel ${data.approvalLevel}</strong>.</p>
          
          <div class="info-box">
            <h3>ðŸ“‹ Detalhes da AprovaÃ§Ã£o</h3>
            <p><strong>Aprovador:</strong> ${data.approverName}</p>
            <p><strong>Ciclo:</strong> ${data.cycleName}</p>
            <p><strong>Valor do BÃ´nus:</strong> R$ ${data.bonusAmount.toFixed(2)}</p>
            <p><strong>Status:</strong> <span class="success-badge">Aprovado - NÃ­vel ${data.approvalLevel}</span></p>
            ${data.comments ? `<p><strong>ComentÃ¡rios:</strong> ${data.comments}</p>` : ''}
          </div>
          
          <p>Seu bÃ´nus estÃ¡ avanÃ§ando no processo de aprovaÃ§Ã£o. VocÃª serÃ¡ notificado sobre os prÃ³ximos passos.</p>
        </div>
        <div class="footer">
          <p>Este Ã© um email automÃ¡tico do Sistema AVD UISA. Por favor, nÃ£o responda.</p>
          <p>Â© 2025 UISA - Todos os direitos reservados</p>
        </div>
      </div>
    </body>
    </html>
  `;

  await sendEmail({
    to: data.employeeEmail,
    subject,
    html: htmlContent,
  });
}

/**
 * Enviar email quando bÃ´nus Ã© rejeitado
 */
export async function sendBonusRejectedEmail(data: BonusNotificationData): Promise<void> {
  const subject = `âŒ BÃ´nus NÃ£o Aprovado - ${data.cycleName}`;

  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #EF4444; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background-color: #f9f9f9; padding: 30px; border: 1px solid #ddd; border-radius: 0 0 8px 8px; }
        .info-box { background-color: white; padding: 15px; margin: 15px 0; border-left: 4px solid #EF4444; }
        .warning-badge { background-color: #EF4444; color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; }
        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>âŒ BÃ´nus NÃ£o Aprovado</h1>
        </div>
        <div class="content">
          <p>OlÃ¡, <strong>${data.employeeName}</strong>,</p>
          
          <p>Informamos que seu bÃ´nus nÃ£o foi aprovado no <strong>NÃ­vel ${data.approvalLevel}</strong>.</p>
          
          <div class="info-box">
            <h3>ðŸ“‹ Detalhes</h3>
            <p><strong>ResponsÃ¡vel pela DecisÃ£o:</strong> ${data.approverName}</p>
            <p><strong>Ciclo:</strong> ${data.cycleName}</p>
            <p><strong>Valor:</strong> R$ ${data.bonusAmount.toFixed(2)}</p>
            <p><strong>Status:</strong> <span class="warning-badge">NÃ£o Aprovado</span></p>
            ${data.comments ? `<p><strong>Motivo:</strong> ${data.comments}</p>` : ''}
          </div>
          
          <p>Para mais informaÃ§Ãµes, entre em contato com o departamento de Recursos Humanos.</p>
        </div>
        <div class="footer">
          <p>Este Ã© um email automÃ¡tico do Sistema AVD UISA. Por favor, nÃ£o responda.</p>
          <p>Â© 2025 UISA - Todos os direitos reservados</p>
        </div>
      </div>
    </body>
    </html>
  `;

  await sendEmail({
    to: data.employeeEmail,
    subject,
    html: htmlContent,
  });
}

/**
 * Enviar email quando bÃ´nus Ã© totalmente aprovado (todos os nÃ­veis)
 */
export async function sendBonusFinallyApprovedEmail(data: BonusNotificationData): Promise<void> {
  const subject = `ðŸŽ‰ BÃ´nus Totalmente Aprovado - ${data.cycleName}`;

  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #F39200; color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background-color: #f9f9f9; padding: 30px; border: 1px solid #ddd; border-radius: 0 0 8px 8px; }
        .info-box { background-color: white; padding: 20px; margin: 20px 0; border-left: 4px solid #F39200; }
        .highlight { background-color: #FEF3C7; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; }
        .amount { font-size: 32px; font-weight: bold; color: #F39200; }
        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>ðŸŽ‰ ParabÃ©ns!</h1>
          <p style="font-size: 18px; margin-top: 10px;">Seu BÃ´nus Foi Totalmente Aprovado</p>
        </div>
        <div class="content">
          <p>OlÃ¡, <strong>${data.employeeName}</strong>!</p>
          
          <p>Ã‰ com grande satisfaÃ§Ã£o que informamos que seu bÃ´nus passou por todas as etapas de aprovaÃ§Ã£o e foi <strong>totalmente aprovado</strong>!</p>
          
          <div class="highlight">
            <p style="margin: 0; font-size: 14px; color: #666;">Valor Aprovado</p>
            <p class="amount">R$ ${data.bonusAmount.toFixed(2)}</p>
          </div>
          
          <div class="info-box">
            <h3>ðŸ“‹ InformaÃ§Ãµes do BÃ´nus</h3>
            <p><strong>Ciclo de AvaliaÃ§Ã£o:</strong> ${data.cycleName}</p>
            <p><strong>AprovaÃ§Ã£o Final:</strong> ${data.approverName}</p>
            <p><strong>Status:</strong> âœ… Aprovado em Todos os NÃ­veis</p>
          </div>
          
          <p>O valor serÃ¡ processado pelo departamento financeiro e estarÃ¡ disponÃ­vel conforme o calendÃ¡rio de pagamentos da empresa.</p>
          
          <p><strong>ParabÃ©ns pelo excelente desempenho!</strong></p>
        </div>
        <div class="footer">
          <p>Este Ã© um email automÃ¡tico do Sistema AVD UISA. Por favor, nÃ£o responda.</p>
          <p>Â© 2025 UISA - Todos os direitos reservados</p>
        </div>
      </div>
    </body>
    </html>
  `;

  await sendEmail({
    to: data.employeeEmail,
    subject,
    html: htmlContent,
  });
}


========================================
ARQUIVO: ./server/utils/bonusExcel.ts
========================================
import ExcelJS from "exceljs";

/**
 * UtilitÃ¡rio de ExportaÃ§Ã£o Excel para BÃ´nus
 * Gera planilhas para RH/Financeiro com cÃ¡lculo de bÃ´nus por colaborador
 */

interface BonusData {
  employeeId: number;
  employeeName: string;
  department: string;
  totalBonusAmount: number;
  totalBonusPercentage: number;
  goalsCount: number;
  goals: Array<{
    title: string;
    bonusAmount: number;
    bonusPercentage: number;
  }>;
}

/**
 * Gerar planilha Excel de bÃ´nus
 */
export async function generateBonusExcel(
  bonusData: BonusData[],
  cycleId: number
): Promise<Buffer> {
  const workbook = new ExcelJS.Workbook();
  workbook.creator = "Sistema AVD UISA";
  workbook.created = new Date();

  // Aba 1: Resumo por Colaborador
  const summarySheet = workbook.addWorksheet("Resumo de BÃ´nus");

  // CabeÃ§alho
  summarySheet.mergeCells("A1:G1");
  const titleCell = summarySheet.getCell("A1");
  titleCell.value = `RelatÃ³rio de BÃ´nus - Ciclo ${cycleId}`;
  titleCell.font = { size: 16, bold: true, color: { argb: "FFF39200" } };
  titleCell.alignment = { horizontal: "center", vertical: "middle" };
  titleCell.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "FFFEF3E8" },
  };

  summarySheet.getRow(2).values = [
    "ID",
    "Colaborador",
    "Departamento",
    "Metas ConcluÃ­das",
    "BÃ´nus Fixo (R$)",
    "BÃ´nus Percentual (%)",
    "Total Estimado (R$)",
  ];

  const headerRow = summarySheet.getRow(2);
  headerRow.font = { bold: true, color: { argb: "FFFFFFFF" } };
  headerRow.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "FFF39200" },
  };
  headerRow.alignment = { horizontal: "center", vertical: "middle" };
  headerRow.height = 25;

  // Dados
  let totalBonusAmount = 0;
  let totalBonusPercentage = 0;
  let totalGoals = 0;

  bonusData.forEach((emp, index) => {
    const row = summarySheet.addRow([
      emp.employeeId,
      emp.employeeName,
      emp.department,
      emp.goalsCount,
      emp.totalBonusAmount,
      emp.totalBonusPercentage,
      emp.totalBonusAmount, // Pode ser ajustado com salÃ¡rio base se disponÃ­vel
    ]);

    // FormataÃ§Ã£o de valores
    row.getCell(5).numFmt = 'R$ #,##0.00';
    row.getCell(6).numFmt = '0.00"%"';
    row.getCell(7).numFmt = 'R$ #,##0.00';

    // Zebra striping
    if (index % 2 === 0) {
      row.fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "FFF9F9F9" },
      };
    }

    totalBonusAmount += emp.totalBonusAmount;
    totalBonusPercentage += emp.totalBonusPercentage;
    totalGoals += emp.goalsCount;
  });

  // Linha de totais
  const totalRow = summarySheet.addRow([
    "",
    "TOTAL",
    "",
    totalGoals,
    totalBonusAmount,
    totalBonusPercentage,
    totalBonusAmount,
  ]);
  totalRow.font = { bold: true };
  totalRow.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "FFFFE0B2" },
  };
  totalRow.getCell(5).numFmt = 'R$ #,##0.00';
  totalRow.getCell(6).numFmt = '0.00"%"';
  totalRow.getCell(7).numFmt = 'R$ #,##0.00';

  // Ajustar largura das colunas
  summarySheet.columns = [
    { width: 8 },
    { width: 30 },
    { width: 25 },
    { width: 18 },
    { width: 18 },
    { width: 20 },
    { width: 20 },
  ];

  // Bordas
  summarySheet.eachRow((row, rowNumber) => {
    if (rowNumber > 1) {
      row.eachCell((cell) => {
        cell.border = {
          top: { style: "thin" },
          left: { style: "thin" },
          bottom: { style: "thin" },
          right: { style: "thin" },
        };
      });
    }
  });

  // Aba 2: Detalhamento por Meta
  const detailSheet = workbook.addWorksheet("Detalhamento");

  detailSheet.mergeCells("A1:F1");
  const detailTitleCell = detailSheet.getCell("A1");
  detailTitleCell.value = "Detalhamento de BÃ´nus por Meta";
  detailTitleCell.font = { size: 16, bold: true, color: { argb: "FFF39200" } };
  detailTitleCell.alignment = { horizontal: "center", vertical: "middle" };
  detailTitleCell.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "FFFEF3E8" },
  };

  detailSheet.getRow(2).values = [
    "Colaborador",
    "Departamento",
    "Meta",
    "BÃ´nus Fixo (R$)",
    "BÃ´nus Percentual (%)",
    "ObservaÃ§Ãµes",
  ];

  const detailHeaderRow = detailSheet.getRow(2);
  detailHeaderRow.font = { bold: true, color: { argb: "FFFFFFFF" } };
  detailHeaderRow.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "FFF39200" },
  };
  detailHeaderRow.alignment = { horizontal: "center", vertical: "middle" };
  detailHeaderRow.height = 25;

  // Dados detalhados
  let detailIndex = 0;
  bonusData.forEach((emp) => {
    emp.goals.forEach((goal) => {
      const row = detailSheet.addRow([
        emp.employeeName,
        emp.department,
        goal.title,
        goal.bonusAmount,
        goal.bonusPercentage,
        "",
      ]);

      row.getCell(4).numFmt = 'R$ #,##0.00';
      row.getCell(5).numFmt = '0.00"%"';

      if (detailIndex % 2 === 0) {
        row.fill = {
          type: "pattern",
          pattern: "solid",
          fgColor: { argb: "FFF9F9F9" },
        };
      }
      detailIndex++;
    });
  });

  detailSheet.columns = [
    { width: 30 },
    { width: 25 },
    { width: 40 },
    { width: 18 },
    { width: 20 },
    { width: 30 },
  ];

  detailSheet.eachRow((row, rowNumber) => {
    if (rowNumber > 1) {
      row.eachCell((cell) => {
        cell.border = {
          top: { style: "thin" },
          left: { style: "thin" },
          bottom: { style: "thin" },
          right: { style: "thin" },
        };
      });
    }
  });

  // Aba 3: InstruÃ§Ãµes
  const instructionsSheet = workbook.addWorksheet("InstruÃ§Ãµes");

  instructionsSheet.mergeCells("A1:D1");
  const instructionsTitleCell = instructionsSheet.getCell("A1");
  instructionsTitleCell.value = "InstruÃ§Ãµes de Uso";
  instructionsTitleCell.font = { size: 16, bold: true, color: { argb: "FFF39200" } };
  instructionsTitleCell.alignment = { horizontal: "center", vertical: "middle" };
  instructionsTitleCell.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "FFFEF3E8" },
  };

  instructionsSheet.addRow([]);
  instructionsSheet.addRow(["ðŸ“Š Sobre este RelatÃ³rio"]);
  instructionsSheet.addRow([
    "Este relatÃ³rio contÃ©m o cÃ¡lculo de bÃ´nus baseado em metas SMART concluÃ­das.",
  ]);
  instructionsSheet.addRow([]);
  instructionsSheet.addRow(["ðŸ“‹ Abas DisponÃ­veis"]);
  instructionsSheet.addRow([
    "â€¢ Resumo de BÃ´nus: Totais por colaborador",
  ]);
  instructionsSheet.addRow([
    "â€¢ Detalhamento: BÃ´nus por meta individual",
  ]);
  instructionsSheet.addRow([
    "â€¢ InstruÃ§Ãµes: Esta aba",
  ]);
  instructionsSheet.addRow([]);
  instructionsSheet.addRow(["ðŸ’° Tipos de BÃ´nus"]);
  instructionsSheet.addRow([
    "â€¢ BÃ´nus Fixo: Valor em reais definido na meta",
  ]);
  instructionsSheet.addRow([
    "â€¢ BÃ´nus Percentual: Percentual sobre salÃ¡rio base (a ser calculado pelo RH)",
  ]);
  instructionsSheet.addRow([]);
  instructionsSheet.addRow(["âš ï¸ ObservaÃ§Ãµes Importantes"]);
  instructionsSheet.addRow([
    "â€¢ Apenas metas concluÃ­das (100%) e elegÃ­veis sÃ£o incluÃ­das",
  ]);
  instructionsSheet.addRow([
    "â€¢ O cÃ¡lculo final deve considerar polÃ­ticas internas de RH",
  ]);
  instructionsSheet.addRow([
    "â€¢ Valores de bÃ´nus percentual devem ser aplicados sobre o salÃ¡rio base",
  ]);
  instructionsSheet.addRow([]);
  instructionsSheet.addRow([
    `Gerado em: ${new Date().toLocaleDateString("pt-BR")} Ã s ${new Date().toLocaleTimeString("pt-BR")}`,
  ]);

  instructionsSheet.columns = [{ width: 80 }];

  // Gerar buffer
  const buffer = await workbook.xlsx.writeBuffer();
  return Buffer.from(buffer);
}


========================================
ARQUIVO: ./server/utils/calibrationPDF.ts
========================================
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";

/**
 * UtilitÃ¡rio de ExportaÃ§Ã£o PDF de CalibraÃ§Ã£o
 * Gera relatÃ³rios consolidados de movimentaÃ§Ãµes e aprovaÃ§Ãµes
 */

interface CalibrationData {
  employee: {
    name: string;
    employeeCode: string;
    department: string;
    position: string;
  };
  movement: {
    fromPerformance: string;
    fromPotential: string;
    toPerformance: string;
    toPotential: string;
    justification: string;
    createdAt: Date;
  };
  approvals: Array<{
    approverName: string;
    approverRole: string;
    status: string;
    evidence?: string;
    comments?: string;
    approvedAt?: Date;
  }>;
}

/**
 * Gerar PDF de relatÃ³rio de calibraÃ§Ã£o individual
 */
export async function generateCalibrationPDF(data: CalibrationData): Promise<Buffer> {
  const doc = new jsPDF() as any;

  // CabeÃ§alho
  doc.setFontSize(20);
  doc.setTextColor(243, 146, 0); // #F39200
  doc.text("RelatÃ³rio de CalibraÃ§Ã£o", 105, 20, { align: "center" });

  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  doc.text(`Gerado em: ${new Date().toLocaleDateString("pt-BR")}`, 105, 28, { align: "center" });

  // Linha divisÃ³ria
  doc.setDrawColor(243, 146, 0);
  doc.setLineWidth(0.5);
  doc.line(20, 32, 190, 32);

  // InformaÃ§Ãµes do Colaborador
  doc.setFontSize(14);
  doc.setTextColor(0, 0, 0);
  doc.text("InformaÃ§Ãµes do Colaborador", 20, 42);

  const employeeInfo = [
    ["Nome", data.employee.name],
    ["MatrÃ­cula", data.employee.employeeCode],
    ["Departamento", data.employee.department],
    ["Cargo", data.employee.position],
  ];

  autoTable(doc, {
    startY: 46,
    head: [],
    body: employeeInfo,
    theme: "plain",
    styles: { fontSize: 10 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 40 },
      1: { cellWidth: 140 },
    },
  });

  // MovimentaÃ§Ã£o
  const finalY1 = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(14);
  doc.text("MovimentaÃ§Ã£o no Nine Box", 20, finalY1);

  const movementInfo = [
    [
      "PosiÃ§Ã£o Anterior",
      `${data.movement.fromPerformance.toUpperCase()} Desempenho â€¢ ${data.movement.fromPotential.toUpperCase()} Potencial`,
    ],
    [
      "Nova PosiÃ§Ã£o",
      `${data.movement.toPerformance.toUpperCase()} Desempenho â€¢ ${data.movement.toPotential.toUpperCase()} Potencial`,
    ],
    ["Data da MovimentaÃ§Ã£o", new Date(data.movement.createdAt).toLocaleDateString("pt-BR")],
  ];

  autoTable(doc, {
    startY: finalY1 + 4,
    head: [],
    body: movementInfo,
    theme: "plain",
    styles: { fontSize: 10 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 40 },
      1: { cellWidth: 140 },
    },
  });

  // Justificativa
  const finalY2 = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(12);
  doc.setFont(undefined, "bold");
  doc.text("Justificativa:", 20, finalY2);

  doc.setFont(undefined, "normal");
  doc.setFontSize(10);
  const justificationLines = doc.splitTextToSize(data.movement.justification, 170);
  doc.text(justificationLines, 20, finalY2 + 6);

  // Workflow de AprovaÃ§Ã£o
  const finalY3 = finalY2 + 6 + justificationLines.length * 5 + 10;
  doc.setFontSize(14);
  doc.setFont(undefined, "bold");
  doc.text("Workflow de AprovaÃ§Ã£o", 20, finalY3);

  const approvalRows = data.approvals.map((approval) => [
    approval.approverName,
    getRoleName(approval.approverRole),
    getStatusName(approval.status),
    approval.approvedAt ? new Date(approval.approvedAt).toLocaleDateString("pt-BR") : "-",
  ]);

  autoTable(doc, {
    startY: finalY3 + 4,
    head: [["Aprovador", "NÃ­vel", "Status", "Data"]],
    body: approvalRows,
    theme: "striped",
    headStyles: { fillColor: [243, 146, 0], textColor: [255, 255, 255] },
    styles: { fontSize: 10 },
  });

  // EvidÃªncias e ComentÃ¡rios
  const finalY4 = doc.lastAutoTable.finalY + 10;
  let currentY = finalY4;

  for (const approval of data.approvals) {
    if (approval.evidence || approval.comments) {
      // Verificar se precisa de nova pÃ¡gina
      if (currentY > 250) {
        doc.addPage();
        currentY = 20;
      }

      doc.setFontSize(12);
      doc.setFont(undefined, "bold");
      doc.text(`${approval.approverName} (${getRoleName(approval.approverRole)})`, 20, currentY);

      currentY += 6;
      doc.setFontSize(10);
      doc.setFont(undefined, "normal");

      if (approval.evidence) {
        doc.setFont(undefined, "bold");
        doc.text("EvidÃªncias:", 20, currentY);
        currentY += 5;
        doc.setFont(undefined, "normal");
        const evidenceLines = doc.splitTextToSize(approval.evidence, 170);
        doc.text(evidenceLines, 20, currentY);
        currentY += evidenceLines.length * 5 + 5;
      }

      if (approval.comments) {
        doc.setFont(undefined, "bold");
        doc.text("ComentÃ¡rios:", 20, currentY);
        currentY += 5;
        doc.setFont(undefined, "normal");
        const commentLines = doc.splitTextToSize(approval.comments, 170);
        doc.text(commentLines, 20, currentY);
        currentY += commentLines.length * 5 + 10;
      }
    }
  }

  // RodapÃ©
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text(
      `Sistema AVD UISA - PÃ¡gina ${i} de ${pageCount}`,
      105,
      290,
      { align: "center" }
    );
  }

  return Buffer.from(doc.output("arraybuffer"));
}

/**
 * Gerar PDF consolidado de calibraÃ§Ãµes
 */
export async function generateConsolidatedCalibrationPDF(
  calibrations: CalibrationData[]
): Promise<Buffer> {
  const doc = new jsPDF() as any;

  // CabeÃ§alho
  doc.setFontSize(20);
  doc.setTextColor(243, 146, 0);
  doc.text("RelatÃ³rio Consolidado de CalibraÃ§Ãµes", 105, 20, { align: "center" });

  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  doc.text(`Gerado em: ${new Date().toLocaleDateString("pt-BR")}`, 105, 28, { align: "center" });
  doc.text(`Total de CalibraÃ§Ãµes: ${calibrations.length}`, 105, 34, { align: "center" });

  // Linha divisÃ³ria
  doc.setDrawColor(243, 146, 0);
  doc.setLineWidth(0.5);
  doc.line(20, 38, 190, 38);

  // Tabela consolidada
  const rows = calibrations.map((cal) => [
    cal.employee.name,
    cal.employee.department,
    `${cal.movement.fromPerformance}/${cal.movement.fromPotential}`,
    `${cal.movement.toPerformance}/${cal.movement.toPotential}`,
    cal.approvals.every((a) => a.status === "approved") ? "Aprovado" : "Pendente",
    new Date(cal.movement.createdAt).toLocaleDateString("pt-BR"),
  ]);

  autoTable(doc, {
    startY: 44,
    head: [["Colaborador", "Departamento", "De", "Para", "Status", "Data"]],
    body: rows,
    theme: "striped",
    headStyles: { fillColor: [243, 146, 0], textColor: [255, 255, 255] },
    styles: { fontSize: 9 },
    columnStyles: {
      0: { cellWidth: 45 },
      1: { cellWidth: 40 },
      2: { cellWidth: 25 },
      3: { cellWidth: 25 },
      4: { cellWidth: 25 },
      5: { cellWidth: 25 },
    },
  });

  // RodapÃ©
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text(
      `Sistema AVD UISA - PÃ¡gina ${i} de ${pageCount}`,
      105,
      290,
      { align: "center" }
    );
  }

  return Buffer.from(doc.output("arraybuffer"));
}

function getRoleName(role: string): string {
  switch (role) {
    case "hr":
      return "RH";
    case "people_director":
      return "Diretor de Gente";
    case "area_director":
      return "Diretor de Ãrea";
    default:
      return role;
  }
}

function getStatusName(status: string): string {
  switch (status) {
    case "pending":
      return "Pendente";
    case "approved":
      return "Aprovado";
    case "rejected":
      return "Rejeitado";
    default:
      return status;
  }
}


========================================
ARQUIVO: ./server/utils/consolidatedPerformancePDF.ts
========================================
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";
import { invokeLLM } from "../_core/llm";

/**
 * RelatÃ³rio Consolidado de Performance com Insights de IA
 * Combina dados de Metas SMART, AvaliaÃ§Ã£o 360Â°, PDI e Nine Box
 */

interface ConsolidatedPerformanceData {
  employee: {
    name: string;
    position: string;
    department: string;
    email: string;
  };
  goals: {
    total: number;
    completed: number;
    completionRate: number;
    avgScore: number;
  };
  evaluation360: {
    overallScore: number;
    competencies: Array<{
      name: string;
      score: number;
    }>;
  };
  pdi: {
    totalActions: number;
    completedActions: number;
    completionRate: number;
    keyCompetencies: string[];
  };
  nineBox: {
    performance: string;
    potential: string;
    quadrant: string;
  };
  period: string;
}

/**
 * Gerar insights de IA baseados nos dados consolidados
 */
async function generateAIInsights(data: ConsolidatedPerformanceData): Promise<{
  summary: string;
  strengths: string[];
  improvementAreas: string[];
  recommendations: string[];
}> {
  const prompt = `
Analise os seguintes dados de performance do colaborador e forneÃ§a insights estruturados:

**Colaborador:** ${data.employee.name}
**Cargo:** ${data.employee.position}
**Departamento:** ${data.employee.department}
**PerÃ­odo:** ${data.period}

**Metas SMART:**
- Total: ${data.goals.total}
- ConcluÃ­das: ${data.goals.completed}
- Taxa de ConclusÃ£o: ${data.goals.completionRate.toFixed(1)}%
- PontuaÃ§Ã£o MÃ©dia: ${data.goals.avgScore.toFixed(1)}

**AvaliaÃ§Ã£o 360Â°:**
- PontuaÃ§Ã£o Geral: ${data.evaluation360.overallScore.toFixed(1)}
- CompetÃªncias: ${data.evaluation360.competencies.map(c => `${c.name} (${c.score.toFixed(1)})`).join(", ")}

**PDI:**
- Total de AÃ§Ãµes: ${data.pdi.totalActions}
- AÃ§Ãµes ConcluÃ­das: ${data.pdi.completedActions}
- Taxa de ConclusÃ£o: ${data.pdi.completionRate.toFixed(1)}%
- CompetÃªncias-Chave: ${data.pdi.keyCompetencies.join(", ")}

**Nine Box:**
- Performance: ${data.nineBox.performance}
- Potencial: ${data.nineBox.potential}
- Quadrante: ${data.nineBox.quadrant}

ForneÃ§a uma anÃ¡lise em formato JSON com a seguinte estrutura:
{
  "summary": "Resumo executivo da performance (2-3 frases)",
  "strengths": ["ForÃ§a 1", "ForÃ§a 2", "ForÃ§a 3"],
  "improvementAreas": ["Ãrea 1", "Ãrea 2", "Ãrea 3"],
  "recommendations": ["RecomendaÃ§Ã£o 1", "RecomendaÃ§Ã£o 2", "RecomendaÃ§Ã£o 3"]
}
`;

  try {
    const response = await invokeLLM({
      messages: [
        {
          role: "system",
          content:
            "VocÃª Ã© um especialista em anÃ¡lise de performance de RH. ForneÃ§a insights profissionais e acionÃ¡veis em portuguÃªs do Brasil.",
        },
        {
          role: "user",
          content: prompt,
        },
      ],
      response_format: {
        type: "json_schema",
        json_schema: {
          name: "performance_insights",
          strict: true,
          schema: {
            type: "object",
            properties: {
              summary: { type: "string" },
              strengths: {
                type: "array",
                items: { type: "string" },
              },
              improvementAreas: {
                type: "array",
                items: { type: "string" },
              },
              recommendations: {
                type: "array",
                items: { type: "string" },
              },
            },
            required: ["summary", "strengths", "improvementAreas", "recommendations"],
            additionalProperties: false,
          },
        },
      },
    });

    const content = response.choices[0].message.content;
    const insights = JSON.parse(typeof content === "string" ? content : "{}");
    return insights;
  } catch (error) {
    console.error("[ConsolidatedPDF] Erro ao gerar insights de IA:", error);
    return {
      summary: "AnÃ¡lise automÃ¡tica nÃ£o disponÃ­vel no momento.",
      strengths: ["Dados insuficientes"],
      improvementAreas: ["Dados insuficientes"],
      recommendations: ["Consulte o RH para anÃ¡lise detalhada"],
    };
  }
}

/**
 * Gerar PDF consolidado de performance
 */
export async function generateConsolidatedPerformancePDF(
  data: ConsolidatedPerformanceData
): Promise<Buffer> {
  const doc = new jsPDF() as any;

  // Gerar insights de IA
  const insights = await generateAIInsights(data);

  // CabeÃ§alho
  doc.setFontSize(20);
  doc.setTextColor(243, 146, 0);
  doc.text("RelatÃ³rio Consolidado de Performance", 14, 20);

  doc.setFontSize(10);
  doc.setTextColor(100);
  doc.text(`Gerado em: ${new Date().toLocaleDateString("pt-BR")}`, 14, 27);

  // InformaÃ§Ãµes do Colaborador
  doc.setFontSize(14);
  doc.setTextColor(0);
  doc.text("InformaÃ§Ãµes do Colaborador", 14, 40);

  doc.setFontSize(10);
  doc.text(`Nome: ${data.employee.name}`, 14, 48);
  doc.text(`Cargo: ${data.employee.position}`, 14, 54);
  doc.text(`Departamento: ${data.employee.department}`, 14, 60);
  doc.text(`PerÃ­odo: ${data.period}`, 14, 66);

  // Resumo Executivo com IA
  doc.setFontSize(14);
  doc.setTextColor(243, 146, 0);
  doc.text("Resumo Executivo (IA)", 14, 80);

  doc.setFontSize(10);
  doc.setTextColor(0);
  const summaryLines = doc.splitTextToSize(insights.summary, 180);
  doc.text(summaryLines, 14, 88);

  let yPosition = 88 + summaryLines.length * 5 + 10;

  // Metas SMART
  doc.setFontSize(14);
  doc.setTextColor(243, 146, 0);
  doc.text("Metas SMART", 14, yPosition);
  yPosition += 8;

  autoTable(doc, {
    startY: yPosition,
    head: [["MÃ©trica", "Valor"]],
    body: [
      ["Total de Metas", data.goals.total.toString()],
      ["Metas ConcluÃ­das", data.goals.completed.toString()],
      ["Taxa de ConclusÃ£o", `${data.goals.completionRate.toFixed(1)}%`],
      ["PontuaÃ§Ã£o MÃ©dia", data.goals.avgScore.toFixed(1)],
    ],
    theme: "grid",
    headStyles: { fillColor: [243, 146, 0] },
  });

  yPosition = (doc as any).lastAutoTable.finalY + 10;

  // AvaliaÃ§Ã£o 360Â°
  doc.setFontSize(14);
  doc.setTextColor(243, 146, 0);
  doc.text("AvaliaÃ§Ã£o 360Â°", 14, yPosition);
  yPosition += 8;

  const competenciesData = data.evaluation360.competencies.map((c) => [
    c.name,
    c.score.toFixed(1),
  ]);

  autoTable(doc, {
    startY: yPosition,
    head: [["CompetÃªncia", "PontuaÃ§Ã£o"]],
    body: [
      ["PontuaÃ§Ã£o Geral", data.evaluation360.overallScore.toFixed(1)],
      ...competenciesData,
    ],
    theme: "grid",
    headStyles: { fillColor: [243, 146, 0] },
  });

  yPosition = (doc as any).lastAutoTable.finalY + 10;

  // Nova pÃ¡gina se necessÃ¡rio
  if (yPosition > 250) {
    doc.addPage();
    yPosition = 20;
  }

  // PDI
  doc.setFontSize(14);
  doc.setTextColor(243, 146, 0);
  doc.text("Plano de Desenvolvimento Individual (PDI)", 14, yPosition);
  yPosition += 8;

  autoTable(doc, {
    startY: yPosition,
    head: [["MÃ©trica", "Valor"]],
    body: [
      ["Total de AÃ§Ãµes", data.pdi.totalActions.toString()],
      ["AÃ§Ãµes ConcluÃ­das", data.pdi.completedActions.toString()],
      ["Taxa de ConclusÃ£o", `${data.pdi.completionRate.toFixed(1)}%`],
      ["CompetÃªncias-Chave", data.pdi.keyCompetencies.join(", ")],
    ],
    theme: "grid",
    headStyles: { fillColor: [243, 146, 0] },
  });

  yPosition = (doc as any).lastAutoTable.finalY + 10;

  // Nine Box
  doc.setFontSize(14);
  doc.setTextColor(243, 146, 0);
  doc.text("Matriz Nine Box", 14, yPosition);
  yPosition += 8;

  autoTable(doc, {
    startY: yPosition,
    head: [["DimensÃ£o", "ClassificaÃ§Ã£o"]],
    body: [
      ["Performance", data.nineBox.performance],
      ["Potencial", data.nineBox.potential],
      ["Quadrante", data.nineBox.quadrant],
    ],
    theme: "grid",
    headStyles: { fillColor: [243, 146, 0] },
  });

  yPosition = (doc as any).lastAutoTable.finalY + 10;

  // Nova pÃ¡gina para insights
  doc.addPage();
  yPosition = 20;

  // Pontos Fortes (IA)
  doc.setFontSize(14);
  doc.setTextColor(34, 197, 94);
  doc.text("âœ“ Pontos Fortes", 14, yPosition);
  yPosition += 8;

  doc.setFontSize(10);
  doc.setTextColor(0);
  insights.strengths.forEach((strength, index) => {
    const lines = doc.splitTextToSize(`${index + 1}. ${strength}`, 180);
    doc.text(lines, 14, yPosition);
    yPosition += lines.length * 5 + 3;
  });

  yPosition += 5;

  // Ãreas de Melhoria (IA)
  doc.setFontSize(14);
  doc.setTextColor(239, 68, 68);
  doc.text("âš  Ãreas de Melhoria", 14, yPosition);
  yPosition += 8;

  doc.setFontSize(10);
  doc.setTextColor(0);
  insights.improvementAreas.forEach((area, index) => {
    const lines = doc.splitTextToSize(`${index + 1}. ${area}`, 180);
    doc.text(lines, 14, yPosition);
    yPosition += lines.length * 5 + 3;
  });

  yPosition += 5;

  // RecomendaÃ§Ãµes (IA)
  doc.setFontSize(14);
  doc.setTextColor(59, 130, 246);
  doc.text("ðŸ’¡ RecomendaÃ§Ãµes", 14, yPosition);
  yPosition += 8;

  doc.setFontSize(10);
  doc.setTextColor(0);
  insights.recommendations.forEach((rec, index) => {
    const lines = doc.splitTextToSize(`${index + 1}. ${rec}`, 180);
    doc.text(lines, 14, yPosition);
    yPosition += lines.length * 5 + 3;
  });

  // RodapÃ©
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text(
      `Sistema AVD UISA - RelatÃ³rio Consolidado de Performance - PÃ¡gina ${i} de ${pageCount}`,
      14,
      285
    );
  }

  return Buffer.from(doc.output("arraybuffer"));
}


========================================
ARQUIVO: ./server/utils/emailService.ts
========================================
import nodemailer from "nodemailer";
import { getDb } from "../db";
import { systemSettings } from "../../drizzle/schema";
import { eq } from "drizzle-orm";

// FunÃ§Ã£o para obter configuraÃ§Ãµes SMTP do banco
async function getSmtpConfig() {
  const db = await getDb();
  if (!db) return null;

  try {
    const settings = await db.select()
      .from(systemSettings)
      .where(eq(systemSettings.settingKey, "smtp_config"))
      .limit(1);

    if (settings.length === 0) return null;

    const config = settings[0].settingValue ? JSON.parse(settings[0].settingValue) : null;
    return config;
  } catch (error) {
    console.error("[EmailService] Erro ao buscar configuraÃ§Ãµes SMTP:", error);
    return null;
  }
}

// Criar transporter dinÃ¢mico baseado nas configuraÃ§Ãµes do banco
async function createTransporter() {
  const config = await getSmtpConfig();
  
  if (!config) {
    console.warn("[EmailService] ConfiguraÃ§Ãµes SMTP nÃ£o encontradas. Configure em /admin/smtp");
    return null;
  }

  return nodemailer.createTransport({
    host: config.host,
    port: config.port,
    secure: config.secure,
    auth: {
      user: config.user,
      pass: config.pass,
    },
  });
}

// Email templates
const templates = {
  goalReminder: (data: { employeeName: string; goalTitle: string; dueDate: string; progress: number }) => ({
    subject: `Lembrete: Meta "${data.goalTitle}" vence em breve`,
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
            .button { display: inline-block; padding: 12px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
            .progress-bar { background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden; margin: 15px 0; }
            .progress-fill { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; }
            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>ðŸŽ¯ Lembrete de Meta</h1>
            </div>
            <div class="content">
              <p>OlÃ¡, <strong>${data.employeeName}</strong>!</p>
              <p>Sua meta <strong>"${data.goalTitle}"</strong> estÃ¡ prÃ³xima do prazo de conclusÃ£o.</p>
              <p><strong>Data de vencimento:</strong> ${data.dueDate}</p>
              <p><strong>Progresso atual:</strong></p>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${data.progress}%"></div>
              </div>
              <p style="text-align: center; margin: 0;">${data.progress}%</p>
              <p style="margin-top: 20px;">Acesse o sistema para atualizar o progresso e garantir o cumprimento no prazo.</p>
              <div style="text-align: center;">
                <a href="https://avd.uisa.com.br/metas" class="button">Ver Metas</a>
              </div>
            </div>
            <div class="footer">
              <p>Sistema AVD UISA - AvaliaÃ§Ã£o de Desempenho</p>
              <p>Este Ã© um e-mail automÃ¡tico, por favor nÃ£o responda.</p>
            </div>
          </div>
        </body>
      </html>
    `,
  }),

  evaluationPending: (data: { employeeName: string; evaluationType: string; deadline: string }) => ({
    subject: `AvaliaÃ§Ã£o 360Â° pendente - ${data.evaluationType}`,
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
            .button { display: inline-block; padding: 12px 30px; background: #f5576c; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
            .alert { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; }
            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>ðŸ“‹ AvaliaÃ§Ã£o Pendente</h1>
            </div>
            <div class="content">
              <p>OlÃ¡, <strong>${data.employeeName}</strong>!</p>
              <p>VocÃª tem uma <strong>${data.evaluationType}</strong> pendente no sistema AVD.</p>
              <div class="alert">
                <strong>â° Prazo:</strong> ${data.deadline}
              </div>
              <p>Sua participaÃ§Ã£o Ã© fundamental para o processo de avaliaÃ§Ã£o 360Â°. Reserve alguns minutos para completar sua avaliaÃ§Ã£o.</p>
              <div style="text-align: center;">
                <a href="https://avd.uisa.com.br/avaliacoes" class="button">Iniciar AvaliaÃ§Ã£o</a>
              </div>
            </div>
            <div class="footer">
              <p>Sistema AVD UISA - AvaliaÃ§Ã£o de Desempenho</p>
              <p>Este Ã© um e-mail automÃ¡tico, por favor nÃ£o responda.</p>
            </div>
          </div>
        </body>
      </html>
    `,
  }),

  actionOverdue: (data: { employeeName: string; actionTitle: string; dueDate: string; pdiTitle: string }) => ({
    subject: `AÃ§Ã£o de PDI vencida: ${data.actionTitle}`,
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
            .button { display: inline-block; padding: 12px 30px; background: #f5576c; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
            .alert { background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0; }
            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>âš ï¸ AÃ§Ã£o de PDI Vencida</h1>
            </div>
            <div class="content">
              <p>OlÃ¡, <strong>${data.employeeName}</strong>!</p>
              <div class="alert">
                <strong>AtenÃ§Ã£o:</strong> A aÃ§Ã£o <strong>"${data.actionTitle}"</strong> do seu ${data.pdiTitle} estÃ¡ vencida.
              </div>
              <p><strong>Data de vencimento:</strong> ${data.dueDate}</p>
              <p>Acesse o sistema para atualizar o status da aÃ§Ã£o ou reprogramar o prazo.</p>
              <div style="text-align: center;">
                <a href="https://avd.uisa.com.br/pdi" class="button">Ver Meu PDI</a>
              </div>
            </div>
            <div class="footer">
              <p>Sistema AVD UISA - AvaliaÃ§Ã£o de Desempenho</p>
              <p>Este Ã© um e-mail automÃ¡tico, por favor nÃ£o responda.</p>
            </div>
          </div>
        </body>
      </html>
    `,
  }),

  resetPassword: (data: { employeeName: string; resetLink: string; expiresIn: string }) => ({
    subject: "RedefiniÃ§Ã£o de senha - Sistema AVD UISA",
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
            .button { display: inline-block; padding: 12px 30px; background: #f5576c; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
            .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; }
            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>ðŸ” RedefiniÃ§Ã£o de Senha</h1>
            </div>
            <div class="content">
              <p>OlÃ¡, <strong>${data.employeeName}</strong>!</p>
              <p>Recebemos uma solicitaÃ§Ã£o para redefinir a senha da sua conta no Sistema AVD UISA.</p>
              <div class="warning">
                <strong>âš ï¸ AtenÃ§Ã£o:</strong> Este link expira em <strong>${data.expiresIn}</strong>.
              </div>
              <p>Clique no botÃ£o abaixo para criar uma nova senha:</p>
              <div style="text-align: center;">
                <a href="${data.resetLink}" class="button">Redefinir Senha</a>
              </div>
              <p style="margin-top: 20px; font-size: 12px; color: #666;">Se vocÃª nÃ£o solicitou esta redefiniÃ§Ã£o, ignore este e-mail.</p>
            </div>
            <div class="footer">
              <p>Sistema AVD UISA - AvaliaÃ§Ã£o de Desempenho</p>
              <p>Este Ã© um e-mail automÃ¡tico, por favor nÃ£o responda.</p>
            </div>
          </div>
        </body>
      </html>
    `,
  }),

  badgeEarned: (data: { employeeName: string; badgeName: string; badgeDescription: string; badgeIcon: string }) => ({
    subject: `ðŸ† ParabÃ©ns! VocÃª conquistou um novo badge: ${data.badgeName}`,
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #333; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
            .badge-icon { font-size: 80px; margin: 20px 0; }
            .button { display: inline-block; padding: 12px 30px; background: #ffd700; color: #333; text-decoration: none; border-radius: 5px; margin: 20px 0; font-weight: bold; }
            .celebration { background: #fff3cd; border-left: 4px solid #ffd700; padding: 15px; margin: 20px 0; }
            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>ðŸŽ‰ Nova Conquista Desbloqueada!</h1>
            </div>
            <div class="content">
              <p>OlÃ¡, <strong>${data.employeeName}</strong>!</p>
              <div style="text-align: center;">
                <div class="badge-icon">${data.badgeIcon}</div>
                <h2 style="color: #ffd700; margin: 10px 0;">${data.badgeName}</h2>
              </div>
              <div class="celebration">
                <p style="margin: 0;"><strong>${data.badgeDescription}</strong></p>
              </div>
              <p>ParabÃ©ns por esta conquista! Continue assim e desbloqueie mais badges.</p>
              <div style="text-align: center;">
                <a href="https://avd.uisa.com.br/badges" class="button">Ver Minhas Conquistas</a>
              </div>
            </div>
            <div class="footer">
              <p>Sistema AVD UISA - AvaliaÃ§Ã£o de Desempenho</p>
              <p>Este Ã© um e-mail automÃ¡tico, por favor nÃ£o responda.</p>
            </div>
          </div>
        </body>
      </html>
    `,
  }),

  pdiApproved: (data: { employeeName: string; pdiTitle: string; approverName: string; startDate: string; endDate: string }) => ({
    subject: `âœ… PDI Aprovado: ${data.pdiTitle}`,
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
            .button { display: inline-block; padding: 12px 30px; background: #10b981; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
            .success { background: #d1fae5; border-left: 4px solid #10b981; padding: 15px; margin: 20px 0; }
            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>âœ… PDI Aprovado!</h1>
            </div>
            <div class="content">
              <p>OlÃ¡, <strong>${data.employeeName}</strong>!</p>
              <div class="success">
                <p style="margin: 0;"><strong>Seu Plano de Desenvolvimento Individual foi aprovado!</strong></p>
              </div>
              <p><strong>PDI:</strong> ${data.pdiTitle}</p>
              <p><strong>Aprovado por:</strong> ${data.approverName}</p>
              <p><strong>PerÃ­odo:</strong> ${data.startDate} atÃ© ${data.endDate}</p>
              <p>Agora vocÃª pode comeÃ§ar a executar as aÃ§Ãµes planejadas. Acesse o sistema para acompanhar seu progresso.</p>
              <div style="text-align: center;">
                <a href="https://avd.uisa.com.br/pdi" class="button">Ver Meu PDI</a>
              </div>
            </div>
            <div class="footer">
              <p>Sistema AVD UISA - AvaliaÃ§Ã£o de Desempenho</p>
              <p>Este Ã© um e-mail automÃ¡tico, por favor nÃ£o responda.</p>
            </div>
          </div>
        </body>
      </html>
    `,
  }),
};

// Email service methods
export const emailService = {
  async sendGoalReminder(to: string, data: Parameters<typeof templates.goalReminder>[0]) {
    const transporter = await createTransporter();
    if (!transporter) {
      console.warn("[EmailService] Transporter nÃ£o disponÃ­vel");
      return false;
    }

    const config = await getSmtpConfig();
    if (!config) return false;

    const template = templates.goalReminder(data);
    
    try {
      await transporter.sendMail({
        from: `"${config.fromName}" <${config.fromEmail}>`,
        to,
        subject: template.subject,
        html: template.html,
      });
      console.log(`[EmailService] E-mail de lembrete de meta enviado para ${to}`);
      return true;
    } catch (error) {
      console.error("[EmailService] Erro ao enviar e-mail:", error);
      return false;
    }
  },

  async sendEvaluationReminder(to: string, data: Parameters<typeof templates.evaluationPending>[0]) {
    const transporter = await createTransporter();
    if (!transporter) {
      console.warn("[EmailService] Transporter nÃ£o disponÃ­vel");
      return false;
    }

    const config = await getSmtpConfig();
    if (!config) return false;

    const template = templates.evaluationPending(data);
    
    try {
      await transporter.sendMail({
        from: `"${config.fromName}" <${config.fromEmail}>`,
        to,
        subject: template.subject,
        html: template.html,
      });
      console.log(`[EmailService] E-mail de lembrete de avaliaÃ§Ã£o enviado para ${to}`);
      return true;
    } catch (error) {
      console.error("[EmailService] Erro ao enviar e-mail:", error);
      return false;
    }
  },

  async sendActionOverdue(to: string, data: Parameters<typeof templates.actionOverdue>[0]) {
    const transporter = await createTransporter();
    if (!transporter) {
      console.warn("[EmailService] Transporter nÃ£o disponÃ­vel");
      return false;
    }

    const config = await getSmtpConfig();
    if (!config) return false;

    const template = templates.actionOverdue(data);
    
    try {
      await transporter.sendMail({
        from: `"${config.fromName}" <${config.fromEmail}>`,
        to,
        subject: template.subject,
        html: template.html,
      });
      console.log(`[EmailService] E-mail de aÃ§Ã£o vencida enviado para ${to}`);
      return true;
    } catch (error) {
      console.error("[EmailService] Erro ao enviar e-mail:", error);
      return false;
    }
  },

  async sendPasswordReset(to: string, data: Parameters<typeof templates.resetPassword>[0]) {
    const transporter = await createTransporter();
    if (!transporter) {
      console.warn("[EmailService] Transporter nÃ£o disponÃ­vel");
      return false;
    }

    const config = await getSmtpConfig();
    if (!config) return false;

    const template = templates.resetPassword(data);
    
    try {
      await transporter.sendMail({
        from: `"${config.fromName}" <${config.fromEmail}>`,
        to,
        subject: template.subject,
        html: template.html,
      });
      console.log(`[EmailService] E-mail de redefiniÃ§Ã£o de senha enviado para ${to}`);
      return true;
    } catch (error) {
      console.error("[EmailService] Erro ao enviar e-mail:", error);
      return false;
    }
  },

  async sendBadgeNotification(to: string, data: Parameters<typeof templates.badgeEarned>[0]) {
    const transporter = await createTransporter();
    if (!transporter) {
      console.warn("[EmailService] Transporter nÃ£o disponÃ­vel");
      return false;
    }

    const config = await getSmtpConfig();
    if (!config) return false;

    const template = templates.badgeEarned(data);
    
    try {
      await transporter.sendMail({
        from: `"${config.fromName}" <${config.fromEmail}>`,
        to,
        subject: template.subject,
        html: template.html,
      });
      console.log(`[EmailService] E-mail de badge conquistado enviado para ${to}`);
      return true;
    } catch (error) {
      console.error("[EmailService] Erro ao enviar e-mail:", error);
      return false;
    }
  },

  async sendPDIApproval(to: string, data: Parameters<typeof templates.pdiApproved>[0]) {
    const transporter = await createTransporter();
    if (!transporter) {
      console.warn("[EmailService] Transporter nÃ£o disponÃ­vel");
      return false;
    }

    const config = await getSmtpConfig();
    if (!config) return false;

    const template = templates.pdiApproved(data);
    
    try {
      await transporter.sendMail({
        from: `"${config.fromName}" <${config.fromEmail}>`,
        to,
        subject: template.subject,
        html: template.html,
      });
      console.log(`[EmailService] E-mail de PDI aprovado enviado para ${to}`);
      return true;
    } catch (error) {
      console.error("[EmailService] Erro ao enviar e-mail:", error);
      return false;
    }
  },

  async sendCustomEmail(to: string, subject: string, html: string) {
    const transporter = await createTransporter();
    if (!transporter) {
      console.warn("[EmailService] Transporter nÃ£o disponÃ­vel");
      return false;
    }

    const config = await getSmtpConfig();
    if (!config) return false;

    try {
      await transporter.sendMail({
        from: `"${config.fromName}" <${config.fromEmail}>`,
        to,
        subject,
        html,
      });
      console.log(`[EmailService] E-mail customizado enviado para ${to}`);
      return true;
    } catch (error) {
      console.error("[EmailService] Erro ao enviar e-mail:", error);
      return false;
    }
  },
};


========================================
ARQUIVO: ./server/utils/externalIntegrations.ts
========================================
/**
 * ServiÃ§o de IntegraÃ§Ãµes Externas
 * Microsoft Teams, Slack e Google Meet
 */

interface TeamsNotification {
  title: string;
  message: string;
  actionUrl?: string;
  actionText?: string;
}

interface SlackNotification {
  channel: string;
  message: string;
  blocks?: any[];
}

interface GoogleMeetConfig {
  summary: string;
  description: string;
  startTime: Date;
  endTime: Date;
  attendees: string[];
}

/**
 * Enviar notificaÃ§Ã£o para Microsoft Teams
 */
export async function sendTeamsNotification(
  webhookUrl: string,
  notification: TeamsNotification
): Promise<boolean> {
  try {
    const payload = {
      "@type": "MessageCard",
      "@context": "https://schema.org/extensions",
      summary: notification.title,
      themeColor: "F39200",
      title: notification.title,
      text: notification.message,
      potentialAction: notification.actionUrl
        ? [
            {
              "@type": "OpenUri",
              name: notification.actionText || "Ver Detalhes",
              targets: [
                {
                  os: "default",
                  uri: notification.actionUrl,
                },
              ],
            },
          ]
        : undefined,
    };

    const response = await fetch(webhookUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    });

    return response.ok;
  } catch (error) {
    console.error("[Teams] Erro ao enviar notificaÃ§Ã£o:", error);
    return false;
  }
}

/**
 * Enviar notificaÃ§Ã£o para Slack
 */
export async function sendSlackNotification(
  webhookUrl: string,
  notification: SlackNotification
): Promise<boolean> {
  try {
    const payload = {
      channel: notification.channel,
      text: notification.message,
      blocks: notification.blocks || [
        {
          type: "section",
          text: {
            type: "mrkdwn",
            text: notification.message,
          },
        },
      ],
    };

    const response = await fetch(webhookUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    });

    return response.ok;
  } catch (error) {
    console.error("[Slack] Erro ao enviar notificaÃ§Ã£o:", error);
    return false;
  }
}

/**
 * Criar reuniÃ£o no Google Meet
 * Requer autenticaÃ§Ã£o OAuth2 do Google
 */
export async function createGoogleMeetMeeting(
  accessToken: string,
  config: GoogleMeetConfig
): Promise<{ meetLink: string; eventId: string } | null> {
  try {
    const event = {
      summary: config.summary,
      description: config.description,
      start: {
        dateTime: config.startTime.toISOString(),
        timeZone: "America/Sao_Paulo",
      },
      end: {
        dateTime: config.endTime.toISOString(),
        timeZone: "America/Sao_Paulo",
      },
      attendees: config.attendees.map((email) => ({ email })),
      conferenceData: {
        createRequest: {
          requestId: `meet-${Date.now()}`,
          conferenceSolutionKey: {
            type: "hangoutsMeet",
          },
        },
      },
    };

    const response = await fetch(
      "https://www.googleapis.com/calendar/v3/calendars/primary/events?conferenceDataVersion=1",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(event),
      }
    );

    if (!response.ok) {
      console.error("[Google Meet] Erro na resposta:", await response.text());
      return null;
    }

    const data = await response.json();
    const meetLink = data.conferenceData?.entryPoints?.find(
      (ep: any) => ep.entryPointType === "video"
    )?.uri;

    return {
      meetLink: meetLink || data.hangoutLink,
      eventId: data.id,
    };
  } catch (error) {
    console.error("[Google Meet] Erro ao criar reuniÃ£o:", error);
    return null;
  }
}

/**
 * Notificar aprovaÃ§Ã£o de meta via Teams
 */
export async function notifyGoalApprovalTeams(
  webhookUrl: string,
  employeeName: string,
  goalTitle: string,
  approver: string
): Promise<boolean> {
  return sendTeamsNotification(webhookUrl, {
    title: "âœ… Meta Aprovada",
    message: `A meta "${goalTitle}" de ${employeeName} foi aprovada por ${approver}.`,
    actionUrl: process.env.VITE_APP_URL + "/metas",
    actionText: "Ver Metas",
  });
}

/**
 * Notificar calibraÃ§Ã£o pendente via Slack
 */
export async function notifyCalibrationPendingSlack(
  webhookUrl: string,
  channel: string,
  employeeName: string,
  approverName: string
): Promise<boolean> {
  return sendSlackNotification(webhookUrl, {
    channel,
    message: `ðŸ”” *CalibraÃ§Ã£o Pendente*\n\nA movimentaÃ§Ã£o de *${employeeName}* estÃ¡ aguardando aprovaÃ§Ã£o de *${approverName}*.`,
    blocks: [
      {
        type: "section",
        text: {
          type: "mrkdwn",
          text: `ðŸ”” *CalibraÃ§Ã£o Pendente*\n\nA movimentaÃ§Ã£o de *${employeeName}* estÃ¡ aguardando aprovaÃ§Ã£o de *${approverName}*.`,
        },
      },
      {
        type: "actions",
        elements: [
          {
            type: "button",
            text: {
              type: "plain_text",
              text: "Ver AprovaÃ§Ãµes",
            },
            url: process.env.VITE_APP_URL + "/executivo/aprovacoes",
            style: "primary",
          },
        ],
      },
    ],
  });
}

/**
 * Agendar reuniÃ£o de feedback via Google Meet
 */
export async function scheduleFeedbackMeeting(
  accessToken: string,
  managerEmail: string,
  employeeEmail: string,
  employeeName: string,
  date: Date
): Promise<{ meetLink: string; eventId: string } | null> {
  const endDate = new Date(date);
  endDate.setHours(endDate.getHours() + 1);

  return createGoogleMeetMeeting(accessToken, {
    summary: `ReuniÃ£o de Feedback - ${employeeName}`,
    description: `ReuniÃ£o de feedback e acompanhamento de desempenho.`,
    startTime: date,
    endTime: endDate,
    attendees: [managerEmail, employeeEmail],
  });
}


========================================
ARQUIVO: ./server/utils/goalsPDF.ts
========================================
import { jsPDF } from "jspdf";
import "jspdf-autotable";

/**
 * UtilitÃ¡rio de ExportaÃ§Ã£o PDF para Metas SMART
 * Gera relatÃ³rios individuais e consolidados de metas
 */

interface GoalData {
  id: number;
  title: string;
  description: string;
  category: string;
  type: string;
  status: string;
  progress: number;
  measurementUnit?: string;
  targetValue?: string;
  currentValue?: string;
  weight: number;
  startDate: Date;
  endDate: Date;
  bonusEligible: boolean;
  bonusPercentage?: string;
  bonusAmount?: string;
  isSpecific: boolean;
  isMeasurable: boolean;
  isAchievable: boolean;
  isRelevant: boolean;
  isTimeBound: boolean;
  employeeName?: string;
  cycleName?: string;
  milestones?: any[];
  comments?: any[];
}

/**
 * Gerar PDF de meta individual
 */
export function generateGoalPDF(goal: GoalData): Buffer {
  const doc = new jsPDF();
  let yPos = 20;

  // CabeÃ§alho
  doc.setFontSize(20);
  doc.setTextColor(243, 146, 0); // Laranja UISA
  doc.text("Sistema AVD UISA", 20, yPos);
  yPos += 10;

  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text("RelatÃ³rio de Meta SMART", 20, yPos);
  yPos += 15;

  // InformaÃ§Ãµes BÃ¡sicas
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("InformaÃ§Ãµes da Meta", 20, yPos);
  yPos += 10;

  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");

  const basicInfo = [
    ["TÃ­tulo", goal.title],
    ["Categoria", getCategoryLabel(goal.category)],
    ["Tipo", getTypeLabel(goal.type)],
    ["Status", getStatusLabel(goal.status)],
    ["Progresso", `${goal.progress}%`],
    ["Peso", `${goal.weight}%`],
    ["Colaborador", goal.employeeName || "N/A"],
    ["Ciclo", goal.cycleName || "N/A"],
  ];

  (doc as any).autoTable({
    startY: yPos,
    head: [],
    body: basicInfo,
    theme: "grid",
    styles: { fontSize: 10 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 40 },
      1: { cellWidth: 140 },
    },
  });

  yPos = (doc as any).lastAutoTable.finalY + 10;

  // DescriÃ§Ã£o
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("DescriÃ§Ã£o", 20, yPos);
  yPos += 7;

  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  const splitDescription = doc.splitTextToSize(goal.description, 170);
  doc.text(splitDescription, 20, yPos);
  yPos += splitDescription.length * 5 + 10;

  // MÃ©tricas
  if (goal.measurementUnit && goal.targetValue) {
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("MÃ©tricas", 20, yPos);
    yPos += 10;

    const metricsInfo = [
      ["Unidade de Medida", goal.measurementUnit],
      ["Valor Alvo", goal.targetValue],
      ["Valor Atual", goal.currentValue || "0"],
    ];

    (doc as any).autoTable({
      startY: yPos,
      head: [],
      body: metricsInfo,
      theme: "grid",
      styles: { fontSize: 10 },
      columnStyles: {
        0: { fontStyle: "bold", cellWidth: 60 },
        1: { cellWidth: 120 },
      },
    });

    yPos = (doc as any).lastAutoTable.finalY + 10;
  }

  // Nova pÃ¡gina se necessÃ¡rio
  if (yPos > 250) {
    doc.addPage();
    yPos = 20;
  }

  // Datas
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("PerÃ­odo", 20, yPos);
  yPos += 10;

  const datesInfo = [
    ["Data de InÃ­cio", formatDate(goal.startDate)],
    ["Data de TÃ©rmino", formatDate(goal.endDate)],
  ];

  (doc as any).autoTable({
    startY: yPos,
    head: [],
    body: datesInfo,
    theme: "grid",
    styles: { fontSize: 10 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 60 },
      1: { cellWidth: 120 },
    },
  });

  yPos = (doc as any).lastAutoTable.finalY + 10;

  // CritÃ©rios SMART
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("ValidaÃ§Ã£o SMART", 20, yPos);
  yPos += 10;

  const smartScore =
    [
      goal.isSpecific,
      goal.isMeasurable,
      goal.isAchievable,
      goal.isRelevant,
      goal.isTimeBound,
    ].filter(Boolean).length * 20;

  const smartInfo = [
    ["S - EspecÃ­fica", goal.isSpecific ? "âœ“ Sim" : "âœ— NÃ£o"],
    ["M - MensurÃ¡vel", goal.isMeasurable ? "âœ“ Sim" : "âœ— NÃ£o"],
    ["A - AtingÃ­vel", goal.isAchievable ? "âœ“ Sim" : "âœ— NÃ£o"],
    ["R - Relevante", goal.isRelevant ? "âœ“ Sim" : "âœ— NÃ£o"],
    ["T - Temporal", goal.isTimeBound ? "âœ“ Sim" : "âœ— NÃ£o"],
    ["Score Total", `${smartScore}/100`],
  ];

  (doc as any).autoTable({
    startY: yPos,
    head: [],
    body: smartInfo,
    theme: "grid",
    styles: { fontSize: 10 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 60 },
      1: { cellWidth: 120 },
    },
  });

  yPos = (doc as any).lastAutoTable.finalY + 10;

  // BÃ´nus
  if (goal.bonusEligible) {
    if (yPos > 250) {
      doc.addPage();
      yPos = 20;
    }

    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("InformaÃ§Ãµes de BÃ´nus", 20, yPos);
    yPos += 10;

    const bonusInfo = [];
    if (goal.bonusPercentage) {
      bonusInfo.push(["BÃ´nus Percentual", `${goal.bonusPercentage}%`]);
    }
    if (goal.bonusAmount) {
      bonusInfo.push(["BÃ´nus Fixo", `R$ ${goal.bonusAmount}`]);
    }

    (doc as any).autoTable({
      startY: yPos,
      head: [],
      body: bonusInfo,
      theme: "grid",
      styles: { fontSize: 10 },
      columnStyles: {
        0: { fontStyle: "bold", cellWidth: 60 },
        1: { cellWidth: 120 },
      },
    });

    yPos = (doc as any).lastAutoTable.finalY + 10;
  }

  // Marcos
  if (goal.milestones && goal.milestones.length > 0) {
    if (yPos > 230) {
      doc.addPage();
      yPos = 20;
    }

    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text(`Marcos IntermediÃ¡rios (${goal.milestones.length})`, 20, yPos);
    yPos += 10;

    const milestonesData = goal.milestones.map((m) => [
      m.title,
      formatDate(m.dueDate),
      `${m.progress || 0}%`,
      getMilestoneStatusLabel(m.status),
    ]);

    (doc as any).autoTable({
      startY: yPos,
      head: [["Marco", "Prazo", "Progresso", "Status"]],
      body: milestonesData,
      theme: "grid",
      styles: { fontSize: 9 },
      headStyles: { fillColor: [243, 146, 0], textColor: 255 },
    });

    yPos = (doc as any).lastAutoTable.finalY + 10;
  }

  // RodapÃ©
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text(
      `Gerado em ${new Date().toLocaleDateString("pt-BR")} Ã s ${new Date().toLocaleTimeString("pt-BR")}`,
      20,
      285
    );
    doc.text(`PÃ¡gina ${i} de ${pageCount}`, 180, 285);
  }

  return Buffer.from(doc.output("arraybuffer"));
}

/**
 * Gerar PDF consolidado de mÃºltiplas metas
 */
export function generateGoalsConsolidatedPDF(
  goals: GoalData[],
  title: string = "RelatÃ³rio Consolidado de Metas"
): Buffer {
  const doc = new jsPDF();
  let yPos = 20;

  // CabeÃ§alho
  doc.setFontSize(20);
  doc.setTextColor(243, 146, 0);
  doc.text("Sistema AVD UISA", 20, yPos);
  yPos += 10;

  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text(title, 20, yPos);
  yPos += 15;

  // Resumo Executivo
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("Resumo Executivo", 20, yPos);
  yPos += 10;

  const totalGoals = goals.length;
  const completedGoals = goals.filter((g) => g.status === "completed").length;
  const inProgressGoals = goals.filter((g) => g.status === "in_progress").length;
  const avgProgress = totalGoals > 0
    ? Math.round(goals.reduce((sum, g) => sum + g.progress, 0) / totalGoals)
    : 0;
  const bonusGoals = goals.filter((g) => g.bonusEligible).length;

  const summaryInfo = [
    ["Total de Metas", totalGoals.toString()],
    ["Metas ConcluÃ­das", `${completedGoals} (${Math.round((completedGoals / totalGoals) * 100)}%)`],
    ["Metas em Andamento", inProgressGoals.toString()],
    ["Progresso MÃ©dio", `${avgProgress}%`],
    ["Metas com BÃ´nus", bonusGoals.toString()],
  ];

  (doc as any).autoTable({
    startY: yPos,
    head: [],
    body: summaryInfo,
    theme: "grid",
    styles: { fontSize: 10 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 70 },
      1: { cellWidth: 110 },
    },
  });

  yPos = (doc as any).lastAutoTable.finalY + 15;

  // DistribuiÃ§Ã£o por Categoria
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("DistribuiÃ§Ã£o por Categoria", 20, yPos);
  yPos += 10;

  const categoryData = [
    ["Financeira", goals.filter((g) => g.category === "financial").length],
    ["Comportamental", goals.filter((g) => g.category === "behavioral").length],
    ["Corporativa", goals.filter((g) => g.category === "corporate").length],
    ["Desenvolvimento", goals.filter((g) => g.category === "development").length],
  ];

  (doc as any).autoTable({
    startY: yPos,
    head: [["Categoria", "Quantidade"]],
    body: categoryData,
    theme: "grid",
    styles: { fontSize: 10 },
    headStyles: { fillColor: [243, 146, 0], textColor: 255 },
  });

  yPos = (doc as any).lastAutoTable.finalY + 15;

  // Lista de Metas
  doc.addPage();
  yPos = 20;

  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("Detalhamento de Metas", 20, yPos);
  yPos += 10;

  const goalsData = goals.map((g) => [
    g.title.substring(0, 40) + (g.title.length > 40 ? "..." : ""),
    getCategoryLabel(g.category),
    getStatusLabel(g.status),
    `${g.progress}%`,
    g.employeeName || "N/A",
  ]);

  (doc as any).autoTable({
    startY: yPos,
    head: [["Meta", "Categoria", "Status", "Progresso", "Colaborador"]],
    body: goalsData,
    theme: "grid",
    styles: { fontSize: 8 },
    headStyles: { fillColor: [243, 146, 0], textColor: 255 },
    columnStyles: {
      0: { cellWidth: 70 },
      1: { cellWidth: 35 },
      2: { cellWidth: 30 },
      3: { cellWidth: 25 },
      4: { cellWidth: 30 },
    },
  });

  // RodapÃ©
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text(
      `Gerado em ${new Date().toLocaleDateString("pt-BR")} Ã s ${new Date().toLocaleTimeString("pt-BR")}`,
      20,
      285
    );
    doc.text(`PÃ¡gina ${i} de ${pageCount}`, 180, 285);
  }

  return Buffer.from(doc.output("arraybuffer"));
}

// Helpers
function formatDate(date: Date | string): string {
  const d = typeof date === "string" ? new Date(date) : date;
  return d.toLocaleDateString("pt-BR");
}

function getCategoryLabel(category: string): string {
  const labels: Record<string, string> = {
    financial: "Financeira",
    behavioral: "Comportamental",
    corporate: "Corporativa",
    development: "Desenvolvimento",
  };
  return labels[category] || category;
}

function getTypeLabel(type: string): string {
  const labels: Record<string, string> = {
    individual: "Individual",
    team: "Equipe",
    organizational: "Organizacional",
  };
  return labels[type] || type;
}

function getStatusLabel(status: string): string {
  const labels: Record<string, string> = {
    draft: "Rascunho",
    pending_approval: "Aguardando AprovaÃ§Ã£o",
    approved: "Aprovada",
    rejected: "Rejeitada",
    in_progress: "Em Andamento",
    completed: "ConcluÃ­da",
    cancelled: "Cancelada",
  };
  return labels[status] || status;
}

function getMilestoneStatusLabel(status: string): string {
  const labels: Record<string, string> = {
    pending: "Pendente",
    in_progress: "Em Andamento",
    completed: "ConcluÃ­do",
    delayed: "Atrasado",
  };
  return labels[status] || status;
}


========================================
ARQUIVO: ./server/utils/notifications.ts
========================================
import type { Server as SocketIOServer } from "socket.io";
import type { NotificationPayload } from "../websocket";

export class NotificationService {
  constructor(private io: SocketIOServer) {}

  // Notificar usuÃ¡rio especÃ­fico
  notifyUser(userId: number, notification: NotificationPayload) {
    this.io.to(`user:${userId}`).emit("notification", notification);
  }

  // Notificar todos os usuÃ¡rios
  notifyAll(notification: NotificationPayload) {
    this.io.emit("notification", notification);
  }

  // NotificaÃ§Ãµes especÃ­ficas do sistema

  notifyNewGoal(userId: number, goalTitle: string) {
    this.notifyUser(userId, {
      type: "meta",
      title: "Nova Meta AtribuÃ­da",
      message: `VocÃª recebeu uma nova meta: ${goalTitle}`,
      link: "/metas",
    });
  }

  notifyGoalApproved(userId: number, goalTitle: string) {
    this.notifyUser(userId, {
      type: "meta",
      title: "Meta Aprovada",
      message: `Sua meta "${goalTitle}" foi aprovada pelo gestor`,
      link: "/metas",
    });
  }

  notifyGoalRejected(userId: number, goalTitle: string, reason?: string) {
    this.notifyUser(userId, {
      type: "meta",
      title: "Meta Rejeitada",
      message: `Sua meta "${goalTitle}" foi rejeitada${reason ? `: ${reason}` : ""}`,
      link: "/metas",
    });
  }

  notifyGoalDeadlineApproaching(userId: number, goalTitle: string, daysLeft: number) {
    this.notifyUser(userId, {
      type: "prazo",
      title: "Prazo de Meta PrÃ³ximo",
      message: `A meta "${goalTitle}" vence em ${daysLeft} dia(s)`,
      link: "/metas",
    });
  }

  notifyEvaluationPending(userId: number, evaluatedName: string) {
    this.notifyUser(userId, {
      type: "avaliacao",
      title: "AvaliaÃ§Ã£o Pendente",
      message: `VocÃª tem uma avaliaÃ§Ã£o pendente para ${evaluatedName}`,
      link: "/avaliacoes",
    });
  }

  notifyEvaluationCompleted(userId: number) {
    this.notifyUser(userId, {
      type: "avaliacao",
      title: "AvaliaÃ§Ã£o ConcluÃ­da",
      message: "Sua avaliaÃ§Ã£o 360Â° foi concluÃ­da e estÃ¡ disponÃ­vel para visualizaÃ§Ã£o",
      link: "/avaliacoes",
    });
  }

  notifyPDICreated(userId: number) {
    this.notifyUser(userId, {
      type: "pdi",
      title: "PDI Criado",
      message: "Seu Plano de Desenvolvimento Individual foi criado",
      link: "/pdi",
    });
  }

  notifyPDIApproved(userId: number) {
    this.notifyUser(userId, {
      type: "pdi",
      title: "PDI Aprovado",
      message: "Seu PDI foi aprovado pelo gestor",
      link: "/pdi",
    });
  }

  notifyPDIActionDue(userId: number, actionTitle: string, daysLeft: number) {
    this.notifyUser(userId, {
      type: "prazo",
      title: "AÃ§Ã£o de PDI Vencendo",
      message: `A aÃ§Ã£o "${actionTitle}" vence em ${daysLeft} dia(s)`,
      link: "/pdi",
    });
  }

  notifyFeedbackReceived(userId: number, from: string) {
    this.notifyUser(userId, {
      type: "feedback",
      title: "Novo Feedback",
      message: `VocÃª recebeu um feedback de ${from}`,
      link: "/avaliacoes",
    });
  }

  notifyCalibrationScheduled(userId: number, date: string) {
    this.notifyUser(userId, {
      type: "avaliacao",
      title: "CalibraÃ§Ã£o Agendada",
      message: `ReuniÃ£o de calibraÃ§Ã£o agendada para ${date}`,
      link: "/calibracao",
    });
  }
}

// Helper para obter o serviÃ§o de notificaÃ§Ãµes do contexto Express
export function getNotificationService(req: any): NotificationService | null {
  const io = req.app?.get('io');
  if (!io) {
    console.warn('[Notifications] Socket.IO nÃ£o disponÃ­vel no contexto');
    return null;
  }
  return new NotificationService(io);
}


========================================
ARQUIVO: ./server/utils/pdiRecommendations.ts
========================================
/**
 * Sistema de RecomendaÃ§Ãµes Inteligentes para PDI
 * Mapeia perfis psicomÃ©tricos para competÃªncias e sugestÃµes de desenvolvimento
 */

export interface PDIRecommendation {
  competency: string;
  description: string;
  actions: string[];
  courses: string[];
  priority: "high" | "medium" | "low";
  reasoning: string;
}

/**
 * Gera recomendaÃ§Ãµes baseadas em perfil DISC
 */
export function generateDISCRecommendations(profile: {
  D: number;
  I: number;
  S: number;
  C: number;
}): PDIRecommendation[] {
  const recommendations: PDIRecommendation[] = [];

  // DominÃ¢ncia Alta (D > 70)
  if (profile.D > 70) {
    recommendations.push({
      competency: "LideranÃ§a Assertiva",
      description: "Seu perfil indica forte orientaÃ§Ã£o para resultados e tomada de decisÃµes rÃ¡pidas",
      actions: [
        "Liderar projetos estratÃ©gicos com prazos desafiadores",
        "Mentorar colegas em tÃ©cnicas de negociaÃ§Ã£o",
        "Participar de comitÃªs de decisÃ£o estratÃ©gica",
      ],
      courses: [
        "LideranÃ§a de Alto Impacto",
        "GestÃ£o de Conflitos e NegociaÃ§Ã£o",
        "Tomada de DecisÃ£o EstratÃ©gica",
      ],
      priority: "high",
      reasoning: "Alta DominÃ¢ncia indica potencial para cargos de lideranÃ§a e gestÃ£o de mudanÃ§as",
    });

    recommendations.push({
      competency: "Empatia e Escuta Ativa",
      description: "Desenvolver habilidades de relacionamento para equilibrar o perfil orientado a resultados",
      actions: [
        "Praticar escuta ativa em reuniÃµes de equipe",
        "Solicitar feedback sobre estilo de comunicaÃ§Ã£o",
        "Participar de dinÃ¢micas de team building",
      ],
      courses: [
        "InteligÃªncia Emocional no Trabalho",
        "ComunicaÃ§Ã£o Assertiva e EmpÃ¡tica",
        "GestÃ£o de Equipes de Alta Performance",
      ],
      priority: "medium",
      reasoning: "Perfil D alto pode se beneficiar de desenvolver soft skills para melhor colaboraÃ§Ã£o",
    });
  }

  // InfluÃªncia Alta (I > 70)
  if (profile.I > 70) {
    recommendations.push({
      competency: "ComunicaÃ§Ã£o e Networking",
      description: "Seu perfil indica excelentes habilidades sociais e capacidade de influenciar",
      actions: [
        "Representar a empresa em eventos e conferÃªncias",
        "Liderar iniciativas de engajamento de equipe",
        "Atuar como embaixador da cultura organizacional",
      ],
      courses: [
        "Storytelling e ApresentaÃ§Ãµes Impactantes",
        "Marketing Pessoal e Networking EstratÃ©gico",
        "FacilitaÃ§Ã£o de Workshops e Treinamentos",
      ],
      priority: "high",
      reasoning: "Alta InfluÃªncia indica talento natural para comunicaÃ§Ã£o e engajamento de pessoas",
    });

    recommendations.push({
      competency: "Foco e OrganizaÃ§Ã£o",
      description: "Desenvolver estrutura e disciplina para complementar o perfil comunicativo",
      actions: [
        "Implementar sistema de gestÃ£o de tempo (ex: Pomodoro)",
        "Definir metas SMART para projetos pessoais",
        "Utilizar ferramentas de produtividade (Trello, Notion)",
      ],
      courses: [
        "GestÃ£o de Tempo e Produtividade",
        "Planejamento EstratÃ©gico Pessoal",
        "Metodologias Ãgeis para OrganizaÃ§Ã£o",
      ],
      priority: "medium",
      reasoning: "Perfil I alto pode se beneficiar de tÃ©cnicas de organizaÃ§Ã£o e foco",
    });
  }

  // Estabilidade Alta (S > 70)
  if (profile.S > 70) {
    recommendations.push({
      competency: "Trabalho em Equipe e ColaboraÃ§Ã£o",
      description: "Seu perfil indica excelente capacidade de colaboraÃ§Ã£o e suporte Ã  equipe",
      actions: [
        "Atuar como mediador em conflitos de equipe",
        "Mentorar novos colaboradores",
        "Liderar iniciativas de bem-estar organizacional",
      ],
      courses: [
        "FacilitaÃ§Ã£o de Grupos e MediaÃ§Ã£o",
        "Mentoria e Desenvolvimento de Pessoas",
        "Cultura Organizacional e Clima",
      ],
      priority: "high",
      reasoning: "Alta Estabilidade indica talento para criar ambientes colaborativos e harmoniosos",
    });

    recommendations.push({
      competency: "Adaptabilidade e InovaÃ§Ã£o",
      description: "Desenvolver flexibilidade para lidar com mudanÃ§as e incertezas",
      actions: [
        "Participar de projetos de inovaÃ§Ã£o e transformaÃ§Ã£o",
        "Experimentar novas metodologias de trabalho",
        "Buscar feedback sobre resistÃªncia a mudanÃ§as",
      ],
      courses: [
        "GestÃ£o de MudanÃ§as Organizacionais",
        "Design Thinking e InovaÃ§Ã£o",
        "ResiliÃªncia e Adaptabilidade",
      ],
      priority: "medium",
      reasoning: "Perfil S alto pode se beneficiar de desenvolver flexibilidade diante de mudanÃ§as",
    });
  }

  // Conformidade Alta (C > 70)
  if (profile.C > 70) {
    recommendations.push({
      competency: "AnÃ¡lise e Qualidade",
      description: "Seu perfil indica forte atenÃ§Ã£o a detalhes e busca por excelÃªncia",
      actions: [
        "Liderar projetos de melhoria de processos",
        "Atuar em auditorias e controles de qualidade",
        "Desenvolver padrÃµes e procedimentos tÃ©cnicos",
      ],
      courses: [
        "GestÃ£o da Qualidade e Processos",
        "AnÃ¡lise de Dados e Business Intelligence",
        "Auditoria e Compliance",
      ],
      priority: "high",
      reasoning: "Alta Conformidade indica talento para anÃ¡lise crÃ­tica e garantia de qualidade",
    });

    recommendations.push({
      competency: "ComunicaÃ§Ã£o e Visibilidade",
      description: "Desenvolver habilidades de comunicaÃ§Ã£o para compartilhar expertise",
      actions: [
        "Apresentar resultados de anÃ¡lises em reuniÃµes executivas",
        "Escrever artigos tÃ©cnicos internos",
        "Participar de comitÃªs tÃ©cnicos multidisciplinares",
      ],
      courses: [
        "ComunicaÃ§Ã£o TÃ©cnica Eficaz",
        "ApresentaÃ§Ãµes para Executivos",
        "InfluÃªncia sem Autoridade",
      ],
      priority: "medium",
      reasoning: "Perfil C alto pode se beneficiar de aumentar visibilidade e comunicaÃ§Ã£o",
    });
  }

  // Perfis Balanceados
  if (Math.max(profile.D, profile.I, profile.S, profile.C) < 70) {
    recommendations.push({
      competency: "Versatilidade e AdaptaÃ§Ã£o",
      description: "Seu perfil balanceado indica capacidade de atuar em diversos contextos",
      actions: [
        "Buscar projetos multidisciplinares",
        "Desenvolver especializaÃ§Ã£o em Ã¡rea de interesse",
        "Atuar como facilitador entre diferentes perfis",
      ],
      courses: [
        "GestÃ£o de Projetos Multidisciplinares",
        "LideranÃ§a Situacional",
        "Desenvolvimento de Carreira em T",
      ],
      priority: "medium",
      reasoning: "Perfil balanceado oferece flexibilidade, mas pode se beneficiar de especializaÃ§Ã£o",
    });
  }

  return recommendations;
}

/**
 * Gera recomendaÃ§Ãµes baseadas em perfil Big Five
 */
export function generateBigFiveRecommendations(profile: {
  O: number; // Abertura
  C: number; // Conscienciosidade
  E: number; // ExtroversÃ£o
  A: number; // Amabilidade
  N: number; // Neuroticismo
}): PDIRecommendation[] {
  const recommendations: PDIRecommendation[] = [];

  // Abertura Alta (O > 0.7)
  if (profile.O > 0.7) {
    recommendations.push({
      competency: "InovaÃ§Ã£o e Criatividade",
      description: "Alta abertura a experiÃªncias indica potencial criativo e inovador",
      actions: [
        "Liderar projetos de inovaÃ§Ã£o e transformaÃ§Ã£o digital",
        "Participar de hackathons e desafios de inovaÃ§Ã£o",
        "Propor melhorias em processos e produtos",
      ],
      courses: [
        "Design Thinking e InovaÃ§Ã£o",
        "Criatividade Aplicada aos NegÃ³cios",
        "TransformaÃ§Ã£o Digital",
      ],
      priority: "high",
      reasoning: "Alta Abertura favorece pensamento criativo e adaptaÃ§Ã£o a novidades",
    });
  }

  // Conscienciosidade Alta (C > 0.7)
  if (profile.C > 0.7) {
    recommendations.push({
      competency: "GestÃ£o de Projetos e Processos",
      description: "Alta conscienciosidade indica organizaÃ§Ã£o e responsabilidade",
      actions: [
        "Certificar-se em metodologias de gestÃ£o de projetos",
        "Liderar iniciativas de melhoria contÃ­nua",
        "Mentorar colegas em organizaÃ§Ã£o e planejamento",
      ],
      courses: [
        "PMP - Project Management Professional",
        "Lean Six Sigma",
        "OKRs e GestÃ£o por Objetivos",
      ],
      priority: "high",
      reasoning: "Alta Conscienciosidade favorece disciplina e entrega de resultados",
    });
  }

  // ExtroversÃ£o Alta (E > 0.7)
  if (profile.E > 0.7) {
    recommendations.push({
      competency: "LideranÃ§a e Engajamento",
      description: "Alta extroversÃ£o indica energia e capacidade de mobilizar pessoas",
      actions: [
        "Liderar equipes e projetos colaborativos",
        "Atuar como facilitador em workshops",
        "Representar a empresa externamente",
      ],
      courses: [
        "LideranÃ§a Inspiradora",
        "GestÃ£o de Equipes Remotas",
        "Public Speaking e OratÃ³ria",
      ],
      priority: "high",
      reasoning: "Alta ExtroversÃ£o favorece interaÃ§Ãµes sociais e lideranÃ§a de grupos",
    });
  }

  // Amabilidade Alta (A > 0.7)
  if (profile.A > 0.7) {
    recommendations.push({
      competency: "Relacionamento e ColaboraÃ§Ã£o",
      description: "Alta amabilidade indica empatia e cooperaÃ§Ã£o",
      actions: [
        "Atuar em projetos de responsabilidade social",
        "Mediar conflitos e facilitar consensos",
        "Desenvolver programas de bem-estar",
      ],
      courses: [
        "MediaÃ§Ã£o e ResoluÃ§Ã£o de Conflitos",
        "Coaching e Mentoria",
        "Responsabilidade Social Corporativa",
      ],
      priority: "medium",
      reasoning: "Alta Amabilidade favorece relacionamentos harmoniosos e cooperaÃ§Ã£o",
    });
  }

  // Neuroticismo Baixo (N < 0.3) - Estabilidade Emocional
  if (profile.N < 0.3) {
    recommendations.push({
      competency: "GestÃ£o de Crises e PressÃ£o",
      description: "Baixo neuroticismo indica estabilidade emocional sob pressÃ£o",
      actions: [
        "Liderar projetos crÃ­ticos e de alta pressÃ£o",
        "Atuar em situaÃ§Ãµes de crise e emergÃªncia",
        "Mentorar colegas em gestÃ£o de estresse",
      ],
      courses: [
        "GestÃ£o de Crises Organizacionais",
        "LideranÃ§a em Ambientes de Alta PressÃ£o",
        "ResiliÃªncia e Bem-Estar",
      ],
      priority: "high",
      reasoning: "Baixo Neuroticismo indica capacidade de manter calma em situaÃ§Ãµes desafiadoras",
    });
  }

  return recommendations;
}

/**
 * Gera recomendaÃ§Ãµes baseadas em Estilos de LideranÃ§a
 */
export function generateLeadershipRecommendations(profile: Record<string, number>): PDIRecommendation[] {
  const recommendations: PDIRecommendation[] = [];

  // Encontrar estilo predominante
  const styles = Object.entries(profile).sort((a, b) => b[1] - a[1]);
  const dominant = styles[0];

  if (dominant[0] === "transformacional" && dominant[1] > 70) {
    recommendations.push({
      competency: "LideranÃ§a Transformacional",
      description: "Seu estilo transformacional inspira e motiva equipes para mudanÃ§as",
      actions: [
        "Liderar projetos de transformaÃ§Ã£o organizacional",
        "Desenvolver visÃ£o estratÃ©gica de longo prazo",
        "Mentorar futuros lÃ­deres",
      ],
      courses: [
        "LideranÃ§a Transformacional AvanÃ§ada",
        "GestÃ£o de MudanÃ§as Complexas",
        "VisÃ£o EstratÃ©gica e InovaÃ§Ã£o",
      ],
      priority: "high",
      reasoning: "LideranÃ§a transformacional Ã© ideal para contextos de mudanÃ§a e inovaÃ§Ã£o",
    });
  }

  if (dominant[0] === "democratico" && dominant[1] > 70) {
    recommendations.push({
      competency: "LideranÃ§a Participativa",
      description: "Seu estilo democrÃ¡tico valoriza participaÃ§Ã£o e consenso",
      actions: [
        "Facilitar processos de tomada de decisÃ£o coletiva",
        "Implementar metodologias Ã¡geis e colaborativas",
        "Desenvolver cultura de feedback contÃ­nuo",
      ],
      courses: [
        "FacilitaÃ§Ã£o de Grupos e DecisÃµes Coletivas",
        "Metodologias Ãgeis para LideranÃ§a",
        "Cultura de Feedback e TransparÃªncia",
      ],
      priority: "high",
      reasoning: "LideranÃ§a democrÃ¡tica favorece engajamento e inovaÃ§Ã£o colaborativa",
    });
  }

  return recommendations;
}

/**
 * Gera recomendaÃ§Ãµes baseadas em Ã‚ncoras de Carreira
 */
export function generateCareerAnchorsRecommendations(profile: Record<string, number>): PDIRecommendation[] {
  const recommendations: PDIRecommendation[] = [];

  // Encontrar Ã¢ncora predominante
  const anchors = Object.entries(profile).sort((a, b) => b[1] - a[1]);
  const dominant = anchors[0];

  if (dominant[0] === "competencia_tecnica" && dominant[1] > 70) {
    recommendations.push({
      competency: "EspecializaÃ§Ã£o TÃ©cnica",
      description: "Sua Ã¢ncora indica motivaÃ§Ã£o por expertise e domÃ­nio tÃ©cnico",
      actions: [
        "Buscar certificaÃ§Ãµes tÃ©cnicas avanÃ§adas",
        "Participar de comunidades tÃ©cnicas e conferÃªncias",
        "Publicar artigos e compartilhar conhecimento",
      ],
      courses: [
        "CertificaÃ§Ãµes TÃ©cnicas AvanÃ§adas",
        "Arquitetura e Design de Sistemas",
        "Pesquisa e Desenvolvimento",
      ],
      priority: "high",
      reasoning: "Ã‚ncora de CompetÃªncia TÃ©cnica indica satisfaÃ§Ã£o em ser referÃªncia especialista",
    });
  }

  if (dominant[0] === "competencia_gerencial" && dominant[1] > 70) {
    recommendations.push({
      competency: "GestÃ£o e LideranÃ§a",
      description: "Sua Ã¢ncora indica motivaÃ§Ã£o por cargos de gestÃ£o e lideranÃ§a",
      actions: [
        "Buscar oportunidades de lideranÃ§a de equipes",
        "Desenvolver habilidades de gestÃ£o estratÃ©gica",
        "Participar de programas de desenvolvimento de lÃ­deres",
      ],
      courses: [
        "MBA em GestÃ£o EstratÃ©gica",
        "LideranÃ§a de Equipes de Alta Performance",
        "GestÃ£o Financeira e OrÃ§amentÃ¡ria",
      ],
      priority: "high",
      reasoning: "Ã‚ncora Gerencial indica aspiraÃ§Ã£o a posiÃ§Ãµes de lideranÃ§a organizacional",
    });
  }

  if (dominant[0] === "autonomia" && dominant[1] > 70) {
    recommendations.push({
      competency: "Autonomia e Empreendedorismo",
      description: "Sua Ã¢ncora indica necessidade de independÃªncia e liberdade",
      actions: [
        "Buscar projetos com alta autonomia",
        "Considerar trabalho remoto ou freelance",
        "Desenvolver projetos pessoais e side hustles",
      ],
      courses: [
        "Empreendedorismo e InovaÃ§Ã£o",
        "GestÃ£o de Carreira Independente",
        "Freelancing e Consultoria",
      ],
      priority: "high",
      reasoning: "Ã‚ncora de Autonomia indica satisfaÃ§Ã£o em ambientes com liberdade e flexibilidade",
    });
  }

  return recommendations;
}

/**
 * Gera recomendaÃ§Ãµes consolidadas baseadas em todos os testes disponÃ­veis
 */
export function generateConsolidatedRecommendations(tests: {
  disc?: any;
  bigfive?: any;
  leadership?: any;
  careeranchors?: any;
}): PDIRecommendation[] {
  let allRecommendations: PDIRecommendation[] = [];

  if (tests.disc) {
    allRecommendations = allRecommendations.concat(generateDISCRecommendations(tests.disc));
  }

  if (tests.bigfive) {
    allRecommendations = allRecommendations.concat(generateBigFiveRecommendations(tests.bigfive));
  }

  if (tests.leadership) {
    allRecommendations = allRecommendations.concat(generateLeadershipRecommendations(tests.leadership));
  }

  if (tests.careeranchors) {
    allRecommendations = allRecommendations.concat(generateCareerAnchorsRecommendations(tests.careeranchors));
  }

  // Remover duplicatas e priorizar
  const uniqueRecommendations = allRecommendations.reduce((acc, rec) => {
    const existing = acc.find(r => r.competency === rec.competency);
    if (!existing) {
      acc.push(rec);
    }
    return acc;
  }, [] as PDIRecommendation[]);

  // Ordenar por prioridade
  return uniqueRecommendations.sort((a, b) => {
    const priorityOrder = { high: 0, medium: 1, low: 2 };
    return priorityOrder[a.priority] - priorityOrder[b.priority];
  });
}


========================================
ARQUIVO: ./server/utils/permissions.ts
========================================
import { getDb } from "../db";
import { employees, users } from "../../drizzle/schema";
import { eq, or, and, inArray } from "drizzle-orm";

/**
 * Verifica se o usuÃ¡rio Ã© administrador (verifica na tabela users)
 */
export async function isAdmin(userId: number): Promise<boolean> {
  const db = await getDb();
  if (!db) return false;

  // Busca o employee para pegar o userId
  const employee = await db.select({ userId: employees.userId }).from(employees).where(eq(employees.id, userId)).limit(1);
  if (employee.length === 0 || !employee[0].userId) return false;

  // Busca o user para verificar role
  const user = await db.select({ role: users.role }).from(users).where(eq(users.id, employee[0].userId)).limit(1);
  return user.length > 0 && user[0].role === 'admin';
}

/**
 * Verifica se o usuÃ¡rio Ã© lÃ­der (tem subordinados diretos)
 */
export async function isLeader(userId: number): Promise<boolean> {
  const db = await getDb();
  if (!db) return false;

  const subordinates = await db
    .select()
    .from(employees)
    .where(eq(employees.managerId, userId))
    .limit(1);

  return subordinates.length > 0;
}

/**
 * Retorna lista de IDs dos subordinados diretos do lÃ­der
 */
export async function getDirectSubordinates(leaderId: number): Promise<number[]> {
  const db = await getDb();
  if (!db) return [];

  const subordinates = await db
    .select({ id: employees.id })
    .from(employees)
    .where(eq(employees.managerId, leaderId));

  return subordinates.map(s => s.id);
}

/**
 * Retorna lista de IDs de todos os subordinados (diretos e indiretos) do lÃ­der
 */
export async function getAllSubordinates(leaderId: number): Promise<number[]> {
  const db = await getDb();
  if (!db) return [];

  const allSubordinates: number[] = [];
  const queue: number[] = [leaderId];
  const visited = new Set<number>();

  while (queue.length > 0) {
    const currentId = queue.shift()!;
    if (visited.has(currentId)) continue;
    visited.add(currentId);

    const directSubs = await db
      .select({ id: employees.id })
      .from(employees)
      .where(eq(employees.managerId, currentId));

    for (const sub of directSubs) {
      allSubordinates.push(sub.id);
      queue.push(sub.id);
    }
  }

  return allSubordinates;
}

/**
 * Retorna lista de IDs dos colaboradores do mesmo centro de custos
 */
export async function getEmployeesByCostCenter(costCenter: string): Promise<number[]> {
  const db = await getDb();
  if (!db) return [];

  const employees_list = await db
    .select({ id: employees.id })
    .from(employees)
    .where(eq(employees.costCenter, costCenter));

  return employees_list.map(e => e.id);
}

/**
 * Verifica se o usuÃ¡rio pode visualizar dados do colaborador
 * Admin: pode ver todos
 * LÃ­der: pode ver apenas seus subordinados diretos e indiretos
 * UsuÃ¡rio: pode ver apenas seus prÃ³prios dados
 */
export async function canViewEmployee(userId: number, targetEmployeeId: number): Promise<boolean> {
  if (userId === targetEmployeeId) return true;
  if (await isAdmin(userId)) return true;

  const subordinates = await getAllSubordinates(userId);
  return subordinates.includes(targetEmployeeId);
}

/**
 * Verifica se o usuÃ¡rio pode fazer consenso/calibraÃ§Ã£o do colaborador
 * Admin: pode fazer consenso de todos
 * LÃ­der direto: pode fazer consenso apenas dos subordinados diretos
 */
export async function canDoConsensus(userId: number, targetEmployeeId: number): Promise<boolean> {
  if (await isAdmin(userId)) return true;

  const directSubordinates = await getDirectSubordinates(userId);
  return directSubordinates.includes(targetEmployeeId);
}

/**
 * Verifica se o usuÃ¡rio pode aprovar avaliaÃ§Ã£o do colaborador
 * Admin: pode aprovar todas
 * LÃ­der direto: pode aprovar apenas dos subordinados diretos
 */
export async function canApproveEvaluation(userId: number, targetEmployeeId: number): Promise<boolean> {
  return await canDoConsensus(userId, targetEmployeeId);
}

/**
 * Retorna lista de IDs de colaboradores que o usuÃ¡rio pode visualizar
 */
export async function getVisibleEmployees(userId: number): Promise<number[]> {
  if (await isAdmin(userId)) {
    const db = await getDb();
    if (!db) return [];
    
    const all = await db.select({ id: employees.id }).from(employees);
    return all.map(e => e.id);
  }

  const subordinates = await getAllSubordinates(userId);
  return [userId, ...subordinates];
}

/**
 * Retorna centro de custos do colaborador
 */
export async function getEmployeeCostCenter(employeeId: number): Promise<string | null> {
  const db = await getDb();
  if (!db) return null;

  const employee = await db
    .select({ costCenter: employees.costCenter })
    .from(employees)
    .where(eq(employees.id, employeeId))
    .limit(1);

  return employee.length > 0 ? employee[0].costCenter : null;
}


========================================
ARQUIVO: ./server/utils/testInviteTemplate.ts
========================================
// Template de email para convite de testes psicomÃ©tricos

export function createTestInviteEmail(data: {
  employeeName: string;
  testType: string;
  testName: string;
  testDescription: string;
  estimatedTime: string;
  testUrl: string;
}) {
  return {
    subject: `Convite: ${data.testName} - Sistema AVD UISA`,
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body { 
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
              line-height: 1.6; 
              color: #333; 
              background-color: #f5f5f5;
              margin: 0;
              padding: 0;
            }
            .container { 
              max-width: 600px; 
              margin: 20px auto; 
              background: white;
              border-radius: 12px;
              overflow: hidden;
              box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .header { 
              background: linear-gradient(135deg, #F39200 0%, #FF6B35 100%); 
              color: white; 
              padding: 40px 30px; 
              text-align: center; 
            }
            .header h1 {
              margin: 0;
              font-size: 28px;
              font-weight: 600;
            }
            .header .icon {
              font-size: 48px;
              margin-bottom: 10px;
            }
            .content { 
              padding: 40px 30px; 
            }
            .content p {
              margin: 15px 0;
              font-size: 16px;
            }
            .test-info {
              background: #FFF8F0;
              border-left: 4px solid #F39200;
              padding: 20px;
              margin: 25px 0;
              border-radius: 4px;
            }
            .test-info h3 {
              margin: 0 0 10px 0;
              color: #F39200;
              font-size: 20px;
            }
            .test-info p {
              margin: 8px 0;
              font-size: 15px;
            }
            .test-info .label {
              font-weight: 600;
              color: #666;
            }
            .button { 
              display: inline-block; 
              padding: 16px 40px; 
              background: linear-gradient(135deg, #F39200 0%, #FF6B35 100%);
              color: white; 
              text-decoration: none; 
              border-radius: 8px; 
              margin: 30px 0;
              font-weight: 600;
              font-size: 16px;
              box-shadow: 0 4px 12px rgba(243, 146, 0, 0.3);
              transition: transform 0.2s;
            }
            .button:hover {
              transform: translateY(-2px);
              box-shadow: 0 6px 16px rgba(243, 146, 0, 0.4);
            }
            .benefits {
              background: #F0F9FF;
              padding: 20px;
              border-radius: 8px;
              margin: 25px 0;
            }
            .benefits h4 {
              margin: 0 0 15px 0;
              color: #1E3A5F;
              font-size: 18px;
            }
            .benefits ul {
              margin: 0;
              padding-left: 20px;
            }
            .benefits li {
              margin: 8px 0;
              color: #555;
            }
            .footer { 
              background: #f8f8f8;
              text-align: center; 
              padding: 30px;
              color: #666; 
              font-size: 13px;
              border-top: 1px solid #e0e0e0;
            }
            .footer p {
              margin: 5px 0;
            }
            .logo {
              color: #F39200;
              font-weight: 700;
              font-size: 16px;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <div class="icon">ðŸ§ </div>
              <h1>Convite para Teste PsicomÃ©trico</h1>
            </div>
            <div class="content">
              <p>OlÃ¡, <strong>${data.employeeName}</strong>!</p>
              
              <p>VocÃª foi convidado(a) a realizar um teste psicomÃ©trico como parte do processo de desenvolvimento profissional da UISA.</p>
              
              <div class="test-info">
                <h3>${data.testName}</h3>
                <p><span class="label">Tipo:</span> ${data.testType}</p>
                <p><span class="label">Tempo estimado:</span> ${data.estimatedTime}</p>
                <p style="margin-top: 15px;">${data.testDescription}</p>
              </div>

              <div class="benefits">
                <h4>ðŸ“Š Por que fazer este teste?</h4>
                <ul>
                  <li>Conhecer melhor seu perfil comportamental e competÃªncias</li>
                  <li>Identificar pontos fortes e oportunidades de desenvolvimento</li>
                  <li>Receber recomendaÃ§Ãµes personalizadas para seu PDI</li>
                  <li>Contribuir para seu crescimento profissional na UISA</li>
                </ul>
              </div>

              <p><strong>â° Importante:</strong> Reserve um momento tranquilo para responder com sinceridade. NÃ£o hÃ¡ respostas certas ou erradas!</p>
              
              <div style="text-align: center;">
                <a href="${data.testUrl}" class="button">ðŸš€ Iniciar Teste Agora</a>
              </div>

              <p style="margin-top: 30px; font-size: 14px; color: #666;">
                <strong>DÃºvidas?</strong> Entre em contato com o RH pelo email avd@uisa.com.br
              </p>
            </div>
            <div class="footer">
              <p class="logo">Sistema AVD UISA</p>
              <p>AvaliaÃ§Ã£o de Desempenho e GestÃ£o de Talentos</p>
              <p style="margin-top: 15px;">Este Ã© um e-mail automÃ¡tico, por favor nÃ£o responda.</p>
            </div>
          </div>
        </body>
      </html>
    `,
  };
}

// Mapeamento de informaÃ§Ãµes dos testes
export const testInfo = {
  disc: {
    name: "Teste DISC",
    type: "AvaliaÃ§Ã£o Comportamental",
    description: "Identifica seu estilo comportamental predominante entre DominÃ¢ncia, InfluÃªncia, Estabilidade e Conformidade. Ajuda a entender como vocÃª se comunica, toma decisÃµes e interage com a equipe.",
    estimatedTime: "10-15 minutos",
    questionCount: 40,
  },
  bigfive: {
    name: "Teste Big Five (OCEAN)",
    type: "AvaliaÃ§Ã£o de Personalidade",
    description: "Avalia as cinco grandes dimensÃµes da personalidade: Abertura, Conscienciosidade, ExtroversÃ£o, Amabilidade e Neuroticismo. Fornece um perfil completo de suas caracterÃ­sticas pessoais.",
    estimatedTime: "12-18 minutos",
    questionCount: 50,
  },
  mbti: {
    name: "Teste MBTI",
    type: "Indicador de Tipo de Personalidade",
    description: "Identifica seu tipo de personalidade entre 16 possÃ­veis combinaÃ§Ãµes, baseado em quatro dimensÃµes: ExtroversÃ£o/IntroversÃ£o, SensaÃ§Ã£o/IntuiÃ§Ã£o, Pensamento/Sentimento e Julgamento/PercepÃ§Ã£o.",
    estimatedTime: "8-12 minutos",
    questionCount: 20,
  },
  ie: {
    name: "Teste de InteligÃªncia Emocional",
    type: "AvaliaÃ§Ã£o de CompetÃªncias Emocionais",
    description: "Mede suas habilidades de AutoconsciÃªncia, AutorregulaÃ§Ã£o, MotivaÃ§Ã£o, Empatia e Habilidades Sociais. Baseado no modelo de Daniel Goleman.",
    estimatedTime: "15-20 minutos",
    questionCount: 25,
  },
  vark: {
    name: "Teste VARK",
    type: "Estilos de Aprendizagem",
    description: "Identifica seu estilo preferido de aprendizagem entre Visual, Auditivo, Leitura/Escrita e CinestÃ©sico. Ãštil para personalizar seu desenvolvimento profissional.",
    estimatedTime: "8-10 minutos",
    questionCount: 20,
  },
  leadership: {
    name: "Teste de Estilos de LideranÃ§a",
    type: "AvaliaÃ§Ã£o de LideranÃ§a",
    description: "Identifica seus estilos de lideranÃ§a predominantes entre AutocrÃ¡tico, DemocrÃ¡tico, Transformacional, Transacional, Coaching e Laissez-faire. Baseado em teorias de Lewin, Bass e Goleman.",
    estimatedTime: "10-12 minutos",
    questionCount: 30,
  },
  careeranchors: {
    name: "Teste de Ã‚ncoras de Carreira",
    type: "AvaliaÃ§Ã£o de MotivaÃ§Ã£o Profissional",
    description: "Identifica suas Ã¢ncoras de carreira segundo Edgar Schein: CompetÃªncia TÃ©cnica, CompetÃªncia Gerencial, Autonomia, SeguranÃ§a, Criatividade Empreendedora, ServiÃ§o, Desafio e Estilo de Vida.",
    estimatedTime: "12-15 minutos",
    questionCount: 40,
  },
};


========================================
ARQUIVO: ./server/utils/totvsIntegration.ts
========================================
import axios from "axios";

// TOTVS RM API Configuration
const TOTVS_CONFIG = {
  baseURL: process.env.TOTVS_RM_BASE_URL || "https://api.totvs.com.br/rm",
  appKey: process.env.TOTVS_RM_APP_KEY || "",
  appSecret: process.env.TOTVS_RM_APP_SECRET || "",
  tenant: process.env.TOTVS_RM_TENANT || "",
};

interface TotvsEmployee {
  CHAPA: string; // Employee ID
  NOME: string; // Name
  CPF: string; // CPF
  EMAIL: string; // Email
  CODSECAO: string; // Department code
  SECAO: string; // Department name
  CODFUNCAO: string; // Position code
  FUNCAO: string; // Position title
  DATAADMISSAO: string; // Admission date
  SITUACAO: string; // Status (A=Active, D=Dismissed)
}

interface TotvsDepartment {
  CODIGO: string;
  DESCRICAO: string;
  CODCOLIGADA: number;
}

interface TotvsPosition {
  CODIGO: string;
  NOME: string;
  CODCOLIGADA: number;
}

class TotvsIntegrationService {
  private accessToken: string | null = null;
  private tokenExpiry: Date | null = null;

  /**
   * Authenticate with TOTVS RM API
   */
  private async authenticate(): Promise<string> {
    try {
      // Check if token is still valid
      if (this.accessToken && this.tokenExpiry && this.tokenExpiry > new Date()) {
        return this.accessToken;
      }

      const response = await axios.post(
        `${TOTVS_CONFIG.baseURL}/oauth/token`,
        {
          grant_type: "client_credentials",
          client_id: TOTVS_CONFIG.appKey,
          client_secret: TOTVS_CONFIG.appSecret,
        },
        {
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
        }
      );

      this.accessToken = response.data.access_token || null;
      // Token expires in 1 hour (3600 seconds)
      this.tokenExpiry = new Date(Date.now() + response.data.expires_in * 1000);

      console.log("[TOTVS] Authentication successful");
      return this.accessToken!;
    } catch (error) {
      console.error("[TOTVS] Authentication failed:", error);
      throw new Error("Failed to authenticate with TOTVS RM");
    }
  }

  /**
   * Make authenticated request to TOTVS API
   */
  private async request<T>(endpoint: string, params?: Record<string, any>): Promise<T> {
    const token = await this.authenticate();

    try {
      const response = await axios.get(`${TOTVS_CONFIG.baseURL}${endpoint}`, {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        params: {
          ...params,
          tenant: TOTVS_CONFIG.tenant,
        },
      });

      return response.data;
    } catch (error) {
      console.error(`[TOTVS] Request failed for ${endpoint}:`, error);
      throw error;
    }
  }

  /**
   * Sync employees from TOTVS RM
   */
  async syncEmployees(): Promise<{
    success: boolean;
    synced: number;
    errors: number;
    details: any[];
  }> {
    console.log("[TOTVS] Starting employee sync...");

    try {
      // Fetch employees from TOTVS
      const employees = await this.request<TotvsEmployee[]>("/api/framework/v1/funcionarios", {
        $filter: "SITUACAO eq 'A'", // Only active employees
      });

      console.log(`[TOTVS] Found ${employees.length} active employees`);

      const results = {
        success: true,
        synced: 0,
        errors: 0,
        details: [] as any[],
      };

      // Process each employee
      for (const emp of employees) {
        try {
          // Map TOTVS data to AVD format
          const employeeData = {
            externalId: emp.CHAPA,
            name: emp.NOME,
            cpf: emp.CPF,
            email: emp.EMAIL,
            departmentCode: emp.CODSECAO,
            departmentName: emp.SECAO,
            positionCode: emp.CODFUNCAO,
            positionTitle: emp.FUNCAO,
            admissionDate: new Date(emp.DATAADMISSAO),
            status: emp.SITUACAO === "A" ? "active" : "inactive",
          };

          // TODO: Call AVD API to upsert employee
          // await db.upsertEmployee(employeeData);

          results.synced++;
          results.details.push({
            id: emp.CHAPA,
            name: emp.NOME,
            status: "synced",
          });
        } catch (error) {
          console.error(`[TOTVS] Error syncing employee ${emp.CHAPA}:`, error);
          results.errors++;
          results.details.push({
            id: emp.CHAPA,
            name: emp.NOME,
            status: "error",
            error: error instanceof Error ? error.message : "Unknown error",
          });
        }
      }

      console.log(
        `[TOTVS] Employee sync completed: ${results.synced} synced, ${results.errors} errors`
      );

      return results;
    } catch (error) {
      console.error("[TOTVS] Employee sync failed:", error);
      return {
        success: false,
        synced: 0,
        errors: 1,
        details: [
          {
            status: "error",
            error: error instanceof Error ? error.message : "Unknown error",
          },
        ],
      };
    }
  }

  /**
   * Sync departments from TOTVS RM
   */
  async syncDepartments(): Promise<{
    success: boolean;
    synced: number;
    errors: number;
  }> {
    console.log("[TOTVS] Starting department sync...");

    try {
      const departments = await this.request<TotvsDepartment[]>(
        "/api/framework/v1/secoes"
      );

      console.log(`[TOTVS] Found ${departments.length} departments`);

      let synced = 0;
      let errors = 0;

      for (const dept of departments) {
        try {
          // TODO: Call AVD API to upsert department
          // await db.upsertDepartment({
          //   externalId: dept.CODIGO,
          //   name: dept.DESCRICAO,
          // });

          synced++;
        } catch (error) {
          console.error(`[TOTVS] Error syncing department ${dept.CODIGO}:`, error);
          errors++;
        }
      }

      console.log(`[TOTVS] Department sync completed: ${synced} synced, ${errors} errors`);

      return { success: true, synced, errors };
    } catch (error) {
      console.error("[TOTVS] Department sync failed:", error);
      return { success: false, synced: 0, errors: 1 };
    }
  }

  /**
   * Sync positions from TOTVS RM
   */
  async syncPositions(): Promise<{
    success: boolean;
    synced: number;
    errors: number;
  }> {
    console.log("[TOTVS] Starting position sync...");

    try {
      const positions = await this.request<TotvsPosition[]>(
        "/api/framework/v1/funcoes"
      );

      console.log(`[TOTVS] Found ${positions.length} positions`);

      let synced = 0;
      let errors = 0;

      for (const pos of positions) {
        try {
          // TODO: Call AVD API to upsert position
          // await db.upsertPosition({
          //   externalId: pos.CODIGO,
          //   title: pos.NOME,
          // });

          synced++;
        } catch (error) {
          console.error(`[TOTVS] Error syncing position ${pos.CODIGO}:`, error);
          errors++;
        }
      }

      console.log(`[TOTVS] Position sync completed: ${synced} synced, ${errors} errors`);

      return { success: true, synced, errors };
    } catch (error) {
      console.error("[TOTVS] Position sync failed:", error);
      return { success: false, synced: 0, errors: 1 };
    }
  }

  /**
   * Full sync: departments, positions, and employees
   */
  async fullSync(): Promise<{
    success: boolean;
    departments: { synced: number; errors: number };
    positions: { synced: number; errors: number };
    employees: { synced: number; errors: number };
    duration: number;
  }> {
    const startTime = Date.now();
    console.log("[TOTVS] Starting full sync...");

    try {
      // Sync in order: departments â†’ positions â†’ employees
      const deptResult = await this.syncDepartments();
      const posResult = await this.syncPositions();
      const empResult = await this.syncEmployees();

      const duration = Date.now() - startTime;

      console.log(`[TOTVS] Full sync completed in ${duration}ms`);

      return {
        success: true,
        departments: { synced: deptResult.synced, errors: deptResult.errors },
        positions: { synced: posResult.synced, errors: posResult.errors },
        employees: { synced: empResult.synced, errors: empResult.errors },
        duration,
      };
    } catch (error) {
      console.error("[TOTVS] Full sync failed:", error);
      return {
        success: false,
        departments: { synced: 0, errors: 0 },
        positions: { synced: 0, errors: 0 },
        employees: { synced: 0, errors: 0 },
        duration: Date.now() - startTime,
      };
    }
  }

  /**
   * Test connection to TOTVS RM
   */
  async testConnection(): Promise<{ success: boolean; message: string }> {
    try {
      await this.authenticate();
      return {
        success: true,
        message: "Connection to TOTVS RM successful",
      };
    } catch (error) {
      return {
        success: false,
        message: error instanceof Error ? error.message : "Connection failed",
      };
    }
  }
}

// Export singleton instance
export const totvsIntegration = new TotvsIntegrationService();

// Export types
export type { TotvsEmployee, TotvsDepartment, TotvsPosition };


========================================
ARQUIVO: ./server/utils/docxParser.ts
========================================
import mammoth from "mammoth";

/**
 * Interface para dados extraÃ­dos de um arquivo .docx de descriÃ§Ã£o de cargo
 */
export interface ParsedJobDescription {
  // InformaÃ§Ãµes BÃ¡sicas
  cargo?: string;
  departamento?: string;
  cbo?: string;
  divisao?: string;
  reporteA?: string;
  dataRevisao?: string;
  
  // Objetivo Principal
  objetivoPrincipal?: string;
  
  // Responsabilidades (por categoria)
  responsabilidades?: {
    processo?: string[];
    analiseKPI?: string[];
    planejamento?: string[];
    budget?: string[];
    resultados?: string[];
  };
  
  // Conhecimento TÃ©cnico
  conhecimentos?: Array<{
    conhecimento: string;
    nivel: "basico" | "intermediario" | "avancado" | "obrigatorio";
  }>;
  
  // Treinamento ObrigatÃ³rio
  treinamentos?: string[];
  
  // CompetÃªncias/Habilidades
  competencias?: string[];
  
  // QualificaÃ§Ã£o Desejada
  qualificacao?: {
    formacao?: string;
    experiencia?: string;
  };
  
  // e-Social
  eSocial?: {
    pcmso?: string;
    ppra?: string;
  };
  
  // Metadados
  fileName?: string;
  parseErrors?: string[];
}

/**
 * Extrai texto de um arquivo .docx usando mammoth
 */
export async function extractTextFromDocx(buffer: Buffer): Promise<string> {
  try {
    const result = await mammoth.extractRawText({ buffer });
    return result.value;
  } catch (error) {
    throw new Error(`Erro ao extrair texto do .docx: ${error instanceof Error ? error.message : String(error)}`);
  }
}

/**
 * Extrai HTML de um arquivo .docx usando mammoth (preserva formataÃ§Ã£o)
 */
export async function extractHtmlFromDocx(buffer: Buffer): Promise<string> {
  try {
    const result = await mammoth.convertToHtml({ buffer });
    return result.value;
  } catch (error) {
    throw new Error(`Erro ao extrair HTML do .docx: ${error instanceof Error ? error.message : String(error)}`);
  }
}

/**
 * Parser principal: extrai dados estruturados de um arquivo .docx de descriÃ§Ã£o de cargo
 */
export async function parseJobDescriptionDocx(buffer: Buffer, fileName: string): Promise<ParsedJobDescription> {
  const errors: string[] = [];
  const parsed: ParsedJobDescription = {
    fileName,
    parseErrors: errors,
  };
  
  try {
    // Extrair texto bruto
    const text = await extractTextFromDocx(buffer);
    
    // Dividir em linhas para anÃ¡lise
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    
    // 1. Extrair InformaÃ§Ãµes BÃ¡sicas
    parsed.cargo = extractField(lines, /^cargo[:\s]+(.+)/i);
    parsed.departamento = extractField(lines, /^depart[ao]mento[:\s]+(.+)/i);
    parsed.cbo = extractField(lines, /^cbo[:\s]+(.+)/i);
    parsed.divisao = extractField(lines, /^divis[Ã£a]o[:\s]+(.+)/i);
    parsed.reporteA = extractField(lines, /^reporte\s+a[:\s]+(.+)/i);
    parsed.dataRevisao = extractField(lines, /^data\s+de\s+revis[Ã£a]o[:\s]+(.+)/i);
    
    // 2. Extrair Objetivo Principal
    const objetivoIdx = findSectionIndex(lines, /objetivo\s+principal/i);
    if (objetivoIdx !== -1) {
      parsed.objetivoPrincipal = extractSectionContent(lines, objetivoIdx);
    }
    
    // 3. Extrair Responsabilidades
    const respIdx = findSectionIndex(lines, /responsabilidades/i);
    if (respIdx !== -1) {
      parsed.responsabilidades = {
        processo: extractListItems(lines, respIdx, /processo/i),
        analiseKPI: extractListItems(lines, respIdx, /an[aÃ¡]lise\s+de\s+kpi/i),
        planejamento: extractListItems(lines, respIdx, /planejamento/i),
        budget: extractListItems(lines, respIdx, /budget|or[Ã§c]amento/i),
        resultados: extractListItems(lines, respIdx, /resultados/i),
      };
    }
    
    // 4. Extrair Conhecimentos TÃ©cnicos
    const conhecIdx = findSectionIndex(lines, /conhecimento\s+t[eÃ©]cnico/i);
    if (conhecIdx !== -1) {
      parsed.conhecimentos = extractKnowledgeItems(lines, conhecIdx);
    }
    
    // 5. Extrair Treinamentos ObrigatÃ³rios
    const treinIdx = findSectionIndex(lines, /treinamento\s+obrigat[Ã³o]rio/i);
    if (treinIdx !== -1) {
      parsed.treinamentos = extractListItems(lines, treinIdx);
    }
    
    // 6. Extrair CompetÃªncias/Habilidades
    const compIdx = findSectionIndex(lines, /compet[Ãªe]ncias|habilidades/i);
    if (compIdx !== -1) {
      parsed.competencias = extractListItems(lines, compIdx);
    }
    
    // 7. Extrair QualificaÃ§Ã£o Desejada
    const qualIdx = findSectionIndex(lines, /qualifica[Ã§c][Ã£a]o\s+desejada/i);
    if (qualIdx !== -1) {
      parsed.qualificacao = {
        formacao: extractField(lines, /forma[Ã§c][Ã£a]o[:\s]+(.+)/i, qualIdx),
        experiencia: extractField(lines, /experi[Ãªe]ncia[:\s]+(.+)/i, qualIdx),
      };
    }
    
    // 8. Extrair e-Social
    const eSocialIdx = findSectionIndex(lines, /e-social/i);
    if (eSocialIdx !== -1) {
      parsed.eSocial = {
        pcmso: extractField(lines, /pcmso[:\s]+(.+)/i, eSocialIdx),
        ppra: extractField(lines, /ppra[:\s]+(.+)/i, eSocialIdx),
      };
    }
    
  } catch (error) {
    errors.push(`Erro geral no parsing: ${error instanceof Error ? error.message : String(error)}`);
  }
  
  return parsed;
}

/**
 * FunÃ§Ãµes auxiliares de parsing
 */

function extractField(lines: string[], pattern: RegExp, startIdx = 0): string | undefined {
  for (let i = startIdx; i < lines.length; i++) {
    const match = lines[i].match(pattern);
    if (match && match[1]) {
      return match[1].trim();
    }
  }
  return undefined;
}

function findSectionIndex(lines: string[], pattern: RegExp): number {
  return lines.findIndex(line => pattern.test(line));
}

function extractSectionContent(lines: string[], startIdx: number, maxLines = 10): string {
  const content: string[] = [];
  for (let i = startIdx + 1; i < Math.min(startIdx + maxLines, lines.length); i++) {
    // Parar se encontrar outra seÃ§Ã£o (linhas em maiÃºsculas ou com padrÃµes de tÃ­tulo)
    if (lines[i].match(/^[A-ZÃÃ‰ÃÃ“ÃšÃ‚ÃŠÃ”ÃƒÃ•\s]+$/) || lines[i].match(/^\d+\./)) {
      break;
    }
    content.push(lines[i]);
  }
  return content.join(' ').trim();
}

function extractListItems(lines: string[], startIdx: number, categoryPattern?: RegExp): string[] {
  const items: string[] = [];
  let inCategory = !categoryPattern; // Se nÃ£o tem padrÃ£o de categoria, aceita tudo
  
  for (let i = startIdx + 1; i < lines.length; i++) {
    const line = lines[i];
    
    // Parar se encontrar outra seÃ§Ã£o principal
    if (line.match(/^[A-ZÃÃ‰ÃÃ“ÃšÃ‚ÃŠÃ”ÃƒÃ•\s]{10,}$/)) {
      break;
    }
    
    // Verificar se entrou na categoria desejada
    if (categoryPattern && categoryPattern.test(line)) {
      inCategory = true;
      continue;
    }
    
    // Verificar se saiu da categoria (encontrou outra categoria)
    if (categoryPattern && line.match(/^[A-Z][a-zÃ¡Ã©Ã­Ã³ÃºÃ¢ÃªÃ´Ã£Ãµ\s]+:$/i)) {
      inCategory = false;
      continue;
    }
    
    // Extrair itens de lista (comeÃ§am com -, â€¢, *, ou nÃºmeros)
    if (inCategory && line.match(/^[-â€¢*\d]+[\.\)]\s+(.+)/)) {
      const match = line.match(/^[-â€¢*\d]+[\.\)]\s+(.+)/);
      if (match && match[1]) {
        items.push(match[1].trim());
      }
    }
  }
  
  return items;
}

function extractKnowledgeItems(lines: string[], startIdx: number): Array<{ conhecimento: string; nivel: "basico" | "intermediario" | "avancado" | "obrigatorio" }> {
  const items: Array<{ conhecimento: string; nivel: "basico" | "intermediario" | "avancado" | "obrigatorio" }> = [];
  
  for (let i = startIdx + 1; i < lines.length; i++) {
    const line = lines[i];
    
    // Parar se encontrar outra seÃ§Ã£o
    if (line.match(/^[A-ZÃÃ‰ÃÃ“ÃšÃ‚ÃŠÃ”ÃƒÃ•\s]{10,}$/)) {
      break;
    }
    
    // Tentar extrair conhecimento e nÃ­vel
    const match = line.match(/^[-â€¢*\d]+[\.\)]\s+(.+?)\s*[-â€“â€”]\s*(b[aÃ¡]sico|intermedi[aÃ¡]rio|avan[Ã§c]ado|obrigat[Ã³o]rio)/i);
    if (match) {
      const conhecimento = match[1].trim();
      let nivel: "basico" | "intermediario" | "avancado" | "obrigatorio" = "basico";
      
      const nivelStr = match[2].toLowerCase();
      if (nivelStr.includes("intermedi")) nivel = "intermediario";
      else if (nivelStr.includes("avan")) nivel = "avancado";
      else if (nivelStr.includes("obrigat")) nivel = "obrigatorio";
      
      items.push({ conhecimento, nivel });
    }
  }
  
  return items;
}

/**
 * Valida se os dados extraÃ­dos estÃ£o completos
 */
export function validateParsedData(parsed: ParsedJobDescription): { isValid: boolean; missingFields: string[] } {
  const missingFields: string[] = [];
  
  if (!parsed.cargo) missingFields.push("Cargo");
  if (!parsed.departamento) missingFields.push("Departamento");
  if (!parsed.objetivoPrincipal) missingFields.push("Objetivo Principal");
  if (!parsed.responsabilidades || Object.values(parsed.responsabilidades).every(r => !r || r.length === 0)) {
    missingFields.push("Responsabilidades");
  }
  
  return {
    isValid: missingFields.length === 0,
    missingFields,
  };
}


========================================
ARQUIVO: ./server/websocket.ts
========================================
import { Server as SocketIOServer } from "socket.io";
import type { Server as HTTPServer } from "http";

export function setupWebSocket(httpServer: HTTPServer) {
  const io = new SocketIOServer(httpServer, {
    cors: {
      origin: "*",
      methods: ["GET", "POST"],
    },
  });

  io.on("connection", (socket) => {
    console.log(`[WebSocket] Cliente conectado: ${socket.id}`);

    // AutenticaÃ§Ã£o do usuÃ¡rio
    const userId = socket.handshake.auth.userId;
    if (userId) {
      socket.join(`user:${userId}`);
      console.log(`[WebSocket] UsuÃ¡rio ${userId} entrou na sala`);
    }

    socket.on("disconnect", () => {
      console.log(`[WebSocket] Cliente desconectado: ${socket.id}`);
    });
  });

  return io;
}

// Tipos de notificaÃ§Ã£o
export interface NotificationPayload {
  type: "meta" | "avaliacao" | "pdi" | "feedback" | "prazo";
  title: string;
  message: string;
  link?: string;
}

// FunÃ§Ãµes helper para enviar notificaÃ§Ãµes
export function sendNotificationToUser(
  io: SocketIOServer,
  userId: number,
  notification: NotificationPayload
) {
  io.to(`user:${userId}`).emit("notification", notification);
  console.log(`[WebSocket] NotificaÃ§Ã£o enviada para usuÃ¡rio ${userId}:`, notification.title);
}

export function sendNotificationToAll(
  io: SocketIOServer,
  notification: NotificationPayload
) {
  io.emit("notification", notification);
  console.log(`[WebSocket] NotificaÃ§Ã£o broadcast:`, notification.title);
}


========================================
ARQUIVO: ./server/tests/bonus-improvements.test.ts
========================================
import { describe, it, expect } from "vitest";
import { appRouter } from "../routers";

/**
 * Testes para as melhorias implementadas no sistema de bÃ´nus:
 * 1. CorreÃ§Ã£o de imports duplicados (validaÃ§Ã£o estrutural)
 * 2. ExportaÃ§Ã£o para Excel (validaÃ§Ã£o de dados)
 * 3. GrÃ¡ficos de evoluÃ§Ã£o temporal (endpoints de agregaÃ§Ã£o)
 */

describe("Melhorias do Sistema de BÃ´nus", () => {
  // Criar caller com contexto mock
  const mockUser = {
    id: 1,
    openId: "test-user",
    name: "Test User",
    email: "test@example.com",
    role: "admin" as const,
  };

  const caller = appRouter.createCaller({
    user: mockUser,
    req: {} as any,
    res: {} as any,
  });

  describe("Endpoint getMonthlyTrends", () => {
    it("deve retornar tendÃªncias mensais de bÃ´nus", async () => {
      const trends = await caller.bonus.getMonthlyTrends({ months: 6 });

      expect(trends).toBeDefined();
      expect(Array.isArray(trends)).toBe(true);

      // Se houver dados, validar estrutura
      if (trends.length > 0) {
        const firstTrend = trends[0];
        expect(firstTrend).toHaveProperty("month");
        expect(firstTrend).toHaveProperty("totalAmount");
        expect(firstTrend).toHaveProperty("count");
        expect(firstTrend).toHaveProperty("paidAmount");
        expect(firstTrend).toHaveProperty("averageBonus");

        // Validar tipos
        expect(typeof firstTrend.month).toBe("string");
        expect(typeof firstTrend.totalAmount).toBe("number");
        expect(typeof firstTrend.count).toBe("number");
        expect(typeof firstTrend.paidAmount).toBe("number");
        expect(typeof firstTrend.averageBonus).toBe("number");
      }
    });

    it("deve respeitar o parÃ¢metro de quantidade de meses", async () => {
      const trends3Months = await caller.bonus.getMonthlyTrends({ months: 3 });
      const trends6Months = await caller.bonus.getMonthlyTrends({ months: 6 });

      expect(trends3Months.length).toBeLessThanOrEqual(3);
      expect(trends6Months.length).toBeLessThanOrEqual(6);
    });

    it("deve calcular corretamente a mÃ©dia de bÃ´nus", async () => {
      const trends = await caller.bonus.getMonthlyTrends({ months: 6 });

      trends.forEach((trend) => {
        if (trend.count > 0) {
          const expectedAverage = trend.totalAmount / trend.count;
          expect(trend.averageBonus).toBeCloseTo(expectedAverage, 2);
        } else {
          expect(trend.averageBonus).toBe(0);
        }
      });
    });
  });

  describe("Endpoint getDepartmentDistribution", () => {
    it("deve retornar distribuiÃ§Ã£o de bÃ´nus por departamento", async () => {
      const distribution = await caller.bonus.getDepartmentDistribution();

      expect(distribution).toBeDefined();
      expect(Array.isArray(distribution)).toBe(true);

      // Se houver dados, validar estrutura
      if (distribution.length > 0) {
        const firstDept = distribution[0];
        expect(firstDept).toHaveProperty("departmentId");
        expect(firstDept).toHaveProperty("totalAmount");
        expect(firstDept).toHaveProperty("count");
        expect(firstDept).toHaveProperty("averageBonus");

        // Validar tipos
        expect(typeof firstDept.departmentId).toBe("number");
        expect(typeof firstDept.totalAmount).toBe("number");
        expect(typeof firstDept.count).toBe("number");
        expect(typeof firstDept.averageBonus).toBe("number");
      }
    });

    it("deve calcular corretamente a mÃ©dia por departamento", async () => {
      const distribution = await caller.bonus.getDepartmentDistribution();

      distribution.forEach((dept) => {
        if (dept.count > 0) {
          const expectedAverage = dept.totalAmount / dept.count;
          expect(dept.averageBonus).toBeCloseTo(expectedAverage, 2);
        } else {
          expect(dept.averageBonus).toBe(0);
        }
      });
    });

    it("deve retornar apenas departamentos com bÃ´nus pagos", async () => {
      const distribution = await caller.bonus.getDepartmentDistribution();

      // Todos os departamentos retornados devem ter pelo menos 1 bÃ´nus
      distribution.forEach((dept) => {
        expect(dept.count).toBeGreaterThan(0);
        expect(dept.totalAmount).toBeGreaterThan(0);
      });
    });
  });

  describe("ValidaÃ§Ã£o de Dados para ExportaÃ§Ã£o Excel", () => {
    it("deve retornar cÃ¡lculos com todos os campos necessÃ¡rios para Excel", async () => {
      const calculations = await caller.bonus.listCalculations({ status: "pago" });

      expect(calculations).toBeDefined();
      expect(Array.isArray(calculations)).toBe(true);

      // Se houver dados, validar campos necessÃ¡rios para exportaÃ§Ã£o
      if (calculations.length > 0) {
        const firstCalc = calculations[0];

        // Campos obrigatÃ³rios para exportaÃ§Ã£o
        expect(firstCalc).toHaveProperty("id");
        expect(firstCalc).toHaveProperty("employeeId");
        expect(firstCalc).toHaveProperty("baseSalary");
        expect(firstCalc).toHaveProperty("bonusAmount");
        expect(firstCalc).toHaveProperty("status");
        expect(firstCalc).toHaveProperty("calculatedAt");

        // Validar tipos numÃ©ricos (valores em centavos)
        expect(typeof firstCalc.baseSalary).toBe("number");
        expect(typeof firstCalc.bonusAmount).toBe("number");
      }
    });

    it("deve retornar estatÃ­sticas corretas para KPIs do relatÃ³rio", async () => {
      const stats = await caller.bonus.getStats();

      expect(stats).toBeDefined();
      expect(stats).toHaveProperty("activePolicies");
      expect(stats).toHaveProperty("totalCalculations");
      expect(stats).toHaveProperty("totalBonusAmount");

      // Validar tipos
      expect(typeof stats.activePolicies).toBe("number");
      expect(typeof stats.totalCalculations).toBe("number");
      expect(typeof stats.totalBonusAmount).toBe("number");

      // Validar valores nÃ£o negativos
      expect(stats.activePolicies).toBeGreaterThanOrEqual(0);
      expect(stats.totalCalculations).toBeGreaterThanOrEqual(0);
      expect(stats.totalBonusAmount).toBeGreaterThanOrEqual(0);
    });
  });

  describe("Integridade dos Dados de BÃ´nus", () => {
    it("deve garantir consistÃªncia entre cÃ¡lculos e polÃ­ticas", async () => {
      const calculations = await caller.bonus.listCalculations({});
      const policies = await caller.bonus.list({});

      expect(calculations).toBeDefined();
      expect(policies).toBeDefined();

      // Se houver cÃ¡lculos, deve haver polÃ­ticas
      if (calculations.length > 0) {
        expect(policies.length).toBeGreaterThan(0);
      }
    });

    it("deve validar que bÃ´nus pagos tÃªm data de pagamento", async () => {
      const paidCalculations = await caller.bonus.listCalculations({ status: "pago" });

      paidCalculations.forEach((calc: any) => {
        if (calc.status === "pago") {
          // BÃ´nus pagos devem ter paidAt definido
          expect(calc.paidAt).toBeDefined();
        }
      });
    });

    it("deve validar que multiplicadores estÃ£o dentro de limites razoÃ¡veis", async () => {
      const calculations = await caller.bonus.listCalculations({});

      calculations.forEach((calc: any) => {
        if (calc.appliedMultiplier) {
          // Multiplicadores devem estar entre 0 e 10 (valores razoÃ¡veis)
          expect(calc.appliedMultiplier).toBeGreaterThanOrEqual(0);
          expect(calc.appliedMultiplier).toBeLessThanOrEqual(10);
        }
      });
    });
  });

  describe("Performance e OtimizaÃ§Ã£o", () => {
    it("deve executar getMonthlyTrends em tempo razoÃ¡vel", async () => {
      const startTime = Date.now();
      await caller.bonus.getMonthlyTrends({ months: 12 });
      const endTime = Date.now();

      const executionTime = endTime - startTime;
      // Deve executar em menos de 5 segundos
      expect(executionTime).toBeLessThan(5000);
    });

    it("deve executar getDepartmentDistribution em tempo razoÃ¡vel", async () => {
      const startTime = Date.now();
      await caller.bonus.getDepartmentDistribution();
      const endTime = Date.now();

      const executionTime = endTime - startTime;
      // Deve executar em menos de 5 segundos
      expect(executionTime).toBeLessThan(5000);
    });
  });
});


========================================
ARQUIVO: ./shared/_core/errors.ts
========================================
/**
 * Base HTTP error class with status code.
 * Throw this from route handlers to send specific HTTP errors.
 */
export class HttpError extends Error {
  constructor(
    public statusCode: number,
    message: string
  ) {
    super(message);
    this.name = "HttpError";
  }
}

// Convenience constructors
export const BadRequestError = (msg: string) => new HttpError(400, msg);
export const UnauthorizedError = (msg: string) => new HttpError(401, msg);
export const ForbiddenError = (msg: string) => new HttpError(403, msg);
export const NotFoundError = (msg: string) => new HttpError(404, msg);


========================================
ARQUIVO: ./shared/const.ts
========================================
export const COOKIE_NAME = "app_session_id";
export const ONE_YEAR_MS = 1000 * 60 * 60 * 24 * 365;
export const AXIOS_TIMEOUT_MS = 30_000;
export const UNAUTHED_ERR_MSG = 'Please login (10001)';
export const NOT_ADMIN_ERR_MSG = 'You do not have required permission (10002)';


========================================
ARQUIVO: ./shared/types.ts
========================================
/**
 * Unified type exports
 * Import shared types from this single entry point.
 */

export type * from "../drizzle/schema";
export * from "./_core/errors";


========================================
ARQUIVO: ./vite.config.ts
========================================
import { jsxLocPlugin } from "@builder.io/vite-plugin-jsx-loc";
import tailwindcss from "@tailwindcss/vite";
import react from "@vitejs/plugin-react";
import fs from "node:fs";
import path from "path";
import { defineConfig } from "vite";
import { vitePluginManusRuntime } from "vite-plugin-manus-runtime";


const plugins = [react(), tailwindcss(), jsxLocPlugin(), vitePluginManusRuntime()];

export default defineConfig({
  plugins,
  resolve: {
    alias: {
      "@": path.resolve(import.meta.dirname, "client", "src"),
      "@shared": path.resolve(import.meta.dirname, "shared"),
      "@assets": path.resolve(import.meta.dirname, "attached_assets"),
    },
  },
  envDir: path.resolve(import.meta.dirname),
  root: path.resolve(import.meta.dirname, "client"),
  publicDir: path.resolve(import.meta.dirname, "client", "public"),
  build: {
    outDir: path.resolve(import.meta.dirname, "dist/public"),
    emptyOutDir: true,
  },
  server: {
    host: true,
    allowedHosts: [
      ".manuspre.computer",
      ".manus.computer",
      ".manus-asia.computer",
      ".manuscomputer.ai",
      ".manusvm.computer",
      "localhost",
      "127.0.0.1",
    ],
    fs: {
      strict: true,
      deny: ["**/.*"],
    },
  },
});


========================================
ARQUIVO: ./vitest.config.ts
========================================
import { defineConfig } from "vitest/config";
import path from "path";

export default defineConfig({
  root: path.resolve(import.meta.dirname),
  resolve: {
    alias: {
      "@shared": path.resolve(import.meta.dirname, "shared"),
    },
  },
  test: {
    environment: "node",
    include: ["server/**/*.test.ts", "server/**/*.spec.ts"],
  },
});


